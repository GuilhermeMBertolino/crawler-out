#!/bin/sh

RUNNING="/var/run/loadsharing-dnrd-running"
# Make sure only one default script running.
while :
do
    if [ ! -f "$RUNNING" ] ; then
        break
    fi
    echo "exist $RUNNING"
    sleep 1
done
echo 1 > $RUNNING

LOADSHARING_ENABLE=`rdcsman 0x004301c0 u32`

LOCAL_STATUS=`rdcsman 0x80010007 u32`
FIRST_STATUS=`rdcsman 0x80432b22 u32`

FIRST_WANTYPE=`rdcsman 0x00010003 u32`

LOCAL_WAN_IF_NAME=`rdcsman 0x8001000b str`
LOCAL_WAN_IP=`rdcsman 0x80010002 ipv4`

LOADSHARING_RUN_STATUS=`rdcsman 0x80432b25 u32`

LS_CHK_LOG="/var/lsing/lsing_chk_status.log"

if [ "$LOADSHARING_RUN_STATUS" = "1" ] ; then
	exit 0
fi

############## Check First WAN , Local WAN STATUS CSID value ; Local WAN IP CSID value ; Local WAN Interface CSID value

if [ "$LOADSHARING_ENABLE" = "1" ] && [ "$FIRST_STATUS" = "2" ] ; then

	count=0
	echo start check local csid status > $LS_CHK_LOG
	case $FIRST_WANTYPE in
		"0")
		IF_NAME=`rdcsman 0x80432b24 str`
		IP=`rdcsman 0x80035002 ipv4`
		;;
		"16")
		IF_NAME=`rdcsman 0x80432b24 str`
		IP=`rdcsman 0x801e0200 ipv4`
		;;
		"32")
		IF_NAME=`rdcsman 0x80432b24 str`
		IP=`rdcsman 0x00110001 ipv4`
		;;
		"64")
		IF_NAME=`rdcsman 0x80432b24 str`
		IP=`rdcsman 0x80040200 ipv4`
		;;
		*)
		echo first wantype error >> $LS_CHK_LOG
		exit 0
		;;
	esac

	if [ "$LOCAL_STATUS" != "2" ] ; then
		echo revise local status csid >> $LS_CHK_LOG
		wrcsman "0x80010007 0x2"
		count=$(($count+1))
	fi

	if [ "$LOCAL_WAN_IF_NAME" != "$IF_NAME" ] ; then
		echo revise local Interface csid >> $LS_CHK_LOG
		wrcsman "0x8001000b \"$IF_NAME"
		count=$(($count+1))
	fi

	if [ "$LOCAL_WAN_IP" != "$IP" ] ; then
		echo revise local IP csid >> $LS_CHK_LOG
		wrcsman "0x80010002 {$IP}"
		count=$(($count+1))
	fi

	if [$count > 0] ; then
		nat restart
	fi
fi

