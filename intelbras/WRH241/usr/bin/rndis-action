#!/bin/sh

UDHCPC="udhcpc"
UDHCPC_PID_FILE="/var/run/udhcpc.rndis.pid"
PIDFILE_CONNECT="/var/run/udhcpc.rndis.pid.connect"
DEMAND_FILE="/var/run/udhcpc.rndis.demand"
UDHCPC_DEFAULT_SCRIPT="/usr/bin/rndis.script"
ETH="usbnet0"
LANIF=`rdcsman 0x8000F201 str`
CNTTYPE=`rdcsman 0x001e000a u16`
WANTYPE=`rdcsman 0x00010003 u16`
HOSTNAME=``
CNTFORCE=`rdcsman 0x8001000e u8`
MTU=`rdcsman 0x801e000b u32`
HOSTNAME=`cat /etc/hostname`
if [ $HOSTNAME == "" ]; then
	HOSTNAME="Router"
fi
LOADSHARING_ENABLE=`rdcsman 0x004301c0 u32`

rndis_status()
{
		TIME=0
		TIMEOUT=10
		while [ true ] ; do	
			sl_get_IP_NM_GW_in_ifconfig $ETH IF_IP IF_NM IF_GW
			#echo "$0 : IF_IP=$IF_IP IF_NM=$IF_NM IF_GW=$IF_GW"	
			if [ "${IF_IP}x" != "x" -a "${IF_NM}x" != "x" -a "${IF_GW}x" != "x" ] ; then	
				return 0		
			else			
				sleep 1
				TIME=$((TIME+1))
				if [ $TIME -gt $TIMEOUT ] ; then
					return 1	
				fi			
			fi
		done
}


rndis_start()
{
		kill `ps | grep udhcpc |grep usbnet0| cut -dr -f1`

		wrcsman "0x801e1100 0x00" #clean error code
		if [ $MTU -eq 0 ] ; then
			ifconfig $ETH 0.0.0.0 mtu 1500 up
		else
			ifconfig $ETH 0.0.0.0 mtu $MTU up
		fi
		if [ $CNTFORCE -eq 1 ] ; then
			$UDHCPC -H $HOSTNAME -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
			wrcsman "0x8001000e 0x00"
		elif [ $CNTTYPE = 0 -a $WANTYPE = 0 ] ; then
			#udhcpc-connect &
			$UDHCPC -H $HOSTNAME -n -d -l $LANIF -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
		else
			$UDHCPC -H $HOSTNAME -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
		fi

		return $?
}


rndis_stop()
{
echo -e "stop" > /var/rndis_stop
	[ -f "$DEMAND_FILE" ] && rm -f $DEMAND_FILE
		
	if [ -f "$PIDFILE_CONNECT" ] ; then
		CONNECT_PID=`cat $PIDFILE_CONNECT`
		kill $CONNECT_PID > /dev/null 2>&1
		rm -f $PIDFILE_CONNECT > /dev/null 2>&1	
	fi		
			
	if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
		UDHCPC_PID=`cat $UDHCPC_PID_FILE`
		rm -f $UDHCPC_PID_FILE
		kill $UDHCPC_PID > /dev/null 2>&1 || exit 1
	fi
			
	ifconfig $ETH 0.0.0.0 				 		
	if [ $LOADSHARING_ENABLE -eq 1 ] ; then
		exit 0 
	fi
	wrcsman "0x801e0500 0x00 && \
		   	 0x80010007 0x00"
	wrcsman "0x801e0200 0x00 && \
		 	0x801e0300 0x00 && \
			0x801e0400 0x00 && \
			0x801e0500 0x00 && \
			0x801e0600 0x00 && \
			0x801e0700 0x00 && \
			0x801E0800 0x00 && \
			0x801E0900 0x00 && \
			0x801E1200 0x00 && \
			0x80010002 0x00 && \
			0x80010003 0x00 && \
			0x80010004 0x00 && \
			0x80010005 0x00 && \
			0x80010006 0x00 && \
			0x80010007 0x00"
	rmcsman "0x801e0100"
	return 0
}

# main ##########################################################

. /usr/bin/scriptlib

case "$1" in

	start)
		rndis_start		
		if [ $? = 1 ] ; then
			ifconfig $ETH 0.0.0.0 
			exit 1
		fi	
		exit 0	
		;;
	
	stop)
		rndis_stop
		;;
	
	release)
		if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR2 $UDHCPC_PID			
		fi
		wrcsman "0x801e0500 0x00 && \
				0x80010007 0x00"		
		exit 0		
		;;
	
	renew)
		if [ $CNTTYPE = 0 ] ; then
			rndis_stop
			rndis_start
		elif [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR1 $UDHCPC_PID
			rndis_status			 			 
		else
			$UDHCPC -H $HOSTNAME -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 

		fi
		
		exit 0									
		;;
	
		
	*)
		exit 1
		;;
esac

exit 0		
			
