#!/bin/sh

UDHCPC="udhcpc"
UDHCPC_PID_FILE="/var/run/udhcpc.cdc_ether.pid"
PIDFILE_CONNECT="/var/run/udhcpc.cdc_ether.pid.connect"
DEMAND_FILE="/var/run/udhcpc.sierra.demand"
UDHCPC_DEFAULT_SCRIPT="/usr/bin/dhcp.script"
. /usr/bin/scriptlib
ETH="usbnet0"
LANIF=`rdcsman 0x8000F201 str`
CNTTYPE=`rdcsman 0x001e000a u16`
WANTYPE=`rdcsman 0x00010003 u16`
HOSTNAME=``
CNTFORCE=`rdcsman 0x8001000e u8`
MTU=`rdcsman 0x001e000b u32`
LOADSHARING_ENABLE=`rdcsman 0x004301c0 u32`
VENDORID=`rdcsman 0x801e1400 u16`
PRODUCTID=`rdcsman 0x801e1500 u16`

cdc_ether_status()
{
		TIME=0
		TIMEOUT=10
		while [ true ] ; do	
			sl_get_IP_NM_GW_in_ifconfig $ETH IF_IP IF_NM IF_GW
			#echo "$0 : IF_IP=$IF_IP IF_NM=$IF_NM IF_GW=$IF_GW"	
			if [ "${IF_IP}x" != "x" -a "${IF_NM}x" != "x" -a "${IF_GW}x" != "x" ] ; then	
				return 0		
			else			
				sleep 1
				TIME=$((TIME+1))
				if [ $TIME -gt $TIMEOUT ] ; then
					return 1	
				fi			
			fi
		done
}


cdc_ether_start()
{
	TMPFIL=/tmp/cdc-ether-connect
	kill `ps | grep udhcpc |grep usbnet0| cut -dr -f1`
	if [ $VENDORID -eq 5136 ] && [ $PRODUCTID -eq 45057 ] ; then
		modprobe cdc-ether
		sleep 6
		CDC_ETHER=` lsmod | grep cdc_ether`
		if [ -z "$CDC_ETHER" ];then
			modprobe cdc-ether
			sleep 5
		fi
		send_ATcmd /dev/modem 'AT$NWQMIDISCONNECT'
		sleep 1
		send_ATcmd /dev/modem 'AT$NWQMICONNECT=,,' > $TMPFIL
		tmpfil=`cat /tmp/cdc-ether-connect`
		logger -t "O3G/SCRIPT" -p 8.7 "tmpfil:$tmpfil"
		echo "AT$NWQMICONNECT=1"
	#	sleep 1
		PIP=`grep 'OK' $TMPFIL | cut -d, -f2  | cut -d\" -f2`
		logger -t "O3G/SCRIPT" -p 8.7 "pip:$PIP"
		if [ -z "$PIP" ]; then
			logger -t "O3G/SCRIPT" -p 8.7 "again"
			send_ATcmd /dev/modem 'AT$NWQMICONNECT=,,' > $TMPFIL
			tmpfil=`cat /tmp/cdc-ether-connect`
			logger -t "O3G/SCRIPT" -p 8.7 "tmpfil:$tmpfil"
			echo "AT$NWQMICONNECT=1"
			sleep 1
			PIP=`grep 'OK' $TMPFIL | cut -d, -f2  | cut -d\" -f2`
			logger -t "O3G/SCRIPT" -p 8.7 "pip:$PIP"
			if [ -z "$PIP" ]; then
				wrcsman "0x801e0700 0x03 && \
						0x80010007 0x03"
			fi
		fi
	#	send_ATcmd /dev/modem 'AT$NWQMISTATUS' > $TMPFIL
	#	sleep 1
		
	elif [ $VENDORID -eq 6797 ] && [ $PRODUCTID -eq 4109 ] ; then
		send_ATcmd /dev/ttyUSB2 'at$wancall=0'
		sleep 1
		send_ATcmd /dev/ttyUSB2 'at$wancall=1' > $TMPFIL
		logger -t "O3G/SCRIPT" -p 8.7 "tmpfil:$TMPFIL"
		echo "at$wancall=1"
		sleep 1
		PIP=`grep 'OK' $TMPFIL | cut -d, -f2  | cut -d\" -f2`
		logger -t "O3G/SCRIPT" -p 8.7 "pip:$PIP"
		if [ -z "$PIP" ]; then
			logger -t "O3G/SCRIPT" -p 8.7 "again"
			send_ATcmd /dev/ttyUSB2 'at$wancall=1'
			echo "at$wancall=1"
			sleep 4
		fi
	elif [ $VENDORID -eq 6610 ] && [ $PRODUCTID -eq 4480 ] ; then
	    APN=`rdcsman 0x001e0003 str`
	    if [ -n "$APN" ]; then
            send_ATcmd /dev/modem 'AT+cgdcont=1,\"IP\",\"$APN\"' > $LOG
	    fi
		send_ATcmd /dev/modem 'at%ipdpact=1,0'
		sleep 1
		send_ATcmd /dev/modem 'at%ipdpact=1,1' > $TMPFIL
		logger -t "O3G/SCRIPT" -p 8.7 "tmpfil:$TMPFIL"
		echo "at%ipdpact=1,1"
		sleep 1
		PIP=`grep 'OK' $TMPFIL | cut -d, -f2  | cut -d\" -f2`
		logger -t "O3G/SCRIPT" -p 8.7 "pip:$PIP"
		if [ -z "$PIP" ]; then
			logger -t "O3G/SCRIPT" -p 8.7 "again"
			send_ATcmd /dev/modem 'at%ipdpact=1,1'
			echo "at$wancall=1"
			sleep 4
		fi
	fi
		wrcsman "0x801e1100 0x00" #clean error code
		if [ $MTU -eq 0 ] ; then
			ifconfig $ETH 0.0.0.0 mtu 1500 up
		else
			ifconfig $ETH 0.0.0.0 mtu $MTU up
		fi
		logger -t "O3G/SCRIPT" -p 8.7 "befre"
		if [ $CNTFORCE -eq 1 ] ; then
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
			wrcsman "0x8001000e 0x00"
		elif [ $CNTTYPE = 0 -a $WANTYPE = 16 ] ; then #3G on demand
			udhcpc-connect-sierra &
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
		elif [ $CNTTYPE = 2 -a $WANTYPE = 16 ] ; then #3G manually
			udhcpc-connect-sierra &
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
		else
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
			if [ $LOADSHARING_ENABLE -eq 1 ] ; then
				logger -p 8.7 -t "O3G/cdc_ether" "Load Sharing Don't do cdc_ether-action update flag !\""
				exit 0 
			fi
		fi

		return $?
}


cdc_ether_stop()
{
	if [ $VENDORID -eq 5136 ] && [ $PRODUCTID -eq 45057 ] ; then
		kill `ps | grep udhcpc |grep usbnet0| cut -dr -f1`
		send_ATcmd /dev/modem 'AT$NWQMIDISCONNECT'
		sleep 1
		killall send_ATcmd
		rmmod cdc_ether
		rmmod usbnet
	elif [ $VENDORID -eq 6797 ] && [ $PRODUCTID -eq 4109 ] ; then
		send_ATcmd /dev/ttyUSB2 'at$wancall=0'
	elif [ $VENDORID -eq 6610 ] && [ $PRODUCTID -eq 4480 ] ; then
		send_ATcmd /dev/modem 'at%ipdpact=1,0'
	fi
	[ -f "$DEMAND_FILE" ] && rm -f $DEMAND_FILE
		
	if [ -f "$PIDFILE_CONNECT" ] ; then
		CONNECT_PID=`cat $PIDFILE_CONNECT`
		kill $CONNECT_PID > /dev/null 2>&1
		rm -f $PIDFILE_CONNECT > /dev/null 2>&1	
	fi		
			
	if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
		UDHCPC_PID=`cat $UDHCPC_PID_FILE`
		rm -f $UDHCPC_PID_FILE
		kill $UDHCPC_PID > /dev/null 2>&1 || exit 1
	fi
			
	ifconfig $ETH down

	if [ $LOADSHARING_ENABLE -eq 1 ] ; then
		logger -p 8.7 -t "O3G/cdc_ether" "Load Sharing Don't do cdc_ether-action update flag !\""
		exit 0 
	fi
	wrcsman "0x801e0500 0x00 && \
		   	 0x80010007 0x00"
	wrcsman "0x801e0200 0x00 && \
		 	0x801e0300 0x00 && \
			0x801e0400 0x00 && \
			0x801e0500 0x00 && \
			0x801e0600 0x00 && \
			0x801e0700 0x00 && \
			0x801E0800 0x00 && \
			0x801E0900 0x00 && \
			0x801E1200 0x00 && \
			0x80010002 0x00 && \
			0x80010003 0x00 && \
			0x80010004 0x00 && \
			0x80010005 0x00 && \
			0x80010006 0x00 && \
			0x80010007 0x00"
	rmcsman "0x801e0100"
	return 0
}

# main ##########################################################

. /usr/bin/scriptlib

case "$1" in

	start)
		cdc_ether_start		
		if [ $? = 1 ] ; then
			logger -t "O3G/SCRIPT" -p 8.7 "connect fail!!\n"
			ifconfig $ETH 0.0.0.0 
			wrcsman "0x801e0700 0x03 && \
					0x80010007 0x03"		
			exit 1
		fi
		exit 0	
		;;
	
	stop)
		cdc_ether_stop
		;;
	
	release)
		if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR2 $UDHCPC_PID			
		fi
		wrcsman "0x801e0500 0x00 && \
				0x80010007 0x00"		
		exit 0		
		;;
	
	renew)
		if [ $CNTTYPE = 0 ] ; then
			cdc_ether_stop
			cdc_ether_start
		elif [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR1 $UDHCPC_PID
			cdc_ether_status			 			 
		else
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 

		fi
		
		exit 0									
		;;
	
		
	*)
		exit 1
		;;
esac

exit 0		
			
