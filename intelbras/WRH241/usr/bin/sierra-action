#!/bin/sh

UDHCPC="udhcpc"
UDHCPC_PID_FILE="/var/run/udhcpc.sierra.pid"
PIDFILE_CONNECT="/var/run/udhcpc.sierra.pid.connect"
DEMAND_FILE="/var/run/udhcpc.sierra.demand"
UDHCPC_DEFAULT_SCRIPT="/usr/bin/dhcp.script"
. /usr/bin/scriptlib
ETH="usbnet0"
LANIF=`rdcsman 0x8000F201 str`
CNTTYPE=`rdcsman 0x001e000a u16`
WANTYPE=`rdcsman 0x00010003 u16`
HOSTNAME=``
CNTFORCE=`rdcsman 0x8001000e u8`
MTU=`rdcsman 0x001e000b u32`
LOADSHARING_ENABLE=`rdcsman 0x004301c0 u32`

sierra_status()
{
		TIME=0
		TIMEOUT=10
		while [ true ] ; do	
			sl_get_IP_NM_GW_in_ifconfig $ETH IF_IP IF_NM IF_GW
			#echo "$0 : IF_IP=$IF_IP IF_NM=$IF_NM IF_GW=$IF_GW"	
			if [ "${IF_IP}x" != "x" -a "${IF_NM}x" != "x" -a "${IF_GW}x" != "x" ] ; then	
				return 0		
			else			
				sleep 1
				TIME=$((TIME+1))
				if [ $TIME -gt $TIMEOUT ] ; then
					return 1	
				fi			
			fi
		done
}


sierra_start()
{
	APN=`rdcsman 0x001e0003 str`

    if [ "$APN" == "connect" ]; then
        Profile="Optus Connect"
    elif [ "$APN" == "yesbusiness" ];then
        Profile="Optus Business"
    elif [ "$APN" == "connectme" ];then
        Profile="Optus BYO"
    elif [ "$APN" == "preconnect" ];then
        Profile="Optus Prepaid"
    elif [ "$APN" == "connectcap" ];then
        Profile="Optus ConnectCap"
    else
        Profile=$APN
    fi
    USER=`rdcsman 0x001e0001 str`
    PASSWORD=`rdcsman 0x001e0002 str`
	TMPFIL=/tmp/sierra-connect
    AT_LOG="/tmp/sierra-action.log"
	kill `ps | grep udhcpc |grep usbnet0| cut -dr -f1`
    send_ATcmd /dev/modem2 at+cgatt=0
    sleep 2
    send_ATcmd /dev/modem2 at+cgatt=1
    
	if [ -n "$APN" ]; then
		send_ATcmd /dev/modem2 AT+CGDCONT=1,\"IP\",\"$APN\"
        sleep 2
        send_ATcmd /dev/modem2 "AT!SCPROF=1,\"$Profile\",0,0,0,0"
	fi

	if [ -n "$USER" -a -n "$PASSWORD" ]; then
		AUTH_TYPE=`rdcsman 0x001e000f u16`
        if [ $AUTH_TYPE -eq 2 ]; then
		    send_ATcmd /dev/modem2 AT\$QCPDPP=1,$AUTH_TYPE,$PASSWORD,$USER
        else
            send_ATcmd /dev/modem2 AT\$QCPDPP=1,1,$PASSWORD,$USER
        fi
	fi
	rm $TMPFIL
	send_ATcmd /dev/modem2 ATZ
	send_ATcmd /dev/modem2 AT!SCACT=0,1
	echo "AT!SCACT=0,1"
	sleep 2
	send_ATcmd /dev/modem2 AT!SCDFTPROF=1 
	sleep 2
	send_ATcmd /dev/modem2 AT!SCACT=1,1 > $AT_LOG
	echo "AT!SCACT=1,1"
    AT_RET=`cat $AT_LOG | grep OK`
    if [ -z "$AT_RET" ]; then
        logger -p 8.7 -t "sierra-action" "Sierra connection failed"
        exit 1
    fi
	sleep 2
	send_ATcmd /dev/modem2 AT!SCPADDR=1 > $TMPFIL
	echo "AT!SCPADDR=1"
	sleep 2
	PIP=`grep '!SCPADDR:' $TMPFIL | cut -d, -f2  | cut -d\" -f2`
	if [ -z "$PIP" ]; then
		send_ATcmd /dev/modem2 AT!SCPADDR=1 > $TMPFIL
		sleep 3
		PIP=`grep '!SCPADDR:' $TMPFIL | cut -d, -f2  | cut -d\" -f2`
	fi
	echo $PIP > /tmp/amanda_pip
	if [ -z "$PIP" ]; then
		rm -f $TMPFIL
		echo  0 > /var/run/3g_link_status	
		if [ -z "$BACKUP" ]; then
			sleep 2
			echo 93 > /var/run/monitor.fifo
		fi
		3g-action stop
#		sierra-action stop
#		sierra-stop
#		wrcsman "0x801e0700 0x00 && \			0x80010007 0x00"		
		exit	
	fi	
#	echo "Got IP: $PIP"
#        echo "ifconfig usbnet0 $PIP netmask 255.255.255.0 up"
		wrcsman "0x801e1100 0x00" #clean error code
		if [ $MTU -eq 0 ] ; then
			ifconfig $ETH 0.0.0.0 mtu 1500 up
		else
			ifconfig $ETH 0.0.0.0 mtu $MTU up
		fi
	sleep 1	
		if [ $CNTFORCE -eq 1 ] ; then
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
			wrcsman "0x8001000e 0x00"
		elif [ $CNTTYPE = 0 -a $WANTYPE = 16 ] ; then #3G on demand
			udhcpc-connect-sierra &
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
		elif [ $CNTTYPE = 2 -a $WANTYPE = 16 ] ; then #3G manually
			udhcpc-connect-sierra &
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
		else
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
			if [ $LOADSHARING_ENABLE -eq 1 ] ; then
				logger -p 8.7 -t "sierra dhcpc" "Load Sharing Don't do sierra-action update flag !\""
				exit 0 
			fi
		fi
	
#   sl_get_IP_NM_GW_in_ifconfig $IFNAME IF_IP IF_NM IF_GW
	IF_IP=`rdcsman 0x801e0200 ipv4`
	echo "Got DHCP IP: $IF_IP" > /tmp/amanda_ifip
	if [ "$PIP" != "$IF_IP" ] ; then
		logger -p 8.7 -t "sierra dhcpc" "connect error sierra-action stop\""
		3g-action stop
	fi

		return $?
}


sierra_stop()
{
	echo -e "stop" > /var/sierra_stop
	rm -rf /tmp/sierra_dhcp_up
	kill `ps | grep udhcpc |grep $ETH| cut -dr -f1`

	[ -f "$DEMAND_FILE" ] && rm -f $DEMAND_FILE
		
	if [ -f "$PIDFILE_CONNECT" ] ; then
		CONNECT_PID=`cat $PIDFILE_CONNECT`
		kill $CONNECT_PID > /dev/null 2>&1
		rm -f $PIDFILE_CONNECT > /dev/null 2>&1	
	fi		
			
	if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
		UDHCPC_PID=`cat $UDHCPC_PID_FILE`
		rm -f $UDHCPC_PID_FILE
		kill $UDHCPC_PID > /dev/null 2>&1 || exit 1
	fi

	ifconfig $ETH 0.0.0.0
	ifconfig $ETH down

	if [ $LOADSHARING_ENABLE -eq 1 ] ; then
		logger -p 8.7 -t "sierra dhcpc" "Load Sharing Don't do sierra-action update flag !\""
		exit 0 
	fi
	wrcsman "0x801e0500 0x00 && \
		   	 0x80010007 0x00"
	wrcsman "0x801e0200 0x00 && \
		 	0x801e0300 0x00 && \
			0x801e0400 0x00 && \
			0x801e0500 0x00 && \
			0x801e0600 0x00 && \
			0x801e0700 0x00 && \
			0x801E0800 0x00 && \
			0x801E0900 0x00 && \
			0x801E1200 0x00 && \
			0x80010002 0x00 && \
			0x80010003 0x00 && \
			0x80010004 0x00 && \
			0x80010005 0x00 && \
			0x80010006 0x00 && \
			0x80010007 0x00"
	rmcsman "0x801e0100"
	return 0
}

# main ##########################################################

. /usr/bin/scriptlib

case "$1" in

	start)
		sierra_start		
		if [ $? = 1 ] ; then
			ifconfig $ETH 0.0.0.0 
			exit 1
		fi	
		exit 0	
		;;
	
	stop)
		sierra_stop
		;;
	
	release)
		if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR2 $UDHCPC_PID			
		fi
		wrcsman "0x801e0500 0x00 && \
				0x80010007 0x00"		
		exit 0		
		;;
	
	renew)
		if [ $CNTTYPE = 0 ] ; then
			sierra_stop
			sierra_start
		elif [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR1 $UDHCPC_PID
			sierra_status			 			 
		else
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 

		fi
		
		exit 0									
		;;
	
		
	*)
		exit 1
		;;
esac

exit 0		
			
