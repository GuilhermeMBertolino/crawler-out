#!/bin/sh

UDHCPC="udhcpc"
UDHCPC_PID_FILE="/var/run/udhcpc.cdc_ether.pid"
PIDFILE_CONNECT="/var/run/udhcpc.cdc_ether.pid.connect"
DEMAND_FILE="/var/run/udhcpc.sierra.demand"
UDHCPC_DEFAULT_SCRIPT="/usr/bin/dhcp.script"
. /usr/bin/scriptlib

KERNEL_VERSION=`uname -a | grep "2.6.36"`
if [ -n "$KERNEL_VERSION" ]; then
    ETH="eth0"
else
    ETH="usbnet0"
fi

LANIF=`rdcsman 0x8000F201 str`
CNTTYPE=`rdcsman 0x001e000a u16`
WANTYPE=`rdcsman 0x00010003 u16`
HOSTNAME=``
CNTFORCE=`rdcsman 0x8001000e u8`
MTU=`rdcsman 0x801e000b u32`
LOADSHARING_ENABLE=`rdcsman 0x004301c0 u32`
VENDORID=`rdcsman 0x801e1400 u16`
PRODUCTID=`rdcsman 0x801e1500 u16`
APN=`rdcsman 0x001e0003 str`
USER=`rdcsman 0x001e0001 str`
PW=`rdcsman 0x001e0002 str`

hw_cdc_status()
{
		TIME=0
		TIMEOUT=10
		while [ true ] ; do	
			sl_get_IP_NM_GW_in_ifconfig $ETH IF_IP IF_NM IF_GW
			#echo "$0 : IF_IP=$IF_IP IF_NM=$IF_NM IF_GW=$IF_GW"	
			if [ "${IF_IP}x" != "x" -a "${IF_NM}x" != "x" -a "${IF_GW}x" != "x" ] ; then	
				return 0		
			else			
				sleep 1
				TIME=$((TIME+1))
				if [ $TIME -gt $TIMEOUT ] ; then
					return 1	
				fi			
			fi
		done
}


hw_cdc_start()
{
	TMPFIL=/tmp/hw-cdc-connect
	kill `ps | grep udhcpc |grep usbnet0| cut -dr -f1`
	if [ $MTU -eq 0 ] ; then
	 	ifconfig $ETH 0.0.0.0 mtu 1500 up
	else
	   	ifconfig $ETH 0.0.0.0 mtu $MTU up
	fi
   	sleep 4
   	send_ATcmd /dev/modem 'AT^NDISDUP=1,0'
   	sleep 1
   	send_ATcmd /dev/modem AT^NDISDUP=1,1,\"$APN\",\"$USER\",\"$PW\" > $TMPFIL
	sleep 1   
	logger -t "O3G/SCRIPT" -p 8.7 "tmpfil:$TMPFIL"
	PIP=`grep 'OK' $TMPFIL | cut -d, -f2  | cut -d\" -f2`
    logger -t "O3G/SCRIPT" -p 8.7 "pip:$PIP"
	if [ -z "$PIP" ]; then
		logger -t "O3G/SCRIPT" -p 8.7 "again"
   	    send_ATcmd /dev/modem 'AT^NDISDUP=1,0'
   	    sleep 1
   	    send_ATcmd /dev/modem AT^NDISDUP=1,1,\"$APN\",\"$USER\",\"$PW\" > $TMPFIL
		sleep 1
	fi
	wrcsman "0x801e1100 0x00" #clean error code
	logger -t "O3G/SCRIPT" -p 8.7 "befre"
	sleep 5
    if [ $CNTFORCE -eq 1 ] ; then
	 	$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
	  	wrcsman "0x8001000e 0x00"
	elif [ $CNTTYPE = 0 -a $WANTYPE = 16 ] ; then #3G on demand
	   	udhcpc-connect-sierra &
	   	$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
	elif [ $CNTTYPE = 2 -a $WANTYPE = 16 ] ; then #3G manually
	   	udhcpc-connect-sierra &
	   	$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
	else
	   	$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 
	   	if [ $LOADSHARING_ENABLE -eq 1 ] ; then
	   		logger -p 8.7 -t "O3G/cdc_ether" "Load Sharing Don't do cdc_ether-action update flag !\""
	   		exit 0 
	   	fi
	fi

	return $?
}


cdc_ether_stop()
{
	kill `ps | grep udhcpc |grep usbnet0| cut -dr -f1`
	send_ATcmd /dev/modem 'AT^NDISDUP=1,0'
	sleep 1
	killall send_ATcmd
	[ -f "$DEMAND_FILE" ] && rm -f $DEMAND_FILE
		
	if [ -f "$PIDFILE_CONNECT" ] ; then
		CONNECT_PID=`cat $PIDFILE_CONNECT`
		kill $CONNECT_PID > /dev/null 2>&1
		rm -f $PIDFILE_CONNECT > /dev/null 2>&1	
	fi		
			
	if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
		UDHCPC_PID=`cat $UDHCPC_PID_FILE`
		rm -f $UDHCPC_PID_FILE
		kill $UDHCPC_PID > /dev/null 2>&1 || exit 1
	fi
			
	ifconfig $ETH down

	if [ $LOADSHARING_ENABLE -eq 1 ] ; then
		logger -p 8.7 -t "O3G/hw_cdc" "Load Sharing Don't do hw_cdc_-action update flag !\""
		exit 0 
	fi
	wrcsman "0x801e0500 0x00 && \
		   	0x80010007 0x00 && \
	        0x801e0200 0x00 && \
		 	0x801e0300 0x00 && \
			0x801e0400 0x00 && \
			0x801e0500 0x00 && \
			0x801e0600 0x00 && \
			0x801e0700 0x00 && \
			0x801E0800 0x00 && \
			0x801E0900 0x00 && \
			0x801E1200 0x00 && \
			0x80010002 0x00 && \
			0x80010003 0x00 && \
			0x80010004 0x00 && \
			0x80010005 0x00 && \
			0x80010006 0x00 && \
			0x80010007 0x00"
	rmcsman "0x801e0100"
	return 0
}

# main ##########################################################

. /usr/bin/scriptlib

case "$1" in

	start)
		hw_cdc_start		
		if [ $? = 1 ] ; then
			logger -t "O3G/SCRIPT" -p 8.7 "connect fail!!\n"
			ifconfig $ETH 0.0.0.0 
			wrcsman "0x801e0700 0x03 && \
					0x80010007 0x03"		
			exit 1
		fi
		exit 0	
		;;
	
	stop)
		hw_cdc_stop
		;;
	
	release)
		if [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR2 $UDHCPC_PID			
		fi
		wrcsman "0x801e0500 0x00 && \
				0x80010007 0x00"		
		exit 0		
		;;
	
	renew)
		if [ $CNTTYPE = 0 ] ; then
			hw_cdc_stop
			hw_cdc_start
		elif [ -f "$UDHCPC_PID_FILE" -a -r "$UDHCPC_PID_FILE" ] ; then 
			UDHCPC_PID=`cat $UDHCPC_PID_FILE`
			kill -USR1 $UDHCPC_PID
			hw_cdc_status			 			 
		else
			$UDHCPC -n -i $ETH -p $UDHCPC_PID_FILE -s $UDHCPC_DEFAULT_SCRIPT 

		fi
		
		exit 0									
		;;
	
		
	*)
		exit 1
		;;
esac

exit 0		
			
