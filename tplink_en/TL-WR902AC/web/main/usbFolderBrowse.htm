<script language="javascript" type="text/javascript">var blank="&nbsp;&nbsp;";var usbDeviceList;var volumeList;var folderList;var currVolume="";var currPath="";var userList;var userAccessList;var accessFolderList;var folderObj="";var userObj="";var idx,i;var folderIdx;var firstClick=1;function escapeStr(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;")}function transStr(str){return str.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&nbsp;/g," ").replace(/\s/g," ")}function doSet(){var command={};var stack;var selectPath;newStr=$.id("shareName").value;if(newStr===""){$.alert(ERR_USB_SHARE_NAME_EMPTY);return}if($.asc(newStr,true)){$.alert(ERR_USB_SHARE_NAME_NOT_ASCII);return}if((/[\\\/:\*\?"<>|\]\ ]+/).test(newStr)){$.alert(ERR_USB_INVALID_CHAR_IN_FOLDER_NAME);return}newStr=$.id("currPath").value;if(newStr===""){$.alert(ERR_USB_DIR_NAME_EMPTY);return}if($.asc(newStr,true)){$.alert(ERR_USB_DIR_NAME_NOT_ASCII);return}selectPath=$.id("currPath").value;if("/"!=selectPath){if("/"==selectPath.charAt(selectPath.length-1)){$.id("currPath").value=selectPath.substring(0,selectPath.length-1);selectPath=$.id("currPath").value}}if("ADD"==pageStatus){for(idx=0;idx<accessFolderList.length;idx++){if(selectPath==accessFolderList[idx].name){$.alert(ERR_USB_DIR_EXIST);return}if($.id("shareName").value==accessFolderList[idx].alias){$.alert(ERR_USB_SHARE_NAME_EXIST);return}}command.name=selectPath;command.alias=$.id("shareName").value;command.enable=1;$.act(ACT_ADD,folderObj,null,null,command);accessFolderList=$.act(ACT_GL,folderObj,null,null,null)}else{stack=accessFolderList[folderIdx].__stack;for(idx=0;idx<accessFolderList.length;idx++){if(($.id("shareName").value==accessFolderList[idx].alias)&&(idx!=folderIdx)){$.alert(ERR_USB_SHARE_NAME_EXIST);return}if((selectPath==accessFolderList[idx].name)&&(idx!=folderIdx)){$.alert(ERR_USB_DIR_EXIST);return}}command.name=selectPath;command.alias=$.id("shareName").value;$.act(ACT_SET,folderObj,stack,null,command);accessFolderList=$.act(ACT_GL,folderObj,null,null,null)}$.addLoading($.id("applyButton"));$.exe(function(ret){if(!ret){if("DLNA"==pageType){$.loadMain("dlnaManage.htm");return}stack=accessFolderList[folderIdx].__stack;for(idx=0;idx<userList.length;idx++){var newFlag=1;var userCommand={};if((1==userList[idx].X_TP_SupperUser)||(""==userList[idx].username)){continue}for(i=0;i<userAccessList.length;i++){if(parseInt(stack,10)!=parseInt(userAccessList[i].__stack,10)){continue}if(parseInt(userList[idx].__stack,10)==userAccessList[i].userId){var permissions="";if(true==$.id("access_n_"+userAccessList[i].userId).checked){permissions=0}else{if(true==$.id("access_r_"+userAccessList[i].userId).checked){permissions=3}else{permissions=7}}if(0==permissions){$.act(ACT_DEL,userObj,userAccessList[i].__stack,null,null)}else{if(permissions!=userAccessList[i].permissions){userCommand.permissions=permissions;$.act(ACT_SET,userObj,userAccessList[i].__stack,null,userCommand)}}newFlag=0;break}}if(1==newFlag){var id=parseInt(userList[idx].__stack,10);if(true!=$.id("access_n_"+id).checked){userCommand.userId=id;userCommand.permissions=($.id("access_r_"+id).checked==true)?3:7;$.act(ACT_ADD,userObj,null,stack,userCommand)}}}$.exe(function(ret){if(!ret){if("SMB"==pageType){$.act(ACT_SET,SMB_SERVICE,null,null,["modified=0"]);if(!$.exe()){$.loadMain("usbSmbSrv.htm")}}if("FTP"==pageType){$.act(ACT_SET,FTP_SERVER,null,null,["modified=0"]);if(!$.exe()){$.loadMain("ftpSrv.htm")}}}})}})}function openFolder(){var fullPath=currVolume+"/"+currPath;var command={};command.targetPath=fullPath;$.act(ACT_SET,FOLDER_BROWSE,null,null,command);folderList=$.act(ACT_GL,FOLDER_NODE,null,null,null);$.exe()}function findFolder(){var dirTmp;var j;var match=false;if($.id("currPath").value=="/"){return}dirTmp=$.id("currPath").value.split("/");for(idx=0;idx<volumeList.length;idx++){currVolume=volumeList[idx].name;currPath="";for(i=0;i<dirTmp.length;i++){if(i==1){currPath=dirTmp[i]}else{if(i>1){currPath=currPath+"/"+dirTmp[i]}}openFolder();for(j=0;j<folderList.length;j++){if(folderList[j].folderName==dirTmp[i+1]){if((i+1)==(dirTmp.length-1)){match=true;$.id("volumeList").selectedIndex=idx+1;if(i==0){currPath=dirTmp[i+1]}else{currPath=currPath+"/"+dirTmp[i+1]}setupFolderTbl()}break}}if(j==folderList.length||match==true){break}}if(match==true){break}}if(match==true){return}else{currVolume="";currPath="";cleanTbl();$.alert(ERR_USB_DIR_NOT_EXIST)}}function doBrowse(){if(firstClick==1){findFolder();firstClick=0}if($.hasClass($.id("Folder_Browse"),"nd")){$.removeClass($.id("Folder_Browse"),"nd");$.removeClass($.id("bl_line"),"nd");$.id("Browse").value=s_str.hide}else{$.addClass($.id("Folder_Browse"),"nd");$.addClass($.id("bl_line"),"nd");$.id("Browse").value=s_str.browse}if("DLNA"==pageType){$.addClass($.id("User_Account"),"nd");$.addClass($.id("bl_line"),"nd")}}function cleanTbl(){while($.id("Folder_tbl").rows.length>1){$.id("Folder_tbl").deleteRow(-1)}}function upper(){var temp=currPath.split("/");var upperPath="";if(1==temp.length){upperPath=""}else{for(idx=0;idx<(temp.length-1);idx++){if(0==idx){upperPath+=temp[idx]}else{upperPath+=("/"+temp[idx])}}}currPath=upperPath;setupFolderTbl()}function browsePath(thisCtrl){var folder=$.h(thisCtrl);var folderStr=transStr(folder);if(""!=currPath){currPath+="/"}currPath+=folderStr;setupFolderTbl()}function setupFolderTbl(){var fullPath=currVolume+"/"+currPath;cleanTbl();currSelect="";var command={};command.targetPath=fullPath;$.act(ACT_SET,FOLDER_BROWSE,null,null,command);folderList=$.act(ACT_GL,FOLDER_NODE,null,null,null);if(!$.exe()){if(""!=currPath){var folderTbl=$.id("Folder_tbl");var row=folderTbl.insertRow(-1);var cell=row.insertCell(-1);cell.innerHTML="<span class='a' onClick='upper();'>"+m_str.upperFolder+"</span>"}for(idx=0;idx<folderList.length;idx++){var folderTbl=$.id("Folder_tbl");var row=folderTbl.insertRow(-1);var cell=row.insertCell(-1);var folderNameStr=escapeStr(folderList[idx].folderName);cell.innerHTML="<span class='a' onClick='browsePath(this);'>"+folderNameStr+"</span>"}if(""!=currPath){$.id("currPath").value="/"+currPath+"/"}else{$.id("currPath").value=currPath+"/"}var currPathStr=escapeStr(currPath);$.id("volumeInfo").innerHTML="/"+currVolume+"/"+currPathStr;if(""!=currPath){$.id("volumeInfo").innerHTML+="/"}}}function loadVolume(){currVolume=$.id("volumeList").value;currPath="";if(""==currVolume){cleanTbl();$.id("currPath").value="/";$.id("volumeInfo").innerHTML="";return}setupFolderTbl()}function changeVolume(){loadVolume()}function init(){usbDeviceList=$.act(ACT_GL,USB_DEVICE,null,null,null);volumeList=$.act(ACT_GL,LOGICAL_VOLUME,null,null,null);if("SMB"==pageType){folderObj=SMB_SERVICE_FOLDER;userObj=SMB_USER_ACCESS;userList=$.act(ACT_GL,USER_ACCOUNT,null,null,null);$.removeClass($.id("t_info1"),"nd")}if("FTP"==pageType){folderObj=FTP_SERVER_FOLDER;userObj=FTP_USER_ACCESS;userList=$.act(ACT_GL,USER_ACCOUNT,null,null,null);$.removeClass($.id("t_info2"),"nd")}if("DLNA"==pageType){folderObj=DLNA_MEDIA_SERVER_FOLDER;$.removeClass($.id("t_info3"),"nd")}if(""!=folderObj){accessFolderList=$.act(ACT_GL,folderObj,null,null,null)}if(""!=userObj){userAccessList=$.act(ACT_GL,userObj,null,null,null)}if(!$.exe()){var option;var sel=$.id("volumeList");for(idx=0;idx<volumeList.length;idx++){if("Online"==volumeList[idx].status){var text;for(i=0;i<usbDeviceList.length;i++){if(parseInt(usbDeviceList[i].__stack,10)==parseInt(volumeList[idx].__stack,10)){text=usbDeviceList[i].vendor+" ( "+usbDeviceList[i].model+")";break}}text+=(", "+volumeList[idx].name+"("+volumeList[idx].capacity+","+volumeList[idx].fileSystem+")");var option=$.c("option");option.value=volumeList[idx].name;option.text=text;var sel=$.id("volumeList");try{sel.add(option,null)}catch(e){sel.add(option)}}}if("DLNA"==pageType){$.addClass($.id("User_Account"),"nd")}else{if(("SMB"==pageType)||("FTP"==pageType)){for(idx=1;idx<=userList.length;idx++){var user_tbl=$.id("user_tbl");var newrow=user_tbl.insertRow(-1);var cell=newrow.insertCell(-1);cell.innerHTML=idx;if(0==userList[idx-1].enable){cell.style.color="#999"}if(1==userList[idx-1].X_TP_SupperUser){cell.innerHTML+="*"}else{cell.innerHTML+="&nbsp;"}var cell=newrow.insertCell(-1);cell.innerHTML=escapeStr(userList[idx-1].username);var cell=newrow.insertCell(-1);if(""!=userList[idx-1].username){cell.innerHTML='<input name="access'+idx+'" id="access_rw_'+idx+'" type="radio" /><span class="T T_faccess">Full-Access'+blank+'</span><input name="access'+idx+'" id="access_r_'+idx+'" type="radio" /><span class="T T_ronly">Read-Only'+blank+'</span><input name="access'+idx+'" id="access_n_'+idx+'" type="radio" checked /><span class="T T_naccess">No-Access'+blank+"</span>"}else{cell.innerHTML="&nbsp;"}if(1==userList[idx-1].X_TP_SupperUser){$.id("access_rw_"+idx).checked=true;$.id("access_rw_"+idx).disabled=true;$.id("access_r_"+idx).disabled=true;$.id("access_n_"+idx).disabled=true}}}}if("ADD"==pageStatus){$.id("currPath").value="/";folderIdx=accessFolderList.length}else{$.id("currPath").value=pageInfo;for(idx=0;idx<accessFolderList.length;idx++){if(pageInfo==accessFolderList[idx].name){$.id("shareName").value=accessFolderList[idx].alias;folderIdx=idx;break}}for(i=0;i<userAccessList.length;i++){if(parseInt(accessFolderList[idx].__stack,10)!=parseInt(userAccessList[i].__stack,10)){continue}if(7==userAccessList[i].permissions){$.id("access_rw_"+userAccessList[i].userId).checked=true}else{if(3==userAccessList[i].permissions){$.id("access_r_"+userAccessList[i].userId).checked=true}}}}}};</script>
<p class="et T" id="et">Folder Browse</p>
<div class="con1 L">
<p class="ct"></p>
<p class="bl"></p>
<div class="con2">
<p class="L1 T" >
<span class="nd T" id="t_info1">This page allows you to set a shared folder and access authorization for Storage Sharing service! It will not take effect when Anonymous access been enabled.</span>
<span class="nd T" id="t_info2">This page allows you to set a shared folder and access authorization for FTP service!</span>
<span class="nd T" id="t_info3">This page allows you to set a scan folder for DLNA media service!</span>
</p>
<p class="br"></p>
<p><b class="item L T" id="t_shname">Share Name:</b><input id="shareName" class="text" size="31" maxlength="31" type="text" /></p>
<p><b class="item L T" id="t_dir">Directory:</b><input id="currPath" class="text" size="31" maxlength="127" type="text" disabled /></p>
<p><b class="item L T">&nbsp;</b><input type="button" id="Browse" class="button M T T_browse" value="Browse" onclick="doBrowse()"/></p>
<p class="br"></p>
	<div id="Folder_Browse" style="width:800px;" class="nd">
		<p class="br"></p>
		<p><b class="L T" id="t_vol">Select Volume:</b><select id="volumeList" onchange="changeVolume();" ><option class="T" id="t_selvol" value="">--please choose volume--</option></select></p>
		<p class="br"></p>
		<table class='tbody' id='Folder_tbl' width='90%' >
			<tr>
				<th width="450px" style="text-align:left;"><span id="volumeInfo"></span></th>
			</tr>
		</table>
		<p class="br"></p>
	</div>
	<div id="bl_line" class="nd">
		<p class="bl"></p>
	</div>
	<div id="User_Account" width="100%" >
	<p><b class="L T" id="t_tbl">User Access Control Table:</b></p>
	<table class='bdr tc' id='user_tbl' width='90%' >
		<tr>
			<th width="40px" class="T T_index">Index</th>
			<th width="300px" class="T T_username">Username</th>
			<th width="300px" class="T" id="t_author">Access Authorization</th>
		</tr>
	</table>
	<p>* : <span class="T" id="t_note">"Super User". It has full-access permission (Read & Write) to all active volume(s) and share folder(s).</span></p>
	</div>
</div>
<p class="bl"></p>
<p class="tail">
<input type="button" class="button M T T_apply" id="applyButton" value="Apply" onclick="doSet()"/>
</p>
</div>
<script language="javascript" type="text/javascript">var pageType;var pageStatus;var pageInfo;if($.local){pageType="SMB";pageStatus="ADD";pageInfo="/"}else{pageType=$.mainParam[0];pageStatus=$.mainParam[1];pageInfo=$.mainParam[2]}init();</script>