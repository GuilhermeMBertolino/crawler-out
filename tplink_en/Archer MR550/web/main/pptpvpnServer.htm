<script language="javascript">function init(){if(curPvpnObj=$.act(ACT_GET,PPTPVPN,null,null),!$.exe()){$("#pptpvpnEn").prop("checked",1==curPvpnObj.enable),$("#cliIpStart").tpAddress("val",curPvpnObj.remoteIpStart);var t=curPvpnObj.remoteIpEnd.split(".");$("#cliIpEndNum").prop("value",t[3]);var e=new Array(t[0],t[1],t[2]).join(".");$("#cliIpSubnet").text("-"+e+"."),$("#username").prop("value",curPvpnObj.username),$("#password").prop("value",curPvpnObj.password)}}function checkParaValidity(){var t=$("#cliIpStart").tpAddress("val"),e=$("#cliIpEndNum").val(),r=$("#username").prop("value"),n=$("#password").prop("value"),l=t.split(".")[3];if(""==t||"0.0.0.0"==t)return $.alert(ERR_IP_FORMAT),$("#cliIpStart").focus().select(),!1;if(""!=t&&"0.0.0.0"!=t&&$.ifip(t,!0))return $.alert(ERR_IP_FORMAT),$("#cliIpStart").focus().select(),!1;if(parseInt(l,10)<1||parseInt(l,10)>254)return $.alert(ERR_IP_FORMAT),$("#cliIpStart").focus().select(),!1;if(!$.isnum(e)||parseInt(e,10)<1||parseInt(e,10)>254)return $.alert(ERR_IP_FORMAT),$("#cliIpEndNum").focus().select(),!1;if(parseInt(e,10)<l)return $.alert(ERR_PVPN_ERR_CLI_IP_STARTNUM_GREATER),$("#cliIpStart").focus().select(),!1;if(parseInt(e,10)>=parseInt(l,10)+10)return $.alert(ERR_PVPN_ERR_CLI_IP_MORE_THAN_TEN),$("#cliIpEndNum").focus().select(),!1;var p=/^[a-zA-Z0-9_-]+$/;return 0==p.test(r)||r.length>15?($.alert(ERR_PVPN_INVALID_USERNAME_PASSWORD),$("#username").focus().select(),!1):!(0==p.test(n)||n.length>15)||($.alert(ERR_PVPN_INVALID_USERNAME_PASSWORD),$("#password").focus().select(),!1)}function checkNothingChg(){if(1==curPvpnObj.enable&&0==$("#pptpvpnEn").prop("data-checked")||0==curPvpnObj.enable&&1==$("#pptpvpnEn").prop("data-checked"))return!1;var t=curPvpnObj.remoteIpEnd.split(".");return $("#cliIpStart").tpAddress("val")==curPvpnObj.remoteIpStart&&$("#cliIpEndNum").prop("value")==parseInt(t[3],10)&&($("#username").prop("value")==curPvpnObj.username&&$("#password").prop("value")==curPvpnObj.password)}function checkConflictPptpVSPort(t,e){var r=!1;return 0==e?1723==t&&(r=!0):0==t?1723==e&&(r=!0):t<=1723&&e>=1723&&(r=!0),!!r}function checkConflictPptpPTPort(t){for(var e=!1,r=(t=t.toString()).split(","),n=0;n<r.length;n++){var l=r[n].split("-");if(1==l.length){if(1723==l[0]){e=!0;break}}else if(2==l.length){if(l[0]>l[1]){var p=l[0];l[0]=l[1],l[1]=p}if(l[0]<=1723&&l[1]>=1723){e=!0;break}}}return!!e}var curPvpnObj,newPvpnObj;$("#save").click(function(){if($.addLoading($(this)),checkParaValidity()){if(!checkNothingChg()){var t,e,r,n,l,p=$("#pptpvpnEn").prop("data-checked")?1:0,a=$("#cliIpStart").tpAddress("val"),P=a.split("."),o=new Array(P[0],P[1],P[2]).join(".")+"."+$("#cliIpEndNum").prop("value"),c=$("#username").prop("value"),i=$("#password").prop("value"),s=[],u=[],_=0;if(parseInt(P[3],10)>1)I=new Array(P[0],P[1],P[2],parseInt(P[3],10)-1);else var I=new Array(P[0],P[1],P[2],parseInt($("#cliIpEndNum").prop("value"),10)+1);var T=I.join(".");l=$.act(ACT_GET,DMZ_HOST_CFG,null,null),s=$.act(ACT_GL,WAN_IP_CONN_PORTMAPPING,null,null),t=$.act(ACT_GL,IP_CONN_PORTTRIGGERING,null,null),u=$.act(ACT_GL,WAN_PPP_CONN_PORTMAPPING,null,null),e=$.act(ACT_GL,PPP_CONN_PORTTRIGGERING,null,null);var h=$.act(ACT_GL,UPNP_PORTMAPPING,null,null),v=$.act(ACT_GET,UPNP_CFG,null,null);return INCLUDE_L2TP&&(vtlServList_L2TP=$.act(ACT_GL,WAN_L2TP_CONN_PORTMAPPING,null,null),r=$.act(ACT_GL,L2TP_CONN_PORTTRIGGERING,null,null)),INCLUDE_PPTP&&(vtlServList_PPTP=$.act(ACT_GL,WAN_PPTP_CONN_PORTMAPPING,null,null),n=$.act(ACT_GL,PPTP_CONN_PORTTRIGGERING,null,null)),$.exe(),$.each(s,function(){checkConflictPptpVSPort(this.externalPort,this.X_TP_ExternalPortEnd)&&1==this.portMappingEnabled&&"UDP"!=this.portMappingProtocol&&(_=1)}),$.each(u,function(){checkConflictPptpVSPort(this.externalPort,this.X_TP_ExternalPortEnd)&&1==this.portMappingEnabled&&"UDP"!=this.portMappingProtocol&&(_=1)}),$.each(t,function(){checkConflictPptpPTPort(this.openPort)&&1==this.enable&&"UDP"!=this.openProtocol&&(_=2)}),$.each(e,function(){checkConflictPptpPTPort(this.openPort)&&1==this.enable&&"UDP"!=this.openProtocol&&(_=2)}),INCLUDE_L2TP&&($.each(vtlServList_L2TP,function(){checkConflictPptpVSPort(this.externalPort,this.externalPortEnd)&&1==this.portMappingEnabled&&"UDP"!=this.portMappingProtocol&&(_=1)}),$.each(r,function(){checkConflictPptpPTPort(this.openPort)&&1==this.enable&&"UDP"!=this.openProtocol&&(_=2)})),INCLUDE_PPTP&&($.each(vtlServList_PPTP,function(){checkConflictPptpVSPort(this.externalPort,this.externalPortEnd)&&1==this.portMappingEnabled&&"UDP"!=this.portMappingProtocol&&(_=1)}),$.each(n,function(){checkConflictPptpPTPort(this.openPort)&&1==this.enable&&"UDP"!=this.openProtocol&&(_=2)})),$.each(h,function(){"1723"==this.externalPort&&1==v.enable&&"UDP"!=this.portMappingProtocol&&"UDP"!=this.portMappingProtocol&&(_=3)}),1==p&&1==l.enable?($.alert(CMM_DMZ_CONFLICT_WITH_PVPN),void $.reload()):1==p&&1==_?($.alert(CMM_VS_CONFLICT_WITH_PVPN),void $.reload()):1==p&&2==_?($.alert(CMM_PT_CONFLICT_WITH_PVPN),void $.reload()):1==p&&3==_?($.alert(CMM_UPNP_CONFLICT_WITH_PVPN),void $.reload()):($.act(ACT_SET,PPTPVPN,null,null,["enable="+p,"remoteIpStart="+a,"remoteIpEnd="+o,"username="+c,"password="+i,"localIp="+T]),void $.exe(function(t){$.removeLoading(),t||$.reload()}))}$.removeLoading()}else $.removeLoading()})</script>
<h3 id="t_pptpvpn">PPTP VPN</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div>
            <b class="l" id="t_empty"></b>
            <input type="checkbox" id="pptpvpnEn">
            <label id="t_enPvpn">Enable VPN Server</label>
        </div>
        <div>
            <b class="l" id="t_cliIp">Client IP Address:</b>
            <input type="text" id="cliIpStart" class="l ip-address" required>
            <span id="cliIpSubnet">-</span>
            <input type="text" id="cliIpEndNum" class="s" required>
            <span id="t_maxCli">(up to 10 clients)</span>
        </div>
        <div>
            <b class="l" id="t_username">Username:</b>
            <input type="text" id="username" class="xl" required>
        </div>
        <div>
            <b class="l" id="t_password">Password:</b>
            <input type="text" id="password" class="xl" required>
        </div>

        <div class="part-separate">
            <button type="submit" class="green T_save" id="save">Save</button>
        </div>
    </form>
</div>
<script language="javascript">var headArray=[{text:'<div><input type="checkbox" id="staticAll" class="table-select-all" /><label></label></div>',width:"8%"},{text:"ID",width:"8%"},{text:"Username",width:"28%"},{text:"Password",width:"28%"},{text:table_str.modify,width:"28%"}];$.initTableHead($("#account-list"),headArray),$("#account-list").tpTable(),$.tpInit(init)</script>
