<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>OpenVPN</title>
</head>
<body>
<div class="func-container">
	<div id="open_vpn">
		<p class="note no-cert-note-container hidden">
            <span class="title note-title"></span>
            <span class="text" id="no_cert_note"></span>
        </p> 
		<input type="text" id="enable_vpn_server" name="enabled" />
		<input type="text" id="service_type" name="proto" />
		<input type="text" id="service_port" name="port" />
		<input type="text" id="vpn_subnet" name="serverip" />
		<input type="text" id="vpn_mask" name="mask"/>
		<input type="text" id="access_type" name="access" />
		<button type="button" id="btn_save" name="btn_save"></button>
                <p class="note not-ready-note-container hidden">
                <span class="title note-title"></span>
                <span class="text" id="not_ready_note"></span>
                </p>	
	</div>
	<div id="cert_file">
		<div id="cert_generate_setting">
			<p id="cert_generate_note" name="cert_generate_note"  class="note first-line inline-block"></p>
			<div class="cert_generate_button_ctn">
				<span id="cert_generate_status" class="hidden"></span>
				<button type="button" id="cert_generate_btn"></button>
			</div>
		</div>
	</div>
	<div id="conf_file">
		<div id="export_setting">
			<p id="export_note" name="export_note"  class="note first-line inline-block"></p>
			<button type="button" id="export_btn"></button>
		</div>
	</div>
	<div id="cert_generate_confirm" class="hidden">
		<h4 class="title">
			<span class="icon" ></span>
			<span class="text" id="cert_generate_str"></span>
		</h4>
	</div>
	<div id="cert_generate_promsg" class="hidden">
		<p id="cert_generate_tips"></p>
		<input id="cert-generate-probar" />
	</div>
	<div id="vpn_help"></div>
<div>
<script type="text/javascript">try{$}catch(e){location.href="/"}$(document).ready(function(E){var G=$.su.url("/admin/openvpn?form=openvpn_cert");var p=$.su.url("/admin/openvpn?form=export");var j=$.su.url("/admin/openvpn?form=config");var f=$.su.url("/admin/nat?form=vs");var H=$.su.url("/admin/nat?form=pt");var w=$.su.url("/admin/nat?form=dmz");var c=$.su.url("/admin/upnp?form=service_vpn");var k=false;var t=false;var d=false;var g="";var y=0;var z=new $.su.Proxy({url:f});var s=0;var C=new $.su.Proxy({url:H});var v=0;var l=new $.su.Proxy({url:w});var b=0;var r=new $.su.Proxy({url:c});z.read({operation:"load"},function(I){y=I});C.read({operation:"load"},function(I){s=I});l.read({},function(I){v=I.enable});r.read({operation:"load"},function(I){b=I});var B="";var a="";var A=new $.su.Proxy({url:$.su.url("/admin/dhcps?form=setting")});A.read({},function(I){B=I.ipaddr_start;a=I.ipaddr_end});var m="";var n=new $.su.Proxy({url:$.su.url("/admin/dhcps?form=reservation")});n.read({operation:"load"},function(I){m=I});var o="";var x="";var i=new $.su.Proxy({url:$.su.url("/admin/pptpd?form=config")});i.read({},function(J){var I=J.remoteip;o=I.substr(0,I.indexOf("-"));x=o.substr(0,o.lastIndexOf(".")+1)+I.substr(I.indexOf("-")+1);o=$.su.format.ip(o);x=$.su.format.ip(x)});$("span.note-title").text($.su.CHAR.OPERATION.NOTE);$("#no_cert_note").html($.su.CHAR.VPN.NO_CERT_NOTE);$("#no_cert_note2").html($.su.CHAR.VPN.NO_CERT_NOTE2);$("#cert_generate_tips").html($.su.CHAR.VPN.GENERATE_TIPS);$("#not_ready_note").html($.su.CHAR.VPN.NOT_READY_NOTE);$("#open_vpn").on("click","a#go-to-time",function(){$.su.menu.advanced.goTo("time-settings")});$("#open_vpn").on("click","a#go-to-internet",function(){$.su.menu.advanced.goTo("internet")});$("div#open_vpn").panel({title:$.su.CHAR.VPN.OPEN_VPN,collapsible:false});$("div#open_vpn").form({proxy:{timeout:30000,url:j},fields:[{name:"enabled",mapping:"enabled"},{name:"proto",mapping:"proto"},{name:"port",mapping:"port"},{name:"serverip",mapping:"serverip"},{name:"mask",mapping:"mask"},{name:"access",mapping:"access"}],submitBtn:"#btn_save",validator:function(){var K=$("input#vpn_subnet").textbox("getValue");var N=$("input#vpn_mask").textbox("getValue");var I=$("input#service_port").textbox("getValue");var O=$("input#service_type").radio("getValue");var P=$("input#chk_enable_vpn_server").checkbox("getValue");if(P=="enabled"){for(var M in y){var S=y[M].external_port;var V=y[M].enable;var R=y[M].protocol;if(V=="on"&&(R.toLowerCase()==O||R=="ALL")&&S==I){$("div#open_vpn").form("setError",$.su.CHAR.ERROR["00000220"]);$("input#service_port").textbox("setError");return false}}for(var M in s){var U=s[M].external_port;var L=s[M].enable;var Q=s[M].external_protocol;if(L=="on"&&(Q.toLowerCase()==O||Q=="ALL")&&U==I){$("div#open_vpn").form("setError",$.su.CHAR.ERROR["00000221"]);$("input#service_port").textbox("setError");return false}}for(var M in b){var J=b[M].external_port;var T=b[M].protocol;if((T.toLowerCase()==O||T=="ALL")&&J==I){$("div#open_vpn").form("setError",$.su.CHAR.ERROR["00000223"]);$("input#service_port").textbox("setError");return false}}if(v=="on"){$("div#open_vpn").form("setError",$.su.CHAR.ERROR["00000222"]);return false}}if($.su.func.ipToInt(N)>$.su.func.ipToInt("255.255.255.248")){$("div#open_vpn").form("setError",$.su.CHAR.VPN.VPN_MASK_ERROR);$("input#vpn_mask").textbox("setError");return false}if($.su.func.isSameNet(o,K,N)){$("div#open_vpn").form("setError",$.su.CHAR.VPN.CONFLICT_WITH_PPTPVPN);$("input#vpn_subnet").textbox("setError");return false}if($.su.func.isSameNet(x,K,N)){$("div#open_vpn").form("setError",$.su.CHAR.VPN.CONFLICT_WITH_PPTPVPN);$("input#vpn_subnet").textbox("setError");return false}for(var M=0;M<m.length;++M){if($.su.func.isSameNet(m[M].ip,K,N)){$("div#open_vpn").form("setError",$.su.CHAR.VPN.CONFLICT_WITH_RESERVED2);$("input#vpn_subnet").textbox("setError");return false}}if($.su.func.isSameNet(B,K,N)){$("div#open_vpn").form("setError",$.su.CHAR.VPN.CONFLICT_WITH_DHCP2);$("input#vpn_subnet").textbox("setError");return false}if($.su.func.isSameNet(a,K,N)){$("div#open_vpn").form("setError",$.su.CHAR.VPN.CONFLICT_WITH_DHCP2);$("input#vpn_subnet").textbox("setError");return false}return true}}).on("ev_loadData",function(J,I){t=I.cert_exist||false;enabled=I.enabled||false;check_ready=I.precheck_ready||false;$(".not-ready-note-container").show();if(!check_ready&&!enabled){$("div#open_vpn").form("disable");$(".no-cert-note-container").hide()}else{if(!t&&!d){$(".no-cert-note-container").show()}else{$(".no-cert-note-container").hide()}}});$("input#enable_vpn_server").checkbox({fieldLabel:"",tips:"",cls:"",items:[{boxlabel:$.su.CHAR.VPN.ENABLE_VPN_SERVER,uncheckedValue:"off",inputValue:"on",id:"chk_enable_vpn_server"}]});$("input#service_type").radio({fieldLabel:$.su.CHAR.VPN.SERVICE_TYPE,cls:"inline-block",columns:2,items:[{boxlabel:$.su.CHAR.VPN.UDP,inputValue:"udp"},{boxlabel:$.su.CHAR.VPN.TCP,inputValue:"tcp"}]});$("input#service_port").textbox({fieldLabel:$.su.CHAR.VPN.SERVICE_PORT,allowBlank:false,textFormat:$.su.format.number,maxLength:5,vtype:{vtype:"number",max:65535,min:1024}});$("input#vpn_subnet").textbox({fieldLabel:$.su.CHAR.VPN.VPN_SUBNET,allowBlank:false,textFormat:$.su.format.ip,vtype:"ip",cls:"inline-block"});$("input#vpn_mask").textbox({fieldLabel:null,allowBlank:false,textFormat:$.su.format.ip,vtype:"netmask",cls:"inline-block"});$("input#access_type").radio({fieldLabel:$.su.CHAR.VPN.CLIENTS_ACCESS,cls:"inline-block",columns:2,items:[{boxlabel:$.su.CHAR.VPN.HOME_NETWORK_ONLY,inputValue:"home"},{boxlabel:$.su.CHAR.VPN.INTERNET_HOME,inputValue:"internet"}]});$("button#btn_save").button({text:$.su.CHAR.OPERATION.SAVE,cls:"submit",handler:function(I){$("button#btn_save").button("disable");if(!$("div#open_vpn").form("validate")){$("button#btn_save").button("enable");return false}g="openvpn";if(!t&&!d){$("#cert_generate_str").html($.su.CHAR.VPN.CERT_STR);$("#cert_generate_confirm").msg("show");$("button#btn_save").button("enable");return}$("div#open_vpn").form("submit",{},function(){$("button#btn_save").button("enable")},function(){$("button#btn_save").button("enable")},function(){$("button#btn_save").button("enable")});setTimeout(function(){$("button#btn_save").button("enable")},1000)}});$("div#cert_file").panel({title:$.su.CHAR.VPN.GENERATE_CERT,collapsible:false});$("p#cert_generate_note").html($.su.CHAR.VPN.GENERATE_NEW_CERT);cert_generate_proxy=new $.su.Proxy({timeout:40000,url:G});var D=$("div#cert_generate_setting").form({proxy:cert_generate_proxy,formEnctype:"multipart/form-data",traditional:true,hiddenFrame:true,autoLoad:false});$("button#cert_generate_btn").button({text:$.su.CHAR.VPN.GENERATE,cls:"submit inline-block",handler:function(){if(k){clearInterval(k);k=false}F.msg("show");$("#cert-generate-probar").progressbar("reset");$("#cert-generate-probar").progressbar("animate",0,1,480000,function(){d=false;$("#cert_generate_status").html($.su.CHAR.VPN.CERT_FAIL);F.msg("close");h("timeout","error")});cert_generate_proxy.write({operation:"generate"});k=setInterval(function(){cert_generate_proxy.write({operation:"check"},function(I){if(I.cert_status=="generating"){return}else{if(I.cert_status=="error"){d=false;$("#cert_generate_status").html($.su.CHAR.VPN.CERT_FAIL);h("interrupt","error")}else{if(I.cert_status=="success"){d=true;$(".no-cert-note-container").hide();$("#cert_generate_status").html($.su.CHAR.VPN.CERT_SUCCESS);h("interrupt","success")}else{}}}},function(){})},1000)}});var h=function(J,I){if(k){clearInterval(k);k=false}if(J=="interrupt"){$("#cert-generate-probar").progressbar("stop");$("#cert-generate-probar").progressbar("animate",null,1,250,function(){F.msg("close")});if(I=="success"){setTimeout(function(){if(g=="openvpn"){$("button#btn_save").trigger("click")}else{if(g=="export"){$("button#export_btn").trigger("click")}else{}}g=""},250)}}$("#cert_generate_status").show()};$("div#conf_file").panel({title:$.su.CHAR.VPN.CONF_FILE,collapsible:false});$("p#export_note").html($.su.CHAR.VPN.EXPORT_CONF_FILE);var q=$("div#export_setting").form({proxy:{timeout:30000,url:p},formEnctype:"multipart/form-data",traditional:true,hiddenFrame:true,autoLoad:false});$("button#export_btn").button({text:$.su.CHAR.VPN.EXPORT,cls:"submit inline-right",handler:function(){$("button#export_btn").button("disable");g="export";if(!t&&!d){$("#cert_generate_str").html($.su.CHAR.VPN.CERT_STR2);$("#cert_generate_confirm").msg("show");$("button#export_btn").button("enable");return}$("#export_setting").form("submit",{operation:"backup"},function(){$("button#export_btn").button("enable")},function(){$("button#export_btn").button("enable")},function(){$("button#export_btn").button("enable")});setTimeout(function(){$("button#export_btn").button("enable")},1000)}});$("#cert_generate_confirm").msg({type:"prompt",cls:"warning",okHandler:function(){$("#cert_generate_confirm").msg("hide");$("button#cert_generate_btn").trigger("click")},cancelHandler:function(){g=""}});var F=$("#cert_generate_promsg").msg({type:"prompt",closeBtn:false,cls:"warning reboot-confirm-size"});F.msg("hideButtons");$("#cert-generate-probar").progressbar({width:270,height:6});$.su.app.runningModule.addUnloadHandler(function(){if(k){clearInterval(k);k=false}});$("div#open_vpn").on("click","a#go-to-vs",function(){$.su.menu.advanced.goTo("virtual-servers")});$("div#open_vpn").on("click","a#go-to-pt",function(){$.su.menu.advanced.goTo("port-triggering")});$("div#open_vpn").on("click","a#go-to-dmz",function(){$.su.menu.advanced.goTo("dmz")});$("div#open_vpn").on("click","a#go-to-upnp",function(){$.su.menu.advanced.goTo("upnp")});var u=new $.su.Help({container:"div#vpn_help",content:["OPEN_VPN","OPEN_VPN_CERTIFICATE","OPEN_VPN_CONF","OPEN_VPN_GUIDE"]})});</script>
</body>
</html>