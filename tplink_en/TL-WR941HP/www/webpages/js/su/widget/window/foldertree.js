(function(a){a.su.Widget("foldertree",{defaults:{store:null,routerName:"My Router",selectLeaves:false,extension:"*",multiple:false,multipleValue:[]},create:function(f,d){var e=this;e.each(function(j,l){var g=a(l);a.extend(l,f,d);var k='<div class="container widget-container foldertree-container">';k+='<div class="router">';k+='<span class="icon"></span>';k+='<span class="text">'+l.routerName+"</span>";k+="</div>";k+="</div>";var h=a(k);g.replaceWith(h);h.append(g.addClass("hidden"))});var b=e.closest("div.foldertree-container");b.delegate("a.foldertree-text","click",function(j){j.preventDefault();j.stopPropagation();var g=a(this);var i=g.attr("data-path");if(e.get(0).selectLeaves){if(g.attr("data-type")!="leaf"){return}b.find("li.foldertree-branch, a.foldertree-text").removeClass("selected");g.closest("li.foldertree-branch").addClass("selected");g.addClass("selected");e.foldertree("setValue",i);return}if(e.get(0).multiple){var h=function(o,k){var l=o;var n=l.attr("data-path");var m=false;while(!l.parent().hasClass("foldertree-root")){if(k){l.closest("ul").children("li").each(function(p,r){if(!a(r).hasClass("selected")){if(a.inArray(n,e.get(0).multipleValue)==-1){var q=[];a.each(e.get(0).multipleValue,function(t,s){if(!new RegExp(i+"/").test(s)){q.push(s)}});e.get(0).multipleValue=q;e.get(0).multipleValue.push(n)}m=true;return false}else{if(p==l.closest("ul").children("li").length-1){l.closest("ul").parent().addClass("selected");l.closest("ul").parent().children("a").addClass("selected");l.closest("ul").children("li").children("a").each(function(s,t){if(a.inArray(a(t).attr("data-path"),e.get(0).multipleValue)>-1){e.get(0).multipleValue.splice(a.inArray(a(t).attr("data-path"),e.get(0).multipleValue),1)}});if(a.inArray(a(r).closest("ul").parent().children("a").attr("data-path"),e.get(0).multipleValue)==-1){e.get(0).multipleValue.push(l.closest("ul").parent().children("a").attr("data-path"))}var q=[];a.each(e.get(0).multipleValue,function(t,s){if(!new RegExp(i+"/").test(s)){q.push(s)}});e.get(0).multipleValue=q}}})}else{l.closest("ul").children("li").each(function(p,q){if(!a(q).hasClass("selected")&&a(q).children("a").attr("data-path")!=l.attr("data-path")){if(a.inArray(n,e.get(0).multipleValue)>-1){e.get(0).multipleValue.splice(a.inArray(n,e.get(0).multipleValue),1)}m=true;return false}else{if(p==l.closest("ul").children("li").length-1){l.closest("ul").parent().removeClass("selected");l.closest("ul").parent().children("a").removeClass("selected");l.closest("ul").children("li").children("a").each(function(r,s){if(a.inArray(a(s).attr("data-path"),e.get(0).multipleValue)==-1&&a(s).attr("data-path")!=l.attr("data-path")){e.get(0).multipleValue.push(a(s).attr("data-path"))}});if(a.inArray(l.closest("ul").parent().children("a").attr("data-path"),e.get(0).multipleValue)>-1){e.get(0).multipleValue.splice(a.inArray(l.closest("ul").parent().children("a").attr("data-path"),e.get(0).multipleValue),1)}}}})}if(m){return}l=l.parent().closest("ul").prev();n=l.attr("data-path")}};if(g.closest("li.foldertree-branch").hasClass("selected")||g.hasClass("selected")){g.parent().removeClass("selected");g.removeClass("selected");g.parent().find("li").removeClass("selected");g.parent().find("a").removeClass("selected");if(g.parent().hasClass("foldertree-root")){e.get(0).multipleValue=[]}else{h(g,false)}}else{g.closest("li.foldertree-branch").addClass("selected");g.addClass("selected");g.parent().find("li").addClass("selected");g.parent().find("a").addClass("selected");if(g.parent().hasClass("foldertree-root")){e.get(0).multipleValue=[i]}else{h(g,true)}}return}b.find("li.foldertree-branch, a.foldertree-text").removeClass("selected");g.closest("li.foldertree-branch").addClass("selected");g.addClass("selected");e.foldertree("setValue",i)}).delegate("span.foldertree-icon","click",function(m){m.preventDefault();m.stopPropagation();var i=a(this),l=i.attr("data-path"),g=e.get(0).store,h=i.next("a.foldertree-text").next("ul.foldertree-wrap"),k=h.next("ul.foldertree-wrap"),j=e.get(0).uuid;if(i.hasClass("foldertree-root")){return}if(i.hasClass("foldertree-has-branch")){if(i.hasClass("opened")){h.slideUp(200,function(){i.removeClass("opened")});if(k){k.slideUp(200,function(){i.removeClass("opened")})}}else{g.loadNode(l,{path:l,uuid:j},function(){i.addClass("opened");h.slideDown(200);if(k){k.slideDown(200)}})}}if(e.get(0).multiple){e.val(e.get(0).multipleValue)}});var c=a(e.get(0).store);c.on("ev_loaddata",function(h,g){e.foldertree("load",g)}).on("ev_loadnode",function(l,h,m,j){var k=b.find("ul.foldertree-wrap"),g=null;k.each(function(n,o){if(a(o).attr("data-path")==m){g=a(o);return false}});if(a.isArray(j.branches)){e.foldertree("initBranch",j.branches,g)}if(e.get(0).selectLeaves){var i;if(g.siblings(".foldertree-leaf-wrap").length){i=g.siblings(".foldertree-leaf-wrap")}else{i=a('<ul class="foldertree-wrap foldertree-leaf-wrap" data-path="'+m+'" ></ul>');g.after(i)}e.foldertree("initLeaf",j.leaves,i)}});return e},load:function(c,f){var c=c||this,b=c.closest("div.foldertree-container"),e=c.get(0),d=f[1][0];c.foldertree("initRoot",d,b);c.trigger("ev_treeloaded",[c,d]);return c},initRoot:function(k,g){var k=k||this,h=k.get(0),e=k.closest("div.foldertree-container"),i=g[1]||{},j=g[2],d=i.uuid||"0000000000";h.uuid=d;if(!i){return k}e.find("div.foldertree-root").remove();var l=i.hasBranch?"foldertree-has-branch":"";var c='<div class="foldertree-root">';c+='<span class="foldertree-icon foldertree-root '+l+' opened" data-path="'+i.path+'"></span>';if(k.get(0).multiple){c+='<a href="javascript:void(0);" class="foldertree-text" data-path="'+i.path+'">'}else{c+='<a href="javascript:void(0);" class="foldertree-text foldertree-root" data-path="'+i.path+'">'}c+='<span class="icon"></span>';c+='<span class="text">'+i.name+"</span>";c+="</a>";c+='<ul class="foldertree-wrap foldertree-root-wrap" data-path="'+i.path+'"></ul>';c+='<ul class="foldertree-wrap foldertree-leaf-wrap" data-path="'+i.path+'"></ul>';c+="</div>";var f=a(c);j.append(f);if(i.hasBranch){var b=f.find("ul.foldertree-root-wrap");k.foldertree("initBranch",i.branches,b)}if(i.leavesInfo&&k.get(0).selectLeaves){var b=f.find("ul.foldertree-leaf-wrap");k.foldertree("initLeaf",i.leaves,b)}return k},initBranch:function(k,d){var k=k||this,h=d[1],g=d[2].empty(),l=g.prev("a.foldertree-text").prev("span.foldertree-icon");if(!a.isArray(h)){h=[h]}var b="";if(h.length==0){l.removeClass("foldertree-has-branch")}else{for(var i=0,j=h.length;i<j;i++){var f=h[i];var m=(f.hasBranch||f.hasLeaves)?"foldertree-has-branch":"foldertree-has-branch opened";var e=(i==j-1)?"lst":"";if(g.parent().hasClass("selected")||a.inArray(f.path,k.get(0).multipleValue)>-1){b+='<li class="foldertree-branch selected'+e+'">'}else{b+='<li class="foldertree-branch '+e+'">'}b+='<span class="foldertree-icon foldertree-branch '+m+'" data-path="'+f.path+'"></span>';if(g.parent().hasClass("selected")||a.inArray(f.path,k.get(0).multipleValue)>-1){b+='<a href="javascript:void(0);" class="foldertree-text foldertree-branch selected" data-path="'+f.path+'">'}else{b+='<a href="javascript:void(0);" class="foldertree-text foldertree-branch " data-path="'+f.path+'">'}b+='<span class="icon"></span>';b+='<span class="text">'+f.name+"</span>";b+="</a>";b+='<ul class="foldertree-wrap foldertree-branch-wrap" data-path="'+f.path+'"></ul>';b+="</li>"}var c=a(b);g.append(c);l.addClass("foldertree-has-branch")}return k},initLeaf:function(k,d){var k=k||this,m=k.get(0).extension,h=d[1],g=d[2].empty(),l=g.prev("a.foldertree-text").prev("span.foldertree-icon");if(!a.isArray(h)){h=[h]}var b="";for(var j=0,i=h.length;j<i;j++){var f=h[j];if(m!="*"){if(m==f.character){}else{continue}}var e=(j==i-1)?"lst":"";b+='<li class="foldertree-branch '+e+'">';b+='<span class="foldertree-icon foldertree-branch " data-path="'+f.path+'"></span>';b+='<a href="javascript:void(0);" class="foldertree-text foldertree-leaf" data-type="leaf" data-path="'+f.path+'">';b+='<span class="icon"></span>';b+='<span class="text">'+f.name+"</span>";b+="</a>";b+='<ul class="foldertree-wrap foldertree-branch-wrap" data-path="'+f.path+'"></ul>';b+="</li>"}var c=a(b);g.append(c);return k},setValue:function(c,d){var c=c||this;d=d[1];if(c.get(0).multiple){c.get(0).multipleValue=d;c.closest(".foldertree-container").find("a.foldertree-text").removeClass("selected");c.closest(".foldertree-container").find("a.foldertree-text").parent().removeClass("selected");for(var b=0;b<c.get(0).multipleValue.length;b++){c.closest(".foldertree-container").find("a.foldertree-text[data-path='"+c.get(0).multipleValue[b]+"']").click()}return c}c.val(d);return c},getValue:function(b){var b=b||this;return b.val()},reset:function(b){var b=b||this;return b.val("")}})})(jQuery);