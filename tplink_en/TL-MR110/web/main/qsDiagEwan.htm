<script language="javascript">function doInternetDiag(){var e={},t={},n="",a="",o=new Array,i="",d={};switch(step){case 0:if(""==dslStk)return void doFail();e=$.act(ACT_GET,WAN_DSL_INTF_CFG,dslStk,null,["Status"]),$.exe(function(t){if(t)return diagRemoveLoading(),void $.alert(t);if("Up"==e.status)step++,doInternetDiag();else{if("NoSignal"==e.status)return handler=function(){$("#err_note").html(failNotePre+" "+s_str.dslSyncFail),doFail(),$("#p_reconfig").addClass("nd"),$("#p_retest").removeClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}});break;case 1:INCLUDE_IPV6?o.push("ConnectionStatus","X_TP_IPv6ConnStatus","X_TP_IPv4Enabled","X_TP_IPv6Enabled"):o.push("ConnectionStatus"),i=WAN_IP_CONN,"ppp"==$.qd.type||"pppoa"==$.qd.type||"PPPoE"==$.qd.type?(o.push("LastConnectionError"),i=WAN_PPP_CONN):"L2TP"==$.qd.type?i=WAN_L2TP_CONN:"PPTP"==$.qd.type&&(i=WAN_PPTP_CONN),t=$.act(ACT_GET,i,$.qd.newConn.stack,null,o),$.exe(function(e){if(e)return diagRemoveLoading(),void $.alert(e);if(n=t.connectionStatus,INCLUDE_IPV6&&"L2TP"!=$.qd.type&&"PPTP"!=$.qd.type&&0==t.X_TP_IPv4Enabled&&1==t.X_TP_IPv6Enabled&&(n=t.X_TP_IPv6ConnStatus),"Connected"==n)step++,doInternetDiag();else{if("Disconnected"==n||"Unconfigured"==n)return handler=function(){("ppp"==$.qd.type||"pppoa"==$.qd.type||"PPPoE"==$.qd.type)&&"ERROR_AUTHENTICATION_FAILURE"==(a=t.lastConnectionError)?($("#err_note").html(n_str.quicksetup.t_pppAuthFail),reconfigPage="ETH"==$.sysMode?"qsEwan.htm":"qsDsl.htm"):$("#err_note").html(failNotePre+" "+s_str.diagOtherFail),doFail(),$("#p_reconfig").removeClass("nd"),$("#p_retest").addClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}});break;case 2:diagTool=$.act(ACT_GET,DIAG_TOOL,null,null,["LastResult"]),$.exe(function(e){e?$.alert(e):3==diagTool.lastResult?setTimeout(doInternetDiag,1e3):1==bStart?(handler=1==diagTool.lastResult?function(){diagRemoveLoading(),$.qd.internetDiag=3,$.qf.next()}:function(){retrys<15&&hasSimCard?(retrys++,$.act(ACT_OP,ACT_OP_DIAG_STARTDIAG,diagTool.__stack),$.exe(function(e){e?$.alert(e):setTimeout(doInternetDiag,1e3)})):(4==diagTool.lastResult?$("#err_note").html(failNotePre+" "+s_str.dnsDiagFail):$("#err_note").html(failNotePre+" "+s_str.diagOtherFail),doFail(),$("#p_reconfig").removeClass("nd"),$("#p_retest").addClass("nd"))},bDiagCompleted=!0,1==removeLoadingFlag&&handler()):(bStart=!0,$.act(ACT_OP,ACT_OP_DIAG_STARTDIAG,diagTool.__stack),$.exe(function(e){e?$.alert(e):setTimeout(doInternetDiag,1e3)}))});break;case 3:if(""==ethStk)return void doFail();d=$.act(ACT_GET,WAN_ETH_INTF,ethStk,null,["Status"]),$.exe(function(e){if(e)return diagRemoveLoading(),void $.alert(e);if("Up"==d.status)step++,doInternetDiag();else{if("NoLink"==d.status)return handler=function(){$("#err_note").html(failNotePre+" "+s_str.ethNoLink),doFail(),$("#p_reconfig").addClass("nd"),$("#p_retest").removeClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}});break;case 4:if("PPPoE"==$.qd.type)t=$.act(ACT_GET,WAN_PPP_CONN,$.qd.newConn.stack,null,["ConnectionStatus","LastConnectionError"]);else if("Static IP"==$.qd.type)t=$.act(ACT_GET,WAN_IP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"]);else if("Dynamic IP"==$.qd.type)t=$.act(ACT_GET,WAN_IP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"]);else if("L2TP"==$.qd.type)t=$.act(ACT_GET,WAN_L2TP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"]);else{if("PPTP"!=$.qd.type)return void doFail();t=$.act(ACT_GET,WAN_PPTP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"])}$.exe(function(e){if(e)return diagRemoveLoading(),void $.alert(e);if("Connected"==(n=t.connectionStatus))step=2,doInternetDiag();else{if("Disconnected"==n||"Unconfigured"==n)return handler=function(){if("PPPoE"==$.qd.type)"ERROR_AUTHENTICATION_FAILURE"==(a=t.lastConnectionError)?($("#err_note").html(n_str.quicksetup.t_pppAuthFail),reconfigPage="qsEwan.htm"):$("#err_note").html(failNotePre+" "+s_str.diagOtherFail);else{if(("L2TP"==$.qd.type||"PPTP"==$.qd.type)&&l2tpretryTime<l2tpretryTimeMax)return l2tpretryTime++,void setTimeout(doInternetDiag,1e3);$("#err_note").html(failNotePre+" "+s_str.diagOtherFail)}doFail(),$("#p_reconfig").removeClass("nd"),$("#p_retest").addClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}})}}function diagAddLoading(){$("div.diag-loading").css("display","block"),$("div.quicksetup-button-container").addClass("nd")}function diagRemoveLoading(){$("div.diag-loading").css("display","none"),$("div.quicksetup-button-container").removeClass("nd")}function doFail(){diagRemoveLoading(),$("#diagFailed").removeClass("nd")}function doReconfig(){"qsIsp.htm"==reconfigPage?$.qd.internetDiag=1:"qsDsl.htm"!=reconfigPage&&"qsEwan.htm"!=reconfigPage||($.qd.internetDiag=2),loadSubPage(reconfigPage)}function doRetest(){$("#diagFailed").addClass("nd"),removeLoadingFlag=!1,bDiagCompleted=!1,diagAddLoading(),setTimeout(function(){removeLoadingFlag=!0,1==bDiagCompleted&&handler&&handler()},1e3),doInternetDiag()}function goNext(){$.qf.next()}function goPrev(){$.qf.prev()}var step=0,dslStk="",ethStk="",bStart=!1,failNotePre=n_str.quicksetup.c_internetFailed,reconfigPage="qsEwan.htm",removeLoadingFlag=!1,bDiagCompleted=!1,handler="",l2tpretryTimeMax=2,l2tpretryTime=0,retrys=0;"br"==$.qd.type&&$.qf.next()</script>
<div id="quicksetup_diag_container">
	<form class="pure-form pure-form-aligned">
		<div id="diagFailed" class="nd">
			<div>
				<div style="height:50px;display:block">
					<span id="quicksetup-icon-diag-failed">
						<svg xmlns="http://www.w3.org/2000/svg" width="64px" height="64px" viewBox="0 0 64 62">
							<path class="iconFailed" d="M32,7.6A23.4,23.4,0,1,1,8.6,31,23.43,23.43,0,0,1,32,7.6M32,5A26,26,0,1,0,58,31,26,26,0,0,0,32,5Z"/>
							<circle class="iconFailed" cx="21.93" cy="26.36" r="3.25"/>
							<circle class="iconFailed" cx="42.18" cy="26.36" r="3.25"/>
							<path class="iconFailed" d="M21.57,42.73a1.3,1.3,0,0,1-.94-2.2C23,38,27.49,36.4,32,36.4s8.79,1.45,11.13,3.88a1.3,1.3,0,0,1,0,1.84,1.28,1.28,0,0,1-1.83,0C39.42,40.18,35.87,39,32,39s-7.58,1.34-9.48,3.33A1.3,1.3,0,0,1,21.57,42.73Z"/>
						</svg>
					</span>
					<span class="T" id="t_sorry">Sorry</span>
				</div>
				<p><span id="err_note" style="font-size:15px"></span></p>
			</div>
			<p style="margin-left:70px;margin-top:20px" id="p_reconfig"><button type="submit" class="green left T_reconfig ru-l de-l pl-l tr-xl" id="btnReconfig" onclick="doReconfig()">Reconfig</button></p>
			<p style="margin-left:70px;margin-top:20px" id="p_retest"><button type="submit" class="green left T_retest l ru-xl" id="btnRetest" onclick="doRetest()">Retest</button></p>
		</div>
		<div class="diag-loading">
			<p><span class="diag-loading-icon"></span></p>
			<p><span id="t_diagLoadingText"></span></p>
		</div>
	</form>
</div>
<div class="inline-btn-right quicksetup-button-container">
    <div class="inline">
        <button type="submit" class="green T_back" onclick="goPrev()">Back</button>
    </div>
    <div class="inline">
        <button type="submit" class="green T_next" onclick="goNext()">Next</button>
    </div>
</div>

<script language="javascript">function internetDiagInit(){var t=$.act(ACT_GET,L3_FORWARDING,null,null,["__ifAliasName"]),n=$.act(ACT_GL,WAN_IP_CONN,null,null,["Enable","Name","ConnectionType"]),a=$.act(ACT_GL,WAN_PPP_CONN,null,null,["Enable","Name"]),e=$.act(ACT_GL,WAN_COMMON_INTF_CFG,null,null,["WANAccessType"]),i=!1;if(INCLUDE_IPV6)var c=$.act(ACT_GET,L3_IP6_FORWARDING,null,null,["__ifAliasName"]);if(INCLUDE_PPTP)var s=$.act(ACT_GL,WAN_PPTP_CONN,null,null,["Enable","Name"]);if(INCLUDE_L2TP)var _=$.act(ACT_GL,WAN_L2TP_CONN,null,null,["Enable","Name"]);if(INCLUDE_WAN_MODE)var C=$.act(ACT_GET,SYS_MODE,null,null,["Mode"]);return!$.exe()&&(0==i&&$.each(n,function(){if(1==this.enable&&INCLUDE_IPV6&&this.name==c.__ifAliasName)return wanConnStack=this.__stack,intfCfgStack=$.stkPop(wanConnStack,2),wanType="ip",i=!0,!1;1==this.enable&&"IP_Bridged"==this.connectionType&&(wanType="ip",wanConnStack=this.__stack,intfCfgStack=$.stkPop(wanConnStack,2))}),0==i&&$.each(a,function(){if(1==this.enable&&INCLUDE_IPV6&&this.name==c.__ifAliasName)return wanConnStack=this.__stack,intfCfgStack=$.stkPop(wanConnStack,2),wanType="ppp",i=!0,!1}),INCLUDE_PPTP&&0==i&&$.each(s,function(){if(this.enable&&this.name==t.__ifAliasName)return wanConnStack=this.__stack,intfCfgStack=INCLUDE_EWAN_VLAN?$.stkPop(wanConnStack,2):$.stkPop(wanConnStack,1),wanType="pptp",i=!0,!1}),INCLUDE_L2TP&&0==i&&$.each(_,function(){if(this.enable&&this.name==t.__ifAliasName)return wanConnStack=this.__stack,intfCfgStack=INCLUDE_EWAN_VLAN?$.stkPop(wanConnStack,2):$.stkPop(wanConnStack,1),wanType="l2tp",i=!0,!1}),0==i&&$.each(n,function(){if(1==this.enable&&this.name==t.__ifAliasName&&"iptv"!=this.name)return wanConnStack=this.__stack,intfCfgStack=$.stkPop(wanConnStack,2),wanType="ip",i=!0,!1;1==this.enable&&"IP_Bridged"==this.connectionType&&(wanType="ip",wanConnStack=this.__stack,intfCfgStack=$.stkPop(wanConnStack,2))}),0==i&&$.each(a,function(){if(1==this.enable&&this.name==t.__ifAliasName&&"iptv"!=this.name)return wanConnStack=this.__stack,intfCfgStack=$.stkPop(wanConnStack,2),wanType="ppp",i=!0,!1}),0==i?(INCLUDE_WAN_MODE&&"ETH"==C.mode&&(wanAccessType="Ethernet"),$.each(e,function(){if(this.WANAccessType==wanAccessType)return intfCfgStack=this.__stack,!1})):$.each(e,function(){if(this.__stack==intfCfgStack)return wanAccessType=this.WANAccessType,intfCfgStack=this.__stack,!1}),"Ethernet"==wanAccessType&&(INCLUDE_EWAN_VLAN||(intfCfgStack="pptp"==wanType||"l2tp"==wanType?wanConnStack:$.stkPop(wanConnStack,1))),!0)}function init(){internetDiagInit();var t=$.act(ACT_GL,WAN_COMMON_INTF_CFG,null,null,["WANAccessType"]);if($.exe(),$.removeLoading(),"DSL"==$.sysMode?$.each(t,function(){if("DSL"==this.WANAccessType)return dslStk=this.__stack,!1}):"ETH"==$.sysMode&&$.each(t,function(){if("Ethernet"==this.WANAccessType)return ethStk=this.__stack,step=3,!1}),"undefined"!=typeof INCLUDE_LTEWAN&&INCLUDE_LTEWAN){var n=$.act(ACT_GL,LTE_WAN_CFG,null,null,["dataSwitchStatusBackup"]);$.exe(),$.each(n,function(){var t=$.stkPop(this.__stack,1);if(intfCfgStack==t)return intfCfgStack=this.__stack,dataSwitchStatusBackup=this.dataSwitchStatusBackup,!1}),lteLinkCfg=$.act(ACT_GET,WAN_LTE_LINK_CFG,intfCfgStack,null,null),$.exe(),3!=lteLinkCfg.simStatus&&5!=lteLinkCfg.simStatus||1!=dataSwitchStatusBackup||(hasSimCard=!0)}$.qd.internetDiag=0,diagAddLoading(),setTimeout(function(){removeLoadingFlag=!0,1==bDiagCompleted&&handler&&handler()},1e3),doInternetDiag()}var diagRet=!0,hasSimCard=!1,intfCfgStack="",wanConnStack="",wanType="";init()</script>
