<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- <link type="text/css" href="css/reset.css" rel="stylesheet" /> -->
<link type="text/css" href="css/widget.css" rel="stylesheet" />

<link type="text/css" href="themes/blue/css/widget.css" rel="stylesheet" />
<link type="text/css" href="themes/blue/css/style.css" rel="stylesheet" />

<!--[if lte IE 8]>
<meta http-equiv="X-UA-Compatible" content="IE=8" />
<link href="themes/blue/css/ie.css" rel="stylesheet" type="text/css" />
<![endif]-->

<!--[if lte IE 7]>
<link href="themes/blue/css/ie.css" rel="stylesheet" type="text/css" />
<![endif]-->

<!--[if lte IE 6]>
<link href="themes/blue/css/ie.css" rel="stylesheet" type="text/css" />
<![endif]-->

<title>Opening...</title>
</head>

<body id="login-body">

<div class="top" id="login-main">
	<div class="top-header">
    	<div class="top-header-wrap">
        	<h1 id="product-tag"></h1>
            <div id="top-control" class="top-control">
                <input id="lan-select" class="lan-select-container"/>
            </div>
        </div>
    </div>
    
    <div class="top-main">
    	<div class="top-main-wrap">
            <div class="top-content">
            	<div class="top-content-wrap" id="top-content">
                    <form id="form-login" method="post" action="/cgi-bin/luci">
                        <div class="login-field">
                            <label id="login-username-label">
                                <span class="icon"></span>
                                <span class="text"></span>
                            </label>
                            <input id="login-username" type="text" />
                        </div>
                        <div class="login-field">
                            <label id="login-password-label">
                                <span class="icon"></span>
                                <span class="text"></span>
                            </label>
                            <input id="login-password" type="password" />
                        </div>
                        <!--<div>
                            <input id="show-characters" />
                        </div>-->
                        <button id="login-btn" type="button"></button>
                    </form>
                    
                </div>
            </div>
            
            <div class="top-footer">
                <div class="top-footer-wrap">
                    <span class="help-faq">
                        <a id="btn-faq" class="btn-faq" target="_blank" href="http://www.tp-link.com/en/Support/"></a>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- user confilct 内容 -->
<div id="user-conflict-msg-container" class="conflict-situation">
    <div>
        <h4 class="title">
            <span class="icon"></span>
            <span class="text" id="user-conflict-situation"></span>
        </h4>
        <div class="content">
            <span id="user-conflict-situation-info"></span>
        </div>
    </div>
</div>

<!-- ip conflict 内容 -->
<!-- <div id="ip-conflict-msg-container">

    <div id="ip-conflict-situation-0" class="conflict-situation">
        <h4 class="title">
            <span class="icon"></span>
            <span class="text" id="ip-conflict-situation-0-title"></span>
        </h4>
        <div class="content">
            <span id="ip-conflict-situation-0-info"></span>
            <a class="link" id="ip-conflict-situation-0-new" href="javascript:void(0);"></a>
            <span id="ip-conflict-situation-0-end"></span>
        </div>

        <button type="button" id="ip-conflict-situation-0-btn-continue"></button>
    </div>

    <div id="ip-conflict-situation-1" class="conflict-situation">
        <h4 class="title">
            <span class="icon"></span>
            <span class="text" id="ip-conflict-situation-1-title"></span>
        </h4>
        <div class="content">
            <span id="ip-conflict-situation-1-info"></span>
            <a class="link" id="ip-conflict-situation-1-new" href="javascript:void(0);"></a>
            <span id="ip-conflict-situation-1-or"></span>
            <a class="link" id="ip-conflict-situation-1-dst" href="javascript:void(0);"></a>
            <span id="ip-conflict-situation-1-end"></span>
        </div>
    </div>

</div> -->

<div id="no-cookie-msg-container" class="hidden warning">
    <h4 class="title">
        <span class="icon"></span>
        <span class="text" id="no-cookie-text"></span>
    </h4>
</div>

<!-- 最长尝试次数超时 -->
<div id="max-attempts-msg-container" class="hidden warning">
    <h4 class="title">
        <span class="icon"></span>
        <span class="text" id="max-attempts-text"></span>
    </h4>    
</div>


<script type="text/javascript" src="js/libs/jquery.min.js"></script>

<script type="text/javascript" src="js/su/locale.js"></script>
<script type="text/javascript">
//<![CDATA[
    try{
        $.su.locale.URL_LAN_CHECK = "./data/lang.json"; // $.su.url("/locale?form=lang");
        $.su.locale.get();
    }catch(error){
        location.href = "./error.html";
    };
//]]>
</script>

<script type="text/javascript" src="js/su/su.js"></script>
<script type="text/javascript" src="js/libs/encrypt.js"></script>
<script type="text/javascript" src="js/libs/md5.js"></script>

<script type="text/javascript" src="js/su/data/proxy.js"></script>
<script type="text/javascript" src="js/su/widget/widget.js"></script>
<script type="text/javascript" src="js/su/widget/window/msg.js"></script>

<script type="text/javascript" src="js/su/widget/form/form.js"></script>
<script type="text/javascript" src="js/su/widget/form/combobox.js"></script>
<script type="text/javascript" src="js/su/widget/form/textbox.js"></script>
<script type="text/javascript" src="js/su/widget/form/password.js"></script>
<script type="text/javascript" src="js/su/widget/form/checkbox.js"></script>
<script type="text/javascript" src="js/su/widget/form/button.js"></script>


<script type="text/javascript">
//<![CDATA[

function strmodify(str)
{
    var localStr = "";
    var len = str.length;
    var i,j;
    var charStr;
    for(i=0;i<len;i++)
    {
        if(document.all)
        {
            charStr = str.slice(i,i+1);
            if(charStr != ' ')break;
        }
        else
        {
            if(str[i] != ' ')break;
        }       
    }
    for(j=(len-1);j>0;j--)
    {
        if(document.all)
        {
            charStr = str.slice(j,j+1);
            if(charStr != ' ')break;
        }
        else
        {
            if(str[j] != ' ')break;
        }       
    }
    if(j<i)
    {
        return localStr;
    }
    else localStr = str.slice(i,j+1);
    return localStr;
}

function checkCookie(srcStr)
{
    var sliceStr = srcStr.indexOf("=");
    var testStr = strmodify(srcStr.slice(0,sliceStr)).toUpperCase();
    if(testStr == "COOKIE")
    {
        return true;
    }   
    else
    {
        return false;
    }
}

function getCookie()
{
    var sliceStr;
    var srcStr;
    var tmpstring = document.cookie;
    while(tmpstring.length > 0)
    {
        sliceStr = tmpstring.indexOf(";");
        if(sliceStr == -1)
        {
            srcStr = tmpstring;
            if(checkCookie(srcStr) == true)
            {
                sliceStr = srcStr.indexOf("=");
                if(sliceStr == -1)return null;          
                var submitStr = strmodify(srcStr.slice(sliceStr+1));    
                return submitStr;
            }
        }
        else
        {
            srcStr = tmpstring.slice(0,sliceStr);
            if(checkCookie(srcStr) == true)
            {
                sliceStr = srcStr.indexOf("="); 
                if(sliceStr == -1)return null;  
                var submitStr = strmodify(srcStr.slice(sliceStr+1));    
                return submitStr;
            }       
        }           
        tmpstring = tmpstring.slice(sliceStr+1);
    }   
    return null;
}

/////////////////////////////////////////////////////////////

$(document).ready(function(e){

    /*var URL_IP_CONFLICT = $.su.url("/domain_login?form=dlogin");
    var URL_USER_CONFLICT = $.su.url("/login?form=limit");
    var URL_FORGET_PASSWORD = $.su.url("/login?form=password");
    var URL_VERIFY_CODE = $.su.url("/login?form=vercode");

    var URL_LOGIN = $.su.url("/login?form=login");*/

    // var URL_IP_CONFLICT = "./data/login.json";
    /*var URL_USER_CONFLICT = "./data/login.json";
    var URL_FORGET_PASSWORD = "./data/login.json";
    var URL_VERIFY_CODE = "./data/login.json";*/
    var URL_LOGIN = "./data/login.json";

    //ip冲突部分内容
    /*var ipConflictProxy = new $.su.Proxy({
        url: URL_IP_CONFLICT,
        autoLoad: false
    });*/

   /* var ipConflictMsg = $("div#ip-conflict-msg-container").msg({
        closeBtn: false,
        type: "window",
        cls: "l"
    });

    $("button#ip-conflict-situation-0-btn-continue").button({
        text: $.su.CHAR.LOGIN.CONTINUE,
        handler: function(){
            ipConflictMsg.msg("close");
            loginMain.fadeIn(200);
        },
        cls: "submit btn-continue-conflict"
    });*/

   /* $("span#ip-conflict-situation-0-title").html($.su.CHAR.LOGIN.IMPORTANT_UPDATE);
    $("span#ip-conflict-situation-0-info").html($.su.CHAR.LOGIN.IMPORTANT_UPDATE_INFO);
    $("span#ip-conflict-situation-0-end").html($.su.CHAR.LOGIN.END);

    $("span#ip-conflict-situation-1-title").html($.su.CHAR.LOGIN.IMPORTANT_NOTICE);
    $("span#ip-conflict-situation-1-info").html($.su.CHAR.LOGIN.IMPORTANT_UPDATE_INFO);
    $("span#ip-conflict-situation-1-or").html($.su.CHAR.LOGIN.OR);
    $("span#ip-conflict-situation-1-end").html($.su.CHAR.LOGIN.END);*/

   /* $("a#ip-conflict-situation-1-new").on("click", function(e){
        ipConflictMsg.msg("close");
        loginMain.fadeIn(200);
    });*/

    //用户登录冲突部分
    var userConflictMsg = $("div#user-conflict-msg-container").msg({
        closeBtn: false,
        cls: "l",
        type: "alert",
        okHandler: function(){
            $("button#login-btn").focus();
        }
    });

    //主页面内容部分
    var loginMain = $("div#login-main");

    var lanSelectCombo = $("input#lan-select").combobox({
        cls: "top-lan-select",
        items: [
            {"value": "en_US", "name": $.su.CHAR.LANGUAGE.EN_US},
            {"value": "zh_CN", "name": $.su.CHAR.LANGUAGE.ZH_CN}
        ],
        fieldLabel: null
    }).on("ev_click", function(e, vOld, vNew){
        if (vOld[0] == vNew[0]){
            return;
        };
        $.su.locale.set(vNew[0], function(){
            lanSelectCombo.combobox("setValue", [$.su.locale.locale]);
        }, function(){
            lanSelectCombo.combobox("setValue", [$.su.locale.locale]);
        });
    }).combobox("setValue", [$.su.locale.locale]);

    document.title = $.su.locale.model;
    $("h1#product-tag").html($.su.locale.model);
    $("a#btn-faq").html($.su.CHAR.HELP_SUPPORT);

    //console.log($.su.locale.force)
    if ($.su.locale.force != false){
        lanSelectCombo.combobox("hide");
    };

    $("input#login-username").textbox({
        hint: $.su.CHAR.LOGIN.USERNAME,
        fieldLabel: null,
        allowBlank: false,
        vtype: "ascii_visible",
        maxLength: 15,
        minLength: 1,
        cls: "inline-block login-text"
    });

    $("input#login-password").password({
        showLevel: false,
        hint: $.su.CHAR.LOGIN.PASSWORD,
        fieldLabel: null,
        maxLength: 15,
        minLength: 1,
        allowBlank: false,
        allowVisible: false,
        cls: "inline-block login-text"
    }).on("ev_change", function(e, value, key, keyCode){
        if (key == "Enter" || keyCode == 13
			/*&& $("div#user-conflict-msg-container").css("display")!="block" 
			&& $("div#no-cookie-msg-container").css("display")!= "block" 
			&& $("div#max-attempts-msg-container").css("display") != "block"*/){
            $("input#login-password").password("doEncrypt");
            if (checkCookie()){
                doLogin();
            };
        }/*else if($("div#user-conflict-msg-container").css("display")=="block" 
			|| $("div#no-cookie-msg-container").css("display")== "block" 
			|| $("div#max-attempts-msg-container").css("display") == "block"){
			$("div#user-conflict-msg-container").msg("close");
			$("div#no-cookie-msg-container").msg("close");
			$("div#max-attempts-msg-container").msg("close");
		
		}*/
    });

    var loginProxy = new $.su.Proxy({
        url: URL_LOGIN
    });

    var loginForm = $("form#form-login").form({
        proxy: loginProxy,
        showPrompt: false,
        autoLoad: false,
        fields: [
          /*  {name: "username"},
            {name: "password"}*/
        ]
    });

    var doLogin = function(){
       ///////////////  get cookies 

        checkCookie();

        var submitStr = getCookie();

       /* if(submitStr == null)
        {
            alert('open your cookies!');
            return false;
        }*/

        var password = $.su.md5( $.su.md5($("input#login-password").password('getValue') ).toUpperCase() + ':' + submitStr  ).toUpperCase();

        var strEncoded = $("input#login-username").textbox('getValue') + ':' + password;

        if( $('input#login-username').textbox('validate') && $('input#login-password').password('validate') ){
            loginForm.form("submit", {
                "operation": "login",
                "encoded": strEncoded,
                "nonce": submitStr
            }, function(data, status, xhr){
                    location.href = "/";            
            }, function(errorcode, others, data){
                switch (errorcode.toUpperCase()){
                    case "USER CONFLICT":
                        $("span#user-conflict-situation").html($.su.CHAR.LOGIN.USER_CONFLICT);
                        var c = $.su.CHAR.LOGIN.USER_CONFLICT_INFO.replace("%USER%", data.logined_user).replace("%HOST%", data.logined_host).replace("%IP%", data.logined_ip).replace("%MAC%", data.logined_mac);
                        $("span#user-conflict-situation-info").html(c)
                        userConflictMsg.msg("show");
						userConflictMsg.find("button").focus();
                        break;
                    case "LOGIN FAILED":
						if(data.attemptsAllowed>5)
							loginForm.form("prompt", false, $.su.CHAR.LOGIN.LOGIN_FAILED);
						else{
							var str = $.su.CHAR.ERROR["000000111"].replace("%fc", data.failureCount).replace("%ac", data.attemptsAllowed);
							/*if(data.attemptsAllowed<=1)
								str=str.replace("attempts","attempt");*/
							$("span#max-attempts-text").html(str);
							maxAttemptsMsg.msg("show");
							maxAttemptsMsg.find("button").focus();
						}
                        break;
                    case "EXCEEDED MAX ATTEMPTS":
                        var num1 = data.failureCount;
                        var num2 = data.attemptsAllowed;
                        var num3 = num2 + num1;
                        var str = $.su.CHAR.ERROR["00000089"].replace("%num", num3);
                        $("span#max-attempts-text").html(str);
                        maxAttemptsMsg.msg("show");
						maxAttemptsMsg.find("button").focus();
                        break;
                    default:

                };
            });
        }

    };

    $("button#login-btn").button({
        text: $.su.CHAR.LOGIN.LOGIN,
        handler: function(e){
            /*var psw = $("input#login-password").password("getValue"),
                user = $("input#login-username").textbox("getValue");*/
            if (checkCookie()){

                function Base64Encoding(input) 
                {
                    var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
                    var output = "";
                    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
                    var i = 0;
                    //input = utf8_encode(input);
                    while (i < input.length) 
                    {
                        chr1 = input.charCodeAt(i++);
                        chr2 = input.charCodeAt(i++);
                        chr3 = input.charCodeAt(i++);
                        enc1 = chr1 >> 2;
                        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                        enc4 = chr3 & 63;
                        if (isNaN(chr2)) {
                            enc3 = enc4 = 64;
                        } else if (isNaN(chr3)) {
                            enc4 = 64;
                        }

                        output = output +
                        keyStr.charAt(enc1) + keyStr.charAt(enc2) +
                        keyStr.charAt(enc3) + keyStr.charAt(enc4);
                    }
                     
                    return output;
                }

                username = $('input#login-username').textbox('getValue');
                password = $('input#login-password').password('getValue');
/*
                var auth = "Basic "+ Base64Encoding(username + ":" + password);
                document.cookie = "Authorization="+escape(auth)+";path=/";
*/

                doLogin();
            };
        },
        cls: "submit login-btn inline-block"
    });

    /*$("button#test").click(function(e){
        $.ajax({
            url: "./data/internet.json",
            type: "POST",
            data: {
                "name" : "name",
                "id": "id"
            },
            success: function(data, status, xhr){
                //console.log(data);
            }  
        });
    });*/

    //登录流程
   /* ipConflictProxy.read({}, function(data){
        if (data && data.conflict === true){
            var sit0 = $("div#ip-conflict-situation-0");
            var sit1 = $("div#ip-conflict-situation-1");
            switch (data.mode){
                case 0:
                    sit0.css("display", "block");
                    sit1.css("display", "none");

                    $("a#ip-conflict-situation-0-new").html(data.new_addr);
                    break;
                case 1:
                    sit0.css("display", "none");
                    sit1.css("display", "block");

                    $("a#ip-conflict-situation-1-dst").html(data.dst_addr).attr("href", "http://" + data.dst_addr + data.dst_webpath);
                    $("a#ip-conflict-situation-1-new").html(data.new_addr);
                    break;
            };
            loginMain.css("display", "none");
            ipConflictMsg.msg("show");
        }else{
            ipConflictMsg.msg("close");
            loginMain.fadeIn(200);
        };
    }, function(e){
        ipConflictMsg.msg("close");
        loginMain.fadeIn(200);
    }, function(e){
        ipConflictMsg.msg("close");
        loginMain.fadeIn(200);
    });*/

    loginMain.show();

    
    /*cookie check*/
    $("span#no-cookie-text").html($.su.CHAR.LOGIN.NO_COOKIE);
    var noCookieMsg = $("div#no-cookie-msg-container").msg({
        type: "alert",
        cls: "m",
        closeBtn: false
    });


    var checkCookie = function(){
        if (navigator.cookieEnabled){
            noCookieMsg.msg("close");
            return true;
        }else{
            noCookieMsg.msg("show");
            return false;
        };
    };

    checkCookie();

    ///////////////  MAX ATTEMPTS

    var maxAttemptsMsg = $("div#max-attempts-msg-container").msg({
        type: "alert",
        cls: "m",
        closeBtn: false,
        okHandler: function(){
            $("button#login-btn").focus();
        }
    });
    

    //$.su.loading.show();
    $.su.loading.hide();
    
});
//]]>
</script>
</body>
</html>