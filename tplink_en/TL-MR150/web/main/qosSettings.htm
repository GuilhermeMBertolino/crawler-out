<style>body{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.inline .select-container{display:inline-block}.inline .select-container .tp-select .select-box{top:-1px}.rule-list-container{width:210px;display:inline-block;height:auto;position:relative}.rule-list-container h4.status{font-weight:400}.qos-panel.status-panel-main{padding:30px 0 0 15px}.qos-panel.status-panel-main .qos-list{margin-top:20px;height:165px;overflow-x:hidden;overflow-y:auto}.msg-container-wrapper.complex-msg{margin-top:-50%;width:650px}.qos-panel.status-panel-main .qos-list .qos-list-p{width:180px;padding:8px 0;border-bottom:1px solid #d9d9d9;cursor:pointer;position:relative;margin:0}.qos-display-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;width:130px;-moz-user-select:none;-webkit-user-select:none;user-select:none}span.qos-toggle-icon{vertical-align:middle;position:absolute;width:18px;height:18px;background:url(../img/icons-02.png) no-repeat -234px -36px}p.qos-list-p span.qos-toggle-icon{top:8px;right:35px}.type-title .qos-toggle-icon{top:18px;right:3px}.selected span.qos-toggle-icon{background:url(../img/icons-02.png) no-repeat -234px -18px}p.qos-list-p span.icon-del{position:absolute;background:url(../img/icons.png) no-repeat -222px -21px;display:inline-block;width:18px;height:18px;right:16px}.qos-item-detail{margin:10px 0;background-color:#f2f2f2;width:180px}.qos-item-detail.hidden{display:none}.qos-item-detail p{line-height:26px;margin:0}label.detail-label{display:inline-block;width:65px;margin-left:10px}label.detail-label.short{width:30px;margin-left:5px;padding-right:5px}.control-panel{margin-top:20px;margin-right:10px}div.msg-container div.button-container{display:inline-block;vertical-align:middle;margin-right:5px}div.msg-container div.inline-btn-right{margin-right:0}div.msg-content-container div.header-container h3{font-size:14px;color:#1a1a1a;margin-bottom:10px;border-bottom:none;padding-bottom:0}.type-title{font-weight:400;color:#1a1a1a;border-bottom:1px solid #ccc;position:relative;cursor:pointer}.app-info-cnt{margin:6px 0 25px}.widget-wrap-outer{position:relative;display:inline-block;vertical-align:middle}.checkbox-group-wrap{vertical-align:top;display:inline-block;position:relative}ul.checkbox-group-list-wrap{vertical-align:top;display:inline-block;margin-right:2px;padding:0;margin-top:0;list-style:outside none none}.app-info-name{width:130px;padding:2px 8px}</style>

<div id="tcHeader">
    <h3 id="t_et">QoS</h3>
</div>

<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div id="qosEnableBox">
            <b class="l" id="t_en">QoS:</b>
            <input type="checkbox" id="enableQoS">
            <label class="T_enable">Enable</label>
            <div id="Nat_Note" class="nv" style="display:inline-block;vertical-align:middle">
                <div style="display:table">
                    <div id="enable-qos-tips" style="display:table-cell;width:240px;color:#b2b2b2;height:20px;line-height:15px">
                    </div>
                </div>
            </div>
        </div>
        <div>
        <p class="cfg-line" id="t_qos_note">tips</p>
        </div>
        <div class="nd">
            <b class="l" id="t_type">Line Type:</b>
            <input type="radio" id="adsl_type" name="lineTypeRadio">
            <label>DSL</label>
            <input type="radio" id="other_type" name="lineTypeRadio">
            <label id="t_other">Other</label>
        </div>

        <div class="pure-control-group nd" id="curDslUp">
            <b class="l" id="t_dslUp">Current Up Stream Rate:</b>
            <input type="text" readonly="true" class="tp-input-text" id="upStreamCurrRate">
        </div>

        <div class="pure-control-group nd" id="curDslDown">
            <b class="l" id="t_dslDown">Current Down Stream Rate:</b>
            <input type="text" readonly="true" class="tp-input-text" id="downStreamCurrRate">
        </div>

        <div class="inline">
            <b id="t_upBandwidth" class="l">Upload Bandwidth:</b>
            <input type="text" maxlength="4" class="m" id="upBandwidth">
            <select id="upUnit" class="m">
                <option value="kbps" class="T_kbps">kbps</option>
                <option value="mbps" class="T_mbps">mbps</option>
            </select>
        </div>

        <div class="inline">
            <b id="t_downBandwidth" class="l">Download Bandwidth:</b>
            <input type="text" maxlength="4" class="m" id="downBandwidth">
            <select id="downUnit" class="m">
                <option value="kbps" class="T_kbps">kbps</option>
                <option value="mbps" class="T_mbps">mbps</option>
            </select>
        </div>

        <div id="iptvQos" class="nd">
            <div>
                <b class="l" id="t_iptv">IPTV QoS:</b>
                <input type="checkbox" id="en_iptvQos">
                <label class="T_enable">Enable</label>
            </div>
            <div id="div_iptvDetails" class="nd">
                <div>
                    <b id="t_iptvClass" class="l">IPTV Class</b>
                    <select id="iptvClass" class="">
                        <option class="T T_high" value="4">High</option>
                        <option class="T T_middle" value="3">Middle</option>
                        <option class="T T_low" value="2">Low</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="voipQos" class="nd">
            <div>
                <b class="l" id="t_voip">VoIP QoS:</b>
                <input type="checkbox" id="en_voipQos">
                <label class="T_enable">Enable</label>
            </div>
        </div>

        <div class="advanced-block">
            <span class="advanced-icon advanced-hide-icon" id="moreCfg"></span>
            <span class="T_adv">Advanced</span>
        </div>

        <div id="con_More" class="nd">
            <div class="pure-control-group">
                <label class="label-title l T T_c_highPriority">High Priority:</label>
                <input type="text" data-slider="true" data-slider-range="0 ,100" data-slider-snap="true" data-slider-step="5" data-slider-highlight="true" id="high">
                <span class="output"></span>
            </div>
            <div class="pure-control-group">
                <label class="label-title l T T_c_middlePriority">Middle Priority:</label>
                <input type="text" data-slider="true" data-slider-range="0 ,100" data-slider-snap="true" data-slider-step="5" data-slider-highlight="true" id="middle">
                <span class="output"></span>
            </div>
            <div class="pure-control-group">
                <label class="label-title l T T_c_lowPriority">Low Priority:</label>
                <input type="text" data-slider="true" data-slider-range="0 ,100" data-slider-snap="true" data-slider-step="5" data-slider-highlight="true" id="low">
                <span class="output"></span>
            </div>
        </div>

        <div id="saveBtn">
            <p class="br"></p>
            <div class="btn-right">
                <button type="submit" class="green T_save" id="editOK">Save</button>
            </div>
        </div>
    </form>

    <p class="br"></p>

    <h3 id="t_et2">QoS Rule List</h3>
    <div class="content-container">
        <div class="rule-list-container">
            <h4 class="status">
                <span class="T T_c_highPriority">High Priority:</span> <span id="highValue"></span>
            </h4>
            <div class="status-panel-main qos-panel">
                <div class="qos-list" id="highList">
                </div>
                <div class="control-panel">
                    <button type="submit" class="blue T_add" id="addHigh">Add</button>
                </div>
            </div>
        </div>
        <div class="rule-list-container">
            <h4 class="status">
                <span class="T T_c_middlePriority">Middle Priority:</span> <span id="middleValue"></span>
            </h4>
            <div class="status-panel-main qos-panel">
                <div class="qos-list" id="middleList">
                </div>
                <div class="control-panel">
                    <button type="submit" class="blue T_add" id="addMiddle">Add</button>
                </div>
            </div>
        </div>
        <div class="rule-list-container">
            <h4 class="status">
                <span class="T T_c_lowPriority">Low Priority:</span> <span id="lowValue"></span>
            </h4>
            <div class="status-panel-main qos-panel">
                <div class="qos-list" id="lowList">
                </div>
                <div class="control-panel">
                    <button type="submit" class="blue T_add" id="addLow">Add</button>
                </div>
            </div>
        </div>
    </div>

</div>
<script>!function(){function e(e){if(v=$.act(ACT_GL,IQOS_RULE,null,null),$("#highList").empty(),$("#middleList").empty(),$("#lowList").empty(),!$.exe()){var t=0;$.each(v,function(){var e={};if(this.type==o){var a=this.macAddress;e[$.tpLang.qosSettings_nstr.c_mac]=a.replace(/\:/g,"-");var s=$.tpLang.qosSettings_nstr.c_none,i=$.act(ACT_GL,LAN_HOST_ENTRY,null,null);$.exe()||$.each(i,function(){this.MACAddress==a&&1==this.active&&(s=this.IPAddress)}),e[$.tpLang.qosSettings_nstr.c_ip]=s}this.type,this.type==r&&(e[$.tpLang.table_str.protocol]=$.tpLang.qosSettings_nstr.t_all,this.srcPort==this.endPort?e[$.tpLang.table_str.port]=this.srcPort:e[$.tpLang.table_str.port]=this.srcPort+"-"+this.endPort),this.type==d&&(e[$.tpLang.table_str.protocol]=$.tpLang.qosSettings_nstr.t_tcp,this.srcPort==this.endPort?e[$.tpLang.table_str.port]=this.srcPort:e[$.tpLang.table_str.port]=this.srcPort+"-"+this.endPort),this.type==p&&(e[$.tpLang.table_str.protocol]=$.tpLang.qosSettings_nstr.t_udp,this.srcPort==this.endPort?e[$.tpLang.table_str.port]=this.srcPort:e[$.tpLang.table_str.port]=this.srcPort+"-"+this.endPort),this.class_==c?l(t,"high",this.appName,e):this.class_==u?l(t,"middle",this.appName,e):this.class_==h&&l(t,"low",this.appName,e),t++}),$.isFunction(e)&&e()}}function t(){$("[data-slider]").each(function(){var e,t,l,a;return e=$(this),l={},(t=e.data("slider-values"))&&(l.allowedValues=function(){var e,l,s,i;for(i=[],e=0,l=(s=t.split(",")).length;e<l;e++)a=s[e],i.push(parseFloat(a));return i}()),e.data("slider-range")&&(l.range=e.data("slider-range").split(",")),e.data("slider-step")&&(l.step=e.data("slider-step")),l.snap=e.data("slider-snap"),l.equalSteps=e.data("slider-equal-steps"),e.data("slider-theme")&&(l.theme=e.data("slider-theme")),e.attr("data-slider-highlight")&&(l.highlight=e.data("slider-highlight")),null!=e.data("slider-animate")&&(l.animate=e.data("slider-animate")),e.simpleSlider(l)}),$("#high").bind("slider:ready slider:changed",function(e,t){var l=100-$("#high").prop("value")-$("#low").prop("value")>$("#high").prop("value")-5?$("#high").prop("value")-5:100-$("#high").prop("value")-$("#low").prop("value");$("#middle").simpleSlider("setLimits",10,l);var a=100-$("#high").prop("value")-$("#middle").prop("value")>$("#middle").prop("value")-5?$("#middle").prop("value")-5:100-$("#high").prop("value")-$("#middle").prop("value");$("#low").simpleSlider("setLimits",5,a),$(this).nextAll(".output:first").html(parseInt(t.value)+"%")}),$("#middle").bind("slider:ready slider:changed",function(e,t){var l=100-$("#high").prop("value")-$("#middle").prop("value")>$("#middle").prop("value")-5?$("#middle").prop("value")-5:100-$("#high").prop("value")-$("#middle").prop("value");$("#low").simpleSlider("setLimits",5,l);var a=100-$("#middle").prop("value")-$("#low").prop("value");a>=$("#high").prop("value")&&$("#high").simpleSlider("setLimits",15,a),$(this).nextAll(".output:first").html(parseInt(t.value)+"%")}),$("#low").bind("slider:ready slider:changed",function(e,t){var l=100-$("#middle").prop("value")-$("#low").prop("value");l>=$("#high").prop("value")&&$("#high").simpleSlider("setLimits",15,l);var a=100-$("#high").prop("value")-$("#low").prop("value")>$("#high").prop("value")-5?$("#high").prop("value")-5:100-$("#high").prop("value")-$("#low").prop("value");a>=$("#middle").prop("value")&&$("#middle").simpleSlider("setLimits",10,a),$(this).nextAll(".output:first").html(parseInt(t.value)+"%")})}function l(e,t,l,s){var i=$("#"+t+"List"),n=$('<div class="qos-item-container">'),o=$('<p class="qos-list-p" id="_rule'+e+'"><span class="qos-display-name">'+l+'</span><span class="qos-toggle-icon"></span><span class="icon-del"></span></p>');n.append(o);var d=0,p=!1,r='<div class="qos-item-detail hidden">';for(var c in s)d++,c==$.tpLang.qosSettings_nstr.c_mac&&(p=!0),r+='<p><label class="detail-label">'+c+":</label><span>"+s[c]+"</span>";r+="</div>";var u=$(r);p&&u.find("label.detail-label").addClass("short"),n.append(u),i.append(n),0==d?o.find(".qos-toggle-icon").css("background","none"):$(o).on("click",function(e){!0!==m&&($(this).toggleClass("selected"),$(this).hasClass("selected")?$(this).next(".qos-item-detail").first().removeClass("hidden"):$(this).next(".qos-item-detail").first().addClass("hidden"))}),$(o).find(".qos-toggle-icon").on("click",function(e){e.stopPropagation();var t=$(this).closest(".qos-list-p");t.toggleClass("selected"),t.hasClass("selected")?t.next(".qos-item-detail").first().removeClass("hidden"):t.next(".qos-item-detail").first().addClass("hidden")}).on("mousedown",function(e){e.stopPropagation()}),$(o).find(".icon-del").on("click",function(t){t.stopPropagation(),a(e)}).on("mousedown",function(e){e.stopPropagation()})}function a(e){$.addLoading(),$.act(ACT_DEL,IQOS_RULE,v[e].__stack,null),$.exe(function(e){$.removeLoading(),e||$.reload()})}function s(e){e&&(e.focus(),e.select())}function i(){var e={},t=$("#upUnit").data("value"),l=$("#downUnit").data("value"),a=$("#iptvClass").data("value");if(e.enable=$("#enableQoS").prop("data-checked")?1:0,e.linkType=0,"mbps"==t?e.upUnit=1:"kbps"==t&&(e.upUnit=2),""==$("#upBandwidth").val()||!$.isnum($("#upBandwidth").val())||parseInt($("#upBandwidth").val(),10)<1||parseInt($("#upBandwidth").val(),10)>1e3)return $.alert(CMM_IQOS_BANDWIDTH_ERR),s($("#upBandwidth")),!1;if(e.upTotalBW=parseInt($("#upBandwidth").val(),10),"mbps"==l?e.downUnit=1:"kbps"==l&&(e.downUnit=2),""==$("#upBandwidth").val()||!$.isnum($("#downBandwidth").val())||parseInt($("#downBandwidth").val(),10)<1||parseInt($("#downBandwidth").val(),10)>1e3)return $.alert(CMM_IQOS_BANDWIDTH_ERR),s($("#downBandwidth")),!1;e.downTotalBW=parseInt($("#downBandwidth").val(),10),INCLUDE_IPTV&&(e.iptvEnable=$("#en_iptvQos").prop("data-checked")?1:0,e.iptvClass=a),INCLUDE_VOIP&&(e.voIPEnable=$("#en_voipQos").prop("data-checked")?1:0),e.high=$("#high").prop("value"),e.middle=$("#middle").prop("value"),e.low=$("#low").prop("value"),$.act(ACT_GET,IQOS,null,null,n),$.exe(),e.guestEnable=n.guestEnable,e.guestClass=n.guestClass;var i=$.act(ACT_GET,ALG_CFG,null,null);$.exe(),INCLUDE_CPU_MT7621&&"1"==i.hw_nat_enable?$.confirm(c_str.qos_hwnat_conflict,function(){i.hw_nat_enable="0",$.act(ACT_SET,ALG_CFG,null,null,i),$.exe(function(e){e||($.removeLoading(),$.reload())}),$.act(ACT_SET,IQOS,null,null,e),$.exe(function(e){e||($.removeLoading(),$.reload())})},function(){$.reload()}):($.act(ACT_SET,IQOS,null,null,e),$.exe(function(e){e||($.removeLoading(),$.reload())}),$.removeLoading(),$.reload())}var n,o=11,d=21,p=22,r=23,c=4,u=3,h=2;$.qosVar={};var v;$("#en_iptvQos").on("click",function(){1==$(this).prop("data-checked")?$("#div_iptvDetails").removeClass("nd"):$("#div_iptvDetails").addClass("nd")}),$("#addHigh").on("click",function(){$.qosVar.newRuleClass=c,$.complexMsg("qosRule.htm")}),$("#addMiddle").on("click",function(){$.qosVar.newRuleClass=u,$.complexMsg("qosRule.htm")}),$("#addLow").on("click",function(){$.qosVar.newRuleClass=h,$.complexMsg("qosRule.htm")}),$("#editOK").on("click",function(){$.addLoading($(this)),i()}),$("#moreCfg").on("click",function(){var e=this;$(e).hasClass("cln")?($("#con_More").addClass("nd"),$(e).removeClass("cln")):($("#con_More").removeClass("nd"),$(e).addClass("cln"))});var m=!1;$(".rule-list-container").on("mousedown","div.qos-item-container .qos-list-p",function(t){m=!1;var l=this,a=$(this).closest(".content-container"),s=t.offsetX,i=t.offsetY,n=$(this).closest(".rule-list-container"),o=$(this).closest("div.qos-item-container");$("body").off("mousemove.qos").on("mousemove.qos",function(e){m=!0;var t=$(n).offset().left,l=$(n).offset().top,d=a.offset().left,p=a.offset().top,r=d+a.width(),c=p+a.height(),u=e.clientX,h=e.clientY;u<d?u=d:u>r&&(u=r),h<p?h=p:h>c&&(h=c);var v=u-t-s,g=h-l-i;o.css({left:v,top:g,"z-index":999,position:"absolute"})}),$("body").off("mouseup.qos").on("mouseup.qos",function(t){if($("body").off(".qos"),!0===m){for(var a=$(".rule-list-container"),s=t.clientX,i=t.clientY,d=null,p=0,r=a.length;p<r;p++){var g=$(a[p]),_=g.offset().left,f=g.offset().top,w=_+g.width(),L=f+g.height();if(s>=_&&s<=w&&i>=f&&i<=L){d=g;break}}if(null===d||d[0]===n[0])o.css({position:"static",left:0,top:0,"z-index":0});else{var C;d.find("#highList").length>0?C=c:d.find("#middleList").length>0?C=u:d.find("#lowList").length>0&&(C=h);var b=$(l).attr("id").match(/_rule(\d+)$/)[1];$(l).remove(),$.act(ACT_DEL,IQOS_RULE,v[b].__stack,null);var q=$.extend({},v[b]);delete q.__stack,q.class_=C,$.addLoading(),$.act(ACT_ADD,IQOS_RULE,null,null,q),$.exe(function(){e(function(){$.removeLoading()})})}}})}),$.tpInit(function(){t(),n=$.act(ACT_GET,IQOS,null,null),algEntry=$.act(ACT_GET,ALG_CFG,null,null),INCLUDE_CPU_MT7621?$("#Nat_Note").removeClass("nv"):$("#Nat_Note").addClass("nv"),$.exe()||($("#enableQoS").prop("checked",0!=n.enable),Number(algEntry.hw_nat_enable)&&$("#enable-qos-tips").html($.tpLang.qosSettings_nstr.t_enable_tips),1==n.linkType?$("#adsl_type").prop("checked",!0):$("#other_type").prop("checked",!0),$("#upBandwidth").val(n.upTotalBW),1==n.upUnit?$('#upUnit option[value="mbps"]').prop("selected","selected"):2==n.upUnit&&$('#upUnit option[value="kbps"]').prop("selected","selected"),$("#downBandwidth").val(n.downTotalBW),1==n.downUnit?$('#downUnit option[value="mbps"]').prop("selected","selected"):2==n.downUnit&&$('#downUnit option[value="kbps"]').prop("selected","selected"),INCLUDE_IPTV&&"ETH"==$.sysMode&&($("#iptvQos").removeClass("nd"),$("#en_iptvQos").prop("checked",0!=n.iptvEnable),1==n.iptvEnable&&($("#div_iptvDetails").removeClass("nd"),$('#iptvClass option[value="'+n.iptvClass+'"]').prop("selected","selected"))),$("#high").simpleSlider("setValue",n.high),$("#middle").simpleSlider("setValue",n.middle),$("#low").simpleSlider("setValue",n.low),$("#highValue").text(n.high+"%"),$("#middleValue").text(n.middle+"%"),$("#lowValue").text(n.low+"%")),e()})}()</script>

