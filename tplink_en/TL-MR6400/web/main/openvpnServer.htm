<script language="javascript">function checkThenExportCliOvpn(){function e(){$.exe(function(e){function n(){$("#export_openvpn").prop("disabled",!1),$("#exportSt").html(""),fakeLink.click()}function t(){$.reload()}e?$.alert(e):(null==wanConn?($.alert(ERR_OVPN_WAN_DISCONN),needToGen=!1):(INCLUDE_CLOUD_ACCOUNT&&1!=cloudDns.enable||!INCLUDE_CLOUD)&&(INCLUDE_DYNDNS&&1==dynCfg.enable&&dynCfg.state==DYNDNS_STATE_CONNECTING||INCLUDE_NOIPDNS&&1==noipCfg.enable&&noipCfg.state==NOIPDNS_STATE_CONNECTING||INCLUDE_DDNS_USERDEFINE&&1==userDnsCfg.enable&&userDnsCfg.state==USERDNS_STATE_CONNECTING||wanConn.connectionStatus==DMVS_CONNECTING)?(needToGen=!1,$("#export_openvpn").prop("disabled",!0),$("#exportSt").html("Exporting"),setTimeout(checkThenExportCliOvpn,1e3)):wanConn.connectionStatus!=DMVS_CONNECTED?($.alert(ERR_OVPN_WAN_DISCONN),needToGen=!1):(INCLUDE_DYNDNS&&1!=dynCfg.enable||!INCLUDE_DYNDNS)&&(INCLUDE_NOIPDNS&&1!=noipCfg.enable||!INCLUDE_NOIPDNS)&&(INCLUDE_DDNS_USERDEFINE&&1!=userDnsCfg.enable||!INCLUDE_DDNS_USERDEFINE)&&(INCLUDE_CLOUD_ACCOUNT&&1!=cloudDns.enable||!INCLUDE_CLOUD)&&wanConn.connectionStatus==DMVS_CONNECTED?(needToGen=!0,isConfirmWindow=!0,$.confirm(c_str.ovpnDDNSNotEnWanConn,n,t)):(INCLUDE_DYNDNS&&1==dynCfg.enable&&dynCfg.state==DYNDNS_STATE_CONNECTED||INCLUDE_NOIPDNS&&1==noipCfg.enable&&noipCfg.state==NOIPDNS_STATE_CONNECTED||INCLUDE_DDNS_USERDEFINE&&1==userDnsCfg.enable&&userDnsCfg.state==USERDNS_STATE_CONNECTED||INCLUDE_CLOUD_ACCOUNT&&1==cloudDns.enable&&2==cloudDns.status&&cloudDns.boundDomain)&&wanConn.connectionStatus==DMVS_CONNECTED?needToGen=!0:(INCLUDE_DYNDNS&&1==dynCfg.enable&&dynCfg.state==DYNDNS_STATE_DISCONNECTED||INCLUDE_NOIPDNS&&1==noipCfg.enable&&noipCfg.state==NOIPDNS_STATE_DISCONNECTED||INCLUDE_DDNS_USERDEFINE&&1==userDnsCfg.enable&&userDnsCfg.state==USERDNS_STATE_DISCONNECTED||INCLUDE_CLOUD_ACCOUNT&&1==cloudDns.enable&&(2!=cloudDns.status||!cloudDns.boundDomain))&&wanConn.connectionStatus==DMVS_CONNECTED?(needToGen=!0,isConfirmWindow=!0,$.confirm(c_str.ovpnDDNSDisconnWanConn,n,t)):needToGen=!0,1==needToGen&&0==isConfirmWindow&&($("#export_openvpn").prop("disabled",!1),$("#exportSt").html(""),location.href=fakeLink.href,$.removeLoading()))})}needToGen=!1,isConfirmWindow=!1;var n=$.act(ACT_GET,L3_FORWARDING,null,null,["__ifAliasName"]),t=$.act(ACT_GL,WAN_IP_CONN,null,null,["Enable","Name","ConnectionStatus"]),o=$.act(ACT_GL,WAN_PPP_CONN,null,null,["Enable","Name","ConnectionStatus"]),c=!1;if(INCLUDE_PPTP)var r=$.act(ACT_GL,WAN_PPTP_CONN,null,null,["Enable","Name","ConnectionStatus"]);if(INCLUDE_L2TP)var l=$.act(ACT_GL,WAN_L2TP_CONN,null,null,["Enable","Name","ConnectionStatus"]);if($.exe())return!1;if($.each(t,function(){1==this.enable&&this.name==n.__ifAliasName&&(wanConn=this,c=!0)}),0==c&&$.each(o,function(){1==this.enable&&this.name==n.__ifAliasName&&(wanConn=this,c=!0)}),INCLUDE_PPTP&&0==c&&$.each(r,function(){this.enable&&this.name==n.__ifAliasName&&(wanConn=this,c=!0)}),INCLUDE_L2TP&&0==c&&$.each(l,function(){this.enable&&this.name==n.__ifAliasName&&(wanConn=this,c=!0)}),INCLUDE_DYNDNS&&(dynCfg=$.act(ACT_GET,DYN_DNS_CFG,null,null)),INCLUDE_NOIPDNS&&(noipCfg=$.act(ACT_GET,NOIP_DNS_CFG,null,null)),INCLUDE_DDNS_USERDEFINE&&(userDnsCfg=$.act(ACT_GET,USERDEFINE_DDNS_CFG,null,null)),INCLUDE_CLOUD_ACCOUNT){if(curUserObj=$.act(ACT_GET,CURRENT_USER,null,null),cloudDns=$.act(ACT_GET,CLOUD_DDNS,null,null),$.exe())return;if(2==curUserObj.userSetting&&1==cloudDns.enable){if($.act(ACT_SET,CLOUD_DDNS,null,null,["action=5","status=0"]),$.exe())return;var a=0;setTimeout(function(){a++,cloudDns=$.act(ACT_GET,CLOUD_DDNS,null,null),$.exe()||(2==cloudDns.status?e():cloudDns.status>=2e4?e():a<10?setTimeout(arguments.callee,1e3):e())},1e3)}else e()}else e()}function checkServerStatus(){curOvpnObj=$.act(ACT_GET,OPENVPN,null,null),$.exe(function(e){if(!e)if(curOvpnObj.caGenerating==OVPN_CA_GENERATED)1==updateFlag?($("#save_openvpn").prop("disabled",!1),$("#export_openvpn").prop("disabled",!1),$("#genCertSt").html(n_str.openvpnServer.t_generated).css("color","rgb(16,171,255)"),$("#genCert").prop("disabled",!1),$.removeLoading(),updateFlag=0):($("#save_openvpn").prop("disabled",!1),$("#export_openvpn").prop("disabled",!1),$("exportSt").html(""),$("#expConfForm").find("span.load").closest("div").remove(),$("#genCert").prop("disabled",!1),$("#genCertSt").html(""),$("#genCertForm").find("span.load").closest("div").remove());else{if(curOvpnObj.caGenerating!=OVPN_CA_GENERATING)return;if(updateFlag=1,$("#save_openvpn").prop("disabled",!0),$("#export_openvpn").prop("disabled",!0),$("#genCert").prop("disabled",!0),$.addLoading($("#genCert"),null,null,1),$("#genCertSt").html(n_str.openvpnServer.t_generating),timeOutID>0)return;timeOutID=setTimeout(function(){timeOutID=0,checkServerStatus()},1e3)}})}function checkConflictOvpnVSPort(e,n,t){var o=!1;return 0==n?t==e&&(o=!0):0==e?t==n&&(o=!0):e<=t&&n>=t&&(o=!0),!!o}function checkConflictOvpnVSProtocol(e,n){var t=!1;return"TCP or UDP"==e?t=!0:e==n&&(t=!0),!!t}function checkConflictOvpnPTPort(e,n){for(var t=!1,o=(e=e.toString()).split(","),c=0;c<o.length;c++){var r=o[c].split("-");if(1==r.length){if(n==r[0]){t=!0;break}}else if(2==r.length){if(r[0]>r[1]){var l=r[0];r[0]=r[1],r[1]=l}if(r[0]<=n&&r[1]>=n){t=!0;break}}}return!!t}function checkConflictOvpnPTProtocol(e,n){var t=!1;return"TCP or UDP"==e?t=!0:e==n&&(t=!0),!!t}function init(){curOvpnObj=$.act(ACT_GET,OPENVPN,null,null),$.exe()||($("#openvpnEn").prop("checked",1==curOvpnObj.enable),"UDP"==curOvpnObj.proto?$("#serviceTypeUDP").prop("checked","checked"):"TCP"==curOvpnObj.proto?$("#serviceTypeTCP").prop("checked","checked"):$.alert(CMM_INTERNAL_ERROR),$("#servicePort").prop("value",curOvpnObj.port),1==curOvpnObj.access?$("#accessHome").prop("checked","checked"):2==curOvpnObj.access?$("#accessInternetHome").prop("checked","checked"):$.alert(CMM_INTERNAL_ERROR),$("#ovpnSubnet").tpAddress("val",curOvpnObj.subnetAddress),$("#ovpnNetmask").tpAddress("val",curOvpnObj.subnetMask),curOvpnObj.caGenerating==OVPN_CA_NOT_GENERATED?$("#noteCert").removeClass("nd"):$("#noteCert").addClass("nd"),checkServerStatus())}function checkNothingChg(){return!(1==curOvpnObj.enable&&0==$("#openvpnEn").prop("data-checked")||0==curOvpnObj.enable&&1==$("#openvpnEn").prop("data-checked"))&&(!("UDP"==curOvpnObj.proto&&1==$("#serviceTypeTCP").prop("checked")||"TCP"==curOvpnObj.proto&&1==$("#serviceTypeUDP").prop("checked"))&&(curOvpnObj.port==parseInt($("#servicePort").prop("value"),10)&&(!(1==curOvpnObj.access&&1==$("#accessInternetHome").prop("checked")||2==curOvpnObj.access&&1==$("#accessHome").prop("checked"))&&($("#ovpnSubnet").tpAddress("val")==curOvpnObj.subnetAddress&&$("#ovpnNetmask").tpAddress("val")==curOvpnObj.subnetMask))))}function checkParaValidity(){var e=parseInt($("#servicePort").prop("value"),10),n=$("#ovpnSubnet").tpAddress("val"),t=$.ip2num(n),o=$("#ovpnNetmask").tpAddress("val"),c=$.ip2num(o);if(e.length<=0||!$.isnum(e)||e<1024||e>65534)return $.alert(ERR_OVPN_PORT_INVALID),(r=$("#servicePort"))&&(r.focus(),r.select()),!1;if(21==e||53==e||70==e||80==e||119==e||110==e||1701==e||1723==e||25==e||1080==e||23==e||33344==e||20005==e||1900==e||20002==e||7547==e||139==e||445==e||7505==e){$.alert(ERR_OVPN_PORT_EXISTS);var r=$("#servicePort");return r&&(r.focus(),r.select()),!1}return $.ifip(n,!0)?($.alert(ERR_OVPN_SUBNET_INVAD),(r=$("#ovpnSubnet"))&&(r.focus(),r.select()),!1):$.mask(o,!0)?($.alert(ERR_OVPN_NETMASK_INVAD),(r=$("#ovpnNetmask"))&&(r.focus(),r.select()),!1):c>=$.ip2num("255.255.255.248")?($.alert(ERR_OVPN_NETMASK_INVAD_VALUE),(r=$("#ovpnNetmask"))&&(r.focus(),r.select()),!1):c<$.ip2num("255.255.0.0")?($.alert(ERR_OVPN_NETMASK_INVAD),(r=$("#ovpnNetmask"))&&(r.focus(),r.select()),!1):(t&c)==t||($.alert(ERR_OVPN_SUBNET_NETMASK_INVAD),(r=$("#ovpnSubnet"))&&(r.focus(),r.select()),!1)}function checkCurrentTime(){var e=$.act(ACT_GET,HOUR,null,null);return!$.exe()&&(!(e.year<2015||e.year>2037)||($.alert(ERR_OVPN_TIME_NOT_SET),!1))}var curOvpnObj,newOvpnObj,curUserObj,cloudDns,dynCfg,noipCfg,userDnsCfg,wanConn,updateFlag,OVPN_CA_NOT_GENERATED=0,OVPN_CA_GENERATED=1,OVPN_CA_GENERATING=2,fakeLink,needToGen=!1,isConfirmWindow=!1,DMVS_CONNECTING="Connecting",DMVS_CONNECTED="Connected",DYNDNS_STATE_DISCONNECTED=0,DYNDNS_STATE_CONNECTING=1,DYNDNS_STATE_CONNECTED=2,NOIPDNS_STATE_DISCONNECTED=3,NOIPDNS_STATE_CONNECTING=4,NOIPDNS_STATE_CONNECTED=5,USERDNS_STATE_DISCONNECTED=0,USERDNS_STATE_CONNECTING=1,USERDNS_STATE_CONNECTED=2,timeOutID;$("#save_openvpn").click(function(){function e(){$.addLoading(),$("#accessHome").prop("checked")?o=1:$("#accessInternetHome").prop("checked")&&(o=2),c=$("#ovpnSubnet").tpAddress("val"),r=$("#ovpnNetmask").tpAddress("val"),$.act(ACT_SET,OPENVPN,null,null,["enable="+n,"proto="+t,"port="+a,"subnetAddress="+c,"subnetMask="+r,"access="+o]),$.exe(function(e){$.removeLoading(),e||$.reload()})}var n,t,o,c,r,l=0;if($.addLoading($(this)),checkParaValidity()){if(checkNothingChg())return $.removeLoading(),void $.reload();n=$("#openvpnEn").prop("data-checked")?1:0,$("#serviceTypeUDP").prop("checked")?t="UDP":$("#serviceTypeTCP").prop("checked")&&(t="TCP");var a=$("#servicePort").prop("value");if(n){var N,i,_,C,p,s=[],u=[],T=0;curOvpnObj=$.act(ACT_GET,OPENVPN,null,null),p=$.act(ACT_GET,DMZ_HOST_CFG,null,null),s=$.act(ACT_GL,WAN_IP_CONN_PORTMAPPING,null,null),N=$.act(ACT_GL,IP_CONN_PORTTRIGGERING,null,null),u=$.act(ACT_GL,WAN_PPP_CONN_PORTMAPPING,null,null),i=$.act(ACT_GL,PPP_CONN_PORTTRIGGERING,null,null);var E=$.act(ACT_GL,UPNP_PORTMAPPING,null,null),O=$.act(ACT_GET,UPNP_CFG,null,null);if(INCLUDE_L2TP&&(vtlServList_L2TP=$.act(ACT_GL,WAN_L2TP_CONN_PORTMAPPING,null,null),_=$.act(ACT_GL,L2TP_CONN_PORTTRIGGERING,null,null)),INCLUDE_PPTP&&(vtlServList_PPTP=$.act(ACT_GL,WAN_PPTP_CONN_PORTMAPPING,null,null),C=$.act(ACT_GL,PPTP_CONN_PORTTRIGGERING,null,null)),$.exe(),$.each(s,function(){checkConflictOvpnVSPort(this.externalPort,this.X_TP_ExternalPortEnd,a)&&1==this.portMappingEnabled&&checkConflictOvpnVSProtocol(this.portMappingProtocol,t)&&(T=1)}),$.each(u,function(){checkConflictOvpnVSPort(this.externalPort,this.X_TP_ExternalPortEnd,a)&&1==this.portMappingEnabled&&checkConflictOvpnVSProtocol(this.portMappingProtocol,t)&&(T=1)}),$.each(N,function(){checkConflictOvpnPTPort(this.openPort,a)&&1==this.enable&&checkConflictOvpnPTProtocol(this.openProtocol,t)&&(T=2)}),$.each(i,function(){checkConflictOvpnPTPort(this.openPort,a)&&1==this.enable&&checkConflictOvpnPTProtocol(this.openProtocol,t)&&(T=2)}),INCLUDE_L2TP&&($.each(vtlServList_L2TP,function(){checkConflictOvpnVSPort(this.externalPort,this.externalPortEnd,a)&&1==this.portMappingEnabled&&checkConflictOvpnVSProtocol(this.portMappingProtocol,t)&&(T=1)}),$.each(_,function(){checkConflictOvpnPTPort(this.openPort,a)&&1==this.enable&&checkConflictOvpnPTProtocol(this.portMappingProtocol,t)&&(T=2)})),INCLUDE_PPTP&&($.each(vtlServList_PPTP,function(){checkConflictOvpnVSPort(this.externalPort,this.externalPortEnd,a)&&1==this.portMappingEnabled&&checkConflictOvpnVSProtocol(this.portMappingProtocol,t)&&(T=1)}),$.each(C,function(){checkConflictOvpnPTPort(this.openPort,a)&&1==this.enable&&checkConflictOvpnPTProtocol(this.portMappingProtocol,t)&&(T=2)})),$.each(E,function(){this.externalPort==a&&1==O.enable&&this.portMappingProtocol==t&&(T=3)}),1==n&&1==p.enable)return $.alert(CMM_DMZ_CONFLICT_WITH_OVPN),void $.reload();if(1==n&&1==T)return $.alert(CMM_VS_CONFLICT_WITH_OVPN),void $.reload();if(1==n&&2==T)return $.alert(CMM_PT_CONFLICT_WITH_OVPN),void $.reload();if(1==n&&3==T)return $.alert(CMM_UPNP_CONFLICT_WITH_OVPN),void $.reload()}$("#openvpnEn").prop("data-checked")&&curOvpnObj.caGenerating==OVPN_CA_NOT_GENERATED&&(l=1,$.confirm(c_str.ovpnNoCertSave,e,function(){$.reload()},null,m_str.ok,m_str.cancel)),0==l&&e()}}),$("#export_openvpn").click(function(){curOvpnObj.caGenerating!=OVPN_CA_NOT_GENERATED?($.addLoading($(this)),void 0===(fakeLink=document.createElement("a")).click?location.href="":(fakeLink.href="/cgi/openvpn?cliOvpnDown",document.body.appendChild(fakeLink)),checkThenExportCliOvpn()):$.alert(ERR_OVPN_CERT_NOT_GEN_EXP)}),$("#genCert").click(function(){$.addLoading($(this)),$.act(ACT_OP,ACT_OP_OVPN_REGEN_KEYS,curOvpnObj.__stack),$.exe(function(e){e?$.alert(e):($.reload(),$.removeLoading())})})</script>
<h3 id="t_openvpn">OpenVPN</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div id="noteCert" class="nd" style="margin:0 0">
            <p class="cfg-line" style="margin:0 0">
                <span id="t_stepCert">Note:</span>
                <span id="t_stepCert1">No certificate currently, please <b>Generate</b> one before enabling VPN Server.</span>
            </p>
        </div>
        <div>
            <b class="l" id="t_empty"></b>
            <input type="checkbox" id="openvpnEn">
            <label id="t_enOvpn">Enable VPN Server</label>
        </div>

        <div>
            <b class="l" id="t_srvType">Service Type:</b>
            <input type="radio" name="serviceType" id="serviceTypeUDP">
            <label id="t_udp">UDP</label>
            <input type="radio" name="serviceType" id="serviceTypeTCP">
            <label id="t_tcp">TCP</label>
        </div>
        <div>
            <b class="l" id="t_servicePort">Service Port:</b>
            <input type="text" id="servicePort" class="l" required>
        </div>
        <div class="inline">
            <b class="l" id="t_ovpnSubnetAndMask">VPN Subnet/Netmask:</b>
            <input type="text" id="ovpnSubnet" class="l ip-address" required>
            <input type="text" id="ovpnNetmask" class="l ip-address" required>
        </div>
        <div>
            <b class="l" id="t_cliAccess">Client Access:</b>
            <input type="radio" name="clientAccess" id="accessHome">
            <label id="t_home">Home Network Only</label>
            <input type="radio" name="clientAccess" id="accessInternetHome">
            <label id="t_internetHome">Internet and Home Network</label>
        </div>

        <div class="part-separate">
            <button type="submit" class="green T_save" id="save_openvpn">Save</button>
        </div>
    </form>
</div>

<h3 id="t_genCert">Certificate</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned" id="genCertForm">
        <div class="pure-control-group">
            <label class="label-title xxl" id="t_genText">Generate the certificate.</label>
            <button type="submit" class="green T_c_genCert l_auto" id="genCert">Generate</button>
            <div class="inline" style="margin-left:25px">
                <span id="genCertSt"></span>
            </div>
        </div>
    </form>
</div>

<h3 id="t_configFile">Configuration File</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned" id="expConfForm">
        <div class="pure-control-group">
            <label class="label-title xxl" id="t_export">Export the configuration.</label>
            <button type="submit" class="green T_c_export ru-l" id="export_openvpn">Export</button>
            <div class="inline" style="margin-left:25px">
                <span id="exportSt"></span>
            </div>
        </div>
    </form>
</div>
<script language="javascript">$.tpInit(init)</script>
