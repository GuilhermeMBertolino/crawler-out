<script type="text/javascript">
var menuBasic = {
    'netMap': [{
        'name': menu_str['map'],
        'url': 'networkMap.htm'
    }],
    'internet': [{
        'name': menu_str['internet'],
        'url':  (INCLUDE_LTEWAN && ($.sysMode == "LTE")) ? 'basicLte.htm' : (INCLUDE_ADSLWAN && ($.sysMode == "DSL")) ? 'wanBasicDsl.htm' : ($.sysMode == "USB_3G") ? 'basic3g.htm' : 'wanBasic.htm'
    }],
    'wireless': [{
        'name': menu_str['wl'],
        'url': 'wirelessBasic.htm'
    }],
    'guestNtw': [{
        'name': menu_str['wlguest'],
        'url': 'wlGuestDulBandBasic.htm'
    }],
    'voip': [{
        'name': menu_str['voip'],
        'url': 'voice_basic.htm'
    },{
        'name': menu_str['voicetel'],
        'url': 'voice_basic.htm'
    }, {
        'name': menu_str['voicedev'],
        'url': 'voice_telephony.htm'
    }, {
        'name': menu_str['usbmail'],
        'url': 'voice_usbmailBasic.htm'
    }],
    'usb': [{
        'name': menu_str['usb'],
        'url': 'usbManage.htm'
    }, {
        'name': menu_str['disk'],
        'url': 'usbManage.htm'
    }, {
        'name': menu_str['printer'],
        'url': 'printSrv.htm'
    }, {
        'name': menu_str['usb3g'],
        'url':  (INCLUDE_USB_3G_DONGLE) ? 0 : 'basic3g.htm'
    }],
    'parentCtrl': [{
        'name': menu_str['pc'],
        'url': 'parentCtrl.htm'
    }],
    'iptv': [{
        'name': menu_str['iptv'],
        'url': INCLUDE_IPTV ? 'iptv.htm' : 0
    }],
    'cloud': [{
        'name': menu_str['cloud'],
        'url': INCLUDE_CLOUD_ACCOUNT ? 'cloudBasic.htm' : 0
    }]
};

var menuAdv = {
    'status': [{
        'name': menu_str['status'],
        'url': 'status.htm'
    }],
    'sysMode': [{
        'name': menu_str['sysmod'],
        'url': 'sysMode.htm'
    }],
    'internet': [{
        'name': menu_str['network'],
        'url':  ($.sysMode == "LTE") ? 'advanceLte.htm' : (($.sysMode == "ETH") ? 'ethWan.htm' : (($.sysMode == "USB_3G") ? 'usb3g.htm' : 'wan.htm'))
    }, {
        'name': menu_str['internet'],
        'url':  ($.sysMode == "LTE") ? 'advanceLte.htm' : (($.sysMode == "ETH") ? 'ethWan.htm' : (($.sysMode == "USB_3G") ? 'usb3g.htm' : 'wan.htm'))
    }, {
        'name': menu_str['usb3g'],
        'url': ($.sysMode == "ETH" && INCLUDE_USB_3G_BACKUP && ($.usb3gBackup == "1")) ?'usb3g.htm' : 0
    }, {
        'name': menu_str['ewan'],
        'url': ($.sysMode == "USB_3G" && INCLUDE_EWAN_BACKUP && ($.ewanBackup == "1")) ?'ethWan.htm' : 0
    }, {
        'name': menu_str['lteBackup'],
        'url': (INCLUDE_LTEWAN && ($.sysMode == "LTE") || (!INCLUDE_LTEWAN)) ? 0 : 'advanceLte.htm'
    }, {
	'name': menu_str['ltepin'],
        'url': (INCLUDE_LTEWAN) ? 'PINManagement.htm': 0
    }, {
	'name': menu_str['ltedata'],
	'url': (INCLUDE_LTEWAN) ? 'dataSettings.htm': 0
    }, {
        'name': menu_str['lan'],
        'url': 'dhcp.htm'
    }, {
        'name': menu_str['group'],
        'url': ((INCLUDE_LTEWAN) || (INCLUDE_USB_3G_DONGLE)) ? 0 :'group.htm'
    }, {
        'name': menu_str['dsl'],
        'url': ($.sysMode == "DSL") ? 'dslcfg.htm' : 0
    }, {
        'name': menu_str['ddns'],
        'url': 'ddns.htm'
    }, {
        'name': menu_str['advroute'],
        'url': 'route.htm'
    }, {
        'name': menu_str['tunnel6'],
        'url': 'ipv6Tunnel.htm'
    }],
    'sms': [{
        'name': menu_str['sms'],
        'url' : (INCLUDE_LTEWAN) ? 'lteSmsInbox.htm': 0
    }, {
        'name': menu_str['inbox'],
        'url' : (INCLUDE_LTEWAN) ? 'lteSmsInbox.htm': 0
    }, {
        'name': menu_str['newMsg'],
        'url' : (INCLUDE_LTEWAN) ? 'lteSmsNewMsg.htm': 0
    }, {
        'name': menu_str['outbox'],
        'url' : (INCLUDE_LTEWAN) ? 'lteSmsOutbox.htm': 0
    }, {
        'name': menu_str['draftbox'],
        'url' : (INCLUDE_LTEWAN) ? 'lteSmsDraftbox.htm': 0
    }, {
        'name': menu_str['smsSettings'],
        'url' : (INCLUDE_LTEWAN) ? 'lteSmsSettings.htm': 0
    }],
    'iptv': [{
        'name': menu_str['iptv'],
        'url': INCLUDE_IPTV ? 'iptv.htm' : 0
    }],
    'wireless': [{
        'name': menu_str['wl'],
        'url': 'wirelessSettings.htm'
    }, {
        'name': menu_str['wlset'],
        'url': 'wirelessSettings.htm'
    }, {
        'name': menu_str['wps'],
        'url': 'wps.htm'
    }, {
        'name': menu_str['wlsche'],
        'url': INCLUDE_LAN_WLAN_SCHEDULE ? 'wirelessSchedule.htm' : 0
    }, {
        'name': menu_str['stat'],
        'url': 'wirelessStat.htm'
    }, {
        'name': menu_str['advset'],
        'url': 'wirelessAdv.htm'
    }],
    'guestNtw': [{
        'name': menu_str['wlguest'],
        'url': 'wlGuestDulBandAdv.htm'
    }],
    'voip': [{
        'name': menu_str['voip'],
        'url': 'voice_advance.htm'
    }, {
        'name': menu_str['voicetel'],
        'url': 'voice_advance.htm'
    }, {
        'name': menu_str['voicebook'],
        'url': 'voice_telebook.htm'
    }, {
        'name': menu_str['voicedev'],
        'url': 'voice_telephony.htm'
    }, {
        'name': menu_str['voicelog'],
        'url': 'voice_calllog.htm'
    }, {
        'name': menu_str['voicerule'],
        'url': 'voice_electionRule.htm'
    }, {
        'name': menu_str['voiceblock'],
        'url': 'voice_callblocks.htm'
    }, {
        'name': menu_str['voicefwd'],
        'url': 'voice_callforward.htm'
    }, {
        'name': menu_str['voiceth'],
        'url': 'voice_callthrough.htm'
    }, {
        'name': menu_str['voicedect'],
        'url': 'voice_dectadv.htm'
    }, {
        'name': menu_str['voiceapp'],
        'url': INCLUDE_VOICEAPP ? 'voice_voiceapp.htm' : 0
    },{
        'name': menu_str['usbmail'],
        'url': 'voice_usbmail.htm'
    }],
    'fwd': [{
        'name': menu_str['fwd'],
        'url': 'alg.htm'
    }, {
        'name': menu_str['alg'],
        'url': 'alg.htm'
    }, {
        'name': menu_str['vs'],
        'url': 'virtualServer.htm'
    }, {
        'name': menu_str['pt'],
        'url': 'portTrigger.htm'
    }, {
        'name': menu_str['dmz'],
        'url': 'dmz.htm'
    }, {
        'name': menu_str['upnp'],
        'url': 'upnp.htm'
    }],
    'usb': [{
        'name': menu_str['usb'],
        'url': 'folderSharing.htm'
    }, {
        'name': menu_str['disk'],
        'url': 'folderSharing.htm'
    }, {
        'name': menu_str['printer'],
        'url': 'printSrv.htm'
    }, {
        'name': menu_str['usb3g'],
        'url': (INCLUDE_USB_3G_DONGLE) ? 0 : 'usb3g.htm'
    }],
    'parentCtrl': [{
        'name': menu_str['pc'],
        'url': 'parentCtrl.htm'
    }],
    'qos': [{
        'name': menu_str['qos'],
        'url': INCLUDE_APP_IQOS ? 'qosSettings.htm' : 0
    }, {
        'name': menu_str['qosSub'],
        'url': INCLUDE_APP_IQOS ? 'qosSettings.htm' : 0
    }, {
        'name': menu_str['qosdatabase'],
        'url': INCLUDE_APP_IQOS ? 'qosDatabase.htm' : 0
    }],
    'trafficCtrl': [{
        'name': menu_str['tc'],
        'url': INCLUDE_APP_IQOS ? 0 : 'trafficCtrl.htm'
    }],
    'security': [{
        'name': menu_str['sec'],
        'url': 'ddos.htm'
    }, {
        'name': menu_str['ddos'],
        'url': 'ddos.htm'
    }, {
        'name': menu_str['pf'],
        'url': 'portFiltering.htm'
    }, {
        'name': menu_str['acc'],
        'url': 'accessControl.htm'
    }, {
        'name': menu_str['arp'],
        'url': 'arpBind.htm'
    }, {
        'name': menu_str['yandexDns'],
        'url': INCLUDE_YANDEX_DNS ? 'yandexDns.htm' : 0
    }],
    'vpn': [{
        'name': menu_str['vpn'],
        'url': (INCLUDE_VPN) ? ((INCLUDE_OPENVPN_SERVER) ? 'openvpnServer.htm' : ((INCLUDE_PPTPVPN_SERVER) ? 'pptpvpnServer.htm' : ((INCLUDE_IPSEC) ? 'ipsec.htm' : 0))) : 0
    }, {
        'name': menu_str['openvpn'],
        'url': (INCLUDE_VPN && INCLUDE_OPENVPN_SERVER) ? 'openvpnServer.htm' : 0
    }, {
        'name': menu_str['pptpvpn'],
        'url': (INCLUDE_VPN && INCLUDE_PPTPVPN_SERVER) ? 'pptpvpnServer.htm' : 0
    }, {
        'name': menu_str['ipsec'],
        'url': (INCLUDE_VPN && INCLUDE_IPSEC) ? 'ipsec.htm' : 0
    }, {
        'name': menu_str['vpnconn'],
        'url': (INCLUDE_VPN && (INCLUDE_OPENVPN_SERVER || INCLUDE_PPTPVPN_SERVER || INCLUDE_IPSEC)) ? 'vpnStatus.htm' : 0
    }],
    'tools': [{
        'name': menu_str['tools'],
        'url': 'time.htm'
    }, {
        'name': menu_str['time'],
        'url': 'time.htm'
    }, {
        'name': menu_str['ledsche'],
        'url': INCLUDE_LED_SCHEDULE ? 'ledSchedule.htm' : 0
    }, {
        'name': menu_str['pushService'],
        'url': INCLUDE_MAIL ? 'pushService.htm' : 0
    }, {
        'name': menu_str['diag'],
        'url': 'diagnostic.htm'
    }, {
        'name': menu_str['softup'],
        'url': clientLocal ? 'softup.htm': 0
    }, {
        'name': menu_str['bnr'],
        'url': clientLocal ? 'backNRestore.htm' : 0
    }, {
        'name': menu_str['restart'],
        'url': INCLUDE_REBOOT_SCHEDULE ? 'restart.htm' : 0
    }, {
        'name': menu_str['admin'],
        'url': clientLocal ? 'manageCtrl.htm' : 0
    }, {
        'name': menu_str['log'],
        'url': 'log.htm'
    }, {
        'name': menu_str['cwmp'],
        'url': 'cwmp.htm'
    }, {
        'name': menu_str['snmp'],
        'url': 'snmp.htm'
    }, {
        'name': menu_str['tm'],
        'url': 'stat.htm'
    }]
};

(function($) {
    'use strict';

    function TPMenu() {}

    TPMenu.prototype = {
        constructor: TPMenu,
        instances: [],
        init: function(id, menuargs) {
            var self = this;
            var page;
            var expr = /\w+.htm$/;
            var hasMore = 0; /* means has secondary menu */
            var inHTMLTmp = '';
            var searchInput = true;


            self.id = id;
            self.$menu = $("#" + id);

            if ($("#qs").hasClass("selected")) {
                $('#menu').tpMenu('destroy');
                $("#con").fadeOut(200);
                $("#verticalFixed").fadeOut(0);  //menu and help icon;no animation
                $.loadPage("quicksetup", "quicksetup.htm", function() {
                    $('#main').empty();
                    $.emptyElem($.bak);
                    $.clearAsync();
                    $.unlock();
                });
                $("#quicksetup").fadeIn(200);
                $.curPage = "quicksetup.htm";
                return;
            } else {
                $("#con").fadeIn(200);
                $("#verticalFixed").fadeIn(200);  //menu and help icon
                $("#quicksetup").fadeOut(200);
            }

            var inHTML = '<div><ul class="mu1" id="menuTree">';

            /* Get menulist from DUT */
            $.cgi("./frame/menu.cgi", null, function(err) {
                if (err) {
                    return;
                }

                var menulistLen = menulist.length;
                for (var i = 0; i < menulistLen; i++) {
                    if (!$.local) {
                        if ((clientLocal == 0) && ((menulist[i] == 'softup.htm') || (menulist[i] == 'backNRestore.htm'))) {
                            menulist[i] = undefined;
                            continue;
                        }
                    }

                    var ret = expr.exec(menulist[i]);
                    if (ret) {
                        menulist[i] = ret[0];
                    } else {
                        menulist[i] = undefined;
                    }
                }

                self.menuFilter(menulist, menuargs);

                for (page in menuargs) {
                    inHTMLTmp = '';
                    hasMore = 0;

                    if (menuargs[page].length == 1) {
                        if (/*($.sysMode == "USB_3G" && menuargs[page][0].name == menu_str['internet']) || */
                            ($.sysMode != "DSL" && $.sysMode != "ETH" &&menuargs[page][0].name == menu_str['iptv']) || (menuargs[page][0].url == '0')) {
                            continue;
                        }
                        inHTML += '<li class="ml1"><a class="click" href="javascript:void(0);" url="' + menuargs[page][0].url + '">';
                        inHTML += '<span class="icon" id="' + page + '"></span>';
                        inHTML += '<span class="text T">' + menuargs[page][0].name + '</span></a>';
                        inHTML += '</li>';
                    } else {
                        if ($.sysMode == "USB_3G" && (menuargs[page][0].url == menu_str['wan'])) {
                            continue;
                        }

                        inHTMLTmp += '<li class="ml1"><a class="click more" href="javascript:void(0);" url="' + menuargs[page][0].url + '">';
                        inHTMLTmp += '<span class="icon" id="' + page + '"></span>';
                        inHTMLTmp += '<span class="text T">' + menuargs[page][0].name + '</span></a>';
                        inHTMLTmp += '<ul class="mu2">';
                        for (var l = 1; l < menuargs[page].length; l++) {
                            if (($.sysMode == "USB_3G" && menuargs[page][l].name == menu_str['wan']) || (menuargs[page][l].url == '0')) {
                                continue;
                            }
                            hasMore = 1;
                            inHTMLTmp += '<li class="ml2"><a class="click" href="javascript:void(0);" url="' + menuargs[page][l].url + '">';
                            inHTMLTmp += '<span class="text T">' + menuargs[page][l].name + '</span></a>';
                            inHTMLTmp += '</li>';
                        }
                        inHTMLTmp += '</ul>';
                        inHTMLTmp += '</li>';
                        if (hasMore == 0) {
                            continue;
                        } else if (hasMore == 1 && inHTMLTmp !== undefined) {
                            inHTML += inHTMLTmp;
                        }
                    }
                }
                inHTML += '</ul></div>';
                $('#menu').append($(inHTML)).find('ul.mu2').hide();    //change for bug in ie11

                $("#menu").niceScroll({
                    cursorcolor: "#36444b",
                    cursoropacitymax: 0.15,
                    cursoropacitymin: 0.15,
                    touchbehavior: false,
                    cursorwidth: "8px",
                    cursorborder: "0",
                    cursorborderradius: "4px",
                    scrollspeed: 20,
                    zindex:2

                    });

                self.$a = $('a.click');
                self.$li = $('li');
                self.registerHandlers();
                self.$a.first().click();

                if (searchInput && $('#menu').prev('.menu-search-input-container').length == 0) {
                    $('#menu').before('<div class="menu-search-input-container"><input type="text" class="menu-search-input" id="menu-search-input"/></div>')
                            .addClass('hasSearch');
                    var inputData = [];
                    var i, j, len, tmp;

                    var menuReconstruct = function(menu, navName) {
                        self.menuFilter(menulist, menu);
                        for (i in menu) {
                            var level1 = '';
                            for (j = 0, len = menu[i].length; j < len; j++) {
                                if (len > 1 && j == 0) {
                                    level1 = menu[i][j].name + ' -> ';
                                    continue;
                                }
                                if (menu[i][j].url != 0) {
                                    tmp = {};
                                    tmp.text = level1 + menu[i][j].name;
                                    tmp.value = {};
                                    tmp.value.url = menu[i][j].url;
                                    tmp.value.navName = navName;
                                    inputData.push(tmp);
                                }

                            }
                        }
                    };

                    menuReconstruct(menuBasic, 'basic');
                    menuReconstruct(menuAdv, 'advanced');

                    inputData.sort(function(a, b) {
                        if (a.text.toUpperCase() <= b.text.toUpperCase()) {
                            return -1;
                        } else {
                            return 1;
                        }
                    });
                    $('#menu-search-input').tpSearchInput({
                        data: inputData,
                        width: $('#menuTree li.ml1').width(),
                        placeholder: s_str.search,
                        selectCallback: function(text, data) {
                            $.goToOtherPage(data.url, data.navName, function() {
                                $('#menu-search-input').tpSearchInput('val', '');
                            });
                        }
                    });
                }
            });
        },
        menuFilter: function(menulist, menuargs) {
            var have = 0;
            for (var page in menuargs) {
                for (var l = 0; l < menuargs[page].length; l++) {
                    have = 0;
                    $.each(menulist, function() {
                        var self = this;
                        if (this == menuargs[page][l].url) {
                            have = 1;
                            return false;
                        }
                    });
                    if ((have == 0)) {
                        menuargs[page][l].url = '0';
                    }
                }
            }
        },
        registerHandlers: function() {
            var self = this;
            var scrollAdjust = 0;
            self.$a.on('click.tpMenu', function(e) {
                var pageUrl;
                var me = $(this);
                var parentli = me.parent('li');
				var needSlide = false;
				if($('li.ml1 a.more').hasClass('clicked')){
					needSlide = true;
				}

                if (parentli.hasClass('ml2')) {
                    $('#menu').find('a').removeClass('sel').removeClass('clicked').parent('li.sel').removeClass('sel');
                    var ancestorLi = parentli.closest('li.ml1');
                    ancestorLi.children('a').addClass('sel').addClass('clicked');
                    me.addClass('sel').addClass('clicked');
                    parentli.addClass('sel');
                    scrollAdjust = ancestorLi.position().top;
					if ($('#menu').find('li:not(:has(a.clicked)) ul.mu2:visible').length==0){
						needSlide = false;
					}
                    $('#menu').find('li:not(:has(a.clicked)) ul.mu2:visible').slideUp('fast', function() {
                        $('#menu').scrollTop(ancestorLi.position().top - $('#menu').children(':first').position().top - scrollAdjust);
                    });
                } else if (me.hasClass('more')) {
                     var mu2 = me.next('ul.mu2');
                    if (mu2.is(':visible')) {
                        if (mu2.find('a.sel.clicked').length == 0) {
                            me.removeClass('clicked')
                        }
                        mu2.slideUp('fast', function() {
//                            $('#menu').scrollTop($('#menu')[0].scrollTop - mu2.height());
                        });
                    } else {
                        me.addClass('clicked');
                        mu2.slideDown('fast', function() {
                            $('#menu').scrollTop(me.position().top - $('#menu').children(':first').position().top);
                        });
                        var tmpLi = parentli.siblings('li:has(a.clicked:not(.sel))');
                        tmpLi.find('a').removeClass('clicked');
                        tmpLi.find('ul.mu2').slideUp('fast');
                    }
                    return;
                } else {
                    $('#menu').find('a').removeClass('sel').removeClass('clicked').parent('li.sel').removeClass('sel');
                    scrollAdjust = parentli.position().top;
                    $('ul.mu2:visible').slideUp('fast', function() {
                        $('#menu').scrollTop(parentli.position().top - $('#menu').children(':first').position().top - scrollAdjust);
                    });
                    me.addClass('sel').addClass('clicked');
                }

                pageUrl = me.attr('url');
                $('#scroll').scrollTop(0);

				if(needSlide){
					needSlide = false;
					$.timeout(function(){
						$.loadMain(pageUrl);
					},200);
				} else {
					$.loadMain(pageUrl);
				}


            });

            //adjust menu's height, prevent menu overlapping bottom.
            function adjustMenuHeight() {
                var botHeight = $(window).height() - $('#bot').offset().top;
                botHeight = botHeight < 0 ? 0: botHeight;
                $('#menu').css('maxHeight', $(window).height() - botHeight -  $('#top').height() - parseInt($('#menu').css('marginTop').match(/\d*/)));
            }

            //when page scrolling or window resize or load a new page, need to adjust menu's height;
            $('#scroll').off('scroll.menu').on('scroll.menu', function() {
                adjustMenuHeight();
            });
            $(window).off('resize.menu loadPage.menu').on('resize.menu loadPage.menu', function() {
                adjustMenuHeight();
            });
            adjustMenuHeight();
        },
        destroy: function() {
            var self = this;
            if (self.$a) {
                self.$a.off('.tpMenu');
            }
            if (self.$li) {
                self.$li.off('.tpMenu');
            }
            delete Object.getPrototypeOf(self).instances[self.id];
        }
    };

    $.fn.tpMenu = function(options) {
        this.each(function() {
            var tpmenu = $(this).data('tpMenu');
            if (!tpmenu) {
                $(this).data('tpMenu', new TPMenu());
                $(this).data('tpMenu').init(this.id, menuargs);
            } else if (options === 'destroy' && tpmenu) {
                tpmenu.destroy();
            } else {
                tpmenu.destroy();
                $(this).data('tpMenu', new TPMenu());
                $(this).data('tpMenu').init(this.id, menuargs);
            }
        });
    };

})(jQuery);

var haveClick = false;
if ($("#advanced").hasClass("selected") ||
	$("#basic").hasClass("selected"))
	haveClick = true;
//if ($.isFD == 1 || $.isFD == 2) {
if ((haveClick == false) && ($.isFD == 1 || $.isFD == 2)) {
    $("#qs").addClass("selected");
    $("#con").fadeOut(200);
	$("#verticalFixed").fadeOut(0);
    $.loadPage("quicksetup", "quicksetup.htm", function() {
        $.curPage = "quicksetup.htm";
        $.emptyElem($.bak);
        $.clearAsync();
        $.unlock();
    });
    if ($.isFD == 1)
    	$("#quicksetup").css("display", "block");
} else {
    if ($("#advanced").hasClass("selected")) {
        menuargs = menuAdv;
    } else if ($("#qs").hasClass("selected")) {
        menuargs = {};
    } else {
        menuargs = menuBasic;
        $("#basic").addClass("selected");
    }
    $('#menu').tpMenu(menuargs);
}
</script>
