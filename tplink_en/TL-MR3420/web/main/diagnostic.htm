<script language="javascript" type="text/javascript">
var strPass = "<span class='green'>"+m_str.pass+"</span>";
var strFail = "<span class='red'>"+m_str.fail+"</span>";
var wanAccessType = (INCLUDE_LTEWAN ? "LTE" : "");
var intfCfgStack = "";
var wanConnStack = "";
var wanType = "";
var bStart = false;	/* indicates that whether we've started a diagnostic once */
var step = 0;
var currDslType = INCLUDE_VDSLWAN ? "vdsl" : "adsl";

var STATUS_INIT = 0;
var STATUS_PHY_LINK_CHECK = 1;
var STATUS_WAN_CONN_CHECK = 2;
var STATUS_NCSI_CHECK = 3;
var STATUS_DONE = 4;
var status = STATUS_INIT;
if(INCLUDE_USB_3G_DONGLE) {
var usb3gLinkCfg = {};
}
var internetDiagId = $.getAsync();
if(INCLUDE_LTEWAN) {
    var lteLinkCfgStk = "";
    var lteLinkCfg = {};
    var lteWanCfg = {};
    var lteIntfCfg = {};
}

function diagnosticInit() {
	var l3Forward = $.act(ACT_GET, L3_FORWARDING, null, null, ["__ifAliasName"]);
	var ipList = $.act(ACT_GL, WAN_IP_CONN, null, null, ["Name", "AddressingType"]);
	var pppList = $.act(ACT_GL, WAN_PPP_CONN, null, null, ["Name"]);
	var commonIntfList = $.act(ACT_GL, WAN_COMMON_INTF_CFG, null, null, ["WANAccessType"]);
	if (INCLUDE_ADSLWAN) {
	var dslIntfCfgList = INCLUDE_VDSLWAN ? $.act(ACT_GL, WAN_DSL_INTF_CFG, null, null, ["LinkEncapsulationUsed"]) : {};
	}
	var connStack = "";
	var found = false;
	if (INCLUDE_PPTP)
		var pptpList = $.act(ACT_GL, WAN_PPTP_CONN, null, null, ["Name"]);
	if (INCLUDE_L2TP)
		var l2tpList = $.act(ACT_GL, WAN_L2TP_CONN, null, null, ["Name"]);
	
	if (INCLUDE_WAN_MODE)
        var sysMode = $.act(ACT_GET, SYS_MODE, null, null, ["Mode"]);

    if (INCLUDE_USB_3G_DONGLE)
        var usb3gLinkCfgList = $.act(ACT_GL, WAN_USB_3G_LINK_CFG, null, null, ["Enable", "CardName"]);	
		
    if (INCLUDE_LTEWAN/* && $.sysMode == "LTE"*/)
        var lteLinkCfgList = $.act(ACT_GL, WAN_LTE_LINK_CFG, null, null, ["Enable", "NetworkType", "SimStatus", "SignalStrength", "connectStatus"]);

	if ($.exe())
		return false;
		
	$.each(ipList, function() {
		if (this.name == l3Forward.__ifAliasName) {
			wanConnStack = this.__stack;
			intfCfgStack = $.stkPop(wanConnStack, 2);
			wanType = /*(this.addressingType == "DHCP") ? "dhcp" : "staip";*/ "ip";
			found = true;			
			return false;
		}
	});
	$.each(pppList, function() {
		if (this.name == l3Forward.__ifAliasName) {
			wanConnStack = this.__stack;
			intfCfgStack = $.stkPop(wanConnStack, 2);
			wanType = "ppp";
			found = true;			
			return false;
		}
	});
	if (INCLUDE_PPTP && found == false) {
		$.each(pptpList, function() {
			if (this.name == l3Forward.__ifAliasName) {
				wanConnStack = this.__stack;
				intfCfgStack = $.stkPop(wanConnStack, 1);
				wanType = "pptp";
				found = true;
				return false;
			}
		});
	}
	if (INCLUDE_L2TP && found == false) {
		$.each(l2tpList, function() {
			if (this.name == l3Forward.__ifAliasName) {
				wanConnStack = this.__stack;
				intfCfgStack = $.stkPop(wanConnStack, 1);
				wanType = "l2tp";
				found = true;
				return false;
			}
		});
	}
	/* The bellow may be ugly if EPON or GPON is enabled */
	if (found == false) {
        if (INCLUDE_WAN_MODE) {
            if (sysMode.mode == "DSL")
                wanAccessType = "DSL";
            else if (sysMode.mode == "ETH")
                wanAccessType = "Ethernet";
            else if (INCLUDE_USB_3G_DONGLE && sysMode.mode == "USB_3G")
                wanAccessType = "USB_3G";
            else if (INCLUDE_LTEWAN && sysMode.mode == "LTE")
                wanAccessType = "LTE";
        }

        $.each(commonIntfList, function() {
            if (this.WANAccessType == wanAccessType) {
                intfCfgStack = this.__stack;
                return false;
            }
        });
    } else {
        $.each(commonIntfList, function() {
            if (this.__stack == intfCfgStack) {
                wanAccessType = this.WANAccessType;
                intfCfgStack = this.__stack;
                return false;
            }
        });
    }
	
	if (wanAccessType == "DSL") {
		if (INCLUDE_VDSLWAN) {
			$.each(dslIntfCfgList, function() {
				if (this.__stack == intfCfgStack) {
					if (this.linkEncapsulationUsed == "G.992.3_Annex_K_ATM")
						currDslType = "adsl";
					else if (this.linkEncapsulationUsed == "G.993.2_Annex_K_PTM")
						currDslType = "vdsl";
				}
			});
		}
	} else if (wanAccessType == "Ethernet") {
		intfCfgStack = $.stkPop(wanConnStack, 1);
		if (wanType == "l2tp" || wanType == "pptp"){
			intfCfgStack = wanConnStack;
		}
	} else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G") {
        $.each(usb3gLinkCfgList, function() {
            if (this.enable == 1 && $.stkPop(this.__stack, 1) == intfCfgStack) {
                usb3gLinkCfg = this;
                return false;
            }
        });
	} else if (INCLUDE_LTEWAN && wanAccessType == "LTE") {
		$.each(lteLinkCfgList, function() {
		    if ((this.enable == 1) && ($.stkPop(this.__stack, 1) == intfCfgStack)) {
		        lteLinkCfgStk = this.__stack;
		        return false;
		    }
		});
    }
	return true;
}
function insNewRow(item, status) {
	var disTbl = $("#display_table").get(0);
	var newRow = disTbl.insertRow(-1);
	var newCell = {};
	var loadSpan = "<span class='diag-loading-icon' style='background: url(../img/loading.gif); height: 20px; width: 20px; display: inline-block;'></span>"
	newRow.style.backgroundColor = "#F5F5F5";
	
	newCell = newRow.insertCell(-1);
	newCell.width = "20px";
	$.h(newCell, "");
	
	newCell = newRow.insertCell(-1);
	newCell.width = "300px";
	$.h(newCell, item);
	
	newCell = newRow.insertCell(-1);
	newCell.width = "200px";
	if (status == "waiting...")
		$(newCell).append(loadSpan);
	else
	$.h(newCell, status);
}
function disResult(result) {
	var disTbl = $("#display_table").get(0);
	var currRow = disTbl.rows[disTbl.rows.length - 1];
	var currCell = currRow.cells[currRow.cells.length - 1];
	
	$("span.diag-loading-icon").remove();
	$.h(currCell, result);
}
function doErr(errStr) {
	$("#p_note").removeClass("nd");
	$("#errNote").html(errStr);
}
function diagDone() {
	insNewRow(s_str.diag_end, "");
	$.unlock();
}
function doInternetDiag() {
	if (INCLUDE_ADSLWAN && wanAccessType == "DSL") {
	var dslIntfConfig = {};
	}
    var ethIntfConfig = {};
	var wanConn = {};
	var phyLinkStatus = "";
	var diagTool = {};	
	var failInfo = "";
	
	if (!$.checkAsync(internetDiagId)) 
    	return;
		
	switch (step) {
		/* physical link status check */
		case 0:
			var linkDiagFunc = function(err) {
				if (err) {
					$.alert(err);
					return ;
				}
				if (INCLUDE_LTEWAN && wanAccessType == "LTE") {
					if (lteLinkCfg.simStatus == 3 || lteLinkCfg.simStatus == 5) {
						disResult(strPass);
						step++;
                                    doInternetDiag();
					} else {
						if (lteLinkCfg.simStatus == 0) {
							failInfo = s_str.lteNoSimOrErr;
						} else if (lteLinkCfg.simStatus == 1) {
							failInfo = s_str.lteNoSim;
						} else if (lteLinkCfg.simStatus == 2) {
							failInfo = s_str.lteSimErr;
						} else if (lteLinkCfg.simStatus == 4) {
							failInfo = s_str.ltePinLocked;
						} else if (lteLinkCfg.simStatus == 6) {
							failInfo = s_str.ltePukLocked;
						} else if (lteLinkCfg.simStatus == 7) {
							failInfo = s_str.lteSimLockedForever;
						} else {
							failInfo = s_str.lteOtherSimErr;
						}
						disResult(strFail);
						doErr(failInfo);
						diagDone();
					}
				} else { /* LTE else branch */
				if (wanAccessType == "DSL")
					phyLinkStatus = dslIntfConfig.status;
				else if (wanAccessType == "Ethernet")
					phyLinkStatus = ethIntfConfig.ethernetLinkStatus;
				else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G") 
					phyLinkStatus = "";
					
				if (phyLinkStatus == "Up") {
					disResult(strPass);
					step++;					
					doInternetDiag();
				} else {
					if (wanAccessType == "DSL") {
						if (phyLinkStatus == "NoSignal") {							
							disResult(strFail);
							doErr(s_str.dslSyncFail);
							diagDone();
						}
						else {
							setTimeout(doInternetDiag, 1000);
						}
					} else if (wanAccessType == "Ethernet") {
						disResult(strFail);
						doErr(s_str.ethNoLink);
						diagDone();
					} else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G") {
						if (usb3gLinkCfg.cardName == "Unplugged" || usb3gLinkCfg.cardName == "Unknown") {
							disResult(strFail);
							doErr(s_str.usb3gUnplugged);
							diagDone();
						} else if (usb3gLinkCfg.cardName == "Identifying...") {
							setTimeout(doInternetDiag, 1000);
						} else {
							disResult(strPass);
							step++;					
							doInternetDiag();
						}
					}
				} 
	            } /* LTE else branch ended */
			};
			if (status == STATUS_INIT) {
				if (wanAccessType == "DSL")
					insNewRow(s_str.diag_dsl, "waiting...");
				else if (wanAccessType == "Ethernet")
					insNewRow(s_str.diag_eth, "waiting...");
				else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G")
					insNewRow("", "waiting...");
				else if (INCLUDE_LTEWAN && wanAccessType == "LTE")
					insNewRow(s_str.diag_lte, "waiting...");
				status = STATUS_PHY_LINK_CHECK;
			}
			if (wanAccessType == "DSL") {
				dslIntfConfig = $.act(ACT_GET, WAN_DSL_INTF_CFG, intfCfgStack, null, ["Status"]);
				$.exe(linkDiagFunc);
			}
			else if (wanAccessType == "Ethernet") {
				ethIntfConfig = $.act(ACT_GET, WAN_ETH_LINK_CFG, intfCfgStack, null, ["EthernetLinkStatus"]);
				$.exe(linkDiagFunc);
			} else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G") {
                usb3gLinkCfg = $.act(ACT_GET, WAN_USB_3G_LINK_CFG, usb3gLinkCfg.__stack, null, ["CardName"]);
                $.exe(linkDiagFunc);
            } else if (INCLUDE_LTEWAN && wanAccessType == "LTE") {
				lteLinkCfg = $.act(ACT_GET, WAN_LTE_LINK_CFG, lteLinkCfgStk, null, ["SimStatus"]);
				$.exe(linkDiagFunc);
			}
			break;
		case 1:
			if (status == STATUS_PHY_LINK_CHECK) {
				insNewRow(s_str.diag_wan, "waiting...");
				status = STATUS_WAN_CONN_CHECK;
			}
			
			if (INCLUDE_LTEWAN && wanAccessType == "LTE") {
            	lteLinkCfg = $.act(ACT_GET, WAN_LTE_LINK_CFG, lteLinkCfgStk, null, ["networkType", "roamingStatus", "connectStatus", "signalStrength"]);
            	lteWanCfg = $.act(ACT_GET, LTE_WAN_CFG, lteLinkCfgStk, null, ["dataSwitchStatus", "networkPreferredMode", "roamingEnabled"]);
     			lteIntfCfg = $.act(ACT_GET, WAN_LTE_INTF_CFG, intfCfgStack, null, ["dataLimit"]);
			    $.exe(function(err) {
                	if (err) {
                    	$.alert(err);
                    	return;
                	}
                	if (lteLinkCfg.connectStatus == 2 || lteLinkCfg.connectStatus == 3) {
                		setTimeout(doInternetDiag, 1000);
                	} else if (lteLinkCfg.connectStatus == 4) {
						disResult(strPass);
						step++;
						doInternetDiag();                		
                	} else {
                		if (lteWanCfg.dataSwitchStatus != 1) {
							failInfo = s_str.lteDataSwtDis;
						} else if (lteIntfCfg.dataLimit == 2) {
							failInfo = s_str.lteDataOverUsed;
						} else if (lteIntfCfg.roamingStatus == 1 && lteIntfCfg.roamingEnabled != 1) {
							failInfo = s_str.lteRoamingDis;
						} else if (lteLinkCfg.signalStrength == 0) {
							failInfo = s_str.lteNoSignalStrength;
						} else if (lteLinkCfg.networkType == 0 /* && lteWanCfg.networkPreferredMode != 3 */) {
							failInfo = s_str.lteModeErr;
						} else {
							failInfo = s_str.lteOtherFail;
						}
               			disResult(strFail);
						diagDone();
						doErr(failInfo); 		
                	}              	
                });
			} else { /* LTE else branch */
			if (wanType == "ppp")
				wanConn = $.act(ACT_GET, WAN_PPP_CONN, wanConnStack, null, ["LastConnectionError", "ConnectionStatus"]);
			else if (wanType == "ip")
				wanConn = $.act(ACT_GET, WAN_IP_CONN, wanConnStack, null, ["ConnectionStatus"]);
			else if (INCLUDE_PPTP && wanType == "pptp")
				wanConn = $.act(ACT_GET, WAN_PPTP_CONN, wanConnStack, null, ["ConnectionStatus"]);
			else if (INCLUDE_PPTP && wanType == "l2tp")
				wanConn = $.act(ACT_GET, WAN_L2TP_CONN, wanConnStack, null, ["ConnectionStatus"]);
			else {
				disResult(strFail);
				diagDone();
				doErr(s_str.noAvaiIntf);
				return ;
			}
			$.exe(function(err) {
				if (err) {
					$.alert(err);
					return ;
				}
				if (wanConn.connectionStatus == "Connected") {
					disResult(strPass);
					step++;
					doInternetDiag();
				}
				else if (wanConn.connectionStatus == "Connecting") {
					setTimeout(doInternetDiag, 1000);
				}
				else {
					disResult(strFail);
					diagDone();
					if (wanType == "ppp") {
						if (wanConn.lastConnectionError == "ERROR_ISP_TIME_OUT") {
							if (wanAccessType == "DSL") {
								if (currDslType == "adsl")
									doErr(s_str.adslPppTimeout);
								else if (currDslType == "vdsl")
									doErr(s_str.vdslPppTimeout);
							} else if (wanAccessType == "Ethernet")
                                doErr(s_str.ethPppTimeout);
                            else {
                                /* for 3G */
                            }
						} else if (wanConn.lastConnectionError == "ERROR_AUTHENTICATION_FAILURE") {
							if (wanAccessType == "DSL" || wanAccessType == "Ethernet")
                                doErr(s_str.pppAuthFail);
                            else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G")
                                doErr(s_str.usb3gAuthFail);							
						} else {
							if (wanAccessType == "DSL" || wanAccessType == "Ethernet")
                                doErr(s_str.pppOtherFail);
                            else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G")
                                doErr(s_str.usb3gOtherFail);
						}
					} else {
						if (INCLUDE_USB_3G_DONGLE && wanConn.X_TP_TransportType == "DHCP4G")
                            doErr(s_str.usb3gOtherFail);
                        else {
							if (wanAccessType == "DSL") {
								if (currDslType == "adsl")
									doErr(s_str.adslPppTimeout);
								else if (currDslType == "vdsl")
									doErr(s_str.vdslPppTimeout);
                            } else if (wanAccessType == "Ethernet")
                                doErr(s_str.ethPppTimeout);
						} 
					}					
				}
			});
			} /* LTE else branch ended */
			break;
		case 2:
			if (status == STATUS_WAN_CONN_CHECK) {
				insNewRow(s_str.diag_ncsi, "waiting...");
				status = STATUS_NCSI_CHECK;
			}
			diagTool = $.act(ACT_GET, DIAG_TOOL, null, null, ["LastResult"]);
			$.exe(function(err) {
				if (err) {
					$.alert(err);
					return ;
				}
				if (diagTool.lastResult == 3) {
					setTimeout(doInternetDiag, 1000);
				}
				else {
					if (bStart == true) {
						if (diagTool.lastResult == 1) {
							disResult(strPass);							
						}
						else {
							disResult(strFail);
                                                        if(INCLUDE_LTEWAN)
                                                        {
                                                            doErr(s_str.lteOtherFail);
                                                        }
                                                        else
                                                        {
                                                            doErr(s_str.dnsDiagFail);
                                                        }							
						}
						diagDone();
					}
					else {
						bStart = true;
						$.act(ACT_OP, ACT_OP_DIAG_DNSDIAG, diagTool.__stack);
						$.exe(function(err) {
							if (err) {
								$.alert(err);
								return ;
							}
							setTimeout(doInternetDiag, 1000);
						});
					}
				}
			});
			break;
	}
}
function doStart() {
	var disTbl = $("#display_table").get(0);
	while (disTbl.rows.length > 0)
		disTbl.deleteRow(-1);
	step = 0;
	status = STATUS_INIT;
	bStart = false;
	$("#p_note").addClass("nd");
	$.lock();
	doInternetDiag();
}
</script>
<h3 id="et">Diagnostic Tools</h3>
<div class="content-container">
	<form class="pure-form pure-form-aligned">
		<span id="t_info">The Internet connection status of this device can be tested on this page.</span>
		<button type="submit" class="blue T_start" id="GetTime">Start</button>
		<p class="br"></p>
		<div class="M tbody bdr ts" style="height: 320px; overflow-y: scroll; background-color: #F5F5F5;">
			<table id="display_table" cellspacing="0" cellpadding="0" class="tbody M"></table>
		</div>
	</form>
	<p id="p_note" class="nd"><span id="t_note" style="vertical-align:baseline;color:#4d4d4d">Note: </span><span id="errNote" style="vertical-align:baseline;"></span></p>
</div>
<script language="javascript" type="text/javascript">
var disTbl = $("#display_table").get(0);
var newRow = disTbl.insertRow(-1);
var newCell = {};

diagnosticInit();
if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G")
	$("#GetTime").prop("disabled", true);
$("#GetTime").click(doStart);
</script>