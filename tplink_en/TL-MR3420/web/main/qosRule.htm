<div id="device-mask" class="mask"></div>
<h3 class="widget-title msg-title"><span class="msg-title-container T" id="t_qosRule">Qos Rule</span></h3>
<form class="pure-form pure-form-aligned">
    <div id="ruleType"><b class="T T_type">Type:</b>
        <input type="radio" name="radioNameRuleType" id="radioByDevice" checked="true">
        <label class="T" id="t_byDevice">By Device</label>
        <input type="radio" name="radioNameRuleType" id="radioByApp">
        <label class="T" id="t_byApp">By App</label>
    </div>
    <div id="ruleByDevice" class="">
        <div>
            <b id="t_devname" class="ru-m">Device Name:</b>
            <input type="text" id="deviceName" maxlength="32" required/>
            <button type="submit" class="blue msg-inline-btn" class="T_scan" id="scan">scan</button>
        </div>
        <div>
            <b class="ru-m T T_macaddr">Mac Address:</b>
            <input type="text" class="tp-input-text mac-address" maxlength="17" id="macAddress" />
        </div>
    </div>
    <div id="ruleByApp" class="nd">
        <h4 class="type-title" id="t_app">app</h4>
        <div id="div_app" class="app-info-cnt">
            <div class="widget-wrap-outer">
                <div class="checkbox-group-wrap">
                    <ul class="checkbox-group-list-wrap" id="groupList0">
                    </ul>
                    <ul class="checkbox-group-list-wrap" id="groupList1">
                    </ul>
                    <ul class="checkbox-group-list-wrap" id="groupList2">
                    </ul>
<!--                     <ul class="checkbox-group-list-wrap" id="groupList3">
                    </ul> -->
                </div>
            </div>
        </div>
        <h4 class="type-title" id="title_custom"><span id="t_custom">custom app</span><span class="qos-toggle-icon"></span></h4>
        <div id="div_custom" class="nd content-container">
            <form class="pure-form pure-form-aligned">
                <div class="inline">
                    <b class="m" id="t_name">name</b>
                    <input type="text" class="xl" id="cusApp_name" maxlength="32" />
                </div>
                <b class="m T_proto">protocol</b>
                <select id="cusApp_protocol" class="xl">
                    <option value="all" class="T_all">all</option>
                    <option value="tcp" id="t_tcp">tcp</option>
                    <option value="udp" id="t_udp">udp</option>
                </select>
                <div class="inline">
                    <b class="m T_c_port">port</b>
                    <input type="text" class="xl" id="cusApp_Port" />
                    <div class="textbox-tips">
                        <span id="t_port_range"></span>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="inline-btn-right">
        <button type="submit" class="green T_cancel" id="editCancel">Cancel</button>
        <button type="submit" class="green T_save" id="editOk">Save</button>
    </div>
</form>
<div>
    <form class="pure-form pure-form-aligned">
        <div id="accessDevList" class="nd">
            <div id="closeDeviceList" class="table-op">
                <div class="table-btn">
                    <span class="close-icon table-icon"></span>
                </div>
            </div>

            <table id="tableAccessDevicesList">
                <thead></thead>
                <tbody id="bodyAccessDevicesList">
                </tbody>
            </table>
        </div>
    </form>
</div>
<script language="javascript" type="text/javascript">
(function() {
    'use strict';
    var appListArray;
    var TYPE_DEVICE = 11;
    var TYPE_SYSTEM = 30;
    var TYPE_CUSTOM_TCP = 21;
    var TYPE_CUSTOM_UDP = 22;
    var TYPE_CUSTOM_ALL = 23;
    var CLASS_HIGH = 4;
    var CLASS_MIDDLE = 3;
    var CLASS_LOW = 2;

    function init() {

        initDeviceList();
        initAppList();
    }

    function initDeviceList() {
        //device list
        var AccessDevicesListHeadArray = [{
            "text": table_str.id,
            "width": "10%"
        }, {
            "text": table_str.devname,
            "width": "20%"
        }, {
            "text": table_str.ip,
            "width": "20%"
        }, {
            "text": table_str.mac,
            "width": "20%"
        }, {
            "text": table_str.operation,
            "width": "20%"
        }];
        $.initTableHead($("#tableAccessDevicesList"), AccessDevicesListHeadArray);
        $("#tableAccessDevicesList").tpTable(initAccessDevicesListTable);

        $.setFixedCentral($("#accessDevList"));
    }

    function initAccessDevicesListTable() {

        var array = [];
        var index = 1;
        var deviceOnline = $.act(ACT_GL, LAN_HOST_ENTRY, null, null);

        $.exe(function(err) {
            if (err) return;

            $.each(deviceOnline, function() {
                if (this.active != 1)
                    return;

                array.push([{
                    "text": index,
                    "width": "5%"
                }, {
                    "text": this.hostName,
                    "width": "10%"
                }, {
                    "text": this.IPAddress,
                    "width": "10%"
                }, {
                    "text": this.MACAddress.replace(/\:/g, '-'),
                    "width": "15%"
                }, {
                    "text": "<span class='table-grid-icon add-icon'></span>",
                    "width": "15%"
                }]);
                index++
            });

            $.initTableBody($("#tableAccessDevicesList"), array);
            $.tablePages($("#tableAccessDevicesList"), 8);

            $("span.add-icon").click(function() {
                var hostName = $(this).parents("tr").find("td:eq(1)").text().match(/^.{1,32}/);
                var macAddress = $(this).parents("tr").find("td:eq(3)").text();

                $("#deviceName").val(hostName);
                $("#macAddress").tpAddress('val', macAddress);
                $("#accessDevList").fadeOut(20, function() {
                    $("#accessDevList").removeClass("on-mask msg-container").addClass("nd");
                });

                $("#device-mask").hide();
            });
        });
    }

    function initAppList() {
        appListArray = $.act(ACT_GL, IQOS_CONF, null, null);
        if (!$.exe()) {
            var numOfColumn = ($("#div_app").find("ul.checkbox-group-list-wrap")).length;
            var columnLength = Math.ceil(appListArray.length/numOfColumn);
            var i = 0;
            $.each(appListArray, function() {
                var column = Math.floor(i/columnLength);
                var newLi = $("<li><div class=\"app-info-name\">"
                        + "<input type=\"checkbox\" id=\"appList_" + i + "\" /><label>" + this.appName + "</label>"
                        + "</div></li>").appendTo($("#groupList" + column));
                i++;
            });
        }
    }

    $("#radioByDevice").click(function() {
        $("#ruleByDevice").removeClass("nd");
        $("#ruleByApp").addClass("nd");
        $("#ruleByPort").addClass("nd");
    });
    $("#radioByApp").click(function() {
        $("#ruleByDevice").addClass("nd");
        $("#ruleByApp").removeClass("nd");
        $("#ruleByPort").addClass("nd");
    });
    $("#radioByPort").click(function() {
        $("#ruleByDevice").addClass("nd");
        $("#ruleByApp").addClass("nd");
        $("#ruleByPort").removeClass("nd");
    });


//    $(".qos-list-p").on("click", function() {
//        $(this).toggleClass("selected");
//        if ($(this).hasClass("selected")) {
//            $(this).next(".qos-item-detail").first().removeClass("hidden");
//        } else {
//            $(this).next(".qos-item-detail").first().addClass("hidden");
//        }
//    });

    $("#scan").on("click", function() {
        $("#accessDevList").fadeIn(20, function() {
            $("#accessDevList").removeClass("nd").addClass("on-mask msg-container");
        });

        $("#device-mask").show();
    });

    $("#closeDeviceList").click(function() {
        $("#accessDevList").fadeOut(20, function() {
            $("#accessDevList").removeClass("on-mask msg-container").addClass("nd");
        });

        $("#device-mask").hide();
    });

    $('#title_custom').on('click', function() {
        $(this).toggleClass("selected");
        if ($(this).hasClass("selected")) {
            $('#div_custom').removeClass('nd');
        } else {
            $('#div_custom').addClass('nd');
        }
    });

    $("#editCancel").on("click", function() {
        $("#complex-msg-container").tpMsg("hide");
    });

    function isPortStr(str) {
        if (str != '') {
            var ports = str.split("-");
            var port0 = ports[0];
            if (port0 == "" || !$.isnum(port0) || (parseInt(port0, 10) == 0) || (parseInt(port0, 10) > 65535)) {
                return false;
            } else {
                if (ports.length == 1) {
                    return [parseInt(port0, 10), parseInt(port0, 10)];
                }
                if (ports.length == 2) {
                    var port1 = ports[1];
                    if (port1 == "" || !$.isnum(port1) || (parseInt(port1, 10) == 0) || (parseInt(port1, 10) > 65535)) {
                        return false;
                    } else {
                        if (parseInt(port1, 10) > parseInt(port0, 10)) {
                            return [parseInt(port0, 10), parseInt(port1, 10)];
                        } else {
                            return 'order';
                        }
                    }
                }
            }
        }
        return false;
    }
    function selectObj(element) {
        if (element) {
            element.focus();
            element.select();
        }
    }
//添加一个规则
    $("#editOk").on("click", function() {
        var tmpRule = {};
        //添加一个规则by device
        if ($("#radioByDevice").prop("checked") == true) {
            if (!($.isname($("#deviceName").val()))) {
                $.alert(ERR_FW_ENTRYNAME_INVAD);
                $("#deviceName").focus().select();
                return false;
            }
            tmpRule.macAddress = $("#macAddress").tpAddress("val");
            if ((tmpRule.macAddress == "") || ($.mac(tmpRule.macAddress, true))) {
                $.alert(ERR_MAC_FORMAT);
                $("#macAddress").tpAddress("focus");
                return false;
            }
            tmpRule.appName = $("#deviceName").prop("value");
            tmpRule["class"] = $.qosVar.newRuleClass;
            tmpRule.type = TYPE_DEVICE;

            $.act(ACT_ADD, IQOS_RULE, null, null, tmpRule);
            $.addLoading($(this));
            if (!$.exe()) {
                $("#complex-msg-container").tpMsg("hide");
                $.removeLoading();
                $.reload();
            }
        } else if ($("#radioByApp").prop("checked") == true) {
            for (var i=0;i<appListArray.length;i++) {
                if ($("#appList_" + i).prop("data-checked") == true) {
                    tmpRule.appName = appListArray[i].appName;
                    tmpRule["class"] = $.qosVar.newRuleClass;
                    tmpRule.type = TYPE_SYSTEM;
                    tmpRule.confId = appListArray[i].id;
                    $.act(ACT_ADD, IQOS_RULE, null, null, tmpRule);
                }
            }
            //设计为用户自定义板块打开时表单必填
            if (!$("#div_custom").hasClass("nd")) {
                tmpRule = {};

                if (!$.isname($("#cusApp_name").val())) {
                    $.alert(ERR_FW_ENTRYNAME_INVAD);
                    selectObj($("#cusApp_name"));
                    return false;
                }
                /*
                 if ($("#cusApp_Port").val() == "" || !$.isnum($("#cusApp_Port").val()) || (parseInt($('#cusApp_Port').val(), 10) == 0) || (parseInt($('#cusApp_Port').val(), 10) > 65535)) {
                 $.alert(ERR_PORT_NUM_INVAD);
                 selectObj($("#cusApp_Port"));
                 return false;
                 }*/

                //check port
                var portValue = isPortStr($("#cusApp_Port").val());
                if (portValue == false) {
                    $.alert(CMM_IQOS_RULE_PORT_FORMAT_ERR);
                    selectObj($("#cusApp_Port"));
                    return false;
                } else if (portValue == 'order') {
                    $.alert(ERR_PORT_ORDER_INVAD);
                    selectObj($("#cusApp_Port"));
                    return false;
                }

                tmpRule.appName = $("#cusApp_name").prop("value");
                var cus_proto = $("#cusApp_protocol").data("value");
                if (cus_proto == "tcp") {
                    tmpRule.type = TYPE_CUSTOM_TCP;
                } else if (cus_proto == "udp") {
                    tmpRule.type = TYPE_CUSTOM_UDP;
                } else if (cus_proto == "all") {
                    tmpRule.type = TYPE_CUSTOM_ALL;
                }
                tmpRule.srcPort = portValue[0];
                tmpRule.endPort = portValue[1];
                tmpRule.class = $.qosVar.newRuleClass;
                $.act(ACT_ADD, IQOS_RULE, null, null, tmpRule);
            }
            $.addLoading($(this));
            if (!$.exe()) {
                $("#complex-msg-container").tpMsg("hide");
                $.removeLoading();
                $.reload();
            }

        }
    });
    $.tpInit(init);
})();
</script>
