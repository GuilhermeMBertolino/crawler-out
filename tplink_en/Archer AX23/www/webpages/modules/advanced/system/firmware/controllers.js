!function(u){u.su.moduleManager.define("firmware",{models:["firmwareSetModel","onlineUpgradeModel","statusAll","autoUpgradeModel","timeSettings"],stores:["upgradeLogStore","autoUpdateTimeStore"],deps:["main","quickSetup"],services:["ajax","language","vtype","time","moduleManager","device"],views:["firmwareView","firmwareQsView"],listeners:{"ev_on_launch":function(e,r,t,o,a,n,i){if(i.device.getConfig().supportAutoUpdate){i.time.on("on_time_change",r.onTimeChange);for(var s=[],c=0;c<11;c++)s.push({name:c+":00AM to "+(c+2)+":00AM",value:c});s.push({name:"11:00AM to 1:00PM",value:11});for(c=0;c<11;c++)s.push({name:c+":00PM to "+(c+2)+":00PM",value:c+12});s.push({name:"11:00PM to 1:00AM",value:23}),a.autoUpdateTimeStore.loadData(s),o.autoUpgradeModel.load(),t.firmwareView.autoUpdateWrap.hide()}o.timeSettings.load({success:function(e){r.timeType=e.type}}),t.firmwareView.upgradeOption.hide(),o.firmwareSetModel.load({success:function(){var e=o.firmwareSetModel.getData(),e=(r.rebootTime=parseInt(1e3*e.totalTime||r.rebootTime,10),e.hardwareVersion);i.device.getConfig().supportFirmwareInfoReplace&&(e=e.replace("v1.0","v1.0/v1.20")),t.firmwareView.hardwareVersion.setValue(e)}}),o.onlineUpgradeModel.load(),o.statusAll.load({success:function(){var e=o.statusAll.getData(),r=e.wireless2gEnable,a=e.wireless5gEnable,e=e.wireless5g2Enable;"on"===r?t.firmwareView.reconnect2g.show():t.firmwareView.reconnect2g.hide(),"on"===a?t.firmwareView.reconnect5g1.show():t.firmwareView.reconnect5g1.hide(),"on"===e?t.firmwareView.reconnect5g2.show():t.firmwareView.reconnect5g2.hide()}}),i.ajax.request({proxy:"checkWireTypeProxy",success:function(e){r.wireType=e.wire_type}}),r.setMode(null),"ap"!==i.device.getCurrentMode()&&i.device.getConfig().supportAutoUpdate||t.firmwareView.autoUpdateField.hide()},"ev_before_destroy":function(){this.beforeDestroy()}},init:function(o,n,a,t,e,i){this.configViews({}),this.listen({"models.onlineUpgradeModel":{"ev_loaded":function(){var e=a.onlineUpgradeModel.getData();n.firmwareView.checkUpgradesBtn.loading(!1),n.firmwareView.checkUpgradesBtn.hide(),e.latestFlag?(n.firmwareView.upgradeOption.hide(),n.firmwareView.checkUpgradesBtn.show(),n.firmwareView.checkUpgradesBtn.setTips(u.su.CHAR.FIRMWARE.FIRMWARE_UPTO_DATE)):(n.firmwareView.checkUpgradesBtn.hide(),n.firmwareView.checkUpgradesBtn.setTips(),n.firmwareView.upgradeOption.show(),i.ajax.request({proxy:"checkUpgradeNumberProxy",success:function(e){parseInt(e.updateNumber,10)}}))}},"models.onlineUpgradeModel.detail":{"ev_value_change":function(e,r){r=(r=r.replace(/\\t/g," ")).replace(/\\'/g,"'");t.upgradeLogStore.loadData(r.split("\\n"),!0)}},"models.autoUpgradeModel.enable":{"ev_value_change":function(e,r){"on"==r?n.firmwareView.autoUpdateWrap.show():n.firmwareView.autoUpdateWrap.hide()}}}),this.control({"#firmware-check-upgrades-btn":{"ev_button_click":function(){o.startCheckUpgrade()}},"#firmware-whats-new":{"ev_button_click":function(){t.upgradeLogStore.toggle()}},"#online-upgrade-btn":{"ev_button_click":function(){o.modeFlag="online",n.firmwareView.confirmUpgrade.show()}},"#manual-upgrade-file":{"ev_file_change":function(e,r){var r=this.checkFileName(r,"bin"),a=n.firmwareView.firmwareFile;!0===r?a.setNormal():a.setError(r)}},"#local-upgrade-btn":{"ev_button_click":function(){o.modeFlag="manual";var e=n.firmwareView.firmwareFile,r=e.getFileName(),r=this.checkFileName(r,"bin");!0===r?(e.setNormal(),n.firmwareView.confirmUpgrade.show()):e.setError(r)}},"#firmware-upgrade-msg":{"ev_msg_ok":function(){"online"===o.modeFlag?o.startOnlineUpgrade():"manual"===o.modeFlag&&o.startLocalUpgrade()}},"#qs-upgrade-retry-btn":{"ev_button_click":function(){o.startOnlineUpgrade()}},".qs-upgrade-skip-btn":{"ev_button_click":function(){o.goToSummary()}},"#reconnect-msg":{"ev_msg_ok":function(e,r){var a=u.Deferred(),t=n.firmwareView.reconnectMsg;r.preventDefault(),t.disableButton("ok"),o.checkRouter({success:function(){a.resolve()},fail:function(){a.resolve()},error:function(){a.reject()}}),a.then(function(){t.close(),t.enableButton("ok"),localStorage&&localStorage.setItem("token",""),window.location.href="/"},function(){t.enableButton("ok")})}},"#firmware-auto-update":{"ev_view_change":function(e,r){"on"!=r.value||"auto"==o.timeType?a.autoUpgradeModel.submit():n.firmwareView.autoUpdateCheckMsg.show()}},"#auto-update-settings":{"ev_button_click":function(){i.moduleManager.get("navigatorController").goTo("timeSettings")}},"#auto-update-check-msg":{"ev_msg_ok":function(e,r){i.moduleManager.get("navigatorController").goTo("timeSettings")},"ev_msg_no":function(e,r){a.autoUpgradeModel.enable.setValue("off")}}})}},function(o,n,i,e,s,c){var a=0,t=null;return{wireType:"",timeType:"",modeFlag:"",rebootTime:12e4,queryLocalInterval:!1,queryLocalIntervalMax:!1,queryOnlineInterval:!1,checkDownloadInterval:!1,MODE:{"QUICK_SETUP":"qs","NETWORK_MAP":"networkMap"},setMode:function(e){t=e},getMode:function(){return t},setQsState:function(e){s.quickSetup.upgradeState=e},startCheckUpgrade:function(){n.firmwareView.checkUpgradesBtn.setTips(),n.firmwareView.checkUpgradesBtn.setNormal(),n.firmwareView.checkUpgradesBtn.loading(!0);var e=u.Deferred(),r=u.Deferred();u.Deferred();o.detectInternet(function(){e.resolve()},function(){o.showCheckError(u.su.CHAR.ERROR["10000139"])},function(){o.showCheckError(u.su.CHAR.ERROR["10000139"])}),u.when(e).then(function(){o.detectDevice(function(){r.resolve()},function(){o.showUpgradeError()},function(){o.showUpgradeError()})}),u.when(r).then(function(){i.onlineUpgradeModel.load({fail:function(){o.showCheckError(u.su.CHAR.ERROR["10000193"])},error:function(){o.showCheckError(u.su.CHAR.ERROR["10000193"])}})})},goToSummary:function(){s.quickSetup.submitQsWirelssData()},startOnlineUpgrade:function(){var r,a=o.getMode(),e=(a!==o.MODE.QUICK_SETUP&&s.main.showProBar(u.su.CHAR.FIRMWARE.DOWNLOADING,u.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),u.Deferred()),t=u.Deferred();u(".qs-download-fail-icon").removeClass("upgrade"),n.firmwareQsView.qsFwUpgradeProgress.show(),n.firmwareQsView.qsFwUpgradeFail.hide(),n.firmwareQsView.qsFailNote.setText(u.su.CHAR.FIRMWARE.DOWNLOAD_FAIL),n.firmwareQsView.qsUpgradeRoad.setText(u.su.CHAR.FIRMWARE.TRY_AGAIN),n.firmwareQsView.qsUpgradeDownloadBtns.show(),n.firmwareQsView.qsUpgradeNextBtn.hide(),a===o.MODE.QUICK_SETUP?(errorHandler=this.qsErrorHandler.bind(this),r=this.qsErrorHandler.bind(this)):a===o.MODE.NETWORK_MAP?(errorHandler=s.main.showError,r=s.main.showError,u.su.moduleManager.get("networkMap").beforeDestroy()):(errorHandler=o.showCheckError,r=o.showOnlineUpgradeError),o.detectInternet(function(){e.resolve()},function(){s.main.hideProBar(),errorHandler(u.su.CHAR.ERROR["10000139"])},function(){s.main.hideProBar(),errorHandler(u.su.CHAR.ERROR["10000139"])}),u.when(e).then(function(){o.detectDevice(function(){t.resolve()},function(){s.main.hideProBar(),errorHandler(u.su.CHAR.ERROR["10000139"])},function(){s.main.hideProBar(),errorHandler(u.su.CHAR.ERROR["10000139"])})}),u.when(t).then(function(){i.onlineUpgradeModel.getProxy().upgrade({success:function(e){a===o.MODE.QUICK_SETUP&&o.setUpgradedValue(!0),o.detectDownloadStatus()},fail:function(e){r(u.su.CHAR.ERROR["10000194"])},error:function(){r(u.su.CHAR.ERROR["10000194"])}})})},qsErrorHandler:function(){this.setQsState("upgradeFailed"),n.firmwareQsView.qsFwUpgradeProgress.hide(),n.firmwareQsView.qsFwUpgradeFail.show()},startLocalUpgrade:function(){n.firmwareView.proBar.reset(),n.firmwareView.proBarTitle.setText(u.su.CHAR.FIRMWARE.UPLOADING),n.firmwareView.proBarTips.setText(u.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),n.firmwareView.confirmUpgrade.hide(),n.firmwareView.progressbarWrap.show(),c.ajax.upload({proxy:"uploadFirmwareProxy",fileId:"manual-upgrade-file",timeout:72e4,success:function(e){n.firmwareView.confirmUpgrade.hide(),n.firmwareView.proBar.setValue(0),n.firmwareView.proBarTitle.setText(u.su.CHAR.FIRMWARE.UPGRADING),n.firmwareView.proBar.animate({percentageStart:0,percentageEnd:100,duration:1e3*i.firmwareSetModel.upgradetime.getValue(),callback:function(){n.firmwareView.progressbarWrap.hide(),localStorage&&localStorage.setItem("token",""),o.getMode()==o.MODE.NETWORK_MAP&&localStorage.setItem("upgradeSuccess","1"),"wired"==o.wireType?window.location.href="/":n.firmwareView.reconnectMsg.show()}})},fail:function(e){n.firmwareView.progressbarWrap.hide(),o.showUpgradeFailedMsg("err_form")},error:function(){n.firmwareView.progressbarWrap.hide(),o.showUpgradeFailedMsg("err_form")}})},detectInternet:function(r,a,t){c.ajax.request({proxy:"checkInternetProxy",success:function(e){r&&r(e)},fail:function(e){a&&a(e)},error:function(e){t&&t(e)}})},detectDevice:function(r,a,t){c.ajax.request({proxy:"checkDeviceProxy",success:function(e){r&&r(e)},fail:function(e){a&&a(e)},error:function(e){t&&t(e)}})},detectDownloadStatus:function(){var r=this.getMode();n.firmwareView.confirmUpgrade.hide(),clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=setInterval(function(){c.ajax.request({proxy:"checkDownloadStatusProxy",success:function(e){a=0;e=parseInt(e.percent,10);r===o.MODE.QUICK_SETUP?n.firmwareQsView.qsFwUpgradeBar.setValue(e):s.main.setProBarValue(e),100===e&&(clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,o.detectOnlineUpgradeStatus())},fail:function(e){if(15===++a){if(a=0,clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,s.main.hideProBar(),t===o.MODE.QUICK_SETUP)return o.setUpgradedValue(!1),void o.qsErrorHandler();var e=e.errorcode;e&&(e=e.toString().replace(/^-/,"E"),s.main.setUpgradeRetryContent(u.su.CHAR.ERROR[e])),s.main.setUpgradeRetryContent(u.su.CHAR.ERROR["10000191"]),s.main.showUpgradeRetry()}},error:function(){if(15===++a){if(a=0,clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,s.main.hideProBar(),t===o.MODE.QUICK_SETUP)return o.setUpgradedValue(!1),void o.qsErrorHandler();s.main.setUpgradeRetryContent(u.su.CHAR.ERROR["10000191"]),s.main.showUpgradeRetry()}}})},1e3)},detectOnlineUpgradeStatus:function(){u(".qs-download-fail-icon").addClass("upgrade"),n.firmwareQsView.qsFailNote.setText(u.su.CHAR.FIRMWARE.UPGRADE_FAIL_NOTE),n.firmwareQsView.qsUpgradeRoad.setText(u.su.CHAR.FIRMWARE.UPGRADE_FAIL_ROAD),n.firmwareQsView.qsUpgradeDownloadBtns.hide(),n.firmwareQsView.qsUpgradeNextBtn.show();var e=o.getMode();e!==o.MODE.QUICK_SETUP&&s.main.showProBar(u.su.CHAR.FIRMWARE.UPGRADING,u.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),n.firmwareQsView.qsFwUpgradeBar.reset(),n.firmwareQsView.qsFwUpgradeBar.setText(u.su.CHAR.FIRMWARE.UPGRADING),e===o.MODE.QUICK_SETUP?s.quickSetup.submitQsWirelssData({success:function(){n.firmwareQsView.qsFwUpgradeBar.animate({percentageStart:0,percentageEnd:100,duration:1e3*i.firmwareSetModel.upgradetime.getValue(),callback:function(){localStorage&&localStorage.setItem("token",""),s.quickSetup.goTo("qsSummary")}})}}):s.main.setProBarAnimate(i.firmwareSetModel.upgradetime.getValue(),function(){s.main.hideProBar(),localStorage&&localStorage.setItem("token",""),this.getMode()==this.MODE.NETWORK_MAP&&localStorage.setItem("upgradeSuccess","1"),"wired"==this.wireType?window.location.href="/":n.firmwareView.reconnectMsg.show()},o)},detectLocalUpgradeStatus:function(){c.ajax.request({proxy:"checkUpgradeStatusProxy",success:function(e){clearTimeout(o.queryLocalIntervalMax);e=parseInt(e.percent,10);n.firmwareView.proBar.setValue(e),100===e&&(clearInterval(o.queryLocalInterval),o.queryLocalInterval=null,n.firmwareView.progressbarWrap.hide(),o.startReboot(o.rebootTime,!0))}})},startReboot:function(e,r){s.main.startReboot(e,function(){localStorage&&localStorage.setItem("token",""),o.getMode()==o.MODE.NETWORK_MAP&&localStorage.setItem("upgradeSuccess","1"),"wired"==o.wireType?window.location.href="/":n.firmwareView.reconnectMsg.show()},r?u.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP:"")},checkFileName:function(e,r){return c.vtype.validate(e,{vtype:"string_file",extension:r})},showCheckError:function(e){n.firmwareView.upgradeOption.hide(),n.firmwareView.checkUpgradesBtn.show(),n.firmwareView.checkUpgradesBtn.loading(!1),n.firmwareView.checkUpgradesBtn.setError(e)},showOnlineUpgradeError:function(e){n.firmwareView.onlineUpgradeBtn.setError(e)},showUpgradeError:function(){n.firmwareView.checkUpgradesBtn.loading(!1),n.firmwareView.upgradeErrorMsg.show()},showUpgradeFailedMsg:function(e){switch(e){case"err_form":n.firmwareView.upgradeFailMsg.setContent(u.su.CHAR.ERROR["00000001"]);break;case"err_check":n.firmwareView.upgradeFailMsg.setContent(u.su.CHAR.ERROR["00000002"]);break;case"err_sizex":n.firmwareView.upgradeFailMsg.setContent(u.su.CHAR.ERROR["00000003"]);break;case"err_flash":n.firmwareView.upgradeFailMsg.setContent(u.su.CHAR.ERROR["00000004"]);break;case"err_reboot":n.firmwareView.upgradeFailMsg.setContent(u.su.CHAR.ERROR["00000005"]);break;case"err_other":n.firmwareView.upgradeFailMsg.setContent(u.su.CHAR.ERROR["00000006"]);break;case"err_failed":n.firmwareView.upgradeFailMsg.setContent(u.su.CHAR.ERROR["10000192"])}n.firmwareView.upgradeFailMsg.show()},failureRetry:function(){var r=this;i.onlineUpgradeModel.getProxy().upgrade({success:function(e){r.getMode()!==r.MODE.QUICK_SETUP&&s.main.showProBar(u.su.CHAR.FIRMWARE.DOWNLOADING,u.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),r.detectDownloadStatus()},fail:function(e){r.showOnlineUpgradeError(u.su.CHAR.ERROR["10000191"])},error:function(){r.showOnlineUpgradeError(u.su.CHAR.ERROR["10000191"])}})},removeInterval:function(){clearInterval(o.queryLocalInterval),o.queryLocalInterval=null,clearInterval(o.queryOnlineInterval),o.queryOnlineInterval=null,clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,n.firmwareView.proBar.stop()},beforeDestroy:function(){o.removeInterval(),c.time.off("on_time_change",o.onTimeChange)},setUpgradedValue:function(e){c.ajax.request({proxy:"firmwareProxy",method:"write",data:{upgraded:e}})},checkRouter:function(e){var r,a,t;e&&(r=e.success,a=e.fail,t=e.error),c.ajax.request({proxy:"checkRouterProxy",success:function(e){r&&r(e)},fail:function(e){a&&a(e)},error:function(e){t&&t(e)}})},onTimeChange:function(e,r){var a=c.time.getHour24(),r=c.time.format(r,"yyyy-MM-dd HH:mm:ss",a);n.firmwareView.currentTime.setValue(r)}}})}(jQuery);