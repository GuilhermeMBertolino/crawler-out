!function(I){I.su.moduleManager.define("portForwarding",{deps:["utils"],services:[],models:["lanAdvLanModel"],stores:["portForwardingStore","natProtocolStore","portForwardingCommonServicesStore","portForwardingConnectedDevicesStore"],views:["portForwardingView"],listeners:{"ev_on_launch":function(e,R,o,f,v,A,t){f.lanAdvLanModel.load(),v.portForwardingStore.load(),this.control({"#port-forwarding-grid":{"ev_grid_before_save":function(c,e){var t=v.portForwardingStore.getEditingModel(),r=f.lanAdvLanModel.ipaddr.getValue(),n=f.lanAdvLanModel.maskType.getValue();switch(n){case 0:n="255.255.255.0";break;case 1:n="255.255.0.0";break;case 2:n="255.0.0.0";break;default:n="custom"}var o="CUSTOM"==n.toUpperCase()?f.lanAdvLanModel.customValue.getValue():n,a=t.ipAddress.getValue();if(!A.utils.isSameNet(a,r,o))return t.ipAddress.setError(I.su.CHAR.ERROR["00000110"]),e.preventDefault(),!1;if(a==A.utils.getLimitIp(r,o,"min"))return t.ipAddress.setError(I.su.CHAR.ERROR["00000134"]),e.preventDefault(),!1;if(a==A.utils.getLimitIp(r,o,"max"))return t.ipAddress.setError(I.su.CHAR.ERROR["00000134"]),e.preventDefault(),!1;if(a==r)return t.ipAddress.setError(I.su.CHAR.ERROR["00000077"]),e.preventDefault(),!1;var o=t.externalPort.getValue(),i=t.protocol.getValue(),s=(t.enable.getValue(),o.split("-")),d=(2==s.length&&parseInt(s[0],10)>parseInt(s[1],10)&&(g=s[0],s[0]=s[1],s[1]=g),v.portForwardingStore.getData());if(I.isArray(d)&&0<d.length)for(var p=0;p<d.length;p++){var l=d[p],u=l.protocol;if(l.key!==t.key.getValue()){var g,l=l["externalPort"].split("-");if(2==l.length&&parseInt(l[0],10)>parseInt(l[1],10)&&(g=l[0],l[0]=l[1],l[1]=g),1==s.length){if(1==l.length){if(parseInt(s[0],10)==parseInt(l[0],10)&&R.containProtocol(i,u))return t.externalPort.setError(I.su.CHAR.ERROR["00000065"]),e.preventDefault(),!1}else if(parseInt(s[0],10)>=parseInt(l[0],10)&&parseInt(s[0],10)<=parseInt(l[1],10)&&R.containProtocol(i,u))return t.externalPort.setError(I.su.CHAR.ERROR["00000065"]),e.preventDefault(),!1}else if(1==l.length){if(parseInt(s[0],10)<=parseInt(l[0],10)&&parseInt(s[1],10)>=parseInt(l[0],10)&&R.containProtocol(i,u))return t.externalPort.setError(I.su.CHAR.ERROR["00000065"]),e.preventDefault(),!1}else if(!(parseInt(s[0],10)>parseInt(l[1],10)||parseInt(s[1],10)<parseInt(l[0],10))&&R.containProtocol(i,u))return t.externalPort.setError(I.su.CHAR.ERROR["00000065"]),e.preventDefault(),!1}}return!0}},"#port-forwarding-common-service":{"ev_button_click":function(e){o.portForwardingView.portForwardingCommonService.show()}},"#port-forwarding-common-service-kinds":{"ev_item_click":function(e,t,r){var n=v.portForwardingStore.getEditingModel();n.name.setValue(r.name),n.externalPort.setValue(r.port),n.internalPort.setValue(r.port),n.protocol.setValue(r.protocol),o.portForwardingView.portForwardingCommonService.close()}},"#port-forwarding-connected-devices":{"ev_button_click":function(e){v.portForwardingConnectedDevicesStore.load({success:function(){o.portForwardingView.portForwardingConnectedDevices.setPosition("center","center")}}),o.portForwardingView.portForwardingConnectedDevices.show()}},"#port-forwarding-connected-devices-items":{"ev_item_click":function(e,t){v.portForwardingStore.getEditingModel().ipAddress.setValue(t.ipAddress),o.portForwardingView.portForwardingConnectedDevices.close()}},"#port-forwarding-external-port":{"ev_textbox_blur":function(){var e,t,r=v.portForwardingStore.getEditingModel();1==r.externalPort.getValid()&&(1==(t=(e=r.externalPort.getValue()).split("-")).length?isNaN(parseInt(t[0],10))||(e=parseInt(t[0],10)):2==t.length&&(isNaN(parseInt(t[0],10))||isNaN(parseInt(t[1],10))||(e=parseInt(t[0],10)+"-"+parseInt(t[1],10))),r.externalPort.setValue(e))}},"#port-forwarding-internal-port":{"ev_textbox_blur":function(e,t){var r,n=v.portForwardingStore.getEditingModel();1==n.internalPort.getValid()&&(r=n.internalPort.getValue(),isNaN(parseInt(r,10))||(r=parseInt(r,10)),n.internalPort.setValue(r))}}}),this.listen({"stores.portForwardingStore":{"ev_data_change":function(e,t,r){t.value!=t.oldValue&&"enable"==r.getName()&&v.portForwardingStore.sync()}}})}},init:function(e,t,r,n,o,a){this.configViews({id:"portForwardingView",items:[{id:"port-forwarding-grid",configs:{popEditor:{addTitle:I.su.CHAR.PORT_FORWARDING.POP_TITLE,content:"#port-forwarding-grid-pop-editor",fields:[{name:"name"},{name:"ipAddress"},{name:"externalPort"},{name:"internalPort"},{name:"protocol"}]},columns:[{text:I.su.CHAR.PORT_FORWARDING.SERVICE_NAME,dataIndex:"name"},{text:I.su.CHAR.PORT_FORWARDING.STATUS,dataIndex:"enable",xtype:"customWidget",widgetName:"switch",cls:"status l-hide xl-hide",settings:{trueValue:"on",falseValue:"off"}},{text:I.su.CHAR.PORT_FORWARDING.DEVICE_IP_ADDRESS,dataIndex:"ipAddress",width:120},{text:I.su.CHAR.PORT_FORWARDING.EXTERNAL_PORT,dataIndex:"externalPort"},{text:I.su.CHAR.PORT_FORWARDING.INTERNAL_PORT,dataIndex:"internalPort"},{text:I.su.CHAR.PORT_FORWARDING.PROTOCOL,dataIndex:"protocol",renderer:function(e){return"ALL"==e?I.su.CHAR.PORT_FORWARDING.ALL:"TCP"==e?I.su.CHAR.PORT_FORWARDING.TCP:I.su.CHAR.PORT_FORWARDING.UDP}},{text:I.su.CHAR.PORT_FORWARDING.STATUS,dataIndex:"enable",xtype:"customWidget",widgetName:"switch",cls:"status s-hide m-hide",settings:{trueValue:"on",falseValue:"off"}},{xtype:"actioncolumn",text:I.su.CHAR.PORT_FORWARDING.MODIFY,renderer:function(e,t){var r='<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit">';r+='<span class="icon"></span>';return'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit"><span class="icon"></span><span class="text"></span></a><a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'}}]}},{id:"port-forwarding-common-service-kinds",itemRender:function(e,t){var r='<div class="common-service-kinds-layout">';return r+'<div class="common-service-kinds">'+("<span>"+t.name+"</span>")+"</div>"+"</div>"}},{id:"port-forwarding-connected-devices-items",configs:[{type:"logo",dataIndex:"deviceType"},{type:"deviceName",dataIndex:"name"},{type:"ip",dataIndex:"ipAddress"},{type:"mac",dataIndex:"macAddress"}]}]})}},function(e,t,r,n,o,a){return{containProtocol:function(e,t){return"ALL"==e||("TCP"==e&&"UDP"!=t||"UDP"==e&&"TCP"!=t)}}})}(jQuery);