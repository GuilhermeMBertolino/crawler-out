!function(d){d.su.moduleManager.define("tpLogin",{services:["moduleManager","ajax","moduleLoader"],stores:[],views:["tpLoginView"],deps:["main","utils"],models:["tpLoginModel","tpLoginControl"],listeners:{"ev_on_launch":function(e,o,t,n,i,a,s){s.ajax.request({proxy:"keyProxy",success:function(e){e&&e.password&&(o.encryptKey=e.password)}}),t.tpLoginView.adminCheckPanel.hide(),d.su.userInfo={},s.moduleLoader.load({module:"tpLogin",view:"tpLoginView"},{module:"tpCloud",view:"tpCloudView"},t.tpLoginView.tpCloudLoader,function(){var e=s.moduleManager.get("tpCloud");e.setMode("login"),e.goTo("login&page=spfLogin")})}},init:function(e,o,t,n,i,a){this.control({"#login-bind-btn":{"ev_button_click":function(){e.doCloudLogin("bind")}},".tp-login-switch-to-local":{"click":function(){var e=a.moduleManager.get("login");e&&e.goToChildModule("localLogin")}},"#user-conflict-prompt2":{"ev_msg_ok":function(){e.doCloudLogin("login",!0)}}})}},function(n,r,a,e,u,l){n=this;return{encryptKey:"",unLoad:function(){l.moduleLoader.unLoad(r.tpLoginView.tpCloudLoader)},checkAdmin:function(){r.tpLoginView.tpLoginPanel.hide(),d(".tp-login-switch-to-local-container").hide(),r.tpLoginView.adminCheckPanel.show()},doCloudLogin:function(e,o){var t={"operation":e,"token":d.su.userInfo.token},i=l.moduleManager.get("tpCloud");if("bind"==e){if(!a.tpLoginControl.validate())return;a.tpLoginControl.password.getValue();e=a.tpLoginControl.password.doEncrypt(n.encryptKey);t.password=e}o&&(t.confirm=o),l.ajax.request({proxy:"authProxy",success:function(e){d.su.encryptor.setRSAKey(e.key[0],e.key[1]),d.su.encryptor.setSeq(e.seq),d.su.encryptor.genAESKey(),d.su.encryptor.setHash(d.su.userInfo.token),d.encrypt.encryptManager.recordEncryptor(),l.ajax.request({proxy:"cloudLoginProxy",data:t,isLogin:!0,success:function(e){var o,t,n=e.stok||(o="12345",t=top.location.href,n=t.indexOf("stok="),o=0<=n?t.substring(n+5):o);i.postLoginStatus(),d.su.userInfo.role=e.role,d.su.userInfo.cloudLogined=!0,localStorage&&(u.main.setToken(n),localStorage.setItem("userInfo",JSON.stringify(d.su.userInfo)),u.main.reload())},fail:n.loginFailDealer,error:i.postLoginStatus})},fail:i.postLoginStatus,error:i.postLoginStatus})},loginFailDealer:function(e,o){l.moduleManager.get("tpCloud").postLoginStatus(),r.tpLoginView.tpLoginBtn.loading(!1);var t=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&t){t=String(e.data.errorcode).replace(/^-/,"E");u.main.showNotice(d.su.CHAR.ERROR[t],1,1e4)}else if(o)switch(o){case"user conflict":e.data.logined_user;r.tpLoginView.userConflictMsgContent2.setText(d.su.CHAR.LOGIN.USER_CONFLICT_MSG),r.tpLoginView.userConflictMsg2.show();break;case"login failed":var n=e.data.failureCount,i=(a=e.data.attemptsAllowed)+n;0===a?(s=d.su.CHAR.ERROR["00000089"].replace("%num",i),r.tpLoginView.maxAttemptsMsgContent2.setText(s),r.tpLoginView.maxAttemptsMsg2.show()):(a<=n?(s=(s=d.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",n)).replace("%num2",a),r.tpLoginView.leftAttemptsMsgContent2.setText(s)):r.tpLoginView.leftAttemptsMsgContent2.setText(d.su.CHAR.LOGIN.LOGIN_FAILED),r.tpLoginView.leftAttemptsMsg2.show());break;case"exceeded max attempts":var a,n=e.data.failureCount,i=(a=e.data.attemptsAllowed)+n,s=d.su.CHAR.ERROR["00000089"].replace("%num",i);r.tpLoginView.maxAttemptsMsgContent2.setText(s),r.tpLoginView.maxAttemptsMsg2.show()}}}})}(jQuery);