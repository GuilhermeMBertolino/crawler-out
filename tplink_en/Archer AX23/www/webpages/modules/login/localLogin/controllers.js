!function(c){c.su.moduleManager.define("localLogin",{services:["ajax"],models:["localLogin","localLoginControl","vercodeModel","resetPwdModel"],stores:[],views:["localLoginView"],deps:["login","main"],listeners:{"ev_on_launch":function(e,o,n,t,i,l,a){n.localLoginView.noInternetTips.hide(),a.ajax.request({proxy:"keyProxy",success:function(e){e&&e.password&&(o.encryptKey=e.password)}}),l.login.supportCloud()?(n.localLoginView.switchToTp.show(),n.localLoginView.mainPanel.setTitle(c.su.CHAR.LOGIN.LOCAL_LOGIN)):(n.localLoginView.switchToTp.hide(),n.localLoginView.mainPanel.setTitle(c.su.CHAR.LOGIN.LOGIN)),a.ajax.request({proxy:"sysmodeLoginProxy",data:{"operation":"read"},success:function(e){"ap"===e.mode?n.localLoginView.switchToTp.hide():n.localLoginView.switchToTp.show()}})}},init:function(n,t,i,e,o,l){this.control({"#local-login-pwd":{"keyup":function(e){13==e.keyCode&&n.doLogin()}},"#local-login-button":{"ev_button_click":function(){n.doLogin()}},".local-login-switch-to-tp":{"click":function(e){l.ajax.request({proxy:"loginCheckInternetProxy",method:"read",success:function(e){o.login.goToChildModule("tpLogin")},fail:function(){t.localLoginView.noInternetTips.show(),t.localLoginView.noInternetTips.setText(c.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)},error:function(){t.localLoginView.noInternetTips.show(),t.localLoginView.noInternetTips.setText(c.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)}})}},".local-login-forget-pwd":{"mousedown":function(){n.forgetPasswordHandler()}},"#send-code-btn":{"ev_button_click":function(){t.localLoginView.sendCodeFailedNote.hide(),l.ajax.request({data:{operation:"read"},proxy:"sendCodeProxy",success:function(e){n.enableConfirm=!0,t.localLoginView.sendCodeBtn.disable(),t.localLoginView.sendCodeBtn.setText(n.receiveCodeTimeCount+c.su.CHAR.LOGIN.SEC),clearInterval(n.countDownTimer),n.countDownTimer=setInterval(function(){0<n.receiveCodeTimeCount?(n.receiveCodeTimeCount--,t.localLoginView.sendCodeBtn.setText(n.receiveCodeTimeCount+c.su.CHAR.LOGIN.SEC)):(clearInterval(n.countDownTimer),n.receiveCodeTimeCount=60,t.localLoginView.sendCodeBtn.enable(),t.localLoginView.sendCodeBtn.setText(c.su.CHAR.LOGIN.SEND))},1e3)},fail:function(){t.localLoginView.sendCodeFailedNote.show()}})}},"#confirm-code-btn":{"ev_button_click":function(){n.enableConfirm&&(t.localLoginView.sendCodeFailedNote.hide(),i.vercodeModel.submit({success:function(e){n.vercode=e.vercode,t.localLoginView.forgetPasswordSendCodeMsg.hide(),i.resetPwdModel.password.setValue(),i.resetPwdModel.confirm.setValue(),t.localLoginView.resetPasswordMsg.show()},fail:function(e,o){i.vercodeModel.vercode.setError(),t.localLoginView.confirmCodeOverlimitNote.setText(c.su.CHAR.ERROR[o]),t.localLoginView.confirmCodeOverlimitMsg.show()},error:function(){i.vercodeModel.vercode.setError()}}))}},"#reset-pwd-btn":{"ev_button_click":function(){var e;i.resetPwdModel.validate()&&(i.resetPwdModel.password.getValue()==i.resetPwdModel.confirm.getValue()?(e=i.resetPwdModel.password.doEncrypt(n.encryptKey),l.ajax.request({proxy:"forgetPasswordProxy",data:{operation:"write",password:e,confirm:!0,vercode:n.vercode},success:function(e){t.localLoginView.resetPasswordMsg.hide()}})):i.resetPwdModel.confirm.setError(c.su.CHAR.ERROR["00000080"]))}},"#send-code-content":{"ev_view_change":function(e,o){"value"===o.type&&(o=o.value,n.enableConfirm&&o?t.localLoginView.confirmCodeBtn.enable():t.localLoginView.confirmCodeBtn.disable())}},".find-local-pwd-jump-label":{"click":function(){n.queryRecoveryPasswordMethod().then(function(e){e?o.login.goToChildModule("localPwdRecovery"):t.localLoginView.noRecoveryMethodMsg.show()})}},"#user-conflict-prompt":{"ev_msg_ok":function(){var e=i.localLoginControl.password.doEncrypt(n.encryptKey);i.localLogin.password.setValue(e),i.localLogin.login({data:{operation:"login",confirm:!0},success:n.loginSuccessDealer,fail:n.loginFailDealer})}}})}},function(n,s,r,e,i,t){return{enableConfirm:!1,receiveCodeTimeCount:60,countDownTimer:null,encryptKey:null,vercode:"",doLogin:function(){var o,e;r.localLoginControl.validate()&&(o=r.localLoginControl.password.getValue(),e=r.localLoginControl.password.doEncrypt(n.encryptKey),r.localLogin.password.setValue(e),s.localLoginView.localLoginBtn.loading(!0),t.ajax.request({proxy:"authProxy",success:function(e){c.su.encryptor.setRSAKey(e.key[0],e.key[1]),c.su.encryptor.setSeq(e.seq),c.su.encryptor.genAESKey(),c.su.encryptor.setHash("admin",o),c.encrypt.encryptManager.recordEncryptor(),r.localLogin.login({preventFailEvent:!0,success:n.loginSuccessDealer,fail:n.loginFailDealer})}}))},loginSuccessDealer:function(e,o){s.localLoginView.localLoginBtn.loading(!1);var n,t=e.stok||(e="12345",n=top.location.href,t=n.indexOf("stok="),e=0<=t?n.substring(t+5):e);localStorage&&(i.main.setToken(t),i.main.reload())},loginFailDealer:function(e,o){s.localLoginView.localLoginBtn.loading(!1);var n=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&n){n=String(e.data.errorcode).replace(/^-/,"E");r.localLoginControl.password.setErrorHtml(c.su.CHAR.ERROR[n])}else if(o)switch(o){case"user conflict":e.data.logined_user;s.localLoginView.userConflictMsgContent.setText(c.su.CHAR.LOGIN.USER_CONFLICT_MSG),s.localLoginView.userConflictMsg.show();break;case"login failed":var t=e.data.failureCount,i=(l=e.data.attemptsAllowed)+t;0===l?(a=c.su.CHAR.ERROR["00000089"].replace("%num",i),s.localLoginView.maxAttemptsMsgContent.setText(a),s.localLoginView.maxAttemptsMsg.show()):(l<=t?(a=(a=c.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",t)).replace("%num2",l),s.localLoginView.leftAttemptsMsgContent.setText(a)):s.localLoginView.leftAttemptsMsgContent.setText(c.su.CHAR.LOGIN.LOGIN_FAILED),s.localLoginView.leftAttemptsMsg.show());break;case"exceeded max attempts":var l,t=e.data.failureCount,i=(l=e.data.attemptsAllowed)+t,a=c.su.CHAR.ERROR["00000089"].replace("%num",i);s.localLoginView.maxAttemptsMsgContent.setText(a),s.localLoginView.maxAttemptsMsg.show()}},queryRecoveryPasswordMethod:function(){var e=c.Deferred();return e.resolve(!0),e.promise()},forgetPasswordHandler:function(){t.ajax.request({proxy:"forgetPasswordProxy",success:function(e){e&&(e.enable_rec?(s.localLoginView.sendCodeFailedNote.hide(),r.vercodeModel.vercode.setNormal(),r.vercodeModel.vercode.setValue(),s.localLoginView.confirmCodeBtn.disable(),s.localLoginView.forgetPasswordSendCodeMsg.show()):s.localLoginView.forgetPasswordMsg.show(),clearInterval(n.countDownTimer),n.receiveCodeTimeCount=60,s.localLoginView.sendCodeBtn.enable(),s.localLoginView.sendCodeBtn.setText(c.su.CHAR.LOGIN.SEND))}})}}})}(jQuery);