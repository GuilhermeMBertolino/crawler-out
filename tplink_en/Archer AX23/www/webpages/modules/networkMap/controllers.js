!function(u){u.su.moduleManager.define("networkMap",{services:["moduleLoader","ajax","device","timer","moduleManager"],models:["statusAll","internetSpeedModel","onlineUpgradeModel","portModel"],stores:["connectedClientsStore","upgradeOperationStore","oneMeshClientsStore"],deps:["mapInternet","navigatorController"],views:["networkMapView"],listeners:{"ev_on_launch":function(e,t,n,a,o,r,s){t.loadModules(function(){t.switchModule("internet"),t.startGetDeviceNum()}),!0===s.device.getConfig().supportSelectPort&&a.portModel.load(),t.startGetInternetStatus(),u("#printer-item").addClass("hidden"),s.device.getIsTriband()?u("#wireless-5g-2-item").removeClass("hidden"):(u("#wireless-5g-2-item").addClass("hidden"),u("#wireless-5g-item .text").text(u.su.CHAR.NETWORK_MAP.G5));a=u.su.CHAR.UPGRADE.NOTICE;n.networkMapView.upgradeMsg3.setContent(a),setTimeout(function(){t.isRunning()&&(s.device.getConfig().supportAutoUpdate?s.ajax.request({proxy:"autoUpgradeReadProxy",method:"read",success:function(e){var t=s.moduleManager.get("index");t&&t.hideSupportTips(),n.networkMapView.autoUpdateMsg.show()},fail:t.updateHandler}):t.updateHandler())},1889),u("#map-clients .map-clients-icon-num").hide(),u("#map-mesh .map-clients-icon-num").hide()},"ev_before_destroy":function(e,t){t.beforeDestroy()},"ev_clients_number_changed":function(e,t){this.setClientsNumber(t)},"ev_mesh_number_changed":function(e,t){this.setMeshNumber(t)}},init:function(n,a,o,t,r,s){this.configViews({}),this.control({"#map-internet":{"click":function(e){n.switchModule("internet")}},"#map-router":{"click":function(e){n.switchModule("router")}},"#map-clients":{"click":function(e){n.switchModule("clients"),setTimeout(function(){t.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){n.setClientsNumber(t.connectedClientsStore.getData().length)}})},11)}},"#map-mesh":{"click":function(e){n.switchModule("mesh"),setTimeout(function(){t.oneMeshClientsStore.load({data:{operation:"read"},success:function(e){n.setMeshNumber(t.oneMeshClientsStore.getData().length),u.su.moduleManager.get("mapMesh").checkLength(t.oneMeshClientsStore.getData().length)}})},11)}},"#upgrade-msg-2":{"ev_msg_ok":function(){n.startOnlineUpgrade()}},"#upgrade-msg-3":{"ev_msg_ok":function(){n.startOnlineUpgrade()},"ev_msg_close":function(){s.ajax.request({method:"write",proxy:"upgradeReadProxy",data:{"remind_later":"1"}})},"click":function(e){u(e.target).hasClass("upgrade-text")&&(a.networkMapView.upgradeMsg3.close(),setTimeout(function(){r.navigatorController.goTo("firmware")},20))}},"#upgrade-msg-4":{"ev_msg_close":function(){s.ajax.request({method:"write",proxy:"upgradeReadProxy",data:{"remind_later":"1"}})},"click":function(e){u(e.target).hasClass("upgrade-text")&&(a.networkMapView.upgradeMsg4.close(),setTimeout(function(){r.navigatorController.goTo("firmware")},20))}},"#upgrade-now-button":{"ev_button_click":function(){a.networkMapView.upgradeMsg4.close(),n.startOnlineUpgrade()}},"#auto-update-now-btn":{"ev_button_click":function(){r.navigatorController.goTo("firmware")}},"#auto-update-later-btn":{"ev_button_click":function(){a.networkMapView.autoUpdateMsg.close()}}}),this.listen({"views.networkMapView.updateOperation":{"ev_value_change":function(e,t){a.networkMapView.upgradeMsg4.close(),s.ajax.request({method:"write",proxy:"upgradeReadProxy",data:{"remind_later":"remind"==t?"1":"0"}})}},"models.onlineUpgradeModel":{"ev_loaded":function(){var e=o.onlineUpgradeModel.detail.getValue(),t="";t=e?e.replace(/\\\\/g,"&#92;").replace(/\\n/g,"<br>"):(e=s.device.getProductName()||u.su.CHAR.NETWORK_MAP.ROUTER,u.su.CHAR.UPGRADE.NOTICE_IMPORTANT.replace("%model%",n.modelName||e)),a.networkMapView.updateDetails.setText(t),u.su.scrollbar({ele:"#upgrade-msg-2 .advanced-panel .panel-content"})}}})}},function(n,r,a,t,o,s){var i,d=null,l=null,e=null;return{delayInterval:0,modelName:"",startOnlineUpgrade:function(){var e=u.su.moduleManager.get("firmware");e.setMode("networkMap"),e.startOnlineUpgrade()},loadModules:function(e){var t=u.Deferred(),n=u.Deferred(),a=u.Deferred(),o=u.Deferred();s.moduleLoader.load({module:"networkMap"},{module:"mapInternet"},r.networkMapView.mapInternetLoader,function(){t.resolve()}),s.moduleLoader.load({module:"networkMap"},{module:"mapRouter"},r.networkMapView.mapRouterLoader,function(){n.resolve()}),1==s.device.getConfig().supportOneMesh&&"router"==s.device.getCurrentMode()?s.moduleLoader.load({module:"networkMap"},{module:"mapMesh"},r.networkMapView.mapMeshLoader,function(){o.resolve()}):(u("#map-mesh").hide(),u(".map-line.mesh").hide(),o.resolve()),s.moduleLoader.load({module:"networkMap"},{module:"mapClients"},r.networkMapView.mapClientsLoader,function(){a.resolve()}),r.networkMapView.mapInternetLoader.hide(),r.networkMapView.mapRouterLoader.hide(),r.networkMapView.mapMeshLoader.hide(),r.networkMapView.mapClientsLoader.hide(),u.when(t,n,o,a).then(function(){e&&e()})},switchModule:function(e){for(var t=["internet","router","mesh","clients"],n=0;n<t.length;n++){var a="map"+(t[n].charAt(0).toUpperCase()+t[n].slice(1))+"Loader",o="#map-"+t[n];t[n]===e?(u(o).addClass("active"),r.networkMapView[a].show()):(u(o).removeClass("active"),r.networkMapView[a].hide())}i=e},getCurrentModule:function(){return i},startGetInternetStatus:function(){var t=s.device.getConfig().supportSpeedTest,e=(t&&n.setInternetSpeed({upSpeed:0,downSpeed:0}),clearInterval(d),{success:function(e){if(o.mapInternet.setInternetStatus(e),"CONNECTED"===e.internetStatus.toUpperCase()?u("#map-internet .map-internet-icon-status").removeClass("disconnected poorconnected warning"):"POOR_CONNECTED"===e.internetStatus.toUpperCase()?u("#map-internet .map-internet-icon-status").addClass("poorconnected"):u("#map-internet .map-internet-icon-status").addClass("disconnected"),"router"!==s.device.getCurrentMode()||!t)return r.networkMapView.speedDownload.hide(),void r.networkMapView.speedUpload.hide();n.startGetInternetSpeed(),r.networkMapView.speedDownload.show(),r.networkMapView.speedUpload.show()}});d=setInterval(function(){n.getInternetStatus(e)},3e3),n.getInternetStatus(e)},getInternetStatus:function(e){var t,n;e&&(t=e.success,n=e.fail),s.ajax.request({proxy:"internetStatusProxy",success:function(e){t&&t(e)},fail:function(e){n&&n(e)}})},startGetInternetSpeed:function(){clearInterval(l);var e={success:function(e){n.setInternetSpeed(e)}};l=setInterval(function(){n.getInternetSpeed(e)},3229)},startGetDeviceNum:function(){e=s.timer.setInterval(n,function(){0==n.delayInterval&&"clients"!=n.getCurrentModule()&&t.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){n.setClientsNumber(t.connectedClientsStore.getData().length),n.delayInterval=0},fail:function(){n.delayInterval=0},error:function(){n.delayInterval=0}}),0==n.delayInterval&&"mesh"!=n.getCurrentModule()&&"router"==s.device.getCurrentMode()&&1==s.device.getConfig().supportOneMesh&&t.oneMeshClientsStore.load({data:{operation:"read"},success:function(e){n.setMeshNumber(t.oneMeshClientsStore.getData().length),n.delayInterval=0},fail:function(){n.delayInterval=0},error:function(){n.delayInterval=0}}),n.delayInterval=1},20123,!0)},getInternetSpeed:function(e){var t,n;e&&(t=e.success,n=e.fail),a.internetSpeedModel.load({success:function(){t&&t(a.internetSpeedModel.getData())},fail:function(e){n&&n(e)}})},setInternetSpeed:function(e){var t=n.separateSpeed(e.upSpeed),e=n.separateSpeed(e.downSpeed);r.networkMapView.speedDownload.setField("value",e.value),r.networkMapView.speedDownload.setField("unit",e.unit),r.networkMapView.speedUpload.setField("value",t.value),r.networkMapView.speedUpload.setField("unit",t.unit)},setProductName:function(e){n.modelName=e;var t=s.device.getProductName()||u.su.CHAR.NETWORK_MAP.ROUTER;r.networkMapView.mapRouter.setField("productName",e||t),r.networkMapView.updateNotice.setText(u.su.CHAR.UPGRADE.NOTICE_IMPORTANT.replace("%model%",e||t))},handleWirelessIcon:function(e,t){var n;t?"on"===e?u("#wireless-"+t+"-item").removeClass("disabled"):u("#wireless-"+t+"-item").addClass("disabled"):(t=e.wireless2gEnable,n=e.wireless5gEnable,e=e.wireless5g2Enable,"on"===t?u("#wireless-2g-item").removeClass("disabled"):u("#wireless-2g-item").addClass("disabled"),"on"===n?u("#wireless-5g-item").removeClass("disabled"):u("#wireless-5g-item").addClass("disabled"),"on"===e?u("#wireless-5g-2-item").removeClass("disabled"):u("#wireless-5g-2-item").addClass("disabled"))},handlePrinterIcon:function(e){e=e.printerCount;0===parseInt(e,10)?u("#printer-item").addClass("hidden"):u("#printer-item").removeClass("hidden")},setClientsNumber:function(e){(e=parseInt(e,10))&&2<e.toString().length?u("#map-clients .map-clients-icon-num").addClass("huge-num"):u("#map-clients .map-clients-icon-num").removeClass("huge-num"),u("#map-clients .map-clients-icon-num").text(isNaN(e)?0:e).show()},setMeshNumber:function(e){(e=parseInt(e,10))&&2<e.toString().length?u("#map-mesh .map-clients-icon-num").addClass("huge-num"):u("#map-mesh .map-clients-icon-num").removeClass("huge-num"),u("#map-mesh .map-clients-icon-num").text(isNaN(e)?0:e).show()},separateSpeed:function(e){var t={};return e/1024<1?(t.value=0===e?0:e/1024,t.unit=u.su.CHAR.NETWORK_MAP.KBPS):e/1024/1024<1?(t.value=e/1024,t.unit=u.su.CHAR.NETWORK_MAP.KBPS):(t.value=e/1024/1024,t.unit=u.su.CHAR.NETWORK_MAP.MBPS),t.value=parseFloat(t.value.toFixed(2)),t},beforeDestroy:function(){clearInterval(d),clearInterval(l),clearInterval(e)},updateHandler:function(){s.moduleLoader.load({module:"networkMap"},{module:"firmware"},r.networkMapView.upgradeLoader,function(){r.networkMapView.upgradeLoader.hide(),sessionStorage&&sessionStorage.getItem&&localStorage.getItem("token")!=sessionStorage.getItem("upgradeToken")&&s.ajax.request({proxy:"upgradeReadProxy",method:"read",success:function(e){"1"==e.remind_now&&(1==e.type?(r.networkMapView.upgradeMsg4.show(),sessionStorage.setItem("upgradeToken",localStorage.getItem("token"))):2==e.type?(r.networkMapView.upgradeMsg3.show(),sessionStorage.setItem("upgradeToken",localStorage.getItem("token"))):3==e.type&&r.networkMapView.upgradeMsg2.show()),"1"==localStorage.getItem("upgradeSuccess")&&(r.networkMapView.networkUpgradeSuccessMsg.show(),localStorage.setItem("upgradeSuccess",0))}})})}}})}(jQuery);