!function(S){S.su.moduleManager.define("dashboard",{deps:["speedTest","navigatorController"],services:["ajax","timer","moduleLoader","moduleManager"],models:["statusAll","internetSpeedModel"],stores:["connectedClientsStore","usbStorageStore","timePeriodStore"],views:["dashboardView"],listeners:{"ev_on_launch":function(e,t,a,n,o,i,s){this.unRegisterAutoSaveData([o.connectedClientsStore]),t.initPerformance(),t.initSpeedtest(),t.initClients(),s.timer.setInterval(t,function(){n.statusAll.load()},2e3,!0)}},init:function(o,e,t,i,a,s){this.configViews({id:"dashboardView",items:[{id:"internet-conn-note",title:S.su.CHAR.NETWORK_MAP.TRY_FOLLOW,items:[{text:S.su.CHAR.NETWORK_MAP.TRY_1},{text:S.su.CHAR.NETWORK_MAP.TRY_2},{text:S.su.CHAR.NETWORK_MAP.TRY_3},{text:S.su.CHAR.NETWORK_MAP.TRY_4}]},{id:"connected-clients-grid",configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty"},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){var a="",n="",o="";switch(e=e.toLowerCase()){case"pc":a="icon-pc";break;case"phone":a="icon-phone";break;case"pad":a="icon-pad";break;case"other":a="icon-other";break;default:a="icon-"+e}return n=n+'<div class="device-type-container widget-container">'+('<span class="icon '+a+' ">'+(o=t.isGaming?'<span class="gaming-tag"></span>':o)+"</span>"),null!=t.enableInternet&&(n+='<span class="text">'+(t.enableInternet?"":S.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),n=(n=(n+="</div>")+'<div class="device-info-container widget-container">'+('<div class="mac">'+t.mac+"</div>"))+('<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>")+"</div>"}},{text:S.su.CHAR.DASHBOARD.TYPE,width:"16%",dataIndex:"deviceType",cls:"s-hide",renderer:function(e,t){var a="",n="",o="";switch(e=e.toLowerCase()){case"pc":a="icon-pc";break;case"phone":a="icon-phone";break;case"pad":a="icon-pad";break;case"other":a="icon-other";break;default:a="icon-"+e}return n=n+'<div class="device-type-container widget-container">'+('<span class="icon '+a+' ">'+(o=t.isGaming?'<span class="gaming-tag"></span>':o)+"</span>"),null!=t.enableInternet&&(n+='<span class="text">'+(t.enableInternet?"":S.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),n+="</div>"}},{text:S.su.CHAR.DASHBOARD.INFORMATION,dataIndex:"deviceName",width:"25%",cls:"s-hide",renderer:function(e,t){var a,n="";return n="object"===S.type(t)?(n=(n+='<div class="device-info-container widget-container">')+'<div class="name" title="'+(a=t.deviceName)+'">'+a+'</div><div class="mac">'+t.mac+"</div>")+'<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div></div>":n}},{text:S.su.CHAR.DASHBOARD.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,t){var a,n="",o=function(e){var t=(e=parseInt(e,10))/1024<1?(0!==e&&(e=(e/1024).toFixed(2)),S.su.CHAR.DASHBOARD.KBPS):e/1024/1024<1?(e/1024<1e3?e=(e/1024).toFixed(1):e/=1024,S.su.CHAR.DASHBOARD.KBPS):(e=(e/1024/1024).toFixed(1),S.su.CHAR.DASHBOARD.MBPS);return{speed:e,unit:t}};return"object"===S.type(t)&&(a=o(t.downloadSpeed),n=(n=(n=(n=(n+='<div class="speed-upload-container widget-container">')+'<span class="icon"></span><span class="text">'+(t=o(t.uploadSpeed)).speed+"</span>")+'<span class="unit">'+t.unit+'</span></div><div class="speed-download-container widget-container">')+'<span class="icon"></span><span class="text">'+a.speed+"</span>")+'<span class="unit">'+a.unit+"</span></div>"),n}},{text:S.su.CHAR.DASHBOARD.DEVICE_PRIORITY,dataIndex:"enablePriority",xtype:"customWidget",cls:"status connected-clients-grid-priority-td",widgetName:"switch",settings:{trueValue:!0,falseValue:!1}},{text:S.su.CHAR.DASHBOARD.TIMING,dataIndex:"timePeriod",xtype:"customWidget",width:90,cls:"s-2-col",widgetName:"combobox",settings:{noneSelectedText:"",items:i.timePeriodStore.getData()},renderer:function(e,t){return!t.enablePriority&&"---"}}]}}]}),this.control({"#speed-test-mini-panel":{"click":function(){S("#speed-test-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),S("#internet-block").toggle(S("#speed-test-mini-panel").hasClass("selected")),S("#performance-panel").hide(),S("#usb-panel").hide(),e.dashboardView.internetSpeedUsage.resize()}},"#performance-mini-panel":{"click":function(){S("#performance-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),S("#internet-block").hide(),S("#performance-panel").toggle(S("#performance-mini-panel").hasClass("selected")),S("#usb-panel").hide(),e.dashboardView.cpuLoad.resize(),e.dashboardView.memoryUsage.resize()}},"#usb-mini-panel":{"click":function(){i.usbStorageStore.getData()&&i.usbStorageStore.getData().length&&(S("#usb-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),S("#internet-block").hide(),S("#performance-panel").hide(),S("#usb-panel").toggle(S("#usb-mini-panel").hasClass("selected")))}},"#map-router-usb-button":{"ev_button_click":function(e){a.navigatorController.goTo("storageSharing")}}}),this.listen({"models.statusAll":{"ev_loaded":function(e,t){o.setStorage(t),o.setPerformance(t)}},"stores.connectedClientsStore":{"ev_data_change":function(e,t,a){var n;"enablePriority"===a.getName()&&t.value!==t.oldValue&&((n=s.moduleManager.get("bandwidth")).hasConfigured()?(i.connectedClientsStore.abort(),i.connectedClientsStore.sync({success:function(e){i.connectedClientsStore.loadData(e,!0)}})):t.value&&(o.stopGetClients(),n.showBandwithMsg())),"timePeriod"==a.getName()&&t.value!=t.oldValue&&(i.connectedClientsStore.abort(),i.connectedClientsStore.sync())}}})}},function(d,l,n,a,t,o){var i,e=null,c=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),u=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),s=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),r=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),p=function(e,t){e=e||2e3,t=t||7;for(var a,n=new Date,o=[];t--;)o.unshift(("0"+(a=n).getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)+":"+("0"+a.getSeconds()).slice(-2)),n=new Date(n-e);return o};return{speedRequestInterval:2e3,setStorage:function(e){var o={PB:S.su.CHAR.UNIT.PB,TB:S.su.CHAR.UNIT.TB,GB:S.su.CHAR.UNIT.GB,MB:S.su.CHAR.UNIT.MB,KB:S.su.CHAR.UNIT.KB,B:S.su.CHAR.UNIT.B};function i(e){return e&&e.toUpperCase()}e.usbStorages.length?(l.dashboardView.noUSBTips.hide(),l.dashboardView.USBFieldset.show(),S.each(e.usbStorages,function(e,t){var a=S.su.capacityToNum(t.available+o[i(t.availableUnit)]),n=S.su.capacityToNum(t.capacity+o[i(t.capacityUnit)]);t.usageRate=a/n*100}),S("#usb-panel").toggleClass("single-column",1===e.usbStorages.length),a.usbStorageStore.loadData(e.usbStorages,!0)):(l.dashboardView.noUSBTips.show(),l.dashboardView.USBFieldset.hide(),S("#usb-mini-panel").removeClass("selected"),S("#usb-panel").hide())},initSpeedtest:function(){l.dashboardView.internetSpeedUsage.setOption(d.calculateInternetSpeedOption()),l.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),l.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),l.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",S.su.CHAR.DASHBOARD.KBPS),l.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",S.su.CHAR.DASHBOARD.KBPS),l.dashboardView.internetSpeedUpload.setValue("0 "+S.su.CHAR.DASHBOARD.KBPS),l.dashboardView.internetSpeedDownload.setValue("0 "+S.su.CHAR.DASHBOARD.KBPS),o.timer.setInterval(d,function(){o.ajax.request({proxy:"internetStatusProxy",success:function(e){"CONNECTED"===e.internetStatus.toUpperCase()?(d.getInternetSpeed({success:function(e){d.setInternetSpeed(e)}}),l.dashboardView.speedTestPanel.show(),l.dashboardView.noInternetFieldset.hide()):(l.dashboardView.speedTestPanel.hide(),l.dashboardView.noInternetFieldset.show(),l.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),l.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),l.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",S.su.CHAR.DASHBOARD.KBPS),l.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",S.su.CHAR.DASHBOARD.KBPS))}})},d.speedRequestInterval,!0)},getInternetSpeed:function(e){var t,a;e&&(t=e.success,a=e.fail),n.internetSpeedModel.load({success:function(){t&&t(n.internetSpeedModel.getData())},fail:function(e){a&&a(e)}})},setInternetSpeed:function(e){var t,a,n,o,i=this.separateSpeed(e.upSpeed),s=this.separateSpeed(e.downSpeed),i=(l.dashboardView.speedTestMiniPanel.setField("uploadSpeed",i.value),l.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",i.unit),l.dashboardView.speedTestMiniPanel.setField("downloadSpeed",s.value),l.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",s.unit),l.dashboardView.internetSpeedUpload.setValue(i.value+" "+i.unit),l.dashboardView.internetSpeedDownload.setValue(s.value+" "+s.unit),p(d.speedRequestInterval,26)),s=(c.shift(),c.push(e.upSpeed/1024),u.shift(),u.push(e.downSpeed/1024),Math.max.apply(this,c.concat(u)));function r(e){var t=parseInt(e,10).toString().length,t=Math.max(t-2,0);return t=3*Math.pow(10,t),Math.ceil(e/t)*t}n=1024<=s?(s/=1024,t=S.map(c,function(e){return e/1024}),a=S.map(u,function(e){return e/1024}),o=S.su.CHAR.DASHBOARD.MBPS,r(s)):(t=c,a=u,o=S.su.CHAR.DASHBOARD.KBPS,Math.max(r(s),120)),l.dashboardView.internetSpeedUsage.setOption({xAxis:[{data:i}],yAxis:[{max:n,interval:n/3,axisLabel:{formatter:function(e,t){return n/3*t+o}}}],series:[{data:t},{data:a}]})},calculateInternetSpeedOption:function(e){return e=S.extend({title:"",color:"#ffcd08",name:"internetSpeed"},e),{title:{show:!1},grid:{top:10,right:30,left:72,bottom:40,containLabel:!1},xAxis:[{name:"",type:"category",axisLine:{show:!1},axisLabel:{show:!0,interval:4,margin:20,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12}},axisTick:{show:!1,alignWithLabel:!0},splitLine:{show:!0,interval:4,lineStyle:{color:"#4a3a3a"}},boundaryGap:!1,data:p(d.speedRequestInterval,26)}],yAxis:[{max:120,min:0,interval:40,offset:40,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{color:"#4a3a3a"}},axisLabel:{show:!0,align:"left",margin:24,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+S.su.CHAR.DASHBOARD.KBPS}}}],series:[{name:"upload",type:"line",smooth:!0,symbol:"none",zIndex:2,itemStyle:{normal:{color:"rgb(236,154,0)",borderColor:"rgb(236,154,0)"}},areaStyle:{normal:{color:"rgba(236,154,0,0.4)"}},lineStyle:{width:1},data:e.data},{name:"download",type:"line",smooth:!0,symbol:"none",zIndex:1,itemStyle:{normal:{color:"rgb(175,0,0)",borderColor:"rgb(175,0,0)"}},areaStyle:{normal:{color:"rgba(175,0,0,0.4)"}},lineStyle:{width:1},data:e.data}]}},initPerformance:function(){l.dashboardView.cpuLoad.setOption(d.calculateLineOption({title:S.su.CHAR.DASHBOARD.CPU_LOAD,color:"#ffcd08",tooltip:{backgroundColor:"rgba(236,154,0,0.4)"},areaColor:"rgba(255, 205, 8, 0.5)",name:S.su.CHAR.DASHBOARD.CPU_CORE_NUMBER+":"})),l.dashboardView.memoryUsage.setOption(d.calculateLineOption({title:S.su.CHAR.DASHBOARD.MEMORY_USAGE,color:"#ff0000",tooltip:{backgroundColor:"rgba(255, 0, 0, 0.8)"},areaColor:"rgba(175,0,0,0.4)"}))},setPerformance:function(e){var t=e.cpuUsage,e=e.memUsage,a=p(2e3,7);s.shift(),s.push(t),l.dashboardView.cpuLoad.setOption({xAxis:[{data:a}],series:{data:s}}),r.shift(),r.push(e),l.dashboardView.memoryUsage.setOption({xAxis:[{data:a}],series:{data:r}})},calculateLineOption:function(s){return{title:{show:!1,text:(s=S.extend({title:"",color:"#ffcd08",name:"",areaColor:"rgba(255, 205, 8, 0.5)"},s)).title,textStyle:{fontSize:13},left:20},grid:{top:10,right:0,left:40,bottom:10},tooltip:S.extend({show:!0,formatter:"{c}%",textStyle:{color:"#fff",fontSize:12,lineHeight:14,fontFamily:"Arial, Sans-Serif, Geneva, Verdana"},padding:[2.6,6],position:function(e,t,a,n,o){var i=(i="")+("<span>"+t.value+"%</span>")+('<span style="display:block;position:absolute;left:'+(o.contentSize[0]/2-3+"px")+";bottom:-6px;border-top:6px solid "+s.tooltip.backgroundColor+';border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:none;background-color:transparent;width:0;height:0;line-height:14px;"></span>');return S(a).html(i),[e[0]-18.5,e[1]-40]}},s.tooltip),xAxis:[{name:"",nameLocation:"middle",nameTextStyle:{color:"#000"},type:"category",axisLine:{show:!1},axisLabel:{show:!1},axisTick:{show:!1},boundaryGap:!1,data:p(2e3,7)}],yAxis:[{max:100,min:0,interval:20,offset:32,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1,lineStyle:{type:"dashed"}},axisLabel:{show:!0,align:"left",textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+"%"}}}],series:[{name:"RX",type:"line",smooth:!0,symbol:"emptyCircle",symbolSize:6,showAllSymbol:!0,legendHoverLink:!1,itemStyle:{normal:{color:s.color,borderColor:s.color}},areaStyle:{normal:{color:s.areaColor}},lineStyle:{width:1},data:s.data}]}},initClients:function(){o.moduleLoader.load({module:"dashboard"},{module:"bandwidth"},l.dashboardView.qosBandwidthLoader,function(){var e=o.moduleManager.get("bandwidth");e.on("ev_qos_saved",function(e){a.connectedClientsStore.abort(),a.connectedClientsStore.sync({success:function(e){a.connectedClientsStore.loadData(e,!0),t()}})}),e.on("ev_qos_save_close",function(e){a.connectedClientsStore.reset(),t()}),e.on("ev_qos_save_cancel",function(e){a.connectedClientsStore.reset(),t()})});var t=function(){clearInterval(e),e=setInterval(function(){a.connectedClientsStore.load({data:{operation:"loadSpeed"}})},1e4)};a.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){a.connectedClientsStore.load({data:{operation:"loadSpeed"}})}}),t()},stopGetClients:function(){clearInterval(e)},getClients:function(){o.ajax.request({proxy:"clientStatusProxy",success:function(e){i=e,a.connectedClientsStore.load({data:{operation:"loadSpeed"}})}})},getAccessControlMode:function(e){var t;e&&(t=e.success),n.accessControl.load({success:function(e){t&&t(n.accessControl.getData())}})},blockDevice:function(e){o.ajax.request({proxy:"blockClientProxy",data:{mac:e},success:function(e){a.connectedClientsStore.load({operation:"loadDevice"})}})},beforeDestroy:function(){clearInterval(e)},getIPaddr:function(e){if(i)for(var t in i)for(var a=0,n=i[t].length;a<n;a++)if(i[t][a].macaddr==e)return i[t][a].ipaddr||"";return""},separateSpeed:function(e){var t={};return e/1024<1?(t.value=0===e?0:e/1024,t.unit=S.su.CHAR.DASHBOARD.KBPS):e/1024/1024<1?(t.value=e/1024,t.unit=S.su.CHAR.DASHBOARD.KBPS):(t.value=e/1024/1024,t.unit=S.su.CHAR.DASHBOARD.MBPS),t.value=parseFloat(t.value.toFixed(2)),t}}})}(jQuery);