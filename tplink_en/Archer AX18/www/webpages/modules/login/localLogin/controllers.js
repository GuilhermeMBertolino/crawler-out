!function(s){s.su.moduleManager.define("localLogin",{services:["ajax"],models:["localLogin","localLoginControl","vercodeModel","resetPwdModel"],views:["localLoginView"],deps:["login","main"],listeners:{ev_on_launch:function(e,o,n,i,t,l,a){n.localLoginView.noInternetTips.hide(),a.ajax.request({proxy:"keyProxy",success:function(e){e&&e.password&&(o.encryptKey=e.password)}}),l.login.supportCloud()?(n.localLoginView.switchToTp.show(),n.localLoginView.mainPanel.setTitle(s.su.CHAR.LOGIN.LOCAL_LOGIN)):(n.localLoginView.switchToTp.hide(),n.localLoginView.mainPanel.setTitle(s.su.CHAR.LOGIN.LOGIN)),a.ajax.request({proxy:"sysmodeLoginProxy",data:{operation:"read"},success:function(e){"ap"===e.mode?n.localLoginView.switchToTp.hide():n.localLoginView.switchToTp.show()}})}},init:function(n,i,t,e,o,l){this.control({"#local-login-pwd":{keyup:function(e){e.preventDefault(),13==e.keyCode&&(s(e.target).blur(),n.doLogin())}},"#local-login-button":{ev_button_click:function(){n.doLogin()}},".local-login-switch-to-tp":{click:function(e){l.ajax.request({proxy:"loginCheckInternetProxy",method:"read",success:function(e){o.login.goToChildModule("tpLogin")},fail:function(){i.localLoginView.noInternetTips.show(),i.localLoginView.noInternetTips.setText(s.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)},error:function(){i.localLoginView.noInternetTips.show(),i.localLoginView.noInternetTips.setText(s.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)}})}},".local-login-forget-pwd":{mousedown:function(){n.forgetPasswordHandler()}},"#send-code-btn":{ev_button_click:function(){i.localLoginView.sendCodeFailedNote.hide(),l.ajax.request({data:{operation:"read"},proxy:"sendCodeProxy",success:function(e){n.enableConfirm=!0,i.localLoginView.sendCodeBtn.disable(),i.localLoginView.sendCodeBtn.setText(n.receiveCodeTimeCount+s.su.CHAR.LOGIN.SEC),clearInterval(n.countDownTimer),n.countDownTimer=setInterval(function(){0<n.receiveCodeTimeCount?(n.receiveCodeTimeCount--,i.localLoginView.sendCodeBtn.setText(n.receiveCodeTimeCount+s.su.CHAR.LOGIN.SEC)):(clearInterval(n.countDownTimer),n.receiveCodeTimeCount=60,i.localLoginView.sendCodeBtn.enable(),i.localLoginView.sendCodeBtn.setText(s.su.CHAR.LOGIN.SEND))},1e3)},fail:function(){i.localLoginView.sendCodeFailedNote.show()}})}},"#confirm-code-btn":{ev_button_click:function(){n.enableConfirm&&(i.localLoginView.sendCodeFailedNote.hide(),t.vercodeModel.submit({success:function(e){n.vercode=e.vercode,i.localLoginView.forgetPasswordSendCodeMsg.hide(),t.resetPwdModel.password.setValue(),t.resetPwdModel.confirm.setValue(),i.localLoginView.resetPasswordMsg.show()},fail:function(e,o){t.vercodeModel.vercode.setError(),i.localLoginView.confirmCodeOverlimitNote.setText(s.su.CHAR.ERROR[o]),i.localLoginView.confirmCodeOverlimitMsg.show()},error:function(){t.vercodeModel.vercode.setError()}}))}},"#reset-pwd-btn":{ev_button_click:function(){var e;t.resetPwdModel.validate()&&(t.resetPwdModel.password.getValue()!=t.resetPwdModel.confirm.getValue()?t.resetPwdModel.confirm.setError(s.su.CHAR.ERROR["00000080"]):(e=t.resetPwdModel.password.doEncrypt(n.encryptKey),l.ajax.request({proxy:"forgetPasswordProxy",data:{operation:"write",password:e,confirm:!0,vercode:n.vercode},success:function(e){i.localLoginView.resetPasswordMsg.hide()}})))}},"#send-code-content":{ev_view_change:function(e,o){"value"===o.type&&(o=o.value,n.enableConfirm&&o?i.localLoginView.confirmCodeBtn.enable():i.localLoginView.confirmCodeBtn.disable())}},".find-local-pwd-jump-label":{click:function(){n.queryRecoveryPasswordMethod().then(function(e){e?o.login.goToChildModule("localPwdRecovery"):i.localLoginView.noRecoveryMethodMsg.show()})}},"#user-conflict-prompt":{ev_msg_ok:function(){var e=t.localLoginControl.password.doEncrypt(n.encryptKey);t.localLogin.password.setValue(e),t.localLogin.login({data:{operation:"login",confirm:!0},success:n.handleLoginSuccess,fail:n.handleLoginFail,error:n.handleLoginError})}}})}},function(l,a,r,e,t,n){var i=void 0;return{enableConfirm:!1,receiveCodeTimeCount:60,countDownTimer:null,encryptKey:null,vercode:"",doLogin:function(){var e;i||r.localLoginControl.validate()&&(e=r.localLoginControl.password.doEncrypt(l.encryptKey),r.localLogin.password.setValue(e),a.localLoginView.localLoginBtn.loading(!0),l.initEncryptor().then(l.handleLogin))},initEncryptor:function(){var o=s.Deferred();return s.su.encryptor?(n.ajax.requestPromise({proxy:"authProxy"}).then(function(e){s.su.encryptor.setRSAKey(e.key[0],e.key[1]),s.su.encryptor.setSeq(e.seq),s.su.encryptor.genAESKey();e=r.localLoginControl.password.getValue();s.su.encryptor.setHash("admin",e),s.encrypt.encryptManager.recordEncryptor(),o.resolve()}).fail(function(){l.handleLoginError(),o.reject()}),o.promise()):o.resolve()},handleLogin:function(){r.localLogin.login({preventFailEvent:!0,success:l.handleLoginSuccess,fail:l.handleLoginFail,error:l.handleLoginError})},handleLoginSuccess:function(e,o){a.localLoginView.localLoginBtn.loading(!1);var n,i=e.stok||(e="12345",i=top.location.href,n=i.indexOf("stok="),e=0<=n?i.substring(n+5):e);localStorage&&(t.main.setToken(i),t.main.reload())},handleLoginFail:function(e,o){a.localLoginView.localLoginBtn.loading(!1);var n=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&n){n=String(e.data.errorcode).replace(/^-/,"E");r.localLoginControl.password.setErrorHtml(s.su.CHAR.ERROR[n])}else if(o)switch(o){case"user conflict":e.data.logined_user;a.localLoginView.userConflictMsgContent.setText(s.su.CHAR.LOGIN.USER_CONFLICT_MSG),a.localLoginView.userConflictMsg.show();break;case"login failed":s.su.IS_RG_SEC?l.handleSGLoginFailed(e):l.handleDefaultLoginFailed(e);break;case"exceeded max attempts":var i=e.data.failureCount,t=e.data.attemptsAllowed,t=s.su.CHAR.ERROR["00000089"].replace("%num",t+i);a.localLoginView.maxAttemptsMsgContent.setText(t),a.localLoginView.maxAttemptsMsg.show()}},handleLoginError:function(){t.main.reload()},queryRecoveryPasswordMethod:function(){var e=s.Deferred();return e.resolve(!0),e.promise()},forgetPasswordHandler:function(){n.ajax.request({proxy:"forgetPasswordProxy",success:function(e){e&&((e.enable_rec?(a.localLoginView.sendCodeFailedNote.hide(),r.vercodeModel.vercode.setNormal(),r.vercodeModel.vercode.setValue(),a.localLoginView.confirmCodeBtn.disable(),a.localLoginView.forgetPasswordSendCodeMsg):a.localLoginView.forgetPasswordMsg).show(),clearInterval(l.countDownTimer),l.receiveCodeTimeCount=60,a.localLoginView.sendCodeBtn.enable(),a.localLoginView.sendCodeBtn.setText(s.su.CHAR.LOGIN.SEND))}})},handleDefaultLoginFailed:function(e){var o,n=e.data.failureCount,e=e.data.attemptsAllowed;(0===e?(o=s.su.CHAR.ERROR["00000089"].replace("%num",e+n),a.localLoginView.maxAttemptsMsgContent.setText(o),a.localLoginView.maxAttemptsMsg):(e<=n?(o=(o=s.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",n)).replace("%num2",e),a.localLoginView.leftAttemptsMsgContent.setText(o)):a.localLoginView.leftAttemptsMsgContent.setText(s.su.CHAR.LOGIN.LOGIN_FAILED),a.localLoginView.leftAttemptsMsg)).show()},handleSGLoginFailed:function(e){var o=s.su.CHAR.LOGIN.LOGIN_FAILED_SG.replace("10",e.data.failureCount+e.data.attemptsAllowed).replace("%SEC%",e.data.failureCount);r.localLoginControl.password.setError(o),l.disableLoginBtn(e.data.remainTime||2)},disableLoginBtn:function(e){var o=s.su.CHAR.LOGIN.LOGIN_RETRY_SG;a.localLoginView.localLoginBtn.disable(),a.localLoginView.loginRetryNote.setText(o.replace("%SEC%",e)),a.localLoginView.loginRetryNote.show(),i=setInterval(function(){if(!--e)return l.enableLoginBtn();a.localLoginView.loginRetryNote.setText(o.replace("%SEC%",e))},1e3)},enableLoginBtn:function(){clearInterval(i),i=void 0,a.localLoginView.localLoginBtn.enable(),a.localLoginView.loginRetryNote.hide()}}})}(jQuery);