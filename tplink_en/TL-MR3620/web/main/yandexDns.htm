<script language="javascript" type="text/javascript">
var index;
var ruleStack;
var isEdit;
var lanHostListStack;
var ydnsList;
var editStackIndex;

function init() {
    index = 0;
    isEdit = 0;
    ruleStack = [];

    var ruleListHeadArray = [{
        "text": '<div><input type="checkbox" id="checkbox_rule_1" class="table-select-all" /><label></label></div>',
        "width": "10%"
    }, {
        "text": table_str.id,
        "width": "10%"
    }, {
        "text": table_str.mac,
        "width": "25%"
    }, {
        "text": table_str.controlMode,
        "width": "20%"
    }, {
        "text": table_str.description,
        "width": "20%"
    }, {
        "text": table_str.modify,
        "width": "15%"
    }];

    $.initTableHead($("#table_yandexRuleList"), ruleListHeadArray);
    $("#table_yandexRuleList").tpTable(initRuleTable);


    var ruleDevicesListHeadArray = [{
        "text": table_str.id,
        "width": "10%"
    }, {
        "text": table_str.devname,
        "width": "20%"
    }, {
        "text": table_str.ip,
        "width": "20%"
    }, {
        "text": table_str.mac,
        "width": "20%"
    }, {
        "text": table_str.operation,
        "width": "20%"
    }];
    $.initTableHead($("#tableRuleDevicesList"), ruleDevicesListHeadArray);

    ydnsList = $.act(ACT_GL, YANDEX_DNS_POOL, null, null, ["mac", "description", "mode"]);
    var lanHostList = $.act(ACT_GL, LAN_HOST_CFG, null, null, ["X_TP_YandexDnsMode", "X_TP_YandexDnsEnable"]);

    if (!$.exe()) {

        lanHostListStack = lanHostList[0].__stack;

        if (lanHostList[0].X_TP_YandexDnsEnable == "1") {
            $("#enYandexDnsOn").addClass("selected");
        } else {
            $("#enYandexDnsOff").addClass("selected");
        }

        $('#yandexEnMode option[value="' + lanHostList[0].X_TP_YandexDnsMode + '"]').prop('selected', 'selected');
        $("#yandexEnMode").tpSelect({
            refresh: 1
        });

        index = 0;
        $.each(ydnsList, function() {
            index++;
            ruleStack[index - 1] = this.__stack;
        });
    }

    $("#t_viewdev").click(function() {

        $("#ruleDevList").fadeIn(20, function() {
            $("#ruleDevList").removeClass("nd").addClass("on-mask msg-container");
        });
        $("#tableRuleDevicesList").tpTable(initRuleDevicesListTable);
        $.setFixedCentral($("#ruleDevList"));
        $("#mask").show();
    });

    $("#closeDeviceList").click(function() {
        $("#ruleDevList").fadeOut(20, function() {
            $("#ruleDevList").removeClass("on-mask msg-container").addClass("nd");
        });
        $("#mask").hide();
    });

    $("#editOk").on("click", function() {
        $.addLoading($(this));
        saveRule();
    });

    $("#editCancel").click(function() {
        $("#editContainer_yandexRuleList").addClass("nd");
        $("#editContainer_yandexRuleList").removeClass("editor-container");
        $("#table_yandexRuleList").unmask();
        $.reload();
    });

    $("#saveYandex").click(function() {
        $.addLoading($(this));
        var mode = $("#yandexEnMode").data("value");
        var enable = $("#enYandexDnsOn").hasClass("selected") ? "1" : "0";

        $.act(ACT_SET, LAN_HOST_CFG, lanHostListStack, null, ["X_TP_YandexDnsMode=" + mode, "X_TP_YandexDnsEnable=" + enable]);
        $.exe(function(err) {
            $.removeLoading();
            if (!err) {
                $.reload();
            }
        });
    });

    $("#enYandexDnsOn").on("click", function() {
        $.addLoading($(this));
        $.act(ACT_SET, LAN_HOST_CFG, lanHostListStack, null, ["X_TP_YandexDnsEnable=1"]);
        $.exe(function(err) {
            $.removeLoading();
            if (!err) {
                $.removeLoading();
                $.reload();
            }
        });
    });

    $("#enYandexDnsOff").on("click", function() {
        $.addLoading($(this));
        $.act(ACT_SET, LAN_HOST_CFG, lanHostListStack, null, ["X_TP_YandexDnsEnable=0"]);
        $.exe(function(err) {
            $.removeLoading();
            if (!err) {
                $.removeLoading();
                $.reload();
            }
        });
    });

    $("#del_yandexRuleIcon").click(function() {
        $.confirm(c_str.del_choosed, deleteSelEntry, null);
    });

}

function deleteSelEntry() {
    var td = $("#table_yandexRuleList").find("tbody tr td");
    var tr = td.find("span.checkbox-click").parents("tr");

    td.find("span.checkbox-click").each(function() {
        var childStackIndex = $(this).parents("tr").find("td:eq(1)").text();
        if (childStackIndex < 0 || childStackIndex == "") return true;

        $.act(ACT_DEL, YANDEX_DNS_POOL, ydnsList[childStackIndex - 1].__stack, null);

    });
    tr.remove();
    var grid = 0;
    $("#table_yandexRuleList").find("thead tr th").each(function() {
        grid++;
    });
    if (grid == 0) {
        $.addEmptyBody($("#table_yandexRuleList"), grid);
    }
    $.exe(function(err) {
        if (!err) {
            $.reload();
        }
    });
}

function initRuleTable() {

    var array = [];
    var ydnsList = $.act(ACT_GL, YANDEX_DNS_POOL, null, null, ["mac", "description", "mode"]);

    $.exe(function(err) {
        if (err) return;
        $.each(ydnsList, function(index) {
            var ctrlMode;
            if (this.mode == "0") ctrlMode = n_str.yandexDns.c_basic;
            else if (this.mode == "1") ctrlMode = n_str.yandexDns.c_safe;
            else if (this.mode == "2") ctrlMode = n_str.yandexDns.c_child;
            else if (this.mode == "3") ctrlMode = n_str.yandexDns.c_disable;

            array.push([{
                "text": '<div><input type="checkbox" id="' + (index + 1) + '_checkbox_ruleList" class="table-select-one" /><label></label></div>',
                "width": "10%"
            }, {
                "text": index + 1,
                "width": "10%"
            }, {
                "text": this.mac.replace(/\:/g, '-'),
                "width": "25%"
            }, {
                "text": ctrlMode,
                "width": "20%"
            }, {
                "text": $.htmlEncodeStr(this.description),
                "width": "20%"
            }, {
                "text": "<span class='table-grid-icon edit-modify-icon' onClick='doRuleEdit(" + index + ")'></span><span class='table-grid-icon edit-trash-icon yandex-rule-list'></span>",
                "width": "10%"
            }]);
        });
        $.initTableBody($("#table_yandexRuleList"), array);
        $.tablePages($("#table_yandexRuleList"), 5);

        $("span.edit-trash-icon.yandex-rule-list").click(function() {
            var ruleStackIndex = $(this).parents("tr").find("td").eq(1).text();
            $.act(ACT_DEL, YANDEX_DNS_POOL, ruleStack[ruleStackIndex - 1], null);
            $.exe(function(err) {
                if (!err) {
                    $.reload();
                }
            });
        })
    });

    return array;
}

function initRuleDevicesListTable() {
    var array = [];
    var index = 1;
    var deviceOnline = $.act(ACT_GL, LAN_HOST_ENTRY, null, null);

    $.exe(function(err) {
        if (err) return;

        $.each(deviceOnline, function() {
            if (this.active != 1)
                return;

            array.push([{
                "text": index,
                "width": "5%"
            }, {
                "text": $.htmlEncodeStr(this.hostName),
                "width": "10%"
            }, {
                "text": this.IPAddress,
                "width": "10%"
            }, {
                "text": this.MACAddress.replace(/\:/g, '-'),
                "width": "15%"
            }, {
                "text": "<span class='table-grid-icon add-icon'></span>",
                "width": "15%"
            }]);
            index++
        });

        $.initTableBody($("#tableRuleDevicesList"), array);
        $.tablePages($("#tableRuleDevicesList"), 8);

        $("span.add-icon").click(function() {
            var macAddress = $(this).parents("tr:eq(0)").find("td:eq(3)").text();
            var deviceName = $(this).parents("tr:eq(0)").find("td:eq(1)").text();

            $("#deviceMac").tpAddress('val', macAddress);
            $("#ruleDescription").val(deviceName);
            $("#ruleDevList").fadeOut(20, function() {
                $("#ruleDevList").removeClass("on-mask msg-container").addClass("nd");
            });

            $("#mask").hide();
        });
    });
}

function doRuleEdit(index) {
    isEdit = 1;
    editStackIndex = index;
    $("#deviceMac").tpAddress('val', ydnsList[index].mac);
    $("#ruleDescription").val(ydnsList[index].description);
    $('#controlMode').find('option[value=' + ydnsList[index].mode + ']').prop('selected', true);
    $('#controlMode').tpSelect({
        refresh: 1
    });
}

function saveRule() {

    var ctrlMode = $("#controlMode").data("value");
    var macAddr = $("#deviceMac").tpAddress('val');
    var description = $("#ruleDescription").val();

	if (!($.isname(description))) {
        $.alert(ERR_FW_DESC_NAME_INVAD);
		$("#ruleDescription").select();
		$("#ruleDescription").focus();
        return false;
    }
	
    if ($.mac(macAddr, true)) {
        $.alert(ERR_MAC_FORMAT);
        $("#deviceMac").tpAddress('focus');
        return false;
    }
    if (isEdit == 0) {
        $.act(ACT_ADD, YANDEX_DNS_POOL, null, lanHostListStack, ["mac=" + macAddr, "description=" + description, "mode=" + ctrlMode]);
    } else if (isEdit == 1) {
        $.act(ACT_SET, YANDEX_DNS_POOL, ydnsList[editStackIndex].__stack, null, ["mac=" + macAddr, "description=" + description, "mode=" + ctrlMode]);
        isEdit = 0;
    }

    $.exe(function(err) {
        $.removeLoading();
        if (!err) {
            $.reload();
        }
    });
}

function doDel() {

    var td = $("#table_bindingList").find("tbody tr td");

    td.find("span.checkbox-click").each(function() {
        var stackIndex = $(this).parents("tr").find("td:eq(1)").text() - 1;
        if (stackIndex < 0) return true;
        $.act(ACT_DEL, YANDEX_DNS_POOL, ruleStack[stackIndex], null);
        $.exe(function(err) {
            if (!err) $.reload();
        });
    });
}
</script>

<h3 id="t_title1">Settings</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div class="button-group-container" id="enYandexDns">
            <b id="t_en" class="xl">ARP Binding</b>
            <ul>
                <li>
                    <button id="enYandexDnsOn" class="fst" value="on">On</button>
                </li>
                <li>
                    <button id="enYandexDnsOff" class="lst" value="off">Off</button>
                </li>
            </ul>
        </div>
        <b id="t_yandexEnMode" class="xl">enable yandex dns for all devices:</b>
        <select id="yandexEnMode" class="">
            <option class="T_c_disable" value="3">disable</option>
            <option class="T_c_basic" value="0">basic</option>
            <option class="T_c_safe" value="1">safe</option>
            <option class="T_c_child" value="2">child</option>
        </select>
        <button id="saveYandex" type="submit" class="green T_save">Save</button>
    </form>
</div>

<h3 id="t_title2">rule for special device</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div class="table-op" id="yandexRuleList">
            <div class="table-btn">
                <span id="add_yandexRuleIcon" class="add-icon"></span>
                <label class="T_add">Add</label>
                <span id="del_yandexRuleIcon" class="delete-icon"></span>
                <label class="T_del">Delete</label>
            </div>
        </div>
        <table id="table_yandexRuleList">
            <thead></thead>
            <tbody id="body_yandexRuleList">
                <tr id="editContainer_yandexRuleList" class="nd">
                    <td colspan="7">
                        <div>
                            <b class="T_macaddr">Mac Address:</b>
                            <input type="text" id="deviceMac" required class="mac-address" />
                            <div style="display:inline-block;">
                                <button type="submit" class="blue T_scan" id="t_viewdev">Scan</button>
                            </div>
                        </div>
                        <div>
                            <b id="t_ctrlMode">control mode: </b>
                            <select id="controlMode" class="">
                                <option class="T_c_disable" value="3">disable</option>
                                <option class="T_c_basic" value="0">basic</option>
                                <option class="T_c_safe" value="1">safe</option>
                                <option class="T_c_child" value="2">child</option>
                            </select>
                        </div>
                        <div>
                            <b id="t_descrip">description:</b>
                            <input type="text" id="ruleDescription" maxlength="15" />
                            <span class="T_optional">(Optional)</span>
                        </div>
                        <div class="inline-btn-right">
                            <button type="submit" class="green T_cancel" id="editCancel">Cancel</button>
                            <button type="submit" class="green T_save" id="editOk">Save</button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>

        <div>
            <form class="pure-form pure-form-aligned">
                <div id="ruleDevList" class="nd">
                    <div id="closeDeviceList" class="table-op">
                        <div class="table-btn">
                            <span class="close-icon table-icon"></span>
                        </div>
                    </div>
                    <table id="tableRuleDevicesList">
                        <thead>
                            <span id="t_devlist" class="msg-container-title"></span>
                        </thead>
                        <tbody id="bodyRuleDevicesList">
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
</div>

<script language="javascript" type="text/javascript">
$.tpInit(init);
</script>
