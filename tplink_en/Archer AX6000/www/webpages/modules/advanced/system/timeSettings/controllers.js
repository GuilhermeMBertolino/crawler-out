!function(m){m.su.moduleManager.define("timeSettings",{models:["timeSettings","language","daylight","time24Model","autoUpgradeModel"],stores:["languageStore","setTimeHourStore","setTimeMinStore","setTimeSecStore","startMonthStore","startWeekStore","startWeekdayStore","startHourStore","setTimeModeStore","timezoneStore"],services:["ajax","language","time","device","moduleManager"],views:["timeSettingsView"],deps:["main"],listeners:{"ev_on_launch":function(e,t,a,n,i,s,o){this.unRegisterAutoSaveData([n.time24Model]),o.time.on("on_time_change",t.onTimeChange),o.time.on("on_hour24_change",t.onHour24Change),i.languageStore.load({success:function(){var e=o.device.getLocale();t.unRegisterAutoSaveData([n.language]),n.language.language.setValue(e),n.language.language.record(),t.registerAutoSaveData([n.language])}}),n.time24Model.load(),n.timeSettings.load(),n.daylight.load(),o.device.getConfig().supportAutoUpdate&&n.autoUpgradeModel.load({success:function(e){t.autoUpdateEnable=e.enable}})},"ev_before_destroy":function(e,t){t.beforeDestroy()}},init:function(r,u,l,e,t,g){this.listen({"models.time24Model":{"ev_loaded":function(e,t){g.time.setHour24("on"===l.time24Model.hour24Enable.getValue())},"ev_model_submit":function(e,t){g.time.setHour24("on"===l.time24Model.hour24Enable.getValue())}},"models.daylight":{"ev_loaded":function(e){"on"===l.daylight.dstEnable.getValue()||l.daylight.dstStatus.getValue()?l.daylight.dstStatus.show():l.daylight.dstStatus.hide(),r.getTimeFormat()}},"models.timeSettings":{"ev_loaded":function(e,t){var a=t.date.split("/");r.sysTimeYear=parseInt(a[2],10),r.sysTimeHash=r.parseFormat(a[0],2)+r.parseFormat(a[1],2)+r.parseFormat(t.time.split(":")[0],2),r.getTimeFormat()}},"models.timeSettings.type":{"ev_value_change":function(e,t,a){"manual"===t?(u.timeSettingsView.manualFieldset.show(),u.timeSettingsView.internetFieldset.hide(),l.timeSettings.time.enable(),l.timeSettings.date.enable()):"auto"===t?(u.timeSettingsView.manualFieldset.hide(),u.timeSettingsView.internetFieldset.show(),l.timeSettings.time.disable(),l.timeSettings.date.disable()):(u.timeSettingsView.manualFieldset.hide(),u.timeSettingsView.internetFieldset.hide(),l.timeSettings.time.enable(),l.timeSettings.date.enable())}},"models.timeSettings.timezone":{"ev_value_change":function(e,t,a){var n,i,s;null!==a&&(n=l.timeSettings.time.getValue().split(":"),s=parseInt(n[0],10),i=parseInt(n[1],10),i=(s=parseInt(60*s,10)+parseInt(i,10)+parseInt(t,10)-parseInt(a,10))%60,(a=24==(a=24<(t=parseInt(s/60,10))?t-24:t)&&0<i?0:a)<0&&(0==a?a=23:a+=24),i<0&&(i+=60),i<10&&(i="0"+i),s=(a=a<10?"0"+a:a).toString()+":"+i.toString()+":"+n[2],l.timeSettings.time.setValue(s))}},"models.time24Model.hour24Enable":{"ev_value_change":function(e,t,a){a&&a!==t&&l.time24Model.submit()}},"models.daylight.dstEnable":{"ev_value_change":function(e,t,a){"on"===t?u.timeSettingsView.daylightFieldset.show():u.timeSettingsView.daylightFieldset.hide()}},"models.daylight.startMonth":{"ev_value_change":function(e,t,a){r.getTimeFormat()}},"models.daylight.startWeek":{"ev_value_change":function(e,t,a){r.getTimeFormat()}},"models.daylight.startDay":{"ev_value_change":function(e,t,a){r.getTimeFormat()}},"models.daylight.startHour":{"ev_value_change":function(e,t,a){r.getTimeFormat()}},"models.daylight.endMonth":{"ev_value_change":function(e,t,a){r.getTimeFormat()}},"models.daylight.endWeek":{"ev_value_change":function(e,t,a){r.getTimeFormat()}},"models.daylight.endDay":{"ev_value_change":function(e,t,a){r.getTimeFormat()}},"models.daylight.endHour":{"ev_value_change":function(e,t,a){r.getTimeFormat()}}}),this.control({".index-common-save-btn":{"ev_will_auto_save":function(e,t){t.preventDefault();var a,n,i,s=m.Deferred(),o=m.Deferred();l.timeSettings.isDirty()?("pc"===(t=l.timeSettings.type.getValue())?(n=(a=function(e){return e<10?"0"+e:e})((i=new Date).getMonth()+1)+"/"+a(i.getDate())+"/"+a(i.getFullYear()),i=a(i.getHours())+":"+a(i.getMinutes())+":"+a(i.getSeconds()),l.timeSettings.time.setValue(i),l.timeSettings.date.setValue(n),m.when(s).then(function(){g.time.sync()})):"auto"===t?(u.timeSettingsView.ntpStatus.hide(),m.when(s).then(function(){u.timeSettingsView.ntpStatus.show(),u.timeSettingsView.ntpStatus.setLoading(m.su.CHAR.TIMESETTING.GETGMT_WAIT),l.timeSettings.startGmt({success:function(){r.syncGmt(function(e){g.time.sync(),l.daylight.load()})},fail:function(){u.timeSettingsView.ntpStatus.hide()},error:function(){u.timeSettingsView.ntpStatus.hide()}})})):m.when(s).then(function(){g.time.sync()}),l.timeSettings.submit({success:function(){s.resolve()}})):s.resolve(),l.daylight.isDirty()?l.daylight.submit({success:function(){o.resolve()}}):o.resolve(),m.when(s,o).then(function(){l.language.language.isDirty()&&g.language.switchTo(l.language.language.getValue()),l.daylight.load()})}},"#setTimeMode":{"ev_view_change":function(e,t,a){"on"==r.autoUpdateEnable&&"auto"!=a&&("pc"==a?u.timeSettingsView.setTimeCheckMsg.setContent(m.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE1):"manual"==a&&u.timeSettingsView.setTimeCheckMsg.setContent(m.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE2),u.timeSettingsView.setTimeCheckMsg.show())}},"#set-time-check-msg":{"ev_msg_ok":function(e,t){g.moduleManager.get("navigatorController").goTo("firmware")},"ev_msg_no":function(e,t){l.timeSettings.type.setValue("auto")}}})}},function(v,y,p,a,e,n){var i=null;return{autoUpdateEnable:"",sysTimeYear:"2017",sysTimeHash:"",syncGmt:function(e){var t=function(t){n.ajax.request({proxy:"timeSettingsGmtProxy",method:"refresh",success:function(e){if("undefined"==typeof e.status)return y.timeSettingsView.ntpStatus.hide(),clearInterval(i),i=null,!1;switch(parseInt(e.status,10)){case 747301:clearInterval(i),i=null,y.timeSettingsView.ntpStatus.setSuccess(m.su.CHAR.TIMESETTING.GETGMT_SUCCESS),t&&t(e);break;case 747302:clearInterval(i),i=null,y.timeSettingsView.ntpStatus.setFailed(m.su.CHAR.TIMESETTING.GETGMT_TIMEOUT);break;case 747303:y.timeSettingsView.ntpStatus.setLoading(m.su.CHAR.TIMESETTING.GETGMT_WAIT);break;default:clearInterval(i),i=null}}})};clearInterval(i),i=setInterval(function(){t(e)},2e3),t(e)},onTimeChange:function(e,t){var a=n.time.getHour24(),t=n.time.format(t,"yyyy-MM-dd HH:mm:ss",a);y.timeSettingsView.currentTime.setValue(t)},onHour24Change:function(e,t){t?(a.startHourStore.loadData(v.startHour24Data),p.timeSettings.time.setHourSystem("24")):(a.startHourStore.loadData(v.startHourData),p.timeSettings.time.setHourSystem("12"))},clearCurrentTime:function(){clearInterval(i),i=null},beforeDestroy:function(){v.clearCurrentTime(),n.time.off("on_time_change",v.onTimeChange),n.time.off("on_hour24_change",v.onHour24Change)},startHourData:function(){for(var e,t=[],a=0;a<=23;a++)t[e=a]={},0===a?(t[e].name="12:00 AM",t[e].value="12am"):a<=11?(t[e].name=a+":00 AM",t[e].value=a+"am"):12===a?(t[e].name="12:00 PM",t[e].value="12pm"):(t[e].name=a-12+":00 PM",t[e].value=a-12+"pm");return t[0].selected=!0,t}(),startHour24Data:function(){for(var e,t=[],a=0;a<=23;a++)t[e=a]={},t[e].name=("0"+a).slice(-2)+":00",t[e].value=0===a?"12am":a<=11?a+"am":12===a?"12pm":a-12+"pm";return t[0].selected=!0,t}(),parseFormat:function(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e},getTimeFormat:function(){var e=v.sysTimeYear,t=v.sysTimeHash,a=p.daylight.startMonth,n=p.daylight.startWeek,i=p.daylight.startDay,s=p.daylight.startHour,o=p.daylight.endMonth,r=p.daylight.endWeek,u=p.daylight.endDay,l=p.daylight.endHour,g=a.getValue(),m=n.getValue(),d=i.getValue(),s=s.getValue(),c=o.getValue(),h=r.getValue(),S=u.getValue(),l=l.getValue();if(!(g&&m&&d&&s&&c&&h&&S&&l))return!1;var f,g=parseInt(a.getLiIndex(g))+1,a=parseInt(n.getLiIndex(m))+1,m=parseInt(i.getLiIndex(d))+1,n=parseInt(o.getLiIndex(c))+1,d=parseInt(r.getLiIndex(h))+1,i=parseInt(u.getLiIndex(S))+1,c=-1!==s.indexOf("am")?(f=parseInt(s),parseInt(l)):(f=parseInt(s)+12,parseInt(l)+12),o=new Date(e,g,1),h=parseInt(o.getDay()),r=new Date(e,n,1),S=parseInt(r.getDay()),m=7*a-h+m+1+(m<h?7:0),i=7*d-S+i+1+(i<S?7:0),u=v.parseFormat(g,2)+v.parseFormat(m,2)+v.parseFormat(f,2),s=v.parseFormat(n,2)+v.parseFormat(i,2)+v.parseFormat(c,2),l=y.timeSettingsView.daylightStart,o=y.timeSettingsView.daylightEnd;u<s?t<s?(l.setSubLabel(e),o.setSubLabel(e)):(l.setSubLabel(e+1),o.setSubLabel(e+1)):t<s?(l.setSubLabel(e-1),o.setSubLabel(e)):(l.setSubLabel(e),o.setSubLabel(e+1))}}})}(jQuery);