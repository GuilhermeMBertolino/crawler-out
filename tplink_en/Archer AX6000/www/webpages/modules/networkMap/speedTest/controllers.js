!function(i){i.su.moduleManager.define("speedTest",{services:["ajax","device"],models:["statusAll","speedTestControl","speedTestStatusModel"],stores:[],views:["speedTestView","speedTestViewDashboard"],listeners:{"ev_on_launch":function(e,s,t,n,d,o,a){this.unRegisterAutoSaveData([n.speedTestStatusModel]),this.initSpeedtest(),s.getSpeedTestResult({success:function(e){var t=e.testTime;e.upSpeed,e.downSpeed;t&&0!==parseInt(t,10)?s.setSpeedTestResult(e):(n.speedTestControl.speedTestTime.setText("&nbsp;"),n.speedTestControl.speedTestBtn.setText(i.su.CHAR.NETWORK_MAP.SPEED_TEST),s.setDownloadChartSpeed(0),s.setUploadChartSpeed(0))}})},"ev_before_destroy":function(e,t){t.beforeDestroy()}},init:function(n,d,o,e,t,a){this.control({"#speed-test-btn":{"ev_button_click":function(){var e=a.device.getCloudLocale().replace("_","-"),t=o.speedTestStatusModel.isFirst.getValue(),s=o.speedTestStatusModel.expirationTime.getValue();1==t?(o.speedTestStatusModel.isFirst.setValue(!1),t=new Date(s).toLocaleString(e,{year:"numeric",month:"long",day:"numeric"}),s=i.su.CHAR.NETWORK_MAP.UNAVAILABLE_TIP.replace("{date}",t),d.speedTestView.outdateContent.setField("date",s),d.speedTestView.speedTestOutdateMsg.show()):n.isSpeedTesting?n.stopSpeedTest():n.startSpeedTest()}},"#speed-test-history-button":{"ev_button_click":function(){n.getSpeedTestHistory(),o.speedTestControl.speedTestHistoryMsg.show()}},"#speed-test-clear-button":{"ev_button_click":function(){o.speedTestControl.speedTestClearMsg.show()}},"#speed-test-clear-msg":{"ev_msg_ok":function(){n.clearSpeedTestHistory()}},"#speed-test-outdate-msg":{ev_msg_ok:function(){n.modifyStatus(),n.isSpeedTesting?n.stopSpeedTest():n.startSpeedTest()},ev_msg_close:function(){n.modifyStatus()}}}),this.listen({})}},function(o,e,a,t,s,d){var n=null;return{isSpeedTesting:!1,initSpeedtest:function(){this.getEffectiveView();"speedTestView"===this.getEffectiveView()&&(this.initDownloadChart(),this.initUploadChart())},initDownloadChart:function(){a.speedTestControl.speedTestDownload.setOption({name:i.su.CHAR.NETWORK_MAP.DOWNLOAD_SPEED_UPPER,convert:[0,5,10,25,50,100,300,1e3,2500]}),this.setDownloadChartSpeed(0)},initUploadChart:function(){a.speedTestControl.speedTestUpload.setOption({name:i.su.CHAR.NETWORK_MAP.UPLOAD_SPEED_UPPER,convert:[0,5,10,25,50,100,300,1e3,2500]}),this.setUploadChartSpeed(0)},setDownloadChartSpeed:function(e){this.getEffectiveView();switch(this.getEffectiveView()){case"speedTestView":a.speedTestControl.speedTestDownload.setOption({value:this.normalizeSpeed(e),name:i.su.CHAR.NETWORK_MAP.DOWNLOAD_SPEED_UPPER,convert:[0,5,10,25,50,100,300,1e3,2500]});break;case"speedTestViewDashboard":a.speedTestControl.speedTestDownload.setField("value",this.normalizeSpeed(e)),a.speedTestControl.speedTestDownload.setField("unit",i.su.CHAR.NETWORK_MAP.DOWNLOAD_SPEED_UPPER)}o.trigger("ev_download_speed_change",e)},setUploadChartSpeed:function(e){this.getEffectiveView();switch(this.getEffectiveView()){case"speedTestView":a.speedTestControl.speedTestUpload.setOption({value:this.normalizeSpeed(e),name:i.su.CHAR.NETWORK_MAP.UPLOAD_SPEED_UPPER,convert:[0,5,10,25,50,100,300,1e3,2500]});break;case"speedTestViewDashboard":a.speedTestControl.speedTestUpload.setField("value",this.normalizeSpeed(e)),a.speedTestControl.speedTestUpload.setField("unit",i.su.CHAR.NETWORK_MAP.UPLOAD_SPEED_UPPER)}o.trigger("ev_upload_speed_change",e)},getSpeedTestResult:function(e){var t,s,n="readSpeedTestProxy";e&&(t=e.success,s=e.fail,n=e.proxy||n),d.ajax.request({proxy:n,preventSuccessEvent:e.preventSuccessEvent,success:function(e){o.isRunning()&&t&&t(e)},fail:function(e){o.isRunning()&&s&&s(e)}})},clearSpeedTestHistory:function(){o.getSpeedTestResult({proxy:"clearSpeedTestHistoryProxy",success:function(e){o.setSpeedTestHistory(e)}})},getSpeedTestHistory:function(){o.getSpeedTestResult({proxy:"getSpeedTestHistoryProxy",success:function(e){o.setSpeedTestHistory(e)}})},setSpeedTestHistory:function(e){if(i.isArray(e)&&0!==e.length){var t="";t=(t=(t=(t+='<div class="content">')+'<div class="items title">'+('<div class="time-wrapper">'+i.su.CHAR.NETWORK_MAP.TIME+"</div>"))+'<div class="point-wrapper"></div>'+('<div class="download-wrapper">'+i.su.CHAR.NETWORK_MAP.DOWNLOAD+"</div>"))+('<div class="upload-wrapper">'+i.su.CHAR.NETWORK_MAP.UPLOAD+"</div>")+"</div>";for(var s=0,n=e.length;s<n;s++)t=(t=(t=(t=(t+='<div class="items'+(s===e.length-1?" last":"")+'">')+('<div class="time-wrapper"><span class="time">'+o.transformSpeedTestDate(e[s].testTime)+"</span></div>"))+'<div class="point-wrapper"><span class="point"></span></div>'+'<span class="conn-line"></span>')+('<div class="download-wrapper"><span class="download">'+o.transformSpeedUnit(e[s].downSpeed)+" "+i.su.CHAR.NETWORK_MAP.MBPS_2+"</span></div>"))+('<div class="upload-wrapper"><span class="upload">'+o.transformSpeedUnit(e[s].upSpeed)+" "+i.su.CHAR.NETWORK_MAP.MBPS_2+"</span></div>")+"</div>";t+="</div>",i("#speed-test-history-detail").html(t),a.speedTestControl.historyContent.show(),a.speedTestControl.noHistoryContent.hide()}else a.speedTestControl.historyContent.hide(),a.speedTestControl.noHistoryContent.show()},setSpeedTestResult:function(e){var t=o.transformSpeedUnit(e.upSpeed),s=o.transformSpeedUnit(e.downSpeed),n=o.transformSpeedTestTime(e.testTime);a.speedTestControl.speedTestBtn.textAnimate(!1),a.speedTestControl.speedTestBtn.setText(i.su.CHAR.NETWORK_MAP.TEST_AGAIN),"idle"===e.status&&(a.speedTestControl.speedTestTime.setText(i.su.CHAR.NETWORK_MAP.SPEED_TEST_TIME_NOTE.replace("%time%",n)),a.speedTestControl.speedTestChartContainer.show(),a.speedTestControl.speedTestingContainer.hide()),o.setDownloadChartSpeed(s),o.setUploadChartSpeed(t);for(var d=1;d<7;d++)i("#speed-test-result-container").removeClass("result-"+d);s<8?i("#speed-test-result-container").addClass("result-6"):8<=s&&s<15?i("#speed-test-result-container").addClass("result-5"):15<=s&&s<30?i("#speed-test-result-container").addClass("result-4"):30<=s&&s<50?i("#speed-test-result-container").addClass("result-3"):50<=s&&s<100?i("#speed-test-result-container").addClass("result-2"):100<=s&&i("#speed-test-result-container").addClass("result-1")},startSpeedTest:function(){o.isSpeedTesting=!0,clearInterval(n),a.speedTestControl.speedTestBtn.setText(i.su.CHAR.NETWORK_MAP.TESTING),a.speedTestControl.speedTestBtn.textAnimate(),a.speedTestControl.speedTestTime.setText("&nbsp;"),a.speedTestControl.speedTestChartContainer.hide(),a.speedTestControl.speedTestingContainer.show(),i("#speed-test-testing-picture").removeClass("download upload fail"),o.getSpeedTestResult({proxy:"startSpeedTestProxy",success:function(e){n=setInterval(function(){o.continueSpeedTest()},2e3)}})},continueSpeedTest:function(){o.getSpeedTestResult({proxy:"readSpeedTestProxy",success:function(e){"idle"===e.status?(o.isSpeedTesting=!1,clearInterval(n),o.setSpeedTestResult(e)):"fail"===e.status?(i("#speed-test-testing-picture").addClass("fail"),a.speedTestControl.speedTestTime.setText(i.su.CHAR.NETWORK_MAP.SPEED_TEST_FAIL),o.isSpeedTesting=!1,clearInterval(n),o.setSpeedTestResult(e)):"down_test"===e.status?(i("#speed-test-testing-picture").addClass("download"),a.speedTestControl.speedTestTime.setText(i.su.CHAR.NETWORK_MAP.DOWNLOAD_SPEED_TEST),o.setDownloadChartSpeed(o.transformSpeedUnit(e.downSpeed)),o.setUploadChartSpeed(o.transformSpeedUnit(e.upSpeed))):"up_test"===e.status?(i("#speed-test-testing-picture").addClass("upload"),a.speedTestControl.speedTestTime.setText(i.su.CHAR.NETWORK_MAP.UPLOAD_SPEED_TEST),o.setDownloadChartSpeed(o.transformSpeedUnit(e.downSpeed)),o.setUploadChartSpeed(o.transformSpeedUnit(e.upSpeed))):(a.speedTestControl.speedTestTime.setText("&nbsp;"),o.setDownloadChartSpeed(0),o.setUploadChartSpeed(0))},fail:function(){i("#speed-test-testing-picture").addClass("fail"),a.speedTestControl.speedTestTime.setText(i.su.CHAR.NETWORK_MAP.SPEED_TEST_FAIL),o.isSpeedTesting=!1,clearInterval(n),n=null,o.setSpeedTestResult({upSpeed:0,downSpeed:0,testTime:0,status:"fail"})},error:function(){i("#speed-test-testing-picture").addClass("fail"),a.speedTestControl.speedTestTime.setText(i.su.CHAR.NETWORK_MAP.SPEED_TEST_FAIL),o.isSpeedTesting=!1,clearInterval(n),n=null,o.setSpeedTestResult({upSpeed:0,downSpeed:0,testTime:0,status:"fail"})}})},stopSpeedTest:function(){o.getSpeedTestResult({proxy:"stopSpeedTestProxy",success:function(e){o.isSpeedTesting=!1,clearInterval(n),n=null,o.setSpeedTestResult(e)}})},normalizeSpeed:function(e){return isNaN(e)||e<0?0:e},separateSpeed:function(e){var t={};return e/1024<1?(t.value=0===e?0:e/1024,t.unit=i.su.CHAR.NETWORK_MAP.KBPS_2):e/1024/1024<1?(t.value=e/1024,t.unit=i.su.CHAR.NETWORK_MAP.KBPS_2):(t.value=e/1024/1024,t.unit=i.su.CHAR.NETWORK_MAP.MBPS_2),t.value=parseFloat(t.value.toFixed(2)),t},transformSpeedUnit:function(e){return(!e||e<0)&&(e=0),1e3<=(e/=1024)?parseInt(e,10):parseFloat(e.toFixed(2))},transformSpeedTestTime:function(e){var t=0<(t=parseInt((new Date).getTime()/1e3,10)-e)?t:0,s=parseInt(t/86400,10),n=parseInt(t%86400/3600,10),t=parseInt(t%3600/60,10);return 0===parseInt(e,10)?i.su.CHAR.NETWORK_MAP.MINUTE_AGO.replace("%minute%",1):0<s?(1<s?i.su.CHAR.NETWORK_MAP.DAYS_AGO:i.su.CHAR.NETWORK_MAP.DAY_AGO).replace("%day%",s):0<n?(1<n?i.su.CHAR.NETWORK_MAP.HOURS_AGO:i.su.CHAR.NETWORK_MAP.HOUR_AGO).replace("%hour%",n):(1<(t=1<t?t:1)?i.su.CHAR.NETWORK_MAP.MINUTES_AGO:i.su.CHAR.NETWORK_MAP.MINUTE_AGO).replace("%minute%",t)},transformSpeedTestDate:function(e){var e=new Date(1e3*e),t=e.getFullYear(),s=("0"+(e.getMonth()+1)).slice(-2),n=("0"+e.getDate()).slice(-2),d=e.getHours();return t+"-"+s+"-"+n+" "+(12<d?d-12:d)+":"+("0"+e.getMinutes()).slice(-2)+" "+(12<e.getHours()?i.su.CHAR.NETWORK_MAP.PM:i.su.CHAR.NETWORK_MAP.AM)},beforeDestroy:function(){clearInterval(null),clearInterval(n),a.speedTestControl.speedTestBtn.textAnimate(!1)},modifyStatus:function(){a.speedTestStatusModel.getProxy().modifyStatus({data:{operation:"modify_status",is_first:!1}})}}})}(jQuery);