<script language="javascript">function changeMecha(){var e=getValueIpv6();"0"===e.mechanism?($("#wan6_select").hasClass("nd")&&$("#wan6_select").removeClass("nd"),$("#wan_select").hasClass("nd")||$("#wan_select").addClass("nd"),$("#conf_type").hasClass("nd")&&$("#conf_type").removeClass("nd"),$("#dslite_elem").hasClass("nd")&&$("#dslite_elem").removeClass("nd"),$("#6rd_elem").hasClass("nd")||$("#6rd_elem").addClass("nd"),1==dsliteTunnel.dynamic?($("#tunnel_auto").prop("checked",1),$("#tunnel_manual").prop("checked",0)):($("#tunnel_auto").prop("checked",0),$("#tunnel_manual").prop("checked",1))):"1"===e.mechanism?($("#wan6_select").hasClass("nd")||$("#wan6_select").addClass("nd"),$("#wan_select").hasClass("nd")&&$("#wan_select").removeClass("nd"),$("#conf_type").hasClass("nd")&&$("#conf_type").removeClass("nd"),$("#dslite_elem").hasClass("nd")||$("#dslite_elem").addClass("nd"),$("#6rd_elem").hasClass("nd")&&$("#6rd_elem").removeClass("nd"),1==sit6rdTunnel.dynamic?($("#tunnel_auto").prop("checked",1),$("#tunnel_manual").prop("checked",0)):($("#tunnel_auto").prop("checked",0),$("#tunnel_manual").prop("checked",1))):"2"===e.mechanism&&($("#wan6_select").hasClass("nd")||$("#wan6_select").addClass("nd"),$("#wan_select").hasClass("nd")&&$("#wan_select").removeClass("nd"),$("#conf_type").hasClass("nd")||$("#conf_type").addClass("nd"),$("#dslite_elem").hasClass("nd")||$("#dslite_elem").addClass("nd"),$("#6rd_elem").hasClass("nd")||$("#6rd_elem").addClass("nd")),$("#tunnel_auto").tpRadio(),$("#tunnel_manual").tpRadio()}function changeType(e){"0"===e.mechanism?$("#tunnel_raddr").prop("disabled",!e.type):"1"===e.mechanism&&($("#masklen").prop("disabled",!e.type),$("#pre").prop("disabled",!e.type),$("#prelen").prop("disabled",!e.type),$("#relayaddr").tpAddress("disabled",!e.type))}function sync(e){!function(e){$("#tunnel_mecha").prop("disabled",e),$("#tunnel_wan6inf").prop("disabled",e),$("#tunnel_waninf").prop("disabled",e),$("#tunnel_mecha").tpSelect({refresh:1}),$("#tunnel_wan6inf").tpSelect({refresh:1}),$("#tunnel_waninf").tpSelect({refresh:1}),$("#tunnel_auto").prop("disabled",e),$("#tunnel_manual").prop("disabled",e),$("#tunnel_raddr").prop("disabled",e),$("#tunnel_auto").tpRadio(),$("#tunnel_manual").tpRadio()}(!e.en)}function getValueIpv6(){var e={};return e.en=$("#tunnelen").prop("data-checked")?1:0,e.type=$("#tunnel_auto").prop("checked")?0:1,e.mechanism=$("#tunnel_mecha").data("value"),e.mechanism=void 0===e.mechanism?"0":e.mechanism,e}function validDomain(e){seg=e.split(".");for(var n=0;n<seg.length;n++)if(seg[n].length<=2){if(null==seg[n].match(/^[a-z0-9]{1,2}$/i))return!1}else if(null==seg[n].match(/^[a-z0-9][a-z0-9\-]+[a-z0-9]$/i))return!1;return!0}function checkDSLiteAttr(e){if(!$.isValidGLUIP6AddrStrict(e.remoteIPv6Address)&&0==validDomain(e.remoteIPv6Address)){$.removeLoading($.id("saveBtn"));var n=$.id("raddr");return n&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_DSLITE_REMOTE_INVALID),!1}return!0}function check6rdAttr(e){if($.num(e.IPv4MaskLen,[0,32],!0))return $.removeLoading($.id("saveBtn")),(n=$.id("masklen"))&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_6RD_IP_MASK_LEN_INVALID),!1;if(!isValidIP6Prefix(e.prefix))return $.removeLoading($.id("saveBtn")),(n=$.id("pre"))&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_6RD_PREFIX_INVALID),!1;if(32-parseInt(e.IPv4MaskLen)+parseInt(e.prefixLen)>64){$.removeLoading($.id("saveBtn"));var n=$.id("prelen");return n&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_6RD_PREFIX_LEN_INVALID),!1}return!$.ifip(e.borderRelayIPv4Address,!0)||($.removeLoading($.id("saveBtn")),$("#relayaddr").tpAddress("focus"),$.alert(ERR_TUNNEL6_6RD_BR_INVALID),!1)}function isValidIP6Prefix(e){var n=0,a=!0,t=0;if(regExp=/::/,a)if(regExp.test(e))if(regExp=/^([a-f]|[A-F]|[0-9])*(::)([a-f]|[A-F]|[0-9])*(::)([a-f]|[A-F]|[0-9])*$/,regExp.test(e))a=!1;else{var l=e.indexOf("::"),n=e.length,s=e.substr(0,l),i=e.substr(l+2,n-l-2);regExp=/^(([a-f]|[A-F]|[0-9]){1,4}(:)){0,6}([a-f]|[A-F]|[0-9]){1,4}$/;t=0;if(""==s&&""==i)a=!1;else if(""==i)regExp.test(s)||(a=!1);else if(""==s)regExp.test(i)||(a=!1);else if(regExp.test(s)&&regExp.test(i)){if(regExp.test(s)&&regExp.test(i)){for(r=0;r<s.length;r++)":"==s.charAt(r)&&(t+=1);for(var r=0;r<i.length;r++)":"==s.charAt(r)&&(t+=1);t>5&&(a=!1)}}else a=!1}else regExp=/^(([a-f]|[A-F]|[0-9]){1,4}(:)){7}([a-f]|[A-F]|[0-9]){1,4}$/,regExp.test(e)||(a=!1);return a}function initWan(){for(var e=0,n=$("#tunnel_waninf"),a=0;a<wanIpList.length;a++)if(1!=$.isSpecialConnection(wanIpList[a])&&1==wanIpList[a].enable&&1==wanIpList[a].X_TP_IPv4Enabled&&"IP_Bridged"!=wanIpList[a].connectionType&&0==wanIpList[a].X_TP_IPv6Enabled){(l={}).value=wanIpList[a].__stack,l.text=wanIpList[a].name,n.append("<option value='ip:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanIpList[a].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}for(t=0;t<wanPppList.length;t++)if(1!=$.isSpecialConnection(wanPppList[t])&&1==wanPppList[t].enable&&1==wanPppList[t].X_TP_IPv4Enabled&&0==wanPppList[t].X_TP_IPv6Enabled){(l={}).value=wanPppList[t].__stack,l.text=wanPppList[t].name,n.append("<option value='ppp:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanPppList[t].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}for(t=0;t<wanPptpConList.length;t++)if(1==wanPptpConList[t].enable&&"Connected"==wanPptpConList[t].connectionStatus){(l={}).value=wanPptpConList[t].__stack,l.text=wanPptpConList[t].name,n.append("<option value='pptp:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanPptpConList[t].ifName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}for(var t=0;t<wanL2tpConList.length;t++)if(1==wanL2tpConList[t].enable&&"Connected"==wanL2tpConList[t].connectionStatus){(l={}).value=wanL2tpConList[t].__stack,l.text=wanL2tpConList[t].name,n.append("<option value='l2tp:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanL2tpConList[t].ifName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}if(0==e){var l={};l.value=0,l.text=noInterface,n.append("<option value='"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}}$("#tunnel_waninf option").eq(n.selectedIndex).prop("selected","selected")}function initWan6(){for(var e=0,n=$("#tunnel_wan6inf"),a=0;a<wanIpList.length;a++)if(1!=$.isSpecialConnection(wanIpList[a])&&1==wanIpList[a].enable&&1==wanIpList[a].X_TP_IPv6Enabled&&0==wanIpList[a].X_TP_IPv4Enabled){(l={}).value=wanIpList[a].__stack,l.text=wanIpList[a].name,n.append("<option value='ip:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanIpList[a].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}for(var t=0;t<wanPppList.length;t++)if(1!=$.isSpecialConnection(wanPppList[t])&&1==wanPppList[t].enable&&1==wanPppList[t].X_TP_IPv6Enabled&&0==wanPppList[t].X_TP_IPv4Enabled){(l={}).value=wanPppList[t].__stack,l.text=wanPppList[t].name,n.append("<option value='ppp:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanPppList[t].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}if(0==e){var l={};l.value=0,l.text=noInterface,n.append("<option value='"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}}$("#tunnel_wan6inf option").eq(n.selectedIndex).prop("selected","selected")}function chkConnConflict(e,n){return e.X_TP_IfName==n.associatedWanIfName?0==n.mechanism&&1==e.X_TP_IPv4Enabled?($.alert(ERR_TUNNEL6_DSLITE_WAN_CONN_ERR),2):0!=n.mechanism&&1==e.X_TP_IPv6Enabled?($.alert(1==n.mechanism?ERR_TUNNEL6_6RD_WAN_CONN_ERR:ERR_TUNNEL6_6TO4_WAN_CONN_ERR),2):1:0}function initTunnel(){mainTunnel=$.act(ACT_GET,IP6_TUNNEL,null,null),dsliteTunnel=$.act(ACT_GET,DSLITE,null,null),sit6rdTunnel=$.act(ACT_GET,SIT_6RD,null,null),wanIpList=$.act(ACT_GL,WAN_IP_CONN,null,null),wanPppList=$.act(ACT_GL,WAN_PPP_CONN,null,null),INCLUDE_L2TP&&(wanL2tpConList=$.act(ACT_GL,WAN_L2TP_CONN,null,null)),INCLUDE_PPTP&&(wanPptpConList=$.act(ACT_GL,WAN_PPTP_CONN,null,null)),$.exe(function(e){if(!e&&(initWan(),initWan6(),$("#tunnelen").prop("checked",1==mainTunnel.enabled?1:0),$("#tunnel_raddr").val(dsliteTunnel.remoteIPv6Address?dsliteTunnel.remoteIPv6Address:"::"),$("#masklen").val(sit6rdTunnel.IPv4MaskLen),$("#pre").val(sit6rdTunnel.prefix?sit6rdTunnel.prefix:"::"),$("#prelen").val(sit6rdTunnel.prefixLen),$("#relayaddr").tpAddress("val",sit6rdTunnel.borderRelayIPv4Address?sit6rdTunnel.borderRelayIPv4Address:"0.0.0.0"),0==mainTunnel.mechanism?($("#t_dslite").prop("selected",1),$("#tunnel_auto").prop("checked","0"===dsliteTunnel.dynamic?0:1)):1==mainTunnel.mechanism?($("#t_6rd").prop("selected",1),$("#tunnel_auto").prop("checked","0"===sit6rdTunnel.dynamic?0:1)):2==mainTunnel.mechanism&&$("#t_6to4").prop("selected",1),$("#tunnelen").tpCheckbox(),sync(getValueIpv6()),changeType(getValueIpv6()),1==mainTunnel.enabled)){for(n=0;n<wanIpList.length;n++)if(0!=chkConnConflict(wanIpList[n],mainTunnel))return;for(var n=0;n<wanPppList.length;n++)if(0!=chkConnConflict(wanPppList[n],mainTunnel))return}})}function init(){initTunnel(),changeMecha(),sync(getValueIpv6()),$("#tunnelen").click(function(){sync(getValueIpv6())}),$("#tunnel_mecha").on("click",function(){changeMecha(),changeType(getValueIpv6())}),$("#tunnel_auto").click(function(){changeType(getValueIpv6())}),$("#tunnel_manual").click(function(){changeType(getValueIpv6())})}function save(){var e,n,a={},t={},l={};if(a.enabled=1==$("#tunnelen").prop("checked")?1:0,0==$("#tunnel_mecha").data("value")){if(a.mechanism=0,!(e=$("#tunnel_wan6inf").data("text"))||e==noInterface)return $.removeLoading(),void $.alert(ERR_IP6_WAN_CONN_NONE);for(i=0;i<wanIpList.length;i++)wanIpList[i].name==e&&(a.associatedWanIfName=wanIpList[i].X_TP_IfName,a.localAddress=wanIpList[i].X_TP_ExternalIPv6Address);for(i=0;i<wanPppList.length;i++)wanPppList[i].name==e&&(a.associatedWanIfName=wanPppList[i].X_TP_IfName,a.localAddress=wanPppList[i].X_TP_ExternalIPv6Address)}else if(1==$("#tunnel_mecha").data("value")){if(a.mechanism=1,!(n=$("#tunnel_waninf").data("text"))||n==noInterface)return $.removeLoading(),void $.alert(ERR_IP6_WAN_CONN_NONE);for(i=0;i<wanIpList.length;i++)if(wanIpList[i].name==n){if(1==$("#tunnel_auto").prop("checked")&&"Static"==wanIpList[i].addressingType)return $.removeLoading(),void $.alert(ERR_TUNNEL6_6RD_NOT_SUPPORT_AUTO);a.associatedWanIfName=wanIpList[i].X_TP_IfName,a.localAddress=wanIpList[i].externalIPAddress;break}for(i=0;i<wanPppList.length;i++)if(wanPppList[i].name==n){if(1==$("#tunnel_auto").prop("checked"))return $.removeLoading(),void $.alert(ERR_TUNNEL6_6RD_NOT_SUPPORT_AUTO);a.associatedWanIfName=wanPppList[i].X_TP_IfName,a.localAddress=wanPppList[i].externalIPAddress;break}}else if(2==$("#tunnel_mecha").data("value")){if(a.mechanism=2,!(n=$("#tunnel_waninf").data("text"))||n==noInterface)return $.removeLoading(),void $.alert(ERR_IP6_WAN_CONN_NONE);for(i=0;i<wanIpList.length;i++)if(wanIpList[i].name==n){a.associatedWanIfName=wanIpList[i].X_TP_IfName,a.localAddress=wanIpList[i].externalIPAddress;break}for(i=0;i<wanPppList.length;i++)if(wanPppList[i].name==n){a.associatedWanIfName=wanPppList[i].X_TP_IfName,a.localAddress=wanPppList[i].externalIPAddress;break}for(i=0;i<wanPptpConList.length;i++)if(wanPptpConList[i].name==n){a.associatedWanIfName=wanPptpConList[i].ifName,a.localAddress=wanPptpConList[i].externalIPAddress;break}for(i=0;i<wanL2tpConList.length;i++)if(wanL2tpConList[i].name==n){a.associatedWanIfName=wanL2tpConList[i].ifName,a.localAddress=wanL2tpConList[i].externalIPAddress;break}}for(var s=0,i=0;0==s&&i<wanIpList.length;i++)if(2==(s=chkConnConflict(wanIpList[i],a)))return void $.removeLoading();for(i=0;0==s&&i<wanPppList.length;i++)if(2==(s=chkConnConflict(wanPppList[i],a)))return void $.removeLoading();2==a.mechanism&&$.act(ACT_SET,SIT_6RD,null,null,["enabled=0"]),$.act(ACT_SET,IP6_TUNNEL,null,null,a),$.exe(function(e){if(e)return $.removeLoading(),!1;if(0==$("#tunnel_mecha").data("value")){if(n=1==$("#tunnel_auto").prop("checked")?1:0,1==a.enabled){for(s=0;s<wanIpList.length;s++)if(wanIpList[s].X_TP_IfName==a.associatedWanIfName){$.act(ACT_SET,WAN_IP_CONN,wanIpList[s].__stack,null,["X_TP_DSLiteEnabled="+n]);break}for(s=0;s<wanPppList.length;s++)if(wanPppList[s].X_TP_IfName==a.associatedWanIfName){$.act(ACT_SET,WAN_PPP_CONN,wanPppList[s].__stack,null,["X_TP_DSLiteEnabled="+n]);break}}if(t.dynamic=n,0==t.dynamic&&(t.remoteIPv6Address=$("#tunnel_raddr").val(),!checkDSLiteAttr(t)))return;t.enabled=1,l.enabled=0}else if(1==$("#tunnel_mecha").data("value")){var n;if(n=1==$("#tunnel_auto").prop("checked")?1:0,1==a.enabled)for(var s=0;s<wanIpList.length;s++)if(wanIpList[s].X_TP_IfName==a.associatedWanIfName){$.act(ACT_SET,WAN_IP_CONN,wanIpList[s].__stack,null,["X_TP_Sit6rdEnabled="+n]);break}if(l.dynamic=n,0==l.dynamic&&(l.IPv4MaskLen=$("#masklen").val(),l.prefix=$("#pre").val(),l.prefixLen=$("#prelen").val(),l.borderRelayIPv4Address=$("#relayaddr").tpAddress("val"),!check6rdAttr(l)))return;t.enabled=0,l.enabled=1}else 2==$("#tunnel_mecha").data("value")&&(t.enabled=0,l.enabled=0);$.act(ACT_SET,DSLITE,null,null,t),$.act(ACT_SET,SIT_6RD,null,null,l),$.exe(function(e){if(e)return $.removeLoading(),!1;$.removeLoading(),$.reload()})})}var noInterface=$.tpLang.ipv6Tunnel_nstr.t_noInterface?$.tpLang.ipv6Tunnel_nstr.t_noInterface:"No available interface.";$("#t_save").on("click",function(e){$.addLoading($(this)),save()})</script>
<h3 id="t_et">IPv6 Tunnel</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <p>
            <span class="" id="t_note">You must reconfigure this page after rebooting the device. And you must also make sure that the WAN connection you want to use is connected before you configure the tunnel.</span>
        </p>

        <div>
            <b id="t_tunnel">IPv6 Tunnel:</b>
            <input type="checkbox" id="tunnelen">
            <label class="T_en">Enable</label>
        </div>

        <div id="con2">
            <b id="t_mech">Mechanism:</b>
            <select id="tunnel_mecha" class="xxl">
                <option value="0" class="" id="t_dslite">DS-Lite</option>
                <option value="1" class="" id="t_6rd">6RD</option>
                <option value="2" class="" id="t_6to4">6to4</option>
            </select>
        </div>

        <div id="wan6_select">
            <b id="t_wan6">WAN Connection:</b>
            <select id="tunnel_wan6inf" class="xxl"></select>
        </div>

        <div id="wan_select">
            <b id="t_wan">WAN Connection:</b>
            <select id="tunnel_waninf" class="xxl"></select>
        </div>

        <div id="conf_type">
            <b id="t_conftype">Configuration Type:</b>
            <input name="t_tunnel_conf" type="radio" id="tunnel_auto">
            <label class="T_auto">Auto</label>
            <input name="t_tunnel_conf" type="radio" id="tunnel_manual">
            <label id="t_manual">Manual</label>
        </div>

        <div id="dslite_elem">
            <b id="t_remote">Remote IPv6 Address:</b>
            <input type="text" id="tunnel_raddr">
        </div>

        <div id="6rd_elem" class="nd">
            <div>
                <b id="t_masklen">IPv4 Mask Length:</b>
                <input type="text" id="masklen">
            </div>

            <div>
                <b id="t_6rdpfx">6RD Prefix:</b>
                <input type="text" id="pre">
            </div>

            <div>
                <b id="t_6rdplen">6RD Prefix Length:</b>
                <input type="text" id="prelen">
            </div>

            <div>
                <b id="t_braddr">Border Relay IPv4 Address:</b>
                <input type="text" id="relayaddr" class="ip-address">
            </div>
        </div>

        <div id="bSave">
            <button type="submit" class="green T_save" id="t_save">Save</button>
        </div>

    </form>
</div>

<script language="javascript">$.tpInit(init)</script>
