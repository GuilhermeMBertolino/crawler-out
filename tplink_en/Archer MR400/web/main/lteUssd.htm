<script language="javascript">function init(){relaseSession();var s,e=$.act(ACT_GL,LTE_WAN_CFG,null,null,["dataSwitchStatus"]),n=$.act(ACT_GL,WAN_COMMON_INTF_CFG,null,null,["WANAccessType"]),t={},a={};if(INCLUDE_USSD_DIAGNOSIS&&($("#diagnosisDiv").removeClass("nd"),$("#diagnosisHeader").removeClass("nd")),$("#loading").css("display","none"),!$.exe()&&($.each(n,function(){"LTE"==this.WANAccessType&&(s=this.__stack)}),$.each(e,function(){var e=$.stkPop(this.__stack,1);s==e&&(t=$.act(ACT_GET,LTE_WAN_CFG,this.__stack,null,["networkPreferredMode"]),a=$.act(ACT_GET,WAN_LTE_LINK_CFG,this.__stack,null,["simStatus"]),profCfg=$.act(ACT_GET,LTE_PROF_STAT,this.__stack,null,["ispMcc","ispMnc"]))}),!$.exe())){if(a.simStatus!=simStatus.prepared&&a.simStatus!=simStatus.unlocked)return disableButton(),void showDisableNote(ERR_LTE_USSD_SIM_ERROR);if(!checkUssdSupport(profCfg.ispMcc,profCfg.ispMnc))return disableButton(),void showDisableNote(ERR_LTE_USSD_ISP_NOT_SUPPORT);if(t.networkPreferredMode==MODE_4G_ONLY)return disableButton(),void showDisableNote(ERR_LTE_USSD_4G_ONLY_NOT_SUPPORT)}disableCancel()}function doEscapeChar(s){for(var e="",n=0;n<s.length;n++)18==s.charCodeAt(n)?e+="\n":17==s.charCodeAt(n)?e+="\r":e+=s[n];return e}function disableButton(){$("#send").prop("disabled",!0),$("#cancel").prop("disabled",!0),$("#ussdRequest").prop("disabled",!0)}function disableSend(){$("#send").prop("disabled",!0)}function enableSend(){$("#send").prop("disabled",!1)}function disableCancel(){$("#cancel").prop("disabled",!0)}function enableCancel(){$("#cancel").prop("disabled",!1)}function showDisableNote(s){$("#ussdDisabledNote").removeClass("nd"),$("#ussdDisabledReason").html(e_str[s])}function checkUssdSupport(s,e){var n=[{mcc:"416",mnc:"77"},{mcc:"652",mnc:"2"},{mcc:"624",mnc:"2"},{mcc:"646",mnc:"2"},{mcc:"605",mnc:"1"},{mcc:"612",mnc:"3"},{mcc:"611",mnc:"1"},{mcc:"630",mnc:"86"},{mcc:"340",mnc:"1"},{mcc:"608",mnc:"1"},{mcc:"602",mnc:"1"},{mcc:"632",mnc:"3"},{mcc:"614",mnc:"4"},{mcc:"610",mnc:"2"},{mcc:"613",mnc:"2"},{mcc:"618",mnc:"7"},{mcc:"460",mnc:"1"}],t=!1;return $.each(n,function(){if(this.mcc==s&&this.mnc==e)return t=!0,!1}),t=!0,0==s&&0==e&&(t=!1),t}function checkUssdCmd(s){return/^[\*\#]{0,3}([0-9]+[\*\#]{0,2})*$/.test(s)}function relaseSession(){$.act(ACT_SET,LTE_USSD,null,null,[USSD_CANCEL_ACTION]),$.exe(null,null,!0)}function updateSendStatus(){if(1==ussdCancelFlag)return $("#loading").css("display","none"),disableCancel(),enableSend(),void(ussdCancelFlag=!1);if(ussdRes=$.act(ACT_GET,LTE_USSD,null,null,["sessionStatus","sendResult","response","ussdStatus"]),$.exe(),ussdRes.sendResult==USSD_SEND_RESULT.FAILED)return $("#loading").css("display","none"),disableCancel(),void enableSend();if(ussdSessionFlag&&ussdRes.sendResult==USSD_SEND_RESULT.SUCCESS)return ussdSessionFlag=!1,$("#loading").css("display","none"),void(ussdRes.sessionStatus==USSD_SESSION_STATUS.active?(enableCancel(),enableSend()):(disableCancel(),enableSend()));if(checkTimes++>=maxCheckTime)return $.lteSmsTips(0,s_str.ussdTimeout,4e3),$("#loading").css("display","none"),disableCancel(),enableSend(),void(checkTimes=0);if(ussdRes.sendResult==USSD_SEND_RESULT.SUCCESS)switch(ussdRes.ussdStatus){case USSD_STATUS.waiting:setTimeout(function(){updateSendStatus()},1e3);break;case USSD_STATUS.received:$("#ussdRequest").val(""),$("#ussdResult").val(doEscapeChar(ussdRes.response)),ussdSessionFlag=!0,updateSendStatus();break;case USSD_STATUS.terminatedByNetwork:$("#ussdRequest").val(""),$("#ussdResult").val(""),$.lteSmsTips(0,s_str.ussdTerminated,4e3),ussdSessionFlag=!0,updateSendStatus();break;case USSD_STATUS.notSupported:$("#ussdRequest").val(""),$("#ussdResult").val(""),$.lteSmsTips(0,s_str.ussdNotSupported,4e3),ussdSessionFlag=!0,updateSendStatus();break;case USSD_STATUS.timeout:$("#ussdRequest").val(""),$("#ussdResult").val(""),$.lteSmsTips(0,s_str.ussdTimeout,4e3),ussdSessionFlag=!0,updateSendStatus();break;case USSD_STATUS.error:default:$("#ussdRequest").val(""),$("#ussdResult").val(""),$.lteSmsTips(0,s_str.ussdSendFail,4e3),ussdSessionFlag=!0,updateSendStatus()}else setTimeout(function(){updateSendStatus()},1e3)}var MODE_4G_ONLY=2,USSD_SESSION_STATUS={idle:0,active:1},USSD_STATUS={waiting:"0",received:"1",terminatedByNetwork:"2",notSupported:"3",timeout:"4",error:"5"},firstLoad=!0,checkTimes=0,maxCheckTime=60,ussdSessionFlag=!1,ussdCancelFlag=!1,simStatus={prepared:3,unlocked:5},USSD_SEND_RESULT={SUCCESS:1,FAILED:0},USSD_ACTION={GET_CONFIG:0,SEND_USSD:1,CANCEL_USSD:2,GET_USSD_RESULT:3},USSD_GET_CONFIG_ACTION="action="+USSD_ACTION.GET_CONFIG,USSD_SEND_ACTION="action="+USSD_ACTION.SEND_USSD,USSD_CANCEL_ACTION="action="+USSD_ACTION.CANCEL_USSD,USSD_GET_RESULT_ACTION="action="+USSD_ACTION.GET_USSD_RESULT,ussdRes;$("#send").click(function(){var s=$("#ussdRequest").prop("value");return checkUssdCmd(s)&&""!=s&&s.length<160?($("#ussdResult").prop("value",""),enableCancel(),disableSend(),checkTimes=0,$("#loading").css("display","inline-block"),$.act(ACT_SET,LTE_USSD,null,null,[USSD_SEND_ACTION,"reqContent="+s]),$.exe(function(s){updateSendStatus()}),!0):($.alert(ERR_LTE_USSD_CMD_INVALID),$("#ussdResult").prop("value",""),!1)}),$("#cancel").click(function(){$("#ussdRequest").prop("value",""),$("#ussdResult").prop("value",""),$("#loading").css("display","none"),relaseSession(),ussdCancelFlag=!0}),$("#diagnosis").click(function(){document.getElementById("backupUssdLog").submit()}),$.tpInit(init)</script>

<h3 id="t_et">USSD</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
    	<div class="nd" id="ussdDisabledNote">
            <span class="inline" style="color:#00a3df" id="c_note">Note:&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <span id="ussdDisabledReason">Unknown Reason.</span>
            <br><br>
		</div>
        <div class="pure-control-group">
			<b id="c_request" class="m">USSD Request:</b>
			<input type="text" id="ussdRequest">
        </div>
        <div style="text-align:right" class="part-separate">
            <span class="blue inline" style="background:url(../img/loading.gif);height:20px;width:20px" id="loading"></span>
            <button type="submit" class="blue inline T_send" id="send">Send</button>
            <button type="submit" class="blue inline T_cancel" id="cancel">Cancel</button>
        </div>
        <div class="pure-control-group">
                <div class="edit-msg-left-wrap inline">
                    <label id="c_result" class="label-title m" style="vertical-align:top">USSD Result:</label>
                </div>
                <div class="edit-msg-right-wrap inline">
                    <textarea type="text" readonly="readonly" class="lte-textarea" rows="10" cols="65" id="ussdResult" maxlength="765"></textarea>
                </div>
        </div>
    </form>
</div>

<h3 class="nd" id="diagnosisHeader">Diagnosis</h3>
<div class="content-container nd" id="diagnosisDiv">
    <form class="pure-form pure-form-aligned" action="/cgi/ussd.log" id="backupUssdLog">
        <p class="cfg-line" id="t_saveussdlog">Save USSD log (TEST ONLY)</p>
        <button type="submit" class="green" id="diagnosis">Save</button>
    </form>
</div>
