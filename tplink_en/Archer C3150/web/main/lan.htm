<script type="text/javascript">
/* This file is from dhcp.htm, for ac3200 */
var brLanList;
var brStackList = "";
var brNameList = "";

if (INCLUDE_LINK_AGGREGATION && !(INCLUDE_SMART_DHCP && $.routerMode == 'AP'))
{
	var iptvobj;
}

var hasGroup;

function initDhcpTableEdit() {
    if (!$.exe()) {
		$.loadPage("dhcpEditPage", "lanEdit.htm", function() {}, function() {
			$("#dhcpEditPage").removeClass('nd');
		});
    }
}

function init() {
    brLanList = $.act(ACT_GL, L2_BRIDGING_ENTRY, null, null, ["bridgeName"]);
    if (!$.exe()) {
        $.each(brLanList, function() {
            var brParts = (this.__stack).split(",");
            brStackList += brParts[0] + ",";
            brNameList += this.bridgeName + ",";
        });
    }
    $("#tableDchp").tpTable(initDhcpTableEdit);
    if (INCLUDE_LINK_AGGREGATION && !(INCLUDE_SMART_DHCP && $.routerMode == 'AP'))
	{
		$("#t_linkaggTitle").removeClass("nd");
		linkAggInit();
	}
}

if (INCLUDE_LINK_AGGREGATION && !(INCLUDE_SMART_DHCP && $.routerMode == 'AP')) {
    function doGet(obj) {

        iptvobj = $.act(ACT_GET, ETH_IPTV_CFG);
        var ret = $.exe();

        if (!ret) {
            obj.en = iptvobj.enable;
            obj.aggEnable = iptvobj.aggEnable;
            obj.aggMode = iptvobj.aggMode;
            obj.LAN1CONF = iptvobj.LAN1CONF;
            obj.LAN2CONF = iptvobj.LAN2CONF;
            obj.LAN3CONF = iptvobj.LAN3CONF;
            obj.LAN4CONF = iptvobj.LAN4CONF;
        }
        return ret;
    }

    function fillPort(obj) {
        if (obj.LAN1CONF == 3) {
            $("#aggPort1").prop("checked", true);
        }
        else if (obj.LAN1CONF == 0) {
            $("#aggPort1").prop("checked", false);
        }
        else {
            $("#aggPort1").prop("disabled", true);
        }

        if (obj.LAN2CONF == 3) {
            $("#aggPort2").prop("checked", true);
        }
        else if (obj.LAN2CONF == 0) {
            $("#aggPort2").prop("checked", false);
        }
        else {
            $("#aggPort2").prop("disabled", true);
        }

        if (obj.LAN3CONF == 3) {
            $("#aggPort3").prop("checked", true);
        }
        else if (obj.LAN3CONF == 0) {
            $("#aggPort3").prop("checked", false);
        }
        else {
            $("#aggPort3").prop("disabled", true);
        }

        if (obj.LAN4CONF == 3) {
            $("#aggPort4").prop("checked", true);
        }
        else if (obj.LAN4CONF == 0) {
            $("#aggPort4").prop("checked", false);
        }
        else {
            $("#aggPort4").prop("disabled", true);
        }

        $("#aggPort1").data("tpCheckbox").refresh();
        $("#aggPort2").data("tpCheckbox").refresh();
        $("#aggPort3").data("tpCheckbox").refresh();
        $("#aggPort4").data("tpCheckbox").refresh();
    }

    function doFill(obj) {
        /* iptv and link agg should not be enabled at the same time */
        if (obj.en == true) {
            $("#linkAggDis").addClass("selected");
            $("#linkAggEn").removeClass("selected");

            $('#linkAggBut').addClass('disabled');
            $("#aggNote").removeClass("nd");
        }


        if (obj.aggEnable == true) {
            $("#linkAggEn").addClass("selected");
            $("#linkAggDis").removeClass("selected");
            $("#aggAdv").removeClass("nd");
        } else if (obj.aggEnable == false) {
            $("#linkAggDis").addClass("selected");
            $("#linkAggEn").removeClass("selected");
            $("#aggAdv").addClass("nd");
        }

        $("#linkAggMode option[value='" + obj.aggMode + "']").prop('selected', 'selected');
        $('#linkAggMode').tpSelect({refresh: 1});

        fillPort(obj);
    }

    function linkAggInit() {
        var tmp = {};
        if (doGet(tmp)) {
            return;
        }
        doFill(tmp);
    }

    function doCollect(obj) {
        var aggPortNo = 0;
        if ($("#linkAggEn").hasClass("selected")) {
            obj.aggEnable = 1;
        } else if ($("#linkAggDis").hasClass("selected")) {
            obj.aggEnable = 0;
        }
        obj.aggMode = $('#linkAggMode').data("value");
        if (!$('#aggPort1').hasClass("disabled")) {
            if ($("#aggPort1").prop("data-checked")) {
                obj.LAN1CONF = 3;
                aggPortNo++;
            } else {
                obj.LAN1CONF = 0;
            }

        }
        if (!$('#aggPort2').hasClass("disabled")) {
            if ($("#aggPort2").prop("data-checked")) {
                obj.LAN2CONF = 3;
                aggPortNo++;
            } else {
                obj.LAN2CONF = 0;
            }
        }
        if (!$('#aggPort3').hasClass("disabled")) {
            if ($("#aggPort3").prop("data-checked")) {
                obj.LAN3CONF = 3;
                aggPortNo++;
            } else {
                obj.LAN3CONF = 0;
            }
        }
        if (!$('#aggPort4').hasClass("disabled")) {
            if ($("#aggPort4").prop("data-checked")) {
                obj.LAN4CONF = 3;
                aggPortNo++;
            } else {
                obj.LAN4CONF = 0;
            }
        }

        if (obj.aggEnable == 1 && aggPortNo != 2) {
            $.alert(CMM_LAN_AGG_PORTNO_INVALID);
            return false;
        }
        return true;
    }

    function aggSave() {
        var tmp = {};
        if (doCollect(tmp) === false) {
            $.removeLoading();
            return;
        }
        /* parameter not changed */
        if ((tmp.aggEnable == iptvobj.aggEnable) &&
                (tmp.aggMode == iptvobj.aggMode) &&
                (tmp.LAN1CONF == iptvobj.LAN1CONF) &&
                (tmp.LAN2CONF == iptvobj.LAN2CONF) &&
                (tmp.LAN3CONF == iptvobj.LAN3CONF) &&
                (tmp.LAN4CONF == iptvobj.LAN4CONF)) {
            $.removeLoading();
            return;
        }
        $.confirm(c_str.agg_reboot, goExcute, goBack);

        function goExcute() {
            $.act(ACT_SET, ETH_IPTV_CFG, null, null, tmp);
            if (!$.exe()) {
                $.guage(["<span class='T T_rebooting'>" + s_str.rebooting + "</span>", "<span class='T T_wait_reboot'>" + s_str.wait_reboot + "</span>" ], 100, $.guageInterval, function () {
                    $.refresh();
                });
                $.act(ACT_OP, ACT_OP_REBOOT);
                $.exe(true);
            }
        }

        function goBack() {
            $.removeLoading();
            return;
        }
    }

    $("#linkAggEn").click(function () {
        $(this).addClass("selected");
        $("#linkAggDis").removeClass("selected");
        $("#aggAdv").removeClass("nd");
    });

    $("#linkAggDis").click(function () {
        $(this).addClass("selected");
        $("#linkAggEn").removeClass("selected");
        $("#aggAdv").addClass("nd");
    });

    $("#agg_save").click(function () {
        $.addLoading($(this));
        aggSave();
    });
}
</script>

<h3 id="t_lanTitle">LAN</h3>

<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div class="nd" id="dhcpEditPage"></div>
        <table class="nd" id="tableDchp">
            <thead></thead>
            <tbody id="tableDchpBody">
                <tr id="editDHCPCfg" class="nd">
                    <td colspan="6">
                        <div id="dhcpTableEditPage"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
</div>

<div id="t_linkaggTitle" class="nd">
	<h3 id="t_linkaggStr">Link Aggregation</h3>
	<div id="aggBody" class="content-container">
	<form class="pure-form pure-form-aligned">
		<div id="linkAggBut" class="button-group-container">
			<b id="t_linkagg">Link Aggregation:</b>
			<ul>
				<li>
 					<button id="linkAggEn" class="fst" value="on">Enable</button>
				</li>
				<li>
					<button id="linkAggDis" class="lst" value="off">Disable</button>
				</li>
			</ul>
        </div>
        <div class="part-separate" id="aggAdv">
			<div>
				<b class="T_mode">Mode:</b>
				<select id="linkAggMode" class="l">
					<option value='0' id="t_passive">LACP passive</option>
					<option value='1' id="t_active" >LACP active</option>
				</select>
			</div>
			<div class = "part-separate">
				<b id="t_aggPorts">Link Aggregation Ports:</b>
				<input type="checkbox" id="aggPort1" />
				<label id="t_LAN1">LAN1</label>
				<input type="checkbox" id="aggPort2" />
				<label id="t_LAN2">LAN2</label>
				<input type="checkbox" id="aggPort3" />
				<label id="t_LAN3">LAN3</label>
				<input type="checkbox" id="aggPort4" />
				<label id="t_LAN4">LAN4</label>
			</div>
		</div>
		<div id="aggNote" class="part-separate nd">
            <span class="T_note2">Note:</span>
            <span class="T_aggNote">
         	Link aggregation and IPTV should not be enabled at the same time.
			</span>
		</div>

		<div id="aggSave">
			<button type="submit" class="green T_save" id="agg_save">Save</button>
		</div>
    </form>
</div>
</div>
<script type="text/javascript">
$.tpInit(init);
</script>
