<input type="hidden" id="device-current-block" value="no-dev" />
<div class="titleBar">
    <a id="back" url="parentCtrl.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a>
    <h1>
        <script type="text/html" class="title-string">
            <%=$.tpLang.parentCtrl_nstr.t_title2%>
        </script>
    </h1>
    <a id="edit" data-status="edit">
        <script type="text/html" class="title-string">
            <%=$.tpLang.m_str.edit%>
        </script>
    </a>
</div>

<div class="no-item" id="no-dev">
    <div class="sprite grid-no-device"></div>
    <span class="text-no-item">
        <script type="text/html" class="title-string">
            <%=$.tpLang.parentCtrl_nstr.t_nodevice%>
        </script>
    </span>
    <input type="button" class="button-mobile add-button mt10" id="btn-add-dev">
</div>

<div class="control-devices nd" id="ctrl-dev">
    <div class="section-title mt15">
        <script type="text/html" class="title-string">
            <%=$.tpLang.table_str.logdev%>
        </script>
        <span class="dhcp-n"></span>
    </div>
    <ul id="control-device-list" class="device-list">
    </ul>
</div>

<div class="add-device item-list mt15 nd" id="add-dev">
    <div class="section-container">
        <div class="section-box">
            <div id="device-enable">
                <span></span>
            </div>
            <input type="checkbox" id="input-device-enable" />
        </div>
    </div>
    <div class="section-container mtNo">
        <div class="section-box single">
            <input id="add-device-name" maxlength="32" type="text" />
        </div>
        <input type="button" class="button-mobile" id="view-ext-dev">

        <div class="section-box mt10">
            <input id="add-device-mac" maxlength="17" type="text" />
        </div>
        <div class="section-box">
            <input id="add-device-description" maxlength="15" type="text" />
        </div>
    </div>
    <div class="section-container mtNo" id="a-access-time">
        <div class="section-box single">
            <a class="turn-page">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.table_str.accesstime%>
                    </script>
                </span>
            </a>
        </div>
    </div>
</div>

<div id="access-time" class="nd">
</div>

<div class="nd" id="ext-dev">
    <div class="section-title mt15">
        <script type="text/html" class="title-string">
            <%=$.tpLang.parentCtrl_nstr.t_accessdevlist%>
        </script>
    </div>
    <div id="selectDeviceList" class="device-list device-container"></div>
</div>

<div class="botP-toolBar">
</div>

<script type="text/javascript">
(function() {
    var deviceList, ruleList, scheList, fwInfo;
    var deviceStack = [];
    var isEdit = 0;
    var editStackIndex;
    var blackParentName, whiteParentName;
    var tempScheList = {};

    (function() {
        $.tpLocal('title-string', $.tpLang);
        $('.titleBar').titleBar();
        $('.botP-toolBar').toolBar();
        $('#btn-add-dev').buttonMobile({
            'text': $.tpLang.wps_nstr.addNew
        });
        $('#view-ext-dev').buttonMobile({
            'text': $.tpLang.parentCtrl_nstr.t_viewdev
        });

        $("#access-time").timeCircle();
        $(".timeCircle").height(Math.floor($("#access-time").parent().innerWidth() * 0.81) + 100);
        $(".timeCircle svg").height(Math.floor($("#access-time").parent().innerWidth() * 0.81) + 100);

        init();

        $('#input-device-enable').checkboxMobile({
            'hasTitle': true,
            'title': $.tpLang.s_str.enthisentry,
            'checked': true
        });
        $('#add-device-name').inputBoxMobile({
            'value': '',
            'title': $.tpLang.parentCtrl_nstr.t_devname,
            'warnings': [{
                func: function() {
                    var val = this.inputBoxMobile('option', 'value');
                    return $.isname(val);
                },
                text: e_str[ERR_FW_ENTRYNAME_INVAD]
            }]
        });
        $('#add-device-mac').inputBoxMobile({
            'value': '',
            'title': $.tpLang.parentCtrl_nstr.t_macaddr,
            'ipOrMac': 'mac',
            'warnings': [{
                func: function() {
                    var mac = this.inputBoxMobile('option', 'value');
                    return e_str[$.mac(mac, true)];
                },
                text: e_str[ERR_MAC_FORMAT]
            }]
        });
        $('#add-device-description').inputBoxMobile({
            'value': '',
            'title': $.tpLang.parentCtrl_nstr.t_descrip,
            'warnings': [{
                func: function() {
                    var val = this.inputBoxMobile('option', 'value');
                    return $.isname(val);
                },
                text: e_str[ERR_FW_ENTRYNAME_INVAD]
            }]
        });
        $.each($('.turn-page'), function() {
            $.initTurnPage(this);
        });
        $('#control-device-list').editList();
    })();

    function init() {
        deviceList = $.act(ACT_GL, INTERNAL_HOST, null, null);
        ruleList = $.act(ACT_GL, RULE, null, null);
        scheList = $.act(ACT_GL, TASK_SCHEDULE, null, null);
        fwInfo = $.act(ACT_GET, FIREWALL, null, null, ["enalbeParentCtrl", "parentCtrlMode"]);
        var blackParentCfg = $.act(ACT_GET, EXTERNAL_HOST, "1,0,0,0,0,0", null);
        var whiteParentCfg = $.act(ACT_GET, EXTERNAL_HOST, "2,0,0,0,0,0", null);
        if (!$.exe()) {
            blackParentName = blackParentCfg.entryName;
            whiteParentName = whiteParentCfg.entryName;

            if (deviceList.length > 0) {
                var listStr = '';
                var deviceNum = 0;
                for (var i = 0; i < deviceList.length; i++) {
                    if (deviceList[i].isParentCtrl === '2') {
                        var id = 'deviceItem' + i;
                        deviceStack[i] = deviceList[i].__stack;
                        listStr += '<li class="ctrl-device">' +
                                '<div id="' + id + '" class="li-content-div" data-index="' + i + '">' +
                                '<div class="device-div">' +
                                '<div class="device-label">' +
                                '<span class="sprite grid-row-device"></span>' +
                                '</div>' +
                                '<div class="device-content">' +
                                '<div class="device-line">' +
                                '<div class="device-info">' +
                                '<div class="device-info-name">' + deviceList[i].entryName + '</div>' +
                                '<div class="device-info-item">' +
                                '<span class="device-info-title">' + $.tpLang.table_str.mac + '</span>' +
                                '<span class="device-info-text device-info-mac">' + deviceList[i].mac + '</span>' +
                                '</div>' +
                                '<div class="device-info-item">' +
                                '<span class="device-info-title">' + $.tpLang.table_str.status + '</span>' +
                                '<span class="device-info-text">' + (ruleList[i].enable === '1' ? $.tpLang.table_str.on : $.tpLang.table_str.off) + '</span>' +
                                '</div></div>' +
                                '<div class="op">' +
                                '<span class="ctrl-arrow floatRight"></span>' +
                                '</div></div></div></div></li>';
                        deviceNum += 1;
                    }
                }
                if (deviceNum > 0) {
                    $('#no-dev').hide();
                    $('#control-device-list').html(listStr);
                    $('.dhcp-n').text(deviceNum);
                    $('#ctrl-dev').show();
                    $.each($('#control-device-list .device-div'), function() {
                        $.addDeviceBlock(this);
                    });
                }
            }
        }

        setExistingData();
        setEvent();
    }

    function setExistingData() {
        var deviceOnline = $.act(ACT_GL, LAN_HOST_ENTRY, null, null, ["MACAddress", "hostName", "IPAddress", "active"]);
        if (!$.exe()) {
            if (deviceOnline.length > 0) {
                var onlineStr = '';
                for (var i = 0; i < deviceOnline.length; i++) {
                    if (deviceOnline[i].active == 1) {
                        $('#ext-dev').find('.section-container').remove();

                        var id = 'exist-device' + i;
                        onlineStr += '<div class="section-container">' +
                            '<div class="section-box">' +
                            '<div class="device-div">' +
                            '<div class="device-label">' +
                            '<span class="sprite grid-row-device"></span>' +
                            '</div>' +
                            '<div class="device-content">' +
                            '<div class="device-line">' +
                            '<div class="device-info">' +
                            '<div class="device-info-name">' + deviceOnline[i].hostName + '</div>' +
                            '<div class="device-info-item">' +
                            '<span class="device-info-title">' + $.tpLang.table_str.ip + '</span>' +
                            '<span class="device-info-text">' + deviceOnline[i].IPAddress + '</span>' +
                            '</div>' +
                            '<div class="device-info-item">' +
                            '<span class="device-info-title">' + $.tpLang.table_str.mac + '</span>' +
                            '<span class="device-info-text device-info-mac">' + deviceOnline[i].MACAddress + '</span>' +
                            '</div></div>' +
                            '<div class="op">' +
                            '<input id="' + id + '" class="input-exist-devices" type="checkbox" />' +
                            '</div></div></div></div></div></div>';
                    }
                }
                $('#selectDeviceList').append(onlineStr);

                $.each($('#ext-dev .device-div'), function() {
                    $.addDeviceBlock(this);
                });
                $('.input-exist-devices').checkboxMobile({
                    'hasTitle': false,
                    'checked': false
                });
            }
        }
    }

    function setEvent() {
        $('#btn-add-dev').on('click', function() {
            showAddDevice();
        });
        $('#view-ext-dev').on('click', function() {
            $('#add-dev').hide();
            $('#ext-dev').show();
            setExistingData();
            $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_viewdev);
            $('#edit').titleButton('status', 'done', $.tpLang.m_str.done);
            $('#back').titleButton('url', '');
            $('#device-current-block').val('ext-dev');
        });
        $('#a-access-time').on('click', function() {
            $('#add-dev').hide();
            $('#access-time').show();
            $('.titleBar').titleBar('title', $.tpLang.table_str.accesstime);
            $('#edit').titleButton('status', 'access-done', $.tpLang.m_str.done);
            $('#back').titleButton('url', '');
            $('#device-current-block').val('access-time');
        });
        $('#control-device-list')
            .on('delete.editlist', '.li-content-div', function() {
                var li = '#' + $(this).attr('id');
                deleteCtrlDev(li);
            }).on('click.editlist', '.ctrl-device .li-content-div', function() {
                editStackIndex = parseInt($(this).attr('data-index'));
                var data = {};
                isEdit = 1;
                $.extend(data, scheList[editStackIndex]);
                clearAddForm();
                $("#input-device-enable").checkboxMobile('option', 'checked', ruleList[editStackIndex].enable === '1' ? true : false);
                $('#add-device-name').inputBoxMobile({
                    'value': deviceList[editStackIndex].entryName
                });
                $('#add-device-mac').inputBoxMobile({
                    'value': deviceList[editStackIndex].mac
                });
                $('#add-device-description').inputBoxMobile({
                    'value': ruleList[editStackIndex].ruleName
                });
                $('#access-time').timeCircle('set', data);
                showAlterDevice();
            });
        $('.botP-toolBar').on('click', '#tb-add', function() {
            hideToolBar();
            showAddDevice();
        });
        $('#edit').on('click', function() {
            var status = $(this).titleButton('status');
            if (status === 'edit') {
                showToolBar();
            } else if (status == 'cancel') {
                hideToolBar();
            } else if (status === 'save' || status === 'modify-save') {
                $.startWaitingMobile();
                if (saveDev()) {
                    var data = deviceList.length === 0 ? false : true;
                    $('#add-dev').hide();
                    if (data) {
                        $('#ctrl-dev').show();
                        $('#device-current-block').val('ctrl-dev');
                    } else {
                        $('#no-dev').show();
                        $('#device-current-block').val('no-dev');
                    }
                    $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_title2);
                    $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);
                } else {
                    $.stopWaitingMobile('');
                }
            } else if (status === 'done') {
                var extDev = $('#ext-dev .checkbox-mobile.checked');
                if (extDev.length === 1) {
                    $('#add-device-name').inputBoxMobile({
                        'value': extDev.eq(0).parent().prev('.device-info').find('.device-info-name').text()
                    });
                    $('#add-device-mac').inputBoxMobile({
                        'value': extDev.eq(0).parent().prev('.device-info').find('.device-info-mac').text()
                    });
                }
                $('#ext-dev').hide();
                $('#add-dev').show();
                $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_adddev);
                $('#edit').titleButton('status', 'save', $.tpLang.m_str.save);
                $('#device-current-block').val('add-dev');
            } else if (status === 'access-done') {
                $.extend(tempScheList, scheList[editStackIndex]);
                $.extend(scheList[editStackIndex], $('#access-time').timeCircle('data'));
                $('#access-time').hide();
                $('#add-dev').show();
                $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_adddev);
                $('#edit').titleButton('status', 'save', $.tpLang.m_str.save);
                $('#device-current-block').val('add-dev');
            }
        });
        $('#back').on('click', function() {
            var cur = $('#device-current-block').val();
            if (cur === 'add-dev') {
                var data = deviceList.length === 0 ? false : true;
                scheList[editStackIndex] = tempScheList;
                $('#add-dev').hide();
                isEdit = 0;
                if (data) {
                    $('#ctrl-dev').show();
                    $('#device-current-block').val('ctrl-dev');
                } else {
                    $('#no-dev').show();
                    $('#device-current-block').val('no-dev');
                }
                $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_title2);
                $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);
            } else if (cur === 'ext-dev') {
                $('#ext-dev').hide();
                $('#add-dev').show();
                $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_adddev);
                $('#edit').titleButton('status', 'save', $.tpLang.m_str.save);
                $('#device-current-block').val('add-dev');
            } else if (cur === 'no-dev' || cur === 'ctrl-dev') {
                $.loadPhoneMain('parentCtrl.mobile.htm');
            } else if (cur === 'access-time') {
                $('#access-time').timeCircle('set', scheList[editStackIndex]);
                $('#access-time').hide();
                $('#add-dev').show();
                $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_adddev);
                $('#edit').titleButton('status', 'save', $.tpLang.m_str.save);
                $('#device-current-block').val('add-dev');
            }
        });
        $('#ext-dev').on('check.checkboxMobile', '.input-exist-devices', function() {
            $('.input-exist-devices').checkboxMobile('option', 'checked', false);
            $(this).checkboxMobile('option', 'checked', true);
        });
    }

    function clearAddForm() {
        $("#input-device-enable").checkboxMobile('option', 'checked', true);
        $('#add-device-name').val('');
        $('#add-device-mac').inputBoxMobile('option', 'value', '');
        $('#add-device-description').val('');
        $('#access-time').removeData('schedule');
        $('#access-time').timeCircle();
    }

    function deleteCtrlDev(li) {
        var childStackIndex = $(li).attr('data-index');
        var childDeviceName = $(li).find('.device-info-name').text();

        $.each(ruleList, function(index) {
            if (this.internalHostRef == childDeviceName) {
                $.act(ACT_DEL, RULE, this.__stack, null);
            }
        });

        $.each(scheList, function(index) {
            if (this.entryName == childDeviceName) {
                $.act(ACT_DEL, TASK_SCHEDULE, this.__stack, null);
            }
        });

        $.act(ACT_DEL, INTERNAL_HOST, deviceStack[childStackIndex], null);

        $.exe(function(err) {
            if (!err) {
                $.loadPhoneMain('deviceControl.mobile.htm');
            }
        });
    }

    function showAddDevice() {
        hideToolBar();
        clearAddForm();
        $('#no-dev').hide();
        $('#ctrl-dev').hide();
        $('#add-dev').show();
        $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_adddev);
        $('#edit').titleButton('status', 'save', $.tpLang.m_str.save);
        $('#back').titleButton('url', '');
        $('#back').titleButton('show');
        $('#device-current-block').val('add-dev');
        $('.inputBox-mobile-div>input[type=text]').inputBoxMobile('hideWarnings');
    }

    function showAlterDevice() {
        hideToolBar();
        $('#no-dev').hide();
        $('#ctrl-dev').hide();
        $('#add-dev').show();
        $('.titleBar').titleBar('title', $.tpLang.table_str.modify);
        $('#edit').titleButton('status', 'modify-save', $.tpLang.m_str.save);
        $('#back').titleButton('url', '');
        $('#device-current-block').val('add-dev');
        $('.inputBox-mobile-div>input[type=text]').inputBoxMobile('hideWarnings');
    }

    function showToolBar() {
        $('#control-device-list').editList({
            'listType': 'selectList'
        });
        $('.op span').removeClass('ctrl-arrow');
        $('#edit').titleButton('status', 'cancel', $.tpLang.m_str.cancel);
        $('#btn-add-dev').hide();
        $('.botP-toolBar').toolBar('option', {
            'hide': false
        });
    }

    function hideToolBar() {
        $('#control-device-list').editList({
            'listType': 'swipeList'
        });
        $('.op span').addClass('ctrl-arrow');
        $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);
        $('#btn-add-dev').show();
        $('.botP-toolBar').toolBar('option', {
            'hide': true
        });
    }

    function saveDev() {

        var internHost = {};
        var parentRule = {};
        var parentSche = {};
        var editRuleStack;
        var editScheStack;
        var isRuleDuplicate = 0;

        if (isEdit == 1) {
            var editDevice = $.act(ACT_GET, INTERNAL_HOST, deviceStack[editStackIndex], null);
            $.exe();
            $.each(ruleList, function() {
                if (this.internalHostRef == editDevice.entryName) {
                    editRuleStack = this.__stack;
                }
            });

            $.each(scheList, function() {
                if (this.entryName == editDevice.entryName) {
                    editScheStack = this.__stack;
                }
            });
        }

        if (!$('#add-device-name').inputBoxMobile('checkValue') || !$('#add-device-mac').inputBoxMobile('checkValue') || !$('#add-device-description').inputBoxMobile('checkValue')) {
            return false;
        }

        $.extend(parentSche, $('#access-time').timeCircle('data'));

        parentSche.isParentCtrl = 2;
        parentSche.entryName = $("#add-device-name").val();

        internHost.isParentCtrl = 2;
        internHost.type = 1;
        internHost.entryName = $("#add-device-name").val();
        internHost.mac = $("#add-device-mac").val();

        parentRule.ruleName = $("#add-device-description").val();
        parentRule.isParentCtrl = 2;
        parentRule.enable = $("#input-device-enable").checkboxMobile('option', 'checked') ? 1 : 0;
        parentRule.action = fwInfo.parentCtrlMode;
        parentRule.protocol = 0;
        parentRule.direction = 1;

        parentRule.internalHostRef = internHost.entryName;
        parentRule.externalHostRef = (fwInfo.parentCtrlMode == 1) ? blackParentName : whiteParentName;
        parentRule.scheduleRef = parentSche.entryName;

        if (isEdit == 0) {
            $.act(ACT_ADD, INTERNAL_HOST, null, null, internHost);
            $.act(ACT_ADD, TASK_SCHEDULE, null, null, parentSche);
            $.act(ACT_ADD, RULE, null, null, parentRule);
        } else if (isEdit == 1) {
            $.act(ACT_SET, INTERNAL_HOST, deviceStack[editStackIndex], null, internHost);
            $.act(ACT_SET, TASK_SCHEDULE, editScheStack, null, parentSche);
            $.act(ACT_SET, RULE, editRuleStack, null, parentRule);
            isEdit = 0;
        }

        $.exe(function(err) {
            $.stopWaitingMobile();
            if (!err) $.loadPhoneMain('deviceControl.mobile.htm');
        });
    }
})();
</script>