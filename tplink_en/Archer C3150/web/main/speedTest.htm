<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head lang="en">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="../js/jquery.tpDial.js" type="text/javascript"></script>
    <link href="../css/jquery.tpDial.css" rel="stylesheet">
    <title>Speed Test</title>
    <style>
    .sprite {
        display:inline-block;
        overflow:hidden;
        background-repeat: no-repeat;
        background-image:url(../img/speedTest.png);
    }
    .download1_highlight_hover {
        width:9px;
        height:12px;
        background-position: -3px -271px
    }
    .download1_highlight_nomal {
        width:9px;
        height:12px;
        background-position: -16px -271px
    }
    .download1_hover {
        width:9px;
        height:12px;
        background-position: -3px -287px
    }
    .download1_nomal {
        width:9px;
        height:12px;
        background-position: -16px -287px
    }
    .download2_hover {
        width:15px;
        height:21px;
        background-position: -3px -171px
    }
    .download2_nomal {
        width:15px;
        height:21px;
        background-position: -3px -196px
    }
    .speed-Test_highlight_hover {
        width:26px;
        height:22px;
        background-position: -3px -3px
    }
    .speed-Test_highlight_nomal {
        width:26px;
        height:22px;
        background-position: -3px -29px
    }
    .speedTest_hover {
        width:26px;
        height:22px;
        background-position: -3px -55px
    }
    .speedvTest_nomal {
        width:26px;
        height:22px;
        background-position: -3px -81px
    }
    .upload1_highlight_hover {
        width:9px;
        height:12px;
        background-position: -4px -303px
    }
    .upload1_highlight_nomal {
        width:9px;
        height:12px;
        background-position: -4px -319px
    }
    .upload2_hover {
        width:15px;
        height:21px;
        background-position: -3px -221px
    }
    .upload2_nomal {
        width:15px;
        height:21px;
        background-position: -3px -246px
    }
    .upload_hover {
        width:9px;
        height:12px;
        background-position: -17px -303px
    }
    .upload_nomal {
        width:9px;
        height:12px;
        background-position: -17px -303px
    }
    div.map-panel div.map-panel-cnt.real-panel {
        min-height: 0;
        padding: 24px 0 10px 0;
    }
    .row {
        white-space: nowrap;
    }
    .row.dial-row {
        margin-bottom: -10px;
    }
    .col {
        display: inline-block;
        margin-right: -4px;
    }
    .col50 {
        width: 50%;
    }
    .dial-row .col {
        height: 97px;
    }
    .col.border-right {
        border-right: 1px solid #ccc;
    }
    .realSpeed-content {
        font-size: 28px;
    }
    .realSpeed-content.left, .dial-wrapper.left {
        text-align: left;
        margin-left: 132px;
    }
    .realSpeed-content.right, .dial-wrapper.right {
        text-align: right;
        margin-right: 132px;
    }
    .realValue {
        font-size: 28px;
        margin-left: 12px;
    }
    .realUnit {
        font-size: 18px;
        margin-left: 7px;
        vertical-align: baseline;
    }
    .test-time-wrapper {
        text-align: center;
        margin-bottom: 32px;
        margin-top: 14px;
        min-height: 17px;
    }
    .test-time-wrapper p {
        font-size: 14px;
        color: #4ACBD6;
    }
    #speedRating-box {
        margin-top: 36px;
        text-align: center;
    }
    h4#speedRating-title {
        font-weight: normal;
        padding-bottom: 10px;
        color: #36444b;
        font-size: 14px;
        margin: 0;
    }
    #speedRating-text {
        margin: 0;
    }
    .testButton-container {
        margin-top: 36px;
    }
    /*speedTestResume*/
    #speedTestResume-outer {
        position: absolute;
        top: 41px;
        left: 210px;
        width: 222px;
        text-align: center;
    }
    #speedTestResume-container {
        display: inline-block;
        white-space: nowrap;
        cursor: pointer;
    }
    .speedTestResume-leftWrapper {
        display: inline-block;
        text-align: center;
    }
    .speedTestResume-rightWrapper {
        display: inline-block;
        margin-left: 12px;
    }
    #speedTestResume-down-value, #speedTestResume-down-unit, #speedTestResume-up-value, #speedTestResume-up-unit {
        font-size: 13px;
        margin-left: 5px;
    }
    .speedTestResume-down-row, .speedTestResume-up-row {
        line-height: 20px;
        text-align: left;
    }
    /*#speedTestResume-container:hover .speedvTest_nomal {*/
    /*background-position: -3px -55px;*/
    /*}*/
    #speedTestResume-container.selected .speedvTest_nomal {
        background-position: -3px -29px;
    }
    /*#speedTestResume-container.select:hover .speedvTest_nomal {*/
    /*background-position: -3px -3px;*/
    /*}*/
    /*#speedTestResume-container:hover .download1_nomal {*/
    /*background-position: -3px -287px;*/
    /*}*/
    #speedTestResume-container.selected .download1_nomal {
        background-position: -16px -271px;
    }
    /*#speedTestResume-container.select:hover .download1_nomal {*/
    /*background-position: -3px -271px;*/
    /*}*/
    /*#speedTestResume-container:hover .upload_nomal {*/
    /*background-position: -17px -319px;*/
    /*}*/
    #speedTestResume-container.selected .upload_nomal {
        background-position: -4px -319px;
    }
    /*#speedTestResume-container.select:hover .upload_nomal {*/
    /*background-position: -4px -303px;*/
    /*}*/
    /*#speedTestResume-container.selected span{*/
    /*color: #4ACBD6;*/
    /*}*/
    .button-container.testButton-container {
        text-align: right;
    }
    #speedTestResume-container span {
        font-weight: normal;
    }
    #testButton {
        background-color: #4acbd6;
        color: #ffffff;
        width: 90px;
        height: 30px;
        border-radius: 5px;
        /*float: right;*/
    }
    #testButton:hover {
        background-color: #23c4c4;
    }
    .map-panel-cnt {
        position: relative;
    }
    div.internet-speed-test-history {
        position: absolute;
        top: 18px;
        right: 0px;
        cursor: pointer;
    }
    div.internet-speed-test-history span.icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        background: url(../img/antiVirus.png) -84px -454px;
        vertical-align: top;
    }
    div.internet-speed-test-history span.text {
        display: inline-block;
        font-size: 15px;
        color: #4acbd6;
        padding-left: 6px;
        vertical-align: top;
    }
    div.msg-container.bandwidth-record {
        width: 650px;
        height: 610px;
    }
    div.msg-container.bandwidth-record div.msg-content-wrap h3.msg-title {
        padding-bottom: 7px;
        border-bottom: 1px solid #a7a9ac;
        margin: 0px 21px 0px 0px;
        font-weight: normal;
        line-height: 17px;
    }
    div.msg-container.bandwidth-record div.msg-content-wrap h3.msg-title span {
        font-size: 14px;
    }
    div.msg-container.bandwidth-record h3.msg-title a.clear-all-btn {
        float: right;
        text-decoration: none;
    }
    div.msg-container.bandwidth-record h3.msg-title a.clear-all-btn span.icon {
        width: 18px;
        height: 18px;
        display: inline-block;
        margin-right: 4px;
        background: url(../img/icons.png) no-repeat -122px -21px;
    }
    div.msg-container.bandwidth-record h3.msg-title a.clear-all-btn span.text {
        font-size: 12px;
        color: #c11c66;
        line-height: 14px;
    }
    div.bandwidth-record-wrapper {
        margin: 24px 0 60px 42px;
        height: 476px;
        overflow: auto;
    }
    div.bandwidth-record-wrapper.no-record {
        margin-left: 0;
    }
    div.bandwidth-record-wrapper div.no-record-wrapper {
        display: none;
        text-align: center;
    }
    div.bandwidth-record-wrapper.no-record div.no-record-wrapper {
        display: block;
    }
    div.no-record-wrapper span.icon {
        width: 52px;
        height: 48px;
        display: inline-block;
        background: url(../img/no-record.png) no-repeat;
        margin: 132px 0px 32px 0;
    }
    div.no-record-wrapper span.no-record-text {
        display: block;
        font-size: 15px;
        color: #36444b;
        font-family: arial;
    }
    div.bandwidth-record {
        font-size: 0;
        margin-bottom: 34px;
    }
    div.bandwidth-record span.time {
        width: 62px;
        display: inline-block;
        text-align: center;
        font-family: arial;
        font-size: 12px;
        line-height: 14px;
    }
    div.bandwidth-record div.bar-wrapper {
        display: inline-block;
        margin: 0px 56px 0px 26px;
        position: relative;
    }
    div.bandwidth-record div.bar-wrapper span.bar {
        width: 2px;
        height: 67px;
        display: block;
        background-color: #a7a9ac;
        margin-left: 3px;
        position: absolute;
        top: 4px;
        left: 0px;
    }
    div.bandwidth-record:last-child div.bar-wrapper span.bar {
        display: none;
    }
    div.bandwidth-record div.bar-wrapper span.point {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: url(../img/speedTest.png) -34px -321px;
    }
    div.download-wrapper {
        display: inline-block;
        width: 180px;
    }
    div.download-wrapper span.icon, div.upload-wrapper span.icon {
        width: 15px;
        height: 21px;
        display: inline-block;
    }
    div.download-wrapper span.icon {
        background: url(../img/speedTest.png) -3px -196px;
    }
    div.upload-wrapper span.icon {
        background: url(../img/speedTest.png) -3px -246px;
    }
    div.download-wrapper span.text, div.upload-wrapper span.text {
        font-size: 18px;
        font-family: arial;
        margin-left: 10px;
    }
    div.upload-wrapper {
        display: inline-block;
    }
    div.test-time-wrapper a.speedtest-icon {
        display: inline-block;
        width: 174px;
        height: 15px;
        margin-bottom: 15px;
        background: url(../img/speedTest.png) -3px -334px;
        cursor: pointer;
    }
    .hidden {
        display: none;
    }
    </style>
</head>

<body>
    <div id="speedTestResume-outer">
        <div id="speedTestResume-container">
            <div class="speedTestResume-leftWrapper">
                <div class="speedTestResume-leftWrapper-iconWrapper">
                    <span class="sprite speedvTest_nomal"></span>
                </div>
                <span id="speedTestResume-text"></span>
            </div>
            <div class="speedTestResume-rightWrapper">
                <div class="speedTestResume-down-row">
                    <span class="sprite download1_nomal"></span>
                    <span id="speedTestResume-down-value"></span>
                    <span id="speedTestResume-down-unit"></span>
                </div>
                <div class="speedTestResume-up-row">
                    <span class="sprite upload_nomal"></span>
                    <span id="speedTestResume-up-value"></span>
                    <span id="speedTestResume-up-unit"></span>
                </div>
            </div>
        </div>
    </div>


    <h4 class="map-panel-title">
        <span id="speedTest-title2"></span>
    </h4>

    <div class="map-panel-cnt">
        <div class="test-time-wrapper">
            <a class="speedtest-icon" href="http://www.speedtest.net/"></a>
            <p id="test-time" class="hidden"></p>
        </div>
        <div class="internet-speed-test-history">
            <span class="icon"></span>
            <span class="text"></span>
        </div>

        <div class="row dial-row">
            <div class="col col50 border-right">
                <div class="dial-wrapper left">
                    <div id="download-dial"></div>
                </div>
            </div>
            <div class="col col50">
                <div class="dial-wrapper right">
                    <div id="upload-dial"></div>
                </div>
            </div>
        </div>
        <div id="speedRating-box">
            <h4 id="speedRating-title"></h4>

            <p id="speedRating-text"></p>
        </div>
        <div class="button-container testButton-container">
            <form class="pure-form">
                <button type="submit" class="green T_save pure-button tp-btn-custom" id="testButton">
                    <span>Save</span>
                </button>
            </form>
        </div>

        <div id="total_bandwidth_record_msg">
            <div class="header-container">
                <h3 class="widget-title msg-title">
                <span class="msg-title-container">
                    <span class="msg-title"></span>
                    <a href="javascript:void(0);" class="clear-all-btn">
                        <span class="icon"></span>
                        <span class="text"></span>
                    </a>
                </span>
                </h3>
            </div>

            <div class="content"></div>
        </div>

        <div id="clear_record_msg" class="warning">
            <h4 class="title">
                <span class="icon"></span>
                <span class="text" id="clear_record_msg_text"></span>
            </h4>
        </div>
    </div>


    <script type="text/javascript">
    $(function() {
        //多语言文案替换
        $('#speedTestResume-text').text($.tpLang.SPEED_TEST.SPEED_TEST);
        $('#speedTestResume-down-unit').text($.tpLang.SPEED_TEST.MBPS);
        $('#speedTestResume-up-unit').text($.tpLang.SPEED_TEST.MBPS);


        $('#speedTest-title2').text($.tpLang.SPEED_TEST.INTERNET_SPEED_TEST);

        $('#test-time').html('&nbsp;');

        $("div.internet-speed-test-history span.text").html($.tpLang.SPEED_TEST.HISTORY);

        $('#testButton').html('<span>' + $.tpLang.SPEED_TEST.BEGIN_TEST + '</span>');

        $('#speedTestResume-outer').appendTo('.map_wrap');

        //用于隐藏其它panel

        function clearStatus() {
            $('div#map_icon_internet').removeClass('map-icon-internet-conn');
            $('div#map_icon_router').removeClass('map-icon-router-conn');
            $('div#map_icon_wireless').removeClass('map-icon-wireless-conn');
            $('div#map_icon_wire').removeClass('map-icon-wire-conn');
            $('div#map_icon_phone').removeClass('map-icon-phone-conn');
            $('div#map_icon_dect').removeClass('map-icon-dect-conn');
            $('div#map_icon_printer').removeClass('map-icon-printer-conn');
            $('div#map_icon_usb').removeClass('map-icon-usb-conn');
            $('div#speedTestResume-container').removeClass('selected');

            $('div#internet_panel').hide();
            $('div#router_panel').hide();
            $('div#wireless_panel').hide();
            $('div#wire_panel').hide();
            $('div#lan_panel').hide();
            $('div#phone_panel').hide();
            $('div#dect_panel').hide();
            $('div#printer_panel').hide();
            $('div#usb_panel').hide();
            $('div#speedTest_panel').hide();
        }
        var speedGetId = 0; //测试时定时器的id，离开页面时要清除定时器的值

        //将数据转换成mb，后台值是kb
        var transformUnit = function(value) {
            var unit = 0;
            unit = parseFloat((value / 1024).toFixed(1));

            return unit;
        };

        //将时间转换成对应文案，1 minute ago
        var transformTime = function(time) {
            var d = new Date(time * 1000);
            var currentDate = new Date();
            var date = "";

            if (d.getFullYear() == currentDate.getFullYear() && d.getMonth() == currentDate.getMonth() && d.getDate() == currentDate.getDate() && d.getHours() == currentDate.getHours() && d.getMinutes() >= currentDate.getMinutes() - 1) {
                date = 1 + " " + $.tpLang.SPEED_TEST.MINUTE_AGO;
            } else if (d.getFullYear() == currentDate.getFullYear() && d.getMonth() == currentDate.getMonth() && d.getDate() == currentDate.getDate() && d.getHours() == currentDate.getHours() && d.getMinutes() < currentDate.getMinutes() - 1) {
                date = (currentDate.getMinutes() - d.getMinutes()) + " " + $.tpLang.SPEED_TEST.MINUTES_AGO;
            } else if (d.getFullYear() == currentDate.getFullYear() && d.getMonth() == currentDate.getMonth() && d.getDate() == currentDate.getDate() && d.getHours() >= currentDate.getHours() - 1) {
                date = 1 + " " + $.tpLang.SPEED_TEST.HOUR_AGO;
            } else if (d.getFullYear() == currentDate.getFullYear() && d.getMonth() == currentDate.getMonth() && d.getDate() == currentDate.getDate() && d.getHours() < currentDate.getHours() - 1) {
                date = (currentDate.getHours() - d.getHours()) + " " + $.tpLang.SPEED_TEST.HOURS_AGO;
            } else if (d.getFullYear() == currentDate.getFullYear() && d.getMonth() == currentDate.getMonth() && d.getDate() >= currentDate.getDate() - 1) {
                date = $.tpLang.SPEED_TEST.YESTERDAY;
            }
            // else if(d.getFullYear()==currentDate.getFullYear()&&d.getMonth()==currentDate.getMonth()&&d.getDate()<currentDate.getDate()-1){
            //     date = (currentDate.getDate()-d.getDate()) + $.tpLang.SPEED_TEST.DAYS_AGO;
            // }
            // else if(d.getFullYear()==currentDate.getFullYear()){
            //     date = (currentDate.getMonth()-d.getMonth()) + $.tpLang.SPEED_TEST.MONTHS_AGO;
            // }
            // else{
            //     date = (currentDate.getFullYear()-d.getFullYear()) + $.tpLang.SPEED_TEST.YEARS_AGO;
            // }
            else {
                date = parseInt(currentDate.getTime() / 1000 / 60 / 60 / 24 - time / 60 / 60 / 24) + " " + $.tpLang.SPEED_TEST.DAYS_AGO;
            }



            return date;
        };

        //将date的值转换成日期
        var parseFormat = function(value, width)
        {
            var value = value.toString();
            while (value.length < width) value = "0" + value;
            return value;
        }

        var transformIntoDate = function(time){
            var d = new Date(time * 1000);
            var date = "";
            date = parseFormat((d.getMonth()+1), 2)+"/"+parseFormat(d.getDate(), 2)+"/"+d.getFullYear()+" ";
            if(d.getHours()<12){
                date = date + parseFormat(d.getHours(),2)+":"+parseFormat(d.getMinutes(),2)+"AM";
            }else if(d.getHours()==12){
                date = date + parseFormat(d.getHours(),2)+":"+parseFormat(d.getMinutes(),2)+"PM";
            }else{
                date = date + parseFormat((d.getHours()-12),2)+":"+parseFormat(d.getMinutes(),2)+"PM";
            }

            return date;
        };


		var mode2num = function(mode){
			switch(mode){
				case "ETH":
					return "0";
				case "DSL":
					return "1";
				case "USB_3G":
					return "2";
			}
		};


        //生成历史记录
        var setBandwidthRecord = function(log) {
            var i = 0;
            var data = [];
            var sysMode = mode2num($.sysMode)
            for (i = 0; i < log.length; i++) {
                if (log[i].mode == sysMode) {
                    data.push({
                        test_time: log[i].date,
                        down_speed: log[i].download,
                        up_speed: log[i].upload
                    });
                }
            }
            data.sort(function(a, b) {
                if (a.test_time > b.test_time) {
                    return -1;
                } else {
                    return 1;
                }
            });

            var noRecord = "";
            if (data.length == 0) {
                noRecord = "no-record";
            }
            var bandwidthHTML = "<div class=\"bandwidth-record-wrapper " + noRecord + "\">";
            bandwidthHTML += "<div class=\"no-record-wrapper\">";
            bandwidthHTML += "<span class=\"icon\"></span>";
            bandwidthHTML += "<span class=\"no-record-text\">" + $.tpLang.SPEED_TEST.NO_RECORD + "</span>";
            bandwidthHTML += "</div>";
            for (i = 0; i < data.length; i++) {
                bandwidthHTML += "<div class=\"bandwidth-record\">";
                bandwidthHTML += "<span class=\"time\">" + transformIntoDate(data[i].test_time) + "</span>";
                bandwidthHTML += "<div class=\"bar-wrapper\">";
                bandwidthHTML += "<span class=\"point\"></span>";
                bandwidthHTML += "<span class=\"bar\"></span>";
                bandwidthHTML += "</div>";
                bandwidthHTML += "<div class=\"download-wrapper\">";
                bandwidthHTML += "<span class=\"icon\"></span>";
                bandwidthHTML += "<span class=\"text\">" + transformUnit(data[i].down_speed) + $.tpLang.SPEED_TEST.MBPS + "</span>";
                bandwidthHTML += "</div>";
                bandwidthHTML += "<div class=\"upload-wrapper\">";
                bandwidthHTML += "<span class=\"icon\"></span>";
                bandwidthHTML += "<span class=\"text\">" + transformUnit(data[i].up_speed) + $.tpLang.SPEED_TEST.MBPS + "</span>";
                bandwidthHTML += "</div>";
                bandwidthHTML += "</div>";
            }
            bandwidthHTML += "</div>";

            $("div#total_bandwidth_record_msg .content").empty().append(bandwidthHTML);
        };


        $('#speedTestResume-down-value').text(0);
        $('#speedTestResume-up-value').text(0);

        //监听wan口实时速率
        var realSpeedOld = $.act(ACT_GET, SPEEDTEST_STAT, null, null);
        var internetConnId;
        $.exe(function(err) {
            //获取wan口流量数据，如果获取失败，不添加定时器，不报错
            if (err) {
                return;
            }
            //如果获取成功，网络联通，添加定时器，定时更新
            internetConnId = setInterval(function() {
                var realSpeedNew = $.act(ACT_GET, SPEEDTEST_STAT, null, null);
                $.exe(function(err) {
                    if (err) {
                        //获取失败，清除定时器
                        clearInterval(internetConnId);
                    }
                    var data = {
                        down_speed: (realSpeedNew.download - realSpeedOld.download) / (realSpeedNew.time - realSpeedOld.time) / 1024 * 8,
                        up_speed: (realSpeedNew.upload - realSpeedOld.upload) / (realSpeedNew.time - realSpeedOld.time) / 1024 * 8
                    };
                    realSpeedOld = realSpeedNew;

                    $('#speedTestResume-down-value').text(transformUnit(data.down_speed));
                    $('#speedTestResume-up-value').text(transformUnit(data.up_speed));
                });
            }, 2000);
        }, true);


        //入口图标的点击事件
        $('#speedTestResume-container').on('click', function() {
            clearStatus();
            $(this).addClass('selected');
            $('#speedTest_panel').fadeIn(150);

            $('#download-dial').tpDial({
                speedUnitText: $.tpLang.SPEED_TEST.MBPS + " " + $.tpLang.SPEED_TEST.DOWNLOAD
            });
            $('#upload-dial').tpDial({
                speedUnitText: $.tpLang.SPEED_TEST.MBPS + " " + $.tpLang.SPEED_TEST.UPLOAD,
                downLoad: false
            });

            //获取上次的测试数据,如果获取失败，不报错
            var speedtest = $.act(ACT_GET, SPEEDTEST, null, null);
            $.exe(function(err) {
                if (err) {
                    return;
                }
				if(speedtest.status == "Down_test" || speedtest.status == "Up_test"){
					test(isTest, true, true);
					return;
				}
                var data = {
                    last_test_time: speedtest.date,
                    last_down_speed: speedtest.download,
                    last_up_speed: speedtest.upload
                };
                if (data.last_test_time == 0) {
                    //没有历史记录
                    $('#speedRating-box').addClass("hidden");
                    $('#testButton span').text($.tpLang.SPEED_TEST.BEGIN_TEST);
                    test(isTest, true);
                } else {
                    $('#speedRating-box').removeClass("hidden");
                    $('#testButton span').text($.tpLang.SPEED_TEST.TEST_AGAIN);
                    $('#test-time').text(transformTime(data.last_test_time) + $.tpLang.SPEED_TEST.LAST_SPEED_TEST + " " + transformUnit(data.last_down_speed) + $.tpLang.SPEED_TEST.MBPS);
                    var speed = transformUnit(data.last_down_speed);
                    if (speed < 8) {
                        $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_0_8);
                    } else if (speed >= 8 && speed < 15) {
                        $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_8_15);
                    } else if (speed >= 15 && speed < 30) {
                        $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_15_30);
                    } else if (speed >= 30 && speed < 50) {
                        $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_30_50);
                    } else if (speed >= 50 && speed < 100) {
                        $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_50_100);
                    } else if (speed >= 100) {
                        $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_100);
                    }
                    var down_speed = transformUnit(data.last_down_speed);
                    $('#download-dial').tpDial('val', down_speed);
                    var up_speed = transformUnit(data.last_up_speed);
                    $('#upload-dial').tpDial('val', up_speed);
                }
            }, true);

        });

        var isTest = true;
        $('#testButton').click(function() {
            test(isTest);
            return false;
        });


        $("div#total_bandwidth_record_msg").tpModal({
            className: "bandwidth-record",
            confirmBtn: null,
            cancelBtn: null,
            maxHeight: 590
        });

        $("span.msg-title-container span.msg-title").html($.tpLang.SPEED_TEST.TOTAL_BANDWIDTH_RECORD);
        $("span.msg-title-container a.clear-all-btn span.text").html($.tpLang.SPEED_TEST.CLEAR_ALL);

        $("div.internet-speed-test-history").on("click", function(e) {
            // get total bandwidth record
            var log = $.act(ACT_GL, SPEEDTEST_LOG);
            $.exe(function() {
                setBandwidthRecord(log);
            });
            $("div#total_bandwidth_record_msg").tpModal("show");
        });

        $("a.clear-all-btn").on("click", function(e) {
            $.confirm($.tpLang.SPEED_TEST.ALERT_NOTIFICATION_CAPTION, function() {
                $.act(ACT_SET, SPEEDTEST, null, null, ["clear=1"]);
                $.exe(function(err) {
                    if (err) {
                        return;
                    }

                    var log = $.act(ACT_GL, SPEEDTEST_LOG);
                    $.exe(function() {
                        setBandwidthRecord(log);
                    });
                });
            }, function() {

            });
        });

        //用于展示tpDial

        function test(flag, unalert, already) {
			var running = already || false;
            if (flag !== false) {
                if ('speedGetId' in window) {
                    clearInterval(speedGetId);
                }

                $('#download-dial').tpDial('val', null);
                $('#download-dial').tpDial('testing', true);
                $('#upload-dial').tpDial('val', null);
                $('#test-time').text($.tpLang.SPEED_TEST.DOWNLOAD_SPEED_TEST);
				
				if(running == false){
					$.act(ACT_SET, SPEEDTEST, null, null, ["enable=1"]);
				}
                var realSpeedOld = $.act(ACT_GET, SPEEDTEST_STAT, null, null);
                $.exe(function(err) {
                    if (err) {
                        //internet is not available
                        $('#test-time').html('&nbsp;');
                        $('#speedRating-box').removeClass("hidden");
                        $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_0);
                        $('#download-dial').tpDial('testing', false);
                        $('#upload-dial').tpDial('testing', false);
                        $('#download-dial').tpDial('val', null);
                        $('#upload-dial').tpDial('val', null);
                        clearInterval(speedGetId);
                        $('#testButton span').text($.tpLang.SPEED_TEST.TEST_AGAIN);
                        isTest = true;
                        return;
                    }
                    speedGetId = setInterval(function() {
                        var speedTest = $.act(ACT_GET, SPEEDTEST, null, null);
                        var realSpeedNew = $.act(ACT_GET, SPEEDTEST_STAT, null, null);
                        $.exe(function(err) {
                            if (err) {
                                clearInterval(speedGetId);
                            }
                            var getInterval = (realSpeedNew.time - realSpeedOld.time) || 1;
                            var data = {
                                status: speedTest.status,
                                last_test_time: speedTest.date,
                                last_down_speed: speedTest.download,
                                down_speed: (realSpeedNew.download - realSpeedOld.download) / getInterval / 1024 * 8,
                                up_speed: (realSpeedNew.upload - realSpeedOld.upload) / getInterval / 1024 * 8
                            };
                            realSpeedOld = realSpeedNew;

                            if (data.status == "Idle") {
                                data.last_down_speed = speedTest.download;
                                data.down_speed = speedTest.download;
                                data.up_speed = speedTest.upload;
                                $('#download-dial').tpDial('testing', false);
                                $('#upload-dial').tpDial('testing', false);
                                $('#upload-dial').tpDial('val', transformUnit(data.up_speed));
                                $('#download-dial').tpDial('val', transformUnit(data.down_speed));

                                $('#test-time').text(transformTime(data.last_test_time) + $.tpLang.SPEED_TEST.LAST_SPEED_TEST + " " + transformUnit(data.last_down_speed) + $.tpLang.SPEED_TEST.MBPS);
                                var speed = transformUnit(data.down_speed);
                                $('#speedRating-box').removeClass("hidden");

                                if (speed < 8) {
                                    $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_0_8);
                                } else if (speed >= 8 && speed < 15) {
                                    $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_8_15);
                                } else if (speed >= 15 && speed < 30) {
                                    $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_15_30);
                                } else if (speed >= 30 && speed < 50) {
                                    $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_30_50);
                                } else if (speed >= 50 && speed < 100) {
                                    $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_50_100);
                                } else if (speed >= 100) {
                                    $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_100);
                                }
                                clearInterval(speedGetId);
                                $('#testButton span').text($.tpLang.SPEED_TEST.TEST_AGAIN);
                                isTest = true;
                            } else if (data.status == "Down_test") {
                                $('#test-time').text($.tpLang.SPEED_TEST.DOWNLOAD_SPEED_TEST);
                                $('#upload-dial').tpDial('testing', false);
                                $('#download-dial').tpDial('testing', true);
                                var down_speed = transformUnit(data.down_speed);
                                $('#download-dial').tpDial('val', down_speed);
                            } else if (data.status == "Up_test") {
                                $('#test-time').text($.tpLang.SPEED_TEST.UPLOAD_SPEED_TEST);
                                $('#download-dial').tpDial('testing', false);
                                $('#upload-dial').tpDial('testing', true);
                                var up_speed = transformUnit(data.up_speed);
                                $('#upload-dial').tpDial('val', up_speed);
                            } else {
                                //fail
                                $('#test-time').html('&nbsp;');
                                $('#speedRating-box').removeClass("hidden");
                                $('#speedRating-text').text($.tpLang.SPEED_TEST.SPEED_RATING_0);
                                $('#download-dial').tpDial('testing', false);
                                $('#upload-dial').tpDial('testing', false);
                                $('#download-dial').tpDial('val', null);
                                $('#upload-dial').tpDial('val', null);
                                clearInterval(speedGetId);
                                $('#testButton span').text($.tpLang.SPEED_TEST.TEST_AGAIN);
                                isTest = true;
                            }
                        }, unalert);
                    }, 1000);
                }, unalert);


                $('#testButton span').text($.tpLang.SPEED_TEST.CANCEL);
                isTest = false;
            } else {
                $.act(ACT_SET, SPEEDTEST, null, null, ["enable=0"]);
                $.exe(function(err) {
                    if (err) {
                        return;
                    }
                    clearInterval(speedGetId);
                    $('#test-time').html('&nbsp;');
                    $('#upload-dial').tpDial('testing', false);
                    $('#download-dial').tpDial('testing', false);
                    $('#testButton span').text($.tpLang.SPEED_TEST.TEST_AGAIN);
                    isTest = true;
                }, unalert);
            }
        }


        $(window).off('beforeLoadPage.speedTest').on('beforeLoadPage.speedTest', function() {
            clearInterval(speedGetId);
            clearInterval(internetConnId);
        });
    });
    </script>
</body>

</html>