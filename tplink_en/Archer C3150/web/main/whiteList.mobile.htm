<input type="hidden" id="white-current-block" value="no-white" />
<div class="titleBar">
    <a id="back" url="contentRestrict.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a>
    <h1>
        <script type="text/html" class="title-string">
            <%=$.tpLang.parentCtrl_nstr.t_wlm%>
        </script>
    </h1>
    <a id="edit" data-status="edit">
        <script type="text/html" class="title-string">
            <%=$.tpLang.m_str.edit%>
        </script>
    </a>
</div>

<div class="no-item" id="no-whi">
    <div class="sprite grid-no-list"></div>
    <span class="text-no-item">
        <script type="text/html" class="title-string">
            <%=$.tpLang.parentCtrl_nstr.t_nowhite%>
        </script>
    </span>
    <input type="button" class="button-mobile add-button mt10" id="btn-add-whi">
</div>

<ul id="white-l" class="nd">
</ul>

<div class="item-list add-white mt15 nd" id="add-whi">
    <div class="section-container">
        <div class="section-box">
            <input id="add-new-keyword" maxlength="32" type="text" />
        </div>
    </div>
</div>

<div class="botP-toolBar">
</div>

<script type="text/javascript">
    (function() {
        var allWhiteUrl, whiteIndex, allWhiteUrlType;
        var isEdit = 0;
        var tempUrl;

        (function() {
            $.tpLocal('title-string', $.tpLang);
            $('.titleBar').titleBar();
            $('.botP-toolBar').toolBar();
            $('#btn-add-whi').buttonMobile({ 'text': $.tpLang.parentCtrl_nstr.c_ak});
            init();

            $('#add-new-keyword').inputBoxMobile({
                'value': '',
                'title': $.tpLang.parentCtrl_nstr.c_ak,
                'warnings': [{
                    func: function() {
                        var val = this.inputBoxMobile('option', 'value');
                        if (val.length === 0) {
                            return false;
                        }
                        return $.isdomain(val);
                    },
                    text: e_str[ERR_FW_URL_INVAD]
                }]
            });
            $.each($('.turn-page'), function() {
                $.initTurnPage(this);
            });
            $('#white-l').editList();
        })();

        function init() {
            whiteIndex = 0;
            allWhiteUrl = [];
            allWhiteUrlType = [];
            var whiteParentCfg = $.act(ACT_GET, EXTERNAL_HOST, "2,0,0,0,0,0", null);
            var urlCfgList = $.act(ACT_GL, URL_CFG, null, null, ["urlAddr"]);
            if (!$.exe()) {
                for (var i = 0; i < whiteParentCfg.urlIndexs.length; i++) {
                    if (whiteParentCfg.urlIndexs.charAt(i) == 1) {
                        var id = 'white-item'+i;
                        allWhiteUrl[whiteIndex] = urlCfgList[i].urlAddr;
                        $("#white-l").append('<li>'+
                                '<div id="'+id+'" class="li-content-div">'+
                                '<span class="white-item-url">'+allWhiteUrl[whiteIndex]+'</span>'+
                                '<span class="white-arrow icon-r fixed-part"></span>'+
                                '</div></li>');
                        allWhiteUrlType[whiteIndex] = 1;
                        whiteIndex++;
                    }
                }
                if (whiteIndex > 0) {
                    $('#no-whi').hide();
                    $('#white-l').show();
                }
            }
            setEvent();
        }
        function setEvent() {
            $('#btn-add-whi').on('click', function () {
                showAdd();
            });
            $('#edit').on('click', function() {
                var status = $(this).titleButton('status');
                if (status === 'edit') {
                    showToolBar();
                } else if (status === 'cancel') {
                    hideToolBar();
                } else if (status === 'done' || status === 'modify-done') {
                    $.startWaitingMobile($.tpLang.m_str.waiting);
                    if (saveKeyword()) {
                        $('#add-whi').hide();
                        if (whiteIndex > 0) {
                            $('#white-l').show();
                            $('#white-current-block').val('white-l');
                        } else {
                            $('#no-whi').show();
                            $('#white-current-block').val('no-whi');
                        }
                        $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_wlm);
                        $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);
                    } else {
                        $.stopWaitingMobile();
                    }
                }
            });
            $('#back').on('click', function() {
                var cur = $('#white-current-block').val();
                if (cur === 'add-whi') {
                    isEdit = 0;
                    $('#add-whi').hide();
                    if (whiteIndex > 0) {
                        $('#white-l').show();
                        $('#white-current-block').val('white-l');
                    } else {
                        $('#no-whi').show();
                        $('#white-current-block').val('no-whi');
                    }
                    $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.t_wlm);
                    $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);
                } else if(cur === 'no-whi' || cur === 'white-l') {
                    $.loadPhoneMain('contentRestrict.mobile.htm');
                }
            });
            $('#white-l')
                    .on('delete.editlist', '.li-content-div', function() {
                        deleteItem($(this).find('.white-item-url').text());
                        $.exe(function(err) {
                            if (!err) {
                                $.loadPhoneMain('whiteList.mobile.htm');
                            }
                        });
                    })
                    .on('click', '.li-content-div', function() {
                        isEdit = 1;
                        tempUrl = $(this).find('.white-item-url').text();
                        showAlter($(this).find('.white-item-url').text());
                    });
            $('.botP-toolBar').on('click', '#tb-add', function() {
                hideToolBar();
                showAdd();
            });
        }
        function saveKeyword() {

            var urlAttrs = {};

            if (!$('#add-new-keyword').inputBoxMobile('checkValue')) {
                return false;
            }
            urlAttrs.type = 2;
            urlAttrs.addUrl = 1;
            urlAttrs.tmpUrl = $('#add-new-keyword').val();

            if (isEdit === 0) {
                $.act(ACT_SET, EXTERNAL_HOST, "2,0,0,0,0,0", null, urlAttrs);
            } else if (isEdit === 1) {
                deleteItem(tempUrl);
                $.act(ACT_SET, EXTERNAL_HOST, "2,0,0,0,0,0", null, urlAttrs);
            }

            $.exe(function(err) {
                if (!err) {
                    $.loadPhoneMain('whiteList.mobile.htm');
                }
            });
        }
        function showAlter(val) {
            hideToolBar();
            $('#no-whi').hide();
            $('#white-l').hide();
            $('#add-whi').show();
            $('#add-new-keyword').inputBoxMobile({'value': val, 'title': $.tpLang.parentCtrl_nstr.t_modify});
            $('.titleBar').titleBar('title', $.tpLang.table_str.modify);
            $('#edit').titleButton('status', 'modify-done', $.tpLang.m_str.done);
            $('#back').titleButton('url', '');
            $('#white-current-block').val('add-whi');
            $('.inputBox-mobile-div>input[type=text]').inputBoxMobile('hideWarnings');
        }
        function showAdd() {
            hideToolBar();
            $('#add-new-keyword').inputBoxMobile({'value': '', 'title': $.tpLang.parentCtrl_nstr.c_ak});
            $('#no-whi').hide();
            $('#white-l').hide();
            $('#add-whi').show();
            $('.titleBar').titleBar('title', $.tpLang.parentCtrl_nstr.c_ak);
            $('#edit').titleButton('status', 'done', $.tpLang.m_str.done);
            $('#back').titleButton('url', '');
            $('#back').titleButton('show');
            $('#white-current-block').val('add-whi');
            $('.inputBox-mobile-div>input[type=text]').inputBoxMobile('hideWarnings');
        }
        function showToolBar() {
            $('.botP-toolBar').toolBar('option', {
                'hide': false
            });
            $('#white-l').editList({
                'listType': 'selectList'
            });
            $('#btn-add-whi').hide();
            $('.white-arrow').removeClass('icon-r fixed-part');
            $('#edit').titleButton('status', 'cancel', $.tpLang.m_str.cancel);
        }
        function hideToolBar() {
            $('.botP-toolBar').toolBar('option', {
                'hide': true
            });
            $('#white-l').editList({
                'listType': 'swipeList'
            });
            $('#btn-add-whi').show();
            $('.white-arrow').addClass('icon-r fixed-part');
            $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);
        }
        function deleteItem(val) {
            var urlAttrs = {};
            urlAttrs.addUrl = 0;
            urlAttrs.tmpUrl = val;
            $.act(ACT_SET, EXTERNAL_HOST, "2,0,0,0,0,0", null, urlAttrs);
        }
    })();
</script>