<div>
    <div class="titleBar">
        <a url="bandwidth.mobile.htm">
            <span class="icon-back sprite c-arrow-blue-left"></span>
        </a>
        <h1>Bandwidth Control</h1>
        <a id="save" data-status="save">Save</a>
    </div>

    <div class="item-list mt15">
        <div class="section-container">
        <div class="section-box">
            <div>
                <span>Bandwidth Control:</span>
            </div>
            <input id="enableTc" type="checkbox" />
        </div>
    </div>
    <div id="tcCont">
        <div class="section-container mtNo">
                <div class="section-box single nd" id="div_linkType">
                <label class="section-labelTitle">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.trafficCtrl_nstr.t_type%>
                    </script>
                </label>
                <select id="linkType">
                    <option value="adsl_type">
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.trafficCtrl_nstr.dsl%>
                        </script>
                    </option>
                    <option value="other_type">
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.trafficCtrl_nstr.t_other%>
                        </script>
                    </option>
                </select>
            </div>
            <div class="section-box nd" id="curDslUp">
                <span>
                <script type="text/html" class="title-string">
                    <%=$.tpLang.trafficCtrl_nstr.t_dslUp%>
                </script>
            </span>
                <span class="text-readonly" id="upStreamCurrRate"></span>
            </div>
            <div class="section-box nd" id="curDslDown">
                <span>
                <script type="text/html" class="title-string">
                    <%=$.tpLang.trafficCtrl_nstr.t_dslDown%>
                </script>
            </span>
                <span class="text-readonly" id="downStreamCurrRate"></span>
            </div>
                <div class="section-box single">
                <input type="text" id="upTotalBW" maxlength="7" />
            </div>
            <div class="section-box">
                <input type="text" id="downTotalBW" maxlength="7" />
            </div>
        </div>
        <div id="iptvTcCont" class="section-container mtNo nd">
            <div class="section-box">
                <div>
                    <span>IPTV Bandwidth Guarantee:</span>
                </div>
                <input type="checkbox" id="enableIptvTc" />
            </div>
            <div id="iptv_elem" class="nd">
                <div class="section-box">
                    <input type="text" id="iptvUpMinBW" />
                </div>
                <div class="section-box">
                    <input type="text" id="iptvDownMinBW" />
                </div>
            </div>
        </div>
        <div id="voipTcCont" class="section-container mtNo nd">
            <div class="section-box">
                <div>
                    <span>VoIP Bandwidth Guarantee:</span>
                </div>
                <input type="checkbox" id="enableVoIPTc" />
            </div>
        </div>
    </div>
</div>

</div>
<script type='text/javascript'>
(function() {
    $.tpLocal('title-string', $.tpLang);
    $('.titleBar').titleBar();
    $('.titleBar').titleBar('title', $.tpLang.menu_str.tc);
    $('#save').titleButton('status', 'save', $.tpLang.m_str.save).on('click', function() {
        doSave();
    });

    var tcEntry;
    var tcSettings;
    var sysMode;
    var guestnetObj, guestnetObj5g;

    var upstreamCurrRate;
    var downstreamCurrRate;
    var wanDslStatus;
    var ewanEnable;

    var check_iptvUpMinBW = false;
    var check_iptvUpMinBW2 = false;
    var check_iptvDownMinBW = false;

    $('#enableTc').flipSwitch({
        'hasTitle': true,
        'title': $.tpLang.trafficCtrl_nstr.t_en
    }).bind('on.flipSwitch', function() {
        $('#tcCont').slideDown('fast');
    }).bind('off.flipSwitch', function() {
        $('#tcCont').slideUp('fast');
    })

    $('#linkType').selectMobile();

    $('#upTotalBW').inputBoxMobile({
        'title': $.tpLang.trafficCtrl_nstr.t_tup,
        'following': $.tpLang.s_str.kbps,
        'warnings': [{
            func: function() {
                if (!INCLUDE_QOS) {
                    if ($('#enableTc').flipSwitch('option', 'on') != false) {
                        if (wanDslStatus == 'Up') {
                            if (parseInt($('#upTotalBW').val(), 10) > upstreamCurrRate) {
                                var returnText = (e_str[ERR_TC_BW_UP_LARGER]).replace('$', upstreamCurrRate);
                                return returnText;
                            }
                        }
                    }
                }
                return true;
            }
        }, {
            func: function() {
                if (!INCLUDE_QOS) {
                    if ($('#enableTc').flipSwitch('option', 'on') != false) {
                        if (($('#upTotalBW').val() == '') || (!$.isnum($('#upTotalBW').val())) || (0 == $('#upTotalBW').val())) {
                            return false;
                        }
                    }
                }
                return true;
            },
            text: e_str[ERR_TC_NUM_INVAD]
        }]
    });

    $('#downTotalBW').inputBoxMobile({
        'title': $.tpLang.trafficCtrl_nstr.t_tdown,
        'following': $.tpLang.s_str.kbps,
        'warnings': [{
            func: function() {
                if (!INCLUDE_QOS) {
                    if ($('#enableTc').flipSwitch('option', 'on') != false) {
                        if (wanDslStatus == 'Up') {
                            if (parseInt($('#downTotalBW').val(), 10) > downstreamCurrRate) {
                                var returnText = e_str[ERR_TC_BW_DOWN_LARGER].replace('$', downstreamCurrRate);
                                return returnText;
                            }
                        }
                    }
                }
                return true;
            }
        }, {
            func: function() {
                if (!INCLUDE_QOS) {
                    if ($('#enableTc').flipSwitch('option', 'on') != false) {
                        if (($('#downTotalBW').val() == '') || (!$.isnum($('#downTotalBW').val())) || (0 == $('#downTotalBW').val())) {
                            return false;
                        }
                    }
                }
                return true;
            },
            text: e_str[ERR_TC_NUM_INVAD]
        }]
    });



    $('#enableIptvTc').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.trafficCtrl_nstr.t_graiptvon
    }).bind('check.checkboxMobile', function() {
        $('#iptv_elem').removeClass('nd');
    }).bind('uncheck.checkboxMobile', function() {
        $('#iptv_elem').addClass('nd');
    });

    $('#iptvUpMinBW').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.trafficCtrl_nstr.t_upgrabd,
        'following': $.tpLang.s_str.kbps,
        'warnings': [{
            func: function() {
                if (check_iptvUpMinBW == false) {
                    return true;
                }
                // if (1 == (tcSettings.enable & 1)) {
                    if (($('#iptvUpMinBW').val() == '') ||
                        (!$.isnum($('#iptvUpMinBW').val())) ||
                        (0 == parseInt($('#iptvUpMinBW').val(), 10))) {
                        return false;
                    }
                // }
                return true;
            },
            text: e_str[ERR_TC_NUM_INVAD]
        }, {
            func: function() {
                if (check_iptvUpMinBW2 == false) {
                    return true;
                }
                if (parseInt($('#iptvUpMinBW').val(), 10) >= parseInt($('#upTotalBW').val(), 10)) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[CMM_TC_UP_TOTAL_BW]
        }]
    });

    $('#iptvDownMinBW').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.trafficCtrl_nstr.t_downgrabd,
        'following': $.tpLang.s_str.kbps,
        'warnings': [{
            func: function() {
                if (check_iptvDownMinBW == false) {
                    return true;
                }
                if (($('#iptvDownMinBW').val() == '' ||
                        (!$.isnum($('#iptvDownMinBW').val())) ||
                        (0 == parseInt($('#iptvDownMinBW').val(), 10)))) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_TC_NUM_INVAD]
        }]
    });

    $('#enableVoIPTc').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.trafficCtrl_nstr.t_enVoip
    });

    (function init() {
        tcEntry = $.act(ACT_GET, TC, null, null);

        var wlanObj, wlanObj5g;
        if (INCLUDE_LAN_WLAN_GUESTNETWORK) {
            var basicList = $.act(ACT_GL, LAN_WLAN, null, null, ['X_TP_Band']);
            if (!$.exe()) {
                $.each(basicList, function() {
                    if ('2.4GHz' == this.X_TP_Band) {
                        wlanObj = this;
                    } else if (INCLUDE_LAN_WLAN_DUALBAND && '5GHz' == this.X_TP_Band) {
                        wlanObj5g = this;
                    }
                });

                guestnetObj = $.act(ACT_GET, LAN_WLAN_GUESTNET, wlanObj.__stack, null, null);
                if (INCLUDE_LAN_WLAN_DUALBAND) {
                    guestnetObj5g = $.act(ACT_GET, LAN_WLAN_GUESTNET, wlanObj5g.__stack, null, null);
                }
            }
        }

        // if (INCLUDE_GERMANY_SPEC) {
        //     $('#div_linkType').addClass('nd');
        // }

        if (!$.exe()) {
            initType();
            initTc();
            // initRuleTable();
            if (INCLUDE_LAN_WLAN_GUESTNETWORK) {
                // initTcRuleTableForGN();
            }
        }
    })();

    function initType() {
		if (1) { /* for ac3150 */
			$('#div_linkType').addClass('nd');
		} else {
			var wanComInfList = $.act(ACT_GL, WAN_COMMON_INTF_CFG, null, null, ['WANAccessType']);
			ewanEnable = false;

			if (!$.exe()) {
				var dslStk;
				var ewanStk;
				$.each(wanComInfList, function() {
					if (this.WANAccessType == 'DSL') {
						dslStk = this.__stack;
					} else if (this.WANAccessType == 'Ethernet') {
						ewanStk = this.__stack;
					}
				});
			}

				var wanDslCfg = $.act(ACT_GET, WAN_DSL_INTF_CFG, dslStk, null, ['status', 'upstreamCurrRate', 'downstreamCurrRate']);
				if (!$.exe()) {
					wanDslStatus = wanDslCfg.status;
					if (wanDslCfg.status == 'Up') {
						$('#curDslUp').removeClass('nd');
						$('#curDslDown').removeClass('nd');
                $('#upStreamCurrRate').html(wanDslCfg.upstreamCurrRate + ' ' + $.tpLang.s_str.kbps);
                $('#downStreamCurrRate').html(wanDslCfg.downstreamCurrRate + ' ' + $.tpLang.s_str.kbps);
					}
				}

			if (!INCLUDE_GERMANY_SPEC) {
				var ewanCfg = $.act(ACT_GET, WAN_ETH_INTF, ewanStk, null, ['enable']);
				if (!$.exe()) {
					ewanEnable = ewanCfg.enable;
				}
			}

			upstreamCurrRate = wanDslCfg.upstreamCurrRate;
			downstreamCurrRate = wanDslCfg.downstreamCurrRate;
		}
    }

    function initTc() {
        if (!INCLUDE_QOS) {
            $('#enableTc').flipSwitch({
                'on': (tcEntry.enable == 0) ? false : true
            });

            if (tcEntry.enable == 0) {
                $('#tcCont').addClass('nd');
            }
            // if (!INCLUDE_GERMANY_SPEC) {
            //     if (tcEntry.linkType == 1) {
            //         $('#linkType').selectMobile('value', 'adsl_type');
            //     }
            //     if (tcEntry.linkType == 0) {
            //         $('#linkType').selectMobile('value', 'other_type');
            //     }
            // }

            $('#upTotalBW').val(tcEntry.upTotalBW == 0 ? '' : tcEntry.upTotalBW);
            $('#downTotalBW').val(tcEntry.downTotalBW == 0 ? '' : tcEntry.downTotalBW);
        } else {

            // $('#tcHeader').addClass('nd');
            // $('#tcEnableBox').addClass('nd');
            // $('#tcCont').addClass('nd');
            // $('#saveBtn').addClass('nd');
        }

        var iptvFlag = false;
/* for ac3150
        if (INCLUDE_GERMANY_SPEC) {
            iptvFlag = INCLUDE_IPTV;
        } else {
            iptvFlag = INCLUDE_IPTV && ewanEnable == false;
        }
*/
        if (iptvFlag) {
            $('#iptvTcCont').removeClass('nd');

            if (1 == tcEntry.iptvEnable) {
                $('#enableIptvTc').checkboxMobile({
                    'checked': true
                });
                $('#iptv_elem').removeClass('nd');
            } else {
                $('#enableIptvTc').checkboxMobile({
                    'checked': false
                });
                $('#iptv_elem').addClass('nd');
            }

            $('#iptvUpMinBW').val((tcEntry.iptvUpMinBW == 0) ? '' : tcEntry.iptvUpMinBW);
            $('#iptvDownMinBW').val((tcEntry.iptvDownMinBW == 0) ? '' : tcEntry.iptvDownMinBW);
        }

        if (INCLUDE_VOIP) {
            $('#voipTcCont').removeClass('nd');
            $('#enableVoIPTc').checkboxMobile({
                'checked': ((tcEntry.voIPEnable == 1) ? true : false)
            });
        }

        if (INCLUDE_LAN_WLAN_GUESTNETWORK) {
            if ((1 == guestnetObj.TCEnable && 1 == guestnetObj.enable) ||
                (INCLUDE_LAN_WLAN_DUALBAND && 1 == guestnetObj5g.TCEnable && 1 == guestnetObj5g.enable)) {
                $('#guestTcCont').removeClass('nd');
            } else {
                $('#guestTcCont').addClass('nd');
            }
        }
    }


    function clickEnTc() {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        $.exe(function (ret){
            if (!ret) {
                $.stopWaitingMobile();
                rebootTc();
            }
        });
    }

    function goBack() {
        $.reload();
    }

    function rebootTc() {
        $.guageMobile("<span>" + $.tpLang.s_str.wait_reboot + "</span>", 100, $.guageInterval, function() {
            $.refresh();
        });
        $.act(ACT_OP, ACT_OP_REBOOT);
        $.exe(true);
    }

    function doSave() {
        tcSettings = {};

        if (!INCLUDE_QOS) {
            tcSettings.enable = $('#enableTc').flipSwitch('option', 'on') == true ? 3 : 0;
            if (tcSettings.enable != 0) {
                /*  if (wanDslStatus == 'Up') {
                                    
                        if (parseInt($('#upTotalBW').val(), 10) > upstreamCurrRate) {
                            $.alert(ERR_TC_BW_UP_LARGER, upstreamCurrRate);
                            $('#upTotalBW').focus();
                            $('#upTotalBW').select();
                            return false;
                        }

                        if (parseInt($('#downTotalBW').val(), 10) > downstreamCurrRate) {
                            $.alert(ERR_TC_BW_DOWN_LARGER, downstreamCurrRate);
                            $('#downTotalBW').focus();
                            $('#downTotalBW').select();
                            return false;
                        }
                    }*/

                // if (($('#upTotalBW').val() == '') || (!$.isnum($('#upTotalBW').val())) || (0 == $('#upTotalBW').val())) {
                //     $.alert(ERR_TC_NUM_INVAD);
                //     $('#upTotalBW').focus();
                //     $('#upTotalBW').select();
                //     return false;
                // }

                // if (($('#downTotalBW').val() == '') || (!$.isnum($('#downTotalBW').val())) || (0 == $('#downTotalBW').val())) {
                //     $.alert(ERR_TC_NUM_INVAD);
                //     $('#downTotalBW').focus();
                //     $('#downTotalBW').select();
                //     return false;
                // }
                tcSettings.upTotalBW = parseInt($('#upTotalBW').val(), 10);
                tcSettings.downTotalBW = parseInt($('#downTotalBW').val(), 10);
                // tcSettings.linkType = $('#adsl_type').prop('checked') == true ? 1 : 0;
                // if (INCLUDE_GERMANY_SPEC) {
                //     tcSettings.linkType = tcEntry.linkType;
                // }
                // else {
                //     tcSettings.linkType = $('#linkType').selectMobile('value');
                // }
                tcSettings.linkType = 0; /* for ac3150 */
                /*
                if (sysMode.mode == "DSL") {
                    tcSettings.linkType = 1;
                } else {
                    tcSettings.linkType = 0;
                }
                */
            }
        } else {
            tcSettings.enable = tcEntry.enable;
            tcSettings.upTotalBW = tcEntry.upTotalBW;
            tcSettings.downTotalBW = tcEntry.upTotalBW;
            tcSettings.linkType = tcEntry.linkType;
        }

        if (tcSettings.enable != 0) {
            if (0/*INCLUDE_IPTV*/) {
                tcSettings.iptvEnable = $('#enableIptvTc').checkboxMobile('option', 'checked') == true ? 1 : 0;
                if (tcSettings.iptvEnable != 0) {

                    if (1 == (tcSettings.enable & 1)) {
                        check_iptvUpMinBW = true;
                        /*if (($('#iptvUpMinBW').val() == '') ||
                            (!$.isnum($('#iptvUpMinBW').val())) ||
                            (0 == parseInt($('#iptvUpMinBW').val(), 10))) {
                            $.alert(ERR_TC_NUM_INVAD);
                            $('#iptvUpMinBW').focus();
                            $('#iptvUpMinBW').select();
                            return false;
                        }*/
                    }

                    if (2 == (tcSettings.enable & 2)) {
                        check_iptvDownMinBW = true;
                        /*if (($('#iptvDownMinBW').val() == '' ||
                                (!$.isnum($('#iptvDownMinBW').val())) ||
                                (0 == parseInt($('#iptvDownMinBW').val(), 10)))) {
                            $.alert(ERR_TC_NUM_INVAD);
                            $('#iptvDownMinBW').focus();
                            $('#iptvDownMinBW').select();
                            return false;
                        }*/
                    }

                    tcSettings.iptvUpMinBW = parseInt($('#iptvUpMinBW').val(), 10);
                    tcSettings.iptvDownMinBW = parseInt($('#iptvDownMinBW').val(), 10);
                }
            }

            if (INCLUDE_VOIP) {
                tcSettings.voIPEnable = $('#enableVoIPTc').checkboxMobile('option', 'checked') == true ? 1 : 0;
            }

            if (0/*INCLUDE_IPTV*/ && INCLUDE_VOIP && $('#enableTc').flipSwitch('option', 'on') == true && $('#enableIptvTc').checkboxMobile('option', 'checked') == true && $('#enableVoIPTc').checkboxMobile('option', 'checked') == true) {
                check_iptvUpMinBW2 = true;
                // if (parseInt($('#iptvUpMinBW').val(), 10) >= parseInt($('#upTotalBW').val(), 10)) {
                //     $.alert(CMM_TC_UP_TOTAL_BW);
                //     $('#iptvUpMinBW').focus();
                //     $('#iptvUpMinBW').select();
                //     return false;
                // }
            }
        }


        if (!$.checkAllInput()) {
            return false;
        }
        $.act(ACT_SET, TC, null, null, tcSettings);
        if (1 /* 'INCLUDE_TC_REBOOT' in window && INCLUDE_TC_REBOOT == 1 */) {
            if (!INCLUDE_QOS) 
            {
                if (tcSettings.enable != 0 ^ tcEntry.enable != 0)
                {
                    $.confirmMobile($.tpLang.c_str.chgmod, clickEnTc, goBack);
                    return true;
                }
            }            
        }

        $.exe(function(ret) {
            if (!ret) {
                $.removeLoading();
                $.reload();
            }
        });
    }
})();
</script>
