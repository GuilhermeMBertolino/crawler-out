<div>
    <div class="titleBar">
        <a url="systemTools.mobile.htm"><span class="icon-back sprite c-arrow-blue-left" ></span></a>
        <h1>Time Settings</h1>
        <a id="tb_Save" data-status="save">Save</a>
    </div>

    <div class="item-list mt15">
        <div class="section-container" id="div_region">
        <div class="section-box">
            <label class="section-labelTitle">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.s_str.region%>
                </script>
            </label>
            <select id="region">
                <option value="none">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.time_nstr.t_plssel%>
                    </script>
                </option>
            </select>
        </div>
    </div>
    <div class="section-container mtNo">
        <div class="section-box">
            <span>
                <script type="text/html" class="title-string">
                    <%=$.tpLang.time_nstr.curTime%>
                </script>
            </span>
            <span class="floatRight" id="current_time"></span>
        </div>
    </div>
    <div class="section-container mtNo">
        <div class="section-box">
            <label class="section-labelTitle" for="set_type">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.time_nstr.setType%>
                </script>
            </label>
            <select id="set_type">
            </select>
        </div>
    </div>
    </div>

    <div class="item-list mt15">
        <div class="section-container" id="auto_div">
        <div class="section-box">
            <label class="section-labelTitle" for="timezone">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.s_str.timezone%>
                </script>
            </label>
            <select id="timezone">
            </select>
        </div>
        <div class="section-box">
            <input type="text" id="ntpA" />
        </div>
        <div class="section-box">
            <input type="text" id="ntpB" />
        </div>
        <div class="section-box">
            <input type="button" id="GetTime" />
        </div>
    </div>
    </div>

    <div id="manual_div" class="item-list mt15 nd">
        <div class="section-container">
        <div class="section-box">
            <input type="text" id="date" />
        </div>
        <div class="section-box">
            <label class="section-labelTitle">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.time_nstr.t_time%>
                </script>
            </label>
            <div class="flexible-box spaceBetween sameWidth">
                <select id="hour" class="grow-part">
                </select>
                <span class="fixed-part">:</span>
                <select id="minute" class="grow-part">
                </select>
                <span class="fixed-part">:</span>
                <select id="second" class="grow-part">
                </select>
            </div>
        </div>
    </div>
    </div>

    <div id="webIncludeDST" class="item-list mt15 nd">
        <div class="section-container">
            <div class="section-box">
                <div>
                    <span>
                        Daylight Saving Time:
                    </span>
                </div>
                <input type="checkbox" id="enableDST" />
            </div>
        </div>
        <div id="dstShow">
        <div class="section-container mtNo">
            <div class="section-box single">
                <label class="section-labelTitle">
                    <span>
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.m_str.start%>:
                        </script>
                    </span>
                    <span class="floatRight" id="dst_start_year"></span>
                </label>
                <div class="flexible-box spaceBetween sameWidth">
                    <select id="dst_start_month" class="grow-part">
                    </select>
                    <select id="dst_start_weekCount" class="grow-part">
                    </select>
                    <select id="dst_start_weekDay" class="grow-part">
                    </select>
                    <select id="dst_start_time" class="grow-part">
                    </select>
                </div>
            </div>
        </div>
        <div class="section-container mtNo">
            <div class="section-box">
                <label class="section-labelTitle">
                    <span>
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.m_str.end%>:
                        </script>
                    </span>
                    <span class="floatRight" id="dst_end_year"></span>
                </label>
                <div class="flexible-box spaceBetween sameWidth">
                    <select id="dst_end_month" class="grow-part">
                    </select>
                    <select id="dst_end_weekCount" class="grow-part">
                    </select>
                    <select id="dst_end_weekDay" class="grow-part">
                    </select>
                    <select id="dst_end_time" class="grow-part">
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script type="text/javascript">
(function() {
    $.tpLocal('title-string', $.tpLang);
    $('.titleBar').titleBar();
    $('.titleBar').titleBar('title', $.tpLang.menu_str.time);
    $('#tb_Save').titleButton('status', 'save', $.tpLang.m_str.save);

    $('#region').selectMobile();

    if (!INCLUDE_WEB_REGION) {
        $('#div_region').addClass('nd');
        $('#div_region').siblings('.section-container').first().removeClass('mtNo').addClass('mt15');
    }

    var options_set_type = [{
        'value': 'auto',
        'text': $.tpLang['time_nstr']['auto']
    }, {
        'value': 'manual',
        'text': $.tpLang['time_nstr']['manual']
    }];
    $('#set_type').selectMobile()
        .selectMobile('appendOptions', options_set_type)
        .on('change', function() {
            if ($('#set_type').selectMobile('value') == 'auto') {
                $('#auto_div').removeClass('nd');
                $('#manual_div').addClass('nd');
            }
            if ($('#set_type').selectMobile('value') == 'manual') {
                $('#auto_div').addClass('nd');
                $('#manual_div').removeClass('nd');
            }
        });

    var options_timezone = [{
        'value': '-12:00',
        'text': $.tpLang.s_str['city1']
    }, {
        'value': '-11:00',
        'text': $.tpLang.s_str['city2']
    }, {
        'value': '-10:00',
        'text': $.tpLang.s_str['city3']
    }, {
        'value': '-09:00',
        'text': $.tpLang.s_str['city4']
    }, {
        'value': '-08:00',
        'text': $.tpLang.s_str['city5']
    }, {
        'value': '-07:00',
        'text': $.tpLang.s_str['city6']
    }, {
        'value': '-06:00',
        'text': $.tpLang.s_str['city7']
    }, {
        'value': '-05:00',
        'text': $.tpLang.s_str['city8']
    }, {
        'value': '-04:30',
        'text': $.tpLang.s_str['city9']
    }, {
        'value': '-04:00',
        'text': $.tpLang.s_str['city10']
    }, {
        'value': '-03:30',
        'text': $.tpLang.s_str['city11']
    }, {
        'value': '-03:00',
        'text': $.tpLang.s_str['city12']
    }, {
        'value': '-02:00',
        'text': $.tpLang.s_str['city13']
    }, {
        'value': '-01:00',
        'text': $.tpLang.s_str['city14']
    }, {
        'value': '+00:00',
        'text': $.tpLang.s_str['city15']
    }, {
        'value': '+01:00',
        'text': $.tpLang.s_str['city16']
    }, {
        'value': '+02:00',
        'text': $.tpLang.s_str['city17']
    }, {
        'value': '+03:00',
        'text': $.tpLang.s_str['city18']
    }, {
        'value': '+03:30',
        'text': $.tpLang.s_str['city19']
    }, {
        'value': '+04:00',
        'text': $.tpLang.s_str['city20']
    }, {
        'value': '+04:30',
        'text': $.tpLang.s_str['city21']
    }, {
        'value': '+05:00',
        'text': $.tpLang.s_str['city22']
    }, {
        'value': '+05:30',
        'text': $.tpLang.s_str['city23']
    }, {
        'value': '+05:45',
        'text': $.tpLang.s_str['city24']
    }, {
        'value': '+06:00',
        'text': $.tpLang.s_str['city25']
    }, {
        'value': '+06:30',
        'text': $.tpLang.s_str['city26']
    }, {
        'value': '+07:00',
        'text': $.tpLang.s_str['city27']
    }, {
        'value': '+08:00',
        'text': $.tpLang.s_str['city28']
    }, {
        'value': '+09:00',
        'text': $.tpLang.s_str['city29']
    }, {
        'value': '+09:30',
        'text': $.tpLang.s_str['city30']
    }, {
        'value': '+10:00',
        'text': $.tpLang.s_str['city31']
    }, {
        'value': '+11:00',
        'text': $.tpLang.s_str['city32']
    }, {
        'value': '+12:00',
        'text': $.tpLang.s_str['city33']
    }, {
        'value': '+13:00',
        'text': $.tpLang.s_str['city34']
    }];

    $('#timezone').selectMobile().selectMobile('appendOptions', options_timezone);

    $('#ntpA').inputBoxMobile({
        'title': $.tpLang.time_nstr['t_npt1'],
        'placeholder': $.tpLang.time_nstr['c_optional']
    });
    $('#ntpB').inputBoxMobile({
        'title': $.tpLang.time_nstr['t_npt2'],
        'placeholder': $.tpLang.time_nstr['c_optional']
    });
    $('#GetTime').buttonMobile({
        'text': $.tpLang.time_nstr['GetTime']
    }).bind('click.buttonMobile', function() {
        // if (first) {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        doGetTime();
        // }
    });

    function checkDate() {
        var element;
        var dateArray = $('#date').inputBoxMobile('option', 'value').split('/');
        var year, month, day;
        if (INCLUDE_DAY_MONTH_YEAR == 1) {
            year = dateArray[2];
            month = dateArray[1];
            day = dateArray[0];
        } else {
            year = dateArray[2];
            month = dateArray[0];
            day = dateArray[1];
        }
        if ((year == '') || ($.num(year, [1970, 2037], true))) {
            return e_str[ERR_TIME_YEAR_INVAD];
            element = $('#date');
            if (element) {
                element.focus();
                element.select();
            }
            return false;
        }
        if ((month == '') || ($.num(month, [1, 12], true))) {
            return e_str[ERR_TIME_MONTH_INVAD];
            element = $('#date');
            if (element) {
                element.focus();
                element.select();
            }
            return false;
        }
        if ((day == '') || ($.num(day, [1, 31], true))) {
            return e_str[ERR_TIME_DAY_INVAD];
            element = $('#date');
            if (element) {
                element.focus();
                element.select();
            }
            return false;
        }

        return true;
    }


    $('#date').inputBoxMobile({
        'title': $.tpLang.time_nstr['t_date'],
        'placeholder': INCLUDE_DAY_MONTH_YEAR ? $.tpLang.time_nstr['t_format_dmy'] : $.tpLang.time_nstr['t_format'],
        'warnings': [{
            func: checkDate,
            text: ''
        }]
    });

    var options_hour = [];
    for (var i = 0; i < 24; i++) {
        options_hour[i] = {
            'text': i,
            'value': i
        };
    }
    $('#hour').selectMobile().selectMobile('appendOptions', options_hour);
    var options_minute = [];
    for (var i = 0; i < 60; i++) {
        options_minute[i] = {
            'text': i,
            'value': i
        };
    }
    $('#minute').selectMobile().selectMobile('appendOptions', options_minute);
    var options_second = [];
    for (var i = 0; i < 60; i++) {
        options_second[i] = {
            'text': i,
            'value': i
        };
    }
    $('#second').selectMobile().selectMobile('appendOptions', options_second);

    $('#enableDST').checkboxMobile({
            'hasTitle': true,
            'title': $.tpLang.time_nstr['t_dlsaving1']
        })
        .bind('check.checkboxMobile', function() {
            $('#dstShow').slideDown('fast');
            // ($('#webIncludeDST').find('select')).selectMobile('disabled', false);
        })
        .bind('uncheck.checkboxMobile', function() {
            $('#dstShow').slideUp('fast');
            // ($('#webIncludeDST').find('select')).selectMobile('disabled', true);
        });

    var options_month = [{
        'text': $.tpLang.time_nstr['c_month1'],
        'value': '01'
    }, {
        'text': $.tpLang.time_nstr['c_month2'],
        'value': '02'
    }, {
        'text': $.tpLang.time_nstr['c_month3'],
        'value': '03'
    }, {
        'text': $.tpLang.time_nstr['c_month4'],
        'value': '04'
    }, {
        'text': $.tpLang.time_nstr['c_month5'],
        'value': '05'
    }, {
        'text': $.tpLang.time_nstr['c_month6'],
        'value': '06'
    }, {
        'text': $.tpLang.time_nstr['c_month7'],
        'value': '07'
    }, {
        'text': $.tpLang.time_nstr['c_month8'],
        'value': '08'
    }, {
        'text': $.tpLang.time_nstr['c_month9'],
        'value': '09'
    }, {
        'text': $.tpLang.time_nstr['c_month10'],
        'value': '10'
    }, {
        'text': $.tpLang.time_nstr['c_month11'],
        'value': '11'
    }, {
        'text': $.tpLang.time_nstr['c_month12'],
        'value': '12'
    }];
    $('#dst_start_month').selectMobile().selectMobile('appendOptions', options_month);
    $('#dst_end_month').selectMobile().selectMobile('appendOptions', options_month);
    var options_weekCount = [{
        'text': $.tpLang.time_nstr['c_week1'],
        'value': '1'
    }, {
        'text': $.tpLang.time_nstr['c_week2'],
        'value': '2'
    }, {
        'text': $.tpLang.time_nstr['c_week3'],
        'value': '3'
    }, {
        'text': $.tpLang.time_nstr['c_week4'],
        'value': '4'
    }, {
        'text': $.tpLang.time_nstr['c_week5'],
        'value': '5'
    }];
    $('#dst_start_weekCount').selectMobile().selectMobile('appendOptions', options_weekCount);
    $('#dst_end_weekCount').selectMobile().selectMobile('appendOptions', options_weekCount);
    var options_weekDay = [{
        'text': $.tpLang.time_nstr['c_day1'],
        'value': '1'
    }, {
        'text': $.tpLang.time_nstr['c_day2'],
        'value': '2'
    }, {
        'text': $.tpLang.time_nstr['c_day3'],
        'value': '3'
    }, {
        'text': $.tpLang.time_nstr['c_day4'],
        'value': '4'
    }, {
        'text': $.tpLang.time_nstr['c_day5'],
        'value': '5'
    }, {
        'text': $.tpLang.time_nstr['c_day6'],
        'value': '6'
    }, {
        'text': $.tpLang.time_nstr['c_day7'],
        'value': '7'
    }];
    $('#dst_start_weekDay').selectMobile().selectMobile('appendOptions', options_weekDay);
    $('#dst_end_weekDay').selectMobile().selectMobile('appendOptions', options_weekDay);
    var options_time = [{
        'text': '00:00',
        'value': '00:00:00'
    }, {
        'text': '01:00',
        'value': '01:00:00'
    }, {
        'text': '02:00',
        'value': '02:00:00'
    }, {
        'text': '03:00',
        'value': '03:00:00'
    }, {
        'text': '04:00',
        'value': '04:00:00'
    }, {
        'text': '05:00',
        'value': '05:00:00'
    }, {
        'text': '06:00',
        'value': '06:00:00'
    }, {
        'text': '07:00',
        'value': '07:00:00'
    }, {
        'text': '08:00',
        'value': '08:00:00'
    }, {
        'text': '09:00',
        'value': '09:00:00'
    }, {
        'text': '10:00',
        'value': '10:00:00'
    }, {
        'text': '11:00',
        'value': '11:00:00'
    }, {
        'text': '12:00',
        'value': '12:00:00'
    }, {
        'text': '13:00',
        'value': '13:00:00'
    }, {
        'text': '14:00',
        'value': '14:00:00'
    }, {
        'text': '15:00',
        'value': '15:00:00'
    }, {
        'text': '16:00',
        'value': '16:00:00'
    }, {
        'text': '17:00',
        'value': '17:00:00'
    }, {
        'text': '18:00',
        'value': '18:00:00'
    }, {
        'text': '19:00',
        'value': '19:00:00'
    }, {
        'text': '20:00',
        'value': '20:00:00'
    }, {
        'text': '21:00',
        'value': '21:00:00'
    }, {
        'text': '22:00',
        'value': '22:00:00'
    }, {
        'text': '23:00',
        'value': '23:00:00'
    }];
    $('#dst_start_time').selectMobile().selectMobile('appendOptions', options_time);
    $('#dst_end_time').selectMobile().selectMobile('appendOptions', options_time);

    $("select[id^='dst_']").on('click', function() {
        checkDstDate();
    });

    function initRegionList() {
        var options_region = [];
        for (var i = 0; i < regionCodeInfo.length; i++) {
            options_region[i] = {
                'text': regionCodeInfo[i][4],
                'value': i
            }
        }
        $('#region').selectMobile('appendOptions', options_region);
    }

    function getStatus() {
        var getgmtStr = $.tpLang.s_str.getgmt;
        var gmtfailStr = $.tpLang.s_str.gmtfail;
        $('#GetTime').buttonMobile({
            'disabled': true
        });
        $.auto(function() {
            var timeobj = $.act(ACT_GET, TIME, null, null, ['__status']);
            if (!$.exe()) {
                if (timeobj.__status == 1) {
                    $.startWaitingMobile(getgmtStr);
                } else if (timeobj.__status == 2) {
                    $.stopWaitingMobile();
                    $.loadPhoneMain();
                    return false;
                } else if (timeobj.__status == 3) {
                    $.stopWaitingMobile();
                    $.alertMobile(gmtfailStr);
                    $('#GetTime').buttonMobile({
                        'disabled': false
                    });
                    return false;
                }
            }
        }, 1000);
    }

    function doGetTime() {
        $.act(ACT_SET, TIME, null, null, ["localTimeZone=" + $("#timezone").selectMobile('value'), "NTPServer1=" + $("#ntpA").inputBoxMobile('option', 'value'), "NTPServer2=" + $("#ntpB").inputBoxMobile('option', 'value')]);
        $.act(ACT_OP, ACT_OP_NTP_REQUEST);
        $.exe(function(ret) {
            $.stopWaitingMobile();
            if (!ret)
                getStatus();
        });
    }

    function checkDstDate() {
        var dstStartString = $('#dst_start_month').selectMobile('value') + $('#dst_start_weekCount').selectMobile('value') + $('#dst_start_weekDay').selectMobile('value') + $('#dst_start_time').selectMobile('value');
        var dstEndString = $('#dst_end_month').selectMobile('value') + $('#dst_end_weekCount').selectMobile('value') + $('#dst_end_weekDay').selectMobile('value') + $('#dst_end_time').selectMobile('value');
        var dateArray = $('#date').inputBoxMobile('option', 'value').split('/');
        $('#dst_start_year').html(dateArray[2]);
        if (dstStartString > dstEndString) {
            var endYear = parseInt(dateArray[2], 10) + 1;
            $('#dst_end_year').html(endYear);
        } else {
            var endYear = parseInt(dateArray[2], 10);
            $('#dst_end_year').html(endYear);
        }
    }

    function doEnableDst() {
        if ($('#enableDST').checkboxMobile('option', 'checked') == true) {
            ($('#webIncludeDST').find('select')).selectMobile('disabled', false);
        } else {
            ($('#webIncludeDST').find('select')).selectMobile('disabled', true);
        }
    }

    (function init() {
        var hour = $.act(ACT_GET, HOUR, null, null, ['year', 'month', 'day', 'hours', 'minutes', 'seconds']);
        var time = {};
        var options = {
            refresh: 1
        };
        if (INCLUDE_WEB_REGION) {
            initRegionList();
        }
        // var local = $.act(ACT_GET, LOCAL, null, null, ['country']);
        var wlanList = $.act(ACT_GL, LAN_WLAN, null, null, ['RegulatoryDomain']);
        if (WEB_INCLUDE_DST) {
            $('#webIncludeDST').removeClass('nd');
            time = $.act(ACT_GET, TIME, null, null, ['localTimeZone', 'NTPServer1', 'NTPServer2', '__status', 'daylightSavingsUsed', 'daylightSavingsStart', 'daylightSavingsEnd', 'X_TP_DaylightSavingsStartWeekCount', 'X_TP_DaylightSavingsEndWeekCount']);
        } else {
            time = $.act(ACT_GET, TIME, null, null, ['localTimeZone', 'NTPServer1', 'NTPServer2', '__status']);
        }

        if (!$.exe()) {
            if (INCLUDE_WEB_REGION) {
                var i = 0;
                for (i = 0; i < regionCodeInfo.length; i++) {
                    if (wlanList[0].regulatoryDomain == regionCodeInfo[i][1]) {
                        break;
                    }
                }
                if (i < regionCodeInfo.length) {
                    $('#region').selectMobile('value', i);
                }                
            }

            var monthTemp = hour.month;
            if (monthTemp < 10) monthTemp = '0' + monthTemp;
            var dayTemp = hour.day;
            if (dayTemp < 10) dayTemp = '0' + dayTemp;
            if (INCLUDE_DAY_MONTH_YEAR) {
                date = dayTemp + '/' + monthTemp + '/' + hour.year;
            } else {
                date = monthTemp + '/' + dayTemp + '/' + hour.year;
            }
            var hoursTemp = hour.hours;
            if (hoursTemp < 10) hoursTemp = '0' + hoursTemp;
            var minutesTemp = hour.minutes;
            if (minutesTemp < 10) minutesTemp = '0' + minutesTemp;
            var secondsTemp = hour.seconds;
            if (secondsTemp < 10) secondsTemp = '0' + secondsTemp;
            var timeNow = hoursTemp + ':' + minutesTemp + ':' + secondsTemp;

            $('#current_time').html(date + ' ' + timeNow);
            $.auto(function() {
                var hour = $.act(ACT_GET, HOUR, null, null, ['year', 'month', 'day', 'hours', 'minutes', 'seconds']);
                if (!$.exe()) {
                    var monthTemp = hour.month;
                    if (monthTemp < 10) monthTemp = '0' + monthTemp;
                    var dayTemp = hour.day;
                    if (dayTemp < 10) dayTemp = '0' + dayTemp;
                    var date;
                    if (INCLUDE_DAY_MONTH_YEAR == 1) {
                        date = dayTemp + '/' + monthTemp + '/' + hour.year;
                    } else {
                        date = monthTemp + '/' + dayTemp + '/' + hour.year;
                    }
                    var hoursTemp = hour.hours;
                    if (hoursTemp < 10) hoursTemp = '0' + hoursTemp;
                    var minutesTemp = hour.minutes;
                    if (minutesTemp < 10) minutesTemp = '0' + minutesTemp;
                    var secondsTemp = hour.seconds;
                    if (secondsTemp < 10) secondsTemp = '0' + secondsTemp;
                    var timeNow = hoursTemp + ':' + minutesTemp + ':' + secondsTemp;
                    $('#current_time').html(date + ' ' + timeNow);
                } else {
                    return false;
                }
            }, 300);

            $('#date').inputBoxMobile({
                'value': date
            });
            $('#hour').selectMobile('value', hour.hours);
            $('#minute').selectMobile('value', hour.minutes);
            $('#second').selectMobile('value', hour.seconds);

            $('#ntpA').inputBoxMobile({
                'value': (time.NTPServer1 ? time.NTPServer1 : '0.0.0.0'),
                'warnings': [{
                    func: function() {
                        if (($('#ntpA').inputBoxMobile('option', 'value') != '') && (!$.isdomain($('#ntpA').inputBoxMobile('option', 'value')))) {
                            element = $('#ntpA');
                            if (element) {
                                element.focus();
                                element.select();
                            }
                            return false;
                        } else {
                            return true;
                        }
                    },
                    text: e_str[ERR_TIME_NTP_SERVER]
                }]
            });

            $('#ntpB').inputBoxMobile({
                'value': (time.NTPServer2 ? time.NTPServer2 : '0.0.0.0'),
                'warnings': [{
                    func: function() {
                        if (($('#ntpB').inputBoxMobile('option', 'value') != '') && (!$.isdomain($('#ntpB').inputBoxMobile('option', 'value')))) {
                            element = $('#ntpB');
                            if (element) {
                                element.focus();
                                element.select();
                            }
                            return false;
                        } else {
                            return true;
                        }
                    },
                    text: e_str[ERR_TIME_NTP_SERVER]
                }]
            });
            var zone = time.localTimeZone ? time.localTimeZone : '+08:00';
            $('#timezone').selectMobile('value', zone);


            if (time.__status == 1) {
                getStatus();
            }
            if (WEB_INCLUDE_DST) {
                if (time.daylightSavingsUsed == 1) {
                    $('#enableDST').checkboxMobile({
                        'checked': true
                    });
					document.getElementById('dstShow').style.display = 'block';
                } else {
                    $('#enableDST').checkboxMobile({
                        'checked': false
                    });
					document.getElementById('dstShow').style.display = 'none';
                }
                if (time.daylightSavingsStart != '') {
                    startYear = parseInt(time.daylightSavingsStart.substr(0, 4), 10);
                    dstStartMonth = parseInt(time.daylightSavingsStart.substr(5, 2), 10);
                    dstStartMday = parseInt(time.daylightSavingsStart.substr(8, 2), 10);
                    dstStartTime = parseInt(time.daylightSavingsStart.substr(11, 2), 10);
                    dateTmp = new Date(startYear, dstStartMonth - 1, dstStartMday);
                    dstStartWeekCount = time.X_TP_DaylightSavingsStartWeekCount;
                    dstStartWday = parseInt(dateTmp.getDay(), 10);
                    if (dstStartWday == 0) {
                        dstStartWday = 7;
                    }
                    $('#dst_start_month').selectMobile('selectedIndex', dstStartMonth - 1);
                    $('#dst_start_weekCount').selectMobile('value', dstStartWeekCount);
                    $('#dst_start_weekDay').selectMobile('value', dstStartWday);
                    $('#dst_start_time').selectMobile('selectedIndex', dstStartTime);
                }
                if (time.daylightSavingsEnd != '') {
                    endYear = parseInt(time.daylightSavingsEnd.substr(0, 4), 10);
                    dstEndMonth = parseInt(time.daylightSavingsEnd.substr(5, 2), 10);
                    dstEndMday = parseInt(time.daylightSavingsEnd.substr(8, 2), 10);
                    dstEndTime = parseInt(time.daylightSavingsEnd.substr(11, 2), 10);
                    dateTmp = new Date(endYear, dstEndMonth - 1, dstEndMday);
                    dstEndWday = parseInt(dateTmp.getDay(), 10);
                    dstEndWeekCount = time.X_TP_DaylightSavingsEndWeekCount;
                    if (dstEndWday == 0) {
                        dstEndWday = 7;
                    }
                    $('#dst_end_month').selectMobile('selectedIndex', dstEndMonth - 1);
                    $('#dst_end_weekCount').selectMobile('value', dstEndWeekCount);
                    $('#dst_end_weekDay').selectMobile('value', dstEndWday);
                    $('#dst_end_time').selectMobile('selectedIndex', dstEndTime);
                }

                checkDstDate();
               // doEnableDst();
            }
        }
    })();

    /* setTime Saving */
    function saveWlanRegion() {
        /*    var wlanObj = {};
            var localObj = {};
            for (var i = 0; i < regionCodeInfo.length; i++) {
                if ($('#region').selectMobile('text') == regionCodeInfo[i][4]) {
                    break;
                }
            }
            if (i >= regionCodeInfo.length) {
                return;
            }

            localObj.country = regionCodeInfo[i][1].substring(0, 2);

            $.act(ACT_SET, LOCAL, null, null, localObj);*/

        /*var wlanObj = {};
        for (var i = 0; i < regionCodeInfo.length; i++) {
            if ($("#region").selectMobile('text') == regionCodeInfo[i][4]) {
                break;
            }
        }
        if (i >= regionCodeInfo.length) {
            return;
        }
        wlanObj.regulatoryDomain = regionCodeInfo[i][1];
        wlanObj.autoChannelEnable = 1;
        var wlanList = $.act(ACT_GL, LAN_WLAN, null, null, ["Standard", "X_TP_Bandwidth", "X_TP_Band", "RegulatoryDomain"]);
        $.exe(function() {
            $.each(wlanList, function() {
                if (this.regulatoryDomain == regionCodeInfo[i][1]) {
                    return true;
                }
                if (("JP " == regionCodeInfo[i][1] ||
                        "CR " == regionCodeInfo[i][1] ||
                        "EC " == regionCodeInfo[i][1] ||
                        "RU " == regionCodeInfo[i][1] ||
                        "UA " == regionCodeInfo[i][1]) &&
                    "5GHz" == this.X_TP_Band) {
                    wlanObj.X_TP_Bandwidth = "20M";
                }

                $.act(ACT_SET, LAN_WLAN, this.__stack, null, wlanObj);
                $.exe();
            });
        });

        var wlanObj = {};
        var localObj = {};
        var i = 0;
        for (i = 0; i < regionCodeInfo.length; i++) {
            if ($("#region").selectMobile('text') == regionCodeInfo[i][4]) {
                break;
            }
        }
        if (i >= regionCodeInfo.length) {
            return;
        }

        localObj.country = regionCodeInfo[i][1].substring(0, 2);

        $.act(ACT_SET, LOCAL, null, null, localObj);*/
    }

    function setTimeSaving() {
        var ret;

        var time = {};
        var hour = {};
        var dateArray = $('#date').inputBoxMobile('option', 'value').split('/');

        time.localTimeZone = $('#timezone').selectMobile('value');
        time.NTPServer1 = $('#ntpA').inputBoxMobile('option', 'value');
        time.NTPServer2 = $('#ntpB').inputBoxMobile('option', 'value');

        if (INCLUDE_DAY_MONTH_YEAR == 1) {
            hour.year = parseInt(dateArray[2], 10);
            hour.month = parseInt(dateArray[1], 10);
            hour.day = parseInt(dateArray[0], 10);
        } else {
            hour.year = parseInt(dateArray[2], 10);
            hour.month = parseInt(dateArray[0], 10);
            hour.day = parseInt(dateArray[1], 10);
        }
        hour.hours = parseInt($('#hour').selectMobile('value'), 10);
        hour.minutes = parseInt($('#minute').selectMobile('value'), 10);
        hour.seconds = parseInt($('#second').selectMobile('value'), 10);

        if (INCLUDE_WEB_REGION) {
            saveWlanRegion();
        }
        doSave(time, hour);
    }

    /*DST Saving*/

    var daysPerWeek = 7;

    function isLeapYear(year) {
        return (((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0))
    }

    function isValidDate(year, mon, date) {
        var daysPerMonth = new Array(31, 0, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);

        daysPerMonth[1] = isLeapYear(year) ? 29 : 28;

        return (date <= daysPerMonth[mon]);
    }

    function getMday(year, mon, weekCnt, wDay) {
        var ret = 0;
        var dateTmp;
        wDay = (wDay + 1) % daysPerWeek;
        dateTmp = new Date(year, mon, 1);
        firstWday = parseInt(dateTmp.getDay(), 10);

        ret = weekCnt * daysPerWeek + wDay - firstWday + 1;
        if (wDay < firstWday)
            ret = ret + daysPerWeek;

        if (weekCnt == 4 && !isValidDate(year, mon, ret)) {
            ret = ret - daysPerWeek;
        }

        if (ret < 10) {
            ret = '0' + ret;
        }
        return ret;
    }

    function DSTSaving() {
        var dstIsEnable = 0;
        var dstStartYear, dstEndYear;
        var dstStartMday, dstEndMday;
        var dstStartArgs = '',
            dstEndArgs = '';
        if (WEB_INCLUDE_DST) {
            if ($('#enableDST').checkboxMobile('option', 'checked') == true) {
                dstIsEnable = 1;
                dstStartYear = parseInt($('#dst_start_year').html(), 10);
                var dstStartMonthIndex = parseInt($('#dst_start_month').selectMobile('value'), 10) - 1;
                var dstStartWeekCountIndex = parseInt($('#dst_start_weekCount').selectMobile('value'), 10) - 1;
                var dstStartWeekDayIndex = parseInt($('#dst_start_weekDay').selectMobile('value'), 10) - 1;
                dstStartMday = getMday(dstStartYear, dstStartMonthIndex, dstStartWeekCountIndex, dstStartWeekDayIndex);
                dstStartArgs = dstStartYear + '-' + $('#dst_start_month').selectMobile('value') + '-' + dstStartMday + 'T' + $('#dst_start_time').selectMobile('value');
                dstEndYear = parseInt($('#dst_end_year').html(), 10);
                var dstEndMonthIndex = parseInt($('#dst_end_month').selectMobile('value'), 10) - 1;
                var dstEndWeekCountIndex = parseInt($('#dst_end_weekCount').selectMobile('value'), 10) - 1;
                var dstEndWeekDayIndex = parseInt($('#dst_end_weekDay').selectMobile('value'), 10) - 1;
                dstEndMday = getMday(dstEndYear, dstEndMonthIndex, dstEndWeekCountIndex, dstEndWeekDayIndex);
                dstEndArgs = dstEndYear + '-' + $('#dst_end_month').selectMobile('value') + '-' + dstEndMday + 'T' + $('#dst_end_time').selectMobile('value');

                if (dstStartArgs >= dstEndArgs) {
                    dstEndYear += 1;
                    dstEndArgs = dstEndYear + '-' + $('#dst_end_month').selectMobile('value') + '-' + dstEndMday + 'T' + $('#dst_end_time').selectMobile('value');
                }

            }
        }
        if (WEB_INCLUDE_DST) {
            if (dstIsEnable == 1) {
                $.act(ACT_SET, TIME, null, null, ['localTimeZone=' + $('#timezone').selectMobile('value'),
                    'daylightSavingsUsed=' + dstIsEnable,
                    'daylightSavingsStart=' + dstStartArgs,
                    'daylightSavingsEnd=' + dstEndArgs,
                    'X_TP_DaylightSavingsStartWeekCount=' + $('#dst_start_weekCount').selectMobile('value'),
                    'X_TP_DaylightSavingsEndWeekCount=' + $('#dst_end_weekCount').selectMobile('value')
                ]);

            } else {
                $.act(ACT_SET, TIME, null, null, ['daylightSavingsUsed=' + dstIsEnable]);
            }
            $.exe(function(ret) {
                $.stopWaitingMobile();
                if (!ret)
                    $.loadPhoneMain();
            });
        }

    }

    function doSave(hour, time) {
        $.act(ACT_SET, TIME, null, null, hour);

        $.act(ACT_SET, HOUR, null, null, time);

        $.exe(function(ret) {
            $.stopWaitingMobile();
            if (!ret)
                $.loadPhoneMain(); //reload
        });
    }

    $('#tb_Save').on('click', function() {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        if (!$.checkAllInput()) return false;
        setTimeSaving();
        DSTSaving();
    });
})();
</script>
