<div id="internet-status">
    <div class="titleBar">
        <a id="back" url="networkMap.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a>
        <h1>
            <script type="text/html" class="title-string">
                <%=$.tpLang.menu_str.internet%>
            </script>
        </h1>
        <a id="edit" data-status="edit">
            <script type="text/html" class="title-string">
                <%=$.tpLang.m_str.edit%>
            </script>
        </a>
    </div>
    <div class="info-list mt15">
        <div class="section-container">
        <div class="section-box">
            <div class="text-right-title">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.status_nstr.c_ipaddr%>
                    </script>
                </span>
            </div>
            <div class="text-right" id="internetIp">
                <span></span>
            </div>
        </div>
    </div>
    <div class="section-container mtNo">
        <div class="section-box">
            <div class="text-right-title">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.status_nstr.c_defgw%>
                    </script>
                </span>
            </div>
            <div class="text-right" id="internetGateway">
                <span></span>
            </div>
        </div>
    </div>
    <div class="section-container mtNo">
        <div class="section-box">
            <div class="text-right-title">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.status_nstr.c_primdns%>
                    </script>
                </span>
            </div>
            <div class="text-right" id="internetDnsp">
                <span></span>
            </div>
        </div>
    </div>
    <div class="section-container mtNo">
        <div class="section-box">
            <div class="text-right-title">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.status_nstr.c_secdns%>
                    </script>
                </span>
            </div>
            <div class="text-right" id="internetDnss">
                <span></span>
            </div>
        </div>
    </div>
    <div class="section-container mtNo">
        <div class="section-box">
            <div class="text-right-title">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.status_nstr.c_conntype%>
                    </script>
                </span>
            </div>
            <div class="text-right" id="internetConnType">
                <span></span>
            </div>
        </div>
    </div>
</div>
</div>
<script type="text/javascript">
    (function() {
        var showType, bStart, step, sysMode = {};
        var wanType, wanTypes, wanIPList, wanPPPList, wanAccessType, currDslType, usb3gLinkCfg;
        var pStk, staticStk, staticEnable, dynStk, dynEnable, PPPoEStk, PPPoEEnable;
        var ethWan, wan_iplist_sta, wan_iplist_dyn, wan_pppoelist;
        var wanConnStack, intfCfgStack;
        (function () {
            $.tpLocal('title-string', $.tpLang);
            $('#internet-status .titleBar').titleBar();
            internetDiagInit();
            internetInit();
            setEvent();
        })();
        function setEvent() {
            if (sysMode.mode === 'USB_3G') {
                $('#edit').addClass('nd');
            }
            $('#edit').on('click', function () {
                if (sysMode.mode === 'DSL') {
                    $.loadPhoneMain('dslInternet.mobile.htm');
                } else if (sysMode.mode === 'ETH') {
                    $.loadPhoneMain('internet.mobile.htm');
                }
            });
        }
        function internetDiagInit() {
            var l3Forward = $.act(ACT_GET, L3_FORWARDING, null, null, ["__ifAliasName"]);
            var ipList = $.act(ACT_GL, WAN_IP_CONN, null, null, ["Enable", "Name", "ConnectionType"]);
            var pppList = $.act(ACT_GL, WAN_PPP_CONN, null, null, ["Enable", "Name"]);
            var commonIntfList = $.act(ACT_GL, WAN_COMMON_INTF_CFG, null, null, ["WANAccessType"]);
            var dslIntfCfgList = INCLUDE_VDSLWAN ? $.act(ACT_GL, WAN_DSL_INTF_CFG, null, null, ["LinkEncapsulationUsed"]) : {};
            var connStack = "";
            var found = false;

            if (INCLUDE_IPV6)
                var l3ForwardIpv6 = $.act(ACT_GET, L3_IP6_FORWARDING, null, null, ["__ifAliasName"]);

            if (INCLUDE_PPTP)
                var pptpList = $.act(ACT_GL, WAN_PPTP_CONN, null, null, ["Enable", "Name"]);
            if (INCLUDE_L2TP)
                var l2tpList = $.act(ACT_GL, WAN_L2TP_CONN, null, null, ["Enable", "Name"]);

            if (INCLUDE_WAN_MODE)
                sysMode = $.act(ACT_GET, SYS_MODE, null, null, ["Mode"]);

            if (INCLUDE_USB_3G_DONGLE)
                var usb3gLinkCfgList = $.act(ACT_GL, WAN_USB_3G_LINK_CFG, null, null, ["Enable", "CardName"]);

            bStart = false;
            step = 0;
            if ($.exe())
                return false;

            $.each(ipList, function() {
                if (this.enable == 1 && (this.name == l3Forward.__ifAliasName)) {
                    wanConnStack = this.__stack;
                    intfCfgStack = $.stkPop(wanConnStack, 2);
                    wanType = "ip";
                    found = true;
                    return false;
                } else if (this.enable == 1 && this.connectionType == "IP_Bridged") {
                    wanType = "ip";
                    wanConnStack = this.__stack;
                    intfCfgStack = $.stkPop(wanConnStack, 2);
                }
            });
            if (found == false) {
                $.each(pppList, function() {
                    if (this.enable == 1 && (this.name == l3Forward.__ifAliasName)) {
                        wanConnStack = this.__stack;
                        intfCfgStack = $.stkPop(wanConnStack, 2);
                        wanType = "ppp";
                        found = true;
                        return false;
                    }
                });
            };
            if (INCLUDE_PPTP && found == false) {
                $.each(pptpList, function() {
                    if (this.enable && this.name == l3Forward.__ifAliasName) {
                        wanConnStack = this.__stack;
                        intfCfgStack = $.stkPop(wanConnStack, 1);
                        wanType = "pptp";
                        found = true;
                        return false;
                    }
                });
            }
            if (INCLUDE_L2TP && found == false) {
                $.each(l2tpList, function() {
                    if (this.enable && this.name == l3Forward.__ifAliasName) {
                        wanConnStack = this.__stack;
                        intfCfgStack = $.stkPop(wanConnStack, 1);
                        wanType = "l2tp";
                        found = true;
                        return false;
                    }
                });
            }

            if (found == false) {
                $.each(ipList, function() {
                    if (this.enable == 1 && (INCLUDE_IPV6 && this.name == l3ForwardIpv6.__ifAliasName)) {
                        wanConnStack = this.__stack;
                        intfCfgStack = $.stkPop(wanConnStack, 2);
                        wanType = "ip";
                        found = true;
                        return false;
                    } else if (this.enable == 1 && this.connectionType == "IP_Bridged") {
                        wanType = "ip";
                        wanConnStack = this.__stack;
                        intfCfgStack = $.stkPop(wanConnStack, 2);
                    }
                });
            };

            if (found == false) {
                $.each(pppList, function() {
                    if (this.enable == 1 && (INCLUDE_IPV6 && this.name == l3ForwardIpv6.__ifAliasName)) {
                        wanConnStack = this.__stack;
                        intfCfgStack = $.stkPop(wanConnStack, 2);
                        wanType = "ppp";
                        found = true;
                        return false;
                    }
                });
            };

            if (found == false) {
                if (INCLUDE_WAN_MODE) {
                    if (sysMode.mode == "DSL")
                        wanAccessType = "DSL";
                    else if (sysMode.mode == "ETH")
                        wanAccessType = "Ethernet";
                    else if (INCLUDE_USB_3G_DONGLE && sysMode.mode == "USB_3G")
                        wanAccessType = "USB_3G";
                } else {
					sysMode.mode = "ETH";
					wanAccessType = "Ethernet";
				}

                $.each(commonIntfList, function() {
                    if (this.WANAccessType == wanAccessType) {
                        intfCfgStack = this.__stack;
                        return false;
                    }
                });
            } else {
				sysMode.mode = "ETH";
                $.each(commonIntfList, function() {
                    if (this.__stack == intfCfgStack) {
                        wanAccessType = this.WANAccessType;
                        intfCfgStack = this.__stack;
                        return false;
                    }
                });
            }

            if (wanAccessType == "DSL") {
                if (INCLUDE_VDSLWAN) {
                    $.each(dslIntfCfgList, function() {
                        if (this.__stack == intfCfgStack) {
                            if (this.linkEncapsulationUsed == "G.992.3_Annex_K_ATM")
                                currDslType = "adsl";
                            else if (this.linkEncapsulationUsed == "G.993.2_Annex_K_PTM")
                                currDslType = "vdsl";
                        }
                    });
                }
            } else if (wanAccessType == "Ethernet") {
                if (wanType == "pptp" || wanType == "l2tp")
                    intfCfgStack = wanConnStack;
                else
                    intfCfgStack = $.stkPop(wanConnStack, 1);
            } else if (INCLUDE_USB_3G_DONGLE && wanAccessType == "USB_3G") {
                $.each(usb3gLinkCfgList, function() {
                    if (this.enable == 1 && $.stkPop(this.__stack, 1) == intfCfgStack) {
                        usb3gLinkCfg = this;
                        return false;
                    }
                });
            }
            return true;
        }
        function internetInit() {
            /* this function must execute after internetDiagInit() */
            if (wanConnStack == "") {
                return;
            }

            var wanDefaultConn = {};
            var bHaveIpv6Param = INCLUDE_IPV6 ? true : false;

            if (wanType == "ppp") {
                wanDefaultConn = $.act(ACT_GET, WAN_PPP_CONN, wanConnStack, null, null);
            } else if (wanType == "ip") {
                wanDefaultConn = $.act(ACT_GET, WAN_IP_CONN, wanConnStack, null, null);
            } else if (INCLUDE_PPTP && wanType == "pptp") {
                wanDefaultConn = $.act(ACT_GET, WAN_PPTP_CONN, wanConnStack, null, null);
                bHaveIpv6Param = false;
            } else if (INCLUDE_L2TP && wanType == "l2tp") {
                wanDefaultConn = $.act(ACT_GET, WAN_L2TP_CONN, wanConnStack, null, null);
                bHaveIpv6Param = false;
            }

            $.exe(function() {
                var dnsv4 = wanDefaultConn.DNSServers ? wanDefaultConn.DNSServers.split(',') : '';
                var dnsv41 = dnsv4[0] ? dnsv4[0] : '0.0.0.0';
                var dnsv42 = dnsv4[1] ? dnsv4[1] : '0.0.0.0';
                var ipv4 = wanDefaultConn.externalIPAddress ? wanDefaultConn.externalIPAddress : '0.0.0.0';
                var gatev4 = wanDefaultConn.defaultGateway ? wanDefaultConn.defaultGateway : '0.0.0.0';
                if (bHaveIpv6Param) {
                    var dnsv6 = wanDefaultConn.X_TP_IPv6DNSServers ? wanDefaultConn.X_TP_IPv6DNSServers.split(',') : '';
                    var dnsv61 = dnsv6[0] ? dnsv6[0] : '::';
                    var dnsv62 = dnsv6[1] ? dnsv6[1] : '::';
                    var ipv6 = wanDefaultConn.X_TP_ExternalIPv6Address ? wanDefaultConn.X_TP_ExternalIPv6Address : '::';
                    var gatev6 = wanDefaultConn.X_TP_DefaultIPv6Gateway ? wanDefaultConn.X_TP_DefaultIPv6Gateway : '::';
                }

                if (wanType == 'ip' && wanDefaultConn.enable == 1) {
                    if (wanDefaultConn.connectionType == "IP_Bridged") {
                        $('#internetConnType span').text($.tpLang.s_str.bridge);
                    } else if (wanDefaultConn.connectionType == "IP_Routed") {
                        var dslLnkStk = $.stkPop(wanDefaultConn.__stack, 1);
                        var wanComStk = $.stkPop(wanDefaultConn.__stack, 2);

                        var wanComInf = $.act(ACT_GET, WAN_COMMON_INTF_CFG, wanComStk, null, null);
						if (INCLUDE_ADSLWAN) {
							var wanDslLnk = $.act(ACT_GET, WAN_DSL_LINK_CFG, dslLnkStk, null, null);
						}

                        if (!$.exe()) {
                            if (INCLUDE_ADSLWAN && wanComInf.WANAccessType == "DSL" && wanDslLnk.linkType == "IPoA") {
                                $('#internetConnType span').text('IPoA');
                                var dns = wanDefaultConn.DNSServers.split(',');
                                $('#internetDnsp span').text(dns[0]);
                                $('#internetDnss span').text(dns[1]);
                                $('#internetIp span').text(wanDefaultConn.externalIPAddress);
                                $('#internetGateway span').text(wanDefaultConn.defaultGateway);
                            } else {
                                $('#internetConnType span').text(wanDefaultConn.addressingType == 'DHCP' ? $.tpLang.s_str.dynip : $.tpLang.s_str.staip);
                                if (INCLUDE_IPV6) {
                                    if (wanDefaultConn.X_TP_IPv4Enabled == 1 && wanDefaultConn.X_TP_IPv6Enabled == 0) {
                                        $('#internetDnsp span').text(dnsv41);
                                        $('#internetDnss span').text(dnsv42);
                                        $('#internetIp span').text(ipv4);
                                        $('#internetGateway span').text(gatev4);
                                    } else if (wanDefaultConn.X_TP_IPv4Enabled == 0 && wanDefaultConn.X_TP_IPv6Enabled == 1) {
                                        $('#internetDnsp span').text(dnsv61);
                                        $('#internetDnss span').text(dnsv62);
                                        $('#internetIp span').text(ipv6);
                                        $('#internetGateway span').text(gatev6);
                                    } else if (wanDefaultConn.X_TP_IPv4Enabled == 1 && wanDefaultConn.X_TP_IPv6Enabled == 1) {
                                        $('#internetDnsp span').text(dnsv41 + ' / ' + dnsv61);
                                        $('#internetDnss span').text(dnsv42 + ' / ' + dnsv62);
                                        $('#internetIp span').text(ipv4 + ' / ' + ipv6);
                                        $('#internetGateway span').text(gatev4 + ' / ' + gatev6);
                                    }
                                } else {
                                    $('#internetDnsp span').text(dnsv41);
                                    $('#internetDnss span').text(dnsv42);
                                    $('#internetIp span').text(ipv4);
                                    $('#internetGateway span').text(gatev4);
                                }
                            }
                        }
                    }
                } else if (wanType == 'ppp' && wanDefaultConn.enable == 1) {
                    if (INCLUDE_IPV6) {
                        $('#internetConnType span').text(wanDefaultConn.transportType);
                        if (wanDefaultConn.X_TP_IPv4Enabled == 1 && wanDefaultConn.X_TP_IPv6Enabled == 0) {
                            $('#internetDnsp span').text(dnsv41);
                            $('#internetDnss span').text(dnsv42);
                            $('#internetIp span').text(ipv4);
                            $('#internetGateway span').text(gatev4);
                        } else if (wanDefaultConn.X_TP_IPv4Enabled == 0 && wanDefaultConn.X_TP_IPv6Enabled == 1) {
                            $('#internetDnsp span').text(dnsv61);
                            $('#internetDnss span').text(dnsv62);
                            $('#internetIp span').text(ipv6);
                            $('#internetGateway span').text(gatev6);
                        } else if (wanDefaultConn.X_TP_IPv4Enabled == 1 && wanDefaultConn.X_TP_IPv6Enabled == 1) {
                            $('#internetDnsp span').text(dnsv41 + ' / ' + dnsv61);
                            $('#internetDnss span').text(dnsv42 + ' / ' + dnsv62);
                            $('#internetIp span').text(ipv4 + ' / ' + ipv6);
                            $('#internetGateway span').text(gatev4 + ' / ' + gatev6);
                        }
                    } else {
                        $('#internetConnType span').text(wanDefaultConn.transportType);
                        $('#internetDnsp span').text(dnsv41);
                        $('#internetDnss span').text(dnsv42);
                        $('#internetIp span').text(ipv4);
                        $('#internetGateway span').text(gatev4);
                    }
                } else if (INCLUDE_L2TP && wanType == 'l2tp' && wanDefaultConn.enable == 1) {
                    $('#internetConnType span').text('L2TP');
                    $('#internetDnsp span').text(dnsv41);
                    $('#internetDnss span').text(dnsv42);
                    $('#internetIp span').text(ipv4);
                    $('#internetGateway span').text(gatev4);
                } else if (INCLUDE_PPTP && wanType == 'pptp' && wanDefaultConn.enable == 1) {
                    $('#internetConnType').prop('value', 'PPTP');
                    $('#internetDnsp span').text(dnsv41);
                    $('#internetDnss span').text(dnsv42);
                    $('#internetIp span').text(ipv4);
                    $('#internetGateway span').text(gatev4);
                }
            });
        }
    })();
</script>