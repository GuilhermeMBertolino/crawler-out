<div class="titleBar">
    <a id="back" url="lanSettings.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a>
    <h1>DHCP Settings</h1>
    <a id="save" data-status="save">Save</a>
</div>

<div id="page-one" class="item-list mt15">
    <div class="section-container">
        <div class="section-box">
            <span>
                <script type="text/html" class="title-string">
                    <%=$.tpLang.s_str.macaddr%>
                </script>               
            </span>
            <span class="text-readonly" id="lanMacAddress"></span>
        </div>
        <div class="section-box single nd" id="address-type-div">
            <label class="section-labelTitle">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.s_str.addrtype%>
                </script>
            </label>
            <select id="addressType">
                <option value="0">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.s_str.staip%>
                    </script>
                </option>
                <option value="1">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.s_str.smartdhcp%>
                    </script>
                </option>
            </select>
        </div>
        <div class="section-box single">
            <input type="text" id="lanIPAddr" />
        </div>
        <div class="section-box">
            <label class="section-labelTitle">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.s_str.netmask%>
                </script>
            </label>
            <select id="lanIPSubMask">
                <option value="0">255.255.255.0</option>
                <option value="1">255.255.0.0</option>
                <option value="2">255.0.0.0</option>
                <option value="3">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.dhcp_nstr.t_custom%>
                    </script>
                </option>
            </select>
        </div>
        <div class="section-box nd" id="lanIPSubMaskCustom">
            <input type="text" id="lanIPSubMaskCustomInput" />
        </div>
        <div class="section-box single" id="igmpBlock">
            <div>
                IGMP Snooping:
            </div>
            <input type="checkbox" id="lanIGMPEn" />
        </div>
        <!---div class="section-box">
            <div>
                Second IP:		
			</div>
			<input type="checkbox" id="secIp_en" />
        </div--->
        <!---div id="secIpCont" class="nd">
            <div class="section-box">
                <input type="text" id="secIp" value="0.0.0.0" maxlength="15" />
            </div>
            <div class="section-box">
                <input type="text" id="secMask" value="0.0.0.0" maxlength="15" />
            </div>
        </div--->
    </div>

    <div class="section-container mtNo">
        <div class="section-box single">
            <div>
                DHCP:
            </div>
            <input type="checkbox" id="dhcpEn" />
        </div>
        <div id="dhcpCont">
            <div class="section-box nd">
                <select id="dhcpfunc">
                    <option value="dhcpServ" selected="true">
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.dhcp_nstr.t_dhcpserv%>
                        </script>
                    </option>
                    <option value="dhcpRelay">
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.dhcp_nstr.t_relay%>
                        </script>
                    </option>
                    </option>
                </select>
            </div>
            <div id="dhcpSrvCont">
                <div class="section-box">
                    <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.dhcp_nstr.t_ippool%>
                    </script>
                </span>
                </div>
                <div class="section-box">
                    <div class="inputBox-mobile-following-div flexible-box">
                        <div class="inputBox-mobile-following fixed-part input-addrpool"><span>
                            <script type="text/html" class="title-string">
                                <%=$.tpLang.m_str.from%>
                            </script>
                        </span>
                        </div>
                        <input id="ip1" class="inputBox-mobile grow-part" type="text" />
                    </div>
                </div>
                <div class="section-box">
                    <div class="inputBox-mobile-following-div flexible-box">
                        <div class="inputBox-mobile-following fixed-part input-addrpool"><span>
                            <script type="text/html" class="title-string">
                                <%=$.tpLang.m_str.to%>
                            </script>
                        </span>
                        </div>
                        <input id="ip2" class="inputBox-mobile grow-part" type="text" />
                    </div>
                </div>
                <div class="section-box">
                    <input id="lease" type="text" />
                </div>
                <div class="section-box">
                    <input id="gateway" type="text" />
                </div>
                <!--div class="section-box">
                    <input id="domain" type="text" />
                </div -->
                <div class="section-box">
                    <input id="dnsserver1" type="text" />
                </div>
                <div class="section-box">
                    <input id="dnsserver2" type="text" />
                </div>
            </div>
            <div id="dhcpRelayCont">
                <div class="section-box">
                    <input id="rmtSrv" type="text" value="0.0.0.0" size="15" maxlength="15" />
                </div>
                <div class="section-tips">
                    <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.dhcp_nstr.t_relay_warn%>
                    </script>
                </span>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="page-two">
    <div class="link-list mt15" id="dhcpTable">
    </div>
</div>

<script type="text/javascript">
(function() {
    $.tpLocal('title-string', $.tpLang);
    $('.titleBar').titleBar();
    $('.titleBar').titleBar('title', $.tpLang.menu_str.dhcpserver);
    $('#save').titleButton('status', 'save', $.tpLang.m_str.save).bind('click', function() {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        doSave();
    });

    var brLanList;
    var brStackList = '';
    var brNameList = '';
    var groupEditIndex;
    var subMask = ['255.255.255.0', '255.255.0.0', '255.0.0.0', $.tpLang.dhcp_nstr.t_custom];
    var oldLanIp;
    var oldLanMask;


    if (INCLUDE_SMART_DHCP && $.routerMode == 'AP') {
        $('#address-type-div').removeClass('nd').next('div.section-box').removeClass('single');

        $('#addressType').selectMobile().on('change', function() {
            if ($('#addressType').selectMobile('value') == 1) {
                $('#lanIPAddr').inputBoxMobile('option', 'disabled', true);
                $('#lanIPSubMaskCustomInput').inputBoxMobile('option', 'disabled', true);
                $("#lanIPSubMask").selectMobile('option','disabled', true);
				$('#dhcpEn').checkboxMobile('option', 'disabled', true);
				$('#ip1').inputBoxMobile('option', 'disabled', true);
				$('#ip2').inputBoxMobile('option', 'disabled', true);
				$('#lease').inputBoxMobile('option', 'disabled', true);
				$('#gateway').inputBoxMobile('option', 'disabled', true);
				$('#dnsserver1').inputBoxMobile('option', 'disabled', true);
				$('#dnsserver2').inputBoxMobile('option', 'disabled', true);
            } else {
                $('#lanIPAddr').inputBoxMobile('option', 'disabled', false);
                $('#lanIPSubMaskCustomInput').inputBoxMobile('option', 'disabled', false);
                $("#lanIPSubMask").selectMobile('option','disabled', false);
				$('#dhcpEn').checkboxMobile('option', 'disabled', false);
				$('#ip1').inputBoxMobile('option', 'disabled', false);
				$('#ip2').inputBoxMobile('option', 'disabled', false);
				$('#lease').inputBoxMobile('option', 'disabled', false);
				$('#gateway').inputBoxMobile('option', 'disabled', false);
				$('#dnsserver1').inputBoxMobile('option', 'disabled', false);
				$('#dnsserver2').inputBoxMobile('option', 'disabled', false);
            }
        });
    }

    $('#lanIPAddr').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.dhcp_nstr.t_lan4,
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                var lanIP = $('#lanIPAddr').val();
                if ($.ifip(lanIP, true)) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_LAN_IP_INVAD]
        }]
    }).on('change', function() {
        setDhcpAddresses();
        // checkParam();
    });
    $('#lanIPSubMask').selectMobile().bind('change', function() {
        if ($('#lanIPSubMask').selectMobile('value') == 3) {
            $('#lanIPSubMaskCustom').removeClass('nd');
        } else {
            $('#lanIPSubMaskCustom').val('').addClass('nd');
            setDhcpAddresses();
            $('#gateway').val(dhcpCfg.IPRouters);
            // checkParam();
        }
    });
    $('#lanIPSubMaskCustomInput').inputBoxMobile({
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                if ($('#lanIPSubMask').selectMobile('value') == 3) {
                    var netMask = $('#lanIPSubMaskCustomInput').val();
                    if ($.mask(netMask, true)) {
                        return false;
                    }
                }
                return true;
            },
            text: e_str[ERR_LAN_MASK_INVAD]
        }]
    }).siblings('.inputBox-ip-container').find('input').on('change', function() {
        setDhcpAddresses();
        // checkParam();
    });
    $('#lanIGMPEn').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.dhcp_nstr.t_snoop
    });
    /*$('#secIp_en').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.dhcp_nstr.t_secIp
    }).bind('check.checkboxMobile', function() {
        $('#secIpCont').removeClass('nd');
    }).bind('uncheck.checkboxMobile', function() {
        $('#secIpCont').addClass('nd');
    });
    $('#secIp').inputBoxMobile({
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                if ($('#secIp_en').checkboxMobile('option', 'checked') == true) {
                    if ($.ifip($("#secIp").val(), true)) {
                        return false;
                    }
                }
                return true;
            },
            text: e_str[ERR_IP_FORMAT]
        }]
    })
    $('#secMask').inputBoxMobile({
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                if ($('#secIp_en').checkboxMobile('option', 'checked') == true) {
                    if ($.mask($("#secMask").val(), true)) {
                        return false;
                    }
                }
                return true;
            },
            text: e_str[ERR_MASK_INVAD]
        }]
    })
	*/
    $('#dhcpEn').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.dhcp_nstr.t_dhcp
    }).bind('check.checkboxMobile', function() {
        $('#dhcpCont').slideDown('fast');
    }).bind('uncheck.checkboxMobile', function() {
        $('#dhcpCont').slideUp('fast');
    });

    $('#dhcpfunc').selectMobile().bind('change', function() {
        if ($('#dhcpfunc').selectMobile('value') == 'dhcpServ') {
            $('#dhcpSrvCont').removeClass('nd');
            $('#dhcpRelayCont').addClass('nd');
        }
        if ($('#dhcpfunc').selectMobile('value') == 'dhcpRelay') {
            $('#dhcpSrvCont').addClass('nd');
            $('#dhcpRelayCont').removeClass('nd');
        }
    });
    $('#dhcpfunc').trigger('change');
    $('#ip1').inputBoxMobile({
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                if ($.ifip($('#ip1').val(), true)) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_DHCP_START_IP_INVAD]
        }, {
            func: function() {
                if ((parseInt($('#ip1').val().split('.')[3], 10) == 0) || (parseInt($('#ip1').val().split('.')[3], 10) == 255)) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DHCP_START_IP_INVAD_1]
        }]
    });
    $('#ip2').inputBoxMobile({
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                if ($.ifip($('#ip2').val(), true)) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_DHCP_END_IP_INVAD]
        }, {
            func: function() {
                if ((parseInt($('#ip2').val().split('.')[3], 10) == 0) || (parseInt($('#ip2').val().split('.')[3], 10) == 255)) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DHCP_END_IP_INVAD_1]
        }]
    });
    $('#lease').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.dhcp_nstr.t_leasetime,
        'following': $.tpLang.s_str.minutes,
        'notice': $.tpLang.dhcp_nstr.t_leasevalNote,
        'warnings': [{
            func: function() {
                if ($.num($('#lease').val(), [1, 2880], true)) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_DHCP_LEASE_INVAD]
        }]
    });
    $('#gateway').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.s_str.defgw,
        'ipOrMac': 'ip',
        'placeholder': $.tpLang.s_str.optional,
        'warnings': [{
            func: function() {
                if (($('#gateway').val() != '') && ($('#gateway').val() != '0.0.0.0') && ($.ifip($('#gateway').val(), true))) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DHCP_GATEWAY_INVAD]
        }]
    });
/* for ac3150
    $('#domain').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.dhcp_nstr.t_defdomain,
        'placeholder': $.tpLang.s_str.optional,
        'warnings': [{
            func: function() {
                if (($('#domain').val() != '') && (!$.isdomain($('#domain').val()))) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DOMAIN_INVAD]
        }]
    });
*/
    $('#dnsserver1').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.s_str.dns,
        'ipOrMac': 'ip',
        'placeholder': $.tpLang.s_str.optional,
        'warnings': [{
            func: function() {
                var dnsServer1 = $('#dnsserver1').val();
                if ((dnsServer1 != '') && (dnsServer1 != '0.0.0.0') && ($.ifip(dnsServer1, true))) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DHCP_DNS1_INVAD]
        }]
    });
    $('#dnsserver2').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.s_str.secdns,
        'ipOrMac': 'ip',
        'placeholder': $.tpLang.s_str.optional,
        'warnings': [{
            func: function() {
                var dnsServer2 = $('#dnsserver2').val();
                if ((dnsServer2 != '') && (dnsServer2 != '0.0.0.0') && ($.ifip(dnsServer2, true))) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DHCP_DNS2_INVAD]
        }]
    });
    $('#rmtSrv').inputBoxMobile({
        'hasTitle': true,
        'title': $.tpLang.dhcp_nstr.t_remote,
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                var rmtSrvVal = $('#rmtSrv').val();
                if ((rmtSrvVal != '') && (rmtSrvVal != '0.0.0.0') && ($.ifip(rmtSrvVal, true))) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DHCP_RMT_SRV_INVAD]
        }, {
            func: function() {
                if (($('#dhcpfunc').selectMobile('value') == 'dhcpRelay') && (($('#rmtSrv').val() == '') || ($('#rmtSrv').val() == '0.0.0.0'))) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_DHCP_RMT_SRV_EMPTY]
        }]
    });

    function loadPageOne() {
        $('#save').titleButton('show');
        $('#page-one').removeClass('nd');
        $('#page-two').addClass('nd');
        if (hasGroup) {
            initEdit(brLanList, groupEditIndex);
        } else {
            initEdit(brLanList, 0);
        }
        $('#back').titleButton({
            'url': ''
        }).unbind('click').bind('click', function() {
            if (hasGroup) {
                loadPageTwo();
            } else {
                $.loadPhoneMain('lanSettings.mobile.htm');
            }
        });
    }

    function loadPageTwo() {
        $('#save').titleButton('hide');
        $('#page-one').addClass('nd');
        $('#page-two').removeClass('nd');
        $('#back').titleButton({
            'url': 'lanSettings.mobile.htm'
        }).bind('click', function() {
            $.loadPhoneMain('lanSettings.mobile.htm');
        });
    }

    (function init() {
        brLanList = $.act(ACT_GL, L2_BRIDGING_ENTRY, null, null, ['bridgeName']);
        if (!$.exe()) {
            $.each(brLanList, function() {
                var brParts = (this.__stack).split(',');
                brStackList += brParts[0] + ',';
                brNameList += this.bridgeName + ',';
            });
        }
        initDhcpTableEdit();
    })();

    function initDhcpTableEdit() {
        if (!$.exe()) {
            /*if (brLanList.length == 1)*/ {
                hasGroup = 0;
                loadPageOne();
                return;
            } /*else {
                hasGroup = 1;
                loadPageTwo();
                var index = 0;
                $.each(brLanList, function() {
                    var dhcpInfo = $.act(ACT_GET, LAN_HOST_CFG, this.__stack, null, null);
                    var ipList = $.act(ACT_GS, LAN_IP_INTF, null, this.__stack, ['IPInterfaceIPAddress', 'IPInterfaceSubnetMask', '__ifName']);
                    if (!$.exe()) {
                        var newDiv = $('<div class="section-container"><div class="section-box">' + '<div class="device-div" id="dhcp_' + index + '">'
                            // + '<div class="device-label"><span class="icon-folder"></span></div>'
                            + '<div class="device-content"><div class="device-line"><div class="device-info">' 
                            + '<div class="device-info-name">' + $.tpLang.table_str.group + ': ' + this.bridgeName + '</div>' 
                            + '<div class="device-info-item">' 
                            + '<span class="device-info-title">' + $.tpLang.table_str.ip + '</span>' 
                            + '<span class="device-info-text">' + ipList[0].IPInterfaceIPAddress + '</span>' 
                            + '</div><div class="device-info-item">' 
                            + '<span class="device-info-title">' + $.tpLang.table_str.subMask + '</span>' 
                            + '<span class="device-info-text">' + ipList[0].IPInterfaceSubnetMask + '</span>' 
                            + '</div><div class="device-info-item">' 
                            + '<span class="device-info-title">' + $.tpLang.table_str.dhcpPool + '</span>' 
                            + '<span class="device-info-text">' + dhcpInfo.minAddress + '-' + dhcpInfo.maxAddress + '</span>' 
                            + '</div>' 
                            + '</div>' + '<div class="op"><input type="checkbox" id="dhcp_op' + index + '" /></div>' + '</div></div>' 
                            + '</div></div>');
                        newDiv.appendTo($('#dhcpTable'));
                        $.addDeviceBlock($('#dhcp_' + index));

                        $('#dhcp_' + index + ' .device-info').bind('click', function() {
                            var thisId = ($(this).parents('.device-div').last()).prop('id').replace('dhcp_', '');
                            doGroupEdit(thisId);
                        });
                        $('#dhcp_op' + index).flipSwitch({
                            'on': (dhcpInfo.DHCPServerEnable == 1) ? true : false
                        }).bind('on.flipSwitch', function() {
                            var thisId = this.id.replace('dhcp_op', '');
                            enableDHCP(thisId);
                        }).bind('off.flipSwitch', function() {
                            var thisId = this.id.replace('dhcp_op', '');
                            disableDHCP(thisId);
                        });
                        index++;
                    }
                });
            }*/
        }
    }

    function enableDHCP(index) {
        $.act(ACT_SET, LAN_HOST_CFG, brLanList[index].__stack, null, ['DHCPServerEnable=1']);
        $.exe(function(err) {
            if (!err) $.reload();
        });
    }

    function disableDHCP(index) {
        $.act(ACT_SET, LAN_HOST_CFG, brLanList[index].__stack, null, ['DHCPServerEnable=0']);
        $.exe(function(err) {
            if (!err) $.reload();
        });
    }

    function doGroupEdit(index) {
        groupEditIndex = index;
        loadPageOne();
    }

    function setDhcpAddresses() {
        var lanIp = $('#lanIPAddr').val();
        var netMask = $('#lanIPSubMask').selectMobile('value') == 3 ?
            $('#lanIPSubMaskCustomInput').val() : $('select#lanIPSubMask').selectMobile('text');
        var addrParts;
        var maskParts;
        var poolStart = [];
        var poolEnd = [];
        var index;
        var pos;

        $('#ip1').inputBoxMobile('option', 'value', '');
        $('#ip2').inputBoxMobile('option', 'value', '');

        addrParts = lanIp.split('.');
        maskParts = netMask.split('.');


        for (index = 0; index < 4; index++) {
            poolStart[index] = addrParts[index] & maskParts[index];
        }
        poolStart[3] += 1;

        for (index = 0; index < 3; index++) {
            poolEnd[index] = poolStart[index];
        }
        pos = $.getrightfirstonebitpos(maskParts[3]);
        poolEnd[3] = poolStart[3] + Math.pow(2, pos) - 3;


        if ((poolEnd[3] >= 200) && (poolStart[3] <= 100)) {
            poolStart[3] = 100;
            poolEnd[3] = 199;
        }

        for (index = 0; index < 4; index++) {
            if (index == 3) {
                $('#ip1').inputBoxMobile('option', 'value', $('#ip1').val() + '.' + poolStart[index]);
                $('#ip2').inputBoxMobile('option', 'value', $('#ip2').val() + '.' + poolEnd[index]);
            } else {
                $('#ip1').inputBoxMobile('option', 'value', $('#ip1').val() + '.' + poolStart[index] + '.');
                $('#ip2').inputBoxMobile('option', 'value', $('#ip2').val() + '.' + poolEnd[index] + '.');
            }
        }

        $('#gateway').inputBoxMobile('option', 'value', lanIp);
    }

    function initEdit(brList, ix) {

        // $.loadPage('ipv6Edit', 'lan6.htm');
        lanIPv4Cfg = $.act(ACT_GS, LAN_IP_INTF, null, brList[ix].__stack, ['IPInterfaceIPAddress', 'IPInterfaceSubnetMask', 'X_TP_MACAddress']);
		if (!(INCLUDE_ROUTER_MODE && $.routerMode == 'AP')){
			lanIgmpCfg = $.act(ACT_GET, LAN_IGMP_SNOOP, brList[ix].__stack, null, ['enabled']);
		}
        dhcpCfg = $.act(ACT_GET, LAN_HOST_CFG, brList[ix].__stack, null, null);

        if (!$.exe()) {
            //mac address
            $('#lanMacAddress').html(lanIPv4Cfg[0].X_TP_MACAddress);

            //lan ip
            oldLanIp = lanIPv4Cfg[0].IPInterfaceIPAddress ? lanIPv4Cfg[0].IPInterfaceIPAddress : '0.0.0.0';
            //lan mask
            oldLanMask = lanIPv4Cfg[0].IPInterfaceSubnetMask ? lanIPv4Cfg[0].IPInterfaceSubnetMask : '0.0.0.0';

            //smart dhcp
            if (INCLUDE_ROUTER_MODE && $.routerMode == 'AP') {
                $('#addressType').selectMobile('value', dhcpCfg.X_TP_DHCPAuto);
            }

			$('#lanIPAddr').inputBoxMobile('option', 'value', oldLanIp);

			//find selected option
			for (var ix = 0; ix < subMask.length; ix++) {
				if (subMask[ix] == oldLanMask) {
					break;
				}
			}
			if (INCLUDE_ROUTER_MODE && $.routerMode == 'AP'){
				$('#igmpBlock').hide();
			}

			if (ix >= subMask.length) {
				$('#lanIPSubMask').selectMobile('value', ix - 1);
				$('#lanIPSubMaskCustomInput').inputBoxMobile('option', 'value', oldLanMask);
			}

			$('#lanIPSubMask').selectMobile('value', ix);
            if (INCLUDE_SMART_DHCP && $.routerMode == 'AP' && dhcpCfg.X_TP_DHCPAuto == 1) {
                //disabled ip and mask
                $('#lanIPAddr').inputBoxMobile('option', 'disabled', true);
                $('#lanIPSubMask').selectMobile('option', 'disabled', true);
                $('#lanIPSubMaskCustomInput').inputBoxMobile('option', 'disabled', true);
				$('#dhcpEn').checkboxMobile('option', 'disabled', true);
				$('#ip1').inputBoxMobile('option', 'disabled', true);
				$('#ip2').inputBoxMobile('option', 'disabled', true);
				$('#lease').inputBoxMobile('option', 'disabled', true);
				$('#gateway').inputBoxMobile('option', 'disabled', true);
				$('#dnsserver1').inputBoxMobile('option', 'disabled', true);
				$('#dnsserver2').inputBoxMobile('option', 'disabled', true);
            }
			if (!(INCLUDE_ROUTER_MODE && $.routerMode == 'AP')){
				$('#lanIGMPEn').checkboxMobile({
					'checked': lanIgmpCfg.enabled == 1 ? true : false
				});
			}
            /*secondIp
			if (lanIPv4Cfg.length == 1) {
				$('#secIp_en').checkboxMobile({
					'checked': false
				});
				$('#secIpCont').addClass('nd');
			} else if (lanIPv4Cfg.length == 2) {
				$('#secIp_en').checkboxMobile({
					'checked': true
				});
				$('#secIpCont').removeClass('nd');
                $('#secIp').inputBoxMobile('option', 'value', lanIPv4Cfg[1].IPInterfaceIPAddress == '' ? '0.0.0.0' : lanIPv4Cfg[1].IPInterfaceIPAddress);
                $('#secMask').inputBoxMobile('option', 'value', lanIPv4Cfg[1].IPInterfaceSubnetMask == '' ? '0.0.0.0' : lanIPv4Cfg[1].IPInterfaceSubnetMask);
			}
			*/
            if (dhcpCfg.DHCPServerEnable == 1) {
                $('#dhcpEn').checkboxMobile({
                    'checked': true
                });
                $('#dhcpCont').removeClass('nd');
            } else {
                $('#dhcpEn').checkboxMobile({
                    'checked': false
                });
                $('#dhcpCont').addClass('nd');
            }
            $('#dhcpRelay').checkboxMobile({
                'checked': dhcpCfg.DHCPRelay == 1 ? true : false
            });
            $('#ip1').inputBoxMobile('option', 'value', (dhcpCfg.minAddress) ? dhcpCfg.minAddress : ('0.0.0.0'));
            $('#ip2').inputBoxMobile('option', 'value', (dhcpCfg.maxAddress) ? dhcpCfg.maxAddress : ('0.0.0.0'));
            $('#lease').val((dhcpCfg.DHCPLeaseTime == '') ? 1440 : (dhcpCfg.DHCPLeaseTime / 60));
            $('#gateway').inputBoxMobile('option', 'value', (dhcpCfg.IPRouters == '') ? '0.0.0.0' : dhcpCfg.IPRouters);
 //for ac3150           $('#domain').val((dhcpCfg.domainName == '') ? '' : dhcpCfg.domainName);
            $('#dnsserver1').inputBoxMobile('option', 'value', (dhcpCfg.DNSServers == '') ? '0.0.0.0' : (dhcpCfg.DNSServers).split(',')[0]);
            $('#dnsserver2').inputBoxMobile('option', 'value', (dhcpCfg.DNSServers == '') ? '0.0.0.0' : (dhcpCfg.DNSServers).split(',')[1]);
            $('#rmtSrv').inputBoxMobile('option', 'value', dhcpCfg.X_TP_DhcpRelayServer);
        }
    }

    function checkParam() {
        var element;
        var lanIp = $('#lanIPAddr').val();
        var netMask = $('#lanIPSubMask').selectMobile('value') == 3 ?
            $('#lanIPSubMaskCustomInput').val() : $('select#lanIPSubMask').selectMobile('text');

        if ($.ipmask(lanIp, netMask, true)) {
            $.alert(ERR_LAN_IPMASK_INVAD);
            element = $('#lanIPAddr');
            if (element) {
                element.focus();
            }
            return false;
        }

        if (!$.isOrderIp($('#ip1').val(), $('#ip2').val())) {
            $.alert(ERR_TC_IP_ORDER_INVAD);
            element = $('#ip2');
            if (element) {
                element.focus();
            }
            return false;
        }

        if (!isSameLan($('#ip1').val(), netMask, lanIp, netMask)) {
            $.alert(ERR_DHCP_POOL_INVAD);
            element = $('#ip1');
            if (element) {
                element.focus();
            }
            return false;
        }

        if (!isSameLan($('#ip2').val(), netMask, lanIp, netMask)) {
            $.alert(ERR_DHCP_POOL_INVAD);
            element = $('#ip2');
            if (element) {
                element.focus();

            }
            return false;
        }

        if (($('#gateway').val() != '') && ($('#gateway').val() != '0.0.0.0') &&
            (!isSameLan($('#gateway').val(), netMask, lanIp, netMask))) {
            $.alert(ERR_GATEWAY_INVAD);
            element = $('#gateway');
            if (element) {
                element.focus();

            }
            return false;
        }


        /*if ($('#secIp_en').checkboxMobile('option', 'checked') == true) {
            if ($.ip2ip($('#secIp').val()) == $.ip2ip($('#lanIPAddr').val())) {
                $.alert(ERR_LAN_SEC_IP_INVAD);
                element = $('#secIp');
                if (element) {
                    element.focus();
                }
                return false;
            }
        }*/

        return true;
    }

    function isSameLan(lan1Ip, lan1Mask, lan2Ip, lan2Mask) {
        var count = 0;
        lan1a = lan1Ip.split('.');
        lan1m = lan1Mask.split('.');
        lan2a = lan2Ip.split('.');
        lan2m = lan2Mask.split('.');
        for (i = 0; i < 4; i++) {
            l1a_n = parseInt(lan1a[i], 10);
            l1m_n = parseInt(lan1m[i], 10);
            l2a_n = parseInt(lan2a[i], 10);
            l2m_n = parseInt(lan2m[i], 10);

            if ((l1a_n & l1m_n) == (l2a_n & l2m_n))
                count++;
        }
        if (count == 4) {
            var testIp = $.ip2num(lan1Ip);
            var lanMask = $.ip2num(lan1Mask);
            if (((testIp & (~lanMask)) == 0) || ((testIp & (~lanMask)) == (~lanMask)))
                return false;
            else
                return true;
        } else {
            return false;
        }
    }

    function doSave() {
        var ipv4Settings = {};
        var igmpSettings = {};
        var dhcpSettings = {};
        var secIpSettings = {};

        /*if (!$.checkAllInput()) {
            return false;
        }*/
        if (checkParam() == false) {
            return false;
        }

        var bReboot = false;
        var tmpLanIp = $('#lanIPAddr').val() == '' ? '0.0.0.0' : $.ip2ip($('#lanIPAddr').val());

        var tmpLanMask = $('#lanIPSubMask').selectMobile('value') == 3 ?
            $('#lanIPSubMaskCustomInput').val() : $('#lanIPSubMask').selectMobile('text');
        tmpLanMask = $.ip2ip(tmpLanMask);

        if (($.ip2num(oldLanIp) != $.ip2num(tmpLanIp) || $.ip2num(oldLanMask) != $.ip2num(tmpLanMask))) {
            bReboot = true;
        }

        if (INCLUDE_ROUTER_MODE && $.routerMode == 'AP') {
            var addressType = $("#addressType").selectMobile("value");
            if (addressType == 1) {
                /* 开启Smart DHCP不需要重启 */
                bReboot = false;
                ipv4Settings.IPInterfaceAddressingType = 'DHCP';
            } else {
                ipv4Settings.IPInterfaceAddressingType = 'Static';
            }
            $.act(ACT_SET, LAN_HOST_CFG, dhcpCfg.__stack, null, ["X_TP_DHCPAuto=" + addressType]);

        }
		if (!(INCLUDE_ROUTER_MODE && $.routerMode == 'AP')){
			igmpSettings.enabled = $('#lanIGMPEn').checkboxMobile('option', 'checked') == true ? 1 : 0;
		}

        if ($('#dhcpEn').checkboxMobile('option', 'checked') == true) {
            dhcpSettings.DHCPServerEnable = 1;
            dhcpSettings.DHCPRelay = $('#dhcpfunc').selectMobile('value') == 'dhcpRelay' ? 1 : 0;
        } else {
            dhcpSettings.DHCPServerEnable = 0;
        }

        if (dhcpSettings.DHCPServerEnable == 1 && dhcpSettings.DHCPRelay == 1) {
            dhcpSettings.X_TP_DhcpRelayServer = $.ip2ip($('#rmtSrv').val());
        } else if (dhcpSettings.DHCPServerEnable == 1) {
            dhcpSettings.minAddress = $.ip2ip($('#ip1').val());
            dhcpSettings.maxAddress = $.ip2ip($('#ip2').val());

            dhcpSettings.IPRouters = $.ip2ip($('#gateway').val());
            dhcpSettings.DHCPLeaseTime = $('#lease').val() * 60;
//            dhcpSettings.domainName = $('#domain').val();

            dhcpSettings.DNSServers = ($('#dnsserver1').val() == '' ? '0.0.0.0' : $.ip2ip($('#dnsserver1').val())) + ',' +
                ($('#dnsserver2').val() == '' ? '0.0.0.0' : $.ip2ip($('#dnsserver2').val()));

        }

        /*secondIp
        secIpSettings.IPInterfaceIPAddress = $('#secIp').val() == '' ? '0.0.0.0' : $.ip2ip($('#secIp').val());
        secIpSettings.IPInterfaceSubnetMask = $('#secMask').val() == '' ? '0.0.0.0' : $.ip2ip($('#secMask').val());
		*/
        var accUrl = document.location.href.split('/')[2];
        var accIp = accUrl.split(':')[0];
        var accPort = 80;
        if (accUrl.split(':').length > 1) {
            accPort = accUrl.split(':')[1];
        }

        /*var bSecIpDiff = false;

        if ($('#secIp_en').checkboxMobile('option', 'checked') == true) {
            if (lanIPv4Cfg.length == 1) {
                var pStk = lanIPv4Cfg[0].__stack.split(',')[0] + ',0,0,0,0,0';
                $.act(ACT_ADD, LAN_IP_INTF, null, pStk, secIpSettings);
            } else if (lanIPv4Cfg.length == 2) {
                $.act(ACT_SET, LAN_IP_INTF, lanIPv4Cfg[1].__stack, null, secIpSettings);
                var oldSecIp = lanIPv4Cfg[1].IPInterfaceIPAddress;
                var curSecIp = $.ip2ip($('#secIp').val());

                if (curSecIp != oldSecIp && accIp == oldSecIp) {
                    bSecIpDiff = true;
                }
            }
        } else if (lanIPv4Cfg.length == 2) {
            $.act(ACT_DEL, LAN_IP_INTF, lanIPv4Cfg[1].__stack, null);
        }*/

        if (!bReboot) {
            if (INCLUDE_SMART_DHCP && $.routerMode == 'AP' && addressType == 1 && dhcpCfg.X_TP_DHCPAuto == 0) {
                $.confirmMobile($.tpLang.lan_nstr.logoutConfirm, function() {
                    $.act(ACT_SET, LAN_IP_INTF, lanIPv4Cfg[0].__stack, null, ipv4Settings);
					if (!(INCLUDE_ROUTER_MODE && $.routerMode == 'AP')){
						$.act(ACT_SET, LAN_IGMP_SNOOP, lanIgmpCfg.__stack, null, igmpSettings);
					}
                    if (!$.exe()) {
                        $.stopWaitingMobile();
                        $.act(ACT_CGI, '/cgi/logout');
                		$.exe();
                		//$.deleteCookie('Authorization');
            			$.deleteCookie('UserChange');
                        $.refresh();
                    }
                }, goBack);
            } else {
				if (!(INCLUDE_ROUTER_MODE && $.routerMode == 'AP')){
					$.act(ACT_SET, LAN_IGMP_SNOOP, lanIgmpCfg.__stack, null, igmpSettings);
				}
                $.act(ACT_SET, LAN_HOST_CFG, dhcpCfg.__stack, null, dhcpSettings);

                if (!$.exe()) {
                    /* for ac3150 */
                    $.stopWaitingMobile();
                    /*
                     if (bSecIpDiff) {
                     $.refresh();
                     } else {
                     */
                    if (accIp != tmpLanIp) {
                        $.refresh();
                    } else {
                        $.stopWaitingMobile();
                        $.reload();
                    }
                }
            }
        } else {
            $.confirmMobile($.tpLang.c_str.lan_reboot, goExcute, goBack);
        }

        function goExcute() {
            ipv4Settings.IPInterfaceIPAddress = tmpLanIp;
            ipv4Settings.IPInterfaceSubnetMask = tmpLanMask;

			if (!(INCLUDE_ROUTER_MODE && $.routerMode == 'AP')){
				$.act(ACT_SET, LAN_IGMP_SNOOP, lanIgmpCfg.__stack, null, igmpSettings);
			}
            $.act(ACT_SET, LAN_HOST_CFG, dhcpCfg.__stack, null, dhcpSettings);
			$.act(ACT_SET, LAN_IP_INTF, lanIPv4Cfg[0].__stack, null, ipv4Settings);
            if (!$.exe()) {
                $.guageMobile('<span>' + $.tpLang.s_str.wait_reboot + '</span>', 100, 1200, function() {
                    $.refresh();
                });
            }
        }

        function goBack() {
            $.stopWaitingMobile();
            bReboot = false;
            return;
        }
    }

})();
</script>
