<div>

    <div id="page-one">

        <div id="titleOne" class="titleBar">
            <a id="back" url="usbSettings.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a>
            <h1>
                <script type="text/html" class="title-string">
                    <%=$.tpLang.folderSharing_nstr.t_sf%>
                </script>
            </h1>
            <a id="edit" data-status="edit">Edit</a>
        </div>
        <div class="item-list mt15">
            <div class="section-container">
                <div class="section-box">
                    <div>
                        <span>Share All</span>
                    </div>
                    <input type="checkbox" id="share" />
                </div>
            </div>
            <div class="section-container mtNo nd">
                <div class="section-box">
                    <div>
                        <span>Enable Authentication</span>
                    </div>
                    <input type="checkbox" id="auth" />
                </div>
            </div>
        </div>
        <div id="auth_notice" class="section-note mt7 nd">
            <span>
                <script type="text/html" class="title-string">
                    <%=$.tpLang.folderSharing_nstr.note%>
                </script>
            </span>
        </div>

        <ul id="authTab" class="link-list nd mt15">
        </ul>

        <ul id="shareTab" class="device-list nd mt15">
        </ul>

        <div id="noFolder" class="no-item nd">
            <div class="sprite grid-no-folder"></div>
            <span class="text-no-item">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.folderSharing_nstr.noFolder%>
                </script>
            </span>
            <input type="button" class="button-mobile add-button mt10" id="addFolder" value="Add folder" />
        </div>

        <div class="botP-toolBar">
        </div>
    </div>

    <div id="page-two" class="nd">
        <div class="section-container mt15">
            <div class="section-box">
                <label class="section-labelTitle" for="shareVolume">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.folderSharing_nstr.t_vol%>
                    </script>
                </label>
                <select id="shareVolume">
                </select>
            </div>
        </div>
        <div class="section-container mtNo" id="setPath">
            <div class="section-box flexible-box" id="fn-parent">
                <span class="fixed-part" id="fp">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.table_str.folderPath%>
                    </script>
                </span>
                <div class="fixed-part"><div id="filename-div"><span class="text-readonly pr5" id="filename"></span></div></div>
                <span class="sprite c-arrow-gray-right fixed-part"></span>
            </div>
        </div>
        <div class="section-container mtNo">
            <div class="section-box">
                <input type="text" id="shareName" maxlength="31" />
            </div>
        </div>
        <div class="section-container mtNo">
            <div class="section-box">
                <div>
                    <span>
                        Enable Authentication:
                    </span>
                </div>
                <input type="checkbox" id="ea" />
            </div>
        </div>
        <div class="section-container mtNo">
            <div class="section-box">
                <div>
                    <span>
                        Enable Write Access:
                    </span>
                </div>
                <input type="checkbox" id="wa" />
            </div>
        </div>
        <div class="section-container mtNo">
            <div class="section-box">
                <div>
                    <span>
                        Enable Media Sharing:
                    </span>
                </div>
                <input type="checkbox" id="ems" />
            </div>
        </div>
    </div>

    <div id="page-three" class="nd mt12">
        <div id="pathContainer"><span class="icon-prev"><span class="sprite c-folder-back"></span></span><div id="pathValue-div"><p id="pathValue"></p></div></div>
        <div id="folderList" class="mt15">        
        </div>
    </div>
</div>


<style type="text/css">
    #pathContainer {
        padding: 0px 7px 0px 7px;
        display: table;
        width: 100%;
        box-sizing: border-box;
        border-collapse: separate;
        table-layout: fixed;
        border-spacing: 8px;
    }
    #pathContainer .icon-prev {
        display: table-cell;
        position: relative;
        width: 2.57rem;
        height: 2.57rem;
        border: 1px solid #e8e8e8;
        border-radius: 5px;
        background-color: #fff;
    }
    #pathContainer .icon-prev .c-folder-back {
        position: absolute;
        top: 0.6rem;
        left: 0.6rem
    }
    #pathValue-div {
        display: table-cell;
        height: 1rem;
        padding: 0.8rem 0.7rem 0.7rem 0.8rem;
        border: 1px solid #e1e2e3;
        border-radius: 10px;
        overflow-x: auto;
        overflow-y: hidden;
    }
    #pathValue {
        box-sizing: border-box;
        height: 18px;
        line-height: 18px;
        /*margin-left: 8px;*/
        color: #333;
        white-space: nowrap;
    }
    .folder-div {
        box-sizing: border-box;
        background-color: #ffffff;
        border-top:1px solid #e1e2e3;
        border-bottom: 1px solid #e8e8e8;
        width: 100%;
        height: 3.7rem;
        display: table;
        table-layout: fixed;
        padding-left: 1rem;
    }
    .folder-div .radio-mobile {
        display: table-cell;
        width: 1.87rem;
        vertical-align: middle;
    }
    .folder-div .folder-name {
        padding: 1.1rem 0px 1.1rem 0.5rem;
        line-height: 1.5rem;
        display: table-cell;
        overflow-x: scroll;
        overflow-y: hidden;
    }
    .folder-div .folder-select {
        display: table-cell;
        box-sizing: border-box;
        border-color: #fff;
        border-style: solid;
        width: 24%;
        padding-right: 1rem;
        vertical-align: middle;
    }
    #filename {
        display: inline-block; 
        line-height: 16px; 
        height: 16px;
        white-space: nowrap;
        float: none;
    }
    #filename-div {
        overflow-x: scroll;
        overflow-y: hidden;
        padding-right: 8px;
    }
    #fp {
        padding-right: 8px;
        white-space: nowrap;
    }
    #fn-parent {
        table-layout: fixed
    }
</style>

<script type="text/javascript">
(function() {
    $('.botP-toolBar').toolBar();
    $.tpLocal('title-string', $.tpLang);
    $.each($('.turn-page'), function() {
        $.initTurnPage(this);
    });

    var userList;
    var usbDeviceList;
    var volumeList;
    var smbService;
    var accessFolderList_samba;
    var accessFolderList_dlna;
    var userAccessList_samba;
    var accessFolderList_ftp;
    var folderIdx;
    var folderList;
    var currVolume = '';
    var shareTabStatus;
    var countDelete = 0;
    var first = 1;
    var thisLayer = '';
    // var deletedShare = [];

    var titleOne = '<div id="titleOne" class="titleBar"><a id="back" url="usbSettings.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a><h1>' + $.tpLang.folderSharing_nstr.t_sf + '</h1><a id="edit" data-status="edit">' + $.tpLang.m_str.edit + '</a></div>';

    var titleTwo = '<div id="titleTwo" class="titleBar"><a id="back2" url=""><span class="icon-back sprite c-arrow-blue-left"></span></a><h1>' + $.tpLang.folderSharing_nstr.addFolder + '</h1><a id="save" data-status="save">' + $.tpLang.m_str.save + '</a></div>';

    var titleThree = '<div id="titleThree" class="titleBar"><a id="back3" url=""><span class="icon-back sprite c-arrow-blue-left"></span></a><h1>' + $.tpLang.table_str.folderPath + '</h1><a id="done" data-status="done">' + $.tpLang.m_str.done + '</a></div>';

    $('#share').flipSwitch({
        'hasTitle': true,
        'title': $.tpLang.folderSharing_nstr.t_esa
    }).bind('on.flipSwitch', function(e) {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        $.act(ACT_SET, SMB_SERVICE, null, null, ['shareAll=1']);
        $.act(ACT_SET, FTP_SERVER, null, null, ['shareAll=1']);
        $.act(ACT_SET, DLNA_MEDIA_SERVER, null, null, ['shareAll=1']);

        if (!$.exe()) {
            $.showBlock('auth');
            if ($('#auth').flipSwitch('option', 'on') == true) {
                $('#auth_notice').removeClass('nd');
            }
            if ($('#authTab').find('.section-container').length != 0) {
                $('#authTab').removeClass('nd');
            }
            $('#shareTab').addClass('nd');
            $('#noFolder').addClass('nd');
            $('#edit').titleButton('hide');
            $.stopWaitingMobile();
            // $.loadPhoneMain('folderSharing.mobile.htm');
        }
    }).bind('off.flipSwitch', function(e) {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        $.act(ACT_SET, SMB_SERVICE, null, null, ['shareAll=0']);
        $.act(ACT_SET, FTP_SERVER, null, null, ['shareAll=0']);
        $.act(ACT_SET, DLNA_MEDIA_SERVER, null, null, ['shareAll=0']);

        if (!$.exe()) {
            $.hideBlock('auth');
            $('#auth_notice').addClass('nd');
            $('#authTab').addClass('nd');
            if ($('#shareTab').find('.li-content-div').length == 0) {
                $('#noFolder').removeClass('nd');
            } else {
                $('#shareTab').removeClass('nd');
                $('#noFolder').addClass('nd');
            }
            $('#edit').titleButton('show');
            $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);
            $('#shareTab').editList({'listType': 'swipeList'});
            $('.botP-toolBar').toolBar('hide');
            $.stopWaitingMobile();
            // $.loadPhoneMain('folderSharing.mobile.htm');
        }
    });

    $('#auth').flipSwitch({
        'hasTitle': true,
        'title': $.tpLang.folderSharing_nstr.t_ea_a
    }).bind('on.flipSwitch', function(e) {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        $.act(ACT_SET, SMB_SERVICE, null, null, ['anonymous=0']);
        $.act(ACT_SET, FTP_SERVER, null, null, ['anonymous=0']);

        if (!$.exe()) {
            $.stopWaitingMobile();
            $('#auth_notice').removeClass('nd');
            // $.loadPhoneMain('folderSharing.mobile.htm');
        };
    }).bind('off.flipSwitch', function(e) {
        $.startWaitingMobile($.tpLang.m_str.waiting);
        $.act(ACT_SET, SMB_SERVICE, null, null, ['anonymous=1']);
        $.act(ACT_SET, FTP_SERVER, null, null, ['anonymous=1']);

        if (!$.exe()) {
            $.stopWaitingMobile();
            $('#auth_notice').addClass('nd');
            // $.loadPhoneMain('folderSharing.mobile.htm');
        };
    });

    $('#shareVolume').selectMobile();
    $('#shareName').inputBoxMobile({
        'title': $.tpLang.folderSharing_nstr.t_shareN,
        'warnings': [{
            func: function() {
                var newStr = $('#shareName').inputBoxMobile('option', 'value');
                if (newStr === '') {
                    return false;
                }
                else {
                    return true;
                }
            },
            text: e_str[ERR_USB_SHARE_NAME_EMPTY]
        }, {
            func: function() {
                var newStr = $('#shareName').inputBoxMobile('option', 'value');
                if ((/[\\\/:\*\?'<>|\]\ ]+/).test(newStr)) {
                    return false;
                }
                else {
                    return true;
                }
            },
            text: e_str[ERR_USB_INVALID_CHAR_IN_FOLDER_NAME]
        }, {
            func: function() {
                var newStr = $('#shareName').inputBoxMobile('option', 'value');
                if ($.asc(newStr) != 0) {
                    return false;
                }
                else {
                    return true;
                }
            },
            text: e_str[ERR_USB_SHARE_NAME_NOT_ASCII]
        }]
    });
    $('#ea').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.folderSharing_nstr.t_ea
    });
    $('#wa').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.folderSharing_nstr.t_wa
    });
    $('#ems').checkboxMobile({
        'hasTitle': true,
        'title': $.tpLang.folderSharing_nstr.t_ems
    });

    $('#setPath').on('click', function() {
        if ($('#shareVolume').selectMobile('value') !== $.tpLang.table_str.selectopt) {
            loadPageThree();
        }
    });

    ($('#page-three').find('.icon-prev').first()).bind('click', function() {
        var pathNow = $('#pathValue').html();
        var lastIndex;
/*        if (thisLayer !== '') {
            lastIndex = $('#pathValue').html().lastIndexOf('/');
            $('#pathValue').html($('#pathValue').html().substring(0, lastIndex));
        }*/
        lastIndex = $('#pathValue').html().lastIndexOf('/');
        if (lastIndex > 0) {
            $('#pathValue').html($('#pathValue').html().substring(0, lastIndex));
        }
        createChildFolder();
    });

    (function init() {
        loadPageOne();
        userList = $.act(ACT_GL, USER_ACCOUNT, null, null);
        usbDeviceList = $.act(ACT_GL, USB_DEVICE, null, null);
        volumeList = $.act(ACT_GL, LOGICAL_VOLUME, null, null);
        smbService = $.act(ACT_GET, SMB_SERVICE, null, null, null);

        // dlnaService = $.act(ACT_GET, DLNA_MEDIA_SERVER, null, null, null);
        accessFolderList_samba = $.act(ACT_GL, SMB_SERVICE_FOLDER, null, null, null);
        accessFolderList_ftp = $.act(ACT_GL, FTP_SERVER_FOLDER, null, null, null);
        accessFolderList_dlna = $.act(ACT_GL, DLNA_MEDIA_SERVER_FOLDER, null, null, null);
        userAccessList_samba = $.act(ACT_GL, SMB_USER_ACCESS, null, null, null);

        var index;

        if (!$.exe()) {
            initShareTab();
            initAuthTab();

            if (smbService.anonymous == 0) {
                $('#auth').flipSwitch({'on': true}).trigger('on.flipSwitch');
            } else {
                $('#auth').flipSwitch({'on': false}).trigger('off.flipSwitch');
            }

            if (smbService.shareAll == false) {
                $('#share').flipSwitch({'on': false}).trigger('off.flipSwitch');
            } else {
                $('#share').flipSwitch({'on': true}).trigger('on.flipSwitch');
            }

            $('#shareVolume').selectMobile('removeAll')
                .selectMobile('appendOptions', [{
                    'value': $.tpLang.table_str.selectopt,
                    'text': $.tpLang.table_str.selectopt
                }]);

            for (index = 0; index < volumeList.length; index++) {
                if ('Online' == volumeList[index].status) {
                    $('#shareVolume').selectMobile('appendOptions', [{
                        'value': volumeList[index].label + ':',
                        'text': volumeList[index].label + ':'
                    }]);
                }
            }

            for (index = 0; index < accessFolderList_samba.length; index++) {
                if (parseInt(accessFolderList_samba[index].__stack, 10) != parseInt(userAccessList_samba[0].__stack, 10)) {
                    continue;
                }
            }

            folderIdx = accessFolderList_samba.length;
        }

    })();

    function loadPageOne() {
        $('#page-one').removeClass('nd');
        $('#page-two').addClass('nd');
        $('#page-three').addClass('nd');

        accessFolderList_samba = $.act(ACT_GL, SMB_SERVICE_FOLDER, null, null, null);
        accessFolderList_ftp = $.act(ACT_GL, FTP_SERVER_FOLDER, null, null, null);
        accessFolderList_dlna = $.act(ACT_GL, DLNA_MEDIA_SERVER_FOLDER, null, null, null);
        userAccessList_samba = $.act(ACT_GL, SMB_USER_ACCESS, null, null, null);
        if(!$.exe()) {};

        if (first == 1) {
             $(titleOne).titleBar(); 
            // $('#titleOne').titleBar();
            first = 0;
        }
        else {
            $(titleOne).titleBar(); 
        }

        if ($('#shareTab').hasClass('edit-list')) {
            $('#shareTab').editList({
                'listType': 'swipeList'
            });            
        }
        $('.botP-toolBar').toolBar('hide');

        $('#titleOne').titleBar('title', $.tpLang.menu_str.folder);
        $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);           
        $('#edit').on('click', function() {
            var status = $(this).titleButton('status');
            if (status == 'edit') {
                $('#shareTab').editList({
                    'listType': 'selectList'
                });
                countDelete = 0;
                var allCheckboxes = $('#shareTab').find('input[type="checkbox"]');
                $.each(allCheckboxes, function() {
                    $(this).bind('check.checkboxMobile', function(){
                        countDelete++;
                    }).bind('uncheck.checkboxMobile', function() {
                        countDelete--;
                    })
                });
                $(this).titleButton('status', 'cancel', $.tpLang.m_str.cancel);
                $('.botP-toolBar').toolBar('option', {
                    'hide': false
                });
                $('#addFolder').addClass('nd');
            } else if (status == 'cancel') {
                $('#shareTab').editList({
                    'listType': 'swipeList'
                });
                $(this).titleButton('status', 'edit', $.tpLang.m_str.edit);
                $('.botP-toolBar').toolBar('option', {
                    'hide': true
                });
                $('#addFolder').removeClass('nd');
            }

        });

        if ($('#shareTab').find('li').length == 0) {
            $('#noFolder').removeClass('nd');
            $('#addFolder').removeClass('nd');
        }
        else {
            $('#noFolder').addClass('nd');
        }
    }

    function loadPageTwo(argument) {
        $('#page-one').addClass('nd');
        $('#page-two').removeClass('nd');
        $('#page-three').addClass('nd');

        accessFolderList_samba = $.act(ACT_GL, SMB_SERVICE_FOLDER, null, null, null);
        accessFolderList_ftp = $.act(ACT_GL, FTP_SERVER_FOLDER, null, null, null);
        accessFolderList_dlna = $.act(ACT_GL, DLNA_MEDIA_SERVER_FOLDER, null, null, null);
        userAccessList_samba = $.act(ACT_GL, SMB_USER_ACCESS, null, null, null);
        if(!$.exe()) {};

        $(titleTwo).titleBar();
        if (shareTabStatus == 'add') {
            $('#titleTwo').titleBar('title', $.tpLang.folderSharing_nstr.addFolder);
        }
        if (shareTabStatus == 'modify' && (argument != '' && argument != undefined)) {
            $('#titleTwo').titleBar('title', $.tpLang.folderSharing_nstr.modFolder);
            modifyShare(argument);
        }
        $('#back2').unbind('click').bind('click', function() {
            loadPageOne();
        });
        $('#save').titleButton('status', 'save', $.tpLang.m_str.save);    
        $('#save').on('click', function() {
            $.startWaitingMobile($.tpLang.m_str.waiting);
            var newStr;
            var selectVolumeUuid;
            var selectVolumeLabel;
            var index;
            var command = {};
            var command_ftp = {};
            var command_dlna = {};
            var stack_samba;
            var enableDlna = 0;
            var str;
            var stack_ftp;
            var curFolderPath;
            var currentVol = $('#shareVolume').selectMobile('value');

            if (!$.checkAllInput()) return false;

            selectVolumeUuid = '';
            selectVolumeLabel = '';

            $.each(volumeList, function() {
                if (this.name == currVolume) {
                    selectVolumeUuid = this.uuid;
                    selectVolumeLabel = this.label;
                }
            });

            str = $('#filename').html();
            if (str == '') {
                $.alert(CMM_USB_BROWSE_FOLDER_PATH);
                return;
            }

            if (str.length == 2 || str == 'ALL:') {
                curFolderPath = '/';
            } else {
                curFolderPath = str.substring(str.indexOf(':') + 1, str.length);
            }

            if (currentVol == $.tpLang.table_str.selectopt) {
                $.alert(CMM_USB_SELECT_VOLUME);
                return;
            }

            if ('add' == shareTabStatus) {
                for (index = 0; index < accessFolderList_samba.length; index++) {
                    if ((curFolderPath == accessFolderList_samba[index].name) && (selectVolumeUuid == accessFolderList_samba[index].volumeUuid)) {
                        $.alert(ERR_USB_DIR_EXIST);
                        return;
                    }

                    if ($('#shareName').inputBoxMobile('option', 'value') == accessFolderList_samba[index].alias) {
                        $.alert(ERR_USB_SHARE_NAME_EXIST);
                        return;
                    }
                }

                command.name = curFolderPath;
                command.alias = $('#shareName').inputBoxMobile('option', 'value')
                command.enable = 1;
                command.needAuth = ($('#ea').checkboxMobile('option', 'checked') == true) ? 1 : 0;

                command_ftp.name = curFolderPath;
                command_ftp.alias = $('#shareName').inputBoxMobile('option', 'value')
                command_ftp.enable = 1;
                command_ftp.needAuth = ($('#ea').checkboxMobile('option', 'checked') == true) ? 1 : 0;
                command_ftp.writePermission = ($('#wa').checkboxMobile('option', 'checked') == true) ? 7 : 3;

                command_dlna.name = curFolderPath;
                command_dlna.alias = $('#shareName').inputBoxMobile('option', 'value')
                command_dlna.enable = ($('#ems').checkboxMobile('option', 'checked') == true) ? 1 : 0;
                command_dlna.needAuth = ($('#ea').checkboxMobile('option', 'checked') == true) ? 1 : 0;
                if (selectVolumeUuid != '') {
                    command.volumeUuid = selectVolumeUuid;
                    command_ftp.volumeUuid = selectVolumeUuid;
                    command_dlna.volumeUuid = selectVolumeUuid;
                }
                if (selectVolumeLabel != '') {
                    command.volumeLabel = selectVolumeLabel;
                    command_ftp.volumeLabel = selectVolumeLabel;
                    command_dlna.volumeLabel = selectVolumeLabel;
                }

                $.act(ACT_ADD, SMB_SERVICE_FOLDER, null, null, command);
                accessFolderList_samba = $.act(ACT_GL, SMB_SERVICE_FOLDER, null, null, null);

                $.act(ACT_ADD, FTP_SERVER_FOLDER, null, null, command_ftp);
                accessFolderList_ftp = $.act(ACT_GL, FTP_SERVER_FOLDER, null, null, null);

                $.act(ACT_ADD, DLNA_MEDIA_SERVER_FOLDER, null, null, command_dlna);
                accessFolderList_dlna = $.act(ACT_GL, DLNA_MEDIA_SERVER_FOLDER, null, null, null);
            } else {
                for (index = 0; index < accessFolderList_samba.length; index++) {
                    if (($('#shareName').inputBoxMobile('option', 'value') == accessFolderList_samba[index].alias) && (index != editCurIndex)) {
                        $.alert(ERR_USB_SHARE_NAME_EXIST);
                        return;
                    }
                    if ((curFolderPath == accessFolderList_samba[index].name) && (selectVolumeUuid == accessFolderList_samba[index].volumeUuid) && (index != editCurIndex)) {
                        $.alert(ERR_USB_DIR_EXIST);
                        return;
                    }
                }

                command.name = curFolderPath;
                command.alias = $('#shareName').inputBoxMobile('option', 'value')
                command.needAuth = ($('#ea').checkboxMobile('option', 'checked') == true) ? 1 : 0;

                command_ftp.name = curFolderPath;
                command_ftp.alias = $('#shareName').inputBoxMobile('option', 'value')
                command_ftp.needAuth = ($('#ea').checkboxMobile('option', 'checked') == true) ? 1 : 0;
                command_ftp.writePermission = ($('#wa').checkboxMobile('option', 'checked') == true) ? 7 : 3;

                command_dlna.name = curFolderPath;
                command_dlna.alias = $('#shareName').inputBoxMobile('option', 'value')
                command_dlna.enable = ($('#ems').checkboxMobile('option', 'checked') == true) ? 1 : 0;
                command_dlna.needAuth = ($('#ea').checkboxMobile('option', 'checked') == true) ? 1 : 0;

                if (selectVolumeUuid != '') {
                    command.volumeUuid = selectVolumeUuid;
                    command_ftp.volumeUuid = selectVolumeUuid;
                    command_dlna.volumeUuid = selectVolumeUuid;
                }
                if (selectVolumeLabel != '') {
                    command.volumeLabel = selectVolumeLabel;
                    command_ftp.volumeLabel = selectVolumeLabel;
                    command_dlna.volumeLabel = selectVolumeLabel;
                }

                $.act(ACT_SET, SMB_SERVICE_FOLDER, accessFolderList_samba[editCurIndex].__stack, null, command);
                accessFolderList_samba = $.act(ACT_GL, SMB_SERVICE_FOLDER, null, null, null);

                $.act(ACT_SET, FTP_SERVER_FOLDER, accessFolderList_ftp[editCurIndex].__stack, null, command_ftp);
                accessFolderList_ftp = $.act(ACT_GL, FTP_SERVER_FOLDER, null, null, null);

                $.act(ACT_SET, DLNA_MEDIA_SERVER_FOLDER, accessFolderList_dlna[editCurIndex].__stack, null, command_dlna);
                accessFolderList_dlna = $.act(ACT_GL, DLNA_MEDIA_SERVER_FOLDER, null, null, null);
            }

            $.exe(function(ret) {
                if (!ret) {
                    if ('add' == shareTabStatus) {
                        folderIdx = accessFolderList_samba.length - 1;
                        stack_samba = accessFolderList_samba[folderIdx].__stack;
                        stack_ftp = accessFolderList_ftp[folderIdx].__stack;
                    } else {
                        stack_samba = accessFolderList_samba[editCurIndex].__stack;
                        stack_ftp = accessFolderList_ftp[editCurIndex].__stack;
                    }

                    var newFlag = 1;
                    var userCommand = {};

                    for (index = 0; index < userAccessList_samba.length; index++) {
                        if (parseInt(stack_samba, 10) != parseInt(userAccessList_samba[index].__stack, 10)) {
                            continue;
                        }

                        if (parseInt(userList[0].__stack, 10) == userAccessList_samba[index].userId) {
                            userCommand.userId = 1;
                            if ($('#wa').checkboxMobile('option', 'checked') == true) {
                                userCommand.permissions = 7;
                            } else {
                                userCommand.permissions = 3;
                            }
                        }

                        $.act(ACT_SET, SMB_USER_ACCESS, userAccessList_samba[index].__stack, null, userCommand);
                        newFlag = 0;
                    }
                    if (1 == newFlag) {
                        userCommand.userId = 1;
                        if ($('#wa').checkboxMobile('option', 'checked') == true) {
                            userCommand.permissions = 7;
                        } else {
                            userCommand.permissions = 3;
                        }

                        $.act(ACT_ADD, SMB_USER_ACCESS, null, stack_samba, userCommand);
                    }

                    $.exe(function(ret) {
                        if (!ret) {
                            $.act(ACT_SET, SMB_SERVICE, null, null, ['modified=0']);
                            $.act(ACT_SET, FTP_SERVER, null, null, ['modified=0']);

                            if (!$.exe()) {
                                $.stopWaitingMobile();
                                // loadPageOne();
                                $.reload();
                            }
                        } else {
                            // $.stopWaitingMobile();
                        }
                    });
                } else {
                    // $.stopWaitingMobile();
                }
            });
            // $.stopWaitingMobile();
        });
        
        $('.inputBox-mobile-div>input[type="text"]').inputBoxMobile('hideWarnings');
    }

    function loadPageThree() {
        $('#page-one').addClass('nd');
        $('#page-two').addClass('nd');
        $('#page-three').removeClass('nd');

        $(titleThree).titleBar();
        $('#back3').unbind('click').bind('click', function() {
            loadPageTwo();
            if (shareTabStatus == 'modify') {
                $('#titleTwo').titleBar('title', $.tpLang.folderSharing_nstr.modFolder);
            }
            else {
                $('#titleTwo').titleBar('title', $.tpLang.folderSharing_nstr.addFolder);
            }
        });
        $('#done').titleButton('status', 'done', $.tpLang.m_str.done);
        var selectedVolume = $('#shareVolume').selectMobile('value');
        $('#pathValue').html(selectedVolume);
        // $('#pathValue').html(($('#filename').html()).substring(0, $('#filename').html().indexOf(':') + 1));

        createChildFolder();

        $('#done').bind('click', function() {
            $('#filename').html(transStr($('#pathValue').html()));
            loadPageTwo();
        });
    }

    $('.botP-toolBar').on('click', '#tb-add', function() {
        shareTabStatus = 'add';
        addShare();
        loadPageTwo();
    });

    $('#addFolder').buttonMobile({
        'text': $.tpLang.folderSharing_nstr.addFolder
    }).on('click.buttonMobile', function() {
        shareTabStatus = 'add';
        addShare();
        loadPageTwo();
    });


    function initAuthTab() {
        usbDeviceList = $.act(ACT_GL, USB_DEVICE, null, null);
        volumeList = $.act(ACT_GL, LOGICAL_VOLUME, null, null);
        if (!$.exe()) {
            for (idx = 1; idx <= usbDeviceList.length; idx++) {
                if ('Online' == usbDeviceList[idx - 1].status) {
                    for (index = 0; index < volumeList.length; index++) {
                        if (((usbDeviceList[idx - 1].__stack).split(','))[0] == ((volumeList[index].__stack).split(','))[0]) {
                            if (volumeList[index].status == 'Online') {
                                // var marginTop = '';
                                // if (idx > 1) {
                                //     marginTop = ' class="mtNo"';
                                // }
                                var newDiv = $('<div class="section-container"><div class="section-box">'
                                           + '<div class="device-div" id="authTab_' + idx + '">' 
                                           + '<div class="device-label"><span class="sprite grid-row-folder"></span></div>'
                                           + '<div class="device-content"><div class="device-line"><div class="device-info">'
                                           + '<div class="device-info-name">' + $.tpLang.s_str.volume +'('+volumeList[index].name+')'+ '</div>'
                                           + '<div class="device-info-item">'
                                           + '<span class="device-info-title">' + $.tpLang.folderSharing_nstr.t_folP + '</span>'
                                           + '<span class="device-info-text">' + volumeList[index].label + ':' + '</span>'
                                           + '</div><div class="device-info-item">'
                                           + '<span class="device-info-title">' + $.tpLang.folderSharing_nstr.t_shareN + '</span>'
                                           + '<span class="device-info-text">' + volumeList[index].name + '</span>'
                                           + '</div>'
                                           + '</div></div></div>'
                                           + '</div></div>');
                                newDiv.appendTo($('#authTab'));
                                $.addDeviceBlock($('#authTab_' + idx));
                            }
                        }
                    }
                }
            }
        }
    }


    function escapeStr(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/ /g, '&nbsp;');
    }

    function transStr(str) {
        return str.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&nbsp;/g, ' ').replace(/\s/g, ' ');
    }

    function initShareTab() {
        var fp;
        var matchVolume;
        var dlnaEnable;
        var index;
        var i;

        $('#shareTab').removeClass('nd');
        for (index = 0; index < accessFolderList_samba.length; index++) {
            var match = false;
            var volumeName = $.tpLang.m_str.disconn;
            fp = accessFolderList_samba[index].volumeLabel + ':' + accessFolderList_samba[index].name;

            $.each(volumeList, function() {
                if (this.uuid == accessFolderList_samba[index].volumeUuid) {
                    matchVolume = this;
                    match = true;
                    return false;
                }
            });

            dlnaEnable = $.tpLang.table_str.off;
            if (accessFolderList_dlna[index].enable == 1) {
                dlnaEnable = $.tpLang.table_str.on;
            }

            for (i = 0; i < volumeList.length; i++) {
                if (volumeList[i].label == accessFolderList_samba[index].volumeLabel) {
                    volumeName = volumeList[i].name;
                }
            }

            if (volumeName == undefined) {
                volumeName = $.tpLang.m_str.disconn;
            }

            var marginTop = '';
            if (index > 0) {
                marginTop = ' class="mtNo"';
            }
            var newDiv = $('<li' + marginTop + '><div class="li-content-div" id="_shareTab_' + index + '">'
                       + '<div class="device-div" id="shareTab_' + index + '">' 
                       + '<div class="device-label"><span class="sprite grid-row-folder"></span></div>'
                       + '<div class="device-content"><div class="device-line"><div class="device-info">'
                       + '<div class="device-info-name">' + accessFolderList_samba[index].alias + '</div>'
                       + '<div class="device-info-item">'
                       + '<span class="device-info-title">' + $.tpLang.folderSharing_nstr.t_folP + '</span>'
                       + '<span class="device-info-text">' + escapeStr(fp) + '</span>'
                       + '</div><div class="device-info-item">'
                       + '<span class="device-info-title">' + $.tpLang.folderSharing_nstr.t_vol + '</span>'
                       + '<span class="device-info-text">' + volumeName + '</span>'
                       + '</div><div class="device-info-item">'
                       + '<span class="device-info-title">' + $.tpLang.table_str.mediaSharing + ':' + '</span>'
                       + '<span class="device-info-text">' + dlnaEnable + '</span>'
                       + '</div>'
                       + '</div><div class="op"><span class="sprite c-arrow-gray-right floatRight"></span></div></div></div>'
                       + '</div></li>');
            newDiv.appendTo($('#shareTab'));
            $.addDeviceBlock($('#shareTab_' + index));
        }
        $('#shareTab').addClass('nd');
        $('#shareTab').editList();
        var allTargets = $('#shareTab').find('.li-content-div');
        $.each(allTargets, function() {
            $(this).bind('delete.editlist', function() {
                delShare((this.id).replace('_shareTab_', ''));
            }).bind('click', function() {
                shareTabStatus = 'modify';
                loadPageTwo((this.id).replace('_shareTab_', ''));
            })
        });
        if ($('#shareTab').find('.li-content-div').length == 0) {
            $('#noFolder').removeClass('nd');
            $('#addFolder').removeClass('nd');
        }
    }

    function delShare(index) {
/*        countDelete--;
        var i;

        deletedShare.push(index);
        index = index - deletedShare.indexOf(index);

        console.log(index);
        console.log(accessFolderList_samba);
        console.log(accessFolderList_dlna);

        $.act(ACT_DEL, SMB_SERVICE_FOLDER, accessFolderList_samba[index].__stack, null, null);
        $.act(ACT_DEL, FTP_SERVER_FOLDER, accessFolderList_ftp[index].__stack, null, null);
        $.act(ACT_DEL, DLNA_MEDIA_SERVER_FOLDER, accessFolderList_dlna[index].__stack, null, null);

        for (i = 0; i < accessFolderList_dlna.length; i++) {
            if (accessFolderList_samba[index].name == accessFolderList_dlna[i].name) {
                $.act(ACT_DEL, DLNA_MEDIA_SERVER_FOLDER, accessFolderList_dlna[i].__stack, null, null);
                accessFolderList_dlna = $.act(ACT_GL, DLNA_MEDIA_SERVER_FOLDER, null, null, null);
            }
        }

        if (!$.exe()) {
            $.act(ACT_SET, SMB_SERVICE, null, null, ['modified=0']);
            $.act(ACT_SET, FTP_SERVER, null, null, ['modified=0']);
            if (!$.exe()) {
                if ($('#shareTab').find('li').length == 1) {
                    $('#noFolder').removeClass('nd');
                }
            }
        }

        accessFolderList_samba = $.act(ACT_GL, SMB_SERVICE_FOLDER, null, null, null);
        if (!$.exe()) {}

        if (countDelete == 0) {
            if ($('#edit').titleButton('status') == 'cancel') {
                $('#edit').trigger('click');
            }
        }*/
        countDelete--;
        $.act(ACT_DEL, SMB_SERVICE_FOLDER, accessFolderList_samba[index].__stack, null, null);
        $.act(ACT_DEL, FTP_SERVER_FOLDER, accessFolderList_ftp[index].__stack, null, null);
        $.act(ACT_DEL, DLNA_MEDIA_SERVER_FOLDER, accessFolderList_dlna[index].__stack, null, null);
        $.exe(function(err) {
            if (!err) {
                if ($('#edit').titleButton('status') == 'cancel') {
                    if (countDelete !== 0) {
                        return;
                    }
                }
                $.act(ACT_SET, SMB_SERVICE, null, null, ["modified=0"]);
                $.act(ACT_SET, FTP_SERVER, null, null, ["modified=0"]);
                $.exe(function(err) {
                    if (!err) {
                        $('#titleOne ').empty();
                        $.reload(); 
                    }
                });                
            }
        });
    }

    /* 从服务器读取数据，填写page-two的表单 */
    function modifyShare(index) {
        var i;
        editCurIndex = index;
        var str = accessFolderList_samba[index].volumeLabel + ':';

        $('#shareVolume').selectMobile('value', str);

        $('#filename').html(accessFolderList_samba[index].volumeLabel + ':' + accessFolderList_samba[index].name);
        $('#shareName').inputBoxMobile({'value': accessFolderList_samba[index].alias});

        if (accessFolderList_samba[index].needAuth == 1) {
            $('#ea').checkboxMobile({'checked': true});
        }

        for (i = 0; i < userAccessList_samba.length; i++) {
            if (parseInt(accessFolderList_samba[index].__stack, 10) != parseInt(userAccessList_samba[i].__stack, 10)) {
                continue;
            }

            if (parseInt(userList[0].__stack, 10) == userAccessList_samba[i].userId) {
                if (userAccessList_samba[i].permissions == 7) {
                    $('#wa').checkboxMobile({'checked': true});
                } else {
                    $('#wa').checkboxMobile({'checked': false});
                }
            }
        }

        if (accessFolderList_dlna[index].enable == 1) {
            $('#ems').checkboxMobile({'checked': true});
        }

    }

    /* 清空page-two的表单 */
    function addShare() {
        $('#shareVolume').selectMobile('selectedIndex', 0);

        $('#filename').html('');
        $('#shareName').val('');

        $('#page-two').find('input[type="checkbox"]').checkboxMobile({'checked': false});

    }

    function createChildFolder() {
        var tempString = $('#pathValue').html();
        var tempIndex = tempString.indexOf(':');
        for (index = 0; index < volumeList.length; index++) {
            if (tempString.substring(0, tempIndex) == (volumeList[index].label)) {
                currVolume = volumeList[index].name;
            }
        }

        var command = {};
        command.targetPath = currVolume + tempString.substring(tempIndex + 1);
        var ide;

        $.act(ACT_SET, FOLDER_BROWSE, null, null, command);
        folderList = $.act(ACT_GL, FOLDER_NODE, null, null, null);

        if (!$.exe()) {
            if (folderList.length > 0) {
                $('#folderList').empty();
                thisLayer = '';
            }
            for (ide = 0; ide < folderList.length; ide++) {
                var folderNameStr = escapeStr(folderList[ide].folderName);

                var marginTop = '';
                if (ide !== 0) marginTop = ' mtNo';
                text = $('<div class="folder-div'+marginTop+'">'
                    + '<input type="radio" id="folder'+ide+'" name="folders" />'
                    + '<span class="folder-name">' + folderNameStr + '</span>'
                    + '<span class="folder-select"><span class="icon-r"></span></span>'
                    + '</div>');
                $('#folderList').append(text);
                $('#folder'+ide).radioMobile({
                        'advanced': 'folder'
                    })
                    .bind('check.radioMobile', function() {
                        var tempValue = $('#pathValue').html();
                        var thisName = ($(this).parents('.folder-div').find('.folder-name').first()).html();
                        $('#pathValue').html(tempValue + '/' + thisName);
                        thisLayer = thisName;
                    })
                    .bind('uncheck.radioMobile', function() {
                        var tempValue = $('#pathValue').html();
                        var thisName = ($(this).parents('.folder-div').find('.folder-name').first()).html();
                        $('#pathValue').html(tempValue.replace('/' + thisName, ''));
                        thisLayer = '';
                    });
                var selectSpan = $('#folder'+ide).parents('.folder-div').find('.folder-select').first();
                selectSpan.bind('click', function() {
                    var thisName = ($(this).parents('.folder-div').find('.folder-name').first()).html();
                    if (thisName !== thisLayer && thisLayer !== '') {
                        var lastIndex = $('#pathValue').html().lastIndexOf('/');
                        $('#pathValue').html($('#pathValue').html().substring(0, lastIndex));
                    }
                    var thisRadio = $(this).parents('.folder-div').find('input[type="radio"]').first();
                    thisRadio.radioMobile({'checked': true});
                    if ($('#pathValue').html().indexOf(thisName) < 0) {
                        $('#pathValue').html($('#pathValue').html() + '/' + thisName);
                    }
                    thisLayer = thisName;
                    createChildFolder();
                });
            }
        }

    }

})();
</script>
