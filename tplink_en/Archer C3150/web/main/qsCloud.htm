<style type="text/css">
    div#quicksetup-setup-complete div#cloud-account-2 span.icon {
        background: url(../img/icons.png) no-repeat -272px -345px;
        height: 55px;
        width: 55px;
        margin-left: 15px;
        display: inline-block;
        position: absolute;
    }
    div.login-register-change {
        position: relative;
    }
    div#quicksetup-setup-complete #internet_ok {
        font-size: 16px;
        font-weight: bolder;
    }
    div#quicksetup-setup-complete #register_account {
        font-size: 12px;
        margin-top: 15px;
        margin-bottom: 10px;
    }
    div#cloud-account-0 div#cloud_account_wizard_cnt, div#basic-account div#status-0 {
        position: relative;
        display: inline-block;
        padding-right: 24px;
    }
    div#cloud-account-0 div#cloud_account_wizard_cnt {
        margin-top: 10px;
    }
    div#cloud-account-0 form#form-login {
        margin-top: 30px;
        margin-left: 216px;
    }
    div#quicksetup-setup-complete #internet_ok {
        font-size: 16px;
        font-weight: bolder;
    }
    a.link {
        display: inline-block;
        color: #4acbd6;
        vertical-align: inherit;
        text-decoration: none;
        cursor: default;
        font-style: italic;
    }

    div.pc-login-field {
        margin: 8px 0;
    }

    .pure-form input[type="text"].tp-input-text, .pure-form input[type="password"].tp-input-text {
        padding-left: 30px;
    }

    div.pc-inputarea {
        position: relative;
        display: inline-block;
    }

    label.pc-login-password-label, label.pc-login-username-label {
        position: absolute;
        left: 0;
        top: 0;
        margin: 7px 4px 7px 7px;
        height: auto;
        z-index: 1;
    }

    label.pc-login-username-label span.icon, label.pc-login-password-label span.icon {
        background: url("./img/icons.png") no-repeat scroll -193px -1185px;
        display: inline-block;
        height: 18px;
        /* margin-right: 14px; */
        width: 18px;
        vertical-align: middle;
    }

    label.pc-login-password-label span.icon {
        background-position: -337px -1116px;
    }

    label.pc-login-username-label span.icon {
        background-position: -357px -1115px;
    }

    span.pc-forgetPwd {
        position: absolute;
        top: 0;
        left: 190px;
    }

    span.pc-forgetPwd a {
        line-height: 32px;
        text-decoration: none;
        color: #4acbd6;
        white-space: nowrap;
    }

    div.cloud_hover_container div#connect-area, div.cloud_hover_container div.cloud_account_wizard_tip_cnt {
        position: absolute;
        display: none;
        left: -300px;
        top: 34px;
        width: 390px;
    }

    div.login-register-change ul li.cloud_account_wizard_tip {
        /* display: block; */
        list-style-type: disc;
        /* margin-left: 10px; */
        margin-left: 15px;
        line-height: 18px;
        color: #666;
    }
    ul {
        padding: 0;
    }
    #quicksetup-setup-complete{
        width: 700px;
        margin-left: 190px;
    }
    div.button-container {
        text-align: left;
    }
    button.tp-btn-custom.long {
        width: 187px;
    }
    #form-skip {
        margin-left: 216px;
        margin-top: 30px;
    }
    #cloud-login {
        width: 100%;
        overflow: hidden;
    }
    div#quicksetup-setup-complete div#cloud-account-2 div#quicksetup-result-text-container {
        display: table-cell;
        height: 70px;
        padding-left: 90px;
    }
    div h4.title, div h4.title span.text {
        font-size: 21px;
        color: #191919;
        margin: 0;
    }
    div#quicksetup-setup-complete div#cloud-account-1 h4 span.icon {
        background: url(../img/icons.png) no-repeat -338px -410px;
        height: 52px;
        width: 52px;
        margin-left: 20px;
        display: inline-block;
        position: absolute;
    }
    div#quicksetup-setup-complete div#cloud-account-1 span.text {
        display: table-cell;
        height: 32px;
        padding-left: 87px;
    }
    div#quicksetup-setup-complete div#cloud-account-1 h4 {
        line-height: 52px;
        height: 64px;
    }
    p#p-quicksetup-congratulations-info-0 {
        margin-top: 36px;
        margin-bottom: 0px;
    }
    p#p-quicksetup-congratulations-info-1 {
        margin-top: 5px;
        margin-bottom: 36px;
    }
    span.input-hint{
        background: #ffffff;
        overflow: hidden;
        position: absolute;
        line-height: 20px;
        color:#cccccc;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        text-align: left;
        margin: 0.5em 0.6em 0.5em 30px ;
    }
</style>
<div id="quicksetup-setup-complete">
    <div id="cloud-account-0">
        <div class="login-register-change">
            <p><span id="internet_ok"></span></p>

            <p id="register_account"><span></span></p>

            <div id="cloud_account_wizard_cnt" class="nd">
                <span id="cloud_account_wizard"></span>

                <div class="cloud_hover_container">
                    <span class="cloud_account_icon"></span>

                    <div id="connect-area"></div>
                    <div id="cloud_account_wizard_tip" class="cloud_account_wizard_tip_cnt">
                        <div class="tips-content-container">
                            <!-- <span class="tips-content-delta"></span> -->
                            <div class="position-top-left"></div>
                            <div class="position-top-center"></div>
                            <div class="position-top-right"></div>
                            <div class="position-center-left">
                                <div class="position-center-right">
                                    <div class="tips-content-wrap">
                                        <div class="tips-content-container-wrap">
                                            <div class="tips-content">
                                                <span id="cloud_account_wizard_total"></span>
                                                <ul>
                                                    <li class="cloud_account_wizard_tip">
                                                        <span id="cloud_account_wizard_tip1"></span>
                                                    </li>
                                                    <li class="cloud_account_wizard_tip">
                                                        <span id="cloud_account_wizard_tip2"></span>
                                                    </li>
                                                    <li class="cloud_account_wizard_tip">
                                                        <span id="cloud_account_wizard_tip3"></span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="position-bottom-left"></div>
                            <div class="position-bottom-center"></div>
                            <div class="position-bottom-right"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <iframe class="nd" frameborder="0" id="cloud-login" name="cloud-login" scrolling="no"></iframe>
        <form class="pc-login-content pure-form" id="form-login">
            <div class="login-field">
                <div class="pc-inputarea">
                    <label class="pc-login-username-label">
                        <span class="icon"></span>
                    </label>
                    <input type="text" id="login-username" autocomplete="off">
                    <span class="input-hint">Email</span>
                </div>
            </div>
            <div class="pc-login-field">
                <div class="pc-inputarea">
                    <label class="pc-login-password-label">
                        <span class="icon"></span>
                    </label>
                    <input type="password" id="login-password" autocomplete="off">
                    <span class="pc-forgetPwd"><a href="#" id="btn-forget-password">For get password</a></span>
                    <span class="input-hint">Password</span>
                </div>
            </div>
            <div class="button-wrapper">
                <button type="submit" class="green T_login2 long" id="login-btn"></button>
            </div>
        </form>

        <form id="form-skip">
            <p id="no-account-tip-cnt"><span id="not-account-tip"></span></p>
            <div class="pc-login-field">
                <button type="submit" class="green T_REGISTER_NOW long" id="btn-regist-cloud"></button>
            </div>
            <div class="pc-login-field">
                <button type="submit" class="green T_REGISTER_SKIP long" id="btn-regist-skip"></button>
            </div>
        </form>

    </div>

    <div id="cloud-account-1">
        <h4 class="title">
            <span class="icon"></span>
            <span class="text" id="cloud-no-internet-title"></span>
        </h4>
        <span class="text" id="cloud-no-internet-note"></span>
    </div>

    <div id="cloud-account-2">
        <span class="icon"></span>

        <div id="quicksetup-result-text-container">
            <h4 class="title" id="h4-quicksetup-congratulations"></h4>
            <p class="note" id="p-quicksetup-congratulations-info-0"></p>
            <p class="note part-separate" id="p-quicksetup-congratulations-info-1"></p>
        </div>
    </div>
</div>


<div class="inline-btn-right quicksetup-button-container" id="btn-container">
    <div class="inline">
        <button type="submit" class="green T_reconfig" id="btn-prev">reconfig</button>
    </div>
    <div class="inline">
        <button type="submit" class="green T_next" id="btn-next">Next</button>
    </div>
</div>

<script type="text/javascript">
    (function () {
        var CURR_USER_DEFUALT = 0,
                CURR_USER_LOGING = 1,
                CURR_USER_LOGIN_SUCC = 2, /* user login successfully. */
                CURR_USER_BINDING = 3,	  /* binding is a part of login, user may not need to care about it */
                CURR_USER_BIND_SUCC = 4,
                CURR_USER_UNBINDING = 5,
                CURR_USER_UNBIND_SUCC = 6,
                CURR_USER_TOKEN_GETTING = 7,
                CURR_USER_TOKEN_GET_SUCC = 8,
                CURR_USER_LOGIN_FAILED = 20000,
                CURR_USER_TOKEN_GET_FAILED = 20001,
                CURR_USER_NO_INTERNET = 20002,    //"Internet is unavailable.",
                CURR_USER_BIND_FAILED = 20003,   //"Unable to bind the device. Please try again later.",
                CURR_USER_UNBIND_FAILED = 20004,//"Unable to unbind the device. Please try again later.",
                CURR_USER_BAD_USER = 20005, /* username not correct for local authentication. */
                CURR_USER_NOT_REG = 20006, 	/* not registered in cloud server, return from cloud server. *///"This email is not registered.",
                CURR_USER_ERR_PWD = 20007,  /* pwd error from cloud server or local authentication. */
                CURR_USER_INACTIVE = 20008; /* user account not active in cloud server. */
        $("h4#h4-quicksetup-congratulations").html($.tpLang.quicksetup_nstr.CONGRATULARIONS);
        $("p#p-quicksetup-congratulations-info-0").html($.tpLang.quicksetup_nstr.COMPLETE_INFO_0);
        $("p#p-quicksetup-congratulations-info-1").html($.tpLang.quicksetup_nstr.COMPLETE_INFO_1);

        $("#internet_ok").html($.tpLang.quicksetup_nstr.INTERNET_OK);
        $("#register_account span").html($.tpLang.quicksetup_nstr.REGISTER_NEW);
        $("#register_account").hide();
        $("#cloud_account_wizard").html($.tpLang.quicksetup_nstr.CLOUD_WIZARD);
        $("span#not-account-tip").html($.tpLang.quicksetup_nstr.NO_ACCOUNT);

        $("#cloud_account_wizard_total").html($.tpLang.quicksetup_nstr.ACCOUNT_DESP);
        $("#cloud_account_wizard_tip1").html($.tpLang.quicksetup_nstr.ACCOUNT_DESP_SUB1);
        $("#cloud_account_wizard_tip2").html($.tpLang.quicksetup_nstr.ACCOUNT_DESP_SUB2);
        $("#cloud_account_wizard_tip3").html($.tpLang.quicksetup_nstr.ACCOUNT_DESP_SUB3);

        $("span#cloud-no-internet-title").html($.tpLang.quicksetup_nstr.SORRY);
        $("span#cloud-no-internet-note").html($.tpLang.quicksetup_nstr.TEST_INTERNET_FAILED_INFO_1);

        $("div#cloud-account-0").hide();
        $("div#cloud-account-1").hide();
        $("div#cloud-account-2").hide();

        $("button#btn-regist-cloud").on('click', function(){
            onReceive({data: {eType: "ev_goto", url: "register"}, source: null, origin: "_self"});
        });
        $("button#btn-regist-skip").on('click', function(){
            $("p#p-quicksetup-congratulations-info-1").html($.tpLang.quicksetup_nstr.COMPLETE_INFO_2);
            $("div#cloud-account-2").show();
            $("div#cloud-account-0").hide();
            $("div#cloud-account-1").hide();
            $('#btn-next').html('<span>' + $.tpLang.m_str.finish + '</span>');
            $('#btn-prev').hide();
            $('#btn-container').show();
        });
        $("#cloud-login").hide();

        $('#btn-next').on('click', function() {
            $.qf.exit();
        });
        $('#btn-prev').on('click', function() {
           $('#qs').click();
        });

        /***************cloud event ********************/
//param e include e.data & e.source & e.origin
        function onReceive(eObject){
            var e = eObject.originalEvent || eObject;
            //console.log("quick setup receive from "+ e.origin, e.data, e)
            if(e.origin !== $.cloudOrigin && e.origin !== "_self" && e.origin != undefined){
                return;
            }
            var data = e.data;
            if(typeof(e.data) == "string"){
                data = $.parseJSON(data);
            }
            if(data){
                switch(data.eType){
                    //module change
                    case "ev_goto": {
                        if(data.url){
                            //getToken and set iframe's src, then set wating event(10s timeout)
                            $.getToken(data.url);
                        }
                        else{
                            if(data.index == "activation"){
                                ;
                            }
                        }
                        if("login" == data.url || "login" == data.index){
                            $("#cloud-login").hide();
                            $("#form-login").show();
                            $("#register_account").hide();
                            $("#cloud_account_wizard_cnt").show();
                            $("#no-account-tip-cnt").show();
                            $("button#btn-regist-cloud").show();
                            $("button#btn-regist-skip").show();
                        }
                        else if("register" == data.url || "register" == data.index){
                            $.addLoading();
                            $("#form-login").hide();
                            $("#cloud_account_wizard_cnt").hide();
                            $("#no-account-tip-cnt").hide();
                            $("button#btn-regist-cloud").hide();
                            $("button#btn-regist-skip").hide();
                            $("#register_account").show();
                        }
                        else if("findBackPassword" == data.url || "findBackPassword" == data.index){
                            $.addLoading();
                            $("#form-login").hide();
                            $("#no-account-tip-cnt").hide();
                            $("button#btn-regist-cloud").hide();
                            $("button#btn-regist-skip").hide();
                        }
                        break;
                    }
                    //cloud login status
                    case "ev_login": {
                        var account = data.account;
                        if(e.origin == $.cloudOrigin){
                            //cloud des decrypt
                            account.cloudPassword = $.DES3.decrypt(account.cloudPassword);
                        }

                        $.act(ACT_SET, CURRENT_USER, null, null, ["userName=" + account.cloudUserName, "passwd=" + account.cloudPassword, "action=2", "loginStatus=0", "needReconn=1"]) ;
                        if ($.exe()) {
                            return;
                        }

                        var count = 0;
                        var timesMax = 10;
                        setTimeout(function() {
                            count++;
                            userObj = $.act(ACT_GET, CURRENT_USER, null, null);
                            if ($.exe()) {
                                return;
                            }

                            if (userObj.loginStatus == CURR_USER_LOGIN_SUCC) {
                                //登录成功
                                $("p#p-quicksetup-congratulations-info-1").html($.tpLang.quicksetup_nstr.COMPLETE_INFO_EMAIL_PREFIX + account.cloudUserName);
                                $("div#cloud-account-2").show();
                                $("div#cloud-account-0").hide();
                                $("div#cloud-account-1").hide();
                                $('#btn-next').html('<span>' + $.tpLang.m_str.finish + '</span>');
                                $('#btn-prev').hide();
                                $('#btn-container').show();

                                $.cloudLogin(true, userObj.userName);
                                $.adjustTop();
                                $.removeLoading();
                            } else if(userObj.loginStatus >= 20000){
                                //登录失败
                                $.alert($.tpLang.cloudBasic_nstr['E' + userObj.loginStatus]);
                            } else if (count < timesMax) {
                                setTimeout(arguments.callee, 1000);
                            } else {
                                $.alert($.tpLang.ddns_nstr['E20002']);
                            }
                        }, 1000);
                        break;
                    }
                }
            }
        }
        $(window).off('.qsCloud').on("message.qsCloud", onReceive);
        /***************cloud event end********************/

        $("input#login-username ~ .input-hint").text($.tpLang.login.email);
        $("input#login-password ~ .input-hint").text($.tpLang.login.password);
        $("input#login-password").on('keyup', function (e) {
            if (e.keyCode == 13) {
                cloudLoginBtn.click();
            }
        }).tpPassword();



        $("a#btn-forget-password").html($.tpLang.login.forgetPwd).on("click", function(e){
            onReceive({data:{eType:"ev_goto",url:"findBackPassword"},source:null,origin:"_self"});
        });

        var cloudLoginBtn = $("button#login-btn").on('click', function() {
            $.addLoading($(this));
            var $password = $("#login-password");
            var $user = $("#login-username");
            var pwd = $password.val();
            var user = $user.val();

            if (user == '') {
                $.alert($.tpLang.login.tipsText);
                $user.focus();
                return;
            }
            var regex = /^[a-zA-Z0-9\.\!\#\$\%\&\'\*\+\/\=\?\^\_\`\{\|\}\~\-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*$/;
            if (!regex.test(user)) {
                $.alert($.tpLang.login.emailFormat);
                $user.focus();
                return;
            }
            if (pwd == "") {
                $.alert($.tpLang.login.tipsText);
                $password.focus();
                return;
            }

            onReceive({data:{eType:"ev_login",account:{cloudUserName: user, cloudPassword: pwd}},source:null,origin:"_self"});

        });

        /* added by CCy for AC3150/AC3200 */
        var step = 0;        
        var ethStk = "";
        var bStart = false;
        var diagTimeout = $.getAsync();
        function doInternetDiag(callCon, callDis) {
            var ethIntfCfg = {};
            var dftConnection = {};
            var connStatus = "";

            if (!$.checkAsync(diagTimeout))
                return;

            switch (step) {
                case 0:
                    if (ethStk == "") {
                        if (callDis) {
                            callDis();
                        }
                        return;
                    }
                    ethIntfCfg = $.act(ACT_GET, WAN_ETH_INTF, ethStk, null, ["Status"]);
                    $.exe(function(err) {
                        if (err) {
                            $.alert(err);
                            return;
                        }
                        if (ethIntfCfg.status == "Up") {
                            step++;
                           doInternetDiag(callCon, callDis);
                        } 
                        else if (ethIntfCfg.status == "NoLink" || ethIntfCfg.status == "Disabled" || ethIntfCfg.status == "Error") {
                            if (callDis) {
                                callDis();
                            }
                            return;
                        } 
                        else {
                            setTimeout(function() {
                                doInternetDiag(callCon, callDis);
                            }, 1000);
                        }
                    });
                    break;
                case 1:
                    if ($.qd.eth.connectionType == "PPPoE") {
                        dftConnection = $.act(ACT_GET, WAN_PPP_CONN, $.qd.eth.diagStack, null, ["ConnectionStatus", "LastConnectionError"]);
                    } else if ($.qd.eth.connectionType == "DynamicIp" || $.qd.eth.connectionType == "StaticIp") {
                        dftConnection = $.act(ACT_GET, WAN_IP_CONN, $.qd.eth.diagStack, null, ["ConnectionStatus"]);
                    } else if (INCLUDE_PPTP && $.qd.eth.connectionType == "Pptp") {
                        dftConnection = $.act(ACT_GET, WAN_PPTP_CONN, $.qd.eth.diagStack, null, ["ConnectionStatus"]);
                    } else if (INCLUDE_L2TP && $.qd.eth.connectionType == "L2tp") {
                        dftConnection = $.act(ACT_GET, WAN_L2TP_CONN, $.qd.eth.diagStack, null, ["ConnectionStatus"]);
                    }

                    $.exe(function(err) {
                        if (err) {
                            $.alert(err);
                            return;
                        }
                        connStatus = dftConnection.connectionStatus;
                        if (connStatus == "Connected") {
                            step++;
                            doInternetDiag(callCon, callDis);
                        } 
                        else if (connStatus == "Disconnected" || connStatus == "Unconfigured") {
                            if (callDis) {
                                callDis();
                            }
                            return;
                        } 
                        else {
                            setTimeout(function() {
                                doInternetDiag(callCon, callDis);
                            }, 1000);
                        }
                    });
                    break;
                case 2:
                    diagTool = $.act(ACT_GET, DIAG_TOOL, null, null, ["LastResult"]);
                    $.exe(function(err) {
                        if (err) {
                            $.alert(err);
                            return;
                        }
                        if (diagTool.lastResult == 3) {
                            setTimeout(function() {
                                doInternetDiag(callCon, callDis);
                            }, 1000);

                        } 
                        else {
                            if (bStart == true) {
                                if (diagTool.lastResult == 1) {
                                    if (callCon) {
                                        callCon();
                                    }
                                    return;
                                } 
                                else {
                                    if (callDis) {
                                        callDis();
                                    }
                                    return;
                                }
                            } 
                            else {
                                bStart = true;
                                $.act(ACT_OP, ACT_OP_DIAG_DNSDIAG, diagTool.__stack);
                                $.exe(function(err) {
                                    if (err) {
                                        $.alert(err);
                                        return;
                                    }
                                    setTimeout(function() {
                                        doInternetDiag(callCon, callDis);
                                    }, 1000);
                                });
                            }
                        }
                    });
                    break;
            }           
        }
        /* add ended by CCy for AC3150/AC3200 */

        var userObj;
        function init() {
            $.addLoading();
            userObj = $.act(ACT_GET, CURRENT_USER);
            $.exe();

            /* added by CCy for AC3150/AC3200 */
            var commonIntfCfgList = $.act(ACT_GL, WAN_COMMON_INTF_CFG, null, null, ["WANAccessType"]);
            $.exe();
            $.each(commonIntfCfgList, function() {
                if (this.WANAccessType == "Ethernet") {
                    ethStk = this.__stack;
                    return false;
                }
            });

            // changed by CCy for AC3150/AC3200 */
            // $.doInternetDiag(function () {
            setTimeout (function() {
                doInternetDiag(function () {
                    if (userObj.userSetting == 2 && userObj.loginStatus == 2) {
                    //已登录
                        $("p#p-quicksetup-congratulations-info-1").html($.tpLang.quicksetup_nstr.COMPLETE_INFO_EMAIL_PREFIX + userObj.userName);
                        $("div#cloud-account-2").show();
                        $("div#cloud-account-0").hide();
                    	$("div#cloud-account-1").hide();
                        $('#btn-next').html('<span>' + $.tpLang.m_str.finish + '</span>');
                        $('#btn-prev').hide();
                        $('#btn-container').show();
                    } else {
                        //设备未登陆云账号
                        $("div#cloud-account-0").show();
                        $("div#cloud-account-1").hide();
                        $("div#cloud-account-2").hide();
                        $('#btn-container').hide();
                    }
                    $.removeLoading();
                }, function () {
                    $('#btn-next').html('<span>' + $.tpLang.m_str.finish + '</span>');
                    $("div#cloud-account-1").show();
                    $("div#cloud-account-0").hide();
                    $("div#cloud-account-2").hide();
                    $.removeLoading();
                });                
            }, 5000);

        }

        init();
        $('.input-hint').click(function(e){
            var inputArea = $(e.target).parents('.pc-inputarea').find('input:visible');
            if (inputArea.length > 0) {
                inputArea.focus();
            }       
        });
        $('.pc-inputarea input').bind('blur',function(e){
            var val = $(e.target).val();
            if (!val){
                var inputHint = $(e.target).parents('.pc-inputarea').find('.input-hint');
                inputHint.show();
            }
        }).bind('focus',function(e){
            $(e.target).parents('.pc-inputarea').find('.input-hint').hide();
        });
    })();
</script>