<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cloud Security</title>
</head>

<body>
    <div class="func-container">
        <h3 id="t_INTERNET_SHIELD"></h3>
        <div id="internet-shield">
            <div class="shield-wrapper">
                <div class="shield-icon"></div>
                <div class="shield-detail">
                    <div class="history">
                        <span class="icon"></span>
                        <span class="text"></span>
                    </div>
                    <div class="protect-days">
                        <span class="digit"></span>
                        <span class="days"></span>
                    </div>
                    <span class="caption"></span>
                    <div id="enable-btn-ctn">
                        <button type="submit" class="green T T_c_enable_all" id="start-security">Start1</button>
                    </div>
                </div>
            </div>
            <a class="trendmicro-logo" href="http://www.trendmicro.com/" target="_blank"></a>
        </div>
        <h3 id="t_ALERT_NOTIFICATION"></h3>
        <div id="alert-notification">
            <div class="notification-type site-block">
                <span class="icon"></span>
                <div class="function">
                    <span class="title"></span>
                    <span class="text"></span>
                </div>
                <div class="button-group-container inline cloud-security-switch">
                    <ul>
                        <li>
                            <button id="site-block-on" class="fst" value="on">On</button>
                        </li>
                        <li>
                            <button id="site-block-off" class="lst" value="off">Off</button>
                        </li>
                    </ul>
                </div>
                <!-- <input id="site-block" name="malicious_sites_blocking" value="" /> -->
            </div>
            <div class="notification-type intrusion-prevent">
                <span class="icon"></span>
                <div class="function">
                    <span class="title"></span>
                    <span class="text"></span>
                </div>
                <div class="button-group-container inline cloud-security-switch">
                    <ul>
                        <li>
                            <button id="intrusion-prevent-on" class="fst" value="on">On</button>
                        </li>
                        <li>
                            <button id="intrusion-prevent-off" class="lst" value="off">Off</button>
                        </li>
                    </ul>
                </div>
                <!-- <input id="intrusion-prevent" name="intrusion_prevention_system" value=""  /> -->
            </div>
            <div class="notification-type device-block">
                <span class="icon"></span>
                <div class="function">
                    <span class="title"></span>
                    <span class="text"></span>
                </div>
                <div class="button-group-container inline cloud-security-switch">
                    <ul>
                        <li>
                            <button id="device-block-on" class="fst" value="on">On</button>
                        </li>
                        <li>
                            <button id="device-block-off" class="lst" value="off">Off</button>
                        </li>
                    </ul>
                </div>
                <!-- <input id="device-block" name="infected_device_quarantine" value=""  /> -->
            </div>
        </div>

        <div class="database">
            <span class="icon"></span>
            <span class="text"></span>
        </div>

        <div id="alert-notification-msg">
            <div class="title"></div>
            <div class="content"></div>
        </div>

        <!--    <div id="clear-history-msg" class="warning">
        <h4 class="title">
            <span class="icon"></span>
            <span class="text" id="clear-history-msg-text"></span>
        </h4>
    </div> -->

        <div id="help-cloud-security"></div>
    </div>

    <script type="text/javascript">
    $(document).ready(function(e) {
        var categoryList = [];
        var ruleList = [];
        var protectedDays = 0;

        function getCatagoryList() {
            /*in production mode ,use $.cgi(/info/) to get the catetory list
            in development , use a array replace it;
            */
            $.act(ACT_CGI, "/cgi/getTmSecWrsCatsDb");
            $.exe();

            categoryList = [];
            for (var i = 0; i < g_tmSecWrsCatsList.length; i++) {
                categoryList.push({
                    id: g_tmSecWrsCatsList[i][0],
                    name: g_tmSecWrsCatsList[i][1]
                });
            }
        }
        // getCatagoryList();

        function getRuleList() {
            /*in production mode ,use $.cgi(/info/) to get the catetory list
            in development , use a array replace it;
            */
            $.act(ACT_CGI, "/cgi/getTmSecRulesDb");
            $.exe();

            ruleList = [];
            for (var i = 0; i < g_tmSecRulesList.length; i++) {
                ruleList.push({
                    id: g_tmSecRulesList[i][0],
                    name: g_tmSecRulesList[i][1]
                });
            }

        }
        // getRuleList();

        function getEnable(callback) {
            var secEnableObj = $.act(ACT_GET, TM_SECURITY, null, null, null);
            var secHistoryObj = $.act(ACT_GET, SEC_HISTORY, null, null, null);
            if(!$.exe()){
                var data = $.extend({}, secHistoryObj, secEnableObj);
                protectedDays = data.daysUsed;
                $("div.protect-days span.digit").html(data.daysUsed);
                if (data.daysUsed == 1) {
                    $("div.protect-days span.days").html($.tpLang.antiVirus_nstr.DAY);
                } else {
                    $("div.protect-days span.days").html($.tpLang.antiVirus_nstr.DAYS);
                }
                if (data.isUpdating == 1) {
                    $("div.database").addClass("updating");
                    $("div.database span.text").html($.tpLang.antiVirus_nstr.DATABASE_UPDATING);
                    $.timeout(function(){
                        getEnable(updateStatus);
                    },5000);
                } else {
                    $("div.database").removeClass("updating");
                    $("div.database span.text").html($.tpLang.antiVirus_nstr.DATABASE_UP_TO_DATE + " " + transformTime(data.timestampLastChecked));
                }
                if (callback) {
                    callback(data);
                }
            }
            // $.exe(function(ret) {
            //     if (ret) {
            //         return;
            //     } else {
            //         var data = $.extend({}, secHistoryObj, secEnableObj);
            //         protectedDays = data.daysUsed;
            //         $("div.protect-days span.digit").html(data.daysUsed);
            //         if (data.daysUsed == 1) {
            //             $("div.protect-days span.days").html($.tpLang.antiVirus_nstr.DAY);
            //         } else {
            //             $("div.protect-days span.days").html($.tpLang.antiVirus_nstr.DAYS);
            //         }
            //         if (data.isUpdating == 1) {
            //             $("div.database").addClass("updating");
            //             $("div.database span.text").html($.tpLang.antiVirus_nstr.DATABASE_UPDATING);
            //             $.timeout(function(){
            //                 getEnable(updateStatus);
            //             },5000);
            //         } else {
            //             $("div.database").removeClass("updating");
            //             $("div.database span.text").html($.tpLang.antiVirus_nstr.DATABASE_UP_TO_DATE + " " + transformTime(data.timestampLastChecked));
            //         }
            //         if (callback) {
            //             callback(data);
            //         }
            //     }
            // });
        }

        function writeEnable(obj, callback) {
            $.addLoading();
            $.act(ACT_SET, TM_SECURITY, null, null, obj);
            $.exe(function(ret) {
                if (ret) {
                    return;
                } else {
                    if (callback) {
                        callback();
                    }
                }
                $.removeLoading();
            });
        }

        $("div.history span.text").html($.tpLang.antiVirus_nstr.HISTORY);

        var getShieldStatus = function(data) {
            if (data.malicious_sites_blocking == "0" || data.intrusion_prevention_system == "0" || data.infected_device_quarantine == "0") {
                return 0;
            } else {
                return 1;
            }
        };

        var changeShieldStatus = function(status) {
            if (status == 1) {
                $("div.shield-wrapper").removeClass("dangerous");
                if (protectedDays == 1) {
                    $("div.protect-days span.days").html($.tpLang.antiVirus_nstr.DAY);
                } else {
                    $("div.protect-days span.days").html($.tpLang.antiVirus_nstr.DAYS);
                }
                $("div.shield-detail span.caption").html($.tpLang.antiVirus_nstr.CAPTION);
                $("#enable-btn-ctn").addClass("nd");
            } else if (status == 0) {
                $("div.shield-wrapper").addClass("dangerous");
                $("div.protect-days span.days").html($.tpLang.antiVirus_nstr.DANGEROUS);
                $("div.shield-detail span.caption").html($.tpLang.antiVirus_nstr.DANGEROUS_CAPTION);
                $("#enable-btn-ctn").removeClass("nd");
            }
        };
        changeShieldStatus(0);

        $("#start-security").click(function(e) {
            writeEnable({
                malicious_sites_blocking: "1",
                intrusion_prevention_system: "1",
                infected_device_quarantine: "1"
            }, function() {
                var enableObj = $.act(ACT_GET, TM_SECURITY, null, null, null);
                $.exe(function(ret) {
                    updateStatus(enableObj);
                });
            });
        });

        $("div#alert-notification-msg").tpModal({
            className: "cloud-security msg-container",
            confirmBtn: null,
            cancelBtn: null
        });

        var getCategory = function(id) {
            for (var i = 0; i < categoryList.length; i++) {
                if (categoryList[i].id == id) {
                    return categoryList[i].name;
                }
            }
            return undefined;
        };

        var getRule = function(id) {
            for (var i = 0; i < ruleList.length; i++) {
                if (ruleList[i].id == id) {
                    return ruleList[i].name;
                }
            }
            return undefined;
        };

        var parseFormat = function(value, width) {
            var value = value.toString();
            while (value.length < width) value = "0" + value;
            return value;
        }

        function transformTime(time) {
            var d = new Date(time * 1000);
            var currentDate = new Date();

            if (d.getFullYear()== currentDate.getFullYear() && d.getMonth() == currentDate.getMonth() && d.getDate() == currentDate.getDate()) {
                if (d.getHours() <= 12) {
                    var date = $.tpLang.antiVirus_nstr.TODAY + ", " + parseFormat(d.getHours(), 2) + ":" + parseFormat(d.getMinutes(), 2) + $.tpLang.antiVirus_nstr.AM;
                } else {
                    var date = $.tpLang.antiVirus_nstr.TODAY + ", " + parseFormat((d.getHours() - 12), 2) + ":" + parseFormat(d.getMinutes(), 2) + $.tpLang.antiVirus_nstr.PM;
                }
            } else if (d.getFullYear()== currentDate.getFullYear() && d.getMonth() == currentDate.getMonth() && d.getDate() == currentDate.getDate() - 1) {
                if (d.getHours() <= 12) {
                    var date = $.tpLang.antiVirus_nstr.YESTERDAY + ", " + parseFormat(d.getHours(), 2) + ":" + parseFormat(d.getMinutes(), 2) + $.tpLang.antiVirus_nstr.AM;
                } else {
                    var date = $.tpLang.antiVirus_nstr.YESTERDAY + ", " + parseFormat((d.getHours() - 12), 2) + ":" + parseFormat(d.getMinutes(), 2) + $.tpLang.antiVirus_nstr.PM;
                }
            } else {
                if (d.getHours() <= 12) {
                    var date = parseFormat((d.getMonth() + 1), 2) + "." + parseFormat(d.getDate(), 2) + ", " + parseFormat(d.getHours(), 2) + ":" + parseFormat(d.getMinutes(), 2) + $.tpLang.antiVirus_nstr.AM;
                } else {
                    var date = parseFormat((d.getMonth() + 1), 2) + "." + parseFormat(d.getDate(), 2) + ", " + parseFormat((d.getHours() - 12), 2) + ":" + parseFormat(d.getMinutes(), 2) + $.tpLang.antiVirus_nstr.PM;
                }
            }
            return date;
        };

        var setAlertInfo = function(data) {
            var noRecord = "";
            if (data.length == 0 || !$.isArray(data)) {
                noRecord = "no-record";
                $("div#alert-notification-msg a.delete-btn").addClass("disabled");
            } else {
                $("div#alert-notification-msg a.delete-btn").removeClass("disabled");
            }
            var inHTML = "<div class=\"alert-info-item-wrapper " + noRecord + "\">";
            inHTML += "<div class=\"no-record-wrapper\">";
            inHTML += "<span class=\"icon\"></span>";
            inHTML += "<span class=\"no-record-text\">" + $.tpLang.antiVirus_nstr.NO_ALERTS + "</span>";
            inHTML += "</div>";
            for (var i = 0; i < data.length; i++) {
                switch (data[i].type) {
                    case "block":
                        inHTML += "<div class=\"alert-info-item alert-site-block\">";
                        inHTML += "<span class=\"icon\"></span>";
                        inHTML += "<div class=\"info-detail\">";
                        inHTML += "<span class=\"device-name\">" + data[i].clientName + "</span>";
                        inHTML += "<span class=\"time\">" + transformTime(data[i].timestamp) + "</span>";
                        inHTML += "<span class=\"device-owner\">" + $.tpLang.antiVirus_nstr.DEVICE_OWNER + ": " + data[i].ownerName + "</span>";
                        inHTML += "<span>" + $.tpLang.antiVirus_nstr.INTERCEPT_WEB_SITE + ": " + data[i].remote + "</span>";
                        inHTML += "<span>" + $.tpLang.antiVirus_nstr.INTERCEPT_REASONS + ": " + getCategory(data[i].ruleId) + "</span>";
                        inHTML += "</div>";
                        inHTML += "</div>";
                        break;
                    case "prevent":
                        inHTML += "<div class=\"alert-info-item alert-intrusion-prevent\">";
                        inHTML += "<span class=\"icon\"></span>";
                        inHTML += "<div class=\"info-detail\">";
                        inHTML += "<span class=\"device-name\">" + data[i].clientName + "</span>";
                        inHTML += "<span class=\"time\">" + transformTime(data[i].timestamp) + "</span>";
                        inHTML += "<span class=\"device-owner\">" + $.tpLang.antiVirus_nstr.DEVICE_OWNER + ": " + data[i].ownerName + "</span>";
                        inHTML += "<span>" + $.tpLang.antiVirus_nstr.ATTACK_SOURCE_IP + ": " + data[i].remote + "</span>";
                        inHTML += "<span>" + $.tpLang.antiVirus_nstr.ATTACK_CATEGORIES + ": " + getRule(data[i].ruleId) + "</span>";
                        inHTML += "</div>";
                        inHTML += "</div>";
                        break;
                    case "infected_block":
                        inHTML += "<div class=\"alert-info-item alert-device-block\">";
                        inHTML += "<span class=\"icon\"></span>";
                        inHTML += "<div class=\"info-detail\">";
                        inHTML += "<span class=\"device-name\">" + data[i].clientName + "</span>";
                        inHTML += "<span class=\"time\">" + transformTime(data[i].timestamp) + "</span>";
                        inHTML += "<span class=\"device-owner\">" + $.tpLang.antiVirus_nstr.DEVICE_OWNER + ": " + data[i].ownerName + "</span>";
                        inHTML += "<span>" + $.tpLang.antiVirus_nstr.INTERCEPTING_IP_ADDRESS + ": " + data[i].remote + "</span>";
                        inHTML += "<span>" + $.tpLang.antiVirus_nstr.INTERCEP_REASONS + ": " + (getCategory(data[i].ruleId) || getRule(data[i].ruleId)) + "</span>";
                        inHTML += "</div>";
                        inHTML += "</div>";
                        break;
                    default:
                        break;
                }
            }
            inHTML += "</div>";
            $("div#alert-notification-msg div.content").html(inHTML);
        }


        var inHTML = "<span class=\"msg-title\"></span>";
        inHTML += "<a href=\"javascript:void(0);\" class=\"delete-btn\">";
        inHTML += "<span class=\"icon\"></span>";
        inHTML += "<span class=\"text\"></span>";
        inHTML += "</a>";

        $("div#alert-notification-msg div.title").html(inHTML);

        function getAlertInfo() {
            var historyList = $.act(ACT_GL, SEC_HISTORIES_LIST, null, null, null);
            $.exe(function(ret) {
                if (ret) {
                    return;
                } else {
                    setAlertInfo(historyList);
                }
            });
        }
        getAlertInfo();

        $("div#alert-notification-msg div.title span.msg-title").html($.tpLang.antiVirus_nstr.ALERT_NOTIFICATION);
        $("div#alert-notification-msg div.title a.delete-btn span.text").html($.tpLang.antiVirus_nstr.CLEAR_ALL);

        $("div.history").on("click", function(e) {
            $("div#alert-notification-msg").tpModal("show");
        });

        // $("span#clear-history-msg-text").html($.tpLang.antiVirus_nstr.ALERT_NOTIFICATION_CAPTION);

        $("a.delete-btn").on("click", function(e) {
            if (!$("div#alert-notification-msg a.delete-btn").hasClass("disabled")) {
                $.confirm($.tpLang.antiVirus_nstr.ALERT_NOTIFICATION_CAPTION, function() {
                    $.act(ACT_SET, SEC_HISTORY, null, null, {
                        "delId": "-1"
                    });
                    $.exe(function(ret) {
                        if (ret) {
                            return;
                        } else {
                            getAlertInfo();
                        }
                    });
                }, function() {

                });
            }
        });

        $("div.site-block div.function span.title").html($.tpLang.antiVirus_nstr.MALICIOUS_SITES_BLOCKING);
        $("div.site-block div.function span.text").html($.tpLang.antiVirus_nstr.MALICIOUS_SITE_BLOCKING_CAPTION);
        $("div.intrusion-prevent div.function span.title").html($.tpLang.antiVirus_nstr.INTRUSION_PREVENTION_SYSTEM);
        $("div.intrusion-prevent div.function span.text").html($.tpLang.antiVirus_nstr.INTRUSION_PREVENTION_SYSTEM_CAPTION);
        $("div.device-block div.function span.title").html($.tpLang.antiVirus_nstr.INFECTED_DEVICE_QUARANTINE);
        $("div.device-block div.function span.text").html($.tpLang.antiVirus_nstr.INFECTED_DEVICE_QUARANTINE_CAPTION);


        $("#site-block-on").click(function(e) {
            changeStatus("malicious_sites_blocking", "1");
        });
        $("#site-block-off").click(function(e) {
            changeStatus("malicious_sites_blocking", "0");
        });
        $("#intrusion-prevent-on").click(function(e) {
            changeStatus("intrusion_prevention_system", "1");
        });
        $("#intrusion-prevent-off").click(function(e) {
            changeStatus("intrusion_prevention_system", "0");
        });
        $("#device-block-on").click(function(e) {
            changeStatus("infected_device_quarantine", "1");
        });
        $("#device-block-off").click(function(e) {
            changeStatus("infected_device_quarantine", "0");
        });

        function changeStatus(key, value) {
            var obj = {};
            obj[key] = value;
            $.addLoading();
            $.act(ACT_SET, TM_SECURITY, null, null, obj);
            $.exe(function(ret) {
                if (ret) {
                    return;
                } else {
                    var status = $.act(ACT_GET, TM_SECURITY, null, null, null);
                    $.exe(function(ret) {
                        if (ret) {
                            return;
                        }
                        updateStatus(status);
                        $.removeLoading();
                    });

                }
            });
        }

        function updateStatus(data) {
            if (getShieldStatus(data) == 0) {
                changeShieldStatus(0);
            } else {
                changeShieldStatus(1);
            }
            if (data.malicious_sites_blocking == "0") {
                $("#site-block-off").addClass("selected");
                $("#site-block-on").removeClass("selected");
            } else {
                $("#site-block-off").removeClass("selected");
                $("#site-block-on").addClass("selected");
            }
            if (data.intrusion_prevention_system == "0") {
                $("#intrusion-prevent-off").addClass("selected");
                $("#intrusion-prevent-on").removeClass("selected");
            } else {
                $("#intrusion-prevent-on").addClass("selected");
                $("#intrusion-prevent-off").removeClass("selected");
            }
            if (data.infected_device_quarantine == "0") {
                $("#device-block-off").addClass("selected");
                $("#device-block-on").removeClass("selected");
            } else {
                $("#device-block-on").addClass("selected");
                $("#device-block-off").removeClass("selected");
            }
            $(".button-group-container").tpBtnGroup();
        }

        function init() {
            getEnable(updateStatus);
            getRuleList();
            getCatagoryList();
        }
        $.tpInit(init);
    });
    </script>
</body>

</html>
