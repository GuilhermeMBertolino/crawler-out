<div>
    <div id="page-one">
        <div id="titleOne" class="titleBar">
            <a id="back" url="bandwidth.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a>
            <h1>
                <script type="text/html" class="title-string">
                    <%=$.tpLang.trafficCtrl_nstr.t_rule%>
                </script>
            </h1>
            <a id="edit" data-status="edit">Edit</a>
        </div>

        <ul id="tcTable" class="link-list device-list mt15">
        </ul>

        <div id="noRule" class="no-item nd">
            <div class="sprite grid-no-rule"></div>
            <span class="text-no-item">
                <script type="text/html" class="title-string">
                    <%=$.tpLang.trafficCtrl_nstr.noRule%>
                </script>
            </span>
            <input type="button" class="button-mobile add-button mt10" id="addRule" value="Add Rule" />
        </div>

        <div class="botP-toolBar">
        </div>
    </div>

    <div id="page-two" class="item-list mt15">
        <div class="section-container">
            <div class="section-box">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.trafficCtrl_nstr.t_iprange%>
                    </script>
                </span>
            </div>
            <div class="section-box">
                <div class="inputBox-mobile-following-div flexible-box">
                    <div class="inputBox-mobile-following fixed-part input-addrpool"><span>
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.m_str.from%>
                        </script>
                    </span>
                    </div>
                    <input id="ipStart" class="inputBox-mobile grow-part" type="text" />
                </div>
            </div>
            <div class="section-box">
                <div class="inputBox-mobile-following-div flexible-box">
                    <div class="inputBox-mobile-following fixed-part input-addrpool"><span>
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.m_str.to%>
                        </script>
                    </span>
                    </div>
                    <input id="ipEnd" class="inputBox-mobile grow-part" type="text" />
                </div>
            </div>
            <div class="section-box">
                <label class="section-labelTitle">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.trafficCtrl_nstr.t_portrange%>
                    </script>
                </label>
                <div class="flexible-box">
                    <input class="grow-part" id="portStart" type="text" maxlength="5" />
                    <span class="fixed-part spanBetween"></span>
                    <input class="grow-part" id="portEnd" type="text" maxlength="5" />
                </div>
            </div>
            <div class="section-box">
                <label class="section-labelTitle">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.s_str.proto%>
                    </script>
                </label>
                <select id="protocol">
                    <option value="0">
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.s_str.all%>
                        </script>
                    </option>
                    <option value="6">TCP</option>
                    <option value="17">UDP</option>
                </select>
            </div>
            <div class="section-box">
                <label class="section-labelTitle">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.trafficCtrl_nstr.t_prio%>
                    </script>
                </label>
                <select id="precedence">
                    <option id="prec0" value="1">1</option>
                    <option id="prec1" value="2">2</option>
                    <option id="prec2" value="3">3</option>
                    <option id="prec3" value="4">4</option>
                    <option id="prec4" value="5" selected>5</option>
                    <option id="prec5" value="6">6</option>
                    <option id="prec6" value="7">7</option>
                    <option id="prec7" value="8">8</option>
                </select>
            </div>
            <div class="section-tips">
                <span>
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.trafficCtrl_nstr.t_prioNote%>
                    </script>
                </span>
            </div>
            <div class="section-box">
                <label class="section-labelTitle">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.wlGuestDulBandAdv_nstr.t_tcup%>
                    </script>
                </label>
                <div class="flexible-box">
                    <input class="grow-part" id="upMinBW" type="text" maxlength="6" />
                    <span class="fixed-part toBetween">
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.trafficCtrl_nstr.c_to%>
                        </script>
                    </span>
                    <input class="grow-part" id="upMaxBW" type="text" maxlength="6" />
                </div>
            </div>
            <div class="section-box">
                <label class="section-labelTitle">
                    <script type="text/html" class="title-string">
                        <%=$.tpLang.wlGuestDulBandAdv_nstr.t_tcdown%>
                    </script>
                </label>
                <div class="flexible-box">
                    <input class="grow-part" id="downMinBW" type="text" maxlength="6" />
                    <span class="fixed-part toBetween">
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.trafficCtrl_nstr.c_to%>
                        </script>
                    </span>
                    <input class="grow-part" id="downMaxBW" type="text" maxlength="6" />
                </div>
            </div>
            <div class="section-box single">
                <div>
                    <span>
                        <script type="text/html" class="title-string">
                            <%=$.tpLang.trafficCtrl_nstr.c_enable%>
                        </script>
                    </span>
                </div>
                <input type="checkbox" id="tc_en" />
            </div>
        </div>
    </div>
</div>

<style type="text/css">
#tcTable .swipe-li-div-parent+li>.section-container {
    padding: 0 2rem 0 5.27rem;
}
.spanBetween {
    width: 2rem;
    display: table-cell;
    height: 33px;
    box-sizing: border-box;
    border-color: #fff;
    border-width: 1.22rem 0.4rem;
    border-style: solid;
    background-color: #dbdbdb;
}
.toBetween {
    width: 30px;
    text-align: center;
    color: #888;
}
.input-addrpool {
    width: 63px;
}
</style>

<script type="text/javascript">
(function() {
    $('.botP-toolBar').toolBar();
    $.tpLocal('title-string', $.tpLang);

    var tcEntry;
    var tcRuleList;
    var guestnetObj, guestnetObj5g;

    var upstreamCurrRate;
    var downstreamCurrRate;
    var wanDslStatus;

    var tcRuleEntryIndex;
    var ewanEnable = true; /* for ac3150 */
    var first = 1;
    var addOrModify;

    var titleOne = '<div id="titleOne" class="titleBar"><a id="back" url="bandwidth.mobile.htm"><span class="icon-back sprite c-arrow-blue-left"></span></a><h1>' + $.tpLang.trafficCtrl_nstr.t_rule + '</h1><a id="edit" data-status="edit">' + $.tpLang.m_str.edit + '</a></div>';

    var titleTwo = '<div id="titleTwo" class="titleBar"><a id="back2" url=""><span class="icon-back sprite c-arrow-blue-left"></span></a><h1>' + $.tpLang.m_str.add + '</h1><a id="save" data-status="save">' + $.tpLang.m_str.save + '</a></div>';

    $('#addRule').buttonMobile({
        'text': $.tpLang.trafficCtrl_nstr.addRule
    });

    // $('input[type="text"]').inputBoxMobile();
    $('#protocol').selectMobile();
    $('#precedence').selectMobile();
    $('#tc_en').flipSwitch({
        'hasTitle': true,
        'on': true
    });

    $('.botP-toolBar').on('click', '#tb-add', function() {
        addOrModify = 'add';
        loadPageTwo();
    });

    $('#addRule').buttonMobile({
        'text': $.tpLang.trafficCtrl_nstr.addRule
    }).on('click.buttonMobile', function() {
        shareTabStatus = 'add';
        loadPageTwo();
    });

    $('#ipStart').inputBoxMobile({
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                if (($('#ipStart').val() != '') && ($.ifip($('#ipStart').val(), true))) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_IP_FORMAT]
        }]
    });

    $('#ipEnd').inputBoxMobile({
        'ipOrMac': 'ip',
        'warnings': [{
            func: function() {
                if (($('#ipEnd').val() != '') && ($.ifip($('#ipEnd').val(), true))) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_IP_FORMAT]
        }]
    });

    $('#portStart').inputBoxMobile({
        'warnings': [{
            func: function() {
                if (($('#portStart').val() != '') && (!$.isnum($('#portStart').val())) || (parseInt($('#portStart').val(), 10) == 0) || (parseInt($('#portStart').val(), 10) > 65535)) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_PORT_NUM_INVAD]
        }]
    });

    $('#portEnd').inputBoxMobile({
        'warnings': [{
            func: function() {
                if (($('#portEnd').val() != '') && (!$.isnum($('#portEnd').val())) || (parseInt($('#portEnd').val(), 10) == 0) || (parseInt($('#portEnd').val(), 10) > 65535)) {
                    return false;
                } else {
                    return true;
                }
            },
            text: e_str[ERR_PORT_NUM_INVAD]
        }, {
            func: function() {
                if (($('#portEnd').val() != '') && ($('#portStart').val() != '') && (parseInt($('#portEnd').val(), 10) < parseInt($('#portStart').val(), 10))) {
                    return e_str[ERR_PORT_ORDER_INVAD];
                } else if ('' == $('#portStart').val() && '' != $('#portEnd').val()) {
                    return e_str[ERR_EMPTY_START_PORT];
                }
                return true;
            }
        }]
    });

    $('#upMinBW, #upMaxBW, #downMinBW, #downMaxBW').inputBoxMobile({
        'warnings': [{
            func: function() {
                if (!INCLUDE_QOS) {
                    if (this.val() == '') {
                        return false;
                    }
                }
                return true;
            },
            text: e_str[ERR_TC_NUM_INVAD]
        }, {
            func: function() {
                if ((this.val() == '') || (!$.isnum(this.val())) || (0 == parseInt(this.val(), 10))) {
                    return false;
                }
                return true;
            },
            text: e_str[ERR_TC_NUM_INVAD]
        }]
    });

    (function init() {
        loadPageOne();
        tcRuleList = $.act(ACT_GL, TC_RULE, null, null);
        tcEntry = $.act(ACT_GET, TC, null, null);

        var wlanObj, wlanObj5g;
        if (INCLUDE_LAN_WLAN_GUESTNETWORK) {
            var basicList = $.act(ACT_GL, LAN_WLAN, null, null, ["X_TP_Band"]);
            if (!$.exe()) {
                $.each(basicList, function() {
                    if ("2.4GHz" == this.X_TP_Band) {
                        wlanObj = this;
                    } else if (INCLUDE_LAN_WLAN_DUALBAND && "5GHz" == this.X_TP_Band) {
                        wlanObj5g = this;
                    }
                });

                guestnetObj = $.act(ACT_GET, LAN_WLAN_GUESTNET, wlanObj.__stack, null, null);
                if (INCLUDE_LAN_WLAN_DUALBAND) {
                    guestnetObj5g = $.act(ACT_GET, LAN_WLAN_GUESTNET, wlanObj5g.__stack, null, null);
                }
            }
        }

        if (!$.exe()) {
            /* for ac3150 */
            //initType();
            // initTc();
            initTcTable();
            if (INCLUDE_LAN_WLAN_GUESTNETWORK) {
                // initTcRuleTableForGN();
            }
        }
    })();

    function initType() {
        var wanComInfList = $.act(ACT_GL, WAN_COMMON_INTF_CFG, null, null, ["WANAccessType"]);
        ewanEnable = false;

        if (!$.exe()) {
            var dslStk;
            var ewanStk;
            $.each(wanComInfList, function() {
                if (this.WANAccessType == "DSL") {
                    dslStk = this.__stack;
                } else if (this.WANAccessType == "Ethernet") {
                    ewanStk = this.__stack;
                }
            });
        }

        var wanDslCfg = $.act(ACT_GET, WAN_DSL_INTF_CFG, dslStk, null, ["status", "upstreamCurrRate", "downstreamCurrRate"]);
        if (!$.exe()) {
            wanDslStatus = wanDslCfg.status;
            if (wanDslCfg.status == "Up") {
                $("#curDslUp").removeClass("nd");
                $("#curDslDown").removeClass("nd");
                $("#upStreamCurrRate").prop("value", wanDslCfg.upstreamCurrRate + " " + $.tpLang.s_str.kbps);
                $("#downStreamCurrRate").prop("value", wanDslCfg.downstreamCurrRate + " " + $.tpLang.s_str.kbps);
            }
        }

        var ewanCfg = $.act(ACT_GET, WAN_ETH_INTF, ewanStk, null, ["enable"]);
        if (!$.exe()) {
            ewanEnable = ewanCfg.enable;
        }

        upstreamCurrRate = wanDslCfg.upstreamCurrRate;
        downstreamCurrRate = wanDslCfg.downstreamCurrRate;
    }

    function loadPageOne() {
        $('#page-one').removeClass('nd');
        $('#page-two').addClass('nd');

        if (first == 1) {
            // $('#titleOne').titleBar();
            $(titleOne).titleBar();
            first = 0;
        } else {
            $(titleOne).titleBar();
        }

        $('#edit').on('click', function() {
            var status = $(this).titleButton('status');
            if (status == 'edit') {
                if ($('#tcTable').hasClass('edit-list')) {
                    $('#tcTable').editList({
                        'listType': 'selectList'
                    });
                }
                $(this).titleButton('status', 'cancel', $.tpLang.m_str.cancel);
                $('.botP-toolBar').toolBar('option', {
                    'hide': false
                });
                $('#addRule').addClass('nd');
            } else if (status == 'cancel') {
                if ($('#tcTable').hasClass('edit-list')) {
                    $('#tcTable').editList({
                        'listType': 'swipeList'
                    });
                }
                $(this).titleButton('status', 'edit', $.tpLang.m_str.edit);
                $('.botP-toolBar').toolBar('option', {
                    'hide': true
                });
                $('#addRule').removeClass('nd');
            }

        });
        if ($('#tcTable').hasClass('edit-list')) {
            $('#tcTable').editList({
                'listType': 'swipeList'
            });
        }
        $('.botP-toolBar').toolBar('hide');

        $('#titleOne').titleBar('title', $.tpLang.trafficCtrl_nstr.t_rule);
        $('#edit').titleButton('status', 'edit', $.tpLang.m_str.edit);

        if ($('#tcTable').find('li').length == 0) {
            $('#noRule').removeClass('nd');
            $('#addRule').removeClass('nd');
        }
        else {
            $('#noRule').addClass('nd');
        }
    }

    function loadPageTwo() {
        $('#page-one').addClass('nd');
        $('#page-two').removeClass('nd');
        $(titleTwo).titleBar();
        if (addOrModify == 'add') {
            $('#titleTwo').titleBar('title', $.tpLang.m_str.add);
        }
        if (addOrModify == 'modify' /* && (argument != '' && argument != undefined)*/ ) {
            $('#titleTwo').titleBar('title', $.tpLang.table_str.modify);
            // modifyShare(argument);
        }
        $('#back2').unbind('click').bind('click', function() {
            loadPageOne();
        });
        $('#save').titleButton('status', 'save', $.tpLang.m_str.save);
        $('#save').on('click', function() {
            doRuleSave();
        });

        if (addOrModify == 'modify') {
            var rule = tcRuleList[tcRuleEntryIndex];
            $('#ipStart').inputBoxMobile('option', 'value', rule.startIP == 0 ? '' : $.num2ip(parseInt(rule.startIP, 10)));
            $('#ipEnd').inputBoxMobile('option', 'value', rule.endIP == 0 ? $('#ipStart').val() : $.num2ip(parseInt(rule.endIP, 10)));
            $('#portStart').val(rule.startPort == 0 ? '' : rule.startPort);
            $('#portEnd').val(rule.endPort == 0 ? '' : rule.endPort);
            $('#protocol').selectMobile('value', rule.protocol);//
            $('#precedence').selectMobile('value', rule.precedence);//
            $('#upMinBW').val(rule.upMinBW == 0 ? '' : rule.upMinBW);
            $('#upMaxBW').val(rule.upMaxBW == 0 ? '' : rule.upMaxBW);
            $('#downMinBW').val(rule.downMinBW == 0 ? '' : rule.downMinBW);
            $('#downMaxBW').val(rule.downMaxBW == 0 ? '' : rule.downMaxBW);
            $('#tc_en').flipSwitch({
                'on': rule.enable == 1 ? true : false
            });
        } else {
            $('input[type="text"]').inputBoxMobile('option', 'value', '');
            $('#protocol').selectMobile('value', 0);//
            $('#precedence').selectMobile('value', 5);//
            $('#tc_en').flipSwitch({
                'on': true
            });
        }
        $('.inputBox-mobile-div>input[type=text]').inputBoxMobile('hideWarnings');
    }

    function initTcTable() {
        var index = 0;
        var des = "";
        var count = 0;

        $.each(tcRuleList, function() {
            if (this.ruleType == 0) {
                var tmpIP = "";
                if ((this.startIP == 0) && (this.endIP == 0))
                    tmpIP = "";
                else if ((this.startIP == 0) && (this.endIP != 0))
                    tmpIP = $.num2ip(parseInt(this.endIP, 10));
                else if ((this.startIP != 0) && (this.endIP == 0))
                    tmpIP = $.num2ip(parseInt(this.startIP, 10));
                else if (this.startIP == this.endIP)
                    tmpIP = $.num2ip(parseInt(this.startIP, 10));
                else if ((this.startIP != 0) && (this.endIP != 0))
                    tmpIP = $.num2ip(parseInt(this.startIP, 10)) + "-" + $.num2ip(parseInt(this.endIP, 10));


                var tmpPort = "";
                if ((this.startPort == 0) && (this.endPort == 0))
                    tmpPort = "";
                else if ((this.startPort == 0) && (this.endPort != 0))
                    tmpPort = this.endPort;
                else if ((this.startPort != 0) && (this.endPort == 0))
                    tmpPort = this.startPort;
                else if (this.startPort == this.endPort)
                    tmpPort = this.startPort;
                else if ((this.startPort != 0) && (this.endPort != 0))
                    tmpPort = this.startPort + "-" + this.endPort;

                var tmpProtcl = "";
                if (this.protocol == 0)
                    tmpProtcl = $.tpLang.s_str.all;
                else if (this.protocol == 6)
                    tmpProtcl = "TCP";
                else if (this.protocol == 17)
                    tmpProtcl = "UDP";

                if (tmpIP != "") des = tmpIP;
                else if (tmpPort != "") des = tmpPort;
                else if (tmpProtcl != "") des = tmpProtcl;
                /*
                                    "text": (this.enable == 1) ? "<span class='table-grid-icon enable-icon' onClick='disableTcClk(" + index + ")'></span>" : "<span class='table-grid-icon disable-icon' onClick='enableTcClk(" + index + ")'></span>",
                                    "width": "10%"
                                }, {
                                    "text": "<span class='table-grid-icon edit-modify-icon' onClick='doTcEdit(" + index + ")'></span><span class='table-grid-icon edit-trash-icon' id='del_" + index + "' onclick='doTcDel(" + index + ");'></span>",
                                    "width": "10%"
                                }]);*/

                var upbw = (this.upMinBW == 0 ? "" : this.upMinBW) + "/" + (this.upMaxBW == 0 ? "" : this.upMaxBW) + " " + $.tpLang.s_str.kbps;
                var downbw = (this.downMinBW == 0 ? "" : this.downMinBW) + "/" + (this.downMaxBW == 0 ? "" : this.downMaxBW) + " " + $.tpLang.s_str.kbps;

                var newDiv = $('<li><div class="li-content-div" id="_tcTable_' + index + '">' + '<div class="device-div" id="tcTable_' + index + '">' + '<div class="device-label"><span class="sprite grid-row-rule"></span></div>' + '<div class="device-content"><div class="device-line"><div class="device-info">' + '<div class="device-info-item">' + '<span class="device-info-title">' + $.tpLang.table_str.descpt + '</span>' + '<span class="device-info-text">' + des + '</span>' + '</div><div class="device-info-item">' + '<span class="device-info-title">' + $.tpLang.table_str.priority + '</span>' + '<span class="device-info-text">' + this.precedence + '</span>' + '</div><div class="device-info-item">' + '<span class="device-info-title">' + $.tpLang.table_str.upbw + ':' + '</span>' + '<span class="device-info-text">' + upbw + '</span>' + '</div><div class="device-info-item">' + '<span class="device-info-title">' + $.tpLang.table_str.downbw + ':' + '</span>' + '<span class="device-info-text">' + downbw + '</span>' + '</div>' + '</div><div class="op"><span class="sprite c-arrow-gray-right floatRight"></span></div></div></div>' + '</div></div>' + '</li>');
                newDiv.appendTo($('#tcTable'));
                if (count > 0) {
                    // newDiv.css('margin-top', '15px');
                }
                var enableDiv = $('<li class="mtNo"><div class="section-container mtNo" ><div class="section-box">' + '<div>Operation:</div>' + '<input id="en_tcTable_' + index + '" type="checkbox" /></div></div></li>');
                enableDiv.appendTo($('#tcTable'));
                $('#en_tcTable_' + index).flipSwitch({
                    'hasTitle': true,
                    'title': $.tpLang.s_str.operation + ':',
                    'on': (this.enable == 1)
                }).bind('on.flipSwitch', function() {
                    var thisIndex = this.id.replace('en_tcTable_', '');
                    enableTcClk(thisIndex);
                }).bind('off.flipSwitch', function() {
                    var thisIndex = this.id.replace('en_tcTable_', '');
                    disableTcClk(thisIndex);
                })

                $.addDeviceBlock($('#tcTable_' + index));
                count++;
            }

            index++;
        });
        $('#tcTable').editList();
        var allTargets = $('#tcTable').find('.li-content-div');
        $.each(allTargets, function() {
            $(this).bind('delete.editlist', function() {
                doTcDel((this.id).replace('_tcTable_', ''));
            }).bind('click', function() {
                addOrModify = 'modify';
                tcRuleEntryIndex = (this.id).replace('_tcTable_', '');
                loadPageTwo((this.id).replace('_tcTable_', ''));
            })
        });
        if ($('#tcTable').find('.li-content-div').length == 0) {
            $('#noRule').removeClass('nd');
            $('#tcTable').addClass('nd');
        } else {
            $('#noRule').addClass('nd');
            $('#tcTable').removeClass('nd');
        }
    }

    function doTcDel(index) {
        $.act(ACT_DEL, TC_RULE, tcRuleList[index].__stack, null);
        $.exe(function(err) {
            if (!err) $.reload();
        });
    }

    function enableTcClk(index) {
        $.act(ACT_SET, TC_RULE, tcRuleList[index].__stack, null, ['enable=1']);
        if (!$.exe()) {
            $.reload();
        }
    }

    function disableTcClk(index) {
        $.act(ACT_SET, TC_RULE, tcRuleList[index].__stack, null, ['enable=0']);
        if (!$.exe()) {
            $.reload();
        }
    }

    function checkBW(idMin, idMax) {

        if (idMin.val() == '' && idMax.val() == '')
            return true;

        // if ((idMin.val() == '') || (!$.isnum(idMin.val())) || (0 == parseInt(idMin.val(), 10))) {
        //     $.alert(ERR_TC_NUM_INVAD);
        //     selectObj(idMin);
        //     return false;
        // }

        // if ((idMax.val() == '') || (!$.isnum(idMax.val())) || (0 == parseInt(idMax.val(), 10))) {
        //     $.alert(ERR_TC_NUM_INVAD);
        //     selectObj(idMax);
        //     return false;
        // }

        if (parseInt(idMax.val(), 10) < parseInt(idMin.val(), 10)) {
            $.alert(ERR_TC_BW_ORDER_INVAD);
            idMax.focus();
            return false;
        }
        return true;
    }


    function doRuleSave() {

        if (!$.checkAllInput()) return false;

        if (($('#ipStart').val() == '') && ($('#ipEnd').val() == '') && ($('#portStart').val() == '') && ($('#portEnd').val() == '')) {
            $.alert(ERR_TC_IP_PORT_INVAD);
            $('#ipStart').focus();
            return false;
        }

        if (!checkBW($('#upMinBW'), $('#upMaxBW')))
            return false;
        if (!checkBW($('#downMinBW'), $('#downMaxBW')))
            return false;
        if ($('#upMinBW').val() == '' && $('#downMinBW').val() == '') {
            $.alert(ERR_TC_BW_NULL);
            $('#upMinBW').focus();
            return false;
        }

        var tmpArg = {};

        tmpArg.startIP = ($('#ipStart').val() == '') ? 0 : ($.ip2num($('#ipStart').val()));
        tmpArg.endIP = ($('#ipEnd').val() == '') ? tmpArg.startIP : ($.ip2num($('#ipEnd').val()));

        if (($('#ipEnd').val() != '') && ($('#ipStart').val() != '') && (!$.isOrderIp($('#ipStart').val(), $('#ipEnd').val()))) {
            $.alert(ERR_TC_IP_ORDER_INVAD);
            $('#ipStart').focus();
            return false;
        } else if ('' == $('#ipStart').val() && '' != $('#ipEnd').val()) {
            $.alert(ERR_TC_EMPTY_START_IP);
            $('#ipStart').focus();
            return false;
        }

        tmpArg.startPort = ($('#portStart').val() == '') ? 0 : parseInt($('#portStart').val(), 10);
        tmpArg.endPort = ($('#portEnd').val() == '') ? tmpArg.startPort : parseInt($('#portEnd').val(), 10);

        tmpArg.protocol = $('#protocol').selectMobile('value');
        tmpArg.precedence = $('#precedence').selectMobile('value');

        tmpArg.upMinBW = ($('#upMinBW').val() == '') ? 0 : parseInt($('#upMinBW').val(), 10);
        tmpArg.upMaxBW = ($('#upMaxBW').val() == '') ? 0 : parseInt($('#upMaxBW').val(), 10);

        tmpArg.downMinBW = ($('#downMinBW').val() == '') ? 0 : parseInt($('#downMinBW').val(), 10);
        tmpArg.downMaxBW = ($('#downMaxBW').val() == '') ? 0 : parseInt($('#downMaxBW').val(), 10);

        tmpArg.enable = ($('#tc_en').flipSwitch('option', 'on') == true) ? 1 : 0;
        tmpArg.flag = 1;


        if (addOrModify == 'modify') {
            var tmpStack = tcRuleList[tcRuleEntryIndex].__stack;
            $.act(ACT_SET, TC_RULE, tmpStack, null, tmpArg);
        } else {
            $.act(ACT_ADD, TC_RULE, null, null, tmpArg);
        }

        $.startWaitingMobile($.tpLang.m_str.waiting);
        if (!$.exe()) {
            $.stopWaitingMobile();
            $.reload();
        }
    }
})();
</script>
