jQuery.su.moduleManager.define("lanAdv",{services:["moduleLoader","moduleManager","ajax","device"],models:["lanAdvLanModel","lanAdvLinkAggModel"],deps:["main"],views:["lanAdvView"],listeners:{ev_on_launch:function(e,n,a,l,t,o,i){this.hasLinkAgg()&&i.moduleLoader.load({module:"lanAdv"},{module:"lanAdvLinkAgg"},a.lanAdvView.lanAdvLinkAggLoader),i.moduleLoader.load({module:"lanAdv"},{module:"lanAdvLan"},a.lanAdvView.lanAdvLanLoader)}},init:function(e,g,u,n,a,v){this.control({".index-common-save-btn":{ev_will_auto_save:function(e,n){n.preventDefault();var a,l=0,n=u.lanAdvLinkAggModel.enableAgg.getValue(),t=u.lanAdvLinkAggModel.ports.getValue();for(a in t)t[a]&&l++;var o,i=u.lanAdvLanModel.isDirty(),d=u.lanAdvLinkAggModel.isDirty(),s=u.lanAdvLanModel.ipaddr.isDirty(),r=v.moduleManager.get("lanAdvLan");u.lanAdvLanModel.validate()&&("1"==n&&l<2?g.lanAdvView.lanSelectTwoMsg.show():!i&&d?v.device.getConfig().supportLanAggCfg?u.lanAdvLinkAggModel.submit():g.lanAdvView.lanAdvRebootMsg.show():i&&!d?r.lanValidate()&&(s?g.lanAdvView.lanIpChangeMsg.show():(o=this,g.lanAdvView.lanAdvRebootAnimate.show(),u.lanAdvLanModel.submit({success:function(){setTimeout(function(){g.lanAdvView.lanAdvRebootAnimate.close(function(){o.goToNewUrl()})},4e4)},fail:function(){g.lanAdvView.lanAdvRebootAnimate.close()},error:function(){g.lanAdvView.lanAdvRebootAnimate.close()}}))):r.lanValidate()&&g.lanAdvView.lanAdvIPRebootMsg.show())}},"#lan-ip-change .btn-msg-ok":{ev_button_click:function(){var e=this;g.lanAdvView.lanAdvRebootAnimate.show(),u.lanAdvLanModel.submit({success:function(){setTimeout(function(){g.lanAdvView.lanAdvRebootAnimate.close(function(){e.goToNewUrl()})},4e4)},fail:function(){g.lanAdvView.lanAdvRebootAnimate.close()},error:function(){g.lanAdvView.lanAdvRebootAnimate.close()}})}},"#lan-reboot .btn-msg-ok":{ev_button_click:function(){u.lanAdvLinkAggModel.submit({success:function(){v.ajax.request({proxy:"rebootProxy",success:function(e){e=e.rebootTime?1e3*e.rebootTime:75e3;a.main.startReboot(e)}})}})}},"#lan-IPreboot .btn-msg-ok":{ev_button_click:function(){var n=this;u.lanAdvLinkAggModel.submit(),u.lanAdvLanModel.submit({success:function(){v.ajax.request({proxy:"rebootProxy",success:function(e){e=e.rebootTime?1e3*e.rebootTime:75e3;a.main.startReboot(e,function(){n.goToNewUrl()})}})}})}}})}},function(e,n,a,l,t,o){return{hasLinkAgg:function(){return o.device.getLanAgg()},goToNewUrl:function(e){location.href="http://tplinkwifi.net"}}}),function(d){d.su.moduleManager.define("lanAdvLan",{deps:["utils"],models:["lanAdvLanModel","lanAdvWanModel"],stores:["lanAdvSubnetCombo"],views:["lanAdvLanView"],listeners:{ev_on_launch:function(e,a,n,l,t,o,i){l.lanAdvLanModel.load({success:function(){a.ipValOrigin=l.lanAdvLanModel.ipaddr.getValue()}}),l.lanAdvWanModel.load({success:function(){a.wanIP=l.lanAdvWanModel.wanIpv4Ipaddr.getValue(),a.wanMask=l.lanAdvWanModel.wanIpv4Netmask.getValue(),a.connType=l.lanAdvWanModel.wanIpv4Conntype.getValue();var e=l.lanAdvWanModel.wanIpv4SndIpaddr.getValue(),n=l.lanAdvWanModel.wanIpv4SndNetmask.getValue();a.wanSndIP=null!=e?e:0,a.wanSndMask=null!=n?n:0}})}},init:function(e,n,l,a,t,o){this.listen({"models.lanAdvLanModel.maskType":{ev_value_change:function(e,n,a){3===n?(l.lanAdvLanModel.customValue.show(),l.lanAdvLanModel.customValue.enable()):(l.lanAdvLanModel.customValue.hide(),l.lanAdvLanModel.customValue.disable())}}}),this.control()}},function(l,e,t,o,i,n){return{lanValidate:function(){var e=t.lanAdvLanModel.ipaddr.getValue(),n=t.lanAdvLanModel.maskType.getValue(),n=(maskStr=3===n?t.lanAdvLanModel.customValue.getValue():o.lanAdvSubnetCombo.getData()[n].name,i.utils.isSameNet(l.wanIP,e,l.wanMask)),a=i.utils.isSameNet(e,l.wanIP,maskStr);return n||a?(t.lanAdvLanModel.ipaddr.setError(d.su.CHAR.ERROR["00000060"]),!1):!i.utils.isNetIpLegal(e,maskStr)||i.utils.isNetIp(e,maskStr)||i.utils.isBroadCastIp(e,maskStr)?(t.lanAdvLanModel.ipaddr.setError(d.su.CHAR.ERROR["00000059"]),!1):"l2tp"!=l.connType&&"pptp"!=l.connType&&"pppoe"!=l.connType||0==l.wanSndIP||0==l.wanSndMask||!i.utils.isSameNet(e,l.wanSndIP,l.wanSndMask)&&!i.utils.isSameNet(l.wanSndIP,e,maskStr)||(t.lanAdvLanModel.ipaddr.setError(d.su.CHAR.ERROR["00000060"]),!1)}}})}(jQuery),function(e){e.su.modelManager.define("lanAdvLanModel",{type:"model",fields:[{name:"macaddr"},{name:"ipaddr",vtype:"ip",allowBlank:!1},{name:"maskType",mapping:"mask_type"},{name:"customValue",mapping:"custom_value",allowBlank:!1,vtype:"netmask",defaultValue:"255.255.255.0"}],convert:function(e){var n={};switch(n.macaddr=e.macaddr,n.ipaddr=e.ipaddr,e.mask_type){case"255.255.255.0":n.mask_type=0;break;case"255.255.0.0":n.mask_type=1;break;case"255.0.0.0":n.mask_type=2;break;default:n.mask_type=3}return n.custom_value=e.custom_value,n.lan_type=e.lan_type,n},serialize:function(e){var n={};switch(n.macaddr=e.macaddr,n.ipaddr=e.ipaddr,e.mask_type){case 0:n.mask_type="255.255.255.0";break;case 1:n.mask_type="255.255.0.0";break;case 2:n.mask_type="255.0.0.0";break;default:n.mask_type="custom"}return n.custom_value=e.custom_value,n.lan_type=e.lan_type,n},proxy:{url:e.su.url("/admin/network?form=lan_ipv4")}}),e.su.modelManager.define("lanAdvWanModel",{type:"model",fields:[{name:"wanIpv4Ipaddr",mapping:"wan_ipv4_ipaddr"},{name:"wanMacaddr",mapping:"wan_macaddr"},{name:"wanIpv4Netmask",mapping:"wan_ipv4_netmask"},{name:"wanIpv4Gateway",mapping:"wan_ipv4_gateway"},{name:"wanIpv4Pridns",mapping:"wan_ipv4_pridns"},{name:"wanIpv4Snddns",mapping:"wan_ipv4_snddns"},{name:"wanIpv4Conntype",mapping:"wan_ipv4_conntype"},{name:"lanIpv4Ipaddr",mapping:"lan_ipv4_ipaddr"},{name:"lanIpv4Netmask",mapping:"lan_ipv4_netmask"},{name:"lanMacaddr",mapping:"lan_macaddr"},{name:"lanIpv4DhcpEnable",mapping:"lan_ipv4_dhcp_enable"},{name:"wanIpv4SndIpaddr",mapping:"wan_ipv4_snd_ipaddr"},{name:"wanIpv4SndNetmask",mapping:"wan_ipv4_snd_netmask"}],proxy:{url:e.su.url("/admin/network?form=status_ipv4")}}),e.su.storeManager.define("lanAdvSubnetCombo",{type:"store",fields:[{name:"name"},{name:"value"},{name:"boxlabel"}],data:[{name:"255.255.255.0",value:0,boxlabel:"255.255.255.0"},{name:"255.255.0.0",value:1,boxlabel:"255.255.0.0"},{name:"255.0.0.0",value:2,boxlabel:"255.0.0.0"},{name:e.su.CHAR.NETWORK_LAN.CUSTOM,value:3,boxlabel:"custom"}]})}(jQuery),function(A){A.su.moduleManager.define("lanAdvLinkAgg",{services:["device"],models:["lanAdvLinkAggModel","iptvVlan"],stores:["lanAdvLinkModeCombo","lanAdvLinkPortsStore"],views:["lanAdvLinkAggView"],listeners:{ev_on_launch:function(e,a,l,t,o,n,i){a.isConfigurable()&&(l.lanAdvLinkAggView.lanAdvLinkAggPanel.setInstruction(A.su.CHAR.NETWORK_LAN.LINK_CONFIG_INSTRUCTION),l.lanAdvLinkAggView.lanAdvLinkAggContent.enable()),a.isLanAggCfgOnlyMode()&&(l.lanAdvLinkAggView.lanAdvLinkAggPanel.setInstruction(A.su.CHAR.NETWORK_LAN.LINK_INSTRUCTION),l.lanAdvLinkAggView.lanAdvLinkAggContent.enable(),t.lanAdvLinkAggModel.ports.hide()),t.lanAdvLinkAggModel.load({success:function(e){var n;t.lanAdvLinkAggModel.enableAgg.enable(),"on"==t.iptvVlan.enable.getValue()&&(t.lanAdvLinkAggModel.enableAgg.disable(),n=A.su.CHAR.NETWORK_LAN.LAN_DISABLE_TIPS.replace("%function%",'<a href="#iptvAdv">'+A.su.CHAR.NETWORK_LAN.IPTV+"</a>"),t.lanAdvLinkAggModel.enableAgg.setTips(n),a.isConfigurable()&&l.lanAdvLinkAggView.lanAdvLinkAggContent.hide()),a.isConfigurable()&&!a.isLanAggCfgOnlyMode()&&(n=a.generatePortOptions(e.port_settings),o.lanAdvLinkPortsStore.loadData(n),n=a.generatePortsData(e.port_settings),t.lanAdvLinkAggModel.ports.setValue(n),t.lanAdvLinkAggModel.record())}})}},init:function(o,i,g,e,n,l){var u,v=[];g.iptvVlan.load({success:function(e){u="on"==e.enable&&!l.device.getLanIptv();for(var n=e.port_settings,a=0;a<n.length;a++)v[a]="Internet"!=n[a].type&&u?1:0}}),this.listen({"models.lanAdvLinkAggModel.enableAgg":{ev_value_change:function(e,n,a){if(o.isConfigurable())if("0"==n)i.lanAdvLinkAggView.lanAdvLinkAggContent.hide();else{i.lanAdvLinkAggView.lanAdvLinkAggContent.show();for(var l=0,t=0;t<v.length;t++)0!=v[t]&&"on"==u&&(g.lanAdvLinkAggModel.ports.disableItem(t),l++);2<l&&(n=A.su.CHAR.NETWORK_LAN.LAN_ADVPORTS_TIPS_1+'<a href="#iptvAdv">'+A.su.CHAR.NETWORK_LAN.IPTV+"</a>"+A.su.CHAR.NETWORK_LAN.LAN_ADVPORTS_TIPS_2,g.lanAdvLinkAggModel.ports.setTips(n))}}},"models.lanAdvLinkAggModel.ports":{ev_value_change:function(e,n,a){for(var l=g.lanAdvLinkAggModel.portSettings.getValue(),t=l.length,o=t,i=0,d=[],s=0;s<t;s++)0!=v[s]&&"on"==u&&o--;o<2?g.lanAdvLinkAggModel.ports.setTips(A.su.CHAR.NETWORK_LAN.LA_PORTS_TIPS):g.lanAdvLinkAggModel.ports.setTips("");for(var r=g.lanAdvLinkAggModel.ports.getValue(),s=0;s<t;s++)r[l[s].name]?(i++,d[s]=1):d[s]=0;if(2<=i)for(s=0;s<t;s++)d[s]||g.lanAdvLinkAggModel.ports.disableItem(s);else for(s=0;s<t;s++)0!=v[s]&&"on"==u||g.lanAdvLinkAggModel.ports.enableItem(s)}}})}},function(e,n,a,l,t,o){return{isConfigurable:function(){return!!o.device.getConfig().supportLanAggCfg},isLanAggCfgOnlyMode:function(){return!!o.device.getConfig().supportLanAggCfgOnlyMode},generatePortOptions:function(e){for(var n=[],a=0;a<e.length;a++)n[a]={name:e[a].name,value:a,boxlabel:o.device.getPortName(e[a].name)};return n},generatePortsData:function(e){for(var n={},a=0;a<e.length;a++)n[e[a].name]=e[a].enable;return n}}})}(jQuery),function(n){n.su.modelManager.define("lanAdvLinkAggModel",{type:"model",fields:[{name:"enableAgg",mapping:"enable_agg",defaultValue:"0"},{name:"lacpmode"},{name:"hashmode"},{name:"portSettings",mapping:"port_settings"},{name:"ports"}],convert:function(e){var n={},e=(n.enable_agg=e.enable_agg,n.lacpmode=e.lacpmode,n.hashmode=e.hashmode,e.port_settings);return n.port_settings=e,n.ports={},n},serialize:function(e){for(var n={},a=(n.enable_agg=e.enable_agg,n.lacpmode=e.lacpmode,n.hashmode=e.hashmode,e.port_settings),l=0;l<a.length;l++)a[l].enable=e.ports[a[l].name];return n.port_settings=JSON.stringify(a),n},proxy:{url:n.su.url("/admin/network?form=lan_agg")}}),n.su.storeManager.define("lanAdvLinkModeCombo",{type:"store",fields:[{name:"name"},{name:"value"},{name:"boxlabel"}],data:[{name:n.su.CHAR.NETWORK_LAN.Static_LAG,value:0,boxlabel:"Static LAG"},{name:n.su.CHAR.NETWORK_LAN.LACP,value:1,boxlabel:"LACP"}]}),n.su.storeManager.define("lanAdvLinkPortsStore",{type:"store",fields:[{name:"name"},{name:"value"},{name:"boxlabel"}],proxy:null}),n.su.define("rebootProxy",{extend:"IPFProxy",url:n.su.url("/admin/system?form=reboot"),preventSuccessEvent:!0,writeFilter:function(e){return n.extend({operation:"write"},e)},readFilter:function(e){return{rebootTime:(e=e.data).reboot_time}}})}(jQuery);