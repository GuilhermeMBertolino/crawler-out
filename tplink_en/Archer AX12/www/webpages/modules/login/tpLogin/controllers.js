!function(l){l.su.moduleManager.define("tpLogin",{services:["moduleManager","ajax","moduleLoader"],views:["tpLoginView"],deps:["main"],models:["tpLoginControl"],listeners:{ev_on_launch:function(e,o,t,n,i,a,r){r.ajax.request({proxy:"keyProxy",success:function(e){e&&e.password&&(o.encryptKey=e.password)}}),t.tpLoginView.adminCheckPanel.hide(),l.su.userInfo={},r.moduleLoader.load({module:"tpLogin",view:"tpLoginView"},{module:"cloudService"},t.tpLoginView.tpCloudLoader,function(){var e=r.moduleManager.get("cloudService");e.setMode("login"),e.init()})}},init:function(e,o,t,n,i,a){this.control({"#login-bind-btn":{ev_button_click:function(){e.doCloudLogin("bind")}},".tp-login-switch-to-local":{click:function(){var e=a.moduleManager.get("login");e&&e.goToChildModule("localLogin")}},"#user-conflict-prompt2":{ev_msg_ok:function(){e.doCloudLogin("login",!0)}}})}},function(n,s,i,e,u,c){n=this;return{encryptKey:"",unLoad:function(){c.moduleLoader.unLoad(s.tpLoginView.tpCloudLoader)},checkAdmin:function(){s.tpLoginView.tpLoginPanel.hide(),l(".tp-login-switch-to-local-container").hide(),s.tpLoginView.adminCheckPanel.show()},doCloudLogin:function(e,o){var t={operation:e,token:l.su.userInfo.token};if("bind"==e){if(!i.tpLoginControl.validate())return;t.password=i.tpLoginControl.password.doEncrypt(n.encryptKey)}o&&(t.confirm=o),n.initEncryptor().then(function(){n.handleLogin(t)})},initEncryptor:function(){var o=l.Deferred();return l.su.encryptor?(c.ajax.requestPromise({proxy:"authProxy"}).then(function(e){l.su.encryptor.setRSAKey(e.key[0],e.key[1]),l.su.encryptor.setSeq(e.seq),l.su.encryptor.genAESKey(),l.su.encryptor.setHash(l.su.userInfo.token),l.encrypt.encryptManager.recordEncryptor(),o.resolve()}).fail(function(){c.moduleManager.get("cloudService").postLoginStatus(),o.reject()}),o.promise()):o.resolve()},handleLogin:function(e){var i=c.moduleManager.get("cloudService");c.ajax.request({proxy:"cloudLoginProxy",data:e,isLogin:!0,success:function(e){var o,t,n=e.stok||(o="12345",n=top.location.href,t=n.indexOf("stok="),o=0<=t?n.substring(t+5):o);i.postLoginStatus(),l.su.userInfo.role=e.role,localStorage&&(u.main.setToken(n),localStorage.setItem("userInfo",l.su.DES3.encrypt(JSON.stringify(l.su.userInfo))),u.main.reload())},fail:n.handleLoginFail,error:i.postLoginStatus})},handleLoginFail:function(e,o){c.moduleManager.get("cloudService").postLoginStatus(),s.tpLoginView.tpLoginBtn.loading(!1);var t=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&t){t=String(e.data.errorcode).replace(/^-/,"E");u.main.showNotice(l.su.CHAR.ERROR[t],1,1e4)}else if(o)switch(o){case"user conflict":s.tpLoginView.userConflictMsgContent2.setText(l.su.CHAR.LOGIN.USER_CONFLICT_MSG),s.tpLoginView.userConflictMsg2.show();break;case"login failed":var n=e.data.failureCount,i=(a=e.data.attemptsAllowed)+n;(0===a?(r=l.su.CHAR.ERROR["00000089"].replace("%num",i),s.tpLoginView.maxAttemptsMsgContent2.setText(r),s.tpLoginView.maxAttemptsMsg2):(a<=n?(r=(r=l.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",n)).replace("%num2",a),s.tpLoginView.leftAttemptsMsgContent2.setText(r)):s.tpLoginView.leftAttemptsMsgContent2.setText(l.su.CHAR.LOGIN.LOGIN_FAILED),s.tpLoginView.leftAttemptsMsg2)).show();break;case"exceeded max attempts":var a,n=e.data.failureCount,i=(a=e.data.attemptsAllowed)+n,r=l.su.CHAR.ERROR["00000089"].replace("%num",i);s.tpLoginView.maxAttemptsMsgContent2.setText(r),s.tpLoginView.maxAttemptsMsg2.show()}},showLoading:function(){u.main.showMask(),s.tpLoginView.cloudLoading.show()},hideLoading:function(){u.main.hideMask(),s.tpLoginView.cloudLoading.hide()}}})}(jQuery);