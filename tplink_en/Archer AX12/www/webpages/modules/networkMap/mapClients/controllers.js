!function(r){var d="all",u={"2g":{type:"2g",text:r.su.CHAR.NETWORK_MAP.G24,iconCls:"show_24G"},"5g":{type:"5g",text:r.su.CHAR.NETWORK_MAP.G5,iconCls:"show_5G"},"5g1":{type:"5g-1",text:r.su.CHAR.NETWORK_MAP.G5_1,iconCls:"show_51G"},"5g2":{type:"5g-2",text:r.su.CHAR.NETWORK_MAP.G5_2,iconCls:"show_52G"},"6g":{type:"6g",text:r.su.CHAR.NETWORK_MAP.G6,iconCls:"show_6G"},offline:{text:r.su.CHAR.NETWORK_MAP.OFFLINE,iconCls:"show_offline"},wired:{text:r.su.CHAR.NETWORK_MAP.WIRED,iconCls:"show_LAN"},all:{text:r.su.CHAR.NETWORK_MAP.ALL}};r.su.moduleManager.define("mapClients",{services:["ajax","timer","device","vtype"],deps:["networkMap","navigatorController"],models:["statusAll","accessControl","accessControlEnableM","speedLimitModel"],stores:["clientFilterOptions","connectedClientsStore","onlineDeviceStore","bandwidthUnitStore","speedLimitDownloadStore","speedLimitUploadStore"],views:["mapClientsView"],listeners:{ev_on_launch:function(e,t,n,i,a,s,c){this.unRegisterAutoSaveData([a.connectedClientsStore,a.onlineDeviceStore,i.speedLimitModel]),t.getClients(),t.getAccessControlMode({success:function(e){"black"===e.accessMode?n.mapClientsView.mapClientsAccessControlBtn.setText(r.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST):n.mapClientsView.mapClientsAccessControlBtn.setText(r.su.CHAR.NETWORK_MAP.VIEW_WHITELIST),n.mapClientsView.blockConfirmMsg.setContent(r.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST)}}),"ap"==c.device.getCurrentMode()&&a.connectedClientsStore.hideColumn("downloadSpeed")},ev_before_destroy:function(e,t){t.beforeDestroy()}},init:function(s,i,e,l,t,a){var o=a.device.getConfig().supportSpeedLimit&&"router"===a.device.getCurrentMode();this.configViews({id:"mapClientsView",items:[{id:"connected-clients-grid",cls:" container widget-container "+(o?"speed-limit-grid ":""),configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){e="<div>"+e;return e+='<div class="phone edit" deviceName="'+t.deviceName+'" mac="'+t.mac+'"></div></div>'}},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){var n="";return(n+=s.generateDeviceIcon(t))+'<div class="device-info-container widget-container">'+('<div class="mac">'+t.mac+"</div>")+('<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>")+"</div>"}},{text:o?r.su.CHAR.NETWORK_MAP.DEVICE_INFO:r.su.CHAR.NETWORK_MAP.TYPE,dataIndex:"deviceName",width:o?220:"10%",cls:"s-hide",renderer:function(e,t){var n="";return n+=s.generateDeviceIcon(t)}},{text:r.su.CHAR.NETWORK_MAP.INFORMATION,dataIndex:"deviceName",cls:"s-hide",hideColumn:o,renderer:function(e,t){var n="";return n="object"===r.type(t)?(n=(n=(n+='<div class="device-info-container widget-container">')+'<div class="name" title="'+e+'">'+e+'</div><div class="mac">'+t.mac+"</div>")+'<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>")+'<div class="edit" deviceName="'+e+'" mac="'+t.mac+'"></div></div>':n}},{text:r.su.CHAR.NETWORK_MAP.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,t){var n,i;return o&&!1===t.speedLimitOnline?'<div class="real-time-offline">---</div>':(n="","object"===r.type(t)&&(i=s.convertSpeedVal(t.downloadSpeed),n=(n=(n=(n=(n+='<div class="speed-upload-container widget-container">')+'<span class="icon"></span><span class="text">'+(t=s.convertSpeedVal(t.uploadSpeed)).speed+"</span>")+'<span class="unit">'+t.unit+'</span></div><div class="speed-download-container widget-container">')+'<span class="icon"></span><span class="text">'+i.speed+"</span>")+'<span class="unit">'+i.unit+"</span></div>"),n)}},{text:r.su.CHAR.NETWORK_MAP.INTERFACE,dataIndex:"networkMode",width:"15%",cls:"center-td s-2-col",hideColumn:o,renderer:function(e,t){var n="",i="";if(!e)return"---";switch(e){case"wired":n="<span class='icon icon-interface'></span>";break;case"offline":n=u[e]["text"];break;default:n="<span class='icon icon-wireless signal-%signal%'></span><span class='text text-%mode%'>%text%</span>".replace("%signal%",s.convertSignal(t.signal)).replace("%mode%",u[e]["type"]).replace("%text%",u[e]["text"])}return(i+='<div class="interface-container widget-container">')+n+"</div>"}},{text:r.su.CHAR.NETWORK_MAP.TXRX,dataIndex:"txrate",cls:"center-td",width:"15%",renderer:function(e,t){var n,i;return o&&!1===t.speedLimitOnline?"---":(n="---",e=s.convertRate(e),i=s.convertRate(t.rxrate),"wired"!==t.deviceTag&&"offline"!==t.deviceTag&&null!=e&&(s.convertSignal(t.signal),-1!==e.indexOf("-")&&-1!==i.indexOf("-")||(n=e+" / "+i)),n)}},{text:r.su.CHAR.NETWORK_MAP.DURATION,dataIndex:"remainTime",width:"15%",cls:"center-td "+(o?"":"s-last-td"),renderer:function(e,t){var n,i,a;return o&&!1===t.speedLimitOnline?"---":(t=t.onlineTime,a="",a+='<div class="duration-container widget-container">',n=parseInt(t/86400,10),i=parseInt(t%86400/3600,10),t=parseInt(t%3600/60,10),1===n?a=a+n+" "+r.su.CHAR.NETWORK_MAP.DAY+" ":1<n&&(a=a+n+" "+r.su.CHAR.NETWORK_MAP.DAYS+" "),(a=(a=0<i?a+i+" "+r.su.CHAR.NETWORK_MAP.H+" ":a)+t+" "+r.su.CHAR.NETWORK_MAP.MIN)+"</div>")}},{text:r.su.CHAR.NETWORK_MAP.SPEED_LIMIT,dataIndex:"enableLimit",cls:"s-last-td center-td",hideColumn:!o,renderer:function(e,t){var n,i,a;return!0===t.isGuest?'<div class="speed-limit-info-container"><div class="empty-content">---</div></div>':(i=s.convertSpeedLimitVal(t.downloadLimit,!(n="")),a=s.convertSpeedLimitVal(t.uploadLimit,!0),n+='<div class="speed-limit-info-container">',"object"===r.type(t)&&"off"!==e?(n+='<div class="speed-upload-container widget-container"><span class="icon"></span>',-1!==t.uploadLimit?n=(n+='<span class="text">'+a.speed+"</span>")+'<span class="unit">'+a.unit+"</span>":n+="---",n+='</div><div class="speed-download-container widget-container"><span class="icon"></span>',-1!==t.downloadLimit?n=(n+='<span class="text">'+i.speed+"</span>")+'<span class="unit">'+i.unit+"</span>":n+="---",n+="</div>"):n+='<div class="empty-content">---</div>',n+('<div class="edit-wrapper"><div class="edit-limit" key="'+t.key)+'"></div></div>')}},{text:r.su.CHAR.NETWORK_MAP.BLOCK,xtype:"actioncolumn",dataIndex:"block",width:"10%",renderer:function(e,t){if(o&&!1===t.speedLimitOnline)return"---";for(var n=l.onlineDeviceStore.getData(),i="",a=0,s=n.length;a<s;a++)n[a].mac==t.mac&&(i="HOST"==n[a].host?"disabled":"");var c="";return c+('<a href="javascript:void(0)" class="grid-content-btn btn-block '+i+'">')+'<span class="icon"></span>'+'<span class="text"></span>'+"</a>"}}]}}]}),this.control({"#connected-clients-grid => .btn-block":{ev_grid_action_click:function(e,t){-1<e.target.className.indexOf("disable")||(e=l.connectedClientsStore.getModelByKey(t),s.blockData={key:e.key.getValue(),deviceType:e.deviceType.getValue(),name:e.deviceName.getValue(),mac:e.mac.getValue(),ipaddr:e.ip.getValue(),conn_type:"wireless",host:"NOT HOST"},i.mapClientsView.blockConfirmMsg.show())}},"#connected-clients-grid => .edit":{click:function(e,t){i.mapClientsView.clientNameMsg.show(),i.mapClientsView.clientNameModelAlias.setValue(r(e.currentTarget).attr("deviceName")),i.mapClientsView.clientNameModelMac.setValue(r(e.currentTarget).attr("mac"))}},"#client-name-msg":{ev_msg_ok:function(e,t){var n;!0===s.checkDeviceName(i.mapClientsView.clientNameModelAlias.getValue())?(a.ajax.request({data:{operation:"write",mac:i.mapClientsView.clientNameModelMac.getValue(),alias:i.mapClientsView.clientNameModelAlias.getValue()},proxy:"changeDeviceNameProxy",success:function(e){r.each(l.connectedClientsStore.getData(),function(e,t){t.mac==i.mapClientsView.clientNameModelMac.getValue()&&(r("[data-key="+t.key+"] .device-info-container .name").text(i.mapClientsView.clientNameModelAlias.getValue()),r("#connected-clients-grid_tr_"+t.key+"_td_1 .content div").html(i.mapClientsView.clientNameModelAlias.getValue()+'<div class="phone edit" devicename="'+i.mapClientsView.clientNameModelAlias.getValue()+'" mac="'+i.mapClientsView.clientNameModelMac.getValue()+'"></div>'))})}}),i.mapClientsView.clientNameMsg.hide()):(n=r.su.CHAR.VTYPETEXT.DEVICE_NAME_INVALID,(i.mapClientsView.clientNameModelAlias.getValue().length<1||64<i.mapClientsView.clientNameModelAlias.getValue().length)&&(n=r.su.CHAR.VTYPETEXT.LEN_MIN_MAX.replace("%min",1).replace("%max",64)),i.mapClientsView.clientNameModelAlias.setError(n)),t.preventDefault()},ev_msg_cancel:function(e,t){}},"#map-clients-access-control-btn":{ev_button_click:function(e){t.navigatorController.goTo("accessControl")}},"#block-confirm-msg":{ev_msg_ok:function(e){s.blockDevice(s.blockData)}}}),this.listen({"views.mapClientsView.clientFilterType":{ev_value_change:function(e,t){s.filterClients(t)}}})}},function(n,i,a,s,c,l){var o=l.device.getNetworkMode();return o.unshift(d),{delayInterval:0,currentEnablePriority:!1,currentDownloadLimitMax:1e3,currentUploadLimitMax:1e3,speedLimitMaxRules:0,isTriband:l.device.getIsTriband(),supportWifi6E:l.device.getConfig().supportWifi6E,loadClientListStore:function(e,t){l.ajax.request({proxy:"connectedClientProxy",data:{operation:e},success:function(e){c.networkMap.trigger("ev_clients_number_changed",e.onlineClientNum),s.connectedClientsStore.loadData(e.clientList),n.updateClientFilter(e.clientNum),n.filterClients(),t&&t()},fail:t,error:t})},updateClientFilter:function(t){var e=o.map(function(e){return{name:u[e]["text"]+" ("+(t[e]||0)+")",value:e}});s.clientFilterOptions.loadItems(e),i.mapClientsView.clientFilterType.getValue()||i.mapClientsView.clientFilterType.setValue(d)},filterClients:function(t){var e;(t=t||i.mapClientsView.clientFilterType.getValue())!==d&&(e={func:function(e){return e.networkMode===t}}),s.connectedClientsStore.dom().triggerHandler("ev_grid_filter",[e,!1])},getClients:function(){n.getClientsInterval=l.timer.setInterval(n,function(){"clients"!=c.networkMap.getCurrentModule()||i.mapClientsView.clientNameMsg.viewObjs[0].settings.shown||i.mapClientsView.blockConfirmMsg.viewObjs[0].settings.shown||0<n.delayInterval||(s.onlineDeviceStore.load({url:r.su.url("/admin/access_control?form=black_devices")}),n.delayInterval=1,n.loadClientListStore("loadSpeed",function(){n.delayInterval=0}))},20011,!0)},getAccessControlMode:function(e){var t;e&&(t=e.success),s.onlineDeviceStore.load({url:r.su.url("/admin/access_control?form=black_devices")}),a.accessControlEnableM.load(),a.accessControl.load({success:function(e){t&&t(a.accessControl.getData())}})},setBlackMode:function(t){"off"==a.accessControlEnableM.enable.getValue()&&a.accessControlEnableM.load({data:{operation:"write",enable:"on"}}),a.accessControl.load({data:{operation:"write",access_mode:"black"},success:function(e){i.mapClientsView.mapClientsAccessControlBtn.setText(r.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST),i.mapClientsView.blockConfirmMsg.setContent(r.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST),t&&t()}})},blockDevice:function(e){function t(){l.ajax.request({data:{operation:"block",data:JSON.stringify([e]),index:s.connectedClientsStore.getIndex(e.key),key:e.key},url:r.su.url("/admin/access_control?form=black_devices"),success:function(){s.onlineDeviceStore.load({url:r.su.url("/admin/access_control?form=black_devices"),success:function(){n.loadClientListStore("loadDevice")}})}})}"on"==a.accessControlEnableM.enable.getValue()&&"black"==a.accessControl.accessMode.getValue()?t():n.setBlackMode(t)},beforeDestroy:function(){clearInterval(null)},getIPaddr:function(e){if(deviceStatusData)for(var t in deviceStatusData)for(var n=0,i=deviceStatusData[t].length;n<i;n++)if(deviceStatusData[t][n].macaddr==e)return deviceStatusData[t][n].ipaddr||"";return""},getConnectType:function(e){if(deviceStatusData)for(var t in deviceStatusData)for(var n=0,i=deviceStatusData[t].length;n<i;n++)if(deviceStatusData[t][n].macaddr==e)return t;return""},checkDeviceName:function(e){return 0<e.length&&e.length<65&&l.vtype.validate(e,{vtype:"deviceName"})},convertSpeedVal:function(e,t){e=parseInt(e,10)*(t?1024:8);var n,t={};return t.speed=e,t.unit=r.su.CHAR.NETWORK_MAP.KBPS_BIT,0!==e&&(n=(e=e/1024)/1024,e<1?t.speed=e.toFixed(2):n<1?t.speed=e<1e3?e.toFixed(1):Math.floor(e):(t.speed=n.toFixed(1),t.unit=r.su.CHAR.NETWORK_MAP.MBPS_BIT)),t},convertSpeedLimitVal:function(e,t){var e=parseInt(e,10),n=e<1024?r.su.CHAR.NETWORK_MAP.KBPS_BIT:(e=(e/1024).toFixed(0),r.su.CHAR.NETWORK_MAP.MBPS_BIT);return{speed:e,unit:n}},convertRate:function(e){return e&&-1!==e?(e/=1e3).toFixed(10<e?0:1):"- -"},convertSignal:function(e){return!e||(e=Math.ceil((parseInt(e)+91)/10))<0?0:5<e?5:e},generateDeviceIcon:function(e){var t="",t=(t+='<div class="device-type-container widget-container">')+('<span class="icon '+n.detectDeviceType(e.deviceType)+' ">')+"</span>";return null!=e.enableInternet&&(t+='<span class="text">'+(e.enableInternet?"":r.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),t+="</div>"},detectDeviceType:function(e){return"other"===(e=e.toLowerCase())?"icon-pc":"icon-"+e}}})}(jQuery);