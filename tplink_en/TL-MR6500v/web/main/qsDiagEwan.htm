<script language="javascript">var step=0,dslStk="",ethStk="",bStart=!1,failNotePre=n_str.quicksetup.c_internetFailed,reconfigPage="qsEwan.htm",removeLoadingFlag=!1,bDiagCompleted=!1,handler="",l2tpretryTimeMax=2,l2tpretryTime=0,retrys=0;function doInternetDiag(){var t={},n={},a="",e=new Array,o="",i={};switch(step){case 0:if(""==dslStk)return void doFail();t=$.act(ACT_GET,WAN_DSL_INTF_CFG,dslStk,null,["Status"]),$.exe(function(e){if(e)return diagRemoveLoading(),void $.alert(e);if("Up"==t.status)step++,doInternetDiag();else{if("NoSignal"==t.status)return handler=function(){$("#err_note").html(failNotePre+" "+s_str.dslSyncFail),doFail(),$("#p_reconfig").addClass("nd"),$("#p_retest").removeClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}});break;case 1:INCLUDE_IPV6?e.push("ConnectionStatus","X_TP_IPv6ConnStatus","X_TP_IPv4Enabled","X_TP_IPv6Enabled"):e.push("ConnectionStatus"),o=WAN_IP_CONN,"ppp"==$.qd.type||"pppoa"==$.qd.type||"PPPoE"==$.qd.type?(e.push("LastConnectionError"),o=WAN_PPP_CONN):"L2TP"==$.qd.type?o=WAN_L2TP_CONN:"PPTP"==$.qd.type&&(o=WAN_PPTP_CONN),n=$.act(ACT_GET,o,$.qd.newConn.stack,null,e),$.exe(function(e){if(e)return diagRemoveLoading(),void $.alert(e);if(a=n.connectionStatus,INCLUDE_IPV6&&"L2TP"!=$.qd.type&&"PPTP"!=$.qd.type&&0==n.X_TP_IPv4Enabled&&1==n.X_TP_IPv6Enabled&&(a=n.X_TP_IPv6ConnStatus),"Connected"==a)step++,doInternetDiag();else{if("Disconnected"==a||"Unconfigured"==a)return handler=function(){("ppp"==$.qd.type||"pppoa"==$.qd.type||"PPPoE"==$.qd.type)&&"ERROR_AUTHENTICATION_FAILURE"==n.lastConnectionError?($("#err_note").html(n_str.quicksetup.t_pppAuthFail),reconfigPage="ETH"==$.sysMode?"qsEwan.htm":"qsDsl.htm"):$("#err_note").html(failNotePre+" "+s_str.diagOtherFail),doFail(),$("#p_reconfig").removeClass("nd"),$("#p_retest").addClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}});break;case 2:diagTool=$.act(ACT_GET,DIAG_TOOL,null,null,["LastResult"]),$.exe(function(e){e?$.alert(e):3==diagTool.lastResult?setTimeout(doInternetDiag,1e3):1==bStart?(handler=1==diagTool.lastResult?function(){diagRemoveLoading(),$.qd.internetDiag=3,$.qf.next()}:function(){retrys<15?(retrys++,$.act(ACT_OP,ACT_OP_DIAG_STARTDIAG,diagTool.__stack),$.exe(function(e){e?$.alert(e):setTimeout(doInternetDiag,1e3)})):(4==diagTool.lastResult?$("#err_note").html(failNotePre+" "+s_str.dnsDiagFail):$("#err_note").html(failNotePre+" "+s_str.diagOtherFail),doFail(),$("#p_reconfig").removeClass("nd"),$("#p_retest").addClass("nd"))},bDiagCompleted=!0,1==removeLoadingFlag&&handler()):(bStart=!0,$.act(ACT_OP,ACT_OP_DIAG_STARTDIAG,diagTool.__stack),$.exe(function(e){e?$.alert(e):setTimeout(doInternetDiag,1e3)}))});break;case 3:if(""==ethStk)return void doFail();i=$.act(ACT_GET,WAN_ETH_INTF,ethStk,null,["Status"]),$.exe(function(e){if(e)return diagRemoveLoading(),void $.alert(e);if("Up"==i.status)step++,doInternetDiag();else{if("NoLink"==i.status)return handler=function(){$("#err_note").html(failNotePre+" "+s_str.ethNoLink),doFail(),$("#p_reconfig").addClass("nd"),$("#p_retest").removeClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}});break;case 4:if("PPPoE"==$.qd.type)n=$.act(ACT_GET,WAN_PPP_CONN,$.qd.newConn.stack,null,["ConnectionStatus","LastConnectionError"]);else if("Static IP"==$.qd.type)n=$.act(ACT_GET,WAN_IP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"]);else if("Dynamic IP"==$.qd.type)n=$.act(ACT_GET,WAN_IP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"]);else if("L2TP"==$.qd.type)n=$.act(ACT_GET,WAN_L2TP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"]);else{if("PPTP"!=$.qd.type)return void doFail();n=$.act(ACT_GET,WAN_PPTP_CONN,$.qd.newConn.stack,null,["ConnectionStatus"])}$.exe(function(e){if(e)return diagRemoveLoading(),void $.alert(e);if("Connected"==(a=n.connectionStatus))step=2,doInternetDiag();else{if("Disconnected"==a||"Unconfigured"==a)return handler=function(){if("PPPoE"==$.qd.type)"ERROR_AUTHENTICATION_FAILURE"==n.lastConnectionError?($("#err_note").html(n_str.quicksetup.t_pppAuthFail),reconfigPage="qsEwan.htm"):$("#err_note").html(failNotePre+" "+s_str.diagOtherFail);else{if(("L2TP"==$.qd.type||"PPTP"==$.qd.type)&&l2tpretryTime<l2tpretryTimeMax)return l2tpretryTime++,void setTimeout(doInternetDiag,1e3);$("#err_note").html(failNotePre+" "+s_str.diagOtherFail)}doFail(),$("#p_reconfig").removeClass("nd"),$("#p_retest").addClass("nd")},bDiagCompleted=!0,void(1==removeLoadingFlag&&handler());setTimeout(doInternetDiag,1e3)}})}}function diagAddLoading(){$("div.diag-loading").css("display","block"),$("div.quicksetup-button-container").addClass("nd")}function diagRemoveLoading(){$("div.diag-loading").css("display","none"),$("div.quicksetup-button-container").removeClass("nd")}function doFail(){diagRemoveLoading(),$("#diagFailed").removeClass("nd")}function doReconfig(){"qsIsp.htm"==reconfigPage?$.qd.internetDiag=1:"qsDsl.htm"!=reconfigPage&&"qsEwan.htm"!=reconfigPage||($.qd.internetDiag=2),loadSubPage(reconfigPage)}function doRetest(){$("#diagFailed").addClass("nd"),bDiagCompleted=removeLoadingFlag=!1,diagAddLoading(),setTimeout(function(){removeLoadingFlag=!0,1==bDiagCompleted&&handler&&handler()},1e3),doInternetDiag()}function goNext(){$.qf.next()}function goPrev(){$.qf.prev()}"br"==$.qd.type&&$.qf.next()</script>
<div id="quicksetup_diag_container">
	<form class="pure-form pure-form-aligned">
		<div id="diagFailed" class="nd">
			<div>
				<div style="height:50px;display:block">
					<span id="quicksetup-icon-diag-failed"></span>
					<span class="T" id="t_sorry">Sorry</span>
				</div>
				<p><span id="err_note" style="font-size:15px"></span></p>
			</div>
			<p style="margin-left:70px;margin-top:20px" id="p_reconfig"><button type="submit" class="green left T_reconfig ru-l de-l pl-l tr-xl" id="btnReconfig" onclick="doReconfig()">Reconfig</button></p>
			<p style="margin-left:70px;margin-top:20px" id="p_retest"><button type="submit" class="green left T_retest l ru-xl" id="btnRetest" onclick="doRetest()">Retest</button></p>
		</div>
		<div class="diag-loading">
			<p><span class="diag-loading-icon"></span></p>
			<p><span id="t_diagLoadingText"></span></p>
		</div>
	</form>
</div>
<div class="inline-btn-right quicksetup-button-container">
    <div class="inline">
        <button type="submit" class="green T_back" onclick="goPrev()">Back</button>
    </div>
    <div class="inline">
        <button type="submit" class="green T_next" onclick="goNext()">Next</button>
    </div>
</div>
<script language="javascript">var diagRet=!0;function init(){var e=$.act(ACT_GL,WAN_COMMON_INTF_CFG,null,null,["WANAccessType"]);$.exe(),$.removeLoading(),"DSL"==$.sysMode?$.each(e,function(){if("DSL"==this.WANAccessType)return dslStk=this.__stack,!1}):"ETH"==$.sysMode&&$.each(e,function(){if("Ethernet"==this.WANAccessType)return ethStk=this.__stack,!(step=3)}),$.qd.internetDiag=0,diagAddLoading(),setTimeout(function(){removeLoadingFlag=!0,1==bDiagCompleted&&handler&&handler()},1e3),doInternetDiag()}init()</script>
