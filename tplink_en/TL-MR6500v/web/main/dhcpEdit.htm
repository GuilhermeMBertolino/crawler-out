<script language="javascript">var lanIPv4Cfg,lanIgmpCfg,dhcpCfg,oldLanIp,oldLanMask,subMask=["255.255.255.0","255.255.0.0","255.0.0.0",n_str.dhcp.t_custom];function initEdit(e,s){if($.loadPage("ipv6Edit","lan6.htm"),lanIPv4Cfg=$.act(ACT_GS,LAN_IP_INTF,null,e[s].__stack,["IPInterfaceIPAddress","IPInterfaceSubnetMask","X_TP_MACAddress"]),lanIgmpCfg=$.act(ACT_GET,LAN_IGMP_SNOOP,e[s].__stack,null,["enabled","Mode"]),dhcpCfg=$.act(ACT_GET,LAN_HOST_CFG,e[s].__stack,null,null),!$.exe()){$("#lanMacAddress").prop("value",lanIPv4Cfg[0].X_TP_MACAddress.replace(/\:/g,"-")),oldLanIp=lanIPv4Cfg[0].IPInterfaceIPAddress?lanIPv4Cfg[0].IPInterfaceIPAddress:"0.0.0.0",$("#lanIPAddr").tpAddress("val",oldLanIp),oldLanMask=lanIPv4Cfg[0].IPInterfaceSubnetMask?lanIPv4Cfg[0].IPInterfaceSubnetMask:"0.0.0.0";for(s=0;s<subMask.length&&subMask[s]!=oldLanMask;s++);if(s>=subMask.length&&($("#lanIPSubMask option[value="+(s-1)+"]").prop("selected","selected"),$("#lanIPSubMaskCustom").css("display","inline-block"),$("#lanIPSubMaskCustomInput").tpAddress("val",oldLanMask)),$("#lanIPSubMask option[value="+s+"]").prop("selected","selected"),1==lanIgmpCfg.enabled?($("#lanIGMPEn").prop("checked",!0),$("#snoopingMode").removeClass("nd"),1==lanIgmpCfg.mode?$("#snoopModeAllow").prop("checked",!0):$("#snoopModeBlock").prop("checked",!0)):($("#lanIGMPEn").prop("checked",!1),1==lanIgmpCfg.mode?$("#snoopModeAllow").prop("checked",!0):$("#snoopModeBlock").prop("checked",!0),$("#snoopingMode").addClass("nd")),1==lanIPv4Cfg.length)$("#secIp_en").prop("checked",!1),$("#secIpCont").addClass("nd");else if(2==lanIPv4Cfg.length){$("#secIp_en").prop("checked",!0),$("#secIpCont").removeClass("nd"),$("#secIp").tpAddress("val",""==lanIPv4Cfg[1].IPInterfaceIPAddress?"0.0.0.0":lanIPv4Cfg[1].IPInterfaceIPAddress),$("#secMask").tpAddress("val",""==lanIPv4Cfg[1].IPInterfaceSubnetMask?"0.0.0.0":lanIPv4Cfg[1].IPInterfaceSubnetMask),document.location.href.split("/")[2].split(":")[0]==lanIPv4Cfg[1].IPInterfaceIPAddress&&($("#secIp_en").prop("disabled",!0),$("#secIp").tpAddress("disabled",!0),$("#secMask").tpAddress("disabled",!0))}1==dhcpCfg.DHCPServerEnable?($("#dhcpEn").prop("checked",!0),$("#dhcpCont").removeClass("nd")):($("#dhcpEn").prop("checked",!1),$("#dhcpCont").addClass("nd")),$("#dhcpRelay").prop("checked",1==dhcpCfg.DHCPRelay),$("#ip1").tpAddress("val",dhcpCfg.minAddress?dhcpCfg.minAddress:"0.0.0.0"),$("#ip2").tpAddress("val",dhcpCfg.maxAddress?dhcpCfg.maxAddress:"0.0.0.0"),$("#lease").val(""==dhcpCfg.DHCPLeaseTime?1440:dhcpCfg.DHCPLeaseTime/60),$("#gateway").tpAddress("val",""==dhcpCfg.IPRouters?"0.0.0.0":dhcpCfg.IPRouters),$("#domain").val(""==dhcpCfg.domainName?"":dhcpCfg.domainName),$("#dnsserver1").tpAddress("val",""==dhcpCfg.DNSServers?"":dhcpCfg.DNSServers.split(",")[0]),$("#dnsserver2").tpAddress("val",""==dhcpCfg.DNSServers?"":dhcpCfg.DNSServers.split(",")[1]),$("#rmtSrv").tpAddress("val",dhcpCfg.X_TP_DhcpRelayServer)}}function clickIPv4Save(){var e={},s={},a={},r={};if(0==checkParam())return!1;var d=!1,n=""==$("#lanIPAddr").tpAddress("val")?"0.0.0.0":$.ip2ip($("#lanIPAddr").tpAddress("val")),t=$("select#lanIPSubMask").data("text")==n_str.dhcp.t_custom?$("#lanIPSubMaskCustomInput").tpAddress("val"):$("select#lanIPSubMask").data("text");t=$.ip2ip(t),$.ip2num(oldLanIp)==$.ip2num(n)&&$.ip2num(oldLanMask)==$.ip2num(t)||(d=!0),s.enabled=1==$("#lanIGMPEn").prop("data-checked")?1:0,1==s.enabled&&(1==$("#snoopModeAllow").prop("checked")?s.mode=1:s.mode=2),1==$("#dhcpEn").prop("data-checked")?(a.DHCPServerEnable=1,a.DHCPRelay=1==$("#dhcpRelay").prop("checked")?1:0):a.DHCPServerEnable=0,1==a.DHCPServerEnable&&1==a.DHCPRelay?a.X_TP_DhcpRelayServer=$.ip2ip($("#rmtSrv").tpAddress("val")):1==a.DHCPServerEnable&&(a.minAddress=$.ip2ip($("#ip1").tpAddress("val")),a.maxAddress=$.ip2ip($("#ip2").tpAddress("val")),a.IPRouters=$.ip2ip($("#gateway").tpAddress("val")),a.DHCPLeaseTime=60*$("#lease").val(),a.domainName=$("#domain").val(),""==$("#dnsserver1").tpAddress("val")?""==$("#dnsserver2").tpAddress("val")?a.DNSServers="":a.DNSServers=$.ip2ip($("#dnsserver2").tpAddress("val"))+",":a.DNSServers=$.ip2ip($("#dnsserver1").tpAddress("val"))+","+(""==$("#dnsserver2").tpAddress("val")?"":$.ip2ip($("#dnsserver2").tpAddress("val")))),r.IPInterfaceIPAddress=""==$("#secIp").tpAddress("val")?"0.0.0.0":$.ip2ip($("#secIp").tpAddress("val")),r.IPInterfaceSubnetMask=""==$("#secMask").tpAddress("val")?"0.0.0.0":$.ip2ip($("#secMask").tpAddress("val"));var l=document.location.href.split("/")[2],p=l.split(":")[0],i=80;1<l.split(":").length&&(i=l.split(":")[1]);var c=!1;if(1==$("#secIp_en").prop("checked")){if(1==lanIPv4Cfg.length){var o=lanIPv4Cfg[0].__stack.split(",")[0]+",0,0,0,0,0";$.act(ACT_ADD,LAN_IP_INTF,null,o,r)}else if(2==lanIPv4Cfg.length){$.act(ACT_SET,LAN_IP_INTF,lanIPv4Cfg[1].__stack,null,r);var I=lanIPv4Cfg[1].IPInterfaceIPAddress,f=$.ip2ip($("#secIp").tpAddress("val"));f!=I&&p==I&&(c=!0)}}else 2==lanIPv4Cfg.length&&$.act(ACT_DEL,LAN_IP_INTF,lanIPv4Cfg[1].__stack,null);if(d)$.confirm(c_str.lan_reboot,function(){e.IPInterfaceIPAddress=n,e.IPInterfaceSubnetMask=t,$.act(ACT_SET,LAN_IP_INTF,lanIPv4Cfg[0].__stack,null,e),$.act(ACT_SET,LAN_IGMP_SNOOP,lanIgmpCfg.__stack,null,s),$.act(ACT_SET,LAN_HOST_CFG,dhcpCfg.__stack,null,a),$.exe()||$.guage(["<span class='T T_rebooting'>"+s_str.rebooting+"</span>","<span class='T T_wait_reboot'>"+s_str.wait_reboot+"</span>"],100,1200,function(){p==oldLanIp?$.refresh(n):$.refresh()})},function(){return void(d=!1)});else if($.act(ACT_SET,LAN_IGMP_SNOOP,lanIgmpCfg.__stack,null,s),$.act(ACT_SET,LAN_HOST_CFG,dhcpCfg.__stack,null,a),!$.exe()){if($.local||0==clientLocal)return $.removeLoading(),void $.reload();c?$.refresh(f,i):p!=n&&lanIPv4Cfg[0].IPInterfaceIPAddress!=n?p==I||-1!=window.location.href.search("tplinkmodem.net")?($.removeLoading(),$.reload()):$.refresh(n,i):($.removeLoading(),$.reload())}}function isSameLan(e,s,a,r){var d=0;for(lan1a=e.split("."),lan1m=s.split("."),lan2a=a.split("."),lan2m=r.split("."),i=0;i<4;i++)l1a_n=parseInt(lan1a[i],10),l1m_n=parseInt(lan1m[i],10),l2a_n=parseInt(lan2a[i],10),l2m_n=parseInt(lan2m[i],10),(l1a_n&l1m_n)==(l2a_n&l2m_n)&&d++;if(4!=d)return!1;var n=$.ip2num(e),t=$.ip2num(s);return 0!=(n&~t)&&(n&~t)!=~t}function checkParam(){var e,s=$("#lanIPAddr").tpAddress("val"),a=$("select#lanIPSubMask").data("text")==n_str.dhcp.t_custom?$("#lanIPSubMaskCustomInput").tpAddress("val"):$("select#lanIPSubMask").data("text");if($.ifip(s,!0))return $.alert(ERR_LAN_IP_INVAD),$("#lanIPAddr").tpAddress("focus"),!1;if($.mask(a,!0))return $.alert(ERR_LAN_MASK_INVAD),"custom"==$("select#lanIPSubMask").data("text")?$("#lanIPSubMaskCustomInput").tpAddress("focus"):$("#lanIPSubMask").focus.select(),!1;if($.ipmask(s,a,!0))return $.alert(ERR_LAN_IPMASK_INVAD),$("#lanIPAddr").tpAddress("focus"),!1;var r=$("#ip1").tpAddress("val"),d=$("#ip2").tpAddress("val");if($.ifip(r,!0))return $.alert(ERR_DHCP_START_IP_INVAD),$("#ip1").tpAddress("focus"),!1;if($.ifip(d,!0))return $.alert(ERR_DHCP_END_IP_INVAD),$("#ip2").tpAddress("focus"),!1;if(0==parseInt(r.split(".")[3],10)||255==parseInt(r.split(".")[3],10))return $.alert(ERR_DHCP_START_IP_INVAD_1),$("#ip1").tpAddress("focus"),!1;if(0==parseInt(d.split(".")[3],10)||255==parseInt(d.split(".")[3],10))return $.alert(ERR_DHCP_END_IP_INVAD_1),$("#ip2").tpAddress("focus"),!1;if(!$.isOrderIp(r,d))return $.alert(ERR_TC_IP_ORDER_INVAD),$("#ip2").tpAddress("focus"),!1;if(!isSameLan(r,a,s,a))return $.alert(ERR_DHCP_POOL_INVAD),$("#ip1").tpAddress("focus"),!1;if(!isSameLan(d,a,s,a))return $.alert(ERR_DHCP_POOL_INVAD),$("#ip2").tpAddress("focus"),!1;if($.num($("#lease").val(),[1,2880],!0))return $.alert(ERR_DHCP_LEASE_INVAD),(e=$("#lease"))&&(e.focus(),e.select()),!1;var n=$("#gateway").tpAddress("val");if(""!=n&&"0.0.0.0"!=n&&$.ifip(n,!0))return $.alert(ERR_DHCP_GATEWAY_INVAD),$("#gateway").tpAddress("focus"),!1;if(""!=n&&"0.0.0.0"!=n&&!isSameLan(n,a,s,a))return $.alert(ERR_GATEWAY_INVAD),$("#gateway").tpAddress("focus"),!1;if(""!=$("#domain").val()&&!$.isdomain($("#domain").val()))return $.alert(ERR_DOMAIN_INVAD),(e=$("#domain"))&&(e.focus(),e.select()),!1;var t=$("#dnsserver1").tpAddress("val");if(""!=t&&"0.0.0.0"!=t&&$.ifip(t,!0))return $.alert(ERR_DHCP_DNS1_INVAD),$("#dnsserver1").tpAddress("focus"),!1;var l=$("#dnsserver2").tpAddress("val");if(""!=l&&"0.0.0.0"!=l&&$.ifip(l,!0))return $.alert(ERR_DHCP_DNS2_INVAD),$("#dnsserver2").tpAddress("focus"),!1;var p=$("#rmtSrv").tpAddress("val");if(1==$("#dhcpRelay").prop("checked")&&(""==p||"0.0.0.0"==p))return $.alert(ERR_DHCP_RMT_SRV_EMPTY),$("#rmtSrv").tpAddress("focus"),!1;if(""!=p&&"0.0.0.0"!=p&&$.ifip(p,!0))return $.alert(ERR_DHCP_RMT_SRV_INVAD),$("#rmtSrv").tpAddress("focus"),!1;var i=$("#secIp").tpAddress("val"),c=$("#secMask").tpAddress("val");if(1==$("#secIp_en").prop("checked")){if($.ifip(i,!0))return $.alert(ERR_IP_FORMAT),$("#secIp").tpAddress("focus"),!1;if($.mask(c,!0))return $.alert(ERR_MASK_INVAD),$("#secMask").tpAddress("focus"),!1;if($.ip2ip(i)==$.ip2ip($("#lanIPAddr").tpAddress("val")))return $.alert(ERR_LAN_SEC_IP_INVAD),$("#secIp").tpAddress("focus"),!1}return!0}function initDhcpEdit(){hasGroup?($("#formIPv6").addClass("nd"),$("#ipVersion").addClass("nd"),$("#cancelIPv4").css("display","inline-block"),"Default"==brLanList[groupEditIndex].bridgeName&&($("#formIPv6").removeClass("nd"),$("#ipVersion").removeClass("nd")),$("#hasGroupBtn").removeClass("nd"),$("#noGroupBtn").addClass("nd"),initEdit(brLanList,groupEditIndex)):($("#cancelIPv4").css("display","none"),$("#ipVersion").removeClass("nd"),$("#hasGroupBtn").addClass("nd"),$("#noGroupBtn").removeClass("nd"),initEdit(brLanList,0)),INCLUDE_LTEWAN&&"LTE"==sysMode.mode&&$("#ipVersion").addClass("nd")}function changeVersion(){$("#ipVer4").prop("checked")?($("#formIPv4").removeClass("nd"),$("#formIPv6").addClass("nd")):$("#ipVer6").prop("checked")&&($("#formIPv4").addClass("nd"),$("#formIPv6").removeClass("nd"))}function setDhcpAddresses(){var e,s,a,r,d=$("#lanIPAddr").tpAddress("val"),n=$("select#lanIPSubMask").data("text")==n_str.dhcp.t_custom?$("#lanIPSubMaskCustomInput").tpAddress("val"):$("select#lanIPSubMask").data("text"),t=[],l=[];for($("#ip1").tpAddress("val",""),$("#ip2").tpAddress("val",""),e=d.split("."),s=n.split("."),a=0;a<4;a++)t[a]=e[a]&s[a];for(t[3]+=1,a=0;a<3;a++)l[a]=t[a];r=$.getrightfirstonebitpos(s[3]),l[3]=t[3]+Math.pow(2,r)-3,200<=l[3]&&t[3]<=100&&(t[3]=100,l[3]=199);var p="",i="";for(a=0;a<4;a++)3==a?(p+=t[a],i+=l[a]):(p=p+t[a]+".",i=i+l[a]+".");$("#ip1").tpAddress("val",p),$("#ip2").tpAddress("val",i),$("#gateway").tpAddress("val",d),$("#dnsserver1").tpAddress("val",d),$("#dnsserver2").tpAddress("val","")}</script>
<div class="content-container">
    <div id="ipVersion">
        <b class="xl" id="t_ipVer">IP Version:</b>
        <input type="radio" name="ipVer" id="ipVer4" checked="checked">
        <label id="t_ipVer4">IPv4</label>
        <input type="radio" name="ipVer" id="ipVer6">
        <label id="t_ipVer6">IPv6</label>
    </div>
    <form class="pure-form pure-form-aligned" id="formIPv4">
        <div class="pure-control-group">
            <b class="xl T_macaddr">Mac address:</b>
            <input type="text" readonly="true" id="lanMacAddress">
        </div>
        <div>
            <b class="xl T_ipaddr">LAN IPv4:</b>
            <input type="text" id="lanIPAddr" class="l ip-address" required>
        </div>
        <div class="inline">
            <b class="xl T_netmask">Subnet Mask:</b>
            <select id="lanIPSubMask" class="l">
                <option value="0">255.255.255.0</option>
                <option value="1">255.255.0.0</option>
                <option value="2">255.0.0.0</option>
                <option value="3" id="t_custom">custom</option>
            </select>
        </div>
        <div class="nd" id="lanIPSubMaskCustom" style="margin-left:20px">
            <input type="text" id="lanIPSubMaskCustomInput" class="l ip-address" required>
        </div>
        <div>
            <b class="xl" id="t_snoop">IGMP Snooping:</b>
            <input type="checkbox" id="lanIGMPEn">
            <label id="t_ensnoop">Enable IGMP Snooping</label>
        </div>
		<div id="snoopingMode">
		    <b class="xl" id="t_snoopmode">Snooping Mode:</b>
		    <input type="radio" name="snoopMode" id="snoopModeBlock" checked="checked">
		    <label class="T_block">Block</label>
			<input type="radio" name="snoopMode" id="snoopModeAllow">
		    <label class="T_allow">Allow</label>
		</div>
        <div>
            <b class="xl" id="t_secIp">Second IP:</b>
            <input type="checkbox" id="secIp_en">
            <label id="t_ensecip">Enable Second IP</label>
        </div>
        <div id="secIpCont" class="nd">
            <div>
                <b class="xl T_ipaddr">IP Address:</b>
                <input type="text" class="l ip-address" maxlength="15" id="secIp" value="0.0.0.0">
            </div>
            <div>
                <b class="xl T_netmask">Subnet Mask:</b>
                <input type="text" class="l ip-address" maxlength="15" id="secMask" value="0.0.0.0">
            </div>
        </div>
        <div>
            <b class="xl" id="t_dhcp">DHCP:</b>
            <input type="checkbox" id="dhcpEn">
            <label id="t_endhcp">Enable DHCP</label>
        </div>
        <div id="dhcpCont">
            <div>
                <b class="xl" id="d"></b>
                <input type="radio" name="dhcpfunc" id="dhcpServ" checked="checked">
                <label id="t_dhcpserv">DHCP Server</label>
                <input type="radio" name="dhcpfunc" id="dhcpRelay">
                <label id="t_relay">DHCP Relay</label>
            </div>
            <div id="dhcpSrvCont">
                <div class="inline">
                    <b class="xl" id="t_ippool">IP Address Pool:</b>
                    <input type="text" class="l ip-address" id="ip1" required>
                    <span>-</span>
                    <input type="text" class="l ip-address" id="ip2" required>
                </div>
                <div>
                    <b class="xl" id="t_leasetime">Address Lease Time:</b>
                    <input type="text" id="lease" required>
                    <div class="textbox-tips">
                        <span class="l" id="t_leaseval">minutes. (1-2880. The default value is 1440.)</span>
                    </div>
                </div>
                <div>
                    <b class="xl T_defgw">Default Gateway:</b>
                    <input type="text" id="gateway" required class="ip-address">
                    <span class="T_optional">(Optional)</span>
                </div>
                <div>
                    <b class="xl" id="t_defdomain">Default Domain:</b>
                    <input type="text" id="domain" required>
                    <span class="T_optional">(Optional)</span>
                </div>
                <div>
                    <b class="xl T_dns">DNS Server:</b>
                    <input type="text" id="dnsserver1" required class="ip-address">
                    <span class="T_optional">(Optional)</span>
                </div>
                <div>
                    <b class="xl T_secdns">Secondary DNS Server:</b>
                    <input type="text" id="dnsserver2" required class="ip-address">
                    <span class="T_optional">(Optional)</span>
                </div>
            </div>
            <div id="dhcpRelayCont">
                <div>
                    <b class="xl" id="t_remote">Remote Server Address:</b>
                    <input id="rmtSrv" type="text" class="text ip-address" value="0.0.0.0" size="15" maxlength="15">
                </div>
                <p class="xl cfg-line" id="t_relay_warn">Note: You have to disable NAT of the WAN connections. Or the DHCP Relay may not take effect!</p>
            </div>
        </div>
        <div class="inline-btn-right part-separate" id="hasGroupBtn">
            <button type="submit" class="green inline T_cancel" id="cancelIPv4">Cancel</button>
            <button type="submit" class="green inline T_save" id="saveIPv4Hg">Save</button>
        </div>
        <div id="noGroupBtn">
            <button type="submit" class="green T_save" id="saveIPv4Ng">Save</button>
        </div>
    </form>
    <form class="pure-form pure-form-aligned" id="formIPv6">
        <div id="ipv6Edit"></div>
    </form>
</div>
<script>$("#lanIPAddr").on("change",function(){setDhcpAddresses(),checkParam()}),$("#lanIPSubMaskCustomInput").on("change",function(){setDhcpAddresses(),checkParam()}),$("#secIp_en").on("click",function(){$("#secIp_en").prop("data-checked")?$("#secIpCont").removeClass("nd"):$("#secIpCont").addClass("nd")}),$("#dhcpEn").on("click",function(n){$("#dhcpEn").prop("data-checked")?$("#dhcpCont").removeClass("nd"):$("#dhcpCont").addClass("nd")}),$("#dhcpServ").on("click",function(){$("#dhcpSrvCont").removeClass("nd"),$("#dhcpRelayCont").addClass("nd")}),$("#dhcpRelay").on("click",function(){$("#dhcpSrvCont").addClass("nd"),$("#dhcpRelayCont").removeClass("nd")}),$("#saveIPv4Hg").on("click",function(n){$.addLoading($(this)),clickIPv4Save()}),$("#saveIPv4Ng").on("click",function(n){$.addLoading($(this)),clickIPv4Save()}),$("#cancelIPv4").on("click",function(n){$.reload()}),$("#ipVer4").on("click",function(n){$("#formIPv4").removeClass("nd"),$("#formIPv6").addClass("nd")}),$("#ipVer6").on("click",function(n){$("#formIPv4").addClass("nd"),$("#formIPv6").removeClass("nd")}),$("#lanIGMPEn").on("click",function(n){$("#lanIGMPEn").prop("data-checked")?$("#snoopingMode").removeClass("nd"):$("#snoopingMode").addClass("nd")}),$.tpInit(initDhcpEdit),$("select#lanIPSubMask").click(function(){$("select#lanIPSubMask").data("text")==n_str.dhcp.t_custom?$("#lanIPSubMaskCustom").css("display","inline-block"):($("#lanIPSubMaskCustom").css("display","none"),$("#lanIPSubMaskCustomInput").tpAddress("val",""),setDhcpAddresses(),checkParam())})</script>
