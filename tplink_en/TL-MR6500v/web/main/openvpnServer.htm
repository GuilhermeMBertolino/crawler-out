<script language="javascript">var curOvpnObj,newOvpnObj,curUserObj,cloudDns,dynCfg,noipCfg,userDnsCfg,wanConn,updateFlag,fakeLink,timeOutID,OVPN_CA_NOT_GENERATED=0,OVPN_CA_GENERATED=1,OVPN_CA_GENERATING=2,needToGen=!1,isConfirmWindow=!1,DMVS_CONNECTING="Connecting",DMVS_CONNECTED="Connected",DYNDNS_STATE_DISCONNECTED=0,DYNDNS_STATE_CONNECTING=1,DYNDNS_STATE_CONNECTED=2,NOIPDNS_STATE_DISCONNECTED=3,NOIPDNS_STATE_CONNECTING=4,NOIPDNS_STATE_CONNECTED=5,USERDNS_STATE_DISCONNECTED=0,USERDNS_STATE_CONNECTING=1,USERDNS_STATE_CONNECTED=2;function checkThenExportCliOvpn(){isConfirmWindow=needToGen=!1;var e=$.act(ACT_GET,L3_FORWARDING,null,null,["__ifAliasName"]),n=$.act(ACT_GL,WAN_IP_CONN,null,null,["Enable","Name","ConnectionStatus"]),t=$.act(ACT_GL,WAN_PPP_CONN,null,null,["Enable","Name","ConnectionStatus"]),o=!1;if(INCLUDE_PPTP)var a=$.act(ACT_GL,WAN_PPTP_CONN,null,null,["Enable","Name","ConnectionStatus"]);if(INCLUDE_L2TP)var c=$.act(ACT_GL,WAN_L2TP_CONN,null,null,["Enable","Name","ConnectionStatus"]);if($.exe())return!1;if($.each(n,function(){1==this.enable&&this.name==e.__ifAliasName&&(wanConn=this,o=!0)}),0==o&&$.each(t,function(){1==this.enable&&this.name==e.__ifAliasName&&(wanConn=this,o=!0)}),INCLUDE_PPTP&&0==o&&$.each(a,function(){this.enable&&this.name==e.__ifAliasName&&(wanConn=this,o=!0)}),INCLUDE_L2TP&&0==o&&$.each(c,function(){this.enable&&this.name==e.__ifAliasName&&(wanConn=this,o=!0)}),INCLUDE_DYNDNS&&(dynCfg=$.act(ACT_GET,DYN_DNS_CFG,null,null)),INCLUDE_NOIPDNS&&(noipCfg=$.act(ACT_GET,NOIP_DNS_CFG,null,null)),INCLUDE_DDNS_USERDEFINE&&(userDnsCfg=$.act(ACT_GET,USERDEFINE_DDNS_CFG,null,null)),INCLUDE_CLOUD_V2){if(curUserObj=$.act(ACT_GET,CURRENT_USER,null,null,["userSetting","loginStatus","logInCloud"]),cloudDns=$.act(ACT_GET,CLOUD_DDNS,null,null),$.exe())return;if(2==curUserObj.userSetting&&1==cloudDns.enable){if($.act(ACT_SET,CLOUD_DDNS,null,null,["action=5","status=0"]),$.exe())return;var N=0;setTimeout(function(){N++,cloudDns=$.act(ACT_GET,CLOUD_DDNS,null,null),$.exe()||(2==cloudDns.status?r():2e4<=cloudDns.status?r():N<10?setTimeout(arguments.callee,1e3):r())},1e3)}else r()}else r();function r(){$.exe(function(e){function n(){$("#export_openvpn").prop("disabled",!1),$("#exportSt").html(""),fakeLink.click()}function t(){$.reload()}e?$.alert(e):(null==wanConn?($.alert(ERR_OVPN_WAN_DISCONN),needToGen=!1):(INCLUDE_CLOUD_V2&&1!=cloudDns.enable||!INCLUDE_CLOUD_V2)&&(INCLUDE_DYNDNS&&1==dynCfg.enable&&dynCfg.state==DYNDNS_STATE_CONNECTING||INCLUDE_NOIPDNS&&1==noipCfg.enable&&noipCfg.state==NOIPDNS_STATE_CONNECTING||INCLUDE_DDNS_USERDEFINE&&1==userDnsCfg.enable&&userDnsCfg.state==USERDNS_STATE_CONNECTING||wanConn.connectionStatus==DMVS_CONNECTING)?(needToGen=!1,$("#export_openvpn").prop("disabled",!0),$("#exportSt").html("Exporting"),setTimeout(checkThenExportCliOvpn,1e3)):wanConn.connectionStatus!=DMVS_CONNECTED?($.alert(ERR_OVPN_WAN_DISCONN),needToGen=!1):(INCLUDE_DYNDNS&&1!=dynCfg.enable||!INCLUDE_DYNDNS)&&(INCLUDE_NOIPDNS&&1!=noipCfg.enable||!INCLUDE_NOIPDNS)&&(INCLUDE_DDNS_USERDEFINE&&1!=userDnsCfg.enable||!INCLUDE_DDNS_USERDEFINE)&&(INCLUDE_CLOUD_V2&&1!=cloudDns.enable||!INCLUDE_CLOUD_V2)&&wanConn.connectionStatus==DMVS_CONNECTED?(isConfirmWindow=needToGen=!0,$.confirm(c_str.ovpnDDNSNotEnWanConn,n,t)):(INCLUDE_DYNDNS&&1==dynCfg.enable&&dynCfg.state==DYNDNS_STATE_CONNECTED||INCLUDE_NOIPDNS&&1==noipCfg.enable&&noipCfg.state==NOIPDNS_STATE_CONNECTED||INCLUDE_DDNS_USERDEFINE&&1==userDnsCfg.enable&&userDnsCfg.state==USERDNS_STATE_CONNECTED||INCLUDE_CLOUD_V2&&1==cloudDns.enable&&2==cloudDns.status&&cloudDns.boundDomain)&&wanConn.connectionStatus==DMVS_CONNECTED?needToGen=!0:(INCLUDE_DYNDNS&&1==dynCfg.enable&&dynCfg.state==DYNDNS_STATE_DISCONNECTED||INCLUDE_NOIPDNS&&1==noipCfg.enable&&noipCfg.state==NOIPDNS_STATE_DISCONNECTED||INCLUDE_DDNS_USERDEFINE&&1==userDnsCfg.enable&&userDnsCfg.state==USERDNS_STATE_DISCONNECTED||INCLUDE_CLOUD_V2&&1==cloudDns.enable&&(2!=cloudDns.status||!cloudDns.boundDomain))&&wanConn.connectionStatus==DMVS_CONNECTED?(isConfirmWindow=needToGen=!0,$.confirm(c_str.ovpnDDNSDisconnWanConn,n,t)):needToGen=!0,1==needToGen&&0==isConfirmWindow&&($("#export_openvpn").prop("disabled",!1),$("#exportSt").html(""),location.href=fakeLink.href,$.removeLoading()))})}}function checkServerStatus(){curOvpnObj=$.act(ACT_GET,OPENVPN,null,null),$.exe(function(e){if(!e)if(curOvpnObj.caGenerating==OVPN_CA_GENERATED)1==updateFlag?($("#save_openvpn").prop("disabled",!1),$("#export_openvpn").prop("disabled",!1),$("#genCertSt").html(n_str.openvpnServer.t_generated).css("color","rgb(16,171,255)"),$("#genCert").prop("disabled",!1),$.removeLoading(),updateFlag=0):($("#save_openvpn").prop("disabled",!1),$("#export_openvpn").prop("disabled",!1),$("exportSt").html(""),$("#expConfForm").find("span.load").closest("div").remove(),$("#genCert").prop("disabled",!1),$("#genCertSt").html(""),$("#genCertForm").find("span.load").closest("div").remove());else{if(curOvpnObj.caGenerating!=OVPN_CA_GENERATING)return;if(updateFlag=1,$("#save_openvpn").prop("disabled",!0),$("#export_openvpn").prop("disabled",!0),$("#genCert").prop("disabled",!0),$.addLoading($("#genCert"),null,null,1),$("#genCertSt").html(n_str.openvpnServer.t_generating),0<timeOutID)return;timeOutID=setTimeout(function(){timeOutID=0,checkServerStatus()},1e3)}})}function init(){curOvpnObj=$.act(ACT_GET,OPENVPN,null,null),$.exe()||($("#openvpnEn").prop("checked",1==curOvpnObj.enable),"UDP"==curOvpnObj.proto?$("#serviceTypeUDP").prop("checked","checked"):"TCP"==curOvpnObj.proto?$("#serviceTypeTCP").prop("checked","checked"):$.alert(CMM_INTERNAL_ERROR),$("#servicePort").prop("value",curOvpnObj.port),1==curOvpnObj.access?$("#accessHome").prop("checked","checked"):2==curOvpnObj.access?$("#accessInternetHome").prop("checked","checked"):$.alert(CMM_INTERNAL_ERROR),$("#ovpnSubnet").tpAddress("val",curOvpnObj.subnetAddress),$("#ovpnNetmask").tpAddress("val",curOvpnObj.subnetMask),curOvpnObj.caGenerating==OVPN_CA_NOT_GENERATED?$("#noteCert").removeClass("nd"):$("#noteCert").addClass("nd"),checkServerStatus())}function checkNothingChg(){return!(1==curOvpnObj.enable&&0==$("#openvpnEn").prop("data-checked")||0==curOvpnObj.enable&&1==$("#openvpnEn").prop("data-checked"))&&(!("UDP"==curOvpnObj.proto&&1==$("#serviceTypeTCP").prop("checked")||"TCP"==curOvpnObj.proto&&1==$("#serviceTypeUDP").prop("checked"))&&(curOvpnObj.port==$("#servicePort").prop("value")&&(!(1==curOvpnObj.access&&1==$("#accessInternetHome").prop("checked")||2==curOvpnObj.access&&1==$("#accessHome").prop("checked"))&&($("#ovpnSubnet").tpAddress("val")==curOvpnObj.subnetAddress&&$("#ovpnNetmask").tpAddress("val")==curOvpnObj.subnetMask))))}function checkParaValidity(){var e,n=$("#servicePort").prop("value"),t=$("#ovpnSubnet").tpAddress("val"),o=$.ip2num(t),a=$("#ovpnNetmask").tpAddress("val"),c=$.ip2num(a),N=0;$("#serviceTypeUDP").prop("checked")?e="UDP":$("#serviceTypeTCP").prop("checked")&&(e="TCP");var r,s=$.act(ACT_GL,UPNP_PORTMAPPING),_=$.act(ACT_GET,UPNP_CFG);return $.exe(),n.length<=0||!$.isnum(n)||n<1024||65535<n?($.alert(ERR_OVPN_PORT_INVALID),(r=$("#servicePort"))&&(r.focus(),r.select()),!1):21==n||53==n||70==n||80==n||119==n||110==n||1701==n||1723==n||25==n||1080==n||23==n||33344==n||20005==n||1900==n||20002==n||7547==n||139==n||445==n||7505==n?($.alert(ERR_OVPN_PORT_EXISTS),(r=$("#servicePort"))&&(r.focus(),r.select()),!1):$.ifip(t,!0)?($.alert(ERR_OVPN_SUBNET_INVAD),(r=$("#ovpnSubnet"))&&(r.focus(),r.select()),!1):$.mask(a,!0)?($.alert(ERR_OVPN_NETMASK_INVAD),(r=$("#ovpnNetmask"))&&(r.focus(),r.select()),!1):c>=$.ip2num("255.255.255.248")?($.alert(ERR_OVPN_NETMASK_INVAD_VALUE),(r=$("#ovpnNetmask"))&&(r.focus(),r.select()),!1):(o&c)!=o?($.alert(ERR_OVPN_SUBNET_NETMASK_INVAD),(r=$("#ovpnSubnet"))&&(r.focus(),r.select()),!1):($.each(s,function(){this.externalPort==n&&1==_.enable&&this.portMappingProtocol==e&&($.alert(CMM_UPNP_CONFLICT_WITH_OVPN),(r=$("#servicePort"))&&(r.focus(),r.select()),N=1)}),!N)}function checkCurrentTime(){var e=$.act(ACT_GET,HOUR,null,null);return!$.exe()&&(!(e.year<2015||2037<e.year)||($.alert(ERR_OVPN_TIME_NOT_SET),!1))}$("#save_openvpn").click(function(){var n,t,o,a,c,e=0;if($.addLoading($(this)),checkParaValidity()){if(checkNothingChg())return $.removeLoading(),void $.reload();$("#openvpnEn").prop("data-checked")&&curOvpnObj.caGenerating==OVPN_CA_NOT_GENERATED&&(e=1,$.confirm(c_str.ovpnNoCertSave,N,function(){$.reload()},null,m_str.ok,m_str.cancel)),0==e&&N()}function N(){$.addLoading(),n=$("#openvpnEn").prop("data-checked")?1:0,$("#serviceTypeUDP").prop("checked")?t="UDP":$("#serviceTypeTCP").prop("checked")&&(t="TCP");var e=$("#servicePort").prop("value");$("#accessHome").prop("checked")?o=1:$("#accessInternetHome").prop("checked")&&(o=2),a=$("#ovpnSubnet").tpAddress("val"),c=$("#ovpnNetmask").tpAddress("val"),$.act(ACT_SET,OPENVPN,null,null,["enable="+n,"proto="+t,"port="+e,"subnetAddress="+a,"subnetMask="+c,"access="+o]),$.exe(function(e){$.removeLoading(),e||$.reload()})}}),$("#export_openvpn").click(function(){curOvpnObj.caGenerating!=OVPN_CA_NOT_GENERATED?($.addLoading($(this)),void 0===(fakeLink=document.createElement("a")).click?location.href="":(fakeLink.href="/cgi/openvpn?cliOvpnDown",document.body.appendChild(fakeLink)),checkThenExportCliOvpn()):$.alert(ERR_OVPN_CERT_NOT_GEN_EXP)}),$("#genCert").click(function(){$.addLoading($(this)),$.act(ACT_OP,ACT_OP_OVPN_REGEN_KEYS,curOvpnObj.__stack),$.exe(function(e){e?$.alert(e):($.reload(),$.removeLoading())})})</script>
<h3 id="t_openvpn">OpenVPN</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div id="noteCert" class="nd" style="margin:0 0">
            <p class="cfg-line" style="margin:0 0">
                <span id="t_stepCert">Note:</span>
                <span id="t_stepCert1">No certificate currently, please <b>Generate</b> one before enabling VPN Server.</span>
            </p>
        </div>
        <div>
            <b class="l" id="t_empty"></b>
            <input type="checkbox" id="openvpnEn">
            <label id="t_enOvpn">Enable VPN Server</label>
        </div>
        <div>
            <b class="l" id="t_srvType">Service Type:</b>
            <input type="radio" name="serviceType" id="serviceTypeUDP">
            <label id="t_udp">UDP</label>
            <input type="radio" name="serviceType" id="serviceTypeTCP">
            <label id="t_tcp">TCP</label>
        </div>
        <div>
            <b class="l" id="t_servicePort">Service Port:</b>
            <input type="text" id="servicePort" class="l" required>
        </div>
        <div class="inline">
            <b class="l" id="t_ovpnSubnetAndMask">VPN Subnet/Netmask:</b>
            <input type="text" id="ovpnSubnet" class="l ip-address" required>
            <input type="text" id="ovpnNetmask" class="l ip-address" required>
        </div>
        <div>
            <b class="l" id="t_cliAccess">Client Access:</b>
            <input type="radio" name="clientAccess" id="accessHome">
            <label id="t_home">Home Network Only</label>
            <input type="radio" name="clientAccess" id="accessInternetHome">
            <label id="t_internetHome">Internet and Home Network</label>
        </div>
        <div class="part-separate">
            <button type="submit" class="green T_save" id="save_openvpn">Save</button>
        </div>
    </form>
</div>
<h3 id="t_genCert">Certificate</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned" id="genCertForm">
        <div class="pure-control-group">
            <label class="label-title xxl" id="t_genText">Generate the certificate.</label>
            <button type="submit" class="green T_c_genCert" id="genCert">Generate</button>
            <div class="inline" style="margin-left:25px">
                <span id="genCertSt"></span>
            </div>
        </div>
    </form>
</div>
<h3 id="t_configFile">Configuration File</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned" id="expConfForm">
        <div class="pure-control-group">
            <label class="label-title xxl" id="t_export">Export the configuration.</label>
            <button type="submit" class="green T_c_export" id="export_openvpn">Export</button>
            <div class="inline" style="margin-left:25px">
                <span id="exportSt"></span>
            </div>
        </div>
    </form>
</div>
<script language="javascript">$.tpInit(init)</script>
