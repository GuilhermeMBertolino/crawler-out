<script language="javascript">function changeMecha(){var e=getValueIpv6();"0"===e.mechanism?($("#wan6_select").hasClass("nd")&&$("#wan6_select").removeClass("nd"),!$("#wan_select").hasClass("nd")&&$("#wan_select").addClass("nd"),$("#conf_type").hasClass("nd")&&$("#conf_type").removeClass("nd"),$("#dslite_elem").hasClass("nd")&&$("#dslite_elem").removeClass("nd"),!$("#6rd_elem").hasClass("nd")&&$("#6rd_elem").addClass("nd"),1==dsliteTunnel.dynamic?($("#tunnel_auto").prop("checked",1),$("#tunnel_manual").prop("checked",0)):($("#tunnel_auto").prop("checked",0),$("#tunnel_manual").prop("checked",1))):"1"===e.mechanism?(!$("#wan6_select").hasClass("nd")&&$("#wan6_select").addClass("nd"),$("#wan_select").hasClass("nd")&&$("#wan_select").removeClass("nd"),$("#conf_type").hasClass("nd")&&$("#conf_type").removeClass("nd"),!$("#dslite_elem").hasClass("nd")&&$("#dslite_elem").addClass("nd"),$("#6rd_elem").hasClass("nd")&&$("#6rd_elem").removeClass("nd"),1==sit6rdTunnel.dynamic?($("#tunnel_auto").prop("checked",1),$("#tunnel_manual").prop("checked",0)):($("#tunnel_auto").prop("checked",0),$("#tunnel_manual").prop("checked",1))):"2"===e.mechanism&&(!$("#wan6_select").hasClass("nd")&&$("#wan6_select").addClass("nd"),$("#wan_select").hasClass("nd")&&$("#wan_select").removeClass("nd"),!$("#conf_type").hasClass("nd")&&$("#conf_type").addClass("nd"),!$("#dslite_elem").hasClass("nd")&&$("#dslite_elem").addClass("nd"),!$("#6rd_elem").hasClass("nd")&&$("#6rd_elem").addClass("nd")),$("#tunnel_auto").tpRadio(),$("#tunnel_manual").tpRadio()}function changeType(e){"0"===e.mechanism?$("#tunnel_raddr").prop("disabled",!e.type):"1"===e.mechanism&&($("#masklen").prop("disabled",!e.type),$("#pre").prop("disabled",!e.type),$("#prelen").prop("disabled",!e.type),$("#relayaddr").tpAddress("disabled",!e.type))}function sync(e){var n;n=!e.en,$("#tunnel_mecha").prop("disabled",n),$("#tunnel_wan6inf").prop("disabled",n),$("#tunnel_waninf").prop("disabled",n),$("#tunnel_mecha").tpSelect({refresh:1}),$("#tunnel_wan6inf").tpSelect({refresh:1}),$("#tunnel_waninf").tpSelect({refresh:1}),$("#tunnel_auto").prop("disabled",n),$("#tunnel_manual").prop("disabled",n),$("#tunnel_raddr").prop("disabled",n),$("#tunnel_auto").tpRadio(),$("#tunnel_manual").tpRadio()}function getValueIpv6(){var e={};return e.en=$("#tunnelen").prop("data-checked")?1:0,e.type=$("#tunnel_auto").prop("checked")?0:1,e.mechanism=$("#tunnel_mecha").data("value"),e.mechanism=void 0===e.mechanism?"0":e.mechanism,e}function validDomain(e){seg=e.split(".");for(var n=0;n<seg.length;n++)if(seg[n].length<=2){if(null==seg[n].match(/^[a-z0-9]{1,2}$/i))return!1}else if(null==seg[n].match(/^[a-z0-9][a-z0-9\-]+[a-z0-9]$/i))return!1;return!0}function checkDSLiteAttr(e){if($.isValidGLUIP6AddrStrict(e.remoteIPv6Address)||0!=validDomain(e.remoteIPv6Address))return!0;$.removeLoading($.id("saveBtn"));var n=$.id("raddr");return n&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_DSLITE_REMOTE_INVALID),!1}function check6rdAttr(e){var n;return $.num(e.IPv4MaskLen,[0,32],!0)?($.removeLoading($.id("saveBtn")),(n=$.id("masklen"))&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_6RD_IP_MASK_LEN_INVALID),!1):isValidIP6Prefix(e.prefix)?$.num(e.prefixLen,[1,64],!0)?($.removeLoading($.id("saveBtn")),(n=$.id("prelen"))&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_6RD_PREFIX_LEN_INVALID),!1):!$.ifip(e.borderRelayIPv4Address,!0)||($.removeLoading($.id("saveBtn")),$("#relayaddr").tpAddress("focus"),$.alert(ERR_TUNNEL6_6RD_BR_INVALID),!1):($.removeLoading($.id("saveBtn")),(n=$.id("pre"))&&(n.focus(),n.select()),$.alert(ERR_TUNNEL6_6RD_PREFIX_INVALID),!1)}function isValidIP6Prefix(e){var n=0,a=!0,t=0;if(regExp=/::/,a)if(regExp.test(e))if(regExp=/^([a-f]|[A-F]|[0-9])*(::)([a-f]|[A-F]|[0-9])*(::)([a-f]|[A-F]|[0-9])*$/,regExp.test(e))a=!1;else{var l=e.indexOf("::"),s=(n=e.length,e.substr(0,l)),i=e.substr(l+2,n-l-2);regExp=/^(([a-f]|[A-F]|[0-9]){1,4}(:)){0,6}([a-f]|[A-F]|[0-9]){1,4}$/;t=0;if(""==s&&""==i)a=!1;else if(""==i)regExp.test(s)||(a=!1);else if(""==s)regExp.test(i)||(a=!1);else if(regExp.test(s)&&regExp.test(i)){if(regExp.test(s)&&regExp.test(i)){for(var d=0;d<s.length;d++)":"==s.charAt(d)&&(t+=1);for(d=0;d<i.length;d++)":"==s.charAt(d)&&(t+=1);5<t&&(a=!1)}}else a=!1}else regExp=/^(([a-f]|[A-F]|[0-9]){1,4}(:)){7}([a-f]|[A-F]|[0-9]){1,4}$/,regExp.test(e)||(a=!1);return a}function initWan(){for(var e=0,n=$("#tunnel_waninf"),a=0;a<wanIpList.length;a++)if(1!=$.isSpecialConnection(wanIpList[a])&&1==wanIpList[a].enable&&1==wanIpList[a].X_TP_IPv4Enabled&&"IP_Bridged"!=wanIpList[a].connectionType&&0==wanIpList[a].X_TP_IPv6Enabled){(l={}).value=wanIpList[a].__stack,l.text=wanIpList[a].name,n.append("<option value='ip:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanIpList[a].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}for(var t=0;t<wanPppList.length;t++)if(1!=$.isSpecialConnection(wanPppList[t])&&1==wanPppList[t].enable&&1==wanPppList[t].X_TP_IPv4Enabled&&0==wanPppList[t].X_TP_IPv6Enabled){(l={}).value=wanPppList[t].__stack,l.text=wanPppList[t].name,n.append("<option value='ppp:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanPppList[t].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}if(0==e){var l={value:0,text:"No available interface."};n.append("<option value='"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}}$("#tunnel_waninf option").eq(n.selectedIndex).prop("selected","selected")}function initWan6(){for(var e=0,n=$("#tunnel_wan6inf"),a=0;a<wanIpList.length;a++)if(1!=$.isSpecialConnection(wanIpList[a])&&1==wanIpList[a].enable&&1==wanIpList[a].X_TP_IPv6Enabled&&0==wanIpList[a].X_TP_IPv4Enabled){(l={}).value=wanIpList[a].__stack,l.text=wanIpList[a].name,n.append("<option value='ip:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanIpList[a].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}for(var t=0;t<wanPppList.length;t++)if(1!=$.isSpecialConnection(wanPppList[t])&&1==wanPppList[t].enable&&1==wanPppList[t].X_TP_IPv6Enabled&&0==wanPppList[t].X_TP_IPv4Enabled){(l={}).value=wanPppList[t].__stack,l.text=wanPppList[t].name,n.append("<option value='ppp:"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}e++,wanPppList[t].X_TP_IfName==mainTunnel.associatedWanIfName&&(n.selectedIndex=e-1)}if(0==e){var l={value:0,text:"No available interface."};n.append("<option value='"+l.value+"'>"+l.text+"</option>");try{n.tpSelect({refresh:1})}catch(e){n.tpSelect({refresh:1})}}$("#tunnel_wan6inf option").eq(n.selectedIndex).prop("selected","selected")}function chkConnConflict(e,n){return e.X_TP_IfName==n.associatedWanIfName?0==n.mechanism&&1==e.X_TP_IPv4Enabled?($.alert(ERR_TUNNEL6_DSLITE_WAN_CONN_ERR),2):0!=n.mechanism&&1==e.X_TP_IPv6Enabled?($.alert(1==n.mechanism?ERR_TUNNEL6_6RD_WAN_CONN_ERR:ERR_TUNNEL6_6TO4_WAN_CONN_ERR),2):1:0}function initTunnel(){mainTunnel=$.act(ACT_GET,IP6_TUNNEL,null,null),dsliteTunnel=$.act(ACT_GET,DSLITE,null,null),sit6rdTunnel=$.act(ACT_GET,SIT_6RD,null,null),wanIpList=$.act(ACT_GL,WAN_IP_CONN,null,null),wanPppList=$.act(ACT_GL,WAN_PPP_CONN,null,null),$.exe(function(e){if(!e&&(initWan(),initWan6(),$("#tunnelen").prop("checked",1==mainTunnel.enabled?1:0),$("#tunnel_raddr").val(dsliteTunnel.remoteIPv6Address?dsliteTunnel.remoteIPv6Address:"::"),$("#masklen").val(sit6rdTunnel.IPv4MaskLen),$("#pre").val(sit6rdTunnel.prefix?sit6rdTunnel.prefix:"::"),$("#prelen").val(sit6rdTunnel.prefixLen),$("#relayaddr").tpAddress("val",sit6rdTunnel.borderRelayIPv4Address?sit6rdTunnel.borderRelayIPv4Address:"0.0.0.0"),0==mainTunnel.mechanism?($("#t_dslite").prop("selected",1),$("#tunnel_auto").prop("checked","0"===dsliteTunnel.dynamic?0:1)):1==mainTunnel.mechanism?($("#t_6rd").prop("selected",1),$("#tunnel_auto").prop("checked","0"===sit6rdTunnel.dynamic?0:1)):2==mainTunnel.mechanism&&$("#t_6to4").prop("selected",1),$("#tunnelen").tpCheckbox(),sync(getValueIpv6()),changeType(getValueIpv6()),1==mainTunnel.enabled)){for(var n=0;n<wanIpList.length;n++)if(0!=chkConnConflict(wanIpList[n],mainTunnel))return;for(n=0;n<wanPppList.length;n++)if(0!=chkConnConflict(wanPppList[n],mainTunnel))return}})}function init(){initTunnel(),changeMecha(),sync(getValueIpv6()),$("#tunnelen").click(function(){sync(getValueIpv6())}),$("#tunnel_mecha").on("click",function(){changeMecha(),changeType(getValueIpv6())}),$("#tunnel_auto").click(function(){changeType(getValueIpv6())}),$("#tunnel_manual").click(function(){changeType(getValueIpv6())})}function save(){var e,n,t={},l={},s={};if(t.enabled=1==$("#tunnelen").prop("checked")?1:0,0==$("#tunnel_mecha").data("value")){if(t.mechanism=0,!(e=$("#tunnel_wan6inf").data("text"))||"No available interface."==e)return $.removeLoading(),void $.alert(ERR_IP6_WAN_CONN_NONE);for(var a=0;a<wanIpList.length;a++)wanIpList[a].name==e&&(t.associatedWanIfName=wanIpList[a].X_TP_IfName,t.localAddress=wanIpList[a].X_TP_ExternalIPv6Address);for(a=0;a<wanPppList.length;a++)wanPppList[a].name==e&&(t.associatedWanIfName=wanPppList[a].X_TP_IfName,t.localAddress=wanPppList[a].X_TP_ExternalIPv6Address)}else if(1==$("#tunnel_mecha").data("value")){if(t.mechanism=1,!(n=$("#tunnel_waninf").data("text"))||"No available interface."==n)return $.removeLoading(),void $.alert(ERR_IP6_WAN_CONN_NONE);for(a=0;a<wanIpList.length;a++)if(wanIpList[a].name==n){if(1==$("#tunnel_auto").prop("checked")&&"Static"==wanIpList[a].addressingType)return $.removeLoading(),void $.alert(ERR_TUNNEL6_6RD_NOT_SUPPORT_AUTO);t.associatedWanIfName=wanIpList[a].X_TP_IfName,t.localAddress=wanIpList[a].externalIPAddress;break}for(a=0;a<wanPppList.length;a++)if(wanPppList[a].name==n){if(1==$("#tunnel_auto").prop("checked"))return $.removeLoading(),void $.alert(ERR_TUNNEL6_6RD_NOT_SUPPORT_AUTO);t.associatedWanIfName=wanPppList[a].X_TP_IfName,t.localAddress=wanPppList[a].externalIPAddress;break}}else if(2==$("#tunnel_mecha").data("value")){if(t.mechanism=2,!(n=$("#tunnel_waninf").data("text"))||"No available interface."==n)return $.removeLoading(),void $.alert(ERR_IP6_WAN_CONN_NONE);for(a=0;a<wanIpList.length;a++)if(wanIpList[a].name==n){t.associatedWanIfName=wanIpList[a].X_TP_IfName,t.localAddress=wanIpList[a].externalIPAddress;break}for(a=0;a<wanPppList.length;a++)if(wanPppList[a].name==n){t.associatedWanIfName=wanPppList[a].X_TP_IfName,t.localAddress=wanPppList[a].externalIPAddress;break}}var i=0;for(a=0;0==i&&a<wanIpList.length;a++)if(2==(i=chkConnConflict(wanIpList[a],t)))return void $.removeLoading();for(a=0;0==i&&a<wanPppList.length;a++)if(2==(i=chkConnConflict(wanPppList[a],t)))return void $.removeLoading();2==t.mechanism&&$.act(ACT_SET,SIT_6RD,null,null,["enabled=0"]),$.removeLoading(),$.act(ACT_SET,IP6_TUNNEL,null,null,t),$.exe(function(e){if(!e){if(0==$("#tunnel_mecha").data("value")){if(a=1==$("#tunnel_auto").prop("checked")?1:0,1==t.enabled){for(var n=0;n<wanIpList.length;n++)if(wanIpList[n].X_TP_IfName==t.associatedWanIfName){$.act(ACT_SET,WAN_IP_CONN,wanIpList[n].__stack,null,["X_TP_DSLiteEnabled="+a]);break}for(n=0;n<wanPppList.length;n++)if(wanPppList[n].X_TP_IfName==t.associatedWanIfName){$.act(ACT_SET,WAN_PPP_CONN,wanPppList[n].__stack,null,["X_TP_DSLiteEnabled="+a]);break}}if(l.dynamic=a,0==l.dynamic&&(l.remoteIPv6Address=$("#tunnel_raddr").val(),!checkDSLiteAttr(l)))return;l.enabled=1,s.enabled=0}else if(1==$("#tunnel_mecha").data("value")){var a;if(a=1==$("#tunnel_auto").prop("checked")?1:0,1==t.enabled)for(n=0;n<wanIpList.length;n++)if(wanIpList[n].X_TP_IfName==t.associatedWanIfName){$.act(ACT_SET,WAN_IP_CONN,wanIpList[n].__stack,null,["X_TP_Sit6rdEnabled="+a]);break}if(s.dynamic=a,0==s.dynamic&&(s.IPv4MaskLen=$("#masklen").val(),s.prefix=$("#pre").val(),s.prefixLen=$("#prelen").val(),s.borderRelayIPv4Address=$("#relayaddr").tpAddress("val"),!check6rdAttr(s)))return;l.enabled=0,s.enabled=1}else 2==$("#tunnel_mecha").data("value")&&(l.enabled=0,s.enabled=0);$.act(ACT_SET,DSLITE,null,null,l),$.act(ACT_SET,SIT_6RD,null,null,s),$.exe(function(e){e||$.loadMain("ipv6Tunnel.htm")})}})}$("#t_save").on("click",function(e){$.addLoading($(this)),save()})</script>
<h3 id="t_et">IPv6 Tunnel</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <p>
            <span class="" id="t_note">You must reconfigure this page after rebooting the device. And you must also make sure that the WAN connection you want to use is connected before you configure the tunnel.</span>
        </p>
        <div>
            <b id="t_tunnel">IPv6 Tunnel:</b>
            <input type="checkbox" id="tunnelen">
            <label class="T_en">Enable</label>
        </div>
        <div id="con2">
            <b id="t_mech">Mechanism:</b>
            <select id="tunnel_mecha" class="xxl">
                <option value="0" class="" id="t_dslite">DS-Lite</option>
                <option value="1" class="" id="t_6rd">6RD</option>
                <option value="2" class="" id="t_6to4">6to4</option>
            </select>
        </div>
        <div id="wan6_select">
            <b id="t_wan">WAN Connection:</b>
            <select id="tunnel_wan6inf" class="xxl"></select>
        </div>
        <div id="wan_select">
            <b id="t_wan">WAN Connection:</b>
            <select id="tunnel_waninf" class="xxl"></select>
        </div>
        <div id="conf_type">
            <b id="t_conftype">Configuration Type:</b>
            <input name="t_tunnel_conf" type="radio" id="tunnel_auto">
            <label class="T_auto">Auto</label>
            <input name="t_tunnel_conf" type="radio" id="tunnel_manual">
            <label id="t_manual">Manual</label>
        </div>
        <div id="dslite_elem">
            <b id="t_remote">Remote IPv6 Address:</b>
            <input type="text" id="tunnel_raddr">
        </div>
        <div id="6rd_elem" class="nd">
            <div>
                <b id="t_masklen">IPv4 Mask Length:</b>
                <input type="text" id="masklen">
            </div>
            <div>
                <b id="t_6rdpfx">6RD Prefix:</b>
                <input type="text" id="pre">
            </div>
            <div>
                <b id="t_6rdplen">6RD Prefix Length:</b>
                <input type="text" id="prelen">
            </div>
            <div>
                <b id="t_braddr">Border Relay IPv4 Address:</b>
                <input type="text" id="relayaddr" class="ip-address">
            </div>
        </div>
        <div id="bSave">
            <button type="submit" class="green T_save" id="t_save">Save</button>
        </div>
    </form>
</div>
<script language="javascript">$.tpInit(init)</script>
