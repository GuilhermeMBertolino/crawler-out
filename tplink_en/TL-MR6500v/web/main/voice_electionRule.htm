<script>var voipAccounts,voipDialPlanTmp,editFlag=0,curType=-1,curVia=-1,attrType=2,otherType=1,curPrefix=[],freshFlag=!0,curStk=new Array(-1,-1,-1,-1,-1,-1),endpoints=4,preArray=new Array;function enterCheck(){var e,t,r;try{t=$("#number"),e=n_str.voice_electionRule.t_addpre,r=getValue("number",e,1,16),t.get(0).value=r,checkNum(t,e)}catch(e){if(!1===e)return!1;throw e}return!0}function drawViaList(e){$("#via").data("value");for(var t="<option value='0' text='-Please Select-' selected='selected'>"+showtype[1]+"</option>",r=0;r<voipAccounts.length;r++)if(voipAccounts[r].multiExtension&&""!=voipAccounts[r].multiExtension){var i=voipAccounts[r].multiIndexing,a=voipAccounts[r].multiProfileName;t+="<option value='"+i+"' text='"+a+"'>"+a+"</option>"}$("#via").empty().append(t),e&&$('#via option[value="'+e+'"]').prop("selected","selected");$("#via").tpSelect({refresh:1})}function initType(e){var t=-1;$("#t_num").addClass("nd");for(var r=0;r<preArray.length;r++){for(var i=preArray[r].split("-"),a=0;a<i.length;a++)if(e==i[a]){t=r;break}if(a<i.length)break}-1==t?(t=4,$("#t_num").removeClass("nd"),$("#number").prop("value",e),curPrefix.push(e)):curPrefix=preArray[t].split("-"),$('#type option[value="'+t+'"]').prop("selected","selected");$("#type").tpSelect({refresh:1}),curType=t}function doDel(c,s){$.confirm(c_str.voice_del_con,function(){var e,r=1,t=$.act(ACT_GL,XTP_IGD_MULTIISPDP_LIST,null,null,["attr","prefix","type"]),i=$.act(ACT_GET,XTP_IGD_MULTIISPDP_LIST,s,null);if(0==$.exe()){var a=[];$.each(t,function(e,t){((r=parseInt(this.attr,10))&ENABLE_MASK)>>>ENABLE_SHIFT!=0&&a.push(this)});var n=[];if("other"==c)n.push(i.prefix),e=otherType;else{var l=isPrefix(i.prefix);0<=l&&l<=3&&(n=preArray[l].split("-")),e=attrType}for(var o=0;o<a.length;o++)for(var p=0;p<n.length;p++)if(a[o].prefix==n[p]){$.act(ACT_DEL,XTP_IGD_MULTIISPDP_LIST,a[o].__stack,null,["attr="+r,"type="+e]);break}actForSendMsg(),$.exe(function(e){e||$.reload()})}})}function doEdit(e,t){freshFlag=!1;var r=$.act(ACT_GET,XTP_IGD_MULTIISPDP_LIST,t,null);if(0==$.exe()){var i=(parseInt(r.attr,10)&SIP_MASK)>>>SIP_SHIFT;curVia=i,curStk=t;var a=-(editFlag=1);$("#t_num").addClass("nd");for(var n=0;n<preArray.length;n++){for(var l=preArray[n].split("-"),o=0;o<l.length;o++)if(r.prefix==l[o]){a=n;break}if(o<l.length)break}-1==a||"other"==e?(a=4,$("#t_num").removeClass("nd"),$("#number").prop("value",r.prefix),curPrefix.push(r.prefix)):curPrefix=preArray[a].split("-"),$('#type option[value="'+a+'"]').prop("selected","selected");$("#type").tpSelect({refresh:1}),curType=a,drawViaList(i)}}function isPrefix(e){for(var t=0;t<preArray.length;t++)for(var r=preArray[t].split("-"),i=0;i<r.length;i++)if(r[i]==e)return t;return 4}function freshTable(){if(freshFlag){voipAccounts=$.act(ACT_GL,XTP_MULTI_ISP,null,null,["multiProfileName","multiExtension","multiIndexing"]),voipDialPlanTmp=$.act(ACT_GL,XTP_IGD_MULTIISPDP_LIST,null,null,["attr","prefix","replace","type"]);$.act(ACT_GL,VOICE_PROF_LINE,null,null,["X_TP_PhoneName","X_TP_InternalNumber","X_TP_PhoneType"]);if(0!=$.exe())return;voipDialPlan=[],$.each(voipDialPlanTmp,function(e,t){(parseInt(this.attr,10)&ENABLE_MASK)>>>ENABLE_SHIFT!=0&&voipDialPlan.push(this)}),$("#table-rules").find("tbody tr:not(.nd)").remove();var l,o=new Array,p=new Array(0,0,0,0);$.each(voipDialPlan,function(){var e=this.prefix,t=parseInt(this.attr,10),r=isPrefix(e),i=(t&SIP_MASK)>>>SIP_SHIFT,a=i-1,n="["+this.__stack+"]";0<=r&&r<=3?(this.type&attrType&&0==p[r]&&(p[r]=1,o.push([{text:typeArray[r],width:"35%"},{text:i?voipAccounts[a].multiProfileName:"None",width:"35%"},{text:"<span class='table-grid-icon edit-modify-icon' id='edit_"+l+"' onclick='doEdit(\"type\", "+n+");'></span><span class='table-grid-icon edit-trash-icon' id='del_"+l+"' onclick='doDel(\"type\", "+n+");'></span>",width:"30%"}])),this.type&otherType&&o.push([{text:this.prefix,width:"35%"},{text:i?voipAccounts[a].multiProfileName:"None",width:"35%"},{text:"<span class='table-grid-icon edit-modify-icon' id='edit_"+l+"' onclick='doEdit(\"other\", "+n+");'></span><span class='table-grid-icon edit-trash-icon' id='del_"+l+"' onclick='doDel(\"other\", "+n+");'></span>",width:"30%"}])):o.push([{text:this.prefix,width:"35%"},{text:i?voipAccounts[a].multiProfileName:"None",width:"35%"},{text:"<span class='table-grid-icon edit-modify-icon' id='edit_"+l+"' onclick='doEdit(\"other\", "+n+");'></span><span class='table-grid-icon edit-trash-icon' id='del_"+l+"' onclick='doDel(\"other\", "+n+");'></span>",width:"30%"}]),l++}),$.initTableBody($("#table-rules"),o)}}function initTable(){var e=$.act(ACT_GL,VOICE_PROF,null,null,["region"]);if(0==$.exe()){var t=e[0].region;t&&telephonyProvider[t]&&telephonyProvider[t].voip_callPrefix&&(preArray=telephonyProvider[t].voip_callPrefix);var r="";""!=preArray&&(preArray[0]&&""!=preArray[0]&&(r+='<option class="T" id="t_modile" value="0">'+$.tpLang.voice_electionRule_nstr.t_modile+"</option>"),preArray[1]&&""!=preArray[1]&&(r+='<option class="T" id="t_tel" value="1">'+$.tpLang.voice_electionRule_nstr.t_tel+"</option>"),preArray[2]&&""!=preArray[2]&&(r+='<option class="T" id="t_dis" value="2">'+$.tpLang.voice_electionRule_nstr.t_dis+"</option>"),preArray[3]&&""!=preArray[3]&&(r+='<option class="T" id="t_inter" value="3">'+$.tpLang.voice_electionRule_nstr.t_inter+"</option>")),r+='<option class="T" id="t_other" value="4">'+$.tpLang.voice_electionRule_nstr.t_other+"</option>",$("#type").empty().append(r);$("#type").tpSelect({refresh:1}),$.auto(freshTable,VOICE_FRESH_TIME,!0)}}INCLUDE_DECT&&(endpoints=8),$("#cancel").click(function(){$.reload()}),$("#save").click(function(){$.addLoading($(this));$.act(ACT_GL,XTP_MULTI_ISP,null,null,["multiProfileName","multiIndexing"]);var e=$.act(ACT_GL,XTP_IGD_MULTIISPDP_LIST,null,null,["attr","prefix","type"]);if(0!=$.exe())return $.removeLoading(),void(freshFlag=!0);var r=0;if($.each(e,function(e,t){(parseInt(this.attr,10)&ENABLE_MASK)>>>ENABLE_SHIFT!=0&&(voipDialPlan.push(this),r++)}),0==editFlag&&50<=r)return $.alert(ERR_VOIP_DIALPLAN_ADD_ERROR),void $.reload();if(0!=$("#via").data("value")){var t,i=[],a=$("#type").data("value"),n=$("#via").data("value");if(4==a){if(0==enterCheck())return!1;var l=n_str.voice_electionRule.t_addpre,o=$("#number"),p=getValue("number",l,1,16);o.get(0).value=p,checkNum(o,l),i.push(p),t=otherType}else 0<=a&&a<=3&&(i=preArray[a].split("-"),t=attrType);if(editFlag){if(a!=curType||4==a&&i[0]!=curPrefix[0]){for(var c=0;c<i.length;c++){var s=0;s|=1<<POUND_SHIFT|1<<TIMEOUT_SHIFT,s|=32<<LENGTH_SHIFT&LENGTH_MASK,s|=$("#via").data("value")<<SIP_SHIFT;for(var u=0;u<endpoints;u++)s|=1<<ENABLE_SHIFT+u;$.act(ACT_ADD,XTP_IGD_MULTIISPDP_LIST,null,null,["attr="+s,"prefix="+i[c],"type="+t])}for(c=0;c<curPrefix.length;c++){for(var _=0;_<voipDialPlan.length&&voipDialPlan[_].prefix!=curPrefix[c];_++);if(_<voipDialPlan.length){s=parseInt(voipDialPlan[_].attr,10);console.log(s.toString(16)),$.act(ACT_DEL,XTP_IGD_MULTIISPDP_LIST,voipDialPlan[_].__stack,null,["attr="+s,"type="+(4==curType?otherType:attrType)])}}}else if(n!=curVia)for(c=0;c<curPrefix.length;c++){for(_=0;_<voipDialPlan.length&&voipDialPlan[_].prefix!=curPrefix[c];_++);if(_<voipDialPlan.length){s=0;s|=1<<POUND_SHIFT|1<<TIMEOUT_SHIFT,s|=32<<LENGTH_SHIFT&LENGTH_MASK,s|=$("#via").data("value")<<SIP_SHIFT;for(u=0;u<endpoints;u++)s|=1<<ENABLE_SHIFT+u;$.act(ACT_SET,XTP_IGD_MULTIISPDP_LIST,voipDialPlan[_].__stack,null,["attr="+s,"prefix="+i[c]])}}}else for(c=0;c<i.length;c++){s=0;s|=1<<POUND_SHIFT|1<<TIMEOUT_SHIFT,s|=32<<LENGTH_SHIFT&LENGTH_MASK,s|=$("#via").data("value")<<SIP_SHIFT;for(u=0;u<endpoints;u++)s|=1<<ENABLE_SHIFT+u;$.act(ACT_ADD,XTP_IGD_MULTIISPDP_LIST,null,null,["attr="+s,"prefix="+i[c],"type="+t])}actForSendMsg(),$.exe(function(e){freshFlag=!0,$.removeLoading(),e||$.reload()})}else $.alert(ERR_VOIP_DIAL_VIA_ERROR)}),$("#add").click(function(){curVia=curType=-1,freshFlag=!(curPrefix=[]);for(var e=editFlag=0,t=0;t<voipAccounts.length;t++)voipAccounts[t].multiExtension&&""!=voipAccounts[t].multiExtension&&e++;0==e?$("#save").prop("disabled",!0):$("#save").prop("disabled",!1),drawViaList(0)}),$("#delAll").click(function(){$.confirm(c_str.voice_del_allcon,function(){$.addLoading($(this));var r=1,e=$.act(ACT_GL,XTP_IGD_MULTIISPDP_LIST,null,null,["attr","prefix","type"]);if(0==$.exe()){var i=[];$.each(e,function(e,t){((r=parseInt(this.attr,10))&ENABLE_MASK)>>>ENABLE_SHIFT!=0&&i.push(this)});for(var t=0;t<i.length;t++)$.act(ACT_DEL,XTP_IGD_MULTIISPDP_LIST,i[t].__stack,null,["attr="+r,"type="+i[t].type]);actForSendMsg(),$.exe(function(e){$.removeLoading(),e||$.reload()})}})}),$("#type").click(function(){4==$("#type").data("value")?$("#t_num").removeClass("nd"):$("#t_num").addClass("nd")})</script>
<h3 class="T" id="t_et">Call Rules</h3>
<div class="content-container">
    <form class="pure-form pure-form-aligned">
        <div class="table-op" id="addItem">
            <div class="table-btn">
                <span id="add" class="add-icon"></span>
                <label class="T_add">Add</label>
                <span id="delAll" class="delete-all-icon"></span>
                <label class="T_delall">Delete All</label>
            </div>
        </div>
        <table id="table-rules">
            <thead></thead>
            <tbody id="body-rules">
                <tr id="edit-container-virtual" class="nd">
                    <td colspan="3">
                        <div>
                            <b class="xxl T" id="t_pre">Prefix or number type: </b>
                            <select id="type" class="inline">
                            </select>
                        </div>
                        <div id="t_num" class="nd">
                            <b class="xxl T" id="t_addpre">Add number prefix: </b>
                            <input type="text" id="number" size="18">
                            <br>
                        </div>
                        <div>
                            <b class="xxl T" id="t_viainfo">Dialed via which telephone number: </b>
                            <select id="via">
                            </select>
                        </div>
                        <div class="btn-right">
                            <button type="submit" class="green T_cancel" id="cancel">Cancel</button>
                            <button type="submit" class="green T_save" id="save">Save</button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
</div>
<script>var headArray=[{text:table_str.prefixtype,width:"35%"},{text:table_str.via,width:"35%"},{text:table_str.modify,width:"30%"}];$.tpInit(),$.initTableHead($("#table-rules"),headArray),$("#table-rules").tpTable(initTable)</script>
