!function(m){m.su.moduleManager.define("timeSettings",{models:["timeSettings","language","daylight","time24Model","autoUpgradeModel","regionModel"],stores:["languageStore","setTimeHourStore","setTimeMinStore","setTimeSecStore","startMonthStore","startWeekStore","startWeekdayStore","startHourStore","setTimeModeStore","timezoneStore","availableRegionStore","allRegionStore"],services:["ajax","language","time","device","moduleManager"],views:["timeSettingsView"],deps:["main"],listeners:{"ev_on_launch":function(e,t,a,n,i,s,o){this.unRegisterAutoSaveData([n.time24Model]),o.time.on("on_time_change",t.onTimeChange),o.time.on("on_hour24_change",t.onHour24Change),i.languageStore.load({success:function(){var e=o.device.getLocale();t.unRegisterAutoSaveData([n.language]),n.language.language.setValue(e),n.language.language.record(),t.registerAutoSaveData([n.language])}}),t.initRegion(),n.time24Model.load(),n.timeSettings.load(),n.daylight.load(),o.device.getConfig().supportAutoUpdate&&n.autoUpgradeModel.load({success:function(e){t.autoUpdateEnable=e.enable}})},"ev_before_destroy":function(e,t){t.beforeDestroy()}},init:function(l,r,g,e,t,u){this.listen({"models.time24Model":{"ev_loaded":function(e,t){u.time.setHour24("on"===g.time24Model.hour24Enable.getValue())},"ev_model_submit":function(e,t){u.time.setHour24("on"===g.time24Model.hour24Enable.getValue())}},"models.daylight":{"ev_loaded":function(e){"on"===g.daylight.dstEnable.getValue()||g.daylight.dstStatus.getValue()?g.daylight.dstStatus.show():g.daylight.dstStatus.hide(),l.getTimeFormat()}},"models.timeSettings":{"ev_loaded":function(e,t){var a=t.date.split("/");l.sysTimeYear=parseInt(a[2],10),l.sysTimeHash=l.parseFormat(a[0],2)+l.parseFormat(a[1],2)+l.parseFormat(t.time.split(":")[0],2),l.getTimeFormat()}},"models.timeSettings.type":{"ev_value_change":function(e,t,a){"manual"===t?(r.timeSettingsView.manualFieldset.show(),r.timeSettingsView.internetFieldset.hide(),g.timeSettings.time.enable(),g.timeSettings.date.enable()):"auto"===t?(r.timeSettingsView.manualFieldset.hide(),r.timeSettingsView.internetFieldset.show(),g.timeSettings.time.disable(),g.timeSettings.date.disable()):(r.timeSettingsView.manualFieldset.hide(),r.timeSettingsView.internetFieldset.hide(),g.timeSettings.time.enable(),g.timeSettings.date.enable())}},"models.timeSettings.timezone":{"ev_value_change":function(e,t,a){var n,i,s;null!==a&&(n=g.timeSettings.time.getValue().split(":"),s=parseInt(n[0],10),i=parseInt(n[1],10),i=(s=parseInt(60*s,10)+parseInt(i,10)+parseInt(t,10)-parseInt(a,10))%60,(a=24==(a=24<(t=parseInt(s/60,10))?t-24:t)&&0<i?0:a)<0&&(0==a?a=23:a+=24),i<0&&(i+=60),i<10&&(i="0"+i),s=(a=a<10?"0"+a:a).toString()+":"+i.toString()+":"+n[2],g.timeSettings.time.setValue(s))}},"models.time24Model.hour24Enable":{"ev_value_change":function(e,t,a){a&&a!==t&&g.time24Model.submit()}},"models.daylight.dstEnable":{"ev_value_change":function(e,t,a){"on"===t?r.timeSettingsView.daylightFieldset.show():r.timeSettingsView.daylightFieldset.hide()}},"models.daylight.startMonth":{"ev_value_change":function(e,t,a){l.getTimeFormat()}},"models.daylight.startWeek":{"ev_value_change":function(e,t,a){l.getTimeFormat()}},"models.daylight.startDay":{"ev_value_change":function(e,t,a){l.getTimeFormat()}},"models.daylight.startHour":{"ev_value_change":function(e,t,a){l.getTimeFormat()}},"models.daylight.endMonth":{"ev_value_change":function(e,t,a){l.getTimeFormat()}},"models.daylight.endWeek":{"ev_value_change":function(e,t,a){l.getTimeFormat()}},"models.daylight.endDay":{"ev_value_change":function(e,t,a){l.getTimeFormat()}},"models.daylight.endHour":{"ev_value_change":function(e,t,a){l.getTimeFormat()}}}),this.control({".index-common-save-btn":{"ev_will_auto_save":function(e,t){t.preventDefault(),g.regionModel.isDirty()&&g.regionModel.submit();var a,n,i,s=m.Deferred(),o=m.Deferred();g.timeSettings.isDirty()?("pc"===(t=g.timeSettings.type.getValue())?(n=(a=function(e){return e<10?"0"+e:e})((i=new Date).getMonth()+1)+"/"+a(i.getDate())+"/"+a(i.getFullYear()),i=a(i.getHours())+":"+a(i.getMinutes())+":"+a(i.getSeconds()),g.timeSettings.time.setValue(i),g.timeSettings.date.setValue(n),m.when(s).then(function(){u.time.sync()})):"auto"===t?(r.timeSettingsView.ntpStatus.hide(),m.when(s).then(function(){r.timeSettingsView.ntpStatus.show(),r.timeSettingsView.ntpStatus.setLoading(m.su.CHAR.TIMESETTING.GETGMT_WAIT),g.timeSettings.startGmt({success:function(){l.syncGmt(function(e){u.time.sync(),g.daylight.load()})},fail:function(){r.timeSettingsView.ntpStatus.hide()},error:function(){r.timeSettingsView.ntpStatus.hide()}})})):m.when(s).then(function(){u.time.sync()}),g.timeSettings.submit({success:function(){s.resolve()}})):s.resolve(),g.daylight.isDirty()?g.daylight.submit({success:function(){o.resolve()}}):o.resolve(),m.when(s,o).then(function(){g.language.language.isDirty()&&u.language.switchTo(g.language.language.getValue()),g.daylight.load()})}},"#setTimeMode":{"ev_view_change":function(e,t,a){"on"==l.autoUpdateEnable&&"auto"!=a&&("pc"==a?r.timeSettingsView.setTimeCheckMsg.setContent(m.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE1):"manual"==a&&r.timeSettingsView.setTimeCheckMsg.setContent(m.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE2),r.timeSettingsView.setTimeCheckMsg.show())}},"#set-time-check-msg":{"ev_msg_ok":function(e,t){u.moduleManager.get("navigatorController").goTo("firmware")},"ev_msg_no":function(e,t){g.timeSettings.type.setValue("auto")}}})}},function(f,T,y,i,e,n){var a=null;return{autoUpdateEnable:"",sysTimeYear:"2017",sysTimeHash:"",syncGmt:function(e){var t=function(t){n.ajax.request({proxy:"timeSettingsGmtProxy",method:"refresh",success:function(e){if("undefined"==typeof e.status)return T.timeSettingsView.ntpStatus.hide(),clearInterval(a),a=null,!1;switch(parseInt(e.status,10)){case 747301:clearInterval(a),a=null,T.timeSettingsView.ntpStatus.setSuccess(m.su.CHAR.TIMESETTING.GETGMT_SUCCESS),t&&t(e);break;case 747302:clearInterval(a),a=null,T.timeSettingsView.ntpStatus.setFailed(m.su.CHAR.TIMESETTING.GETGMT_TIMEOUT);break;case 747303:T.timeSettingsView.ntpStatus.setLoading(m.su.CHAR.TIMESETTING.GETGMT_WAIT);break;default:clearInterval(a),a=null}}})};clearInterval(a),a=setInterval(function(){t(e)},2e3),t(e)},onTimeChange:function(e,t){var a=n.time.getHour24(),t=n.time.format(t,"yyyy-MM-dd HH:mm:ss",a);T.timeSettingsView.currentTime.setValue(t)},onHour24Change:function(e,t){t?(i.startHourStore.loadData(f.startHour24Data),y.timeSettings.time.setHourSystem("24")):(i.startHourStore.loadData(f.startHourData),y.timeSettings.time.setHourSystem("12"))},clearCurrentTime:function(){clearInterval(a),a=null},beforeDestroy:function(){f.clearCurrentTime(),n.time.off("on_time_change",f.onTimeChange),n.time.off("on_hour24_change",f.onHour24Change)},startHourData:function(){for(var e,t=[],a=0;a<=23;a++)t[e=a]={},0===a?(t[e].name="12:00 AM",t[e].value="12am"):a<=11?(t[e].name=a+":00 AM",t[e].value=a+"am"):12===a?(t[e].name="12:00 PM",t[e].value="12pm"):(t[e].name=a-12+":00 PM",t[e].value=a-12+"pm");return t[0].selected=!0,t}(),startHour24Data:function(){for(var e,t=[],a=0;a<=23;a++)t[e=a]={},t[e].name=("0"+a).slice(-2)+":00",t[e].value=0===a?"12am":a<=11?a+"am":12===a?"12pm":a-12+"pm";return t[0].selected=!0,t}(),parseFormat:function(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e},getTimeFormat:function(){var e=f.sysTimeYear,t=f.sysTimeHash,a=y.daylight.startMonth,n=y.daylight.startWeek,i=y.daylight.startDay,s=y.daylight.startHour,o=y.daylight.endMonth,l=y.daylight.endWeek,r=y.daylight.endDay,g=y.daylight.endHour,u=a.getValue(),m=n.getValue(),d=i.getValue(),s=s.getValue(),c=o.getValue(),S=l.getValue(),h=r.getValue(),g=g.getValue();if(!(u&&m&&d&&s&&c&&S&&h&&g))return!1;var v,u=parseInt(a.getLiIndex(u))+1,a=parseInt(n.getLiIndex(m))+1,m=parseInt(i.getLiIndex(d))+1,n=parseInt(o.getLiIndex(c))+1,d=parseInt(l.getLiIndex(S))+1,i=parseInt(r.getLiIndex(h))+1,c=-1!==s.indexOf("am")?(v=parseInt(s),parseInt(g)):(v=parseInt(s)+12,parseInt(g)+12),o=new Date(e,u,1),S=parseInt(o.getDay()),l=new Date(e,n,1),h=parseInt(l.getDay()),m=7*a-S+m+1+(m<S?7:0),i=7*d-h+i+1+(i<h?7:0),r=f.parseFormat(u,2)+f.parseFormat(m,2)+f.parseFormat(v,2),s=f.parseFormat(n,2)+f.parseFormat(i,2)+f.parseFormat(c,2),g=T.timeSettingsView.daylightStart,o=T.timeSettingsView.daylightEnd;r<s?t<s?(g.setSubLabel(e),o.setSubLabel(e)):(g.setSubLabel(e+1),o.setSubLabel(e+1)):t<s?(g.setSubLabel(e-1),o.setSubLabel(e)):(g.setSubLabel(e),o.setSubLabel(e+1))},initRegion:function(){y.regionModel.load({success:function(e){y.regionModel.getData().regionSelectEnable&&(y.regionModel.country.show(),T.timeSettingsView.timeSettingsPanel.setTitle(m.su.CHAR.TIMESETTING.REGION_TIME),T.timeSettingsView.timeSettingsPanel.setInstruction(m.su.CHAR.TIMESETTING.SYSTEM_TIME_REGION_TIP),i.availableRegionStore.loadData(f.getAvailableRegions()))}})},getAvailableRegions:function(){for(var e=y.regionModel.getData(),t=(regionList=e.regionList,[]),a=0;a<regionList.length;a++){var n=regionList[a],n=i.allRegionStore.getModelByKey(n).getData();t.push(n)}return t}}})}(jQuery);