<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>DMZ</title>
</head>

<body>
	<div class="func-container">
		<div id="dmz_setting">
			<form id="dmz_enable_setting" class="natSeries">
				<input type="text"  id="dmz_enable" name="dmz_type" />
				<div id = "form_dmz">
					<input type="text"  id="dmz_ipaddr" name="dmz_host_ip" />
                 </br>
					</br>
					<span class="" id="dmz_note"></span>
				</div>
				<div id = "form_smartDmz">
					<input type = "text"  id="smartDmz_mac" name="dmz_host_mac"/>
					<button type="button"  id="device_view"></button>
                 </br>
					</br>
					</br>
					<span class="" id="dmz_note"></span>
				</div>
			</form>
		</div>
		<div id="device_survey">
 			<div id="device_result"></div>
		</div>
 	</div>	
	<div id="dmz_help"></div>

	
<script type="text/javascript">
//<![CDATA[
try{
    $
}catch(e){
    location.href = "/";
};

$(document).ready(function(e){

	var URL_DMZ = $.su.url("/admin/nat?form=dmz"); //data/nat.dmz.json
	var URL_ONLINE_BLACK = $.su.url("/admin/access_control?form=black_devices");
	

	$("div.func-container").page({
		title: $.su.CHAR.DMZ.TITLE,
		help: ""	//可能是个调用的id 也可能是个url
	});

	$('div#dmz_setting').panel({
		title: $.su.CHAR.DMZ.TITLE,
		collapsible: false
	});
    $("span#dmz_note").html($.su.CHAR.DMZ.DMZ_NOTE);/*ALG与DMZ提醒文字*/
	
	$("#form_dmz").fieldset({
		fields: [
			{name: "dmz_host_ip"}
		]
	});
	$("#form_dmz").fieldset("hide");
	$("#form_smartDmz").fieldset({
		fields: [
			{name: "dmz_host_mac"}
		]
	});
	$("#form_smartDmz").fieldset("hide");


	$("input#dmz_enable").radio({
		fieldLabel: $.su.CHAR.DMZ.HARDWARESTATUS,
		columns:3,
		items: [
			{boxlabel: $.su.CHAR.DMZ.DISABLEDMZ, inputValue: "disable" },
			{boxlabel: $.su.CHAR.DMZ.ENABLE_DMZ, inputValue: "dmz"},
			{boxlabel: $.su.CHAR.DMZ.ENABLE_SMARTDMZ, inputValue: "smartDmz" }
		]
	}).on("ev_change", function(e, oldValue, newValue){
	switch(newValue)
		{
		    case "disable":
		      $('#form_dmz').fieldset("hide");
			  $('#form_smartDmz').fieldset("hide");
		      break;
		    case "dmz":
		      $('#form_smartDmz').fieldset("hide");
			  $('#form_dmz').fieldset("show");
		      break;
			case "smartDmz":
		      $('#form_smartDmz').fieldset("show");
			  $('#form_dmz').fieldset("hide");
		      break;
	    }
	});

	$("input#dmz_ipaddr").textbox({
		fieldLabel: $.su.CHAR.DMZ.DMZ_IP,
		vtype:"ip",
		textFormat: $.su.format.ip,
		allowBlank:false,
		vtypeText: $.su.CHAR.DMZ.IPERROR
	});

	$("input#smartDmz_mac").textbox({
		fieldLabel: $.su.CHAR.DMZ.MAC_ADDRESS,
		vtype:"mac",
		textFormat: $.su.format.mac,
		allowBlank:false,
		tipsCls:"after-button",
		cls: 'inline-block'
	//	vtypeText: $.su.CHAR.DMZ.IPERROR
	});

	$("#device_view").button({
		text:$.su.CHAR.DMZ.PLEASE_SELECT,
		cls: 'inline-block ml5',
		handler:function(){
			$("div#device_survey").msg("show");
			result_store.load();
			
		}
	});
	
	/*$("#clone_pc_mac").checkbox({
		fieldLabel: "",
		items: [
			{boxlabel: $.su.CHAR.DMZ.MAC_CLONE, inputValue: "on", uncheckedValue: "off"}
		]
	});*/
	var existingService = $("div#device_survey").msg({
		autoshow:false,
		title:$.su.CHAR.DMZ.PLEASE_SELECT,
		type: "window"
	});	
	var blackOnlineProxy = new $.su.Proxy({
		url: URL_ONLINE_BLACK
	});	
	
	var result_store = new $.su.Store({
		proxy: blackOnlineProxy,//dmzOnline的json文件；
		fields: [
			{name: "ipaddr"},
		 	{name: "mac"}
		],
		autoLoad: false
	});

	var result_grid = $("div#device_result").grid({
		store: result_store,
		maxLines:5,
		paging: {},
		columns: [
					{
						text: $.su.CHAR.ACCESS_CTR.ID, 
						xtype: "rownumberer",
						width:40
					},
					{
						text: $.su.CHAR.DMZ.IP_ADDRESS, 
						width:150,
						dataIndex: "ipaddr"
					},
					{
						text: $.su.CHAR.DMZ.MAC, 
						width:170,
						dataIndex: "mac"
					},
					{
						text: $.su.CHAR.GRID.OPERATION, 
						renderer:function(data, index){
							return "<a href=\"javascript:void(0);\" data-index=\""+index+"\" class=\"choose-existing-service choose\" >"+$.su.CHAR.OPERATION.CHOOSE+"</a>"
						}
					}
				]
	});

	$(result_grid).delegate("a.choose-existing-service", "click", function(e){
		e.preventDefault();
		var store = result_grid.grid("getStore"),
			index = $(this).attr("data-index"),
			data = store.data[index] || undefined;
		if (data){
			$("input#smartDmz_ip").textbox("setValue", data["ipaddr"]);
			$("input#smartDmz_mac").textbox("setValue", data["mac"]);
		};
		existingService.msg("close");
    });

	var dmzProxy = new $.su.Proxy({
		url: URL_DMZ
	});
	var lanIP = 0;
	var lanMask = 0;

	var lanProxy = new $.su.Proxy({
		url: $.su.url('/admin/network?form=lan_ipv4')
	});

	lanProxy.read({}, function(data){
		lanIP = data.ipaddr;
		lanMask = data.mask_type.toUpperCase()=='CUSTOM'?data.custom_value:data.mask_type;
	});


	$("form#dmz_enable_setting").form({
		proxy: dmzProxy,
		fields: [
			{name: "dmz_type" , mapping : "dmz_type"},
			{name: "dmz_host_ip" , mapping : "dmz_host_ip"},
			{name: "dmz_host_mac", mapping: "dmz_host_mac"}		
		],
		validator:function(){
			if($("input#dmz_enable").checkbox("getValue")[1] == "dmz")
			{
				if( $("#dmz_ipaddr").textbox('getValue') == $.su.func.getLimitIp(lanIP,lanMask,"min") ){
					$("#dmz_ipaddr").textbox("setError");
					$("form#form_dmz").form('setError',  $.su.CHAR.ERROR['00000133']);
					return false;
				}
				if( $("#dmz_ipaddr").textbox('getValue') == $.su.func.getLimitIp(lanIP,lanMask,"max") ){
					$("#dmz_ipaddr").textbox("setError");
					$("form#form_dmz").form('setError',  $.su.CHAR.ERROR['00000133']);
					return false;
				}

				if( $("#dmz_ipaddr").textbox('getValue') == lanIP){
					$("#dmz_ipaddr").textbox("setError");
					$("form#form_dmz").form('setError',  $.su.CHAR.ERROR['00000077']);
					return false;
				}
			}
			return true;
		},
		submitBtn: "default"
	});
	

	var helpDMZ = new $.su.Help({
		container: "div#dmz_help",
		content: "SMART_DMZ"
	});

});
</script>
</body>
</html>
