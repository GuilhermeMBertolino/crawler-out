(function(a){a.su.Store=function(b){var d={fields:null,xtype:"store",proxy:null,autoLoad:false,tag:"store",global:false,keyProperty:"key",updateMode:"operation",keyLength:0};var c=a.extend({},d,b);if(c.proxy){if(c.proxy.isProxy!==true){c.proxy=new a.su.Proxy(c.proxy)}}else{c.autoLoad=false}if(!c.fields||c.fields.length===0){return null}if(c.global==true){if(!c.id){return null}}this.id=c.id||a.su.randomId("store");this.init(c)};a.su.Store.prototype.init=function(b){a.extend(this,b);this.data=[];this.snapshot=null;this.isStore=true;this.isSorted=false;if(this.autoLoad===true){this.load()}a(this).on("ev_datachanged",function(f,d,c){this.isSorted=false});a.su.storeManager.add(this)};a.su.Store.prototype.getData=function(d){var e=this.data,b=this.keyProperty;if(!d){return undefined}var c=this.getIndex(d);if(c==undefined){return undefined}else{return e[c]}};a.su.Store.prototype.getDataByIndex=function(b){var c=this.data;return c[b]};a.su.Store.prototype.getIndex=function(e){var f=this.data,c=this.keyProperty;if(!e){return undefined}for(var d=0,b=f.length;d<b;d++){if(f[d][c].toString()==e.toString()){return d;break}}return undefined};a.su.Store.prototype.getKeyByIndex=function(c){var e=this.data;var b=this.keyProperty;var f=e[c];return f[b]};a.su.Store.prototype.getIndexs=function(b){var d=this.data,c=this.keyProperty;if(b.length==0){return undefined}var h=[];for(var e=0,j=b.length;e<j;e++){for(var f=0,g=d.length;f<g;f++){var i=b[e];if(d[f][c].toString()==i.toString()){h.push(f);break}}}return h};a.su.Store.prototype.insert=function(e,g,b,h,d){var e=(e==undefined||e==null)?g.length-1:e,c=this,f={};f[this.keyProperty]="add";this.proxy.write(a.extend(f,{operation:"insert",index:e},g),function(k,j,i,l){if(!a.isArray(k)){k=[k]}k=c.dataFormat(k);if(c.updateMode=="operation"){c.insertData(e,k,function(m,n){if(b){b.call(c,m,n)}})}else{c.loadData(k,j,false,function(m){if(b){b.call(c,m,j,i,l)}})}},function(i,j){if(h){h.call(c,i,j)}a(c).trigger("ev_failed",["insert",i,j])},function(k,i,j){if(d){d.call(c,k,i,j)}a(c).trigger("ev_error",["insert",k,i,j])})};a.su.Store.prototype.load=function(e,b,f,d){var c=this,e=e||{};this.proxy.read(a.extend({operation:"load"},e),function(i,h,g,j){i=c.dataFormat(i);c.loadData(i,h,false,function(k){if(b){b.call(c,k,h,g,j)}});a(c).trigger("ev_load",[c,i])},function(g,h){if(f){f.call(c,g,h)}a(c).trigger("ev_failed",["load",g,h])},function(i,g,h){if(d){d.call(c,i,g,h)}a(c).trigger("ev_error",["load",i,g,h])})};a.su.Store.prototype.update=function(h,e,j,b,i){var d=this.keyProperty;if(h==undefined||h==null){return}var f=this.getIndex(h),c={},g=this;c[d]=h;this.proxy.write(a.extend({operation:"update",index:f},c,e),function(m,l,k,n){if(!a.isArray(m)){m=[m]}a.extend(m,c);m=g.dataFormat(m);if(g.updateMode=="operation"){g.updateData(h,m,function(o,p){if(j){j.call(g,o,p)}})}else{g.loadData(m,l,false,function(o){if(j){j.call(g,o)}})}a(g).trigger("ev_update",[g,m])},function(k,l){if(b){b.call(g,k,l)}a(g).trigger("ev_failed",["update",k,l])},function(m,k,l){if(i){i.call(g,m,k,l)}a(g).trigger("ev_error",["update",m,k,l])})};a.su.Store.prototype.remove=function(d,h,c,i,g){var e=this,b=this.keyProperty;if(!a.isArray(d)){d=[d]}var f=this.getIndexs(d);this.proxy.write(a.extend({operation:"remove",key:d,index:f},h),function(m,j,l,s){if(e.updateMode=="operation"){if(m.length>0){if(m[0][b]){var k=[];for(var o=0,p=m.length;o<p;o++){if(m[o].success){var r=m[o][b];k.push(r)}}e.removeDataByKey(k)}else{var q=[];for(var n=0,p=m.length;n<p;n++){if(m[n].success){var o=m[n]["index"];q.push(parseInt(o,10))}}e.removeDataByIndex(q)}}if(c){c.call(e,k,q,m)}}else{e.loadData(m,j,false,function(t){if(c){c.call(e,t,j)}})}},function(j,k){if(i){i.call(e,j,k)}a(e).trigger("ev_failed",["remove",j,k])},function(l,j,k){if(g){g.call(e,l,j,k)}a(e).trigger("ev_error",["remove",l,j,k])})};a.su.Store.prototype.dataFormat=function(g){var k=this.fields,e=this.keyProperty,c=a.su.format;if(!g||a.isEmptyObject(g)){return[]}if(!a.isArray(g)){g=[g]}var q=[],f=false;for(var h=0;h<k.length;h++){var o=k[h].name,j=k[h].type||"string",b=k[h].mapping||o,m=k[h].defaultValue||undefined,p=(k[h].dataFormat)?k[h].dataFormat:function(r){return r};for(var l=0;l<g.length;l++){q[l]=q[l]||{};var i=g[l][b];var d=(i===undefined||i===null)?m:i;var n=p(d);q[l][o]=n}if(e==name){f=true}}if(!f){for(var l=0;l<g.length;l++){q[l]=q[l]||{};q[l][e]=g[l][e]||"key-"+(l+this.keyLength)}}this.keyLength+=g.length;return q};a.su.Store.prototype.insertData=function(f,e,d){var h=this.data;if(f>h.length){return false}if(!a.isArray(e)){e=[e]}var c=h.slice(0,f);var g=h.slice(f,h.length);var b=c.concat(e,g);this.data=null;delete this.data;this.data=b;this.snapshot=null;delete this.snapshot;this.snapshot=a.su.clone(this.data);if(d){d.call(this,f,e)}a(this).trigger("ev_insertdata",[f,e]);a(this).trigger("ev_datachanged",[this,this.data,"insertData"]);return this};a.su.Store.prototype.loadData=function(e,d,c,b){if(!c&&this.data.length>0){this.removeAllData()}if(!a.isArray(e)){e=[e]}this.data=this.data||[];this.data=this.data.concat(e);this.snapshot=null;delete this.snapshot;this.snapshot=a.su.clone(this.data);if(b){b.call(this,e,c)}a(this).trigger("ev_loaddata",[this.data,d]);a(this).trigger("ev_datachanged",[this,this.data,"loadData"]);return this};a.su.Store.prototype.updateData=function(d,e,b){if(a.isArray(e)){e=e[0]}var c=this.getIndex(d);if(c===undefined||c===null){return}this.data.splice(c,1,e);this.snapshot=null;delete this.snapshot;this.snapshot=a.su.clone(this.data);if(b){b.call(this,d,e)}a(this).trigger("ev_updatedata",[d,c,e]);a(this).trigger("ev_datachanged",[this,this.data,"updateData"]);return this};a.su.Store.prototype.removeDataByKey=function(e,d){var c=this.keyProperty;if(!a.isArray(e)){e=[e]}var i={};for(var g=0,b=e.length;g<b;g++){i[e[g]]=true}var h=this.data;var f=[];for(var g=0,b=h.length;g<b;g++){if(h[g][c] in i){f.push(g)}}this.removeDataByIndex(f,function(j,k){if(d){d.call(this,j,k)}})};a.su.Store.prototype.removeDataByIndex=function(f,d){var c=this.keyProperty,h=this.data;if(!a.isArray(f)){f=[f]}f.sort(function(j,i){return j-i});var b=[];for(var e=f.length-1;e>=0;e--){var g=f[e];if(isNaN(g)){continue}b.push(h[g][c]);h.splice(f[e],1)}this.snapshot=null;delete this.snapshot;this.snapshot=a.su.clone(this.data);if(d){d.call(this,b,f)}a(this).trigger("ev_removedata",[b,f]);a(this).trigger("ev_datachanged",[this,this.data,"removeData"]);return this};a.su.Store.prototype.removeAllData=function(b){this.data=null;delete this.data;this.data=[];this.snapshot=null;a(this).trigger("ev_removeAllData",[this]);a(this).trigger("ev_datachanged",[this,this.data,"removeData"]);return this}})(jQuery);