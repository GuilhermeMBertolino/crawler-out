(function(a){a.su.Widget("editor",{defaults:{columns:null,grid:null,editing:false,pluginId:"",editingId:null,form:null,beforeSubmit:null,items:null,content:null,fields:null},create:function(e,b){var d=this;d.each(function(o,n){a.extend(this,e,b);var p=a(n),m=n.columns;var f='<td class="editor-container" colspan="'+m.length+'">';f+='<div class="container editor-content-container"></div>';f+='<div class="container editor-buttons-container">';f+='<span class="form-error-tips"></span>';f+='<div class="button-container submit">';f+='<button type="button" class="editor-btn btn-cancel button-button">';f+='<span class="button-button-before"></span>';f+='<span class="button-text text">'+a.su.CHAR.OPERATION.CANCEL+"</span>";f+="</button>";f+="</div>";f+='<div class="button-container submit">';f+='<button type="button" class="editor-btn btn-submit button-button">';f+='<span class="button-button-before"></span>';f+='<span class="button-text text">'+a.su.CHAR.OPERATION.SAVE+"</span>";f+="</button>";f+="</div>";f+="</div>";f+="</td>";var j=a(f);p.append(j).addClass("container widget-container editor-container");var k=p.find("div.editor-content-container");var q=[];for(var t=0;t<m.length;t++){var l=m[t],g=m[t]["editor"];if(g){var s=a("<input />");k.append(s);if(a.type(g)==="string"){s[g]({fieldLabel:l.text||"",name:l.name||l.dataIndex||""})}else{if(g.xtype){var h=a.extend({},g,{fieldLabel:l.text||"",name:l.name||l.dataIndex||""});s[g.xtype](h)}else{return null}}q.push({name:l.name||l.dataIndex||""})}}if(n.items){for(var t=0,r=n.items.length;t<r;t++){var u=n.items[t],s=a("<input />");k.append(s);s[u.xtype](a.extend({},u));q.push({name:u.name})}}if(n.content&&n.content!="default"){if(!n.fields){return}k.append(a(n.content).detach())}a.extend(q,n.fields);a.extend(b,{fields:q});j.form(b);n.pluginId=a.su.randomId("editor");n.isEditor=true});d.delegate("button.btn-submit","click",function(h){h.stopPropagation();var g=d.get(0);if(g.beforeSubmit){var f=g.beforeSubmit();if(!f){return}}d.editor("completeEdit")});d.delegate("button.btn-cancel","click",function(f){f.stopPropagation();d.editor("cancelEdit")});var c=d.get(0).grid;if(!c||c.length==0||!c.get(0).isGrid){return null}c.delegate("a.grid-content-btn.grid-content-btn-edit","click",function(k){k.preventDefault();k.stopPropagation();var h=a(this),j=h.closest("tr.grid-content-tr");if(j.hasClass("disabled")){return}var g=h.attr("data-key"),f=h.attr("data-index"),i=d;if(i){var l=i.get(0);if(l&&l.isEditor){if(l.editing===false){i.editor("startEdit",g)}else{i.editor("shake")}}}});d.css("display","none");return d},hide:function(b){var b=b||this;b.detach().css("display","none");return b},shake:function(b){var b=b||this;b.queue(function(){a(this).addClass("shaking");a(this).dequeue()});b.delay(80);b.queue(function(){a(this).removeClass("shaking");a(this).dequeue()});b.delay(80);b.queue(function(){a(this).addClass("shaking");a(this).dequeue()});b.delay(80);b.queue(function(){a(this).removeClass("shaking");a(this).dequeue()});return b},startEdit:function(l,g){var l=l||this,j=l.get(0),e=g[1]||"add",b=l.get(0).grid,f=b.get(0),n=b.get(0).store,k=null,c=l.find("td.editor-container");l.editor("hide");c.form("setNormal");j.editing=true;j.editingId=e;j.editingIndex="add";if(e!="add"){var i=n.getData(e),h=n.getIndex(e);j.editingIndex=h;j.adding=false;if(i){c.form("loadData",i)}else{c.form("reset")}k=f.rows[h];if(k){k.addClass("editing");b.grid("disableRow",h)}}else{l.get(0).adding=true;c.form("reset");var m=b.find("tbody.grid-content-data"),d=m.find("tr.grid-content-tr").eq(0);if(d.hasClass("empty")){k=d}else{k=l.grid("initEmptyRow");m.prepend(k)}k.addClass("editing add disabled")}l.insertAfter(k);l.slideDown(300);l.trigger("ev_startEdit",[j.editingIndex,j.editingId]);return l},completeEdit:function(j){var j=j||this,c=j.find("td.editor-container"),g=j.get(0),b=g.grid,f=g.editingIndex,k=b.get(0).store,e=g.editingId,i=0;if(c.form("validate")){var h=c.form("serialize"),d=null;b.grid("runProgress");if(e!="add"){d=k.getData(e);k.update(e,{old:a.su.json.toJSONString(d),"new":a.su.json.toJSONString(h)},function(){b.grid("prompt",true);j.editor("cancelEdit")},function(){b.grid("prompt",false)},function(){b.grid("prompt",false)})}else{k.insert(i,{old:"add","new":a.su.json.toJSONString(h)},function(){b.grid("prompt",true);j.editor("cancelEdit")},function(){b.grid("prompt",false)},function(){b.grid("prompt",false)})}j.get(0).adding=false}return j},cancelEdit:function(d){var d=d||this,g=d.get(0),c=d.get(0).grid,f=c.get(0),b=g.editingIndex;var e=null;if(b!=="add"){f.rows[b].removeClass("editing");c.grid("enableRow",b)}else{c.find("tr.grid-content-tr.add").remove()}d.editor("hide");g.editing=false;g.editingIndex="";c.grid("updateRowNumber");return d},isEditing:function(b){var b=b||this;if(b.get(0).editing){return true}else{return false}},getEditingId:function(b){var b=b||this;if(b.get(0).editing){return b.get(0).editingId}else{return undefined}}})})(jQuery);