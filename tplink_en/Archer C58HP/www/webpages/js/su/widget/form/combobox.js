(function(a){a.su.Widget("combobox",{defaults:{fieldLabel:"",tips:"",cls:"",readOnly:true,noneSelectedText:a.su.CHAR.OPERATION.NOSELECTEDTEXT,multiSelect:false,displayField:"name",valueField:"value",items:null,store:null,isCombobox:true,allowBlank:true,widgetName:"combobox",tabindex:0},create:function(f,d){var e=this;e.each(function(k,n){var m=a(n);a.extend(n,f,d);if(m.is("select")){var o=m.find("option");n.items=n.items||[];for(var j=0,g=o.length;j<g;j++){n.items.push({value:o[j].value,name:o[j].innerHTML,selected:o[j].selected?"selected":false})}}var l='<div class="container widget-container combobox-container '+(n.multiSelect?"multiple":"single")+" "+n.cls+" "+(n.className||"")+'">';if(this.fieldLabel!==null){l+='<div class="widget-fieldlabel-wrap '+this.labelCls+'">';l+='<label class="widget-fieldlabel combobox-fieldlabel">'+this.fieldLabel+"</label>";if(this.fieldLabel!==""){l+='<span class="widget-separator">'+this.separator+"</span>"}l+="</div>"}l+='<div class="widget-wrap-outer combobox-wrap-outer">';l+='<div class="widget-wrap combobox-wrap">';l+='<span class="text-wrap-before"></span>';l+='<input class="combobox-text '+n.inputCls+'" type="text" tabindex="-1" readonly="true" value="'+n.noneSelectedText+'" />';l+='<a class="combobox-switch" href="javascript:void(0);" tabindex="'+this.tabindex+'">';l+='<span class="icon"></span>';l+="</a>";l+='<div class="combobox-list-wrap">';l+='<div class="position-top-left"></div><div class="position-top-center"></div>';l+='<div class="position-center-left"><div class="position-center-right">';l+='<div class="combobox-list-content-wrap">';l+='<ul class="combobox-list">';l+="</ul>";l+="</div>";l+="</div></div>";l+='<div class="position-bottom-left"></div><div class="position-bottom-center"></div>';l+="</div>";l+='<span class="text-wrap-after"></span>';l+="</div>";if(this.tips!=null&&this.tips!=undefined){l+='<div class="widget-tips combobox-tips '+n.tipsCls+'">';l+='<div class="content tips-content"></div>';l+="</div>"}l+='<div class="widget-error-tips combobox-error-tips '+n.errorTipsCls+'">';l+='<span class="widget-error-tips-delta"></span>';l+='<div class="widget-error-tips-wrap">';l+='<div class="content error-tips-content"></div>';l+="</div>";l+="</div>";l=="</div>";l=="</div>";var h=a(l);m.replaceWith(h);h.prepend(m.addClass("hidden combobox-value").prop("disabled",true));e.combobox("setText")});var b=null;if(e.hasClass("div.combobox-container")){b=e}else{b=e.closest("div.combobox-container")}b.delegate("div.combobox-wrap","click",function(j){j.stopPropagation();var g=a(this).find("a.combobox-switch"),i=g.next("div.combobox-list-wrap"),h=g.closest("div.combobox-container"),k=i.attr("toggleflag")||"hidden";if(h.hasClass("disabled")||h.hasClass("none-items")){return false}h.addClass("focus").removeClass("error");a("div.combobox-list-wrap").hide().attr("toggleflag","hidden");if(k==="hidden"){i.slideDown(150);i.attr("toggleflag","shown")}else{i.hide();i.attr("toggleflag","hidden")}a("div.widget-error-tips.show").css("display","none")}).delegate("label.combobox-label","click",function(k){k.stopPropagation();k.preventDefault();var m=a(this),r=m.closest("li.combobox-list"),g=m.closest("div.combobox-container"),l=m.attr("type"),n=m.find("input.combobox-checkbox"),p=n.val(),i=e.combobox("getValue"),q=[];if(r.hasClass("disabled")){return}switch(l){case"multiple":var o=n.prop("checked");if(o){for(var j=i.length-1;j--;j>=0){if(i[j]==p){i.splice(j,1);break}}}else{q=i.push(p)}e.combobox("select",q);break;case"single":q.push(p);e.combobox("select",q);var h=m.parents("div.combobox-list-wrap");h.hide().attr("toggleflag","hidden");break}g.addClass("selected");g.removeClass("focus");e.trigger("ev_click",[i,q])});b.delegate("input.combobox-text","click",function(g){g.preventDefault()}).delegate("input.combobox-text","focus",function(g){if(b.hasClass("disabled")||b.hasClass("none-items")){return}a(this).combobox("setFocus")}).delegate("input.combobox-text","keyup blur",function(g){if(b.hasClass("disabled")||b.hasClass("none-items")){return}a(this).combobox("validate")}).delegate("input.combobox-value","ev_validatechange",function(h,g){h.stopPropagation();if(g){a(this).combobox("setNormal")}else{a(this).combobox("setError")}});var c=e.get(0).items;e.combobox("loadData",c);e.combobox("setTips",d.tips);e.combobox("setErrorTips","");return e},getSelectedIndex:function(e){var c=e.get(0).items;var f=e.combobox("getValue");var b=c.length;for(var d=0;d<b;d++){if(f[0]===c[d].value){return d}}return -1},loadData:function(f,d){var f=f||this,g=f.get(0),c=f.combobox("getContainer"),d=d[1];c.find("ul.combobox-list").empty();if(!a.isArray(d)){d=[]}g.items=d;for(var e=0,b=d.length;e<b;e++){if(d[e]){f.combobox("initItem",d[e])}}if(d.length==0){c.addClass("none-items")}else{c.removeClass("none-items")}return f},initItem:function(g,j){var g=g||this,b=g.closest("div.combobox-container"),d=g.get(0),l=j[1];var i=d.multiSelect==true?"multiple":"single",n=d.id+"-"+a.su.randomId("option"),f=l[d.displayField],m=l[d.valueField],e=l.disabled?true:false,h=l.selected?true:false,c=l.cls||"";var k="";k+='<li class="combobox-list '+c+" "+(e?"disabled":"")+" "+(h?"selected":"")+'">';k+='<label for="'+n+'" type="'+i+'" class="combobox-label '+i+'">';k+='<input id="'+n+'" name="'+d.name+'" display="'+f+'" class="combobox-checkbox" type="checkbox" value="'+m+'"'+(h?' checked="checked"':"")+" "+(e?'disabled="disabled"':"")+" />";k+='<span class="icon"></span>';k+='<span class="text">'+f+"</span>";k+="</label>";k+="</li>";b.find("ul.combobox-list").append(a(k));if(g.is("select")){g.append('<option value="'+m+'">'+f+"</option>")}g.combobox("setText")},getItem:function(f,g){var f=f||this,h=f.get(0),g=g[1];var c=h.items;var e=null;for(var d=0,b=c.length;d<b;d++){if(c[d]["value"]==g){e=c[d];break}}return e},setText:function(g,c){var g=g||this,b=g.combobox("getContainer"),f=b.find("input.combobox-checkbox"),h=b.find("input.combobox-text");var k=g.combobox("getValue"),d=a.type(k),j="";if(d==="array"){for(var e=0;e<k.length;e++){var i=f.filter("[value='"+k[e]+"']").attr("display");j=j+i+",\x20"}j=j.slice(0,j.length-2)}else{if(d==="string"){var i=f.filter("[value='"+k[e]+"']").attr("display");j=i}}if(j==""){h.val(g.get(0).noneSelectedText)}else{h.val(j)}return g},getSelectedText:function(c){var c=c||this,b=c.closest("div.combobox-container"),d=b.find("input.combobox-text");return d.val()},setValue:function(b,c){var b=b||this,c=c[1];b.combobox("select",c);return b},getValue:function(d){var d=d||this,c=d.combobox("getContainer").find("input.combobox-checkbox");var b=[];c.each(function(e,f){if(f.checked){b.push(a(f).val())}});return b},disable:function(c){var c=c||this,b=c.combobox("getContainer");b.addClass("disabled");b.find("input.combobox-text").attr("disabled",true);b.find("input.combobox-checkbox").prop("disabled",true);return c},enable:function(c){var c=c||this,b=c.combobox("getContainer");b.removeClass("disabled");b.find("input.combobox-text").removeAttr("disabled");b.find("input.combobox-checkbox").prop("disabled",false);return c},disableItem:function(e,d){var e=e||this,c=e.combobox("getContainer"),b=c.find("input.combobox-checkbox"),d=d[1];if(a.type(d)==="string"){d=[d]}var f=(function(){var h={};for(var g=0;g<d.length;g++){h[d[g]]=true}return h})();b.each(function(h,j){var g=a(j);if(g.val() in f){g.closest("li.combobox-list").addClass("disabled");g.attr("disabled",true)}});e.combobox("setText");return e},enableItem:function(e,d){var e=e||this,c=e.combobox("getContainer"),b=c.find("input.combobox-checkbox"),d=d[1];if(a.type(d)==="string"){d=[d]}var f=(function(){var h={};for(var g=0;g<d.length;g++){h[d[g]]=true}return h})();b.each(function(h,j){var g=a(j);if(g.val() in f){g.closest("li.combobox-list").removeClass("disabled");g.attr("disabled",false)}});e.combobox("setText");return e},select:function(f,d){var f=f||this,g=f.get(0),c=f.combobox("getContainer"),b=c.find("input.combobox-checkbox"),d=d[1];var e=f.combobox("getValue").sort();if(a.type(d)==="string"){d=[d]}if(g.multiSelect){var i=(function(){var k={};for(var j=0;j<d.length;j++){k[d[j]]=true}return k})();b.each(function(k,l){var j=a(l);if(j.val() in i){j.closest("li.combobox-list").addClass("selected");l.checked=true}})}else{if(d.length>0){d=d[0]}b.each(function(k,l){var j=a(l);if(j.val()==d){j.closest("li.combobox-list").addClass("selected");l.checked=true}else{j.closest("li.combobox-list").removeClass("selected");l.checked=false}})}var h=f.combobox("getValue").sort();if(e.toString()!=h.toString()){f.trigger("ev_change",[e,h])}f.combobox("setText").val(h);return f},validate:function(e){var e=e||this,c=e.get(0),d=e.combobox("getContainer"),f=d.find("input.combobox-value, select.combobox-value").val(),b=true;if(f==""){if(!c.allowBlank){b=false}}if(c.validator){b=c.validator(f);if(a.type(b)!=="boolean"){b=false}}a(c).trigger("ev_validatechange",b);return b},reset:function(e){var e=e||this,f=e.get(0),d=e.combobox("getContainer"),b=d.find("input.combobox-checkbox"),c=f.defaultValue;b.each(function(h,j){var g=a(j);g.closest("li.combobox-list").removeClass("selected");j.checked=false});e.combobox("setText");if(c!==undefined||c!==null){e.combobox("setValue",c)}else{e.combobox("setValue",[])}return e},selectNoTrigger:function(f,d){var f=f||this,g=f.get(0),c=f.combobox("getContainer"),b=c.find("input.combobox-checkbox"),d=d[1];var e=f.combobox("getValue").sort();if(a.type(d)==="string"){d=[d]}if(g.multiSelect){var h=(function(){var j={};for(var i=0;i<d.length;i++){j[d[i]]=true}return j})();b.each(function(k,l){var j=a(l);if(j.val() in h){j.closest("li.combobox-list").addClass("selected");l.checked=true}})}else{if(d.length>0){d=d[0]}b.each(function(k,l){var j=a(l);if(j.val()==d){j.closest("li.combobox-list").addClass("selected");l.checked=true}else{j.closest("li.combobox-list").removeClass("selected");l.checked=false}})}f.combobox("setText").val(d);return f}})})(jQuery);