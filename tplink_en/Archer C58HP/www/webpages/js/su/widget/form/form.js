(function(a){a.su.Widget("form",{defaults:{fields:[],proxy:null,formEnctype:"application/x-www-form-urlencoded",traditional:false,hiddenFrame:false,submitBtn:null,autoLoad:true,showPrompt:true,sendDisableData:false,promptTextSuccessed:a.su.CHAR.OPERATION.FORM_SAVED,promptTextFailed:a.su.CHAR.OPERATION.FORM_FAILED,cls:""},create:function(e,b){var d=this;d.each(function(n,m){var o=a(m).addClass("form-panel");a.extend(m,e,b);m.id=m.id||a.su.randomId("form");var q=m.proxy;if(q){if(!q.isProxy){q=new a.su.Proxy(q)}m.proxy=q}var g="POST",k="",p=m.hiddenFrame?"_"+m.id+"_iframe":"_self";if(m.proxy){g=m.proxy.writer.type;k=m.proxy.writer.url}if(!o.is("form")){var h=a('<form enctype="'+m.formEnctype+'" method="'+g+'" action="'+k+'" target="'+p+'"></form>');h.append(o.children().detach());o.append(h)}else{o.attr("enctype",m.formEnctype);o.attr("method",g);o.attr("action",k);o.attr("target",p)}o.addClass(m.cls);if(m.hiddenFrame){var l=a('<iframe id="'+p+'" name="'+p+'" class="hidden"></iframe>');l.insertAfter(o)}var f="";if(m.submitBtn){f+='<div class="form-submit button-container submit">';f+='<span class="form-error-tips error"></span>';f+='<div class="form-submit-wrap"></div>';f+='<span class="loading"></span>';f+="</div>"}f+='<div class="form-prompt successed">';f+='<div class="bg"></div>';f+='<div class="content">';f+='<span class="icon"></span>';f+='<span class="text text-successed">'+m.promptTextSuccessed+"</span>";f+='<span class="text text-failed">'+m.promptTextFailed+"</span>";f+="</div>";f+="</div>";var s=a(f);o.append(s);m.isForm=true;if(m.isPanel){m.isFormPanel=true}if(m.autoLoad){o.form("load")}if(m.submitBtn){var r=a.type(m.submitBtn),j=null;if(r==="string"){if(m.submitBtn==="default"){j=a('<button type="button"></button>').button({text:a.su.CHAR.OPERATION.SAVE,cls:"submit",handler:function(i){d.trigger("beforeSubmit");d.form("submit",{},m.callback)}})}else{j=a(m.submitBtn);if(j.length==0){}}}else{if(m.submitBtn.isButton){j=a(m.submitBtn)}else{}}m.submitBtn=j.get(0);if(m.submitBtn&&m.submitBtn.isButton){o.find("div.form-submit-wrap").append(j.button("getContainer"))}else{o.find("div.form-submit-wrap").append(j)}}});var c=a(d.get(0).proxy);c.on("ev_read",function(h,f,g,i){d.form("hideLoading");d.form("loadData",f)}).on("ev_write",function(h,f,g,i){d.form("hideLoading");d.form("loadData",f)}).on("ev_failed",function(i,f,g,h){d.form("hideLoading");d.trigger("ev_failed",[d,f,g,h])});d.on("ev_validatechange",function(h,f,g){h.stopPropagation();if(f==true){d.form("setNormal")}});return d},validate:function(j){var j=j||this,g=j.get(0),h=g.fields,n=true,c=null;j.form("setNormal");a("div.widget-error-tips-wrap").css("display","none");for(var i=0;i<h.length;i++){var l=h[i];if(l){var d=l.name,b=l.mapping||d;if(d){var k=j.find("[name="+d+"]");if(k.length!=0){var e=k.get(0).xtype;if(e){if(!k[e]("getContainer").hasClass("disabled")&&(!k.prop("disabled")||e=="combobox")){if(k[e]("validate")){var f=k.get(0);var m=k[e]("getValue");if(f.textFormat){k[e]("setValue",f.textFormat(m))}continue}else{n=false;c=k.attr("id");break}}}}}}}if(n){if(g.validator&&a.type(g.validator)==="function"){n=g.validator.call(j);if(!n){j.find("div.error input.text-text").each(function(p,q){var o=a(q).closest("div");o.delegate("input.text-text","click",function(r){r.stopPropagation();j.find(".form-error-tips").css("display","none")})})}c="validator"}}j.trigger("ev_validatechange",[n,c]);return n},doSubmit:function(m,e){var m=m||this,h=m.get(0),b=m.is("form")?m:m.find("form");var k=h.traditional,l=m.form("getProxy"),d=e[1]||{},p=e[2]||null,i=e[3]||null,o=e[4]||null,c=(e[5]!==undefined)?e[5]:h.showPrompt;if(k){var n=null;for(var j in d){n=b.find("[name="+j+"]");if(n.length){n.val(d[j])}else{n=a('<input type="hidden" class="hidden" name="'+j+'" value="'+d[j]+'"/>');b.append(n)}}b.submit();var f=a("#"+a(b).attr("target"));f.one("load",function(){if(p){p.call(m)}});return}m.form("showLoading");var g=m.form("serialize");if(l){l.write(a.extend({},g,d),function(s,r,q,t){m.form("hideLoading");if(c){m.form("prompt",true)}if(p){p.call(m,s,r,q,t)}},function(q,r,s){m.form("hideLoading");if(c){m.form("prompt",false)}if(i){i.call(m,q,r,s)}},function(s,q,r){m.form("hideLoading");if(c){m.form("prompt",false)}if(o){o.call(m,s,q,r)}})}},submit:function(k,e){var k=k||this,f=k.get(0),b=k.is("form")?k:k.find("form"),i=f.traditional,j=k.form("getProxy"),d=e[1]||{},m=e[2]||null,h=e[3]||null,l=e[4]||null,c=(e[5]!==undefined)?e[5]:f.showPrompt,g=e[6]===false?false:true;if(g!==false){if(!k.form("validate")){return false}}k.form("doSubmit",d,m,h,l,c,g)},load:function(c,d){var c=c||this;var b=c.get(0).proxy;if(b){b.read()}},loadData:function(j,e){var j=j||this,g=e[1]||[],h=j.get(0).fields;j.trigger("ev_beforeLoadData",g);j.data("data",g);for(var i=0;i<h.length;i++){var k=h[i];if(k){var c=k.name,b=k.mapping||c;if(c){var f=j.find("[name="+c+"]");if(f.length!=0){var d=f.get(0).xtype;if(d){var l=g[b];if(l!==undefined){f[d]("setValue",l)}else{continue}}}}}}j.trigger("ev_loadData",g)},getProxy:function(c){var c=c||this,b=c.get(0).proxy;if(b&&b.isProxy){return b}else{return null}},serialize:function(i){var i=i||this,c=i.is("form")?i:i.find("form");var e=i.get(0).sendDisableData?c.find(":input:disabled").removeAttr("disabled"):a();var f=c.serializeArray(),d={};e.attr("disabled","disabled");for(var g=0;g<f.length;g++){var h=f[g],b=h.name,j=h.value;d[b]=j}return d},reset:function(h){var h=h||this,e=h.get(0),f=e.fields;for(var g=0;g<f.length;g++){var i=f[g];if(i){var c=i.name,b=i.mapping||c;if(c){var j=h.find("[name="+c+"]");if(j.length!=0){var d=j.get(0).xtype;if(d){j[d]("reset")}}}}}h.trigger("ev_reset");return h},prompt:function(j,f){var j=j||this,h=j.get(0),q=j.find("div.form-submit"),c=j.get(0).showPrompt,i=f[1],o=f[2],d=f[3]||900,m=j.find("div.form-prompt");var n=m.outerHeight(),b=m.outerWidth(),g=j.innerHeight()-q.height(),k=j.innerWidth()-q.height();var e=parseInt((k-b)/2,10);var p=parseInt((g-n)/2,10);m.css({left:e,top:p});if(i){m.removeClass("failed").addClass("successed");o=o||h.promptTextSuccessed;m.find("span.text-successed").html(o)}else{m.removeClass("successed").addClass("failed");o=o||h.promptTextFailed;m.find("span.text-failed").html(o)}m.fadeIn("150",function(){setTimeout(function(){m.fadeOut("150")},d)});return j},getContainer:function(b){var b=b||this;return b},setError:function(d,b){var d=d||this;var b=b[1];if(b){var c=d.find("span.form-error-tips");c.html(b).fadeIn(150)}return d},setNormal:function(i){var i=i||this,f=i.get(0),g=f.fields;for(var h=0;h<g.length;h++){var j=g[h];if(j){var c=j.name,b=j.mapping||c;if(c){var k=i.find("[name="+c+"]");if(k.length!=0){var d=k.get(0).xtype;if(d){k[d]("setNormal")}}}}}var e=i.find("span.form-error-tips");e.css("display","none");return i},showLoading:function(c){var c=c||this,d=c.get(0),b=a(d.submitBtn);b.button("disable");b.closest("div.form-submit").find("span.loading").fadeIn(50);return c},hideLoading:function(c){var c=c||this,d=c.get(0),b=a(d.submitBtn);b.button("enable");b.closest("div.form-submit").find("span.loading").fadeOut(50);return c},enable:function(j,l){var j=j||this,e=j.get(0),d=a(e.submitBtn),g=e.fields,l=l[1];for(var h=0,i=g.length;h<i;h++){var k=g[h];if(k){var b=k.name;var f=j.find('[name="'+b+'"]');if(f.length>0){var c=f.get(0).xtype;if(c&&(f.prop("inFront")!="no")){f[c]("enable")}}}}if(d.length>0){d.button("enable")}if(l){l.call(j)}return j},disable:function(j,l){var j=j||this,e=j.get(0),d=a(e.submitBtn),g=e.fields,l=l[1];for(var h=0,i=g.length;h<i;h++){var k=g[h];if(k){var b=k.name;var f=j.find('[name="'+b+'"]');if(f.length>0){var c=f.get(0).xtype;if(c&&(f.prop("inFront")!="no")){f[c]("disable")}}}}if(d.length>0){d.button("disable")}if(l){l.call(j)}return j}})})(jQuery);