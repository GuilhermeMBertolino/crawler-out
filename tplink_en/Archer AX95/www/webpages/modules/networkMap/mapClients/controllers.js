!function(p){p.su.moduleManager.define("mapClients",{services:["ajax","timer","device","vtype"],deps:["networkMap","navigatorController"],models:["statusAll","accessControl","accessControlEnableM","speedLimitModel"],stores:["connectedClientsStore","onlineDeviceStore","bandwidthUnitStore","speedLimitDownloadStore","speedLimitUploadStore"],views:["mapClientsView"],listeners:{ev_on_launch:function(e,t,i,a,n,s,o){this.unRegisterAutoSaveData([n.connectedClientsStore,n.onlineDeviceStore,a.speedLimitModel]),"router"===o.device.getCurrentMode()&&o.ajax.request({proxy:"getSpeedLimitMaxProxy",data:{operation:"read_max"},success:function(e){t.currentDownloadLimitMax=(parseInt(e.downloadLimitMax)/1024).toFixed(0),t.currentUploadLimitMax=(parseInt(e.uploadLimitMax)/1024).toFixed(0),t.speedLimitMaxRules=parseInt(e.max_rules)}}),t.getClients(),"router"==o.device.getCurrentMode()?t.getAccessControlMode({success:function(e){"black"===e.accessMode?i.mapClientsView.mapClientsAccessControlBtn.setText(p.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST):i.mapClientsView.mapClientsAccessControlBtn.setText(p.su.CHAR.NETWORK_MAP.VIEW_WHITELIST),i.mapClientsView.blockConfirmMsg.setContent(p.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST)}}):(i.mapClientsView.mapClientsAccessControlBtn.hide(),n.connectedClientsStore.hideColumn("downloadSpeed"),n.connectedClientsStore.hideColumn("block"),n.connectedClientsStore.hideColumn("action-column"))},ev_before_destroy:function(e,t){t.beforeDestroy()}},init:function(l,d,c,r,t,a){var m=a.device.getConfig().supportSpeedLimit&&"router"===a.device.getCurrentMode(),s={"24G":{type:"2g",text:"G24"},"5G":{type:"5g",text:"G5"},"51G":{type:"5g-1",text:"G5_1"},"52G":{type:"5g-2",text:"G5_2"},"6G":{type:"6g",text:"G6"}};this.configViews({id:"mapClientsView",items:[{id:"connected-clients-grid",cls:" container widget-container "+(m?"speed-limit-grid ":""),configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){e="<div>"+e;return e+='<div class="phone edit" deviceName="'+t.deviceName+'" mac="'+t.mac+'"></div></div>'}},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){var i="",i=(i=(i+=l.generateDeviceIcon(t))+'<div class="device-info-container widget-container">'+('<div class="mac">'+t.mac+"</div>"))+('<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>");return m&&(i+='<span class="mode show_'+l.detectNetworkMode(t.deviceTag)+'"></span>'),i+="</div>"}},{text:m?p.su.CHAR.NETWORK_MAP.DEVICE_INFO:p.su.CHAR.NETWORK_MAP.TYPE,dataIndex:"deviceName",width:m?220:"10%",cls:"s-hide",renderer:function(e,t){var i="";return i+=l.generateDeviceIcon(t),i=m&&"object"===p.type(t)?(i=(i=(i=(i+='<div class="device-info-container widget-container">')+'<div class="name" title="'+e+'">'+e+'</div><div class="mac">'+t.mac+"</div>")+'<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>")+'<span class="mode show_'+l.detectNetworkMode(t.deviceTag)+'"></span>')+'<div class="edit" deviceName="'+e+'" mac="'+t.mac+'"></div></div>':i}},{text:p.su.CHAR.NETWORK_MAP.INFORMATION,dataIndex:"deviceName",cls:"s-hide",hideColumn:m,renderer:function(e,t){var i="";return i="object"===p.type(t)?(i=(i=(i+='<div class="device-info-container widget-container">')+'<div class="name" title="'+e+'">'+e+'</div><div class="mac">'+t.mac+"</div>")+'<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>")+'<div class="edit" deviceName="'+e+'" mac="'+t.mac+'"></div></div>':i}},{text:p.su.CHAR.NETWORK_MAP.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,t){var i,a;return m&&!1===t.speedLimitOnline?'<div class="real-time-offline">---</div>':(i="","object"===p.type(t)&&(a=l.convertSpeedVal(t.downloadSpeed),i=(i=(i=(i=(i+='<div class="speed-upload-container widget-container">')+'<span class="icon"></span><span class="text">'+(t=l.convertSpeedVal(t.uploadSpeed)).speed+"</span>")+'<span class="unit">'+t.unit+'</span></div><div class="speed-download-container widget-container">')+'<span class="icon"></span><span class="text">'+a.speed+"</span>")+'<span class="unit">'+a.unit+"</span></div>"),i)}},{text:p.su.CHAR.NETWORK_MAP.INTERFACE,dataIndex:"deviceTag",width:"15%",cls:"center-td s-2-col",hideColumn:m,renderer:function(e,t){var i=l.detectNetworkMode(t.deviceTag),a="",n="";if(!i)return"---";switch(i){case"LAN":a="<span class='icon icon-interface'></span>";break;case"offline":a=p.su.CHAR.NETWORK_MAP.OFFLINE;break;default:a="<span class='icon icon-wireless signal-%signal%'></span><span class='text text-%mode%'>%text%</span>".replace("%signal%",t.signal).replace("%mode%",s[i]["type"]).replace("%text%",p.su.CHAR.NETWORK_MAP[s[i]["text"]])}return(n+='<div class="interface-container widget-container">')+a+"</div>"}},{text:p.su.CHAR.NETWORK_MAP.TXRX,dataIndex:"txrate",cls:"center-td",width:"15%",renderer:function(e,t){var i,a;return m&&!1===t.speedLimitOnline?"---":(i='<div class="interface-container widget-container">',a="---","wired"!==t.deviceTag&&"offline"!==t.deviceTag&&null!=e&&(i+="<span class='icon icon-wireless signal-"+t.signal+"'></span>",-1!==e.indexOf("-")&&-1!==t.rxrate.indexOf("-")||(a=e+" / "+t.rxrate)),m?(i+='<span class="text">')+a+"</span></div>":a)}},{text:p.su.CHAR.NETWORK_MAP.DURATION,dataIndex:"remainTime",width:"15%",cls:"center-td "+(m?"":"s-last-td"),renderer:function(e,t){var i,a,n;return m&&!1===t.speedLimitOnline?"---":(t=t.duration,n="",n+='<div class="duration-container widget-container">',i=parseInt(t/86400,10),a=parseInt(t%86400/3600,10),t=parseInt(t%3600/60,10),1===i?n=n+i+" "+p.su.CHAR.NETWORK_MAP.DAY+" ":1<i&&(n=n+i+" "+p.su.CHAR.NETWORK_MAP.DAYS+" "),(n=(n=0<a?n+a+" "+p.su.CHAR.NETWORK_MAP.H+" ":n)+t+" "+p.su.CHAR.NETWORK_MAP.MIN)+"</div>")}},{text:p.su.CHAR.NETWORK_MAP.SPEED_LIMIT,dataIndex:"enableLimit",cls:"s-last-td center-td",hideColumn:!m,renderer:function(e,t){var i,a,n;return!0===t.isGuest?"---":(a=l.convertSpeedLimitVal(t.downloadLimit,!(i="")),n=l.convertSpeedLimitVal(t.uploadLimit,!0),i+='<div class="speed-limit-info-container">',"object"===p.type(t)&&"off"!==e?(i+='<div class="speed-upload-container widget-container"><span class="icon"></span>',-1!==t.uploadLimit?i=(i+='<span class="text">'+n.speed+"</span>")+'<span class="unit">'+n.unit+"</span>":i+="---",i+='</div><div class="speed-download-container widget-container"><span class="icon"></span>',-1!==t.downloadLimit?i=(i+='<span class="text">'+a.speed+"</span>")+'<span class="unit">'+a.unit+"</span>":i+="---",i+="</div>"):i+='<div class="empty-content">---</div>',i+('<div class="edit-limit" key="'+t.key)+'"></div></div>')}},{text:p.su.CHAR.NETWORK_MAP.BLOCK,xtype:"actioncolumn",dataIndex:"block",width:"10%",renderer:function(e,t){if(m&&!1===t.speedLimitOnline)return"---";for(var i=r.onlineDeviceStore.getData(),a="",n=0,s=i.length;n<s;n++)i[n].mac==t.mac&&(a="HOST"==i[n].host?"disabled":"");var o="";return o+('<a href="javascript:void(0)" class="grid-content-btn btn-block '+a+'">')+'<span class="icon"></span>'+'<span class="text"></span>'+"</a>"}}]}}]}),this.control({"#connected-clients-grid => .btn-block":{ev_grid_action_click:function(e,t){-1<e.target.className.indexOf("disable")||(e=r.connectedClientsStore.getModelByKey(t),l.blockData={key:e.key.getValue(),deviceType:e.deviceType.getValue(),name:e.deviceName.getValue(),mac:e.mac.getValue(),ipaddr:e.ip.getValue(),conn_type:"wireless",host:"NOT HOST"},d.mapClientsView.blockConfirmMsg.show())}},"#connected-clients-grid => .edit":{click:function(e,t){d.mapClientsView.clientNameMsg.show(),d.mapClientsView.clientNameModelAlias.setValue(p(e.currentTarget).attr("deviceName")),d.mapClientsView.clientNameModelMac.setValue(p(e.currentTarget).attr("mac"))}},"#client-name-msg":{ev_msg_ok:function(e,t){var i;!0===l.checkDeviceName(d.mapClientsView.clientNameModelAlias.getValue())?(a.ajax.request({data:{operation:"write",mac:d.mapClientsView.clientNameModelMac.getValue(),alias:d.mapClientsView.clientNameModelAlias.getValue()},proxy:"changeDeviceNameProxy",success:function(e){p.each(r.connectedClientsStore.getData(),function(e,t){t.mac==d.mapClientsView.clientNameModelMac.getValue()&&(p("[data-key="+t.key+"] .device-info-container .name").text(d.mapClientsView.clientNameModelAlias.getValue()),p("#connected-clients-grid_tr_"+t.key+"_td_1 .content div").html(d.mapClientsView.clientNameModelAlias.getValue()+'<div class="phone edit" devicename="'+d.mapClientsView.clientNameModelAlias.getValue()+'" mac="'+d.mapClientsView.clientNameModelMac.getValue()+'"></div>'))})}}),d.mapClientsView.clientNameMsg.hide()):(i=p.su.CHAR.VTYPETEXT.DEVICE_NAME_INVALID,(d.mapClientsView.clientNameModelAlias.getValue().length<1||64<d.mapClientsView.clientNameModelAlias.getValue().length)&&(i=p.su.CHAR.VTYPETEXT.LEN_MIN_MAX.replace("%min",1).replace("%max",64)),d.mapClientsView.clientNameModelAlias.setError(i)),t.preventDefault()},ev_msg_cancel:function(e,t){}},"#map-clients-access-control-btn":{ev_button_click:function(e){t.navigatorController.goTo("accessControl")}},"#block-confirm-msg":{ev_msg_ok:function(e){l.blockDevice(l.blockData)}},"#connected-clients-grid => .edit-limit":{click:function(e,t){for(var i=r.connectedClientsStore.getData(),a=0,n=0;n<i.length;n++)"on"==i[n].enableLimit&&a++;t=p(e.currentTarget).attr("key"),e=r.connectedClientsStore.getModelByKey(t);if(a>=l.speedLimitMaxRules&&"off"==e.enableLimit.getValue())d.mapClientsView.speedLimitMaxRulesTip.setText(p.su.CHAR.NETWORK_MAP.MAX_RULES_WARN.replace("%max%",l.speedLimitMaxRules)),d.mapClientsView.speedLimitMaxRulesMsg.show();else{c.speedLimitModel.mac.setValue(e.mac.getValue()),c.speedLimitModel.enableLimit.setValue(e.enableLimit.getValue()),d.mapClientsView.speedLimitMsg.show(),!0===e.enablePriority.getValue()?l.currentEnablePriority=!0:l.currentEnablePriority=!1;var s=e.downloadLimit.getValue(),o=e.uploadLimit.getValue();if(c.speedLimitModel.downloadLimit.setValue(""),c.speedLimitModel.downloadLimitUnit.setValue("mbps"),c.speedLimitModel.uploadLimit.setValue(""),c.speedLimitModel.uploadLimitUnit.setValue("mbps"),-1===s)c.speedLimitModel.downloadLimitType.setValue("none");else switch(s){case 0:c.speedLimitModel.downloadLimitType.setValue("none");break;case 1024:c.speedLimitModel.downloadLimitType.setValue("1mbps");break;case 10240:c.speedLimitModel.downloadLimitType.setValue("10mbps");break;default:c.speedLimitModel.downloadLimitType.setValue("custom"),s<1024?(c.speedLimitModel.downloadLimit.setValue(s.toFixed(0)),c.speedLimitModel.downloadLimitUnit.setValue("kbps")):(c.speedLimitModel.downloadLimit.setValue((s/1024).toFixed(0)),c.speedLimitModel.downloadLimitUnit.setValue("mbps"))}if(-1===o)c.speedLimitModel.uploadLimitType.setValue("none");else switch(o){case 0:c.speedLimitModel.uploadLimitType.setValue("none");break;case 200:c.speedLimitModel.uploadLimitType.setValue("200kbps");break;case 2048:c.speedLimitModel.uploadLimitType.setValue("2mbps");break;default:c.speedLimitModel.uploadLimitType.setValue("custom"),o<1024?(c.speedLimitModel.uploadLimit.setValue(o.toFixed(0)),c.speedLimitModel.uploadLimitUnit.setValue("kbps")):(c.speedLimitModel.uploadLimit.setValue((o/1024).toFixed(0)),c.speedLimitModel.uploadLimitUnit.setValue("mbps"))}}}},"#speed-limit-enable":{ev_view_change:function(e,t,i){"on"==t.value&&1==l.currentEnablePriority&&d.mapClientsView.speedLimitPriorityMsg.show()}},"#speedlimit-priority-conflict-msg":{ev_msg_ok:function(e){},ev_msg_cancel:function(e){c.speedLimitModel.enableLimit.setValue("off")}},"#speed-limit-msg":{ev_msg_ok:function(e,t){return c.speedLimitModel.validate()?"none"==c.speedLimitModel.downloadLimitType.getValue()&&"none"==c.speedLimitModel.uploadLimitType.getValue()?(c.speedLimitModel.downloadLimitType.setError(p.su.CHAR.NETWORK_MAP.NO_LIMITS_ERROR),t.preventDefault()):void c.speedLimitModel.submit({success:function(){r.connectedClientsStore.load({data:{operation:"loadDevice"}})}}):t.preventDefault()}}}),this.listen({"models.speedLimitModel.enableLimit":{ev_value_change:function(e,t,i){"on"==t?(d.mapClientsView.speedLimitEditBlock.show(),"custom"==c.speedLimitModel.downloadLimitType.getValue()?(d.mapClientsView.downloadLimitCustom.show(),d.mapClientsView.downloadLimitCustom.enable()):(d.mapClientsView.downloadLimitCustom.hide(),d.mapClientsView.downloadLimitCustom.disable()),"custom"==c.speedLimitModel.uploadLimitType.getValue()?(d.mapClientsView.uploadLimitCustom.show(),d.mapClientsView.uploadLimitCustom.enable()):(d.mapClientsView.uploadLimitCustom.hide(),d.mapClientsView.uploadLimitCustom.disable())):d.mapClientsView.speedLimitEditBlock.hide()}},"models.speedLimitModel.downloadLimitType":{ev_value_change:function(e,t,i){switch(d.mapClientsView.downloadLimitCustom.hide(),d.mapClientsView.downloadLimitCustom.disable(),t){case"1mbps":c.speedLimitModel.downloadLimitType.setTips(p.su.CHAR.NETWORK_MAP.SPEED_1_MBPS_TIPS);break;case"10mbps":c.speedLimitModel.downloadLimitType.setTips(p.su.CHAR.NETWORK_MAP.SPEED_10_MBPS_TIPS);break;case"custom":d.mapClientsView.downloadLimitCustom.show(),d.mapClientsView.downloadLimitCustom.enable(),c.speedLimitModel.downloadLimitType.setTips("");break;default:c.speedLimitModel.downloadLimitType.setTips("")}}},"models.speedLimitModel.uploadLimitType":{ev_value_change:function(e,t,i){d.mapClientsView.uploadLimitCustom.hide(),d.mapClientsView.uploadLimitCustom.disable(),"custom"==t&&(d.mapClientsView.uploadLimitCustom.show(),d.mapClientsView.uploadLimitCustom.enable())}},"models.speedLimitModel.downloadLimitUnit":{ev_value_change:function(e,t,i){"kbps"===t?(c.speedLimitModel.downloadLimit.setTips("(1-1024)"),c.speedLimitModel.downloadLimit.setVtype({vtype:"number",min:1,max:1024})):(c.speedLimitModel.downloadLimit.setTips("(1-"+l.currentDownloadLimitMax+")"),c.speedLimitModel.downloadLimit.setVtype({vtype:"number",min:1,max:l.currentDownloadLimitMax}))}},"models.speedLimitModel.uploadLimitUnit":{ev_value_change:function(e,t,i){"kbps"===t?(c.speedLimitModel.uploadLimit.setTips("(1-1024)"),c.speedLimitModel.uploadLimit.setVtype({vtype:"number",min:1,max:1024})):(c.speedLimitModel.uploadLimit.setTips("(1-"+l.currentUploadLimitMax+")"),c.speedLimitModel.uploadLimit.setVtype({vtype:"number",min:1,max:l.currentUploadLimitMax}))}}})}},function(a,i,n,s,o,l){return{delayInterval:0,currentEnablePriority:!1,currentDownloadLimitMax:1e3,currentUploadLimitMax:1e3,speedLimitMaxRules:0,isTriband:l.device.getIsTriband(),getClients:function(){a.getClientsInterval=l.timer.setInterval(a,function(){var e;"clients"!=o.networkMap.getCurrentModule()||i.mapClientsView.clientNameMsg.viewObjs[0].settings.shown||i.mapClientsView.blockConfirmMsg.viewObjs[0].settings.shown||0<a.delayInterval||(a.delayInterval=1,e={data:{operation:"loadSpeed"},success:function(e){a.delayInterval=0,o.networkMap.trigger("ev_clients_number_changed",s.connectedClientsStore.getData().length)},fail:function(){a.delayInterval=0},error:function(){a.delayInterval=0}},s.onlineDeviceStore.load({url:p.su.url("/admin/access_control?form=black_devices")}),s.connectedClientsStore.load(e))},20011,!0)},getAccessControlMode:function(e){var t;e&&(t=e.success),s.onlineDeviceStore.load({url:p.su.url("/admin/access_control?form=black_devices")}),n.accessControlEnableM.load(),n.accessControl.load({success:function(e){t&&t(n.accessControl.getData())}})},setBlackMode:function(t){"off"==n.accessControlEnableM.enable.getValue()&&n.accessControlEnableM.load({data:{operation:"write",enable:"on"}}),n.accessControl.load({data:{operation:"write",access_mode:"black"},success:function(e){i.mapClientsView.mapClientsAccessControlBtn.setText(p.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST),i.mapClientsView.blockConfirmMsg.setContent(p.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST),t&&t()}})},blockDevice:function(e){function t(){l.ajax.request({data:{operation:"block",data:JSON.stringify([e]),index:s.connectedClientsStore.getIndex(e.key),key:e.key},url:p.su.url("/admin/access_control?form=black_devices"),success:function(){s.onlineDeviceStore.load({url:p.su.url("/admin/access_control?form=black_devices"),success:function(){s.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){o.networkMap.trigger("ev_clients_number_changed",s.connectedClientsStore.getData().length)}})}})}})}"on"==n.accessControlEnableM.enable.getValue()&&"black"==n.accessControl.accessMode.getValue()?t():a.setBlackMode(t)},beforeDestroy:function(){clearInterval(null)},getIPaddr:function(e){if(deviceStatusData)for(var t in deviceStatusData)for(var i=0,a=deviceStatusData[t].length;i<a;i++)if(deviceStatusData[t][i].macaddr==e)return deviceStatusData[t][i].ipaddr||"";return""},getConnectType:function(e){if(deviceStatusData)for(var t in deviceStatusData)for(var i=0,a=deviceStatusData[t].length;i<a;i++)if(deviceStatusData[t][i].macaddr==e)return t;return""},getSignal:function(e,t){var i;l.ajax.request({data:{operation:"read",mac:e,type:"wireless"},proxy:"clientSignalProxy",success:function(e){i=a.convertSignal(e.signal),p("#connected-clients-grid_tr_"+t+" .icon-wireless").addClass("signal-"+i)}})},convertSignal:function(e){e=+e+91;return e<=0?0:e<10?1:e<20?2:e<30?3:e<50?4:5},checkDeviceName:function(e){return 0<e.length&&e.length<65&&l.vtype.validate(e,{vtype:"deviceName"})},convertSpeedVal:function(e,t){e=parseInt(e,10)*(t?1024:8);var i,t={};return t.speed=e,t.unit=p.su.CHAR.NETWORK_MAP.KBPS_BIT,0!==e&&(i=(e=e/1024)/1024,e<1?t.speed=e.toFixed(2):i<1?t.speed=e<1e3?e.toFixed(1):Math.floor(e):(t.speed=i.toFixed(1),t.unit=p.su.CHAR.NETWORK_MAP.MBPS_BIT)),t},convertSpeedLimitVal:function(e,t){var e=parseInt(e,10),i=e<1024?p.su.CHAR.NETWORK_MAP.KBPS_BIT:(e=(e/1024).toFixed(0),p.su.CHAR.NETWORK_MAP.MBPS_BIT);return{speed:e,unit:i}},generateDeviceIcon:function(e){var t="",t=(t=(t+='<div class="device-type-container widget-container">')+('<span class="icon '+a.detectDeviceType(e.deviceType)+' ">')+('<span class="'+(e.speedLimitOnline?"online-tag":"offline-tag")+'"></span>'))+('<span class="guest-tag '+(e.isGuest?"":"hidden")+'"></span>')+"</span>";return null!=e.enableInternet&&(t+='<span class="text">'+(e.enableInternet?"":p.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),t+="</div>"},detectDeviceType:function(e){return"other"===(e=e.toLowerCase())?"icon-pc":"icon-"+e},detectNetworkMode:function(e){var t="";switch(e){case"2.4G":case"2.4G_guest":t="24G";break;case"5G":case"5G_guest":t=l.device.getIsTriband()?"51G":"5G";break;case"5G_1":case"5G_1_guest":t="51G";break;case"5G_2":case"5G_2_guest":t="52G";break;case"6G":t="6G";break;case"wired":t="LAN";break;case"unknown":t="";break;default:t="offline"}return t}}})}(jQuery);