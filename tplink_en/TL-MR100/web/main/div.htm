<script language="JavaScript">function initConnTypeSelect(t){var e=$("#link_type").data("value"),n="<option value='staticIp' text='"+s_str.staip+"'>"+s_str.staip+"</option><option value='dynamicIp' text='"+s_str.dynip+"'>"+s_str.dynip+"</option><option value='pppoe' text='"+s_str.pppoe+"'>"+s_str.pppoe+"</option>";"DSL"==$.sysMode&&"ATM"==t&&(n+="<option value='pppoa' text='"+s_str.pppoa+"'>"+s_str.pppoa+"</option><option value='ipoa' text='"+s_str.ipoa+"'>"+s_str.ipoa+"</option>"),INCLUDE_L2TP&&(n+="<option value='l2tp' text='"+s_str.l2tp+"'>"+s_str.l2tp+"</option>"),INCLUDE_PPTP&&(n+="<option value='pptp' text='"+s_str.pptp+"'>"+s_str.pptp+"</option>"),n+="<option value='bridge' text='"+s_str.bridge+"'>"+s_str.bridge+"</option>",$("#link_type").empty().append(n),e&&$("#link_type option[value='"+e+"']").prop("selected","selected");var d={refresh:1};$("#link_type").tpSelect(d)}function initDiv(){$("input[type='text'].mac-address").tpAddress({connector:"-",connectorReal:":",cellLength:2,cellNumber:6}),(INCLUDE_VDSLWAN||INCLUDE_LTEWAN)&&($("#link_type option[value='pppoa']").remove(),$("#link_type option[value='ipoa']").remove()),INCLUDE_LTEWAN&&$("#link_type option[value='bridge']").remove(),"DSL"==$.sysMode?($.loadPage("divDslCfg","dsl.htm"),$("#divDslCfg").removeClass("nd")):$.loadPage("eth-cfg","eth.htm");var t=$.wd.editIndex==$.wd.conn.length?"pppoe":$.wd.conn[$.wd.editIndex].type;if($("#link_type option[value='"+t+"']").prop("selected","selected"),$.wd.editIndex==$.wd.conn.length){$("#addLinkType").removeClass("nd");var e={type:null,obj:{},dsl:{},ptm:{}};$.wd.conn.push(e)}else"DSL"==$.sysMode?$("#editLinkType").removeClass("nd"):$("#addLinkType").removeClass("nd"),"bridge"==$.wd.conn[$.wd.editIndex].type&&$("#saveBtn").prop("disabled",!0);$("#link_type").tpSelect({refresh:1}),doSync(t),initMacClone()}function detectPvcConflict(){var t,e="PVC:"+$("#vpi").val()+"/"+$("#vci").val(),n=$.act(ACT_GL,WAN_DSL_LINK_CFG,null,null,["destinationAddress","linkType","ATMPeakCellRate","ATMMaximumBurstSize","ATMSustainableCellRate","ATMEncapsulation","ATMQoS"]);if(!$.exe())for(var d=0;d<n.length;d++)if(n[d].destinationAddress==e)return t=$.act(ACT_GET,WAN_CONN_DEVICE,n[d].__stack,null),void($.exe()||(t.WANIPConnectionNumberOfEntries>0||t.WANPPPConnectionNumberOfEntries>0)&&disablePvcParam(n[d].linkType))}function doSync(t){switch(t){case"staticIp":$.loadPage("divStaIp","staticIp.htm",function(){},function(){$("#divStaIp").show("fast")}),$("#divDynIp").hide("fast"),$("#divPPPoE").hide("fast"),$("#divPPPoA").hide("fast"),$("#divIPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("Static IP");break;case"dynamicIp":$.loadPage("divDynIp","dynamicIp.htm",function(){},function(){$("#divDynIp").show("fast")}),$("#divStaIp").hide("fast"),$("#divPPPoE").hide("fast"),$("#divPPPoA").hide("fast"),$("#divIPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("Dynamic IP");break;case"pppoe":$.loadPage("divPPPoE","pppoe.htm",function(){},function(){$("#divPPPoE").show("fast")}),$("#divStaIp").hide("fast"),$("#divDynIp").hide("fast"),$("#divPPPoA").hide("fast"),$("#divIPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("PPPoE");break;case"pppoa":$.loadPage("divPPPoA","pppoa.htm",function(){},function(){$("#divPPPoA").show("fast")}),$("#divStaIp").hide("fast"),$("#divDynIp").hide("fast"),$("#divPPPoE").hide("fast"),$("#divIPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("PPPoA");break;case"ipoa":$.loadPage("divIPoA","ipoa.htm",function(){},function(){$("#divIPoA").show("fast")}),$("#divStaIp").hide("fast"),$("#divDynIp").hide("fast"),$("#divPPPoE").hide("fast"),$("#divPPPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("IPoA");break;case"l2tp":$.loadPage("divL2TP","l2tp.htm",function(){},function(){$("#divL2TP").show("fast")}),$("#divStaIp").hide("fast"),$("#divDynIp").hide("fast"),$("#divPPPoE").hide("fast"),$("#divIPoA").hide("fast"),$("#divPPPoA").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("L2TP");break;case"pptp":$.loadPage("divPPTP","pptp.htm",function(){},function(){$("#divPPTP").show("fast")}),$("#divStaIp").hide("fast"),$("#divDynIp").hide("fast"),$("#divPPPoE").hide("fast"),$("#divIPoA").hide("fast"),$("#divPPPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#linkTypeText").html("PPTP");break;case"bridge":$("#divStaIp").hide("fast"),$("#divDynIp").hide("fast"),$("#divPPPoE").hide("fast"),$("#divPPPoA").hide("fast"),$("#divIPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("Bridge");break;default:$.loadPage("divPPPoE","pppoe.htm",function(){},function(){$("#divPPPoE").show("fast")}),$("#divStaIp").hide("fast"),$("#divDynIp").hide("fast"),$("#divPPPoA").hide("fast"),$("#divIPoA").hide("fast"),$("#divL2TP").hide("fast"),$("#divPPTP").hide("fast"),$("#linkTypeText").html("PPPoE")}if(null==$.wd.conn[$.wd.editIndex].type&&(!INCLUDE_VDSLWAN||0==curSetIsPtm)&&$("#atm_encapsulation")){if(INCLUDE_LTEWAN&&"ETH"==$.sysMode||detectPvcConflict(),$("#p_note")&&!$("#p_note").hasClass("nd"))return void $("#vpi").focus().select();var e="pppoa"==t?"VCMUX":"LLC";$("#atm_encapsulation option[value='"+e+"']").prop("selected","selected"),$("#atm_encapsulation").tpSelect({refresh:1})}}function isConnDeviceExist(){var t=0;if("DSL"==$.sysMode){for(t=0;t<dsllinkcfglist.length;t++)if(INCLUDE_VDSLWAN&&1==curSetIsPtm){if(1==ptmlinkcfglist[t].X_TP_Used&&ptmlinkcfglist[t].X_TP_VID==wanPtm.X_TP_VID)return ptmlinkcfglist[t].__stack}else if(dsllinkcfglist[t].destinationAddress==wanDsl.destinationAddress)return dsllinkcfglist[t].__stack}else if("ETH"==$.sysMode)for(t=0;t<ethlinkcfglist.length;t++)if(1==ethlinkcfglist[t].enable&&ethlinkcfglist[t].X_TP_VID==wanEth.X_TP_VID&&$.wd.conn[$.wd.editIndex].ewan&&ethlinkcfglist[t].__stack!=$.wd.conn[$.wd.editIndex].ewan.__stack)return ethlinkcfglist[t].__stack;return""}function newConnApply(t,e,n,d){var a;"ETH"==$.sysMode&&$.act(ACT_SET,WAN_ETH_LINK_CFG,e.__stack,null,wanEth),"l2tp"!=t&&"pptp"!=t&&1==n&&s_str.cur_con==dftGtw6.data("text")&&(wanArg.X_TP_PDEnabled=1),a="l2tp"==t?$.act(ACT_ADD,WAN_L2TP_CONN,null,e.__stack,wanArg):"pptp"==t?$.act(ACT_ADD,WAN_PPTP_CONN,null,e.__stack,wanArg):$.act(ACT_ADD,t.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,null,e.__stack,wanArg),$.exe(function(n){if(!n)return"bridge"==t?($.removeLoading(),void $.loadMain("wan.htm")):(conn="l2tp"==t?$.act(ACT_GET,WAN_L2TP_CONN,a.__stack,null,["name"]):"pptp"==t?$.act(ACT_GET,WAN_PPTP_CONN,a.__stack,null,["name"]):$.act(ACT_GET,t.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,a.__stack,null,["name"]),void $.exe(function(e){e||($.wd.originIfAliasName!=dftGtw.data("text")&&("DSL"==$.sysMode?$.act(ACT_SET,LOCAL,null,null,{ispIndex:-1}):$.act(ACT_SET,LOCAL,null,null,{ewanIspIndex:-1})),s_str.cur_con==dftGtw.data("text")?$.wd.l3ForwardingObj.__ifAliasName=conn.name:$.wd.l3ForwardingObj.__ifAliasName=dftGtw.data("text"),"l2tp"==t||"pptp"==t?$.act(ACT_SET,L3_FORWARDING,null,null,$.wd.l3ForwardingObj):INCLUDE_IPV6&&1!=wanArg.X_TP_IPv4Enabled||$.act(ACT_SET,L3_FORWARDING,null,null,$.wd.l3ForwardingObj),INCLUDE_IPV6&&null!=dftGtw6&&(s_str.cur_con==dftGtw6.data("text")?$.wd.l3Ip6ForwardingObj.__ifAliasName=conn.name:$.wd.l3Ip6ForwardingObj.__ifAliasName=dftGtw6.data("text"),1==wanArg.X_TP_IPv6Enabled&&$.act(ACT_SET,L3_IP6_FORWARDING,null,null,$.wd.l3Ip6ForwardingObj)),"AlwaysOn"==wanArg.connectionTrigger&&("l2tp"==t&&$.act(ACT_OP,ACT_OP_L2TP_CONN,a.__stack),"pptp"==t&&$.act(ACT_OP,ACT_OP_PPTP_CONN,a.__stack)),$.exe(function(e){e||("l2tp"==t||"pptp"==t?$.timeout(function(){$.removeLoading(),$.loadMain("wan.htm")},1500):($.removeLoading(),$.loadMain("wan.htm")))}))}));""==d&&($.act(ACT_DEL,WAN_CONN_DEVICE,e.__stack,null),$.exe(function(){$.removeLoading()}))})}function isEqualIPAddress(t,e,n){if(!t||!e||!n)return!1;var d=[],a=[];t=t.split("."),e=e.split("."),n=n.split(".");for(var i=0,o=t.length;i<o;i+=1)d.push(parseInt(t[i])&parseInt(n[i])),a.push(parseInt(e[i])&parseInt(n[i]));return d.join(".")==a.join(".")}function saveApply(t){var e;if("ETH"==$.sysMode){if($.act(ACT_SET,WAN_ETH_LINK_CFG,$.wd.conn[$.wd.editIndex].ewan.__stack,null,wanEth),"staticIp"==t){var n,d,a=$.act(ACT_GL,L2_BRIDGING_ENTRY,null,null,["bridgeName"]);if(!$.exe())for(n=0;n<a.length;n++){var i=$.act(ACT_GS,LAN_IP_INTF,null,a[n].__stack,["IPInterfaceIPAddress"]);if(!$.exe()&&(d=i[0].IPInterfaceIPAddress,isEqualIPAddress(wanArg.externalIPAddress,d,wanArg.subnetMask)))return void $.alert(CMM_WAN_IP_IP_IN_THE_SAME_SUBNET_WITH_LAN)}}t!=$.wd.conn[$.wd.editIndex].type?(ethDelConnFlag=!0,"l2tp"==$.wd.conn[$.wd.editIndex].type?$.act(ACT_DEL,WAN_L2TP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack,null):"pptp"==$.wd.conn[$.wd.editIndex].type?$.act(ACT_DEL,WAN_PPTP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack,null):$.act(ACT_DEL,$.wd.conn[$.wd.editIndex].type.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack,null),e="l2tp"==t?$.act(ACT_ADD,WAN_L2TP_CONN,null,$.wd.conn[$.wd.editIndex].ewan.__stack,wanArg):"pptp"==t?$.act(ACT_ADD,WAN_PPTP_CONN,null,$.wd.conn[$.wd.editIndex].ewan.__stack,wanArg):$.act(ACT_ADD,t.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,null,$.wd.conn[$.wd.editIndex].ewan.__stack,wanArg),$.exe()):"l2tp"==t?$.act(ACT_SET,WAN_L2TP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack,null,wanArg):"pptp"==t?$.act(ACT_SET,WAN_PPTP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack,null,wanArg):$.act(ACT_SET,t.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack,null,wanArg)}if(1==("l2tp"==t||"pptp"==t?1:"bridge"==t||INCLUDE_IPV6&&1!=wanArg.X_TP_IPv4Enabled?0:1)){if(($.wd.originIfAliasName!=dftGtw.data("text")||ethDelConnFlag&&$.wd.l3ForwardingObj.__ifAliasName==$.wd.conn[$.wd.editIndex].obj.name)&&("DSL"==$.sysMode?$.act(ACT_SET,LOCAL,null,null,{ispIndex:-1}):$.act(ACT_SET,LOCAL,null,null,{ewanIspIndex:-1})),$.wd.l3ForwardingObj.__ifAliasName=dftGtw.data("text"),s_str.cur_con==dftGtw.data("text")&&($.wd.l3ForwardingObj.__ifAliasName=$.wd.conn[$.wd.editIndex].obj.name),ethDelConnFlag&&($.wd.l3ForwardingObj.__ifAliasName==$.wd.conn[$.wd.editIndex].obj.name||$.wd.l3ForwardingObj.__ifAliasName==s_str.cur_con)){o="l2tp"==t?$.act(ACT_GET,WAN_L2TP_CONN,e.__stack,null,["name"]):"pptp"==t?$.act(ACT_GET,WAN_PPTP_CONN,e.__stack,null,["name"]):$.act(ACT_GET,t.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,e.__stack,null,["name"]),$.exe(),$.wd.l3ForwardingObj.__ifAliasName=o.name}$.act(ACT_SET,L3_FORWARDING,null,null,$.wd.l3ForwardingObj)}if(INCLUDE_IPV6&&null!=dftGtw6){if($.wd.l3Ip6ForwardingObj.__ifAliasName=dftGtw6.data("text"),!ethDelConnFlag||$.wd.l3Ip6ForwardingObj.__ifAliasName!=$.wd.conn[$.wd.editIndex].obj.name&&$.wd.l3Ip6ForwardingObj.__ifAliasName!=s_str.cur_con)s_str.cur_con==dftGtw6.data("text")||$.wd.conn[$.wd.editIndex].obj.name==dftGtw6.data("text")?$.wd.l3Ip6ForwardingObj.__ifAliasName=$.wd.conn[$.wd.editIndex].obj.name:$.wd.l3Ip6ForwardingObj.__ifAliasName=dftGtw6.data("text");else{var o;o="l2tp"==t?$.act(ACT_GET,WAN_L2TP_CONN,e.__stack,null,["name"]):"pptp"==t?$.act(ACT_GET,WAN_PPTP_CONN,e.__stack,null,["name"]):$.act(ACT_GET,t.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,e.__stack,null,["name"]),$.exe(),$.wd.l3Ip6ForwardingObj.__ifAliasName=o.name}"bridge"!=t&&1==wanArg.X_TP_IPv6Enabled&&$.act(ACT_SET,L3_IP6_FORWARDING,null,null,$.wd.l3Ip6ForwardingObj)}"ETH"==$.sysMode&&"dynamicIp"==$.wd.conn[$.wd.editIndex].type&&"dynamicIp"==t&&"dynamicIp"==$.wd.conn[$.wd.editIndex].type&&1==wanArg.X_TP_IPv4Enabled&&$.act(ACT_OP,ACT_OP_DHCP_RENEW,$.wd.conn[$.wd.editIndex].obj.__stack),"AlwaysOn"==wanArg.connectionTrigger&&("l2tp"==t&&(1==ethDelConnFlag?$.act(ACT_OP,ACT_OP_L2TP_CONN,e.__stack):$.act(ACT_OP,ACT_OP_L2TP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack)),"pptp"==t&&(1==ethDelConnFlag?$.act(ACT_OP,ACT_OP_PPTP_CONN,e.__stack):$.act(ACT_OP,ACT_OP_PPTP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack))),$.exe(function(e){e||("l2tp"==t||"pptp"==t?$.timeout(function(){$.removeLoading(),$.loadMain("wan.htm")},1500):($.removeLoading(),$.loadMain("wan.htm")))})}function addAttrs(t){var e=!0;if(null==$.wd.conn[$.wd.editIndex].type){if("DSL"==$.sysMode){if(0==addDslCfgAttrs())return!1}else if(0==addEthCfgAttrs())return!1}else INCLUDE_WAN_VLAN&&"DSL"==$.sysMode&&addDslVlanAttrs();if(0==addMacCloneAttrs(t))return!1;switch(t){case"staticIp":e=addStaIpAttrs();break;case"dynamicIp":e=addDynIpAttrs();break;case"pppoe":e=addPPPoEAttrs();break;case"pppoa":e=addPPPoAAttrs();break;case"ipoa":e=addIPoAAttrs();break;case"l2tp":e=addL2tpAttrs();break;case"pptp":e=addPptpAttrs();break;case"bridge":wanArg.NATEnabled=0,wanArg.X_TP_FullconeNATEnabled=0,wanArg.X_TP_FirewallEnabled=0,wanArg.X_TP_IGMPProxyEnabled=0,wanArg.maxMTUSize=1500,wanArg.enable=1,wanArg.connectionType="IP_Bridged",e=!0}return e}function showIPv6(){$("p").each(function(){$(this).hasClass("IPv6")&&$(this).removeClass("nd")}),$("div").each(function(){$(this).hasClass("IPv6")&&$(this).removeClass("nd")})}function initDefaultGwDNS(){var t,e=0,n=$.wd.conn[$.wd.editIndex].type,d=null==n?$.wd.conn.length-1:$.wd.conn.length;if("DSL"==$.sysMode){if(INCLUDE_WAN_MODE&&INCLUDE_VDSLWAN){_=$.act(ACT_GET,SYS_MODE,null,null,["mode","DSLL3ForwardingName","VDSLL3ForwardingName","DSLL3IPv6ForwardingName","VDSLL3IPv6ForwardingName"]);$.exe()}if(INCLUDE_USB_3G_DONGLE&&INCLUDE_WAN_MODE&&null!=$.wd.l3ForwardingObj.__ifAliasName.match("USB_3G")){var a,i,o=$.act(ACT_GL,WAN_COMMON_INTF_CFG,null,null,["WANAccessType"]),l=$.act(ACT_GL,WAN_USB_3G_LINK_CFG,null,null,["backupEnable"]);if(INCLUDE_WAN_MODE)var _=$.act(ACT_GET,SYS_MODE,null,null,["mode"]);$.exe()||($.each(o,function(){"USB_3G"==this.WANAccessType&&(a=this.__stack)}),$.each(l,function(){var t=$.stkPop(this.__stack,1);a==t&&(i=$.act(ACT_GET,WAN_USB_3G_LINK_CFG,this.__stack,null,["mainConnObjName"]))}),$.exe()||INCLUDE_WAN_MODE&&"USB_3G"!=_.mode&&($.wd.l3ForwardingObj.__ifAliasName=i.mainConnObjName))}dftGtw.empty();for(c=0;c<d;c++){if(1==("l2tp"==$.wd.conn[c].type||"pptp"==$.wd.conn[c].type?1:"bridge"==$.wd.conn[c].type||INCLUDE_IPV6&&1!=$.wd.conn[c].obj.X_TP_IPv4Enabled?0:1)){if(INCLUDE_VDSLWAN&&curSetIsPtm!=$.wd.conn[c].ptm.X_TP_Used)continue;if(INCLUDE_IPTV&&"iptv"==$.wd.conn[c].obj.name)continue;t="<option value='"+$.wd.conn[c].obj.name+"' text='"+$.wd.conn[c].obj.name+"''>"+$.wd.conn[c].obj.name+"</option>",dftGtw.append(t),$.wd.conn[c].obj.name==(INCLUDE_VDSLWAN?curSetIsPtm?_.VDSLL3ForwardingName:_.DSLL3ForwardingName:$.wd.l3ForwardingObj.__ifAliasName)&&dftGtw.find('option[value="'+$.wd.conn[c].obj.name+'"]').prop("selected","selected"),e++}}if(null!=n&&0!=e&&("l2tp"==n||"pptp"==n||INCLUDE_IPV6&&0!=$.wd.conn[$.wd.editIndex].obj.X_TP_IPv4Enabled)||(t="<option text='"+s_str.cur_con+"''>"+s_str.cur_con+"</option>",dftGtw.append(t),currGtwIndex=e,e++),"l2tp"!=n&&"pptp"!=n&&0==$.wd.conn[$.wd.editIndex].obj.X_TP_IPv4Enabled&&"iptv"==(INCLUDE_VDSLWAN?curSetIsPtm?_.VDSLL3ForwardingName:_.DSLL3ForwardingName:$.wd.l3ForwardingObj.__ifAliasName)&&dftGtw.find('option[text="'+s_str.cur_con+'"]').prop("selected","selected"),INCLUDE_IPV6&&null!=dftGtw6){e=0,dftGtw6.empty();for(c=0;c<d;c++)if("bridge"!=$.wd.conn[c].type&&1==$.wd.conn[c].obj.X_TP_IPv6Enabled){if(INCLUDE_VDSLWAN&&curSetIsPtm!=$.wd.conn[c].ptm.X_TP_Used)continue;if(INCLUDE_IPTV_V2&&"iptv"==$.wd.conn[c].obj.name)continue;t="<option value='"+$.wd.conn[c].obj.name+"' text='"+$.wd.conn[c].obj.name+"''>"+$.wd.conn[c].obj.name+"</option>",dftGtw6.append(t),$.wd.conn[c].obj.name==(INCLUDE_VDSLWAN?curSetIsPtm?_.VDSLL3IPv6ForwardingName:_.DSLL3IPv6ForwardingName:$.wd.l3Ip6ForwardingObj.__ifAliasName)&&dftGtw6.find('option[value="'+$.wd.conn[c].obj.name+'"]').prop("selected","selected"),e++}null!=n&&0!=$.wd.conn[$.wd.editIndex].obj.X_TP_IPv6Enabled&&0!=e||(t="<option text='"+s_str.cur_con+"''>"+s_str.cur_con+"</option>",dftGtw6.append(t),currGtw6Index=e,e++)}}else{dftGtw.empty();for(c=0;c<d;c++)if("pptp"==$.wd.conn[c].type||"l2tp"==$.wd.conn[c].type)t="<option value='"+$.wd.conn[c].obj.name+"' text='"+$.wd.conn[c].obj.name+"''>"+$.wd.conn[c].obj.name+"</option>",dftGtw.append(t),$.wd.conn[c].obj.name==$.wd.l3ForwardingObj.__ifAliasName&&dftGtw.find('option[value="'+$.wd.conn[c].obj.name+'"]').prop("selected","selected"),e++;else if("bridge"!=$.wd.conn[c].type&&(!INCLUDE_IPV6||1==$.wd.conn[c].obj.X_TP_IPv4Enabled)){if(INCLUDE_EWAN_IPTV&&"ewan_iptv"==$.wd.conn[c].obj.name)continue;t="<option value='"+$.wd.conn[c].obj.name+"' text='"+$.wd.conn[c].obj.name+"''>"+$.wd.conn[c].obj.name+"</option>",dftGtw.append(t),$.wd.conn[c].obj.name==$.wd.l3ForwardingObj.__ifAliasName&&dftGtw.find('option[value="'+$.wd.conn[c].obj.name+'"]').prop("selected","selected"),e++}if(null!=n&&0!=e&&("l2tp"==n||"pptp"==n||INCLUDE_IPV6&&0!=$.wd.conn[$.wd.editIndex].obj.X_TP_IPv4Enabled)||(t="<option text='"+s_str.cur_con+"''>"+s_str.cur_con+"</option>",dftGtw.append(t),currGtwIndex=e,e++),"l2tp"!=n&&"pptp"!=n&&0==$.wd.conn[$.wd.editIndex].obj.X_TP_IPv4Enabled&&"iptv"==$.wd.l3ForwardingObj.__ifAliasName&&dftGtw.find('option[text="'+s_str.cur_con+'"]').prop("selected","selected"),INCLUDE_IPV6&&null!=dftGtw6){e=0,dftGtw6.empty();for(var c=0;c<d;c++)if("bridge"!=$.wd.conn[c].type&&1==$.wd.conn[c].obj.X_TP_IPv6Enabled){if(INCLUDE_EWAN_IPTV&&"ewan_iptv"==$.wd.conn[c].obj.name)continue;t="<option value='"+$.wd.conn[c].obj.name+"' text='"+$.wd.conn[c].obj.name+"''>"+$.wd.conn[c].obj.name+"</option>",dftGtw6.append(t),$.wd.conn[c].obj.name==$.wd.l3Ip6ForwardingObj.__ifAliasName&&dftGtw6.find('option[value="'+$.wd.conn[c].obj.name+'"]').prop("selected","selected"),e++}null!=n&&0!=$.wd.conn[$.wd.editIndex].obj.X_TP_IPv6Enabled&&0!=e||(t="<option text='"+s_str.cur_con+"''>"+s_str.cur_con+"</option>",dftGtw6.append(t),currGtw6Index=e,e++)}}null!=$.wd.conn[$.wd.editIndex].type&&$.wd.conn[$.wd.editIndex].type!=$("#link_type").data("value")&&(t="<option text='"+s_str.cur_con+"''>"+s_str.cur_con+"</option>",dftGtw.append(t),dftGtw.find('option[text="'+s_str.cur_con+'"]').prop("selected","selected"),INCLUDE_IPV6&&"pptp"!=$("#link_type").data("value")&&"l2tp"!=$("#link_type").data("value")&&(dftGtw6.append(t),dftGtw6.find('option[text="'+s_str.cur_con+'"]').prop("selected","selected")))}function addMacCloneAttrs(t){var e;if($("#dftMac").prop("checked"))return wanArg.MACAddressOverride=0,!0;if($("#pcMac").prop("checked"))e=pcMacAddr;else if($("#customMac").prop("checked")&&(e=$("#customMacAddr").tpAddress("val"),$.mac(e)))return $("#customMacAddr").focus().select(),!1;return wanArg.MACAddressOverride=1,"l2tp"==t||"pptp"==t?wanArg.clonedMACAddress=e.toUpperCase():wanArg.X_TP_ClonedMACAddress=e.toUpperCase(),!0}function initMacClone(){if($.act(ACT_CGI,"/cgi/info"),$.exe())return!1;if(pcMacAddr=clientMac,$("input[type='text'].mac-address").tpAddress({connector:"-",connectorReal:":",cellLength:2,cellNumber:6}),$("#computerMacAddr").tpAddress("val",pcMacAddr),null!=$.wd.conn[$.wd.editIndex].type){var t=$.wd.conn[$.wd.editIndex].obj;1==t.MACAddressOverride&&(t.X_TP_ClonedMACAddress==pcMacAddr||t.clonedMACAddress==pcMacAddr?($("#pcMac").prop("checked",!0),$("#customMac").prop("checked",!1),$("#dftMac").prop("checked",!1)):($("#customMac").prop("checked",!0),"l2tp"==$.wd.conn[$.wd.editIndex].type||"pptp"==$.wd.conn[$.wd.editIndex].type?$("#customMacAddr").tpAddress("val",t.clonedMACAddress):$("#customMacAddr").tpAddress("val",t.X_TP_ClonedMACAddress),$("#pcMac").prop("checked",!1),$("#dftMac").prop("checked",!1)))}}var dftGtw,currGtwIndex=null,dftGtw6=null,currGtw6Index=null,curSupIsPtm=0,curSetIsPtm=0,wanArg={},wanDsl={},wanEth={},ethDelConnFlag=!1,dsllinkcfglist={},ptmlinkcfglist={},ethlinkcfglist={};$("#saveConnBtn").click(function(){$.addLoading($(this));var t=$.wd.conn[$.wd.editIndex].type;null!=t&&"ETH"!=$.sysMode||(t=$("#link_type").data("value")),wanDsl={},wanPtm={},wanArg={},wanEth={};var e,n=!1;if(e=$.act(ACT_GL,LAN_IP6_HOST_CFG,null,null),$.exe(),$.each(e,function(){"br0"==this.__ifName&&""==this.IPv6PDWANConnection&&"Delegated"==this.IPv6SitePrefixConfigType&&(n=!0),!n&&INCLUDE_CHECK_WANALIVE_WITH_PING&&"ETH"==$.sysMode&&"LTE"==this.IPv6PDWANConnection&&"Delegated"==this.IPv6SitePrefixConfigType&&(n=!0)}),0!=addAttrs(t))if($.wd.l3ForwardingObj.__ifName="",$.wd.l3ForwardingObj.defaultConnectionService="",INCLUDE_IPV6&&($.wd.l3Ip6ForwardingObj.__ifName="",$.wd.l3Ip6ForwardingObj.defaultConnectionService=""),null==$.wd.conn[$.wd.editIndex].type){var d={};if(""==(o=isConnDeviceExist())){if(d=$.act(ACT_ADD,WAN_CONN_DEVICE,null,$.wd.pStk),$.exe())return;"DSL"==$.sysMode&&(INCLUDE_VDSLWAN&&1==curSetIsPtm?$.act(ACT_SET,WAN_PTM_LINK_CFG,d.__stack,null,wanPtm):$.act(ACT_SET,WAN_DSL_LINK_CFG,d.__stack,null,wanDsl))}else{if("DSL"!=$.sysMode)return void $.alert(CMM_WAN_VID_CONFLICT);d.__stack=o}var a={},i={};if(INCLUDE_L2TP)a=$.act(ACT_GL,WAN_L2TP_CONN,null,null);if(INCLUDE_PPTP)i=$.act(ACT_GL,WAN_PPTP_CONN,null,null);!INCLUDE_L2TP&&!INCLUDE_PPTP||"l2tp"!=t&&"pptp"!=t?newConnApply(t,d,n,o):$.exe(function(e){e||(a.length>0?(""==o&&($.act(ACT_DEL,WAN_CONN_DEVICE,d.__stack,null),$.exe(function(){$.removeLoading()})),$.alert(CMM_WAN_L2TP_ALREADY_EXIST),$.removeLoading(),$.loadMain("wan.htm")):i.length>0?(""==o&&($.act(ACT_DEL,WAN_CONN_DEVICE,d.__stack,null),$.exe(function(){$.removeLoading()})),$.alert(CMM_WAN_PPTP_ALREADY_EXIST),$.removeLoading(),$.loadMain("wan.htm")):newConnApply(t,d,n,o))})}else if("l2tp"!=t&&"pptp"!=t&&(1!=n||s_str.cur_con!=dftGtw6.data("text")&&$.wd.conn[$.wd.editIndex].obj.name!=dftGtw6.data("text")||(wanArg.X_TP_PDEnabled=1)),"DSL"==$.sysMode)$.act(ACT_SET,t.indexOf("ppp")<0?WAN_IP_CONN:WAN_PPP_CONN,$.wd.conn[$.wd.editIndex].obj.__stack,null,wanArg);else if("ETH"==$.sysMode){if(0==addEthCfgAttrs())return;var o=isConnDeviceExist();if(""!=o&&o!=$.wd.conn[$.wd.editIndex].obj.__stack)return void $.alert(CMM_WAN_VID_CONFLICT);var a={},i={};if(INCLUDE_L2TP&&("l2tp"==t||"pptp"==t))a=$.act(ACT_GL,WAN_L2TP_CONN,null,null);if(INCLUDE_PPTP&&("l2tp"==t||"pptp"==t))i=$.act(ACT_GL,WAN_PPTP_CONN,null,null);!INCLUDE_L2TP&&!INCLUDE_PPTP||"l2tp"!=t&&"pptp"!=t||"l2tp"==$.wd.conn[$.wd.editIndex].type||"pptp"==$.wd.conn[$.wd.editIndex].type?"dynamicIp"==$.wd.conn[$.wd.editIndex].type&&"dynamicIp"==t?($.act(ACT_OP,ACT_OP_DHCP_RELEASE,$.wd.conn[$.wd.editIndex].obj.__stack),$.exe()||$.timeout(function(){saveApply(t)},1500)):saveApply(t):$.exe(function(e){e||(a.length>0?($.alert(CMM_WAN_L2TP_ALREADY_EXIST),$.removeLoading(),$.loadMain("wan.htm")):i.length>0?($.alert(CMM_WAN_PPTP_ALREADY_EXIST),$.removeLoading(),$.loadMain("wan.htm")):saveApply(t))})}else saveApply(t)}),$("#link_type").click(function(){"bridge"==$("#link_type").data("value")?$("#divMacClone").addClass("nd"):$("#divMacClone").removeClass("nd"),$("#addLinkType").hasClass("nd")||(INCLUDE_WAN_VLAN&&"ipoa"!=$("#link_type").data("value")&&"pppoa"!=$("#link_type").data("value")?$("#dsl_vlan_add").removeClass("nd"):$("#dsl_vlan_add").addClass("nd"),doSync($("#link_type").data("value")))}),$("#cancelBtn").click(function(){$.loadMain("wan.htm")});var pcMacAddr;$("#divMacClone").on("click","input[type=radio]",function(t){switch(this.id){case"dftMac":$("#computerMacAddr, #customMacAddr").tpAddress("hide");break;case"pcMac":$("#customMacAddr").tpAddress("hide"),$("#computerMacAddr").tpAddress("show");break;case"customMac":$("#computerMacAddr").tpAddress("hide"),$("#customMacAddr").tpAddress("show")}})</script>

<div id="divDslCfg" class="nd"></div>
<div class="part-separate"></div>
<div id="eth-cfg"></div>

<div id="addLinkType" class="nd"><b class="T_conntype">Connection Type</b>
    <select id="link_type">
        <option class="T_staip" value="staticIp">Static IP</option>
        <option class="T_dynip" value="dynamicIp">Dynamic IP</option>
        <option class="T_pppoe" value="pppoe">PPPoE</option>
        <option class="T_pppoa" value="pppoa">PPPoA</option>
        <option class="T_ipoa" value="ipoa">IPoA</option>
        <option class="T_l2tp" value="l2tp">L2TP</option>
        <option class="T_pptp" value="pptp">PPTP</option>
        <option class="T_bridge" value="bridge">Bridge</option>
    </select>
</div>
<div class="pure-control-group cfg-line nd" id="editLinkType">
    <label class="label-title T_conntype">Connection Type:</label>
    <span class="text" id="linkTypeText"></span>
</div>

<div id="divStaIp" class="nd"></div>
<div id="divDynIp" class="nd"></div>
<div id="divPPPoE" class="nd"></div>
<div id="divPPPoA" class="nd"></div>
<div id="divIPoA" class="nd"></div>
<div id="divL2TP" class="nd"></div>
<div id="divPPTP" class="nd"></div>

<div id="divMacClone" class="part-separate">
    <h3 id="et2">MAC Clone</h3>
    <div>
        <input type="radio" name="macClone" id="dftMac" checked="checked">
        <label id="t_defMac" class="xl">Use Default MAC Address</label>
    </div>
    <div>
        <input type="radio" name="macClone" id="pcMac">
        <label id="t_computerMac" class="xl">Use Current Computer MAC Address</label>
        <input type="text" id="computerMacAddr" disabled="true" class="mac-address">
    </div>
    <div>
        <input type="radio" name="macClone" id="customMac">
        <label id="t_customMac" class="xl">Use Custom MAC Address</label>
        <input type="text" id="customMacAddr" class="mac-address">
    </div>
</div>

<div class="inline-btn-right part-separate">
    <div class="inline">
        <button type="submit" class="green T_cancel" id="cancelBtn">Cancel</button>
    </div>
    <div class="inline">
        <button type="submit" class="green T_save" id="saveConnBtn">Save</button>
    </div>
</div>
<script language="JavaScript">initDiv()</script>
