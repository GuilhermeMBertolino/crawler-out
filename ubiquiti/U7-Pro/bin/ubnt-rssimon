#!/bin/ash

. /usr/bin/unifi_util_funcs.sh
sysid=$(get_config_value /proc/ubnthal/system.info systemid)

case $sysid in
	dca8)
		base_gpios="1 15 20 21"
		base_thresholds="-67 -74 -80 -96"
		;;
	a688)
		base_gpios="495 508 510 490"
		base_thresholds="-67 -74 -80 -96"
		;;
	*)
		echo "Unsupported device: $sysid"
		exit 0
		;;
esac

echo $$ > /var/run/ubnt-rssimon.pid

for gpio in $base_gpios; do
    [ ! -e "/sys/class/gpio/gpio$gpio" ] && echo $gpio > /sys/class/gpio/export
    echo "out" > /sys/class/gpio/gpio$gpio/direction
done

while true; do
    signal=-96
    bssid=$(wpa_cli status | grep "bssid=" | cut -d= -f2)
    # If associated, get the signal from the bssid
    if [ -n "$bssid" ]; then
        signal=$(wpa_cli scan_results | grep "$bssid" | awk '{print $3}')
    fi

    # If a parameter was provided, use it as the fake signal level used for debugging
    if [ ! -z "$1" ]; then
        signal=$1
    fi

    gpios=$base_gpios
    thresholds=$base_thresholds
    for gpio in $gpios; do
        current_threshold=$(echo $thresholds | awk '{print $1}')
        if [ "$signal" -gt "$current_threshold" ]; then
            echo "1" > /sys/class/gpio/gpio$gpio/value
        else
            echo "0" > /sys/class/gpio/gpio$gpio/value
        fi
        thresholds=$(echo $thresholds | awk '{$1=""; print $0}')
    done
    sleep 2
done
