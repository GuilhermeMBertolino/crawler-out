#!/bin/sh

if [ $# -eq 0 -o $# -eq 1 ]; then
	echo "Usage: $0 <output dir> <file name> [emerg <reason>]"
        exit 1
fi

ddir=$1
file=$2
emerg=0
now=$(date +%s)
has5g=true

if [ $(grep "radio.1.status" /tmp/system.cfg | awk -F'=' {'print $2'}) = "disabled" ]; then
	has5g=false
fi

collect_temperatures() {
	temperatures show > $ddir/temperatures.txt
	temperatures show boot >> $ddir/temperatures.txt
}

copy_minion() {
    if [ -d /var/log/e2e/ ]; then
        cp -r /var/log/e2e/ $ddir
    fi
}

copy_crashes() {
    if [ -d /tmp/crash_data ]; then
        for crash in /tmp/crash_data/crash-*; do
            name=$(basename $crash)
            cp -a $crash $ddir/$name
        done
    fi

    if [ -d /tmp/boot_reason ]; then
        cp -r /tmp/boot_reason $ddir
    fi
}

if [ $# -ge 4 -a "$3" = "emerg" ]; then
        emerg=1
        file=/etc/persistent/emerg.supp
        date > /etc/persistent/emerg
        echo "$4" >> /etc/persistent/emerg
fi

if [ -z "$ddir" ]; then
    flavor=$(grep -Eo '^[^.]+' /usr/lib/version)
    hwaddr=$(sed -n 's/^board.hwaddr=//p' /etc/board.info)
    ddir=/tmp/support-$flavor-$hwaddr
    file=/tmp/$flavor-$hwaddr.sup
fi

rm -rf $ddir
rm -rf $file
mkdir $ddir
if [ $emerg -eq 1 ]; then
	cp /usr/lib/version $ddir
	if $has5g; then
		radartool savereports >/dev/null 2>&1
	fi
	mv /tmp/*.dfsz $ddir >/dev/null 2>&1

copy_crashes

iwconfig 2> /dev/null > $ddir/iwconfig.txt

	if $has5g; then
		athstats > $ddir/athstats.txt
		athstats -ol > $ddir/athstats-ol.txt
		80211stats -a > $ddir/80211stats.txt
		wlanconfig ath0 list > $ddir/wlist.txt
		iwlist ath0 keys > $ddir/wkeys.txt
		wstalist -p > $ddir/wstalist.txt
	fi

	ps > $ddir/ps.txt
	uptime > $ddir/uptime.txt
	cat /tmp/gps_info > $ddir/gps.txt

	if $has5g; then
		cp -R /proc/net/uph_wifi0/ $ddir
		iwpriv wifi0 get_dacount > $ddir/dynack.txt
		iwpriv wifi0 get_distance >> $ddir/dynack.txt
		iwpriv wifi0 get_acktimeout >> $ddir/dynack.txt
	fi
	dmesg -s 524288 > $ddir/dmesg.txt
	if [ -f /var/log/messages.0 ]; then
		cat /var/log/messages.* > $ddir/syslog.txt
	fi
	cat /var/log/messages >> $ddir/syslog.txt
	cat /var/log/unms.log* > $ddir/unms.log.txt
	for i in meminfo slabinfo loadavg vmstat; do
		cp /proc/$i $ddir
	done

	for i in `grep eth /proc/net/dev | cut -f 1 -d ":"`; do ethtool ${i} >> $ddir/eth.txt; ethtool -d ${i} >> $ddir/eth-d.txt; ethtool -S ${i} >> $ddir/eth-S.txt; done

	brctl show > $ddir/brctl-show.txt
	for i in `grep br /proc/net/dev | cut -f 1 -d ":"`; do brctl showmacs ${i} >> $ddir/brctl-showmacs.txt; done

	if $has5g; then
		apstats -r -i wifi0 -R > $ddir/apstats.txt
	fi
	collect_temperatures
	copy_minion
else
	top -d1 -n3 -b > $ddir/top.txt
	if [ -x /usr/bin/clad-client ]; then
        	/usr/bin/clad-client -c adoption-status > $ddir/clad.txt
                echo "adoption-status-rc: $?" >> $ddir/clad.txt
                cat /var/run/x-ubnt 2>/dev/null >> $ddir/clad.txt
        fi
	cp /tmp/boot.txt $ddir
	cp /etc/board.info $ddir
	cp /tmp/running.cfg $ddir
	cp /tmp/system.cfg $ddir
	cp /etc/resolv.conf $ddir
	cp /etc/dnsmasq.conf $ddir
	cp /etc/host.conf $ddir
	cp /etc/hosts $ddir
	grep -iv psk /etc/wpasupplicant* > $ddir/wpasuplicant
	cp /etc/inittab $ddir
	cp /var/run/*_autoip $ddir/autoip
	cp -R /tmp/airview $ddir
	cp /tmp/amg_data $ddir
	cp /usr/lib/version $ddir
	radartool savereports >/dev/null 2>&1
	mv /tmp/*.dfsz $ddir >/dev/null 2>&1

	copy_crashes

	for i in link addr route neigh ntable tunnel maddr mroute; do
		echo "#### $i ####" >> $ddir/ip.txt
		ip -s -d $i 2> /dev/null >> $ddir/ip.txt
	done
	ifconfig -a > $ddir/ifconfig.txt
	route -n > $ddir/routes.txt
	du -ah /var > $ddir/var.txt
	iwconfig 2> /dev/null > $ddir/iwconfig.txt

	if $has5g; then
		athstats > $ddir/athstats.txt
		athstats -ol > $ddir/athstats-ol.txt
		80211stats -a > $ddir/80211stats.txt
		wlanconfig ath0 list > $ddir/wlist.txt
		iwlist ath0 keys > $ddir/wkeys.txt
		athchans -g > $ddir/athchans.txt
		iwpriv wifi0 get_dacount > $ddir/dynack.txt
		iwpriv wifi0 get_distance >> $ddir/dynack.txt
		iwpriv wifi0 get_acktimeout >> $ddir/dynack.txt
		wstalist -p > $ddir/wstalist.txt
		wpa_cli status > $ddir/wpa.txt
		echo "wpa supp blacklist:" >> $ddir/wpa.txt
		wpa_cli blacklist >> $ddir/wpa.txt
		cp -R /proc/net/uph_wifi0/ $ddir
	fi

	cp -R /etc/sysinit/ $ddir
	cp -R /etc/persistent/ $ddir
	ps > $ddir/ps.txt
	uptime > $ddir/uptime.txt
	cat /proc/sys/dev/ubnt_poll/gps_info > $ddir/gps.txt
	for i in `grep eth /proc/net/dev | cut -f 1 -d ":"`; do ethtool ${i} >> $ddir/eth.txt; ethtool -d ${i} >> $ddir/eth-d.txt; ethtool -S ${i} >> $ddir/eth-S.txt; done

	tc=$(command -v tc)
	iptables=$(command -v iptables)
	ebtables=$(command -v ebtables)

	if [ -n "$iptables" ]; then
		for i in filter nat mangle; do iptables -t ${i} -L -nv >> $ddir/iptables.txt; done
	fi

	if [ -n "$ebtables" ]; then
		for i in filter nat broute; do ebtables -t ${i} -L --Lc >> $ddir/ebtables.txt; done
	fi

	if [ -n "$tc" ]; then
		for i in `grep : /proc/net/dev | cut -f 1 -d ":"`; do 
			echo "#### $i ####" >> $ddir/tc.txt
		        tc -s -d qdisc show dev ${i} >> $ddir/tc.txt
		        tc -s -d class show dev ${i} >> $ddir/tc.txt
		done
	fi

	df > $ddir/df.txt

	if $has5g; then
		iwpriv ath0 medump 1
		radartool status > $ddir/radartool.txt
		radartool shownol

		iwpriv ath0 medump 1

		# Wireless Scan must be the last one as it could change current status
		sc_res=`iwlist ath0 scan`
	fi

	top -d1 -n3 -b > $ddir/top.txt

	dmesg -s 262144 > $ddir/dmesg.txt

	if [ -f /var/log/messages.0 ]; then
		cat /var/log/messages.* > $ddir/syslog.txt
	fi
	cat /var/log/messages >> $ddir/syslog.txt
	cat /var/log/unms.log* > $ddir/unms.log.txt

	for i in meminfo slabinfo loadavg vmstat modules kallsyms net/arp mtd uptime; do
		cp /proc/$i $ddir
	done
	
	/usr/www/status.cgi -p > $ddir/status.cgi.txt

	i=`grep cfg /proc/mtd | cut -b 4`; dd if=/dev/mtdblock${i} of=$ddir/part.cfg > /dev/null 2>&1
	i=`grep EEPROM /proc/mtd | cut -b 4`; dd if=/dev/mtdblock${i} of=$ddir/part.eeprom > /dev/null 2>&1

	brctl show > $ddir/brctl-show.txt
	for i in `grep br /proc/net/dev | cut -f 1 -d ":"`; do brctl showmacs ${i} >> $ddir/brctl-showmacs.txt; done

	if $has5g; then

	# combine tcpdump, upollstats and counters:
		dev=br0 || dev=ath0
		tcpdump -i $dev -c 100 -w $ddir/tcpdump.out & tcpdump_pid=$!
		[ -x /bin/upollstats ] && upollstats -p 1 -c 5 > $ddir/upollstats.txt &
		for i in 1 2 3 4 5; do
		ip -s -d link >> $ddir/ip.$i.txt
		sleep 1
		done
		kill $tcpdump_pid 2>/dev/null

		echo "==== Support file marker $now ====" >> /dev/kmsg

		if [ -f /proc/sys/dev/uph_wifi0/debug_tid ]; then
		    echo 1 20 0xff > /proc/sys/dev/uph_wifi0/debug_tid

		    echo "==== ubnt_poll stats #1 ====" >> /dev/kmsg
		    echo 7 > /proc/sys/dev/uph_wifi0/get_diag
		    echo 9 > /proc/sys/dev/uph_wifi0/get_diag

		    iwpriv ath0 txrx_fw_stats 7
		    iwpriv ath0 txrx_fw_stats 2
		fi

		athstats -ol > $ddir/athstats-ol-2.txt
		apstats -r -i wifi0 -R > $ddir/apstats-2.txt


		if [ -f /proc/sys/dev/uph_wifi0/debug_tid ]; then
		    echo "==== ubnt_poll stats #2 ====" >> /dev/kmsg
		    echo 7 > /proc/sys/dev/uph_wifi0/get_diag
		    echo 9 > /proc/sys/dev/uph_wifi0/get_diag

		    iwpriv ath0 txrx_fw_stats 7
		    iwpriv ath0 txrx_fw_stats 2

		    echo "==== debug_tid ====" >> /dev/kmsg
		    echo 27 > /proc/sys/dev/uph_wifi0/get_diag

		    echo 0 20 0xff > /proc/sys/dev/uph_wifi0/debug_tid

		    dmesg -s 16384|awk "BEGIN p=0; { if (/marker $now/) p=1; if (p==1) print \$0 }" > $ddir/dmesg_upoll_debug.txt
		fi
	fi

	collect_temperatures
	copy_minion

	if $has5g; then

		[ -x /bin/radarprescan ] && ust-ctl -c dump-dfs-prescan -p > $ddir/dfs_prescan.txt

		# Collect scan results.
		n=0
		while [ $n -lt 40 ]; do
			n=$((n+1))
			sc_res=`iwlist ath0 scan last`
			if echo "$sc_res" | grep -cq "Scan in progress :"; then
				sleep 1;
			else
				break;
			fi;
		done
		echo "$sc_res" > $ddir/wscan.txt
	fi
fi
d=`dirname $ddir`
f=`basename $ddir`
tar -C ${d} -zcf $file ${f}
rm -fr $ddir
[ $emerg -eq 1 ] && cfgmtd -w -p /etc -f /tmp/running.cfg
