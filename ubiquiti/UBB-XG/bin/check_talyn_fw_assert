#!/bin/sh
set -e

CRASH_DATA_PATH="/tmp/crash_data"
LAST_FW_ASSERT_FILE="/tmp/.last_fw_assert"
PROCESS_NAME="offload"

latest_assert=`grep "Firmware error" /var/log/messages | tail -n1`

if [ -z "$latest_assert" ]; then
	exit 0
fi

# check events cache
if [ -f $LAST_FW_ASSERT_FILE ]; then
	last_assert_data=`cat $LAST_FW_ASSERT_FILE`

	# nothing to do here
	if [ "$latest_assert" = "$last_assert_data" ]; then
		exit 0
	fi
fi

# get information about assert codes and time
assert_time=`echo $latest_assert | awk -F ' ' '{print $1" "$2" "$3}'`
assert_codes=`echo $latest_assert | awk -F 'assert codes' '{print $2}'`

# get information about offload hardware and firmware
talyn_fw_version=`wigig_logger2 -i | grep version | cut -d" " -f3`
talyn_fw_build_date=`wigig_logger2 -i | grep date | cut -d" " -f4`
talyn_rev=`wigig_logger2 -i | grep rev | cut -d" " -f3`

# sometimes wigig_logger2 may fail, exit then
if [ -z "$talyn_fw_version" ] || [ -z "$talyn_fw_build_date" ] || [ -z "$talyn_rev" ]; then
	exit 0
fi

crash_id="crash-$(date +%s)-$$"
crash_path="${CRASH_DATA_PATH}/${crash_id}"
mkdir -p ${crash_path}/meta

#

platform_get_cfg_opt() {
	cat /etc/board.info | grep ${1} | awk -F '=' '{print $2}'
}

# generate crash report
# common data
echo -n $(platform_get_cfg_opt 'board\.device_id') > ${crash_path}/meta/device_id
echo -n $(platform_get_cfg_opt 'board\.model') > ${crash_path}/meta/model
echo -n $(platform_get_cfg_opt 'board\.bom') > ${crash_path}/meta/bomrev
echo -n $(uname -r) > ${crash_path}/meta/kernel_version
echo -n $(uname -m) > ${crash_path}/meta/architecture

cat /lib/version > ${crash_path}/meta/full_version
cat /lib/version | sed -nr 's/^.*\.v(.+)\.([^.]+)\.([0-9]{6})\.([0-9]{4})$/v\1/p' > ${crash_path}/meta/version

echo -n $(date +%Y-%m-%dT%H:%M:%S) > ${crash_path}/meta/system_time
cut -d" " -f1-3 < /proc/loadavg > ${crash_path}/meta/load_average

# information about actual offload event
echo -n "! "${talyn_rev}" OFFLOAD" > ${crash_path}/meta/cmd
cp ${crash_path}/meta/cmd ${crash_path}/meta/cmd_fullpath
echo -n 17 > ${crash_path}/meta/signal
cut -d" " -f1 < /proc/uptime > ${crash_path}/meta/uptime
echo -n ${assert_codes} > ${crash_path}/meta/memory_map

echo -n ${PROCESS_NAME} > ${crash_path}/meta/ps
df > ${crash_path}/meta/df
free > ${crash_path}/meta/free

echo -n "Firmware error: "${assert_codes} > ${crash_path}/meta/crash_log
echo -n ${talyn_rev}"_"${talyn_fw_version}"_"${talyn_fw_build_date} > ${crash_path}/meta/cmd_envvars
echo -n ${assert_codes}" on "${talyn_rev}" "${talyn_fw_version} > ${crash_path}/meta/cmdline_params
echo -n "empty" > ${crash_path}/meta/file_descriptors
echo -n "app" > ${crash_path}/type

touch ${crash_path}/done

# set offload crash count
crash_num=0
if [ -f "${CRASH_DATA_PATH}/${PROCESS_NAME}_crash_count" ]; then
	num=$(cat "${CRASH_DATA_PATH}/${PROCESS_NAME}_crash_count")
fi
echo "$((num+1))" > "${CRASH_DATA_PATH}/${PROCESS_NAME}_crash_count"

# add current event to the cache
echo $latest_assert > $LAST_FW_ASSERT_FILE
