#!/bin/sh
. /etc/config.sh

[ -n "$CONFIG_NEW_FRAMEWORK" ] && . /etc/ugw_notify_defs.sh

handle_framework()
{
	if [ "z${sixrd}" != "z" ]; then
		ubus call servd notify '{"nid": '$NOTIFY_DYNAMIC_6RD', "type": true, "pn1": "ipv4MaskLen","pv1": "'$(echo $sixrd | cut -d ' ' -f 1)'","pn2": "sixrdPrefixLen","pv2": "'$(echo $sixrd | cut -d ' ' -f 2)'","pn3": "sixrdPrefix","pv3": "'$(echo $sixrd | cut -d ' ' -f 3)'","pn4": "BRIPv4Address","pv4": "'$(echo $sixrd | cut -d ' ' -f 4)'","pn5":"ip","pv5": "'$ip'", }'
	fi
}

handle_dhcp_route()
{
	local metric

	[ "$1" == "renew" ] && {
		[ ! -z "$INTERFACE" ] && {
			cur=$(route -n | grep $INTERFACE | awk '/UG/{print $2};')
			[ "$cur" != "$i" ] && {
				[ "$cur" != "" ] && {
					route del default gw $cur
				}
				metric=$(uci get network.$INTERFACE.metric)
				[ ! -z "$metric" ] && {
					route add default gw $i metric $metric
				}
			}
		}
	}
}

[ -n "$CONFIG_NEW_FRAMEWORK" ] && handle_dhcp_route $*
[ -n "$CONFIG_NEW_FRAMEWORK" ] && handle_framework $*
