<!DOCTYPE HTML>
<? include 'php/commonCfg.php';?>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">
  
  <title>NETGEAR Router <?= getModelNameStr()?></title>



  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  <script src="js/validations.js<? getVer(); ?>"></script>

  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/custom.css"  type="text/css">
  <script language="javascript" type="text/javascript">

  CSRF_TOKEN_SUB = <?= genCsrfTokenSubFilePhp('tokenNumber')?>;

  $(document).ready(function() {
      refreshUsbListTable();
      
      $("input[name='umountAll']").on("click", function() {
          toggleCheckbox();
      });
      
      $("#apply").on("click", function() {
          if( !validation())
          {
              return false;
          }
          else
          {
              var a=[];
              $(".checkbox:checked").each(function(){
                  a.push($(this).val());
              });
              var o={};
              o["umountAll"] = $("input[name='umountAll']:checked").val();
              o["disks"] = a.join(',');
              removePost(o);
          }
      
      });
  });

  function reloadClose()
  {
      window.opener.location.reload();
      //RAXE300-398,Steven add for pop-up message  when "safely remove usb device" button is clicked.
      window.opener.alert(window.opener.top.mlang["UASE29"]);
      window.close();  
  }

  function removePost(objData)
    {   
        var wrapObj = {};
        wrapObj.function = "removeUsb";
        wrapObj.data = objData;
        
        console.log(JSON.stringify(wrapObj));
        $.ajax({
            url: "/cgi-bin/rex_cgi?csrftoken_sub=" + CSRF_TOKEN_SUB,
            type: "POST",
            data: JSON.stringify(wrapObj),
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            success: function(json) {
                console.log(json.status);
                if(json.status == "success")
                    setTimeout(reloadClose, 1000);
                else
                {
                    window.opener.location.reload();
                    window.opener.alert(window.opener.top.mlang["UASE30"]);
                    window.close();
                }
            },
            error: function(json) {
                window.opener.location.reload();
                window.opener.alert(window.opener.top.mlang["UASE30"]);
                window.close();
            }
        });
    }
  function toggleCheckbox()
  {
          if($("input[name='umountAll']:checked").val() === "true")
          {
              $(".checkbox_row").css("pointer-events", "none");
              $(".checkbox_row").css("opacity", "0.5");
              $(".checkbox").prop("disabled", true);
              $(".checkbox").prop("checked", true);
          }
          else
          {
              $(".checkbox_row").css("pointer-events", "");
              $(".checkbox_row").css("opacity", "");
              $(".checkbox").prop("disabled", false);
              $(".checkbox").prop("checked", false);
          }  
  }
  
  function validation()
  {
    var msg = "";
    if ($("input[name='umountAll']:checked").val() === "false")
    {
        if($(".checkbox:checked").length < 1)
        {
            msg += window.opener.top.mlang["UASE23"];
        }
    }

    if (msg.length > 1)
    {
        alert(msg);
        return false;
    }
    return true;
  }
  
  function removeTableRow()
  {
      $(".table_row").remove();  
  }
  
  function refreshUsbListTable()
  {
      var new_tr = '<tr class="table_row checkbox_row">\r\n\
                    <td><INPUT class=\"checkbox\"name=\"usb__index\" type=\"checkbox\" value=\"__disk\" checked>__deviceName __productName(__disk:__volume_name)</td>\r\n\
                    </tr>';
      fetchTableData('usb_list', 'usb_list_table', new_tr, 'removeTableRow', 'toggleCheckbox');  
  }
  
  function initLoad()
  {
      $("[mlang]").each(function(idx, obj) {
          obj.innerHTML = window.opener.top.mlang[obj.attributes.mlang.value];    
      });
  }
  </script>  
</head>

<body onload="initLoad()" class="page-body">
  <form id="target" name="formname" method="POST" >
    <div class="page-header" style="position: relative;color: #09c;" mlang="UBS011">Safely Remove USB Device</div>
    <div class="form-group" style="overflow:auto;scrolling:auto">
      <div class="form-row ">
        <img src="images/liteblue.gif" height="12" width="97%">
      </div>
      <div class="form-row ">
        <p style="display:inline-block;" mlang="UASE18"></p>
        <input type="radio"  checked name="umountAll" value="true" ></input><span mlang="SWP003">Yes</span>
        <input type="radio" name="umountAll" value="false"></input><span mlang="SWP009">No</span>
      </div>
      <div class="form-row ">
        <table id="usb_list" border="0" cellpadding="0" cellspacing="3" width="100%">
        </table>
      </div>
      <div class="form-row">
        <button type="button" value="Apply" name="Apply" id="apply" class="button-rule"><span mlang="LUP004">Apply</span></button>
        <button type="button" value="Cancel" name="Cancel" id="cancel" class="button-rule" onclick="window.close();"><span mlang="UAS021">Cancel</span></button>
      </div>
    </div><!--form-group-->  
</form>
</body>
</html>
