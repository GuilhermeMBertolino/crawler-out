<!DOCTYPE HTML>
<!-- include PHP to use php functions -->
<? include 'php/commonCfg.php';?>

<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= getModelNameStr()?></title>

  <link rel="stylesheet" href="css/table_noh.css">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" href="css/custom.css">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.inputmask.min.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  <script src="js/validations.js<? getVer(); ?>"></script>

  <script language="javascript" type="text/javascript">

    CSRF_TOKEN = <?= genCsrfTokenFilePhp('tokenNumber')?>;

    $(document).ready(function()
    {
        fetchData('target', 'password', '', 'post_fillout_init');
    });

    function formSubmit() {
        if (validation()) {
            /* do base64 encode for new password, answer1, answer2 */
            var encrypt_old_password = btoa($('#target [name=oldPassword]').val());
            var encrypt_new_password = btoa($('#target #sys_new_passwd').val());
            var encrypt_answer1 = btoa($('#target [name=answer1]').val());
            var encrypt_answer2 = btoa($('#target [name=answer2]').val());

            /* sync new password to password for post */
            $('#target [name=oldPassword]').val(encrypt_old_password);
            $('#target [name=password]').val(encrypt_new_password);
            $('#target [name=answer1]').val(encrypt_answer1);
            $('#target [name=answer2]').val(encrypt_answer2);
            
            $.postForm('setPassword', $('#target'), 'cgi-bin/rex_cgi', 'check_oldPassword_handler');
        }
    }
    

    function validation()
    {
        var old_password = $('#target #sys_old_passwd').val();
        var new_password = $('#target #sys_new_passwd').val();
        var confirm_password = $('#target #sys_confirm_passwd').val();
        var enableReset = $('#target [name=enableReset]').val();
        var answer1 = $('#target [name=answer1]').val();
        var answer2 = $('#target [name=answer2]').val();
        var question1 = $('#target select[name=question1]').val();
        var question2 = $('#target select[name=question2]').val();
        
        if (new_password == "") {
            //"Password cannot be blank"
            alert(window.top.mlang["ADDE02"]);
            document.getElementById("apply").style.backgroundColor = "#c0c0c0";
            document.getElementById("apply").disabled = true;
            return false;
        }

        if (new_password == "password") {
            //"You cannot use the default admin password. You must change the admin password."
            alert(window.top.mlang["SWP080"]);
            return false;
        }

        if (new_password.length < 10) {
            alert(window.top.mlang["PWD003"]);
            return false;
        }

        if (!new_password.match(/[A-Z]/))
        {
            alert(window.top.mlang["PWD006"]);
            return false;
        }

        if (!new_password.match(/[a-z]/))
        {
            alert(window.top.mlang["PWD007"]);
            return false;
        }

        if (new_password.length > 32 || confirm_password.length > 32) {
            //"Maximum password length is 32 characters!"
            alert(window.top.mlang["MSPE01"]);
            return false;
        }
        
        if (new_password != confirm_password) {
            //"The password you typed does not match. Please enter it again."
            alert(window.top.mlang["SWPE13"]);
            $('#target #sys_confirm_passwd').focus();
            return false;
        }
        
        if (enableReset == "false") {
            //"If you do not enable password recovery and forget your new password, the only way to recover the password is to reset the device to factory default."
            if(confirm(window.top.mlang["genie_59"]))
            {
                return true;
            }
            else
            {
                return false;
            }
        }
        else if (enableReset == "true") {
            if(answer1.length < 1 || answer1.length > 64)
            {
                //"Please enter your answer for each question."
                alert(window.top.mlang["genie_95"]);
                return false;
            }
            if(answer2.length < 1 || answer2.length > 64)
            {
                alert(window.top.mlang["genie_95"]);
                return false;
            }

            if(question1 == "0" || question2 == "0")
            {
                //"Please select a question."
                alert(window.top.mlang["genie_97"]);
                return false;
            }
        }
        
        return true;
    }
    
    function post_fillout_init()
    {   
        /* init function */
        init_enableReset();

		//steven 0416 add 
		isLastTimerestchecked();
        
        /* register a onClick/onChange funtion */
        $('#target #sys_new_passwd').on('keyup', function() {
            onKeyUp_sys_new_passwd();
        });
        $('#target #sys_new_passwd').on('keydown', function() {
            onKeyDown_sys_new_passwd();
        });
        $('#target [name=enableReset]').on('change', function() {
            $('#target [name=enableReset]').val($('#target [name=enableReset]').prop("checked"));
            onChange_enableReset();
        });
    }

	//steven 0416 add 
	function isLastTimerestchecked()
	{
		var lastRecovered = document.getElementById("last_recovered").innerText;
		//alert(lastRecovered);
		if(lastRecovered == "")
		{
			document.getElementById("strLastPasswordResetTime").hidden  = true;
		}
		else
		{
			document.getElementById("strLastPasswordResetTime").hidden  = false;
			$('#strLastPasswordResetTime').show();
		}
	}

    /* init function Section --------> Begin */
    function init_enableReset()
    {
        onChange_enableReset();
    }
    
    /* init function Section --------> End */
    
    /* Onclick Callback Section --------> Begin */
    function onKeyUp_sys_new_passwd()
    {
        setTimeout("newPasswordCheck()", 100);
    }
    
    function onKeyDown_sys_new_passwd()
    {
        //$("#passwd_hint_content")[0].style.display="none";
    }
    
    function onChange_enableReset()
    {
        var enableReset = $('#target [name=enableReset]').val();
        
        if (enableReset == "true") {
            $('#password_reset_fields').show();
        }
        else {
            $('#password_reset_fields').hide();
        }
    }

    /* Onclick Callback Section --------> End */

    function newPasswordCheck()
    {
        var passwd = $('#target #sys_new_passwd').val();
        var check_result=false;
        if(passwd != "")
        {
            var conditions = 0;

            /* Rule 1: Contains 10 to 32 characters*/
            if (passwd.length < 10 || passwd.length > 32 ) {
                document.getElementById("weak_password_rule2").style.display ="none";
                document.getElementById("weak_password_rule2_gray").style.display="table-cell";
            }
            else {
                document.getElementById("weak_password_rule2").style.display="table-cell";
                document.getElementById("weak_password_rule2_gray").style.display ="none";
                conditions+=1;
            }

            /* Rule 2: At least constins one upper case character*/
            if (passwd.match(/[A-Z]/)) {
                document.getElementById("weak_password_rule1_1").style.display="table-cell";
                document.getElementById("weak_password_rule1_1_gray").style.display ="none";
                conditions+=1;
            }
            else {
                document.getElementById("weak_password_rule1_1").style.display="none";
                document.getElementById("weak_password_rule1_1_gray").style.display="table-cell";
                check_result = false;
            }

            /* Rule 3: At least constins one lower case character*/
            if (passwd.match(/[a-z]/)) {
                document.getElementById("weak_password_rule1_2").style.display="table-cell";
                document.getElementById("weak_password_rule1_2_gray").style.display ="none";
                conditions+=1;
            }
            else {
                document.getElementById("weak_password_rule1_2").style.display ="none";
                document.getElementById("weak_password_rule1_2_gray").style.display="table-cell";
            }

            if (conditions < 3)
            {
                check_result = false;
            }
            else
            {
                check_result = true;
            }

            if (check_result == false)
            {
                document.getElementById("passwd_hint_content").style.display="table-row";
                document.getElementById("pwd_warn").style.display="";
                document.getElementById("pwd_strong").style.display="none";
            }
            else {
                document.getElementById("passwd_hint_content").style.display="none";
                document.getElementById("pwd_warn").style.display="none";
                document.getElementById("pwd_strong").style.display="";
            }
            document.getElementById("apply").style.backgroundColor = "#3F354B";
            document.getElementById("apply").disabled = false;
        }
        else {
            document.getElementById("passwd_hint_content").style.display="none";
            document.getElementById("pwd_warn").style.display="none";
            document.getElementById("pwd_strong").style.display="none";
            document.getElementById("apply").style.backgroundColor = "#c0c0c0";
            document.getElementById("apply").disabled = true;
        }
        return true;
    }
    
    function reload_MainPage()
    {
        location.href='PWD_password.html';
    }
    
    function check_oldPassword_handler(json)
    {
        /* Show password error page while old password check fail */
        if (json.message == "Password is wrong") {
            $('#main_page').hide();
            $('#password_error_page').show();
            
            setTimeout('reload_MainPage()' ,8000);
        }
        else {
            reload_MainPage();
        }
        
    }
    
  </script>


</head>

<body onload="window.top.change_size($(this));loadhelp('PWD_passwd','');" class="page-body" onResize="window.top.change_size($(this));">
    <div id="main_page">
        <div class="page-header" style="position: relative;">
            <span mlang="LUP025">Set Password</span>
        </div>
    
        <div id="main" class="form-group"  style="overflow:auto;scrolling:auto">
    
        <!-- form -->
        <form id="target"  name="formname" method="POST" >
            <div class="form-row">
                <span mlang="MSP001">Old Password</span>
            </div>
            <div class="form-row">
                <input type="password" class="input1" name="oldPassword" id="sys_old_passwd" size="18" maxlength="32">
                <input type="hidden" id="password" name="password">
            </div>
        
            <div class="form-row">
                <span mlang="LUP025">Set Password</span>
            </div>
            <div class="form-row">
                <input type="password" class="input1" id="sys_new_passwd" size="18" maxlength="32">
                <img id="pwd_warn"; src="images/warning.png" style="display:none; vertical-align:middle; width:16px;height:16px">
                <img id="pwd_strong"; src="images/DDNS_Yes.png" style="display:none; vertical-align:middle; width:16px;height:16px">
            </div>

            <div id="passwd_hint_content" style="display: none">
                <td align="left" colspan="2" style="margin-top: -17px">
                    <div style="border-radius:30px; background-color:#D3D3D3; font-size:11px; width: 700px">
                        <table style="width:100%">
                            <tr>
                                <td width="100%" align="left" colspan="3" style="display: table-cell;padding-left:20px;height:22px" mlang="PWD002"></td>
                            </tr>

                            <tr style="display: flex">
                                <td width="5%" align="left">
                                    <img id="weak_password_rule2" src="images/DDNS_Yes.png" style="display: none;padding-left:20px;height:75%">
                                    <img id="weak_password_rule2_gray" src="images/DDNS_Yes_gray.png" style="display: table-cell;padding-left:20px;height:75%">
                                </td>
                                <td width="95%" colspan="2" align="left" style="height:22px;padding-left: 25px" mlang="PWD001"></td>
                            </tr>

                            <tr style="display: flex">
                                <td width="5%" align="left">
                                    <img id="weak_password_rule1_1" src="images/DDNS_Yes.png" style="display: none;padding-left:20px;height:75%">
                                    <img id="weak_password_rule1_1_gray" src="images/DDNS_Yes_gray.png" style="display: table-cell;padding-left:20px;height:75%">
                                </td>
                                <td width="95%" colspan="2" align="left" style="height:22px;padding-left: 25px" mlang="PCVP_036"></td>
                            </tr>

                            <tr style="display: flex">
                                <td width="5%" align="left">
                                    <img id="weak_password_rule1_2" src="images/DDNS_Yes.png" style="display: none;padding-left:20px;height:75%">
                                    <img id="weak_password_rule1_2_gray" src="images/DDNS_Yes_gray.png" style="display: table-cell;padding-left:20px;height:75%">
                                </td>
                                <td width="95%" colspan="2" align="left" style="height:22px;padding-left: 25px" mlang="PCVP_037"></td>
                            </tr>
                        </table>
                    </div>
                </td>
            </div>
        
            <div class="form-row">
                <span mlang="MSP003">Repeat New Password</span>
            </div>
            <div class="form-row">
                <input type="password" class="input1" id="sys_confirm_passwd" size="18" maxlength="32">
            </div>
        
            <div class="form-row">
                <label class="checkbox-container">
                    <span mlang="PCVP_050" >Enable Password Reset</span>
                        <input type="checkbox" name="enableReset" id="enable_recovery" value="true">
                    <span class="checkbox-checkmark"></span>
                </label>
            </div>
        
            <div id="password_reset_fields">
                <div class="form-row">
                    <span mlang="genie_117">Security Question #1</span> <span>*:</span>
                </div>
                <div class="form-row">
                    <select name="question1" id="question1" size=1>
                        <option value="0" selected mlang="genie_97">Please select a question.</option>
                        <option value="1" mlang="genie_149">What was the name of the first NETGEAR product you purchased?</option>
                        <option value="2" mlang="genie_150">What was the name of the first school you attended?</option>
                        <option value="3" mlang="genie_145">"What is your oldest sister's first name?</option>
                        <option value="4" mlang="genie_144">What is your oldest brother's first name?</option>
                        <option value="5" mlang="genie_63">In what city were you born?</option>
                        <option value="6" mlang="genie_142">What is your grandmother's first name?</option>
                        <option value="7" mlang="genie_141">What is your grandfather's first name?</option>
                        <option value="8" mlang="genie_64">In what year (YYYY) did you graduate from high school?</option>
                        <option value="9" mlang="genie_138">"What is the name of your first employer?</option>
                    </select>
                </div>
        
                <div class="form-row">
                    <span mlang="genie_17">Answer</span> <span>*:</span>
                </div>
                <div class="form-row">
                    <input type="password" class="input1" name="answer1" id="answer1" size="64" maxlength="64" onfocus="this.value='';">
                </div>
        
                <div class="form-row">
                    <span mlang="genie_118">Security Question #2</span> <span>*:</span>
                </div>
                <div class="form-row">
                    <select name="question2" id="question2" size=1>
                        <option value="0" selected mlang="genie_97">Please select a question.</option>
                        <option value="1" mlang="genie_147">What is your youngest sister's first name?</option>
                        <option value="2" mlang="genie_146">What is your youngest brother's first name?</option>
                        <option value="3" mlang="genie_140">What is your father's middle name?</option>
                        <option value="4" mlang="genie_143">"What is your mother's middle name?</option>
                        <option value="5" mlang="genie_148">What was the first name of your first manager?</option>
                        <option value="6" mlang="genie_62">In what city was your mother born?</option>
                        <option value="7" mlang="genie_61">In what city was your father born?</option>
                        <option value="8" mlang="genie_139">What is your best friend's first name?</option>
                    </select>
                </div>
        
                <div class="form-row">
                    <span mlang="genie_17">Answer</span> <span>*:</span>
                </div>
        
                <div class="form-row">
                    <input type="password" class="input1" name="answer2" id="answer2" size="64" maxlength="64" onfocus="this.value='';">
                </div>
        
                <div class="form-row">
                    <span mlang="genie_6">"*=required information</span>
                </div>
                
                <div id="strLastPasswordResetTime" class="form-row">
                    <span mlang="PCVP_052">Last time password was reset :</span> <span name="lastPasswordResetTime" id="last_recovered"></span>
                </div>
                <!--
                <div class="form-row">
                    <span name="lastPasswordResetTime" id="last_recovered"></span>
                </div>
                -->
            </div>
        </form>
        <!-- form end -->
    
        </div><!-- form-group end -->
    
        <div class="form-btn-row" id="form_btn_div">
            <button type="button" value="cancel"  onClick="location.href='PWD_password.html';" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
            <button type="button" value="apply"  onClick="formSubmit($(this))" name="apply" id="apply" class="button-apply apply_bt" style="background-color:#c0c0c0" disabled mlang="LUP004">Apply</button>
        </div>

        <? genHelpSection()?>
    </div><!-- main page end-->
  
    <div id="password_error_page" style="display:none"> 
        <div class="page-header" style="position: relative;">
            <span mlang="AWC005">Failure</span>
        </div>
    
        <div id="main1" class="form-group"  style="overflow:auto;scrolling:auto">
            <form id="target_error"  name="formname" method="POST" >
                <div align="center" class="form-row">
                    <b mlang="MSPE02">The old password is wrong!</b>
                </div>
            
                <div class="divider">&nbsp;</div>
           
                <div align="center" class="form-row">
                    <b mlang="CBS009">This screen will automatically return to the previous screen in a few seconds...</b>
                </div>
            </form>
        </div>
    </div><!-- password_error page end-->
</html>
