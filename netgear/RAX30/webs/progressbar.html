<!DOCTYPE HTML>
<? include 'php/commonCfg.php';?>
<? genCsrfTokenFilePhp('noOutput'); ?>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">
  
  <title>NETGEAR Router <?= getModelNameStr()?></title>

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  <script src="js/menu.js<? getVer(); ?>"></script>

  <link rel="stylesheet" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/custom.css">

  <script language="javascript" type="text/javascript">
  var pchar = "||";// progress char
  var maxchars = 60;
  var delay_time = 1000;// msecs
  var charcount = 0;
  var duration = 90000;
  var sysReady = false;
  var disconnect = false;
  var nextURL = null;
  var startTime;

  $(document).ajaxError(function(event, request, settings){
      if(!disconnect)
      {
          disconnect = true;
          $("input[name='fwVersion']").val("default");
      }    
  });

  function makeStr(strSize, fillChar)
  {
      var temp = "";
      for (i=0; i < strSize ; i ++)
          temp = temp + fillChar;
      return temp;
  }

  function showProgress()
  {
      sessionStorage.getItem("barTitle") ? $("[name=barTitle]").attr('mlang', sessionStorage.getItem("barTitle")) : $("[name=barTitle]").attr('mlang');
      $("#pgbar-div").toggle();
      delay_time = sessionStorage.getItem("delay") ? sessionStorage.getItem("delay") : delay_time;
      duration = sessionStorage.getItem("duration") ? sessionStorage.getItem("duration") : duration;
      nextURL = sessionStorage.getItem("nextURL") ? sessionStorage.getItem("nextURL") : nextURL;
      if (nextURL == "/WIZ_sel.html.postConfig_callback")
      {
          nextURL = "/WIZ_sel.html";
          $("[name=barTitle]").attr("id", "card-restoring-router-settings");
      }
      sessionStorage.getItem("guiId") ? $("input[name='progress']").attr('id', sessionStorage.getItem("guiId")) : $("input[name='progress']").attr('id', "progress");
      //console.log($("#barTitle").attr('mlang')+", "+delay_time+", "+duration+", "+nextURL);
      sessionStorage.removeItem("barTitle");
      sessionStorage.removeItem("delay");
      sessionStorage.removeItem("duration");
      sessionStorage.removeItem("nextURL");
      sessionStorage.removeItem("guiId");
      startTime = (new Date()).valueOf();
      updateProgress();
  }

  function updateProgress()
  {
      var delta = (new Date()).valueOf() - startTime;
      if(delta > (duration * 0.9))//over 90%, start to polling state.
      {
          checkSystemReady();
      }

      if(sysReady)
      {
          redirectNextURL();
      }
 
      if(delta > duration)
      {
          console.log("Error: Exceed the time of rebooting !");
          redirectNextURL();
          return ;
      }
 
      if (charcount < maxchars)
      {
          charcount ++;
      }

      $("input[name='progress']").val(makeStr(charcount,pchar));
      setTimeout("updateProgress()",delay_time);
  }

  function redirectNextURL()
  {
      if( nextURL ) //For LAN ip change
      {
          sessionStorage.removeItem("nextURL");
          if(nextURL.match("http://") || nextURL.match("https://"))
          {
              top.window.location.replace(nextURL);
          }
          else
          {
              window.location.replace(nextURL);
          }
      }
      else
      {
          window.top.location.reload();
      }
  }

  function checkSystemReady()
  {
      fetchData('target', 'sysReady', '', 'post_fillout');
  }

  function post_fillout()
  {
      if($("input[name='fwVersion']").val() != "default")
          sysReady = true;
  }
  </script>
</head>


<body onload="showProgress();" style="margin:0px;display: inline-flex;overflow: hidden;width: 100%;">
<form id="target" style="width: 100%;">
  <div class="form-group" id="pgbar-div" style="display:none;height:600px;overflow:auto;scrolling:auto">
      <div class="form-row prgbar">
        <h1 name="barTitle" id="pls_wait_div" mlang="SWP046">Updating Settings</h1>
      </div>
      <div class="form-row prgbar">
        <input type="text" name="progress" id="progress" value="" disabled />
      </div>
      <div class="divider">&nbsp;</div>
  </div>
  <input type="hidden" name="fwVersion" value="default"/>
</form>
</body>
</html>
