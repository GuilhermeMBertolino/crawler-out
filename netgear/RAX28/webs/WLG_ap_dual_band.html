<!DOCTYPE HTML>
<!-- include PHP to use php functions -->
<? include 'php/commonCfg.php';?>

<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= getModelNameStr()?></title>

  <link rel="stylesheet" href="css/table_noh.css">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" href="css/custom.css">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.inputmask.min.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  <script src="js/validations.js<? getVer(); ?>"></script>

  <script language="javascript" type="text/javascript">
    
    CSRF_TOKEN = <?= genCsrfTokenFilePhp('tokenNumber')?>;

    $(document).ready(function()
    {
        fetchData('target', 'wireless_apmode', '', 'post_fillout_init');
    });

    function formSubmit() {
        //fill the ip data to hidden input
        $("[name=ipAddr]").val($("#ipAddr-ip").getIp());
        $("[name=netmask]").val($("#netmask-ip").getIp());
        $("[name=gateway]").val($("#gateway-ip").getIp());
        $("[name=dns1]").val($("#dns1-ip").getIp());
        $("[name=dns2]").val($("#dns2-ip").getIp());
        
        if (validation()) {
            /* system would reboot after sending post, show progress bar */
            sessionStorage.setItem("nextURL", "/WLG_ap_dual_band.html");
            setTimeout("redirectProgressBar('D-genie_377')", 100);
            
            $.postForm('apMode', $('#target'), 'cgi-bin/rex_cgi', 'after_postForm_handler');
        }
    }
    
    function after_postForm_handler(json)
    {
        //handle error
        if (json.code == -1) {
            alert("ajax error : " + json.message);
            return false;
        }
        else if (json.status != "success") {
            alert("cgi response error!");
            document.location.reload();
            return false;
        }
        
        var apmode_enable = $("[name=enable]").val();
        
        //show the greyout/un-greyout menu of start.html
        if (apmode_enable == "true") {
            //greyout ApMode-ReadOnly submenus when DUT is in ap mode
            parent.$(".ApMode-ReadOnly").css("pointer-events", "none");
            parent.$(".ApMode-ReadOnly").css("opacity", "0.5");
            parent.$(".ApMode-ReadOnly").addClass("auto_grey");
        }
        else if (apmode_enable == "false") {
            //un-greyout ApMode-ReadOnly submenus when DUT leave ap mode
            parent.$(".ApMode-ReadOnly").css("pointer-events", "");
            parent.$(".ApMode-ReadOnly").css("opacity", "");
            parent.$(".ApMode-ReadOnly").removeClass("auto_grey");
        }
        
        //location.href='WLG_ap_dual_band.html';
    }

    function validation()
    {
        var enable = $("[name=enable]").val();
        var msg = "";
        
        if (enable == "false") {
            //ap mode is disabled, no need to check other fields
            return true;
        }
        
        var ipType = $("[name=ipType]:checked").val();
     
        if (ipType == "fixed") {
            
            var ipAddr = $("[name=ipAddr]").val();
            var gateway = $("[name=gateway]").val();
            var netmask = $("[name=netmask]").val();
            var dns1 = $("[name=dns1]").val();
            var dns2 = $("[name=dns2]").val();
            
            //check if IP fields are valid IP string
            if (isValidIpStr(ipAddr) == false) {
                //"Invalid IP address. Please enter it again."
                msg += window.top.mlang["SWPE05"] + "\n";
            }
            if (isValidNetmaskStr(netmask) == false) {
                //"Invalid subnet mask. Please enter it again.\n"
                msg += window.top.mlang["SWPE06"];
            }
            if (isValidIpStr(gateway) == false) {
                //"Invalid gateway IP address. Please enter it again."
                msg += window.top.mlang["SWPE04"] + "\n";
            }
            if (isValidIpStr(dns1) == false) {
                //"Invalid primary DNS address. Please enter it again.\n";
                msg += window.top.mlang["SWPE08"];
            }
            if (isValidIpStr(dns2) == false) {
                //"Invalid secondary DNS address. Please enter it again.\n";
                msg += window.top.mlang["SWPE09"];
            }
            
            if (msg.length > 1) {
                alert(msg);
                return false;
            }
            
            //check if ip and gateway is in same subnet
            if (isSameSubnet_v4(ipAddr, gateway, netmask) == false) {
                //Error: IP Address xxx.xxx.xxx.xxx "is in a different subnet as the gateway address xxx.xxx.xxx.xxx
                alert(window.top.mlang["SBSE09"] + ipAddr + window.top.mlang["SBSE11"] + gateway);
                return false;
            }
            
        }
        
        //"Please change your computer's IP address manually if LAN IP subnet will be changed."
        alert(window.top.mlang["ALSW02"]);
        
        return true;
    }
    
    function post_fillout_init()
    {   
        /* init function */
        init_ipType();
        init_enable();

        /* register a onClick/onChange funtion */
        $('#target [name=enable]').on('change', function() {
            $('#target [name=enable]').val($('#target [name=enable]').prop("checked"));
            onChange_enable();
        });
        $('#target [name=ipType]').on('change', function() {
            onChange_ipType();
        });
    }
    
    /* init function Section --------> Begin */
    function init_enable()
    {
        onChange_enable();
    }
    
    function init_ipType()
    {
        onChange_ipType();
    }
    /* init function Section --------> End */
    
    /* Onclick Callback Section --------> Begin */
    function onChange_enable()
    {
        var enable = $('#target [name=enable]').val();
        
        if (enable == "true") {
            $('#apmode_fields').show();
        }
        else {
            $('#apmode_fields').hide();
        }
    }
    
    function onChange_ipType()
    {
        var ipType = $('#target [name=ipType]:checked').val();
        
        if (ipType == "fixed") {
            $('#fixed_ip_fields').show();
        }
        else {
            $('#fixed_ip_fields').hide();
        }
    }
    
    function isValidIpStr(str)
    {
        var ip = str.split('.');
        var i;
        
        if (ip.length != 4) {
            return false;
        }
        
        for (i = 0; i < ip.length; i++) {
            if (isNumStr(ip[i]) == false) {
                return false;
            }
            
            if (parseInt(ip[i]) < 0 || parseInt(ip[i]) > 255) {
                return false;
            }
        }
        
        if (parseInt(ip[3]) == 0 ) {
            return false;
        }
        
        return true;
    }
    
    function isNumStr(str)
    {
        var i;
        if (str.length == 0) {
            return false;
        }
        
        for(i = 0; i < str.length; i++) {
            var c = str.substring(i, i+1);
            if("0" <= c && c <= "9") {
                continue;
            }
            return false;
        }
        
        return true;
    }
    
    function isValidNetmaskStr(netmask_str)
    {
        var netmaskArr = netmask_str.split(".");
        var netmask_bin = (parseInt(netmaskArr[0],10) << 24) | (parseInt(netmaskArr[1],10) << 16) | (parseInt(netmaskArr[2],10) << 8) | (parseInt(netmaskArr[3]));
        
        return isNetmask(netmask_bin); 
    }

    /* Onclick Callback Section --------> End */ 
  </script>


</head>

<body onload="window.top.change_size($(this));loadhelp('WLG_ap_dual_band','');" class="page-body" onResize="window.top.change_size($(this));">
    <div id="main_page">
        <div class="page-header" style="position: relative;">
            <span mlang="MRS052">Wireless AP</span>
        </div>
    
        <div id="main" class="form-group"  style="overflow:auto;scrolling:auto">
    
        <!-- form -->
        <form id="target"  name="formname" method="POST" >
            <div class="form-row">
                <b mlang="genie_196">Wireless AP mode allows this device to work as a stand-alone wireless access point on your existing network.</b>
            </div>
            
            <div class="form-row">
                <label class="checkbox-container">
                    <span mlang="AAW029" >Enable AP Mode</span>
                        <input type="checkbox" name="enable" id="operation_type_ap" value="true">
                    <span class="checkbox-checkmark"></span>
                </label>
            </div>
            
            <div class="form-row">
                <img src="images/AP_Mode.png" alt="AP Mode" width="623" height="302" border="0" >
            </div>

            <div id="apmode_fields">
                <div class="form-row">
                    <span mlang="AWA003">This would be this device's wireless settings as an access point:</span>
                </div>
                <table style="width:100%">
                    <tr>
                        <td mlang="AWA004">Wireless Name (SSID):</td>
                        <td><span name="24GSSID">24GSSID</span></td>
                        <td><span name="5GSSID">5GSSID</span></td>
                        <td></div>
                    </tr>
                    <tr>
                        <td mlang="AWA005">Wireless Password (Key):</td>
                        <td ><span name="24GPassword">24GPassword</span></td>
                        <td ><span name="5GPassword">5GPassword</span></td>
                        <td></td>
                    </tr>
                </table>
                
                <div class="form-row" style="width:680px">
                    <span mlang="PCVP_020">If you want to change, go to Setup->Wireless Setup to change it, your computer needs to reconnect using</span>
                    <span mlang="PCVP_021">new setting, then come back to this page.</td>
                </div>
                
                <div class="form-row" style="width:680px">
                    <span mlang="PCVP_022">NETGEAR recommends you to use different wireless settings from your existing wireless network to avoid</span>
                    <span mlang="PCVP_023">interference, or you should disable or turn off wireless signal on your existing router.</span>
                </div>         
                
                <div class="form-row">
                    <b mlang="AWA008">To add this router to your network in Access Point Mode:</b>
                </div>
                
                <tr></tr>
                
                <div class="form-row" style="width:680px">
                    <span mlang="PCVP_024">Connect one end of an Ethernet cable to the Internet port of this router, and the other end to a</span>
                    <span mlang="PCVP_025">LAN port in the existed router.</span>
                </div>
                    
                <div class="form-row">
                    <span mlang="AWA010">Choose IP Address settings on this access point</span>
                </div>
                
                <div class="form-row">
                    <label class="checkbox-container" ><div mlang="AWA011">Get dynamically from existing router</div>
                    <input type="radio" name="ipType" id="enable_dynamic_ip_setting" value="dynamic">
                    <span class="radio-checkmark"></span>
                    </label>
                </div>
                <div class="form-row">
                    <label class="checkbox-container" ><div mlang="genie_197">Enable fixed IP settings on this device (not recommended)</div>
                    <input type="radio" name="ipType" id="enable_fixed_ip_setting" value="fixed">
                    <span class="radio-checkmark"></span>
                    </label>
                </div>
                
                <div id="fixed_ip_fields">
                    <div class="form-row">
                        <span mlang="SWP030">IP Address</span>
                    </div>
                    <div class="form-row">
                        <div id="ipAddr-ip"></div>
                        <input type="hidden" name="ipAddr">
                    </div>
                    
                    <div class="form-row">
                        <span mlang="SWP044">IP Subnet Mask</span>
                    </div>
                    <div class="form-row">
                        <div id="netmask-ip"></div>
                        <input type="hidden" name="netmask">
                    </div>
                    
                    <div class="form-row">
                        <span mlang="SWP034">Gateway IP Address</span>
                    </div>
                    <div class="form-row">
                        <div id="gateway-ip"></div>
                        <input type="hidden" name="gateway">
                    </div>
                    
                    <div class="form-row">
                        <span mlang="SWP022">Primary DNS</span>
                    </div>
                    <div class="form-row">
                        <div id="dns1-ip"></div>
                        <input type="hidden" name="dns1">
                    </div>
                    
                    <div class="form-row">
                        <span mlang="SWP023">Secondary DNS</span>
                    </div>
                    <div class="form-row">
                        <div id="dns2-ip"></div>
                        <input type="hidden" name="dns2">
                    </div>
                </div> <!-- fixed_ip_fields div end-->
                
                <div class="form-row">
                    <span mlang="PCVP_026">Note: After you click Apply, this device will change to a new IP assigned by your existing router, therefore</span><br>
                    <span mlang="PCVP_027">this web page might not be available. Please close and restart the web browser to</span><br>
                    <span mlang="PCVP_028">http://www.routerlogin.net/ again.</span>
                </div>
                
            </div> <!-- apmode_fields div end-->

        </form>
        <!-- form end -->
    
        </div><!-- form-group end -->
    
        <div class="form-btn-row" id="form_btn_div">
            <button type="button" value="cancel"  onClick="location.href='WLG_ap_dual_band.html';" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
            <button type="button" value="apply"  onClick="formSubmit($(this))" name="apply" id="apply" class="button-apply apply_bt" mlang="LUP004">Apply</button>
        </div>

        <? genHelpSection()?>
    </div><!-- main page end-->
</html>
