<!DOCTYPE HTML>
<? include 'php/usb.php';?>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= getModelNameStr()?></title>

  <link rel="stylesheet" type="text/css" href="css/table_noh.css">
  <link rel="stylesheet" type="text/css" href="css/scrollbar.css">
  <link rel="stylesheet" type="text/css" href="css/button.css">
  <link rel="stylesheet" type="text/css" href="css/form.css">
  <link rel="stylesheet" type="text/css" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" type="text/css" href="css/custom.css" >

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  
  
  <script language="javascript" type="text/javascript">
    CSRF_TOKEN_SUB = <?= genCsrfTokenSubFilePhp('tokenNumber')?>;

    function browse_folder()
    {
        winoptions = "width=450,height=450,left=400,top=300,status=yes,resizable=0, scrollbars=yes";
        datSubWinVar = window.open('USB_browse_folder.html','browse',winoptions);
    }

    function checkShareNameDuplicate(sName)
    {
        var ret = false;
        window.opener.$("tr.table_row").find("input[name='share_folder']").each(function(){
            if((sName == $(this).val()))
            {
                ret = true;
                return;
            }    
        });
        return ret;
    }
    function validation()
    {
        var msg = "";
        if ($("input[name='folderNameDisplay']").val() == "")
        {
            alert(window.opener.top.mlang["UASE08"]);
            return false;
        }

        // check prefix
        var usbDevice = $("select[name='volumeName'] option:selected").text().split('(')[0];
        if($("input[name='folderNameDisplay']").val() != usbDevice && $("input[name='folderNameDisplay']").val().startsWith(usbDevice + "\\") == false)
        {
            alert(window.opener.top.mlang["UASE09"]);
            return false;
        }

        if ($("input[name='folderNameDisplay']").val().match( /[\x2E-\x2E]/ ))
        {
            alert(window.opener.top.mlang["UASE09"]);
            return false;
        }

        var currentShareName =$("input[name='newShareName']").val();
        var oldShareName =$("input[name='shareName']").val();
        if (currentShareName == "")
        {
            alert(window.opener.top.mlang["UASE05"]);
            return false;
        }

        
        if ( currentShareName.match( /[\x22-\x22]/ ) ||
             currentShareName.match( /[\x3A-\x3A]/ ) ||
             currentShareName.match( /[\x3C-\x3C]/ ) ||
             currentShareName.match( /[\x3E-\x3E]/ ) ||
             currentShareName.match( /[\x27-\x27]/ ) ||
             currentShareName.match( /[\x7C-\x7C]/ ) ||
             currentShareName.match( /[\x2F-\x2F]/ ) ||
             currentShareName.match( /[\x5D-\x5D]/ ) ||
             currentShareName.match( /[\x3E-\x3E]/ ) ||
             currentShareName.match( /[\x5C-\x5C]/ ) )
        {
            alert(window.opener.top.mlang["UASE04"]);
            return false;
        }
        if(currentShareName != oldShareName)
        {
	        if(checkShareNameDuplicate(currentShareName))
	        {
	            alert(window.opener.top.mlang["UASE06"]);
	            return false;
	        }
        }
        return true;
    }

    function refreshWindow()
    {
        window.opener.location.reload();
        window.close();  
    }

    // Use RAX-120's method to close the window
    function close_window()
    {
        window.close();
    }

    $(document).ready(function() {
         if(window.opener.tableAction == "Edit")
         {
             $("select[name='volumeName']").addClass("select2inputDisable");
             //$("select[name='volumeName']").prop("disabled", true);
             $("select[name='volumeName']").css("color", "#666");
             $("select[name='volumeName']").css("font-size", "16px");
             $("select[name='volumeName']").css("font-family", "Arial, Helvetica, Geneva, Swiss, SunSans-Regular, sans-serif");
             var selectedRowValues = window.opener.$("input[type='radio']:checked").closest("tr").find("input[type='hidden']");
             //$("input[name='volumeName']").val($(selectedRowValues).filter("[name='disk_name']").val());
             //$("select[name='volumeName']").val($(selectedRowValues).filter("[name='disk_name']").val());
             $("select[name='volumeName'] option").each(function(){
                if($(this).val().split('_')[1] == $(selectedRowValues).filter("[name='disk_name']").val().split('_')[1])
                {
                    $("select[name='volumeName']").val($(this).val());
                    return ;
                }
             });
             //$("input[name='volumeName']").text($(selectedRowValues).filter("[name='usb_device']").val());
             // Follow RAX-120 to remove 'File System'
             //$("#fileSystem").text($(selectedRowValues).filter("[name='file_system']").val());
             $("input[name='folderNameDisplay']").val($(selectedRowValues).filter("[name='folder_name']").val());
             $("input[name='shareName']").val($(selectedRowValues).filter("[name='share_folder']").val());
             $("input[name='newShareName']").val($(selectedRowValues).filter("[name='share_folder']").val());
             $("select[name='readAccess']").val($(selectedRowValues).filter("[name='read_access']").val());
             $("select[name='writeAccess']").val($(selectedRowValues).filter("[name='write_access']").val());
             $("input[name='action']").val("edit");
         }
         else
         {
            // Follow RAX-120 to remove 'File System'
            //$("#fileSystem").text($("select[name='volumeName'] option:selected").attr("format"));
         }
        $("button[name='browse']").on("click", function(){
            browse_folder();
        });
        
        $("select[name='volumeName']").on("change", function(){
            // Follow RAX-120 to remove 'File System'
            //$("#fileSystem").text($("option:selected",this).attr("format"));
        });
        
        // Follow RAX-120, if read's permission is changed to admin, then write's permission is changed accordingly
        $("select[name='readAccess']").on("change", function(){
            if ($("select[name='readAccess']").val() == "false") {
              $("select[name='writeAccess']").val("false");
            }
        });

        $("button[name='Apply']").on("click", function(){
            if(validation())
            {
                if(window.opener.tableAction != "Edit")
                {
                    $("input[name='shareName']").val($("input[name='newShareName']").val());
                }
                var newFolderName = $("input[name='folderNameDisplay']").val();
                if(newFolderName == $("select[name='volumeName'] option:selected").text().split('(')[0])
                {
                    $("input[name='folderName']").val(" ");
                }
                else
                {
                   $("input[name='folderName']").val(newFolderName.split(":\\")[1].replace(/\\/g,"/"));
                }
                $.postForm("netFolder", $('#target'), 'cgi-bin/rex_cgi', 'refreshWindow');
            }
        });
    });
    
  </script>

</head>
<body id="mybody" onload="window.opener.top.change_size($(this));window.opener.top.mlangInit($('#mybody'))" class="page-body" onResize="window.opener.top.change_size($(this));">
  <form id="target" name="formname" method="POST" >
    <input type="hidden" name="action" value="add"/>
    <div name="Create Network Folder" class="page_title" mlang="UAS012">Create Network Folder</div>
    <div id="main" class="form-group" style=height:450px;overflow:auto;scrolling:auto">
      <table border="1" cellpadding="2" cellspacing="0" width="100%" class="tbWhite cmn-table-2 mt-50">
        <tr class='el-hide'>
          <td colSpan="2"><h1></h1></td>
        </tr>
        <tr>
          <td colspan="2" class="top0"></td>
        </tr>
        <input type="hidden" name="folderName" value="" />
        <input type="hidden" name="shareName" value="" />
        <tr>
          <td colspan="2">
            <table border="1" cellpadding="2" cellspacing="0" width="100%">
              <tr>
                <td align="center" nowrap="nowrap" width="40%">
                  <span class="thead" mlang="UAS014">USB Device</span>
                </td>
                <td align="center" nowrap="nowrap" width="60%">
                  <span class="ttext">
                    <!--input name="volumeName" align="left" id="usb_device" style="font-size:16px; pointer-events: none; color: #666; border:none; font-family:Arial, Helvetica, Geneva, Swiss, SunSans-Regular, sans-serif"></inpu-->
                    <select name="volumeName" id="usb_device"  style="font-size:16px;height: 36px;font-family: 'Avenir Next'; padding: 0;color: #434343;">
                      <?= getVolumeList()?>
                    </select>
                  </span>
                </td>
              </tr>
              <!-- Follow RAX-120 to remove 'File System'
              <tr>
                <td align="center" nowrap="nowrap" width="40%">
                  <span class="thead" mlang="UAS015">File System</span>
                </td>
                <td align="center" nowrap="nowrap" width="60%">
                  <span class="ttext">
                    <p align="left" id="fileSystem" style="font-size:16px;color: #666;"></p>
                  </span>
                </td>
              </tr>
              -->
              <tr>
                <td align="center" nowrap="nowrap" width="40%">
                  <span class="thead" mlang="UAS016">Folder</span>
                </td>
                <td align="center" nowrap="nowrap" width="60%">
                  <span class="ttext">
                    <input class="input1" name="folderNameDisplay" id="folder" value="" style="font-size:16px;float: left;">
                    <button type="button" name="browse" id="browse" class="button-sty1" style="position:  relative;top: 10px;" mlang="UAS017"></button>
                  </span>
                </td>
              </tr>
              <tr>
                <td align="center" nowrap="nowrap" width="40%">
                  <span class="thead" mlang="UBS008">Share Name</span>
                </td>
                <td align="center" nowrap="nowrap" width="60%">
                  <span class="ttext">
                    <input class="input1" name="newShareName" id="share_name" value="" size="21" maxlength="20" style="font-size:16px;float: left">
                  </span>
                </td>
              </tr>
              <tr>
                <td align="center" nowrap="nowrap" width="40%">
                  <span class="thead" mlang="UBS009">Read Access</span>
                </td>
                <td align="center" nowrap="nowrap" width="60%">
                  <span>
                    <select name="readAccess" id="read_access" size="1">
                      <option value="true" mlang="UAS022">All - no password</option>
                      <option value="false" mlang="admin=" >admin</option>
                    </select>
                  </span>
                </td>
              </tr>
              <tr>
                <td align="center" nowrap="nowrap" width="40%">
                  <span class="thead" mlang="UBS010">Write Access</span>
                </td>
                <td align="center" nowrap="nowrap" width="60%">
                  <span class="ttext">
                    <select name="writeAccess" id="write_access" size="1">
                      <option value="true" mlang="UAS022">All - no password</option>
                      <option value="false" mlang="admin=" >admin</option>
                    </select>
                  </span>
                </td>
              </tr>
            </table>
          </td>
        </tr>
        <tr class='el-hide'>
          <td colspan=2>&nbsp;</td>
        </tr>
        <tr>
          <td colspan="2" align="center">
            <button type="button" value="" name="Close" id="close" class="button-sty1" onclick="close_window();" mlang="WP0006"></button>
            <button type="button" value="" name="Apply" id="apply" class="button-sty1" mlang="LUP004"></button>
          </td>
        </tr>
        <tr class='el-hide'>
          <td colspan=2>&nbsp;</td>
        </tr>
        <tr class='el-hide'>
          <td colspan=2>
            <img src=/liteblue.gif width=100% height=12>
          </td>
        </tr>
        <tr class='el-hide'>
          <td colspan=2>&nbsp;</td>
        </tr>
        <tr class='el-hide'>
          <td colspan=2 align="center">
            <button type="button" value="" name="Close" id="close" class="button-sty1" onclick="close_window();" mlang="WP0006"></button>
          </td>
        </tr>
      </table>
    </div>
  </form>
</body>
</html>
