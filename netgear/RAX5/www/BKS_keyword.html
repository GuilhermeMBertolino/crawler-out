<!DOCTYPE HTML>
<!-- include lua to use webGetFunc functions -->
<%
      local commonCfg = require "webGetFunc.commonCfg"
%>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= commonCfg.getModelNameStr()?></title>

  <link rel="stylesheet" type="text/css" href="css/table_noh.css">
  <link rel="stylesheet" type="text/css" href="css/scrollbar.css">
  <link rel="stylesheet" type="text/css" href="css/button.css">
  <link rel="stylesheet" type="text/css" href="css/form.css">
  <link rel="stylesheet" type="text/css" href="css/settings.css<? commonCfg.getVer(); ?>">
  <link rel="stylesheet" type="text/css" href="css/custom.css" >

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/utils.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/validations.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/ipInput.js"></script>
  
  <script language="javascript" type="text/javascript">
      CSRF_TOKEN = <?= commonCfg.genCsrfTokenFile('tokenNumber')?>;

      function refreshLoginSession()
      {
        $.ajax({
          type: "GET",
          url: "/index.html",
          success: function(res){}, // do nothing, just refresh login session time
        });
      }

      function post_fillout_init()
      {
          $("#keyword_addkeyword").on('click', function() {
              if(checkKeyword())
              {
                  refreshLoginSession();
                  addKeywordToList($("input[name='cfKeyWord_Domain']").val());
                  $("input[name='cfKeyWord_Domain']").val("");
              }    
          });

          $("#keyword_deletekeyword").on('click', function() {
              refreshLoginSession();
              removeList(":selected");
          });
          
          $("#keyword_clearlist").on('click', function() {
              refreshLoginSession();
              removeList("");
          });
          
          $("#trust_ip_enble").on('click', function() {
              this.value = this.checked ? "true" : "false";
              $('#trusted-ip :input').attr('readonly', ($(this).val() == "true") ? false : true );
          });
          $('#trusted-ip :input').attr('readonly', ($("#trust_ip_enble").val() == "true") ? false : true );
      }
      
      function checkKeyword()
      {
          var msg = "";
          var checkStr = $("input[name='cfKeyWord_Domain']").val();
          msg+= checkBlank(checkStr, "");
          
          if (checkStr.length >= 255){
              alert(window.top.mlang["CBSE02"]);
              return false;
          }
          
          if (msg.length > 1)
          {
              $("input[name='cfKeyWord_Domain']").focus();
              return false;
          }
          if (checkStr.match( /[^\x20-\x7E]/ ))
          {
              alert(window.top.mlang["CBSE01"]);
              return false;
          }

          var	word = checkStr.replace(/(^\w+:|^)\/\//, '');
          var wordExist = false;
          $("select[name='keyword_list'] option").each(function(){
              if($(this).text() == word)
              {
                  alert("duplicate name");//window.top.mlang["firewall068"]
                  $("input[name='cfKeyWord_Domain']").val("");
                  wordExist = true;
                  return false;//for break each
              }
          });

          if(wordExist)
              return false;
          else
          return true;
      }
      
      function addKeywordToList(word)
      {
          if($("select[name='keyword_list'] option").length >= 255)
          {
              alert(window.top.mlang["CBSE03"]);
              return false;
          }

          var opt = new Option(word, $("select[name='keyword_list'] option").length + 1);
          word = encodeHtml(word);
          $(opt).html(word);
          $("select[name='keyword_list']").append(opt);
      }
      
      function removeList(methodStr)
      {
          if($("select[name='keyword_list'] option").length == 0)
              return false;

          if (methodStr == ":selected" && $("select[name='keyword_list'] option:selected").length == 0)
          {
              alert(window.top.mlang["AAWE07"]);
              return false;
          }

          $("select[name='keyword_list'] option" + methodStr).remove();
          return true;
      }

      function validation()
      {

          var msg = "";

          var str_lan_ip = $("input[name='lanIpAddr']").val();
          var str_lan_netmask = $("input[name='lanIpMask']").val();
          var lan_ipaddr = ip2int(str_lan_ip);
          var lan_netmaskaddr = ip2int(str_lan_netmask);
          
          $("input[name='trustIpAddr']").val($("#trusted-ip input").map(function(){
              return $(this).val();
            }).get().join("."));

          if($("input[name='allowTrustIp']").prop("checked"))
          {
              var trusted_ipaddr = ip2int($("input[name='trustIpAddr']").val());
              if(!$("#trusted-ip").getIp() 
                || checkIP($("input[name='trustIpAddr']").val(),254)
                || (parseInt($("#trusted_ipaddress4").val(),10)==0)
                || ( (trusted_ipaddr & lan_netmaskaddr) != (lan_ipaddr & lan_netmaskaddr) ) )
              {    
                  msg+= window.top.mlang["SWPE05"] + "\n";
              }
          }
          if (msg.length > 1)
          {
              alert(msg);
              return false;
          }

          $("input[name='keywords']").val("");
          $("select[name='keyword_list'] option").each(function(i){
               if(i > 0)
                  var opt_val = ","+ encodeHtml($(this).text());
               else   
                  var opt_val = encodeHtml( $(this).text() );
                  
               $("input[name='keywords']").val(function(str_idx, oldVal){
                  return oldVal + opt_val;
               }); 
          });
          return true;
      }

      function formSubmit(btn)
      {
        $("button[name='apply']").prop("disabled", true);
        if(validation())
        {
            $.postForm('blockSites', $('#target'), 'cgi-bin/netgear.plua');
        }
        else
        {
            $("button[name='apply']").prop("disabled", false);
        }
      }


  </script>

</head>
<? commonCfg.bodyBegin('block_site', 'BKS_keyword', 'LUP017', 'Block Sites', '', 'post_fillout_init') ?>
  <div id="main" class="form-group" style=height:365px;overflow:auto;scrolling:auto">
    <div class="form-row">
      <span mlang="CBS015">
      To learn more about advanced content filtering and keyword blocking features from NETGEAR, please go to <a class="linktype" href="http://www.netgear.com/lpc"; target="_blank">www.netgear.com/lpc</a>.
      </span>
    </div>

    <div class="space-divider">&nbsp;</div>

    <div class="form-row ">
      <label class="checkbox-container">
        <span mlang="CBS012">Never</span>
        <input checked type="radio" name="blockingType" id="skeyword_never" value="never">
        <span class="radio-checkmark"></span>
      </label>
    </div>
    <div class="form-row ">
      <label class="checkbox-container">
        <span mlang="CBS013">Per Schedule</span>
        <input  type="radio" name="blockingType" id="skeyword_sched" value="schedule">
        <span class="radio-checkmark"></span>
      </label>
    </div>
    <div class="form-row ">
      <label class="checkbox-container">
        <span mlang="CBS001">Always</span>
        <input  type="radio" name="blockingType" id="skeyword_always" value="always">
        <span class="radio-checkmark"></span>
      </label>
    </div>

    <div class="space-divider">&nbsp;</div>

    <div class="form-row ">
      <a href="javascript:loadhelp('BKS_keyword','toaddword')" tabindex="-1">
        <b mlang="CBS008">Type keyword or domain name here.</b>
      </a>
    </div>

    <div class="form-row ">
      <input type="text" name="cfKeyWord_Domain" id="keyword_domain" size="32" maxlength="60" value="" class="input1"/>
    </div>

    <div class="form-row ">
      <button type="button"  name="cfKeyWord_AddKeyword" id="keyword_addkeyword" class="button-sty1" mlang="CBS002">Add Keyword</button>
    </div>

    <div class="space-divider">&nbsp;</div>

    <div class="form-row ">
      <a href="javascript:loadhelp('BKS_keyword','blocklist')" tabindex="-1">
        <b mlang="CBS005">Block sites containing these keywords or domain names:</b>
      </a>
    </div>

    <div class="form-row ">
      <select name="keyword_list" id="keyword_domainlist" size="6" multiple class="mb-15"></select> 
    </div>

    <div class="form-row ">
      <button type="button"  name="cfKeyWord_DeleteKeyword" id="keyword_deletekeyword" class="button-sty1" mlang="CBS006">Delete Keyword</button> 
      <button type="button"  name="cfKeyWord_ClearList" id="keyword_clearlist" class="button-sty1" mlang="CBS004">Clear List</button>
    </div>

    <div class="space-divider">&nbsp;</div>

    <div class="form-row ">
      <label class="checkbox-container">
        <input type="checkbox" name="allowTrustIp" id="trust_ip_enble" value="true">
        <a href="javascript:loadhelp('BKS_keyword','trusted')" tabindex="-1">
          <b mlang="CBS003">Allow trusted IP address to visit blocked sites</b>
        </a>
        <span class="checkbox-checkmark"></span> 
      </label> 
    </div>

    <div class="form-row ">
      <a href="javascript:loadhelp('BKS_keyword','trusted')" tabindex="-1">
        <b mlang="CBS014">Trusted IP Address</b>
      </a>
    </div>
    
    <div class="form-row ip-input-row">
      <div id="trusted-ip"></div>
    </div>
    <input type="hidden" name="trustIpAddr" value="" />
    <input type="hidden" name="keywords" value="" />
    <input type="hidden" name="lanIpAddr" value="" disabled/>
    <input type="hidden" name="lanIpMask" value="" disabled/>
  </div>
  <? commonCfg.bodyEnd(0, 'BKS_keyword.html') ?>    
</html>
