<!DOCTYPE HTML>
<!-- include lua to use webGetFunc functions -->
<% 
      local commonCfg = require "webGetFunc.commonCfg"
%>

<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= commonCfg.getModelNameStr()?></title>

  <link rel="stylesheet" href="css/table_noh.css">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.inputmask.min.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/validations.js"></script>
  <script src="js/portForward.js"></script>

  <script language="javascript" type="text/javascript">
    CSRF_TOKEN = <?= commonCfg.genCsrfTokenFile('tokenNumber')?>;

    /* var for Edit button of port-forward rule */
    var sel_fwd_index = "-1";
    var sel_fwd_serviceName;
    var sel_fwd_serviceType;
    var sel_fwd_externalPort;
    var sel_fwd_internalPort;
    var sel_fwd_serverIp;
    /* var for Edit button of port-trigger rule */
    var sel_tgr_index = "-1";
    var sel_tgr_serviceName;
    var sel_tgr_triggerProtocol;
    var sel_tgr_triggerPort;
    var sel_tgr_inConntype;
    var sel_tgr_inStartPort;
    var sel_tgr_inEndPort;
    var sel_tgr_userIp;
    /* global var for getting db values not from fillouted input elements */
    var g_lanIp;
    
    $(document).ready(function()
    {
        fetchData('target_PortTrigger', 'portForward', 'pre_fillout_init', 'post_fillout_init');
    });
    
    function pre_fillout_init(json) 
    {
        var new_tr_fwd = '<tr name="forward_row">\r\n\
        <td nowrap align=center>&nbsp;\r\n\
          <input type=RADIO name=RouteSelect id=\"inbound_select__index\" value=__index onClick="onClick_SelFwdRule(\'__index\',\'__serviceName\',\'__serviceType\',\'__externalPort\',\'__internalPort\',\'__serverIp\');">&nbsp;\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=thead>__count</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=ttext>__serviceName</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=ttext>__externalPort</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=ttext>__internalPort</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>__serverIp</td>\r\n\
        <td nowrap align=center style = "display: none;" >__index</td>\r\n\
        <td nowrap align=center style = "display: none;">__serviceType</td>\r\n\
        </tr>';
        
        fetchTableData('pf_record', 'portForwardTable', new_tr_fwd);
        
        var new_tr_tgr = '<tr>\r\n\
        <td nowrap align=center> &nbsp;\r\n\
          <input type=RADIO name=serviceSelect id=\"service_select__index\" value=__index onClick=\"onClick_SelTgrRule(\'__index\', \'__serviceName\', \'__triggerProtocol\', \'__triggerPort\', \'__inConnType\', \'__inStartPort\', \'__inEndPort\', \'__userIp\');\"> &nbsp;\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=thead>__count</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=\"ttext\"> &nbsp;\r\n\
            <input type=\"checkbox\" id=\"srv__index\" __enableRule>\r\n\
          </span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=ttext>__serviceName</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=ttext>__upper_triggerProtocol:__triggerPort</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=ttext>__displayInConnType:__inStartPort..__inEndPort</span>\r\n\
        </td>\r\n\
        <td nowrap align=center>\r\n\
          <span class=ttext>__userIp</span>\r\n\
        </td>\r\n\
        <td nowrap align=center style = "display: none;" >__index</td>\r\n\
        <td nowrap align=center style = "display: none;" >__triggerProtocol</td>\r\n\
        <td nowrap align=center style = "display: none;" >__triggerPort</td>\r\n\
        <td nowrap align=center style = "display: none;" >__inConnType</td>\r\n\
        <td nowrap align=center style = "display: none;" >__inStartPort</td>\r\n\
        <td nowrap align=center style = "display: none;" >__inEndPort</td>\r\n\
        </tr>';
        
        fetchTableData('pt_record', 'portTriggerTable', new_tr_tgr);
        
        var new_tr_attach = '<tr>\r\n\
        <td nowrap align=\"center\">\r\n\
          <input type=\"radio\" name=\"MacSelect\" id=\"mac_select__index\" onclick=\"onClick_SelAttachedDev(\'__ip\')\">\r\n\
        </td>\r\n\
        <td nowrap align=\"center\">\r\n\
          <span class=\"ttext\">__ip</span>\r\n\
        </td>\r\n\
        <td nowrap align=\"center\">\r\n\
          <span class=\"ttext\">__name</span>\r\n\
        </td></tr>';
        
        fetchTableData('attach_device', 'attachedDevTable', new_tr_attach);
        
        /* get db values which would not be post */
        //var data = JSON.parse(json);
        var data;
        console.log("typeof(json)="+ (typeof json));
        if( json )
        {
            try
            {
                if( typeof json == "string" )
                {
                    data = JSON.parse(json);
                }
                else if( typeof json == "object" )
                {
                    data = json;
                }
            }
            catch( e )
            {
                console.log( e );
                return;
            }
        }
        g_lanIp = data['lanIp']['value'];
    }

    function formSubmit() {
        var select_page = $("input[name='switch_page']:checked").val();
        
        if (select_page == "trigger-page") {
            formSubmit_trigger();
        }
        else {
            /* forward page has no apply button */
        }
    }

    function formSubmit_trigger() {
        /* sync value of enableTriggerRule and disablePortTrigger */
        var iids_enabledTgrRules = get_iids_enabledTgrRules();
        var iids_disabledTgrRules = get_iids_disabledTgrRules(); 
        $('#target_PortTrigger [name=enableTriggerRule]').val(iids_enabledTgrRules); 
        $('#target_PortTrigger [name=disableTriggerRule]').val(iids_disabledTgrRules); 

        if (validation_trigger()) {
            $.postForm('portTriggering', $('#target_PortTrigger'), 'cgi-bin/netgear.plua');
            window.top.g_portFwdTgr_goToPage = "trigger-page";
        }
    }

    function formSubmit_forwardRule() {
        //sync the ip data to hidden input
        if ($('#serverIpAddr-ip').getIp() == false) {
            alert(window.top.mlang["SWPE05"]);
            return false;
        }
        $('#serverIpAddr').val($('#serverIpAddr-ip').getIp());
        
        //remove white-space in externalPort and internalPort
        var externalPort = $("#target_PortForwardRule input[name='externalPort']").val();
        var internalPort = $("#target_PortForwardRule input[name='internalPort']").val();
        $("#target_PortForwardRule input[name='externalPort']").val(externalPort.replace(/\s/g, ''));
        $("#target_PortForwardRule input[name='internalPort']").val(internalPort.replace(/\s/g, ''));
        
        if (validation_forwardRule()) {
            $.postForm('portForwarding', $('#target_PortForwardRule'), 'cgi-bin/netgear.plua', 'postForm_callback_portForward');
        }
    }
    
    function formSubmit_triggerRule() {
        var serviceUser_Select = $("#target_PortTriggerRule #src_ip_type").val();
        
        //sync the ip data to hidden input
        if (serviceUser_Select == "Any") {
            $('#serviceUser').val("0.0.0.0");
        }
        else if (serviceUser_Select == "Single address") {
            if ($('#serviceUser-ip').getIp() == false) {
                alert(window.top.mlang["SWPE05"]);
                return false;
            }
            $('#serviceUser').val($('#serviceUser-ip').getIp());
        }
        
        if (validation_triggerRule()) {
            $.postForm('portTriggerServ', $('#target_PortTriggerRule'), 'cgi-bin/netgear.plua', 'postForm_callback_portTrigger');
            window.top.g_portFwdTgr_goToPage = "trigger-page";
        }
    }
    
    function validation_forwardRule()
    {
        var serviceName = $("#target_PortForwardRule input[name='serviceName']").val();
        var externalPortRanges = $("#target_PortForwardRule input[name='externalPort']").val();
        var internalPortRanges = $("#target_PortForwardRule input[name='internalPort']").val();
        var serverIpAddr = $("#target_PortForwardRule input[name='serverIpAddr']").val();
        var action = $("#target_PortForwardRule input[name='action']").val();
        var protocol = $("#target_PortForwardRule select[name='serviceType']").val();
        var error;
        
        /* check service name */
        if (serviceName == "" || serviceName.match( /[^\x20-\x7E]/ )) {
            //"Invalid service name."
            alert(window.top.mlang["APPE05"]);
            return false;
        }
        
        /* check if service name is duplicate */
        if (is_duplicateFwdRuleName(sel_fwd_index, action, serviceName) == true) {
            //"Duplicate service name."
            alert(window.top.mlang["APPE33"]);
            return false;
        }
        
        /* check port */
        error = check_forwardRule_Ports(externalPortRanges, internalPortRanges);
        if ( error == 1) {
            // "Invalid external port range"
            alert(window.top.mlang["APP040"] + "\n" + window.top.mlang["APP042"] + "\n" + window.top.mlang["APP038"]);
            return false;
        }
        else if (error == 2) {
            // "Invalid internal port range"
            alert(window.top.mlang["APP041"] + "\n" + window.top.mlang["APP042"] + "\n" + window.top.mlang["APP038"]);
            return false;
        }
        else if (error == 3) {
            //"Internal and external ports mismatch"
            alert(window.top.mlang["APP045"] + "\n" + window.top.mlang["APP046"]);
            return false;
        }
        
        /* check if port range is conflict */
        if (is_conflictFwdPort(sel_fwd_index, action, externalPortRanges, internalPortRanges, protocol, serverIpAddr) == true) {
            //"Port conflicts with another rule."
            alert(window.top.mlang["APPE16"]);
            return false;
        }
        
        /* check IP */
        if(isValidIpStr(serverIpAddr) == false)
        {
            alert(window.top.mlang["SWPE05"]);
            return false;
        }

        return true;
    }
    
    function validation_trigger()
    {
        var timeout = $("#target_PortTrigger input[name='timeout']").val();
        
        if (timeout.length == 0 || isNumStr(timeout) == false) {
            alert(window.top.mlang["APPE35"]);
            return false;
        }
        
        return true;
    }    
    
    function validation_triggerRule() {
        var serviceName = $("#target_PortTriggerRule input[name='serviceName']").val();
        var serviceUser = $("#target_PortTriggerRule input[name='serviceUser']").val();
        var triggeringPort = $("#target_PortTriggerRule input[name='triggeringPort']").val();
        var inStartPort = $("#target_PortTriggerRule input[name='inStartPort']").val();
        var inEndPort = $("#target_PortTriggerRule input[name='inEndPort']").val();
        var action = $("#target_PortTriggerRule input[name='action']").val();
        var serviceType = $("#target_PortTriggerRule select[name='serviceType']").val();
        var inConnType = $("#target_PortTriggerRule select[name='inConnType']").val();
        
        
        /* check service name */
        if (serviceName == "" || serviceName.match( /[^\x20-\x7E]/ )) {
            //Invalid service name.
            alert(window.top.mlang["APPE05"]);
            return false;
        }
        
        /* check if service name is duplicate */
        if (is_duplicateTgrRuleName(sel_tgr_index, action, serviceName) == true) {
            //"Duplicate service name."
            alert(window.top.mlang["APPE33"]);
            return false;
        }
        
        /* check user IP */
        if(serviceUser != "0.0.0.0" && isValidIpStr(serviceUser) == false)
        {
            alert(window.top.mlang["SWPE05"]);
            return false;
        }
        
        /* check port */
        if (isNumStr(triggeringPort) == false || 
            parseInt(triggeringPort) < 1 || parseInt(triggeringPort) > 65534) {
            alert(window.top.mlang["APPE11"] + " " + window.top.mlang["APPE14"] + ", " + window.top.mlang["APP042"]);
            return false;
        }
        if (isNumStr(inStartPort) == false || 
            parseInt(inStartPort) < 1 || parseInt(inStartPort) > 65534) {
            alert(window.top.mlang["APPE11"] + " " + window.top.mlang["APPE09"] + ", " + window.top.mlang["APP042"]);
            return false;
        }
        if (isNumStr(inEndPort) == false || 
            parseInt(inEndPort) < 1 || parseInt(inEndPort) > 65534) {
            alert(window.top.mlang["APPE11"] + " " + window.top.mlang["APPE08"] + ", " + window.top.mlang["APP042"]);
            return false;
        }
        
        /* check if trigger port is conflict */
        if (is_conflictTgrPort(sel_tgr_index, action, triggeringPort, serviceType) == true) {
            //"Triggering port is already used by another service."
            alert(window.top.mlang["APPE29"]);
            return false;
        }
        
        /* check if inbound port is conflict */
        if (is_conflictInboundPort(sel_tgr_index, action, inStartPort, inEndPort, inConnType) == true) {
            //"Inbound connection port range overlap with other services."
            alert(window.top.mlang["APPE32"]);
            return false;
        }
        
        if (parseInt(inEndPort,10) < parseInt(inStartPort,10))
        {
            alert(window.top.mlang["APPE12"]);
            return false;
        }

        return true;
    }
    
    function post_fillout_init()
    {   
        /* init the forms to hide/show */
        init_switch_page();
        
        /* init IP element in PortForward page */
        $('#internalIpAddr-ip').ipInput().setIp(g_lanIp);
        $('#internalIpAddr-ip :input:eq(3)').val("");
        // fill auto test IDs
        $('#internalIpAddr-ip :input').each(function(index){
            $(this).attr("id", 'server_ipaddress' + (index+1));  
        });
        
        
        /* register a onClick/onChange funtion */
        $('#target_switch-page [name=switch_page]').on('change', function() {
            onChange_switch_page();
        });
        $('#target_PortForward [name=server_add]').on('click', function() {
            onClick_server_add();
        });
        
        $('#target_PortForward [name=add_fwd_rule]').on('click', function() {
            onClick_add_fwd_rule();
            //PEGA JYang, change the edit id to "main"
            $('div[name=main]').attr("id", "");
            $('div[name=mainEditPf]').attr("id", "main");
        });
        $('#target_PortForward [name=edit_fwd_rule]').on('click', function() {
            onClick_edit_fwd_rule();
            //PEGA JYang, change the edit id to "main"
            $('div[name=main]').attr("id", "");
            $('div[name=mainEditPf]').attr("id", "main");
        });
        $('#target_PortForward [name=del_fwd_rule]').on('click', function() {
            onClick_del_fwd_rule();
        });
        $('#target_PortForward [name=arrange_fwd_rule_by_ip]').on('click', function() {
            onClick_arrange_fwd_rule_by_ip();
        });     
        $('#target_PortTrigger [name=add_tgr_rule]').on('click', function() {
            onClick_add_tgr_rule();
            //PEGA JYang, change the edit id to "main"
            $('div[name=main]').attr("id", "");
            $('div[name=mainEditPt]').attr("id", "main");
        });
        $('#target_PortTrigger [name=edit_tgr_rule]').on('click', function() {
            onClick_edit_tgr_rule();
            //PEGA JYang, change the edit id to "main"
            $('div[name=main]').attr("id", "");
            $('div[name=mainEditPt]').attr("id", "main");
        });
        $('#target_PortTrigger [name=del_tgr_rule]').on('click', function() {
            onClick_del_tgr_rule();
        });
        /* sync checkbox value */
        $('#target_PortTrigger [name=disablePortTrigger]').on('change', function() {
            $('#target_PortTrigger [name=disablePortTrigger]').val($('#target_PortTrigger [name=disablePortTrigger]').prop("checked"));
            $('#target_PortTrigger [name=enable]').val(!$('#target_PortTrigger [name=disablePortTrigger]').prop("checked"));
        });
  
        post_fillout_init_forwardRule();
        post_fillout_init_triggerRule();
    }
    
    function post_fillout_init_forwardRule()
    {
        /* register a onClick/onChange funtion */
        $('#target_PortForwardRule [name=externalPort]').on('blur', function() {
            onBlur_externalPort();
        });
        $('#target_PortForwardRule #same_range').on('change', function() {
            $('#same_range').val($('#same_range').prop("checked"));
            onChange_same_range();
        });

        //PEGA JYang, sync two select list for Netgear GUI automation id (dirty solution)
        $('#srvtype')[0].selectedIndex = $('#serviceType').prop('selectedIndex');
        $('#srvtype').on('click', function() {
            $('#serviceType')[0].selectedIndex = $('#srvtype').prop('selectedIndex');
        });
    }
    
    function post_fillout_init_triggerRule()
    {
        /* register a onClick/onChange funtion */
        $('#target_PortTriggerRule #src_ip_type').on('change', function() {
            onChange_serviceUserSelect();
        });

        //PEGA KKHuang, sync two select list for Netgear GUI automation id (dirty solution)
        $('#in_port_type')[0].selectedIndex = $('#inConnType').prop('selectedIndex');
        $('#in_port_type').on('click', function() {
            $('#inConnType')[0].selectedIndex = $('#in_port_type').prop('selectedIndex');
        });
    }

    function postForm_callback_portForward(json)
    {
        /* Show port conflict error popup message while port conflict check fail */
        if (json.message == "Port Forwarding Port Conflict!!!") {
            //"The specified port(s) are being used by other configurations. ..."
            alert(window.top.mlang["APPE39"]);
        }
        else {
            location.href='FW_port_forward.html';
        }
    }
    
    function postForm_callback_portTrigger(json)
    {
        /* Show port conflict error popup message while port conflict check fail */
        if (json.message == "Port Triggering Port Conflict!!!") {
            //"The specified port(s) are being used by other configurations. ..."
            alert(window.top.mlang["APPE39"]);
        }
        else {
            window.top.g_portFwdTgr_goToPage = "trigger-page";
            location.href='FW_port_forward.html';
        }
    }
    /* init function Section --------> Begin */
    function init_switch_page()
    {
        if (window.top.g_portFwdTgr_goToPage == "trigger-page") {
            /* after sending post in PortTrigger form, the refreshed page must stay at PortTrigger form, not at default PortFoward form */
            $("#target_PortForward").hide();
            $("#target_PortTrigger").show();
            $("#cancel").css("visibility","visible");
            $("#apply").css("visibility","visible");
            loadhelp('FW_port_trigger','');
            
            $("input[name='switch_page']")[1].checked = true;
            
            /* back to default form at next time refreshing the page*/
            window.top.g_portFwdTgr_goToPage = "forward-page";
        }
        else {
            /* default show PortFoward form, hide PortTrigger form. */
            $("#target_PortForward").show();
            $("#target_PortTrigger").hide();
            $("#cancel").css("visibility","hidden");
            $("#apply").css("visibility","hidden");
            loadhelp('FW_port_forward','');
        }
    }
    
    function init_same_range()
    {
        /*sync externalPort value to internalPort if same_range enabled*/
        onChange_same_range();
    }
    /* init function Section --------> End */

    /* Onclick Callback Section --------> Begin */
    function onClick_SelFwdRule(index, serviceName, serviceType, externalPort, internalPort, serverIp)
    {
        sel_fwd_index = index;
        sel_fwd_serviceName = serviceName;
        sel_fwd_serviceType = serviceType;
        sel_fwd_externalPort = externalPort;
        sel_fwd_internalPort = internalPort;
        sel_fwd_serverIp = serverIp;
    }
    
    function onClick_SelTgrRule(index, serviceName, triggerProtocol, triggerPort, inConnType, inStartPort, inEndPort, userIp)
    {
        sel_tgr_index = index;
        sel_tgr_serviceName = serviceName;
        sel_tgr_triggerProtocol = triggerProtocol;
        sel_tgr_triggerPort = triggerPort;
        sel_tgr_inConntype = inConnType;
        sel_tgr_inStartPort = inStartPort;
        sel_tgr_inEndPort = inEndPort;
        sel_tgr_userIp = userIp;
    }
    
    function onClick_SelAttachedDev(ip)
    {
        /* sync the IP of selected attached dev into serverIpAddr-ip field */
        $('#target_PortForwardRule #serverIpAddr-ip').ipInput().setIp(ip);
        // fill auto test IDs
        $('#serverIpAddr-ip :input').each(function(index){
            $(this).attr("id", 'lan_ip' + (index+1));  
        });
    }
    
    function onChange_switch_page()
    {
        var switch_page = $("input[name='switch_page']:checked").val();
        
        if (switch_page == "forward-page")
        {
            $("#target_PortForward").show();
            $("#target_PortTrigger").hide();
            $("#cancel").css("visibility","hidden");
            $("#apply").css("visibility","hidden");
            loadhelp('FW_port_forward','');
        }
        else if (switch_page == "trigger-page")
        {
            $("#target_PortForward").hide();
            $("#target_PortTrigger").show();
            $("#cancel").css("visibility","visible");
            $("#apply").css("visibility","visible");
            loadhelp('FW_port_trigger','');            
        }
    }
    
    function onClick_server_add()
    {
        var add_serviceName = $("select[name='selectService']").val();
        var serviceType_map = {"FTP" : "tcp", 
                               "HTTP" : "tcp",
                               "ICUII" : "tcp", 
                               "IP Phone" : "tcp",
                               "NetMeeting/H.323" : "tcp", 
                               "News" : "tcp",
                               "Quake II & III" : "tcp udp",
                               "Real Audio" : "tcp udp",
                               "Telnet" : "tcp",
                               "VPN-PPTP" : "tcp"
                               };
        var add_serviceType = serviceType_map[add_serviceName];
        var add_serverIpAddr = $('#internalIpAddr-ip').getIp();
        var port_map = {"FTP" : "20-21",
                        "HTTP" : "80-80",
                        "ICUII" : "23566-23566",
                        "IP Phone" : "6670-6670",
                        "NetMeeting/H.323" : "1720-1720",
                        "News": "119-119",
                        "Quake II & III" : "27960-27960",
                        "Real Audio" : "6970-7170",
                        "Telnet" : "23-23",
                        "VPN-PPTP": "1723-1723"};
        var add_externalPort = port_map[add_serviceName];
        var add_internalPort = port_map[add_serviceName];
        
        /* validate IP */
        if(!$("#target_PortForward #internalIpAddr-ip").validateIp())
        {
            alert(window.top.mlang["SWPE05"]);
            return;
        }
        
        var last_word_ip = $('#target_PortForward #internalIpAddr-ip :input:eq(3)').val();
        if (last_word_ip == "0" || last_word_ip == "255")
        {
            alert(window.top.mlang["SWPE05"]);
            return;
        }
        
        $("#target_PortForwardRule input[name='action']").val("add");
	$("#target_PortForwardRule input[name='iid']").val(""); 
        $("#target_PortForwardRule input[name='serviceName']").val(add_serviceName); 
        $("#target_PortForwardRule select[name='serviceType']").val(add_serviceType);
        $("#target_PortForwardRule input[name='serverIpAddr']").val(add_serverIpAddr);
        $("#target_PortForwardRule input[name='externalPort']").val(add_externalPort);
        $("#target_PortForwardRule input[name='internalPort']").val(add_internalPort);

	//console.log("adding forward rule");
        /* Send post for adding forward rule */
        if (validation_forwardRule()) 
        {
            $.postForm('portForwarding', $('#target_PortForwardRule'), 'cgi-bin/netgear.plua', 'postForm_callback_portForward');
        }
    }
    
    function onClick_add_fwd_rule()
    {
        $("#target_PortForwardRule input[name='action']").val("add");
    
        /* init IP element in PortForwardRule page */
        $('#serverIpAddr-ip').ipInput().setIp(g_lanIp);
        // fill auto test IDs
        $('#serverIpAddr-ip :input').each(function(index){
            $(this).attr("id", 'lan_ip' + (index+1));  
        });
        $('#serverIpAddr-ip :input:eq(3)').val("");

        
        /* default greyout internalPort field */
        init_same_range();
        
        /* show form "target_PortForwardRule"*/
        show_PortForwardRule_form();
    }
    
    function onClick_edit_fwd_rule()
    {
        /* no rule is selected */
        if (sel_fwd_index == "-1")
        {
            //"Please select an item to edit"
            alert(window.top.mlang["AAWE08"]);
            return;
        }
        
        /* Fillout selected rule data into form 'target_PortForwardRule' */
        $("#target_PortForwardRule input[name='action']").val("edit");
        $("#target_PortForwardRule input[name='iid']").val(sel_fwd_index); 
        $("#target_PortForwardRule input[name='serviceName']").val(sel_fwd_serviceName);
        $("#target_PortForwardRule select[name='serviceType']").val(sel_fwd_serviceType).change();
        //PEGA JYang, sync two select list for Netgear GUI automation id (dirty solution)
        $('#srvtype')[0].selectedIndex = $('#serviceType').prop('selectedIndex');
        
        /* init IP element in PortForwardRule page */
        $('#serverIpAddr-ip').ipInput().setIp(sel_fwd_serverIp);
        // fill auto test IDs
        $('#serverIpAddr-ip :input').each(function(index){
            $(this).attr("id", 'lan_ip' + (index+1));  
        });
        $("#target_PortForwardRule input[name='serverIpAddr']").val(sel_fwd_serverIp);
        
        $("#target_PortForwardRule input[name='externalPort']").val(sel_fwd_externalPort);
        $("#target_PortForwardRule input[name='internalPort']").val(sel_fwd_internalPort);

        if (sel_fwd_externalPort == sel_fwd_internalPort) {
            $('#same_range')[0].checked = true;
        }
        else {
            $('#same_range')[0].checked = false;
        }
        $('#same_range').val($('#same_range').prop("checked"));

        init_same_range();
        
        /* show form "target_PortForwardRule"*/
        show_PortForwardRule_form();
    }
    
    function onClick_del_fwd_rule()
    {
        /* no rule is selected */
        if (sel_fwd_index == "-1")
        {
            //"Please select an item to delete"
            alert(window.top.mlang["AAWE07"]);
            return;
        }
        
        $("#target_PortForwardRule input[name='action']").val("delete");
        $("#target_PortForwardRule input[name='iid']").val(sel_fwd_index); 
        $("#target_PortForwardRule input[name='serviceName']").val(sel_fwd_serviceName);
        $("#target_PortForwardRule select[name='serviceType']").val(sel_fwd_serviceType);
        $("#target_PortForwardRule input[name='serverIpAddr']").val(sel_fwd_serverIp);
        $("#target_PortForwardRule input[name='externalPort']").val(sel_fwd_externalPort);
        $("#target_PortForwardRule input[name='internalPort']").val(sel_fwd_internalPort);
        
        /* Send post for deleting forward rule */
        $.postForm('portForwarding', $('#target_PortForwardRule'), 'cgi-bin/netgear.plua');
    }
    
    function onClick_arrange_fwd_rule_by_ip()
    {
        var table = document.getElementById("pf_record");
        var rows = table.getElementsByTagName("tr");
        var i;
        var ip1, ip2;
        var need_reorder_again = true;
        
        /* sort rules by IP */
        while(need_reorder_again)
        {
            need_reorder_again = false;
            
            for (i = 1; i < rows.length - 1; i++)
            {
                ip1 = rows[i].getElementsByTagName("td")[5].innerHTML.split('.')[3];
                ip2 = rows[i+1].getElementsByTagName("td")[5].innerHTML.split('.')[3];
            
                if (parseInt(ip1) > parseInt(ip2)) {
                    rows[i].parentNode.insertBefore(rows[i+1], rows[i]);
                    need_reorder_again = true;
                }
            }
        }
        
        /* re-fill the number of each rule */
        for (i = 1; i < rows.length; i++)
        {
            rows[i].getElementsByTagName("td")[1].innerHTML = i;
        }
    }
    
    function onClick_add_tgr_rule()
    {
        $("#target_PortTriggerRule input[name='action']").val("add");
        
        /* init IP element */
        $('#serviceUser-ip').ipInput();
        // fill auto test IDs
        $('#serviceUser-ip :input').each(function(index){
            $(this).attr("id", 'src_ip' + (index+1));  
        });
        // serviceUser-ip must be readonly
        $("#serviceUser-ip :input").css("pointer-events","none");
        
        /* show form "target_PortTriggerRule"*/
        show_PortTriggerRule_form();
    }
    
    function onClick_edit_tgr_rule()
    {
        /* no rule is selected */
        if (sel_tgr_index == "-1")
        {
            //"Please select an item to edit"
            alert(window.top.mlang["AAWE08"]);
            return;
        }
           
        /* Fillout selected rule data into the form elements */
        $("#target_PortTriggerRule input[name='action']").val("edit");
        $("#target_PortTriggerRule input[name='iid']").val(sel_tgr_index);
        $("#target_PortTriggerRule input[name='serviceName']").val(sel_tgr_serviceName);
    
        /* init IP element in PortForwardRule page */
        $('#serviceUser-ip').ipInput().setIp(sel_tgr_userIp);
        // fill auto test IDs
        $('#serviceUser-ip :input').each(function(index){
            $(this).attr("id", 'src_ip' + (index+1));  
        });
        if (sel_tgr_userIp == "any" || sel_tgr_userIp == "") {
            $("#target_PortTriggerRule #src_ip_type").val("Any").change();
            $("#serviceUser-ip :input").css("pointer-events","none");
            $("#serviceUser-ip :input").css("opacity", "0.5");
        }
        else {
            $("#target_PortTriggerRule #src_ip_type").val("Single address").change();
            $("#serviceUser-ip :input").css("pointer-events","");
            $("#serviceUser-ip :input").css("opacity", "");
        }
        
        $("#target_PortTriggerRule select[name=serviceType]").val(sel_tgr_triggerProtocol).change();
        $("#target_PortTriggerRule select[name='serviceType']").val(sel_tgr_triggerProtocol).change();
        $("#target_PortTriggerRule input[name='triggeringPort']").val(sel_tgr_triggerPort);
        $("#target_PortTriggerRule select[name='inConnType']").val(sel_tgr_inConntype).change();
        $("#target_PortTriggerRule input[name='inStartPort']").val(sel_tgr_inStartPort);
        $("#target_PortTriggerRule input[name='inEndPort']").val(sel_tgr_inEndPort);
        //PEGA KKHuang, sync two select list for Netgear GUI automation id (dirty solution)
        $('#in_port_type')[0].selectedIndex = $('#inConnType').prop('selectedIndex');
        
        /* show form "target_PortTriggerRule"*/
        show_PortTriggerRule_form();
    }
    
    function onClick_del_tgr_rule()
    {
        /* no rule is selected */
        if (sel_tgr_index == "-1")
        {
            //"Please select an item to delete"
            alert(window.top.mlang["AAWE07"]);
            return;
        }
        
        $("#target_PortTriggerRule input[name='action']").val("delete");
        $("#target_PortTriggerRule input[name='iid']").val(sel_tgr_index);
        $("#target_PortTriggerRule input[name='serviceName']").val(sel_tgr_serviceName);
        if (sel_tgr_userIp == "any")
        {
            $("#target_PortTriggerRule input[name='serviceUser']").val("0.0.0.0");
        }
        else
        {
            $("#target_PortTriggerRule input[name='serviceUser']").val(sel_tgr_userIp);
        }
        $("#target_PortTriggerRule select[name=serviceType]").val(sel_tgr_triggerProtocol);
        $("#target_PortTriggerRule input[name='triggeringPort']").val(sel_tgr_triggerPort);
        $("#target_PortTriggerRule select[name='inConnType']").val(sel_tgr_inConntype);
        $("#target_PortTriggerRule input[name='inStartPort']").val(sel_tgr_inStartPort);
        $("#target_PortTriggerRule input[name='inEndPort']").val(sel_tgr_inEndPort);
        
        /* Send post for deleting trigger rule */
        $.postForm('portTriggerServ', $('#target_PortTriggerRule'), 'cgi-bin/netgear.plua');
        window.top.g_portFwdTgr_goToPage = "trigger-page";
    }
    
    function onBlur_externalPort()
    {
        /*sync value to internalPort if same_range enabled*/
        if ($('#same_range').val() == "true") {
            $('[name=internalPort]').val($('[name=externalPort]').val());
        }
    }
    
    function onChange_same_range()
    {
        /*sync externalPort value to internalPort if same_range enabled*/
        if ($('#same_range').val() == "true") {
            $(".internal_port_rage").css("pointer-events", "none");
            $(".internal_port_rage").css("opacity", "0.5");
            $('[name=internalPort]').val($('[name=externalPort]').val());
        }
        else {
            $(".internal_port_rage").css("pointer-events", "");
            $(".internal_port_rage").css("opacity", "");
        }
    }

    function onChange_serviceUserSelect()
    {
        var serviceUserSelect = $("#target_PortTriggerRule #src_ip_type").val();
        
        if (serviceUserSelect == "Any") {
            $("#serviceUser-ip :input").css("pointer-events","none");
            $("#serviceUser-ip :input").css("opacity", "0.5");
        }
        else if (serviceUserSelect == "Single address") {
            $("#serviceUser-ip :input").css("pointer-events","");
            $("#serviceUser-ip :input").css("opacity", "");
        }
    }
    /* Onclick Callback Section --------> End */
  </script>

  <link href="css/custom.css" rel="stylesheet" type="text/css">
</head>

<body onload="window.top.change_size($(this));loadhelp('FW_port_forward','');" class="page-body" onResize="window.top.change_size($(this));">
    <div id="main_page"> <!-- main_page div end -->
    <div class="page-header" style="position: relative;" mlang="LUP030">Port Forwarding / Port Triggering</div>
    <div id="main" name="main" class="form-group" style=height:365px;overflow:auto;scrolling:auto">
    <!-- switch-page form -->
    <form id="target_switch-page"  name="formname_switch-page" > 
    
        <div class="form-row">
            <a href="javascript:loadhelp('FW_port_forward','select')" tabindex="-1"><b mlang="APP012" >Please select the service type.</b></a>
        </div>
        
        <div class="form-row">
            <label class="checkbox-container" ><div mlang="APP010">Port Forwarding</div>
            <input type="radio" name="switch_page" id="serv_pf" value="forward-page" checked>
            <span class="radio-checkmark"></span>
            </label>
        </div>
        
        <div class="form-row">
            <label class="checkbox-container" ><div mlang="APP011">Port Triggering</div>
            <input type="radio" name="switch_page" id="serv_pt" value="trigger-page">
            <span class="radio-checkmark"></span>
            </label>
        </div>
        
        <div class="divider">&nbsp;</div>
    </form>
    <!-- switch-page form end-->
    
    <!-- port forward form -->
    <form id="target_PortForward"  name="formname_PortForward" method="POST" >
    
        <div class="form-row">
            <a href="javascript:loadhelp('FW_port_forward','setup')" tabindex="-1"><b mlang="APP008" >Service Name</b></a>
        </div>
        
        <div class="form-row">
            <select name="selectService" id="svs_gm" size=1>
                <option value="FTP" selected >FTP</option>
                <option value="HTTP" >HTTP</option>
                <option value="ICUII" >ICUII</option>
                <option value="IP Phone" >IP Phone</option>
                <option value="NetMeeting/H.323" >NetMeeting/H.323</option>
                <option value="News" >News</option>
                <option value="Quake II & III" >Quake II & III</option>
                <option value="Real Audio" >Real Audio</option>
                <option value="Telnet" >Telnet</option>
                <option value="VPN-PPTP" >VPN-PPTP</option>
            </select>
        </div>
    
        <div class="form-row">
            <a href="javascript:loadhelp('FW_port_forward','setup')" tabindex="-1"><b mlang="APP007" >Server IP Address</b></a>
        </div>

        <div class="form-row" style="display:inline-block;">
            <div id="internalIpAddr-ip" style="display:inline-block;"></div>
            
            &nbsp;&nbsp;&nbsp;
		
            <button type="button" value="add" name="server_add" id="server_add" class="button-sty1" mlang="OTH012">Add</button>
        </div>
        
        <div class="form-row">
            <table class="sortable tbWhite" name="portForward_table" id="pf_record" border="1" cellpadding="2" cellspacing="0" width="90%">
                <tr class="table_header">
                    <td nowrap width="3%" align="center"><span class="thead">&nbsp;</span></td>
                    <td nowrap width="3%" align="center"><span class="thead">#</span></td>
                    <td width="26%" align="center"><span class="thead" mlang="APP008">Service Name</span></td>
                    <td width="12%" align="center"><span class="thead" mlang="APP036">External port range</span></td>
                    <td width="12%" align="center"><span class="thead" mlang="APP037">Internal port range</span></td>
                    <td width="20%" align="center"><span class="thead" mlang="APP024">Internal IP address</span></td>
                    <td align="center" style="display: none;"></td>
                </tr>
            </table>
        </div>
        
        <div class="form-row">
            <td colspan="2" align="center">
                <button type="button" value="edit" id="inbound_edit" name="edit_fwd_rule" class="button-sty1" mlang="APP004">Edit Service</button>
                <button type="button" value="delete" id="inbound_del" name="del_fwd_rule" class="button-sty1" mlang="APP015">Delete Service</button>
                <button type="button" value="add" id="inbound_add" name="add_fwd_rule" class="button-sty1"  mlang="APP003">Add Custom Service</button>
                <button type="button" value="edit" id="arrange_by_ip" name="arrange_fwd_rule_by_ip" class="button-sty1" mlang="APP039">Arrange by internal IP</button>
            </td>
        </div>
    </form>
    <!-- port forward form end -->
    
    <!-- port trigger form -->
    <form id="target_PortTrigger"  name="formname_PortTrigger" method="POST" >
        <div class="form-row">
            <label class="checkbox-container">
                <a href="javascript:loadhelp('FW_port_forward','pt_enable')" tabindex="-1"><span mlang="APP022">Disable Port Triggering</span></a>
                <input type="checkbox" name="disablePortTrigger" id="fwpt_enable" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
            <input type="hidden" name="enable" value="false" checked>
        </div>
        
        <div class="form-row">
            <a href="javascript:loadhelp('FW_port_forward','setup')" tabindex="-1"><b mlang="APP021" >Port Triggering Time-out</b></a>
            <b mlang="APP001">(in minutes)</b>
        </div>
        
        <div class="form-row">
            <input type="text" class="num s_input" name="timeout" id="fwpt_timeout" size="5" maxlength="4" onFocus="this.select();" >
        </div>
        
        <div class="form-row">
            <span mlang="APP018" >Port Triggering Portmap Table</span>
        </div>

        <div class="form-row">
            <table class="sortable tbWhite" name="portTrigger_table" id="pt_record" border="1" cellpadding="2" cellspacing="0" width="90%">
                <tr class="table_header">
                    <td nowrap width="3%" align="center"><span class="thead">&nbsp;</span></td>
                    <td nowrap width="3%" align="center"><span class="thead">#</span></td>
                    <td nowrap align="center"><span class="thead" mlang="SBS026">Enable</span></td>
                    <td nowrap align="center"><span class="thead" mlang="APP008">Service Name</span></td>
                    <td nowrap align="center"><span class="thead" mlang="CBE005">Service Type</span></td>
                    <td nowrap align="center"><span class="thead" mlang="APP017">Inbound Connection</span></td>
                    <td nowrap align="center"><span class="thead" mlang="APP020">Service User</span></td>
                    <td align="center" style="display: none;"></td>
                </tr>
            </table>
        </div>

        <div class="form-row">
            <td colspan="2" align="center">
                <button type="button" value="add" id="service_add" name="add_tgr_rule" class="button-sty1" mlang="APP014">Add Service</button>
                <button type="button" value="edit" id="service_edit" name="edit_tgr_rule" class="button-sty1" mlang="APP004">Edit Service</button>
                <button type="button" value="delete" id="service_delete" name="del_tgr_rule" class="button-sty1"  mlang="APP015">Delete Service</button>
            </td>
        </div>
        
        <input type="hidden" name="enableTriggerRule" value="">
        <input type="hidden" name="disableTriggerRule" value="">
    </form> <!-- port trigger form end -->
    
    </div><!-- form-group end -->
    
    <div class="form-btn-row" id="form_btn_div">
        <button type="button" value="BUTTON"  onClick="location.href='FW_port_forward.html';" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
        <button type="button" value="apply"  onClick="formSubmit($(this))" name="apply" id="apply" class="button-apply apply_bt" mlang="LUP004" >Apply</button>
    </div>
    </div> <!-- main_page div end -->

    <!-- port forward rule form begin -->
    <form id="target_PortForwardRule"  name="formname_PortForwardRule" method="POST" style="display: none;">
        <div class="page-header" style="position: relative;" mlang="APP006">Ports - Custom Services</div>
        <div id="mainEditPf" name="mainEditPf" class="form-group" style=height:365px;overflow:auto;scrolling:auto">
            <div class="form-row">
                <span mlang="APP008" >Service Name</span>
            </div>
            
            <div class="form-row">
                <input class="input1" type="text" name="serviceName" id="port_name" size="30" maxlength="30" value="">
            </div>
            
            <div class="form-row">
                <span mlang="SBS014" >Protocol</span>
            </div>

            <!--PEGA JYang, sync two select list for Netgear GUI automation id (dirty solution)-->
            <div class="form-row" style="display:none">
                <select name="serviceType" id="serviceType" size=1>
                    <option value="tcp udp" selected >TCP/UDP</option>
                    <option value="tcp" selected >TCP</option>
                    <option value="udp" >UDP</option>
                </select>
            </div>
            <div class="form-row">
                <select id="srvtype" size=1>
                    <option value="tcp udp" selected >TCP/UDP</option>
                    <option value="tcp" selected >TCP</option>
                    <option value="udp" >UDP</option>
                </select>
            </div>
            
            <div class="form-row">
                <span mlang="APP036" >External port range</span>
            </div>
            <div class="form-row">
                <input type="text" class="num s_input" name="externalPort" id="exter_port" size="27" maxlength="256" value="" onFocus="this.select();">
                <span>(1~65534)</span>
            </div>
            
            <div class="form-row">
                <span mlang="APP038" >Please specify ports and port ranges split by commas, example: 30, 50 - 60, 65500 - 65510</span>
            </div>
            
            <div class="form-row">
                <label class="checkbox-container">
                    <span mlang="APP033" >Use the same port range for Internal port</span>
                    <input type="checkbox" id="same_range" value="true" checked>
                    <span class="checkbox-checkmark"></span>
                </label>
            </div>
            
            <div class="internal_port_rage">
                <div class="form-row">
                    <b mlang="APP037">Internal port range</b>
                </div>
                <div class="form-row">
                    <input type="text" class="num s_input" name="internalPort" id="internal_port" size="27" maxlength="256" value="" onFocus="this.select();">
                    <span>(1~65534)</span>
                </div>
                
                <div class="form-row">
                    <span mlang="APP038" >Please specify ports and port ranges split by commas, example: 30, 50 - 60, 65500 - 65510</span>
                </div>
            </div>
            
            <div class="form-row">
                <b mlang="APP024">Internal IP address</b>
            </div>
            
            <div id="serverIpAddr-ip"></div>
            <input type="hidden" id="serverIpAddr" name="serverIpAddr">

            <div class="form-row">
                <b mlang="APP034">Or select from currently attached devices</b>
            </div>

            <div class="form-row">
                <table class="sortable tbWhite" name="attachedDev_table" id="attach_device" border="1" cellpadding="2" cellspacing="0" width"63%">
                    <tr class="table_header">
                        <td nowrap align="center" width="20%"><span class="thead"> &nbsp;</span></td>
                        <td nowrap align="center" width="30%"><span class="thead" mlang="SWP030">IP Address</span></td>
                        <td nowrap align="center" width="50%"><span class="thead" mlang="MAD001">Device Name</span></td>
                    </tr>
                </table>
            </div>            
        </div> <!-- form-group end -->
    
        <div class="form-btn-row" id="form_btn_fwdrule">
            <button type="button" value="BUTTON"  onClick="location.href='FW_port_forward.html';" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
            <button type="button" value="apply"  onClick="formSubmit_forwardRule($(this))" name="apply" id="apply" class="button-apply apply_bt" mlang="LUP004" >Apply</button>
        </div>
        
        <input type="hidden" name="action" value="">
        <input type="hidden" name="iid" value=""> 
    </form>
    <!-- port forward rule form end -->

    <!-- port trigger rule form begin -->
    <form id="target_PortTriggerRule"  name="formname_PortTriggerRule" method="POST" style="display: none;">
        <div class="page-header" style="position: relative;" mlang="APP016">Port Triggering - Services</div>
        <div id="mainEditPt" name="mainEditPt" class="form-group" style=height:365px;overflow:auto;scrolling:auto">
            <div class="form-row">
                <b mlang="APP019">Service</b>
            </div>
            
            <div class="form-row">
                <span mlang="APP008">Service Name</span>
            </div>
            
            <div class="form-row">
                <input class="input1" type="text" name="serviceName" id="pt_name" size="15" maxlength="30" value="">
            </div>
            
            <div class="form-row">
                <span mlang="APP020">Service User</span>
            </div>

            <div class="form-row">
                <select id="src_ip_type" size=1>
                    <option value="Any" mlang="APP002" selected >Any</option>
                    <option value="Single address" mlang="APP013">Single address</option>
                </select>
            </div>

            <div id="serviceUser-ip"></div>
            <input type="hidden" id="serviceUser" name="serviceUser">
            
            <div class="form-row">
                <span mlang="CBE005">Service Type</span>
            </div>
            
            <div class="form-row">
                <select name="serviceType" id="pt_type" size=1>
                    <option value="tcp" selected >TCP</option>
                    <option value="udp" >UDP</option>
                </select>
            </div>
            
            <div class="form-row">
                <span mlang="APPE14">Triggering Port</span>
            </div>
            
            <div class="form-row">
                <input type="text" class="num s_input" name="triggeringPort" id="pt_port" size="6" maxlength="5" >
                <span>(1~65534)</span>
            </div>
            
            <div class="space-divider" >&nbsp;</div>
            
            <div class="form-row">
                <b mlang="APP017">Inbound Connection</b>
            </div>
            
            <div class="form-row">
                <span mlang="MRS076">Connection Type</span>
            </div>
            
            <!--PEGA KKHuang, sync two select list for Netgear GUI automation id (dirty solution)-->
            <div class="form-row" style="display:none">
                <select name="inConnType" id="inConnType" size=1>
                    <option value="tcp udp" selected >TCP/UDP</option>
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>
            <div class="form-row">
                <select id="in_port_type" size=1>
                    <option value="tcp udp" selected >TCP/UDP</option>
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>
            
            <div class="form-row">
                <span mlang="CBE012">Starting Port</span>
            </div>
            
            <div class="form-row">
                <input type="text" class="num s_input" name="inStartPort" id="in_port_start" size="6" maxlength="5">
                <span>(1~65534)</span>
            </div>
            
            <div class="form-row">
                <span mlang="CBE001">Ending Port</span>
            </div>
            
            <div class="form-row">
                <input type="text" class="num s_input" name="inEndPort" id="in_port_end" size="6" maxlength="5">
                <span>(1~65534)</span>
            </div>
            
        </div> <!-- form-group end -->
        
        <div class="form-btn-row" id="form_btn_tgrrule">
            <button type="button" value="BUTTON"  onClick="location.href='FW_port_forward.html';" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
            <button type="button" value="apply"  onClick="formSubmit_triggerRule($(this))" name="apply" id="apply" class="button-apply apply_bt" mlang="LUP004" >Apply</button>
        </div>
        
        <input type="hidden" name="action" value="">
        <input type="hidden" name="iid" value="">
    </form>
    <!-- port trigger rule form end -->

    
    
  <? commonCfg.genHelpSection()?>
</html>
