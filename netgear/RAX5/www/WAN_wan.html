<!DOCTYPE HTML>
<% 
      local commonCfg = require "webGetFunc.commonCfg"
%>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <? commonCfg.getModelNameStr()?></title>

  <link rel="stylesheet" href="css/table_noh.css">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css<? commonCfg.getVer(); ?>">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.inputmask.min.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/validations.js<? commonCfg.getVer(); ?>"></script>

<!--
  <link rel="stylesheet" href="css/form.css">
  <style TYPE="text/javascript">
    classes.num.all.fontFamily = "Courier";
    classes.num.all.fontSize = "10pt" ;
  </style>
-->

  <script language="javascript" type="text/javascript">
    CSRF_TOKEN = <?= commonCfg.genCsrfTokenFile('tokenNumber')?>;

    var g_wanInfName;
    function pre_fillout_init(json)
    {
        /* get db values which would not be post */
        var data = JSON.parse(json);
        g_wanInfName = data['wanInfName']['value']; 
    }
    
    function formSubmit(btn) {
        //sync the ip data to hidden input
        if ($('#dmzServer-ip').getIp() == false) {
            alert(window.top.mlang["AWN015"]);
            return false;
        }
        //When DMZ is disabled, keep dmzServer IP unchanged
        if ($('[name=enableDmz]').val() == "true") {
        $('#dmzServer').val($('#dmzServer-ip').getIp());
        }
        
        if (validation(document.forms[0])) {
            $.postForm('wanAdvSetup', $('#target'), 'cgi-bin/netgear.plua');
        }
    }

    function validation(f) {
        var enabledmz = $("#target input[name='enableDmz']").val();
        var dmzServer = $("#target input[name='dmzServer']").val();
        var lanIP = $("#target input[name=lanIP]").val();
        var lanMask = $("#target input[name=lanMask]").val();
        var mtuSize = $("#target input[name='mtuSize']").val();
        var maxMtu;
        
        if(enabledmz == "true")
        {
            if(isValidIpStr(dmzServer) == false) {
                //"DMZ Server is not a valid IP address."
                alert(window.top.mlang["AWN015"]);
                return false;
            }
            
            //check if DMZ server IP and DUT's LAN IP is in same subnet
            if (isSameSubnet_v4(dmzServer, lanIP, lanMask) == false) {
                //"DMZ Server is not on the LAN subnet."
                alert(window.top.mlang["AWN016"]);
                return false;
            }
        }
        
        /* get max Mtu */
        if (g_wanInfName == "eth4.1") {
            //static/dhcp wan
            maxMtu = 1500;
        }
        else if (g_wanInfName == "ppp0.2") {
            //pppoe/l2tp wan
            maxMtu = 1492;
        }
        else {
            maxMtu = 1500;
        }
        
        /* check mutSize string is number or not */
        if (isNumStr(mtuSize) == false) {
            //"Invalid MTU value, valid range is 616 to xxxx"
            alert(window.top.mlang["AWNE01"] + " " + maxMtu);
            return false;
        }
        /* check mutSize is in range */
        if (parseInt(mtuSize) < 616 || parseInt(mtuSize) > maxMtu) {
            alert(window.top.mlang["AWNE01"] + " " + maxMtu);
            return false;
        }
        
        return true;
    }
    
    function isValidIpStr(str)
    {
        var ip = str.split('.');
        var i;
        
        if (ip.length != 4) {
            return false;
        }
        
        for (i = 0; i < ip.length; i++) {
            if (isNumStr(ip[i]) == false) {
                return false;
            }
            
            if (parseInt(ip[i]) < 0 || parseInt(ip[i]) > 255) {
                return false;
            }
        }
        
        if (parseInt(ip[3]) == 0 || parseInt(ip[3]) == 255) {
            return false;
        }
        
        return true;
    }
    
    function isNumStr(str)
    {
        var i;
        if (str.length == 0) {
            return false;
        }
        
        for(i = 0; i < str.length; i++) {
            var c = str.substring(i, i+1);
            if("0" <= c && c <= "9") {
                continue;
            }
            return false;
        }
        
        return true;
    }
    
    function post_fillout_init() 
    {

        $('#test').hide();      // Hide Test button, there is no button on RAX30
        /* init elements */
        init_enableDmz();
        init_dmzServer();

        // Update ID of Help Center
        $("span[mlang='genie_51']").attr("id","help_space");

        /* register onClick/onChange callback function */

        
        /* sync checkbox value to be same with its check status */
        $('#target [name=disableProtection]').on('change', function() {
            $('[name=disableProtection]').val($('[name=disableProtection]').prop("checked"));
            $('[name=enableProtection]').val(!$('[name=disableProtection]').prop("checked"));
        });
        $('#target [name=enableDmz]').on('change', function() {
            $('[name=enableDmz]').val($('[name=enableDmz]').prop("checked"));
            onChange_enableDmz();
        });
        $('#target [name=responsePing]').on('change', function() {
            $('[name=responsePing]').val($('[name=responsePing]').prop("checked"));
        });

        var openvpnEnable = $('[name=hidOpenvpnEnable]').val();
        if ( openvpnEnable == "true" ) // openvpn is enabled
        {
            /* Greyout  “Response to Ping on Internet Port”  */
            $(".grayoutResponsePing").css("pointer-events", "none");
            $(".grayoutResponsePing").css("opacity", "0.5");
        }
        else
        {
            $(".grayoutResponsePing").css("pointer-events", "");
            $(".grayoutResponsePing").css("opacity", "");
        }

        $('#target [name=disableIgmpProxy]').on('change', function() {
            $('[name=disableIgmpProxy]').val($('[name=disableIgmpProxy]').prop("checked"));
            $('[name=enableIgmpProxy]').val(!$('[name=disableIgmpProxy]').prop("checked"));
        });
        $('#target [name=disableSipAlg]').on('change', function() {
            $('[name=disableSipAlg]').val($('[name=disableSipAlg]').prop("checked"));
            $('[name=enableSipAlg]').val(!$('[name=disableSipAlg]').prop("checked"));
        });
    }
    
    function init_enableDmz()
    {
        onChange_enableDmz();
    }
    
    function init_dmzServer()
    {
        //init the value of hidden IP input
        $('#dmzServer').val($('#dmzServer-ip').getIp());
    }

    function onChange_enableDmz()
    {
        var enableDmz = $('[name=enableDmz]').val();
        
        if (enableDmz == "true") {
            $('#dmzServer-ip :input').prop("disabled", false);
    }
        else {
            //greyout dmzServer-ip
            $('#dmzServer-ip :input').prop("disabled", true);
        }
    }
    
  </script>
  <link href="css/custom.css" rel="stylesheet" type="text/css">
</head>

<? commonCfg.bodyBegin('wanSetup', 'WAN_wan', 'LUP031', 'WAN Setup', '', 'post_fillout_init') ?>
    <div id="main" class="form-group" style=height:365px;overflow:auto;scrolling:auto">

        <div class="space-divider">&nbsp;</div>
        
        <div class="form-row">
            <label class="checkbox-container">
                <a href="javascript:loadhelp('WAN_wan','spi')" tabindex="-1">
                    <span mlang="AWN009" >Disable Port Scan and DoS Protection</span>
                </a>
                <input type="checkbox" name="disableProtection" id="disable_dos" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
            <input type="hidden" name="enableProtection" id="enableProtection" value="true">
        </div>

        <div class="divider">&nbsp;</div>

        <div class="form-row">
            <label class="checkbox-container">
                <a href="javascript:loadhelp('WAN_wan','dmz')" tabindex="-1">
                    <span mlang="AWN002" >Default DMZ Server</span>
                </a>
                <input type="checkbox" name="enableDmz" id="dmz_enable" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
        </div>
        
        <div id="dmzServer-ip"></div>
        <input type="hidden" id="dmzServer" name="dmzServer">

        <div class="divider">&nbsp;</div>
        
        <div class="form-row grayoutResponsePing">
            <label class="checkbox-container">
                <a href="javascript:loadhelp('WAN_wan','ping')" tabindex="-1">
                    <span mlang="AWN007" >Respond to Ping on Internet Port</span>
                </a>
                <input type="checkbox" name="responsePing" id="response_ping" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
        </div>
        
        <div class="divider">&nbsp;</div>
        
        <div class="form-row">
            <label class="checkbox-container">
                <a href="javascript:loadhelp('WAN_wan','igmp')" tabindex="-1">
                    <span mlang="AWN017" >Disable IGMP Proxying</span>
                </a>
                <input type="checkbox" name="disableIgmpProxy" id="disable_igmp" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
            <input type="hidden" name="enableIgmpProxy" id="enableIgmpProxy" value="true">
        </div>
        
        <div class="divider">&nbsp;</div>
        
        <div class="form-row">
            <a href="javascript:loadhelp('WAN_wan','mtu')" tabindex="-1"><b mlang="AWN003">MTU Size</b><b mlang="AWN001">(in bytes)</b></a>
        </div>
        <div class="form-row">
            <input type="text" class="input1" name="mtuSize" id="wan_mtu" size="5" maxlength="4">
        </div>

        <div class="divider">&nbsp;</div>
        
        <div class="form-row">
            <a href="javascript:loadhelp('WAN_wan','nat')" tabindex="-1"><b mlang="AWN004">NAT Filtering"</b></a>
        </div>
 
        <div class="form-row">
            <label class="checkbox-container" ><div mlang="AWN006">Secured</div>
                <input type="radio" name="natFilter" id="nat_filtering_secured" value="secured">
                <span class="radio-checkmark"></span>
            </label>
        </div>

        <div class="form-row">
            <label class="checkbox-container"><div mlang="AWN005">Open</div>
                <input type="radio" name="natFilter" id="nat_filtering_open" value="open">
                <span class="radio-checkmark"></span>
            </label>
        </div>
        
        <div class="form-row">
            <label class="checkbox-container">
                <a href="javascript:loadhelp('WAN_wan','sipalg')" tabindex="-1">
                    <span mlang="AWN008" >Disable SIP ALG</span>
                </a>
                <input type="checkbox" name="disableSipAlg" id="disable_sip" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
            <input type="hidden" name="enableSipAlg" id="enableSipAlg" value="true">
        </div>
        
        <div class="space-divider">&nbsp;</div>
  </div> <!-- form-group end -->
    <input type="hidden" name="lanIP" disabled>
    <input type="hidden" name="lanMask" disabled>
    <input type="hidden" name="hidOpenvpnEnable" value="" disabled>
<? commonCfg.bodyEnd(false, 'WLG_wireless_guest.html') ?>
</html>
