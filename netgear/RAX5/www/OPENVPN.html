<!DOCTYPE HTML>
<%
      local commonCfg = require "webGetFunc.commonCfg"
%>

<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <? commonCfg.getModelNameStr()?></title>


  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/validations.js<? commonCfg.getVer(); ?>"></script>

  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/settings.css<? commonCfg.getVer(); ?>">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/custom.css"  type="text/css">
  <script language="javascript" type="text/javascript">

  CSRF_TOKEN = <?= commonCfg.genCsrfTokenFile('tokenNumber')?>;

  $(document).ready(function() {
     
     $("#for_windows").on("click", function(){
        formSubmitDlClientCfgForWindows();
     });
     
     $("#for_non_windows").on("click", function(){
        formSubmitDlClientCfgForNonWindows();
     });
     
     $("#for_smart_phone").on("click", function(){
        formSubmitDlClientCfgForSmartPhone();
     });
  });
  
  function formSubmitDlClientCfgForWindows()
  {
    $.ajax({
      url : "/cgi-bin/netgear.plua?csrftoken="+CSRF_TOKEN,
      type : "POST",
      cache : false,
      dataType : "json",
      processData: false,
      contentType: "application/json; charset=utf-8",
      data : JSON.stringify($("#target").serializeObject("openvpnClientCfgUpdate")),
      success : function(data) {
          window.location.href = 'files/windows.zip';
      }
    }); //ajax()
  }

  function formSubmitDlClientCfgForNonWindows()
  {
    $.ajax({
      url : "/cgi-bin/netgear.plua?csrftoken="+CSRF_TOKEN,
      type : "POST",
      cache : false,
      dataType : "json",
      processData: false,
      contentType: "application/json; charset=utf-8",
      data : JSON.stringify($("#target").serializeObject("openvpnClientCfgUpdate")),
      success : function(data) {
          window.location.href = 'files/nonwindows.zip';
          
      }
    }); //ajax()
  }

  function formSubmitDlClientCfgForSmartPhone()
  {
    $.ajax({
      url : "/cgi-bin/netgear.plua?csrftoken="+CSRF_TOKEN,
      type : "POST",
      cache : false,
      dataType : "json",
      processData: false,
      contentType: "application/json; charset=utf-8",
      data : JSON.stringify($("#target").serializeObject("openvpnClientCfgUpdate")),
      success : function(data) {
          window.location.href = 'files/smartphone.zip';
      }
    }); //ajax()
  }

  function pre_fillout_init()
  {
      $("[name='enable']").on("click", function(){
          $(this).val($(this).prop("checked"));
      });
  }

  function postForm_callback(json)
  {
      /* Show port conflict error popup message while port conflict check fail */
      if (json.message == "VPN Port Conflict") {
          //"The specified port(s) are being used by other configurations. ..."
          alert(window.top.mlang["APPE39"]);
      }
      else {
          location.href='OPENVPN.html';
      }
  }

  function validation()
  {
      var pingEnable = $("[name='ping_enable']").val();
      var ntp_sync = "1";
      var ddns_enable_check = $("[name='ddns_enable']").val();
      var static_enable_check = $("[name='wanIsStatic']").val();
      var wan_type = $("[name='wan_type']").val();
      var ppp_conn_type = $("[name='ppp_conn_type']").val();
      var old_protocol = $("[name='oldTapModeType']").val();
      var new_protocol = $("[name='tapModeType']:checked").val();
      var service_port = $("[name='tapModePort']").val();
      var old_protocol_tun = $("[name='oldTunModeType']").val();
      var new_protocol_tun = $("[name='tunModeType']:checked").val();
      var service_port_tun = $("[name='tunModePort']").val();
      var ipv6_protocol = "disable";
      var new_redirectGW = $("[name='clientAccessType']:checked").val();
      
      if(!$("input[name='enable']").prop("checked"))
          return true;

      if(ddns_enable_check == "false" && static_enable_check == "false")
      {
          //alert("Dynamic DNS service is suggested to be used alone with the VPN Service. Please make sure you will enable the Dynamic DNS service or use Static IP address for your Internet connection.");
          alert(window.top.mlang["vpn158"]);
          window.location.reload();

          return false;
      }

      if(wan_type == "pppoe" || wan_type == "pptp" || wan_type == "l2tp")
      {
          if($("input[name='enable']").prop("checked"))
          {
              if(ppp_conn_type == "onDemand")
              {
                  //if(!confirm("If you enable the VPN service on your router, your router’s Internet connection mode will change from Dial on Demand to Always On. This change is required for a VPN client to connect to your router. Do you want to continue?"))
                  if(!confirm(window.top.mlang["UAS052"]))
                  {
                      return false;
                  }
                  else
                      $("input[name='dodTypeChange']").val("true");
              }
              else if(ppp_conn_type == "manually")
              {
                  //alert("If you enable the VPN service on your router, you need to change your router’s Internet connection mode from Manually Connect to Always On in order for a VPN client to connect to your router. Go to the Internet Setup page to make this change.");
                  alert(window.top.mlang["UAS053"]);
              }
          }
      }

      if (!$.isNumeric(service_port) || (service_port < 1) || (service_port >= 65535))
      {
          //alert("The Service Port has to be less than or equal to 65534.");
          alert(window.top.mlang["vpn164"]);
          return false;
      }

      if(!$.isNumeric(service_port_tun) || (service_port_tun < 1) || (service_port_tun >= 65535))
      {
          //alert("The Service Port has to be less than or equal to 65534.");
          alert(window.top.mlang["vpn164"]);
          return false;
      }

      if ((new_protocol == new_protocol_tun) && (service_port == service_port_tun))
      {
          //alert("Port conflicts with another rule.");
          alert(window.top.mlang["AQSE09"]);
          return false;
      }
      
      if((new_protocol != old_protocol) || (new_protocol_tun != old_protocol_tun) 
      || ($("[name='oldTapModePort']").val() != service_port) || ($("[name='oldTunModePort']").val() != service_port_tun) 
      || (new_redirectGW != $("[name='oldClientAccessType']").val()))
      {
          //alert("You have changed your VPN Service configurations, please follow the Step 2 and Step 3 to download and install the configuration files on each of your VPN client devices (overwrite existing configuration files).");
          alert(window.top.mlang["vpn160"]);
      }
      
      return true;

  }
  function formSubmit() 
  {
      if (validation())
      {
          $.postForm('openVpn', $('#target'), 'cgi-bin/netgear.plua', 'postForm_callback');
      }
  }

  function ddns_check()
  {
      var ddns_enable_check = $("[name='ddns_enable']").val();
      var openvpnEnable = $("[name='openVpn_enable']").val();

      if(openvpnEnable == "false")
      {
          //alert("Please enable the VPN Service and click \"Apply\" button first.");
          alert(window.top.mlang["vpn178"]);
          return false;
      }
      
      if(ddns_enable_check == "false")
      {
        //alert("Currently your Dynamic DNS service is not enabled, and the IP address for your Internet connection will be used for client configurations. When the IP address for your Internet connection is changed, you will have to download and install the configuration files again.");
        alert(window.top.mlang["vpn159"]);
      }
      
      return true;
  }
  </script>  
</head>
<? commonCfg.bodyBegin('openVpn', 'openvpn', 'vpn172', 'VPN Service', 'pre_fillout_init', '') ?>
    <div id="main" class="form-group" style=height:365px;overflow:auto;scrolling:auto;">
      <div class="form-row ">
        <label class="checkbox-container">
          <input type="checkbox" name="enable" id="openvpn_active" value="true"> <b mlang="vpn151">Enable VPN Service</b>
          <span class="checkbox-checkmark"></span> 
        </label>
      </div>
      <div class="divider">&nbsp;</div>
      <div class="form-row ">
        <b mlang="vpn185">OpenVPN client setup instruction</b>
      </div>
      <div class="form-row" style="padding-left: 10px;">
        <a id="link_windows" target="_new" href="vpn_instruction_windows.html"><u>Windows</u></a>
        &nbsp;&nbsp;<a id="link_macosx" target="_new" href="vpn_instruction_mac.html"><u>Mac OSX</u></a>
        &nbsp;&nbsp;<a id="link_iphone" target="_new" href="vpn_instruction_iphone.html"><u>iPhone/iPad</u></a>
        &nbsp;&nbsp;<a id="link_andriod" target="_new" href="vpn_instruction_android.html"><u>Android</u></a>
      </div>
      <div class="divider">&nbsp;</div>
      <div class="form-row ">
        <b mlang="vpn183">OpenVPN configuration package download</b>
      </div>
      <div class="form-row">
        <button type="BUTTON" value="windows_zip" name="windows" id="for_windows" class="button-sty1" onclick=" if(!ddns_check()) return false; " mlang="vpn181">For Windows</button>
        <button type="BUTTON" value="nonwindows_zip" name="non-windows" id="for_non_windows" class="button-sty1" onclick=" if(!ddns_check()) return;" mlang="vpn182">For non-Windows</button>
        <button type="BUTTON" value="smartphone_zip" name="smartphone" id="for_smart_phone" class="button-sty1" onclick=" if(!ddns_check()) return;" mlang="vpn184">For Smart Phone</button>
      </div>
      <div class="divider">&nbsp;</div>
      <div class="form-row ">
        <b mlang="vpn177">Advanced Configurations</b>
      </div>
      <div class="form-row ">
        <p mlang="vpn186">TUN Mode Service Type</p>
      </div>
      <div class="form-row" >
        <label class="checkbox-container">
        <input type="radio" name="tunModeType" id="tun_protocol_udp" value="UDP"> UDP 
        <span class="radio-checkmark"></span>
        </label>
      </div>
      <div class="form-row" >
        <label class="checkbox-container">
        <input type="radio" name="tunModeType" id="tun_protocol_tcp" value="TCP"> TCP
        <span class="radio-checkmark"></span>
        </label>
      </div>
      <div class="form-row ">
        <p mlang="vpn187">TUN Mode Service Port</p>
      </div>
      <div class="form-row" >
        <input class="table-input input1" type="text" name="tunModePort" id="openvpn_tun_service_port" value="" size="6" height="12" maxlength="8">
      </div>
      <div class="form-row ">
        <p mlang="vpn188">TAP Mode Service Type</p>
      </div>
      <div class="form-row" >
        <label class="checkbox-container">
          <input type="radio" name="tapModeType" id="protocol_udp" value="UDP"> UDP 
          <span class="radio-checkmark"></span>
        </label>
      </div>
      <div class="form-row" >
        <label class="checkbox-container">
          <input type="radio" name="tapModeType" id="protocol_tcp" value="TCP"> TCP
          <span class="radio-checkmark"></span>
        </label>
      </div>
      <div class="form-row ">
        <p mlang="vpn189">TAP Mode Service Port</p>
      </div>
      <div class="form-row" >
        <input class="table-input input1" type="text" name="tapModePort" id="openvpn_service_port" size="6" height="12" maxlength="8">
      </div>
      <div class="form-row ">
        <p mlang="vpn174">Clients will use this VPN connection to access</p>
      </div>
      <div class="form-row" >
        <label class="checkbox-container">
          <input type="radio" name="clientAccessType" id="redirectgw_all" value="allsites" >
          <span class="radio-checkmark"></span>
          <span mlang="vpn175"></span>
        </label>
      </div>
      <div class="form-row" >
        <label class="checkbox-container"> 
        <input type="radio" name="clientAccessType" id="redirectgw_only_lan" value="home" >
        <span mlang="vpn176"></span>
        <span class="radio-checkmark"></span>
        </label>
      </div>
      <div class="form-row" >
        <label class="checkbox-container">
          <input type="radio" name="clientAccessType" id="redirectgw_auto" value="auto" >
          <span mlang="SWS001"></span>
          <span class="radio-checkmark"></span>
        </label>
      </div>
    </div><!--form-group-->  
  
    <input type="hidden" value="" name="openVpn_enable" disabled>
    <input type="hidden" value="" name="ddns_enable" disabled>
    <input type="hidden" value="" name="wanIsStatic" disabled>
    <input type="hidden" value="" name="wan_type" disabled>
    <input type="hidden" value="" name="oldTunModeType" disabled>
    <input type="hidden" value="" name="oldTunModePort" disabled>
    <input type="hidden" value="" name="oldTapModeType" disabled>
    <input type="hidden" value="" name="oldTapModePort" disabled>
    <input type="hidden" value="" name="oldClientAccessType" disabled>
    <input type="hidden" value="" name="ppp_conn_type" disabled>
    <input type="hidden" value="false" name="dodTypeChange">
<? commonCfg.bodyEnd(0, 'OPENVPN.html') ?>
</html>
