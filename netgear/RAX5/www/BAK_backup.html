<!DOCTYPE HTML>
<% 
      local commonCfg = require "webGetFunc.commonCfg"
%>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <? commonCfg.getModelNameStr()?></title>

  <link rel="stylesheet" type="text/css" href="css/table_noh.css">
  <link rel="stylesheet" type="text/css" href="css/scrollbar.css">
  <link rel="stylesheet" type="text/css" href="css/button.css">
  <link rel="stylesheet" type="text/css" href="css/form.css">
  <link rel="stylesheet" type="text/css" href="css/settings.css<? commonCfg.getVer(); ?>">
  <link rel="stylesheet" type="text/css" href="css/custom.css" >

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/utils.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/embedProgressBar.js"></script>
  
  <script language="javascript" type="text/javascript">
    CSRF_TOKEN = <? commonCfg.genCsrfTokenFile('tokenNumber')?>;

    function validation()
    {
        if($("#restoreFile").val().length == 0)
        {
            //alert("File name cannot be blank.");
            alert(window.top.mlang["MBSE01"]);
            return false;
        }

        // check if file name is *.cfg (Please assign the correct file. (File format is *.cfg.))
        if($("#restoreFile").val().endsWith(".cfg") == false)
        {
            alert(window.top.mlang["MBSW03"]);
            return false;
        }

        //	if(confirm("Warning! \nRestoring settings from a configuration file will erase all of the current settings. \nAre you sure you want to do this?"))
        if(confirm(window.top.mlang["MBSW01"]))
            return true;
        else
            return false;
    }

    function formSubmit() 
    {   
        $("#erase").prop("disabled", true);
        $("#browse").prop("disabled", true);
        $("#backup").prop("disabled", true);
        $("#restore").prop("disabled", true);
        if (validation())
        {
            var formData = new FormData();
            formData.append("config_file",$("#restoreFile").prop("files")[0]);
            $.ajax({
              url : "/cgi-bin/restore.plua?csrftoken=" + CSRF_TOKEN,
              type : "POST",
              cache : false,
              dataType : "json",
              processData: false,
              contentType: false,
              data : formData,
              success : function(data) {
                  if(data.status == "error")
                  {   
                      console.log("restore failed!");
                      window.top.backUrl = "BAK_backup.html";
                      window.top.errorStr = "genie_823";
                      location.href ="ErrorMessage.html";
                  }
                  show_EmbedProgressBar('D-genie_377', 120000);
              },
              error : function(xhr, ajaxOptions, thrownError) {
                  console.log(xhr.status);
                  console.log(thrownError);
                  show_EmbedProgressBar('D-genie_377', 120000);
              },
              beforeSend : function(json) {
		  // Extend to 120 seconds
                  //setTimeout("redirectProgressBar('D-genie_377', '2000', '120000')", 100);
              }
            }); //ajax()
        }
        else
        {
            $("#erase").prop("disabled", false);
            $("#browse").prop("disabled", false);
            $("#backup").prop("disabled", false);
            $("#restore").prop("disabled", false);
        }
    }

    function toggleConfirm()
    {
      $("#confirmDiv").toggle();
      $("#primaryDiv").toggle();
      $(".form-btn-row").toggle();
      $(".help-section").toggle();
    }

    function eraseSubmit()
    {
        $("#erase").prop("disabled", true);
        $("#browse").prop("disabled", true);
        $("#backup").prop("disabled", true);
        $("#restore").prop("disabled", true);

        var json = {"function" : "restoreDefault"};

        $.ajax({
            url : "/cgi-bin/netgear.plua?csrftoken="+CSRF_TOKEN,
            type : "POST",
            cache : false,
            data : JSON.stringify(json),
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            success : function(data) {
              if(data.status == "error")
              {   
                  console.log("Reset failed!");
                  location.href ="BAK_backup.html";
              }
              show_EmbedProgressBar('D-genie_377', 120000);
            },
            error : function(xhr, ajaxOptions, thrownError) {
              console.log(xhr.status);
              console.log(thrownError);
              show_EmbedProgressBar('D-genie_377', 120000);
            },
            beforeSend : function(json) {
              // Extend to 120 seconds
              //setTimeout("redirectProgressBar('D-genie_377', '2000', '120000')", 100);
            }
        }); //ajax()
    }

    function backupSubmit()
    {
        cfg_url = "cgi-bin/NETGEAR_<? commonCfg.getModelNameStr()?>.cfg";
        window.location.href = cfg_url;
    }
  </script>

</head>
<!--? commonCfg.bodyBegin('backup', 'BAK_backup', 'LUP024', 'Backup Settings', '', '') ?-->
<body onload="window.top.change_size($(this));loadhelp('BAK_backup','');" class="page-body" onResize="window.top.change_size($(this));">
  <form id="target"  name="formname" method="POST" >
  <div class="page-header" style="position: relative;" mlang="LUP024">Backup Settings</div>
  <div id="main" class="form-group">
    <div id="primaryDiv">
      <div class="form-row pt-10">
        <a href="javascript:loadhelp('BAK_backup','save')" tabindex="-1"><b mlang="MBS004">Save a copy of current settings</b></a>
      </div>
      <div class="form-row">
        <button type="BUTTON" value="Back Up" name="Backup" id="backup" class="button-sty1" onclick="backupSubmit()" mlang="MBS002">Back Up</button> 
      </div>
  
      <div class="space-divider">&nbsp;</div>
  
      <div class="form-row">
        <a href="javascript:loadhelp('BAK_backup','restore')" tabindex="-1"><b mlang="MBS003">Restore saved settings from a file</b></a>
      </div>
  
      <div class="form-row">
        <input class="input1" type="file" name="config_file" id="restoreFile" size="23" maxlength="1024" style="position:relative;opacity:0;filter:alpha(opacity=0);font-size:15px;width:310px;padding-top:4px" onchange="this.form.upfile.value=this.value.substr(this.value.lastIndexOf('\\')+1);" contentEditable=false onkeydown="return false;" onbeforeeditfocus="return false;" onpaste="return false;">
        <div style="margin-top: -56px">
          <input class="input1" type="text" name="upfile" size="20" maxlength="1024" readonly>
          <button type="button" value="browse" id="browse" class="button-sty1" onclick="this.form.config_file.click();" onmouseover="this.style.cursor='default';" mlang="UAS017">Browse</button>
        </div>
      </div>
      <div class="form-row">
        <button type="button" value="Restore" name="mtenRestore" id="restore" class="button-sty1" onClick="formSubmit()" mlang="MBS008">Restore</button>
      </div>
  
      <div class="space-divider">&nbsp;</div>
  
      <div class="form-row">
        <a href="javascript:loadhelp('BAK_backup','revert')" tabindex="-1"><b mlang="MBS001">Revert to factory default settings</b></a>
      </div>
      <div class="form-row">
        <button type="button" value="Erase" name="defaults" id="erase" class="button-sty1" style="width:120px;"onclick="toggleConfirm();" mlang="MBS005">Erase</button> 
      </div>
    </div><!--primaryDiv-->

    <div id="confirmDiv" style="display:none;">
      <div class="form-row">
        <b mlang="MBS006">Loading the factory default settings will erase all the current settings.</b>
      </div>
      <div class="form-row">
        <b mlang="MBS007">Are you sure you want to do this?</b>
      </div>
      <div class="form-row" style="text-align:center;">
        <button type="button" value="Yes" name="ROMReset" id="yes" class="button-sty1" onclick="eraseSubmit();" mlang="SWP003">Yes</button>
        <button type="button" value="No" name="no" id="no" class="button-sty1" onclick="toggleConfirm();" mlang="SWP009">No</button>
      </div>
    </div><!--confirmDiv-->

    <div id="progressDiv" style="display:none;">
      <div class="form-row prgbar">
        <h1 mlang="D-genie_377">Rebooting the router now, please wait K</h1>
      </div>
      <div class="form-row prgbar">
        <input type="text" name="progress" id="bar" value="">
      </div>
    </div>

    <div class="space-divider">&nbsp;</div>
    <div class="space-divider">&nbsp;</div>
  </div>
  <? commonCfg.bodyEnd(2, 'BAK_backup.html') ?>    
  <? commonCfg.generate_EmbedProgressBar()?>
</html>
