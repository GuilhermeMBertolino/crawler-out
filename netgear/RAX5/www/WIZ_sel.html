<!DOCTYPE HTML>
<% 
      local commonCfg = require "webGetFunc.commonCfg"
      local installEvents = require "commonFunc.installEvents"
%>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">
  
  <title>NETGEAR Router <?= commonCfg.getModelNameStr()?></title>

  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css<? commonCfg.getVer(); ?>">
  <link rel="stylesheet" href="css/custom.css<? commonCfg.getVer(); ?>"  type="text/css">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.inputmask.min.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/validations.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/wizard.js<? commonCfg.getVer(); ?>"></script>

  <script language="javascript" type="text/javascript">
  CSRF_TOKEN = <?= commonCfg.genCsrfTokenFile('tokenNumber')?>;

  var stepPage = new Array;
  var currentPage = 0;
  var firstPing = true;
  var internetDetectRetryCount = 0;
  var internetDetectRetryMax = 1;
  var applyingWaitSecond = 30;
  var wanCurrentType = "dhcp";
  //stepPage.push({});
  function checkDefaultToSkip()
  {
      if($("[name='defaultState']").val() === "1")
      {
          if( $('[name=wizardRestoreConfigInProgress]').val() === "false" &&
              $('[name=wizardFwUpgradeInProgress]').val() === "false" &&
              $('[name=wizardWifiConfigured]').val() === "false" ) 
          {
              //$(".help-section").css("display", "none");
              togglePage("first-page", "internetPing-page");
              setTimeout('doPage()', 2000);
          }
          else
          {
              if(!init_RestoreConfig_flow_lvl_1())
              {
                  init_WifiConfiguration_or_FwUpgrade_flow();
              }
          }
      }
      else
      {
          togglePage("first-page", "first-page");
      }
  }

  function init_RestoreConfig_flow_lvl_1()
  {
      var wizardRestoreConfigInProgress = $('[name=wizardRestoreConfigInProgress]').val();
      //wizard didn't perform config restore, nothing need to handle 
      if (wizardRestoreConfigInProgress == "false") {
          return false;  
      }
      else
      {  
          //check internet status and do following RestoreConfig flow
          updateInternetStatus('init_RestoreConfig_flow_lvl_2');
          return true;
      }
  }
      
  function init_RestoreConfig_flow_lvl_2()
  {
      var internetStatus = $('[name=internetStatus]').val();

      if (internetStatus == "up") {
          //The resoted config already configured internet properly, jump to the "configuration complete" page to end the wizard
          togglePage("first-page", "congratulations-page");
          doPage();
      }
      else {
          //The restored config didn't configure internet properly, jump to "internet help choose" page for user can configure himslef
          togglePage("first-page", "internetHelpChoose-page");
          doPage();
          //hide help_restore radio for "internetHelpChoose-page" to become "networkIssue-page" which we didn't implement
          $('#help_restore_div').hide();
      }
      
      //hide the "Help Center" bar
      //$(".help-section").css("display", "none");
  }
  
  function init_WifiConfiguration_or_FwUpgrade_flow()
  {
      var wizardWifiConfigured = $('[name=wizardWifiConfigured]').val();
      var wizardFwUpgradeInProgress = $('[name=wizardFwUpgradeInProgress]').val();
      if (wizardFwUpgradeInProgress == "true" || wizardWifiConfigured == "true") {
          //$(".help-section").css("display", "none");
          togglePage("first-page", "congratulations-page");
          doPage();
          
      }
      else
      {
          return;
      }
  }

  function init_updateStatus()
  {
      checkDefaultToSkip();
  }

  $(document).ready(function() {
      addWizardPages();
      updateStatus('init_updateStatus');
      $(".page-group").each(function(i){
          var o = {};
          o.step = i+1;
          o.pageId = $(this).attr('id');
          $(this).find("button[id='next']").each(function(){this.id = "next"+o.step});
          stepPage.push(o);
      });
      $("div.page-group:visible").find("[name='next']").attr('id','next');
      
      $("[name='next']").on("click", function(e){
          var goNext = false;
          switch($(".page-group:visible").attr('id'))
          {
              case 'first-page':
                  if($("input[name='WANDetc']:checked").val() == "AutoDetc")
                  {
                      goNext = true;
                  }
                  else
                  {
                      window.location.href = "/BAS_wan.html";
                      //$("#basic-int",parent.document).click();
                      //$("#int_set",parent.document).click();
                      nextPage = 'first-page';
                  }
                  
                  break;
            
              case 'adminSetting-page':
                  if(goNext = checkAdminSettingData())
                  {
                      postAdminSetting($("[name='defaultState']").val());
                      goNext = true;
                  }
                  break;
              case 'wifiSetup-page':
                  if(goNext = checkWifiSetupData())
                  {
                      postWifiSetup();
                      goNext = false;
                      setTimeout('updateStatus("afterUpdateWifiInfo")', 100);
                  }
                  break;
              case 'restoreConfig-page':
                  if(check_restore())
                  {
                      postConfig('postConfig_callback'); 
                  }
                  break;
              case 'staticWanSetting-page':
                  if(checkStaticIpSettingData())
                  {
                      postStaticIpSetting();
                      goNext = true;
                  }
                  break;
              case 'staticWanSetting-page_v2':
                  if(checkStaticIpSettingData_v2())
                  {
                      postStaticIpSetting_v2();
                      goNext = true;
                  }
                  break;
              case 'pppoeWanSetting-page':
                  if(checkPppoeSettingData())
                  {
                      postPppoeSetting();
                      goNext = true;
                  }
                  break;
              case 'pptpWanSetting-page':
                  if(checkPptpSettingData())
                  {
                      postPptpSetting();
                      goNext = true;
                  }
                  break;    
              case 'macSetting-page':
                  if(checkWanMacSettingData())
                  {
                      postMacSetting();
                      goNext = true;
                  } 
                  break;
              default:
                   goNext = true;
                   break;
          }
          if(!goNext)
            return ;

          currentPage = findCurrentPage();
          var nextPage = changePage(currentPage);
          if(currentPage != "FW_check")
          {
              togglePage(currentPage, nextPage);
              doPage();
          }
      });
  });

  function togglePage(cur, nex)
  {
      var curPage = cur;
      var nexPage = nex;
      $("div.page-group:visible").find("[name='next']").attr('id','next'+cur );
      $("#"+curPage).hide();
      if(nexPage == 'adminSetting-page')
      {
          //follow RAX120, wizard don't need old password
          //if($("[name='defaultState']").val() === "1")          
              $("#oldPasswordTr").hide();
      }
      $("#"+nexPage).show();
      $("div.page-group:visible").find("[name='next']").attr('id','next');
      if(nexPage == "adminSetting-page")
      {
          $("div.page-group:visible").find("[name='next']").attr('id','admin_account_next');
      }
      else if(nexPage == "wifiSetup-page" )
      {
          $("div.page-group:visible").find("[name='next']").attr('id','setup_wifi_next');
      }
      else if(nexPage == "congratulations-page")
      {
          $("div.page-group:visible").find("[name='next']").attr('id','config_com_next');
      }
      else if(nexPage == "internetDetectSuccess-page")
      {
          $("div.page-group:visible").find("[name='next']").attr('id','internet_dect_next');
      }
      else if(nexPage == "pptpWanSetting-page")
      {
          $("div.page-group:visible").find("[name='next']").attr('id','pptp_next');
      }
      else if(nexPage == "internetDetectSuccess-page")
      {
          $("div.page-group:visible").find("[name='next']").attr('id','internet_dect_next');
      }
  }

  function changePage(curPage)
  {
      switch (curPage)
      {
          case 'first-page':
              if($("input[name='WANDetc']:checked").val() == "AutoDetc")
              {
                  //$(".help-section").css("display", "none");
                  if(parent.window.location.pathname == "/start.html")
                      nextPage = 'internetDetect-page';
                  else
                      nextPage = 'internetPing-page';
              }
              else
              {
                  $("#setup_header",parent.document).click();
                  $("#int_set",parent.document).click();
                  nextPage = 'first-page';
              }
              break;
          case 'internetPing-page':
              if($("[name='wanConnectionStatus']").val() === "up")
              {
                  if($("[name='internetStatus']").val() === "up")
                  {
                      nextPage = 'internetDetectSuccess-page';
                  }
                  else
                  {
                      wanCurrentType = "dhcp";
                      postDhcpSetting('');

                      if($("[name='defaultState']").val() === "0")
                      {
                          nextPage = 'internetHelpChoose-page';
                      }
                      else
                      {
                          if(!firstPing && internetDetectRetryCount >= internetDetectRetryMax)
                          {
                              internetDetectRetryCount = 0;
                              //nextPage = 'wanTypeProblem-page';//should be Ehternet failure page[18] in spec.
                              nextPage = 'internetHelpChoose-page';
                          }
                          else if(firstPing || internetDetectRetryCount >= internetDetectRetryMax)
                          {
                              internetDetectRetryCount = 0;
                              nextPage = 'internetHelpChoose-page';
                          }
                          else
                          {
                              nextPage = 'internetDetect-page';
                          }
                      }
                  }
              }
              else
              {
                  //internetDetectRetryCount = 0;
                  if($("[name='defaultState']").val() === "0")
                  {
                      nextPage = 'cableConnectionRetry-page';
                  }
                  else
                  {
                      if(firstPing)
                      {
                          nextPage = 'internetHelpChoose-page';
                      }
                      else
                      {
                          nextPage = 'noCable-page';
                      }
                  }
                   
              }
              break;
          case 'internetDetect-page':
              if($("[name='internetStatus']").val() === "up")
              {
                  nextPage = 'adminSetting-page';
              }
              else 
              {
                  if($("[name='wanConnectionStatus']").val() !== "up")
                  {
                      nextPage = 'noCable-page';
                      //nextPage = 'cableConnectionRetry-page';
                      //nextPage = 'internetHelpChoose-page';
                  }
                  else
                  {
                      if(internetDetectRetryCount < internetDetectRetryMax)
                      {
                          nextPage = 'internetDetect-page';
                      }
                      else
                      {
                          var wanDetectType = $("[name='wanDetectType']").val();
                          
                          if(wanDetectType === "pppoe")
                          {
                              wanCurrentType = "pppoe";
                              nextPage = 'pppoeWanSetting-page';
                          }
                          else if(wanDetectType === "dhcp")
                          {
                              wanCurrentType = "dhcp";
                              //Ian: use default applyingWaitSecond(30s)
                              //applyingWaitSecond = 10;
                              // KKHuang: Special case, change from PPPoE to DHCP at setup wizard
                              if(parent.window.location.pathname == "/start.html")
                                postDhcpSetting('');
                              nextPage = 'applySetting-page';
                          }
                          else if(wanDetectType === "pptp")
                          {
                              wanCurrentType = "pptp";
                              nextPage = 'pptpWanSetting-page';
                          }
                          else if(wanDetectType === "cloneMac")
                          {
                              wanCurrentType = "cloneMac";
                              //Ian: use default applyingWaitSecond(30s)
                              //applyingWaitSecond = 15;
                              postMacSetting();
                              nextPage = 'applySetting-page';
                          }
                          else
                          {
                              wanCurrentType = "dhcp";
                              nextPage = 'wanTypeProblem-page_v2';
                          }   
                      }
                  }  
              }  
              break;
          case 'internetDetectSuccess-page':
              if($("[name='internetStatus']").val() === "up")
              {
                  nextPage = 'adminSetting-page';
              }
              break;
          case 'noCable-page':
              if($("[name='no_cable_select']:checked").val() === "yes")
              {
                  nextPage = 'internetDetect-page'; 
              }
              else if($("[name='no_cable_select']:checked").val() === "manual")
              {
                  nextPage = 'adminSetting-page';
              }
              break;
          case 'cableConnectionRetry-page':
              nextPage = 'internetDetect-page';
              break;    
          case 'internetHelpChoose-page':
              if($("[name='WANDetcHelp']:checked").val() === "AutoDetc")
              {
                  //internetDetectRetryCount = 0;
                  nextPage = 'internetDetect-page';
              }
              else if($("[name='WANDetcHelp']:checked").val() === "MyDetc")
              {
                  nextPage = 'adminSetting-page';
              }
              else if($("[name='WANDetcHelp']:checked").val() === "Restore")
              {
                  nextPage = 'restoreConfig-page';
              }
              break;
          case 'adminSetting-page':
              nextPage = 'wifiSetup-page';
              break;
          case 'wanTypeProblem-page':
              if($("[name='WANDetcProblem']:checked").val() === "unknowProblem")
              {
                  nextPage = 'ipTypeChoose-page'; 
              }
              else 
              {
                  nextPage = 'internetDetect-page';
              }
              break;
          case 'wanTypeProblem-page_v2':
              if($("[name='try_again']").val() === "0")
              {
                  nextPage = 'ipTypeChoose-page'; 
              }
              else 
              {
                  nextPage = 'internetDetect-page';
              }
              break;
          case 'ipTypeChoose-page':
              if($("[name='ipProblem']:checked").val() === "staticIp")
              {
                  wanCurrentType = "static";
                  nextPage = 'staticWanSetting-page_v2'; 
              }
              else
              {
                  wanCurrentType = "mac";
                  nextPage = 'macSetting-page';
              }
              break;
          case 'staticWanSetting-page':
              nextPage = 'applySetting-page';
              break;
          case 'staticWanSetting-page_v2':
              nextPage = 'applySetting-page';
              break;
          case 'pppoeWanSetting-page':
              nextPage = 'applySetting-page';
              break;
          case 'pptpWanSetting-page':
              nextPage = 'applySetting-page';
              break;
          case 'macSetting-page':
              nextPage = 'internetDetect-page';
              break;
          case 'applySetting-page':
              nextPage = 'internetPing-page';
              if(firstPing)
              {
                  firstPing = false;
              }
              break;
          case 'wifiSetup-page':
              nextPage = 'congratulations-page';
              break;    
          case 'congratulations-page':
              window.location.href = "/FW_check.html";
              nextPage = 'FW_check';
              break;
          default:
            nextPage = 'first-page';
            break;
      }//Switch End 
      //console.log("Current: "+curPage+" Next: "+nextPage)
      return nextPage;
  }

  function doPage()
  {
      thisPage = findCurrentPage();
      // send installEvent "gui access"
      postGuiAccess(thisPage);
      switch (thisPage)
      {
          case 'first-page':
              break;
          case 'internetPing-page':
              if($("[name='wanConnectionStatus']").val() !== "up")
                  toggleNext();
              else
                  updateInternetStatus("toggleNext");
              break;
          case 'internetDetect-page':
              updateWanDetectStatus("toggleNext");
              internetDetectRetryCount++;
              break;
          case 'adminSetting-page':
              $("#adminSetting-page .appendStar").text(function(i,curContent){
                  return (curContent+'*');  
              });
              $("#adminSetting-page .appendColon").text(function(i,curContent){
                  return (curContent+':');  
              });
              break;
          case 'staticWanSetting-page':
              $('#staticWanSetting-page div[id$="-ip"]').ipInput();
              break;
          case 'macSetting-page':
              $("#macSetting-page :input").inputmask();
              $("#macFormat").text($("#macFormat").text().replace("AABBCCDDEEFF", "AA:BB:CC:DD:EE:FF"));
              break; 
          case 'applySetting-page':
              setTimeout('updateStatus("toggleNext")', applyingWaitSecond * 1000);
              break;
          case 'congratulations-page':
              setTimeout('showWifiInfo()', 12 * 1000);
              break;
          default:
            break;
      }//Switch End 
  }

  function showWifiInfo()
  {
     $(".wifiLoading").toggle();
     //$(".waitWifiSetting").css("display", "inline-block");
     $(".waitWifiSetting").toggle();
  }

  function updateStatus(callbackFun)
  {
      fetchData('target', 'wizard', '', callbackFun);
  }

  function updateInternetStatus(callbackFun)
  {
      fetchData('target', 'internetStatus', '', callbackFun);
  }

  function updateWanDetectStatus(callbackFun)
  {
      fetchData('target', 'wanDetect', '', callbackFun);
  }

  function afterUpdateWifiInfo()
  {
      currentPage = findCurrentPage();
      var nextPage = changePage(currentPage);
      togglePage(currentPage, nextPage);
      doPage();
  }

  function toggleNext()
  {
      $("div.page-group:visible").find("[name='next']").click();
  }
  
  </script>
</head>

<body onload="window.top.change_size($(this));loadhelp('WIZ_sel','');window.top.mlangInit($('#target'));" class="page-body" onResize="window.top.change_size($(this));">
  <form onSubmit="return false" id="target" name="formname" method="POST" >
    <div class="page-group" id="first-page" style="display: none;">
      <div class="page-header" style="position: relative;" mlang="LUP005">Setup Wizard</div>
      <div id="main" class="form-group" style=height:365px;overflow:auto;scrolling:auto">
        <div class="form-row ">
          <b mlang="SWP001">The Smart Setup Wizard can detect the type of Internet connection that you have.</b>
        </div>
        <div class="form-row ">
          <b mlang="SWP002">Do you want the Smart Setup Wizard to try and detect the connection type now?</b>
        </div>
        <div class="form-row pt-10">
          <label class="checkbox-container">
            <input type="radio" checked name="WANDetc" id="wan_detect_type" value="AutoDetc" checked></input>
            <span mlang="SWP003">Yes</span>
          <span class="radio-checkmark"></span>
          </label>
        </div>
        <div class="form-row ">
          <label class="checkbox-container">
            <input type="radio" name="WANDetc" id="wan_detect_type2" value="MyDetc" ></input>
            <span mlang="SWP004">No. I want to configure the router myself.</span>
          <span class="radio-checkmark"></span>
          </label>
        </div>
  
        <div class="divider">&nbsp;</div>
  
        <div class="form-row " id="form_btn_div">
          <button type="Button" value="Next" name="next" id="next" class="button-apply apply_bt mt-20" mlang="OTH011">Next</button>
        </div>
      </div><!--form-group-->
      <? commonCfg.genHelpSection() ?>
    </div><!--page-group first-page-->

<input type="hidden" name="defaultState" disabled />
<input type="hidden" name="wanConnectionStatus" disabled />
<input type="hidden" name="internetStatus" disabled />
<input type="hidden" name="wanDetectType" disabled />
<input type="hidden" name="wanMac" disabled />
<input type="hidden" name="clientMac" disabled />
<input type="hidden" name="wizardRestoreConfigInProgress" disabled>
<input type="hidden" name="wizardFwUpgradeInProgress" disabled>
<input type="hidden" name="wizardWifiConfigured" disabled>
</form>

</html>
