<!DOCTYPE HTML>
<% 
      local commonCfg = require "webGetFunc.commonCfg"
%>

<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

    <title>NETGEAR Router <?= commonCfg.getModelNameStr()?></title>

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/utils.js<? commonCfg.getVer(); ?>"></script>
  <script src="js/embedProgressBar.js"></script>

  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" type="text/css" href="css/qos_tabs.css">
   <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/settings.css">
  <link rel="stylesheet" href="css/custom.css">

  <script>

  CSRF_TOKEN = <?= commonCfg.genCsrfTokenFile('tokenNumber')?>;

 var initState = 1;
 var isApply = 0;
 var dbAction = "";
 var dbCheckDone = 0;
 var dbUpgradeDone = 0;
  $(document).ready(function()
  {
		var cf = document.forms[0];

		$('#target_qos [name=enableQos]').on('change', function() {
			$('[name=enableQos]').val($('[name=enableQos]').prop("checked"));
		});

		$('#qos_speedtest').on('click', function() {
			chk_qosrule_display();
		});
		
		$('#qos_define_bw').on('click', function() {
			chk_qosrule_display();
			if(initState == 0)
			{
				alert(window.top.mlang["AQSW02"]);
			}
		});

    $('#apply').on("click", function(ev){
        $('#apply').prop("disabled", true);
        var funcName = "setQos";
        if (validation())
        {
            if ($("input[name='speedMethod']:checked").val() == "speedtest")
            {
					$("input[name=upSpeed]").val($("input[name=speedtest_up_hid]").val());
					$("input[name=downSpeed]").val($("input[name=speedtest_down_hid]").val());
				}
            else if  ($("input[name='speedMethod']:checked").val() == "manually")
            {
						$("input[name=upSpeed]").val($("input[name=manuallyUpSpeed]").val()*1000);
						$("input[name=downSpeed]").val($("input[name=manuallyDownSpeed]").val()*1000);
					}
        }
					else
					{
            if(isApply !=1)
						document.location.reload();
						return;
					}

        $.postForm(funcName, $('#target_qos'), 'cgi-bin/netgear.plua', 'postForm_callback');
        show_EmbedProgressBar('SWP011', 10000, '/QOS_down_streaming_iqos_basic.html');
		});

		$('#cancel').on("click", function(ev){
		   document.location.reload();
		});

		$('#speedtest').on("click", function(ev){
			   startSpeedTest();
		});

    $("#device_app_link").on("click", function(){
        goAttachedDevicePage();
    });
    
    $("button[name='update_now']").on("click", function(){
        doQosDbCheck();
    });
    
    $("button[name='yes']").on("click", function(){
        $("#dbAssistant_div").hide();
        doQosDbUpgrade();
    });
    
    $("button[name='no']").on("click", function(){
        $("#dbAssistant_div").hide();
        $("#qosDiv").show();
    });

		fetchData('target_qos', 'QoS', '', 'changeInit');
		fetchData('target_qos', 'QoS_speedtest', '', '');
  });

  function postForm_callback()
  {
    /* Refreshing page is already done by progress bar, the callback function do nothing here is
       to avoid the postForm defaultHandler() refreshing page may interrupt the execution of progress bar
    */
  }

  function startDbProgress()
  {
      $("#qosDiv").hide();
      maxcharsQoS = 60;
      showDbProgressBar("SWP011",10000);
  }

  function hideDbProgressBar()
  {
      $("#pgbar-div").hide();
  }

  var db_duration;
  var db_startTime;
  var db_delay_time;
  function showDbProgressBar(barTitle_mlang, i_duration)
  {
      //hide router/ap/bridge mode page elements and show the progress bar embeded in router/ap/bridge mode page

      $("#pgbar-div").show();
      
      //change progress bar title
      $("[name=barTitle]").text(window.top.mlang[barTitle_mlang]);
      db_duration = i_duration;
      db_startTime = (new Date()).valueOf();
      db_delay_time = db_duration / (maxcharsQoS+2);// msecs
      charcountQoS = 0;
      updateDbProgress();
  }

  function updateDbProgress()
  {
      var delta = (new Date()).valueOf() - db_startTime;

      if(delta > db_duration)
      {
          if(dbAction == "check" && dbCheckDone == 1)
          {
              finishChecking();
              return;
              
          }
          else if(dbAction == "upgrade"  && dbUpgradeDone == 1)
          {
              finishUpgrading();
          return ;
      }
          else if(delta > 90000)
          {
              return;  
          }
      }
   
      if (charcountQoS < maxcharsQoS)
      {
          charcountQoS ++;
      }
  
      $("input[name='progress']").val(makeStrQoS(charcountQoS,pcharQoS));
      setTimeout("updateDbProgress()",db_delay_time);  
  }
  
  function doQosDbCheck()
  {
      dbAction = "check";
      dbCheckDone = 0;
      fetchData('target_qos', 'qosDbCheck', '', 'afterChecking');
      window.top.finishLoading();
      startDbProgress();
  }

  function afterChecking()
  {
       dbCheckDone = 1;
  }

  function finishChecking()
  {
      hideDbProgressBar();
      var checkStatus = $("input[name='check_status']").val();
      //console.log("check_status:"+checkStatus);
      if(checkStatus == "2")
      {
          $("#qosDiv").hide();
          $("#dbAssistant_div").show();
          //found new
      }
      else
      {
          $("#qosDiv").show();
          alert(window.top.mlang["AQS124"]);
          //fail or no new
      }
      
  }

  function doQosDbUpgrade()
  {
      dbAction = "upgrade";
      dbUpgradeDone = 0;
      fetchData('target_qos', 'qosDbUpgrade', '', 'afterUpgrading');
      window.top.finishLoading();
      startDbProgress();
  }

  function afterUpgrading()
  {
      dbUpgradeDone = 1;  
  }

  function finishUpgrading()
  {
      hideDbProgressBar();
      if($("input[name='upgrade_status']").val() != "4")
      {
          //Download fail;
          alert(window.top.mlang["AQSE19"]);
      }
      else
      {
          alert(window.top.mlang["AQS125"]);
      }
      
      $("#qosDiv").show();
  }

  function goAttachedDevicePage()
  {
      window.top.$('#basic-atd').click();
  }

  function startSpeedTest()
  {
      $("#check_notConnect").hide();
      $("#check_info").show();
      maxcharsQoS = 22;
      updateProgressQoS();
      $.postForm("speedTest", $('#target_qos'), 'cgi-bin/netgear.plua', 'speedTestCallback');
      window.top.finishLoading();  
  }

 function speedMethodCallBack(json)
 {
	  if (json.code == -1) {
		//ajax error, Check if the page exists
		 console.log("ajax error : " + json.message);
	  } else if (json.code == 0 || json.status == "success") {
		//ajax done, and return success.
		 document.location.reload();
	  } else {
		if(json.code == undefined) {
		  document.location.reload(); 
		}
	  }
 }

  function toSaveSpeedTestResult()
  {
      $('#apply').click();
  }

  function getSpeedTestResult()
 {
    
    $("#speedtest_tm").text("("+$("#speedtest_tm_hid").val()+")")
      if(isApply == 1)
      {
          sAlert(window.top.mlang["AQS130"], function(){toSaveSpeedTestResult();}, function(){applyToCancel();});
      }  
  }

  function speedTestCallback(json)
  {
	  $("#check_info").hide();
      $('#apply').prop("disabled", false);
      if(json.status == "error")
      {
          $("#check_notConnect").show();
      }
      else
      {
          fetchData('target_qos', 'QoS_speedtest', '', 'getSpeedTestResult');
      }
 }
 

function isFloat(value)
{
	if (isNaN(value) || value.toString().indexOf(".") < 0) 
	{
		return false;
	}
	else 
	{
		if (parseFloat(value)) 
			return true;
		else
			return false;
	}
}
	
function allnumeric(inputtxt)
{
	var numbers = /^[0-9]+$/;
	if(inputtxt.match(numbers))
	{
		return true;
	}
	else
	{
		return false;
	}
} 

  function applyToSpeedTest()
  {
      startSpeedTest();
  }

  function applyToCancel()
  {
      $('#apply').prop("disabled", false);
  }

function validation()
{
    isApply = 0;
    var ulSpeed = $("input[name=manuallyUpSpeed]").val();
    var dlSpeed = $("input[name=manuallyDownSpeed]").val();
    $("#check_notConnect").hide();

    if($("[name='enableQos']").prop("checked") && $("input[name='speedMethod']:checked").val() == "speedtest" )
    {
        if ($("input[name='wan_status']").val() == "down")
        {
            isApply=1;
            sAlert(window.top.mlang["AQSE16"], function(){applyToCancel();}, '');
            return false;
        }

        if ($("[name='speedtest_down']").text() == "0.00" && $("[name='speedtest_down_hid']").val() == "0.00" && $("[name='speedtest_up']").text() == "0.00" && $("[name='speedtest_up_hid']").val() == "0.00" )
        {
            isApply=1;
            sAlert(window.top.mlang["AQS111"], function(){applyToSpeedTest();}, function(){applyToCancel();});
            return false;
        }

        if($("[name='speedtest_up']").text() == "0" && $("[name='speedtest_down']").text() == "0")
        {
            return false;
        }
    }

    if($("input[name='speedMethod']:checked").val() == "manually")
    {
        if ((isFloat(ulSpeed)  || allnumeric(ulSpeed)) && (isFloat(dlSpeed)  || allnumeric(dlSpeed)))
        {
            if (parseInt(ulSpeed, 10) * 1000 < 1000000 && parseInt(dlSpeed, 10) * 1000 < 1000000)
            {
                return true;
            }
            else
            {
                alert(window.top.mlang["D-genie_507"]);
                document.location.reload();
                return false;
            }
        }
        else
        {
            if($("[name='manuallyDownSpeed']").val() == "" || $("[name='manuallyUpSpeed']").val() == "")
            {
                isApply=1;
                sAlert(window.top.mlang["ACB_102"], function(){applyToCancel();}, '');
            }
            else
            {
                alert(window.top.mlang["D-genie_507"]);
                document.location.reload();
            }
            return false;
        }
    }
    return true;
}

function chk_qosrule_display(){
    var cf = document.forms[0];

    if (cf.speedMethod[0].checked == true) {
        document.getElementById("qos_rule1").style.display="flex";
        document.getElementById("qos_rule2").style.display="none";
		document.getElementById("speedtest").disabled=false;
    }
    else if (cf.speedMethod[1].checked == true) {
        document.getElementById("qos_rule1").style.display="none";
        document.getElementById("qos_rule2").style.display="block";
		document.getElementById("speedtest").disabled=true;
    }
}

var pcharQoS = "|"; // progress char
var maxcharsQoS = 22;
var delay_timeQoS=1000; // msecs
var charcountQoS = 0;

function makeStrQoS(strsize, fillchar)
{
	var temp = "";
	for (i=0; i < strsize ; i ++)
		temp = temp + fillchar;
	return temp;
}

function updateProgressQoS()
{
	var cf = document.forms[0];
	
	if (charcountQoS < maxcharsQoS)
	{
		charcountQoS ++;
		cf.qosProgress.value = makeStrQoS(charcountQoS,pcharQoS);
		setTimeout("updateProgressQoS()",delay_timeQoS);
	}
	else if($("#check_info").is(":visible"))
	{
		charcountQoS = 0;
		updateProgressQoS();
	}
	
}

function  changeInit()
{
	initState = 0;
}
</script>
  
  <link href="css/custom.css" rel="stylesheet" type="text/css">

</head>

<body onload="window.top.change_size($(this));loadhelp('QOS_UP_QOS','');" class="page-body" onResize="window.top.change_size($(this));">
	<!-- target_qos form start-->
	<form id="target_qos"  name="formname_qos" >
    <div id="qosDiv">
    <div class="page-header" style="position: relative;">Speed Test</div>
    <div id="main" class="form-group" style=height:450px;overflow:auto;scrolling:auto">

	<div style="display:none;">
		<div class="form-row">
			<label class="checkbox-container">
				<a href="javascript:loadhelp('QOS_UP_QOS','')" tabindex="-1">
					<span mlang="RAX5_QOS_2">Enable Speed Test</span>
				</a>
				<input type="checkbox" name="enableQos" id="dynamic_qos_enable" value="true">
				<span class="checkbox-checkmark"></span>
			</label>
		</div>

		<div class="form-row" style="padding-left: 30px;">
			<a href="javascript:loadhelp('QOS_UP_QOS','')" tabindex="-1" mlang="RAX5_QOS_1">Speed Test does not increase your total Internet bandwidth or WiFi throughput</a>
		</div>

		<div class="form-row" style="padding-left: 30px;">
			<a href="javascript:loadhelp('QOS_UP_QOS','')" tabindex="-1"><b mlang="AQS105">Internet Bandwidth</b></a>
		</div>

		<div class="form-row" style="padding-left: 60px;">
			<label class="checkbox-container"><div mlang="AQS106">Let Speedtest detect my Internet bandwidth</div>
				<input id="qos_speedtest" type="radio" name="speedMethod" value="speedtest">
				<span class="radio-checkmark"></span>
			</label>
		</div>
	</div>

  			<div class="space-divider">&nbsp;</div>
  
			<div class="form-row">
			  <button type="button" id="speedtest" value="Speed Test" name="check_bw" class="button-sty3"  mlang="AQSE22">Take a Speedtest</button>
			</div>
			
			<div id="qos_rule1" class="form-row" style="display: flex;">
				<div style="width:265px;" align="right">
          <a target="_blank" href="http://www.speedtest.net/" id="ookla_img">
          <img src="images/speedtest_new_logo.jpg" style="margin-top:0px;">
          </a>
						<br>
						<a target="_blank" href="http://www.speedtest.net/privacy" id="online_link">
							<u>Privacy Policy</u>
						</a>
				</div>
				
				<div style="width:265px;" align="left">
           <p style="position:relative;left: 70px;top: -15px;color: #408080;">Latest test result: <span id="speedtest_tm" name="speedtest_tm" "color: #408080;">( )</span></p>
           <table style="position: relative;top: -25px;left: 70px;">
           <tr>
           <td><img src="images/speedtest_download.jpg"></td>
           <td><img src="images/speedtest_upload.jpg"></td>
           </tr>
           <tr>
           <td>
				   <span id="downlink_speed" name="speedtest_down" style="position:relative;left: 5px;color: #000000;font-weight: bold;">0.00</span>
				   <span style="position:relative;left: 5px;color: rgb(0, 0, 0);font-weight: bold;"> Mbps</span>
           </td>
            <td>
				   <span id="uplink_speed" name="speedtest_up" style="position:relative;left: 5px;color: #000000;font-weight: bold;">0.00</span>
				   <span style="position:relative;left: 5px;color: #000000;font-weight: bold;"> Mbps</span>
           </td>
           </tr>
          </table>
				</div>
			</div>
			
			<div class="form-row" id="check_info" style="display:none;">
					<b><font color=#ADA7D7 mlang="AQS089">Checking your Internet bandwidth</font></b>
					<br>
  					<input type="text" name="qosProgress" id="qosProgress" class="prgbar" value="" style="color: blue" size="20" onkeydown="return false;" onbeforeeditfocus="return false;" onpaste="return false;" contenteditable="false">
			</div>

      <div class="form-row" id="check_notConnect" style="display:none;">
        <b><font color="red" mlang="AQSE25">Could not connect to Speedtest</font></b>
      </div>

		<div style="display:none;">
			<div class="form-row"  style="padding-left: 60px;">
				<label class="checkbox-container"><div mlang="AQS109">I want to define my Internet Bandwidth</div>
					<input id="qos_define_bw" type="radio" name="speedMethod" value="manually">
					<span class="radio-checkmark"></span>
				</label>
			</div>

			<div id="qos_rule2" style="display: none;">
				<div class="form-row" style="padding-left: 28px; display:flex;">
				  <div style="width:185px">
					  <a href="javascript:loadhelp('QOS_UP_QOS','')" tabindex="-1" mlang="AQS145"><b>Download Speed (Mbps)</b> </a>
				  </div>
				  <div>
					  <input type="text" class="input1 table-input" name="manuallyDownSpeed" id="downlink_value" size="7" maxlength="7" value="">
				  </div>
				</div>

				<div class="form-row" style="padding-left: 28px; display:flex;">
					<div style="width:185px">
					  <a href="javascript:loadhelp('QOS_UP_QOS','')" tabindex="-1" mlang="AQS146"><b>Upload Speed (Mbps)</b> </a>
					</div>
					<div>
					  <input type="text" class="input1 table-input" name="manuallyUpSpeed" id="uplink_value" size="7" maxlength="7" value="">
					</div>
				</div>
			</div>
		</div>

      <div class="space-divider">&nbsp;</div>
      
			<input type="hidden"  name="downSpeed"  value="">
		    <input type="hidden"  name="upSpeed"  value="">
			<input type="hidden"  id="speedtest_down_hid" name="speedtest_down_hid"  value="">
			<input type="hidden"  id="speedtest_up_hid" name="speedtest_up_hid"  value="">
      <input type="hidden"  id="speedtest_tm_hid" name="speedtest_tm_hid" value="">
      <input type="hidden"  name="wan_status"  value="" disabled>
        <input type="hidden" value="" name="check_status" disabled>
        <input type="hidden" value="" name="upgrade_status" disabled>
			
	  </div>  <!--form-group-->
	<div class="form-btn-row" id="form_btn_div1"  style="display:none;">
		<button type="button" value="BUTTON"  name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
		<button type="button" value="apply"  name="apply" id="apply" class="button-apply apply_bt" mlang="LUP004" >Apply</button>
	</div>
    </div><!-- qosDiv --> 

      <? commonCfg.generate_EmbedProgressBar()?>

    <div id="dbAssistant_div" style="display:none;">
     <div class="page-header" style="position: relative;" mlang="AQS082">Streaming Database Update Assistant</div>
      <div class="form-group" style=height:450px;overflow:auto;scrolling:auto">
        <div class="form-row">
          <p mlang="AQS083">A New Streaming Database is Found. Do You Want to Upgrade to the New Version Now?</p>
        </div>

        <div class="divider">&nbsp;</div>
        
        <div class="form-row" style="text-align: center;">
          <button type="button" value="Yes" name="yes" id="yes" class="button-sty1" mlang="SWP003">Yes</button>
          <button type="button" value="No" name="no" id="no" class="button-sty1" mlang="SWP009">No</button>
        </div>
      </div>
    </div><!-- dbAssistant_div -->
    </form>

	
    <? commonCfg.genHelpSection() ?>
    <? commonCfg.generate_EmbedProgressBar()?>
</html>
