<!DOCTYPE HTML>
<% 
    local commonCfg = require "webGetFunc.commonCfg"
%>

<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= commonCfg.getModelNameStr()?></title>

  <link rel="stylesheet" href="css/table_noh.css">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css<?= commonCfg.getVer() ?>">
  <link rel="stylesheet" href="css/custom.css">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.inputmask.min.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<?= commonCfg.getVer() ?>"></script>
  <script src="js/validations.js<?= commonCfg.getVer() ?>"></script>
  <script src="js/embedProgressBar.js"></script>

  <script language="javascript" type="text/javascript">
    
    CSRF_TOKEN = <?= commonCfg.genCsrfTokenFile('tokenNumber')?>;

    $(document).ready(function()
    {
        fetchData('target', 'wireless_apmode_bridge', '', 'post_fillout_init');
    });

    function formSubmit() 
    {
        //fill the ip data to hidden input
        $("[name=ipAddr]").val($("#ipAddr-ip").getIp());
        $("[name=netmask]").val($("#netmask-ip").getIp());
        $("[name=gateway]").val($("#gateway-ip").getIp());
        $("[name=dns1]").val($("#dns1-ip").getIp());
        if ($("#dns2-ip").isEmptyIp() == false) {
            $("[name=dns2]").val($("#dns2-ip").getIp());
        }
        
        if (validation()) {
            $.postForm('opMode', $('#target'), 'cgi-bin/netgear.plua', 'postForm_callback');
        }
    }
    
    function validation()
    {
        var ipType = $('[name=ipType]').val();
        var dnsType = $('[name=dnsType]').val();
        var msg = "";
        
        if (ipType == "fixed") {
            
            var ipAddr = $("[name=ipAddr]").val();
            var gateway = $("[name=gateway]").val();
            var netmask = $("[name=netmask]").val();

            
            //check if IP fields are valid IP string
            if (isValidIpStr(ipAddr) == false) {
                //"Invalid IP address. Please enter it again."
                msg += window.top.mlang["SWPE05"] + "\n";
            }
            if (isValidNetmaskStr(netmask) == false) {
                //"Invalid subnet mask. Please enter it again.\n"
                msg += window.top.mlang["SWPE06"];
            }
            if (isValidIpStr(gateway) == false) {
                //"Invalid gateway IP address. Please enter it again."
                msg += window.top.mlang["SWPE04"] + "\n";
            }

            //check if ip and gateway is in same subnet
            if (isSameSubnet_v4(ipAddr, gateway, netmask) == false) {
                //Error: IP Address xxx.xxx.xxx.xxx "is in a different subnet as the gateway address xxx.xxx.xxx.xxx
                alert(window.top.mlang["SBSE09"] + ipAddr + window.top.mlang["SBSE11"] + gateway);
                return false;
            }
        }
        
        if (dnsType == "fixed") {
            var dns1 = $("[name=dns1]").val();
            var dns2 = $("[name=dns2]").val();
            
            if (isValidIpStr(dns1) == false) {
                //"Invalid primary DNS address. Please enter it again.\n";
                msg += window.top.mlang["SWPE08"];
            }
            if ($("[name=dns2]").isEmptyIp() == false && isValidIpStr(dns2) == false) {
                //"Invalid secondary DNS address. Please enter it again.\n";
                msg += window.top.mlang["SWPE09"];
            }
        }
        
        if (msg.length > 1) {
            alert(msg);
            return false;
        }

        return true;
    }

    function postForm_callback(json)
    {
        if (json.status == "success") {
            //"Please change your computer's IP address manually if LAN IP subnet will be changed."
            alert(decodeHtml(window.top.mlang["ALSW02"]));

            /* system would reboot after sending post, show progress bar and go back to first page */
            show_EmbedProgressBar('D-genie_377', 120000, 'http://www.routerlogin.net');

            //greyout BridgeMode-ReadOnly submenus when DUT switch to Bridge mode
            parent.$(".ApMode-ReadOnly").css("pointer-events", "");
            parent.$(".ApMode-ReadOnly").css("opacity", "");
            parent.$(".ApMode-ReadOnly").removeClass("auto_grey");
            parent.$(".BridgeMode-ReadOnly").css("pointer-events", "none");
            parent.$(".BridgeMode-ReadOnly").css("opacity", "0.5");
            parent.$(".BridgeMode-ReadOnly").addClass("auto_grey");
        } else {
            if (json["message"] == "SSID cannot be blank.") {
                //"SSID cannot be blank.
                alert(window.top.mlang["SWSE07"]);
            } else {
                //"Setting failed."
                alert(window.top.mlang["genie_1030"]);
            }
            document.location.reload();
        }
    }
    
    function post_fillout_init()
    {   
        /* init function */
        init_runningMode();
        init_enable_DynamicIp();
        init_enable_DynamicDns();

        /* register a onClick/onChange funtion */
        $('#target [name=mode]').on('change', function() {
            onChange_mode($('[name=mode]:checked').val());
        });
        $('#target [name=enable_DynamicIp]').on('change', function() {
            $('[name=enable_DynamicIp]').val($('[name=enable_DynamicIp]').prop("checked"));
            onChange_enable_DynamicIp();
        });
        $('#target [name=enable_DynamicDns]').on('change', function() {
            $('[name=enable_DynamicDns]').val($('[name=enable_DynamicDns]').prop("checked"));
            onChange_enable_DynamicDns();
        });
    }
    
    /* init function Section --------> Begin */
    function init_runningMode()
    {
        var runningMode = $('[name=runningMode]').val();
        
        //change the color of the icon based on which mode is running
        if (runningMode == "router") {
            $("#router").removeClass("icon").addClass("icon_select");
        }
        else if (runningMode == "ap") {
            $("#ap").removeClass("icon_unselect").addClass("icon_select");
        }
        else if (runningMode == "bridge") {
            $("#bridge").removeClass("icon_unselect").addClass("icon_select");
        }
        
        //when runningMode is not bridge mode, fillout elements by the web default value instead of by the db value
        //if (runningMode != "bridge") {
            //change the default IP setting to be dynamic not fixed
            $('[name=enable_DynamicIp]')[0].checked = true;
            $('[name=enable_DynamicIp]').val("true");
            $('[name=enable_DynamicDns]')[0].checked = true;
            $('[name=enable_DynamicDns]').val("true");
        //}
    }
    
    function init_enable_DynamicIp()
    {
        onChange_enable_DynamicIp();
    }
    
    function init_enable_DynamicDns()
    {
        onChange_enable_DynamicDns();
    }
    /* init function Section --------> End */
    
    /* Onclick Callback Section --------> Begin */
    function onChange_mode(mode) 
    {
        if (mode == "router") {
            location.href="WLG_ap_router.html";
        }
        else if (mode == "ap") {
            location.href="WLG_ap_ap.html";
        }
        else if (mode == "bridge") {
            location.href="WLG_ap_bridge.html";
        }
    }
    
    function onClick_edit()
    {
        //jump to Device Name page
        parent.highLightMenu('setup_header', 'device_name');
        parent.loadPage("DEV_name.html");
    }

    function onClick_wireless_settinge()
    {
        // open traffic status window
        var winoptions = "resizable=0,scrollbars=yes,width=600,height=535,left=400,top=300";
        
        brWirelessWinVar = window.open('WLG_ap_bridge_wlan.html','net_folder',winoptions);

        if (brWirelessWinVar.focus) {
            setTimeout('brWirelessWinVar.focus()',200);
        }
    }
    
    function onChange_enable_DynamicIp()
    {
        var enable = $('[name=enable_DynamicIp]').val();
        
        //sync value to ipType for post parameter
        //greyout/un-greyout fixed_ip_fields
        if (enable == "true") {
            $('[name=ipType]').val('dynamic');
            $("#fixed_ip_fields").css("pointer-events", "none");
            $("#fixed_ip_fields").css("opacity", "0.5");
            
            $("[name=enable_DynamicDns]")[0].disabled = false;
        }
        else if (enable == "false") {
            $('[name=ipType]').val('fixed');
            $("#fixed_ip_fields").css("pointer-events", "");
            $("#fixed_ip_fields").css("opacity", "");
            
            //greyout enable_DynamicDns checkbox when enable_DynamicIp is un-checked
            $("[name=enable_DynamicDns]")[0].disabled = true;
            $("[name=enable_DynamicDns]")[0].checked = false;
            $("[name=enable_DynamicDns]").change();
        }
    }
    
    function onChange_enable_DynamicDns()
    {
        var enable = $('[name=enable_DynamicDns]').val();
        
        //sync value to dnsType for post parameter
        //greyout/un-greyout fixed_dns_fields
        if (enable == "true") {
            $('[name=dnsType]').val('dynamic');
            $("#fixed_dns_fields").css("pointer-events", "none");
            $("#fixed_dns_fields").css("opacity", "0.5");
        }
        else if (enable == "false") {
            $('[name=dnsType]').val('fixed');
            $("#fixed_dns_fields").css("pointer-events", "");
            $("#fixed_dns_fields").css("opacity", "");
        }
    }
    /* Onclick Callback Section --------> End */ 
    
    function isValidIpStr(str)
    {
        var ip = str.split('.');
        var i;
        
        if (ip.length != 4) {
            return false;
        }
        
        for (i = 0; i < ip.length; i++) {
            if (isNumStr(ip[i]) == false) {
                return false;
            }
            
            if (parseInt(ip[i]) < 0 || parseInt(ip[i]) > 255) {
                return false;
            }
        }
        
        if (parseInt(ip[3]) == 0 ) {
            return false;
        }
        
        return true;
    }
    
    function isNumStr(str)
    {
        var i;
        if (str.length == 0) {
            return false;
        }
        
        for(i = 0; i < str.length; i++) {
            var c = str.substring(i, i+1);
            if("0" <= c && c <= "9") {
                continue;
            }
            return false;
        }
        
        return true;
    }
    
  </script>


<style>
.boxline{width: 590px; height: 180px; margin: 0 auto; position: relative;}
.box_select {width: 170px; height: 150px; float: left; position: relative; margin-left: 20px; margin-top: 20px;}
.box_select .radio_box{width: 90%; height: 20px; font-size: 13px; font-weight: bold; color: black; position: relative; top: 10px; padding-left: 10%;}
.box_select .icon_unselect, .box_select .icon_select{width:100px; height: 100px; position: absolute; bottom: 0px; left: 20px; cursor: pointer;}
.box_select .icon_unselect img, .box_select .icon_select img{width:100px; height:100px}
.box {width: 170px; height: 110px; float: left; position: relative; margin-left: 20px; margin-top: 30px; }
.box .radio_box{width: 90%; height: 20px; font-size: 11px; font-weight: bold; color: black; position: relative; top: 10px; padding-left: 10%;}
.box .icon_unselect, .box .icon_select{width:60px; height: 60px; position: absolute; bottom: 0px; left: 20px; cursor: pointer;}
.box .icon_unselect img, .box .icon_select img{width:60px; height:60px}
.icon_unselect { background-color: #5db5e5;border-radius:8px;}
.icon_select { background-color: #6abd49;}

#content1{width:58%;height:auto;position:relative;left:5%;float:left;background-image:url(images/v_middleline.gif);background-repeat:repeat-y;background-position:100% 0}
#content3{width:25%;height:auto;position:relative;left:5%;float:left}

.iptable{background:url(images/ap_map_700.gif) no-repeat;width:374px;height:280px;left:5%;}
.table1{border:#d7d7d7 solid 1px;margin-bottom:15px;font-size:14px}
</style>

</head>

<body onload="window.top.change_size($(this));loadhelp('WLG_ap_bridge','');" class="page-body" onResize="window.top.change_size($(this));">
    <div class="page-header" style="position: relative;">
        <span mlang="ACB_110">Router / AP / Bridge Mode</span>
    </div>
    
    <div id="main" class="form-group"  style=height:365px;overflow:auto;scrolling:auto">
    
    <!-- form -->
    <form id="target"  name="formname" method="POST" >
        <div class="main_top_button">
            <div class="boxline">
                <div class="box">
                    <div class="radio_box">
                        <input type="radio" name="mode" value="router" id="routerid">
                        <label for="routerid" mlang="RAEM06"> Router Mode </label>
                    </div>
                    <div id="router" class="icon_unselect" onclick="onChange_mode('router')">
                        <img src="/images/router.gif">
                    </div>
                </div>
                <div class="box">
                    <div class="radio_box">
                        <input type="radio" name="mode" id="routerapid" value="ap">
                        <label for="routerapid" mlang="AAW028"> AP Mode </label>
                    </div>
                    <div id="ap" class="icon_unselect" onclick="onChange_mode('ap')">
                        <img src="/images/ap.gif">
                    </div>
                </div>
                <div class="box_select">
                    <div class="radio_box">
                        <input type="radio" name="mode" id="apid" value="bridge" checked>
                        <label for="apid" mlang="MRS093"> Bridge Mode </label>
                    </div>
                    <div id="bridge" class="icon_unselect" onclick="onChange_mode('bridge')">
                        <img src="/images/bridge.gif">
                    </div>
                </div>
                
                <input type="hidden" name="runningMode" disabled>
            </div>
            
            <div class="form-row">
                <button class="button-sty1" type="button" id="setup_bridge" name="wireless_setting" onClick="onClick_wireless_settinge()" mlang="PCVP_092">Setup bridge mode wireless settings</button>
            </div>
            
            <div class="space-divider">&nbsp;</div>
            
            <div class="form-row">
                &nbsp; 
                <span mlang="MAD001">Device Name</span>
                :
                <span name="deviceName"></span>
                &nbsp;&nbsp;&nbsp;
                <button class="button-sty1" type="button" id="edit_devname_bt" name="edit" onClick="onClick_edit()" mlang="UAS011">Edit</button>
            </div>
            
            <div class="form-row">
                <label class="checkbox-container">
                    <span mlang="AAW030" >Get IP Address Dynamically</span>
                        <input type="checkbox" name="enable_DynamicIp" id="dyn_bridge_get_ip" value="true">
                    <span class="checkbox-checkmark"></span>
                </label>
                <input type="hidden" name="ipType">
            </div>
            
            <div id="fixed_ip_fields">
                <div class="form-row">
                    <span mlang="SWP030">IP Address</span>
                </div>
                <div class="form-row">
                    <div id="ipAddr-ip"></div>
                    <input type="hidden" name="ipAddr">
                </div>
                    
                <div class="form-row">
                    <span mlang="SWP044">IP Subnet Mask</span>
                </div>
                <div class="form-row">
                    <div id="netmask-ip"></div>
                    <input type="hidden" name="netmask">
                </div>
                    
                <div class="form-row">
                    <span mlang="SWP034">Gateway IP Address</span>
                </div>
                <div class="form-row">
                    <div id="gateway-ip"></div>
                    <input type="hidden" name="gateway">
                </div>
            </div>
            
            <div class="form-row">
                <label class="checkbox-container">
                    <span mlang="AAW031" >Get DNS Server Address Dynamically</span>
                        <input type="checkbox" name="enable_DynamicDns" id="dyn_dns_r" value="true">
                    <span class="checkbox-checkmark"></span>
                </label>
                <input type="hidden" name="dnsType">
            </div>
            
            <div id="fixed_dns_fields">
                <div class="form-row">
                    <span mlang="SWP022">Primary DNS</span>
                </div>
                <div class="form-row">
                    <div id="dns1-ip"></div>
                    <input type="hidden" name="dns1">
                </div>
                    
                <div class="form-row">
                    <span mlang="SWP023">Secondary DNS</span>
                </div>
                <div class="form-row">
                    <div id="dns2-ip"></div>
                    <input type="hidden" name="dns2">
                </div>
            </div>
                    
            <div class="space-divider">&nbsp;</div>        
            
            <div class="form-row">
                <b mlang="AWA013">Note:</b>
                <span mlang="AWA014">After you click Apply, this device will change to a new IP assigned by your existing router, therefore this web page might not be available. Please close and restart the web browser to http://www.routerlogin.net/ again.</span>
            </div>
            
            <div class="space-divider">&nbsp;</div> 
        </div>
    </form>
    <!-- form end -->
    </div><!-- form-group end -->
    
    <div class="form-btn-row" id="form_btn_div">
        <button type="button" value="cancel"  onClick="location.href='WLG_ap_basic.html';" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
        <button type="button" value="apply"  onClick="formSubmit($(this))" name="apply" id="apply" class="button-apply apply_bt" mlang="LUP004">Apply</button>
    </div>

    <?= commonCfg.genHelpSection() ?>
    <?= commonCfg.generate_EmbedProgressBar() ?>
    
</html>
