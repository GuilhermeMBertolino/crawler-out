<!DOCTYPE HTML>
<!-- include PHP to use php functions -->
<? include 'php/commonCfg.php';?>

<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= getModelNameStr()?></title>

  <link rel="stylesheet" href="css/table_noh.css">
  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" href="css/custom.css">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.inputmask.min.js"></script>
  <script src="js/ipInput.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  <script src="js/validations.js<? getVer(); ?>"></script>

  <script language="javascript" type="text/javascript">

    CSRF_TOKEN = <?= genCsrfTokenFilePhp('tokenNumber')?>;
    
    $(document).ready(function()
    {
        var sku = "<?= getNmrpSKU() ?>";
        if (sku == "PR")
        {
            $('#sys_dnsprovider_list').append($("<option/>", {
                value: "pubyun",
                text: "www.3322.org"
            }));
        }

        fetchData('target', 'ddns', '', 'post_fillout_init');
    });

    function formSubmit() {
        if (validation()) {
            $.postForm('ddns', $('#target'), 'cgi-bin/rex_cgi', 'postForm_callback_register_apply');
        }
    }
    
    function postForm_callback_reset()
    {
        /* After sending post, the update of ddns status would spend abount 10 second ,so show progress bar */
        setTimeout("redirectProgressBar('D-genie_93', '', '10000', 'DNS_ddns.html')", 10);
    }

    function formSubmit_reset()
    {
        $('[name=action]').val('reset');
        
        $.postForm('ddns', $('#target'), 'cgi-bin/rex_cgi', 'postForm_callback_reset');
    }
    
    function validation()
    {
        var ddns_service = $('select[name=ddnsService]').val();
        var hostname = $('#target [name=hostName]').val();
        var username = $('#target [name=username]').val();
        var password = $('#target [name=password]').val();
        
        if (ddns_service != "netgear") {
            /* check hostname, username, password blank*/
            if (hostname == "") {
                //"Host Name must not be blank."
                alert(window.top.mlang["ADD005"] + window.top.mlang["APPE13"])
                return false;
            }
            if (username == "") {
                //"User Name must not be blank."
                alert(window.top.mlang["SWP051"] + window.top.mlang["APPE13"])
                return false;
            }
            if (password == "") {
                //"Password must not be blank."
                alert(window.top.mlang["SWP027"] + window.top.mlang["APPE13"])
                return false;
            }
            
            /* check hostname */
            var hostnameMaxLength = 128;
            if (ddns_service == "pubyun")
            {
                hostnameMaxLength = 255;
            }
            if ( hostname.length > hostnameMaxLength || hostname.match( /[^\x20-\x7E]/ ) ) {
                //"Invalid host name."
                alert(window.top.mlang["ADDE06"]);
                return false;
            }
            
            /* check user name */
            var usernameMinLength = 0;
            if (ddns_service == "pubyun")
            {
                if (username.length < 3)
                {
                    //"User Name for www.3322.org should be no less than 3 characters"
                    alert(window.top.mlang["ADDE24"]);
                    return false;
                }
                else if (username.length > 64)
                {
                    //"User Name for www.3322.org should be no more than 64 characters"
                    alert(window.top.mlang["ADDE25"]);
                    return false;
                }
                else if (username.match( /[^\x20-\x7E]/ ))
                {
                    //"Invalid user name."
                    alert(window.top.mlang["ADDE04"]);
                    return false;
                }
            }
            else
            {
                if (username.length > 64 || username.match( /[^\x20-\x7E]/ ))
                {
                    //"Invalid user name.
                    alert(window.top.mlang["ADDE04"]);
                    return false;
                }
            }
            
            /* check password */
            if (ddns_service == "pubyun")
            {
                if (password.length < 6)
                {
                    //"Password for www.3322.org should be no less than 6 characters"
                    alert(window.top.mlang["ADDE26"]);
                    return false;
                }
                else if (password.length > 64)
                {
                    //"Password for www.3322.org should be no more than 64 characters"
                    alert(window.top.mlang["ADDE27"]);
                    return false;
                }
                else if (password.match( /[^\x20-\x7E]/ ))
                {
                    //"Invalid password."
                    alert(window.top.mlang["ADDE05"]);
                    return false;
                }
            }
            else
            {
                if (password.length < 6 || password.length > 32 || password.match( /[^\x20-\x7E]/ )) {
                    //"Invalid password."
                    alert(window.top.mlang["ADDE05"]);
                    return false;
                }
            }
        }
        else {
            /* ToDo : Netgear DDNS service post data validation */
        }
        
        return true;
    }
    
    function post_fillout_init()
    {   
        /* apply the mlang tag */
        $("[mlang]").each(function(idx, obj) {
            obj.innerHTML = window.top.mlang[obj.attributes.mlang.value];
        });
        
        /* init function */
        init_agreenTermsOfService();
        init_ddnsService();
        init_enableDdns();
        
        /* register a onClick/onChange funtion */
        $('#target [name=enableDdns]').on('change', function() {
            $('#target [name=enableDdns]').val($('#target [name=enableDdns]').prop("checked"));
            $('#msg_netgear_update_fail').hide();
            onChange_enableDdns();
        });
        $('#target select[name=ddnsService]').on('change', function() {
            onChange_ddnsService();
        });
        $('#target [name=haveNetgearAccount]').on('change', function() {
            onChange_haveNetgearAccount();
        });
        $('#target [name=hostName]').on('blur', function() {
            onBlur_hostName();
        });       
        $('#target [name=email]').on('blur', function() {
            onBlur_email();
        });
        $('#target [name=password]').on('blur', function() {
            onBlur_password();
        });
        $('#target [name=agreeTermOfService]').on('change', function() {
            $('[name=agreeTermOfService]').val($('[name=agreeTermOfService]').prop("checked"));
            onChange_agreeTermOfService();
        });

        $('#target [name=wildCards]').on('change', function() {
            $('[name=wildCards]').val($('[name=wildCards]').prop("checked"));
        });
    }
    
    function postForm_callback_register_apply(json)
    {
        if (json.message == "Set ddns SUCCESS") {
             /* Record apply/register button was clicked */
            sessionStorage.setItem("clicked_DDNSApplyButton", "true");
            
            /* After sending post, the update of ddns status would spend abount 45 second ,so show progress bar */
            setTimeout("redirectProgressBar('MRU015', '', '45000', 'DNS_ddns.html')", 10);
        }
    }
    
    /* init function Section --------> Begin */
    function init_enableDdns()
    {
        onChange_enableDdns();
    }
    
    function init_ddnsService()
    {
        onChange_ddnsService();
    }
    
    function init_agreenTermsOfService()
    {
        //sync init checkbox value because it is not in fetchData parameters
        $('[name=agreeTermOfService]').val($('[name=agreeTermOfService]').prop("checked"));
        
        onChange_agreeTermOfService();
    }
    
    function init_NetgearAccount_inRunning()
    {
        var ddnsStatus = $('[name=ddnsStatus]').val();
        var runningProvider = $('[name=runningProvider]').val();
        
        if (runningProvider == "netgear" && ddnsStatus == "HostnameUpdateSucess") {
            $('.NetgearAccount_inRunning').show();
            $('.NetgearAccount_notInRunning').hide();
        }
        else {
            $('.NetgearAccount_inRunning').hide();
            $('.NetgearAccount_notInRunning').show();
        }
        
        /* show error message of netgear account update fail */
        var clicked_DDNSApplyButton = sessionStorage.getItem("clicked_DDNSApplyButton");
        
        if (clicked_DDNSApplyButton == "true" && runningProvider == "netgear" && ddnsStatus != "HostnameUpdateSucess") {
            sessionStorage.setItem("clicked_DDNSApplyButton", "false");
            $('#msg_netgear_update_fail').show();
        }
        else {
            $('#msg_netgear_update_fail').hide();
        }
    }
    /* init function Section --------> End */
    
    /* Onclick Callback Section --------> Begin */
    function onChange_enableDdns()
    {
        var enable_ddns = $('[name=enableDdns]').val();
        
        if (enable_ddns == "false") {
            /* Greyout all DDNS input elements except enableDdns itself. */
            $(".inputDDNS").css("pointer-events", "none");
            $(".inputDDNS").css("opacity", "0.5");
        }
        else {
            $(".inputDDNS").css("pointer-events", "");
            $(".inputDDNS").css("opacity", "");
        }
    }
    
    function onChange_ddnsService()
    {
        var ddns_service = $('select[name=ddnsService]').val();
        
        if (ddns_service != "netgear") {
            /* hide elements related to the "NETGEAE" option  */
            $('.netgearDDNS').hide();
            $('.notNetgearDDNS').show();
            /* always show apply buttons while select non-netgear ddns */
            $("#show_status").css("visibility","visible");
            $("#cancel").css("visibility","visible");
            $("#apply").css("visibility","visible");
            /* always hide netgear ddns service related invalid error text while select non-netgear ddns */
            $('#invalid_netgear_hostname').hide();
            $('#invalid_email').hide();
            $('#invalid_netgear_password').hide();
            $('#msg_netgear_update_fail').hide();
            $('.both_provider').show();

            if (ddns_service == "pubyun")
            {
                $('.useWildCards').show();
                $('#target [name=hostName]').attr('maxlength', '255');
                $('#target [name=password]').attr('maxlength', '64');
            }
            else
            {
                $('.useWildCards').hide();
                $('#target [name=hostName]').attr('maxlength', '128');
                $('#target [name=password]').attr('maxlength', '32');
            }
        }
        else {
            /* show elements related to the "NETGEAE" option  */
            $('.netgearDDNS').show();
            $('.notNetgearDDNS').hide();
            /* hide/show haveNetgearAccount related elements */
            onChange_haveNetgearAccount();
            /* check if invalid_netgear_hostname need to show */
            onBlur_hostName()
            /* check if invalid_email need to show */
            onBlur_email();
            /* check if invalid_netgear_password need to show */
            onBlur_password();

            $('#target [name=hostName]').attr('maxlength', '144');
            $('#target [name=password]').attr('maxlength', '32');
        }
        
    }
    
    function onChange_haveNetgearAccount()
    {
        var haveNetgearAccount = $('#target [name=haveNetgearAccount]:checked').val();
        
        if (haveNetgearAccount == "yes") {
            $('.netgearAccountYes').show();
            $('.netgearAccountNo').hide();

            $("#show_status").css("visibility","visible");
            $("#cancel").css("visibility","visible");
            $("#apply").css("visibility","visible");
            // check if NetgearAccount_inRunning need to show
            init_NetgearAccount_inRunning();
        }
        else {
            // check if NetgearAccount_inRunning need to hide
            init_NetgearAccount_inRunning();
            $('.netgearAccountYes').hide();
            $('.netgearAccountNo').show();
            /* no netgear account, only show register account button, not show apply buttons */
            $("#show_status").css("visibility","hidden");
            $("#cancel").css("visibility","hidden");
            $("#apply").css("visibility","hidden");
        }
    }
    
    function onBlur_hostName()
    {
        var ddns_service = $('select[name=ddnsService]').val();
        var hostName = $('#target [name=hostName]').val();

        if (ddns_service == "netgear") {
            if (hostName.length > 144  || hostName.match( /[^a-zA-Z0-9\_\-]/ )) {
                $('#invalid_netgear_hostname').show();
            }
            else {
                $('#invalid_netgear_hostname').hide();
            }
        }
        else {
            //non-netgear ddns service does not check hostname in onBlur function
        }
    }
    
    function onBlur_email()
    {
        var email = $('#target [name=email]').val();
        var emailRule = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;
        
        if (email.length == 0) {
            $('#invalid_email').hide();
        }
        else if (email.length > 48) {
            $('#invalid_email').show();
        }
        else if (email.search(emailRule) == -1) {
            $('#invalid_email').show();
        }
        else {
            $('#invalid_email').hide();
        }
    }
    
    function onBlur_password()
    {
        var ddns_service = $('select[name=ddnsService]').val();
        var password = $('#target [name=password]').val();
        
        if (ddns_service == "netgear") {
            if (password.length == 0) {
                $('#invalid_netgear_password').hide();
            }
            else if (password.length < 6 || password.length > 32) {
                $('#invalid_netgear_password').show();
            }
            else {
                $('#invalid_netgear_password').hide();
            }
        }
        else {
            //non-netgear ddns service does not check password in onBlur function
        }
    }

    function onChange_agreeTermOfService()
    {
        var agreeTermOfService = $('[name=agreeTermOfService]').val();
        
        if (agreeTermOfService == "true") {
            $('[name=NRegister]').attr('disabled', false);
            $("[name=NRegister]").css("opacity", "");
        }
        else if (agreeTermOfService == "false") {
            $('[name=NRegister]').attr('disabled', true);
            $("[name=NRegister]").css("opacity", "0.5");
        }
    }
    /* Onclick Callback Section --------> End */

    function showResult() 
    {
        var winoptions = "width=780,height=360,status=yes,resizable=yes";
        openDataSubWin('DNS_ddns_st.html',winoptions);
    }
    
    function openDataSubWin(filename,win_type)
    {
        datSubWinVar = window.open(filename,'datasub_win',win_type);
        if (datSubWinVar && datSubWinVar.focus)
            setTimeout('datSubWinVar.focus()',200); 
    }
  </script>


</head>

<body onload="window.top.change_size($(this));loadhelp('DNS_ddns','');" class="page-body" onResize="window.top.change_size($(this));">
    <div id="main_page"> <!-- main_page div end -->
    <div class="page-header" style="position: relative;">
        <span mlang="LUP034">Dynamic DNS</span>
        <img id="Netgear_noip" style="width:100px;position:absolute;right:20px" src="images/DDNS_NoIplog.png">
    </div>
    
    <div id="main" class="form-group" style="height:370px;overflow:auto;scrolling:auto">
    
    <!-- ddns form -->
    <form id="target"  name="formname" method="POST" >
        <div class="form-row">
            <label class="checkbox-container">
                <a href="javascript:loadhelp('DNS_ddns','setup')" tabindex="-1">
                    <b mlang="ADD002">Use a Dynamic DNS Service</b>
                </a>
                <input type="checkbox" name="enableDdns" id="sys_dnsactive" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
        </div>
        
        <div class="divider">&nbsp;</div>
        
        <div class="form-row">
            <a href="javascript:loadhelp('DNS_ddns','provider')" tabindex="-1">
                <b mlang="ADD001">Service Provider</b>
            </a>
        </div>
        
        <div class="form-rowv inputDDNS">
            <select name="ddnsService" id="sys_dnsprovider_list" size=1>
                <option value="netgear" selected>NETGEAR</option>
                <option value="noip">NoIP.com</option>
                <option value="dyndns">www.DynDNS.org</option>
            </select>
        </div>
        
        <div class="space-divider">&nbsp;</div>
        
        <div class="form-row netgearDDNS NetgearAccount_notInRunning">
            <span mlang="ADD014">Do you have a NETGEAR DDNS or a No-IP DDNS account?</span>
        </div>
        <div class="form-row inputDDNS netgearDDNS NetgearAccount_notInRunning">
            <label class="checkbox-container" ><div mlang="SWP003">Yes</div>
                <input type="radio" name="haveNetgearAccount" id="account_yes" value="yes">
                <span class="radio-checkmark"></span>
            </label>
        </div>
        <div class="form-row inputDDNS netgearDDNS NetgearAccount_notInRunning">
            <label class="checkbox-container"><div mlang="SWP009">No</div>
                <input type="radio" name="haveNetgearAccount" id="account_no" value="no">
                <span class="radio-checkmark"></span>
            </label>
        </div>
        
        
        <div class="netgearDDNS NetgearAccount_inRunning">
            <div class="divider">&nbsp;</div>
            
            <div class="form-row">
                <b mlang="ADD032">The NETGEAR DDNS on this router is currently configured to</b>
                <b>:</b>
            </div>
        
            <div class="form-row">
                <b mlang="ADD005">Host Name</b>
                <b>:</b>
                <span name="runningHostName"></span>
            <!-- .mynetgear.com -->
            </div>
        
            <div class="form-row">
                <b mlang="ADD033">Account/Email</b>
                <b>:</b>
                <span name="runningEmail"></span>
            </div>
        
            <div class="form-row">
                <span mlang="PCVP_004">To change the settings, click</span>
                <button type="button" value="add" onClick="formSubmit_reset($(this))" id="NReset" name="NReset" class="button-sty1" mlang="GD15">Reset</button>
                <span mlang="PCVP_005">to reset the settings first.</span>
            </div>
        </div>
        
        <div class="form-row netgearDDNS netgearAccountNo">
            <span mlang="ADD035">Please enter the following information for registration.</span>
        </div>
        
        <div class="form-row NetgearAccount_notInRunning both_provider">
            <span mlang="ADD005">Host Name</span>
        </div>
        <div class="form-row inputDDNS NetgearAccount_notInRunning both_provider">
            <input class="input1" type="text" name="hostName" id="sys_dnshost" size="32" maxlength="255">
        </div>
        
        <div class="form-row inputDDNS NetgearAccount_notInRunning">
            <span class="netgearDDNS">.mynetgear.com</span>
        </div>

        <div class="form-row" id="invalid_netgear_hostname" style="display:none;">
            <div>
                <img src="images/DDNS_No.png">
            </div>
            <div style="text-align:left;color:#FF0000" mlang="ADDE07">The hostname is not valid. The characters allowed here are '0'~'9', 'a'~'z', 'A'~'Z', and hyphen '-'</div>
        </div>
        
        <div class="form-row netgearDDNS NetgearAccount_notInRunning">
            <span mlang="LPC005">Email</span>
        </div>
        <div class="form-row inputDDNS netgearDDNS NetgearAccount_notInRunning">
            <input class="input1" type="text" name="email" id="sys_dnsmail" size="30" maxlength="48">
        </div>   
        
        <div class="form-row" id="invalid_email" style="display:none;">
            <div>
                <img src="images/DDNS_No.png">
            </div>
            <div style="text-align:left;color:#FF0000" mlang="ADDE08">The email address is not valid</div>
        </div>
        
        <div class="form-row notNetgearDDNS">
            <span mlang="SWP051">User Name</span>
        </div>
        <div class="form-row inputDDNS notNetgearDDNS">
            <input class="input1" type="text" name="username" id="sys_dnsuser" size="32" maxlength="64">
        </div> 
        
        <div class="form-row netgearDDNS NetgearAccount_notInRunning">
            <span mlang="ADD015">Password (6~32 characters)</span>
        </div>
        <div class="form-row notNetgearDDNS">
            <span mlang="SWP027">Password</span>
        </div>
        <div class="form-row inputDDNS NetgearAccount_notInRunning both_provider">
            <input class="input1" type="password" name="password" id="sys_dnspassword" size="30" maxlength="32">
        </div>
        <div class="form-row inputDDNS notNetgearDDNS useWildCards">
            <label class="checkbox-container">
                <input type="checkbox" name="wildCards" id="wild_cards" value="true"> <b mlang="ADD003">Use Wildcards</b>
                <span class="checkbox-checkmark"></span>
            </label>
        </div>

        <div class="form-row" id="invalid_netgear_password" style="display:none;">
            <div>
                <img src="images/DDNS_No.png">
            </div>
            <div style="text-align:left;color:#FF0000" mlang="ADDE09">Your password must be at least 6 characters long and at most 32 characters long</div>
        </div>
        
        <div class="form-row" id="msg_netgear_update_fail" style="display:none;">
            <span style="color:#FF0000" name="msgNetgearUpdateFail"></span>
            <span style="color:#FF0000" name="msgNetgearUpdateFail_continue"></span>
            <span style="color:#FF0000" name="msgNetgearUpdateFail_continue2"></span>
        </div> 
        
        <div class="space-divider">&nbsp;</div>
        
        <div class="form-row inputDDNS netgearDDNS netgearAccountNo">
            <label class="checkbox-container">
                <span mlang="PCVP_058">By submitting this form I agree to No-IP</span>
                <a href="https://www.noip.com/legal/tos" target="_blank" id="link_tos" style="color: rgb(000,000,255);text-decoration:underline">
                    <span mlang="ADD019">terms of service</span>
                </a>
                <span>&nbsp;</span>
                <span mlang="genie_225">and</span>
                <span>&nbsp;</span>
                <a href="https://www.noip.com/legal/privacy" target="_blank" id="link_policy" style="color: rgb(000,000,255);text-decoration:underline">
                    <span mlang="genie_322">Privacy Policy</span>
                </a>
                <input type="checkbox" name="agreeTermOfService" id="ddns_reg_agree" value="true">
                <span class="checkbox-checkmark"></span>
            </label>
        </div>  

        <div class="form-row netgearDDNS netgearAccountYes NetgearAccount_notInRunning">
            <span mlang="PCVP_003">Forget your password?</span>
            <span>&nbsp;</span>
            <a href="https://www.noip.com/forgotPw.php?oem=ntgr" target="_blank" id="link_pw" style="color: rgb(0,51,255);text-decoration:underline">
                <span mlang="ADDE17">click here</span>
            </a>
        </div>
        
        <div class="form-row netgearDDNS netgearAccountYes NetgearAccount_notInRunning">
            <span mlang="ADD017">To manage your DDNS account,</span>
            <span>&nbsp;</span>
            <a href="https://www.noip.com/login/?oem=ntgr" target="_blank" id="link_ac" style="color: rgb(0,51,255);text-decoration:underline">
                <span mlang="ADDE17">click here</span>
            </a>
        </div>
        
        <div class="space-divider">&nbsp;</div>
        
        <div class="form-row inputDDNS netgearDDNS netgearAccountNo">
            <td colspan="2" align="center">
                <button type="button" value="add" onClick="formSubmit($(this))" id="NRegister" name="NRegister" class="button-sty1" mlang="UBS105">Register</button>
            </td>
        </div>
        
        <div class="space-divider">&nbsp;</div>
        
        <!-- read only input value, it will not be included in post data -->
        <input type="hidden" name="ddnsStatus" disabled>
        <input type="hidden" name="runningProvider" disabled>

         <!-- value will be included in post data -->
         <input type="hidden" name="action">
    </form>
    <!-- ddns form end -->
    
    </div><!-- form-group end -->
    
    <div class="form-btn-row" id="form_btn_div">
        <button type="button" value="show status"  onClick="showResult()" name="show_status" id="show_status" class="button-common common_bt" mlang="ADD004">Show Status</button>
        <button type="button" value="cancel"  onClick="location.href='DNS_ddns.html';" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
        <button type="button" value="apply"  onClick="formSubmit($(this))" name="apply" id="apply" class="button-apply apply_bt" mlang="LUP004" >Apply</button>
    </div>

  <? genHelpSection()?>
</html>
