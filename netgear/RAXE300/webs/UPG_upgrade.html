<!DOCTYPE HTML>
<? include 'php/commonCfg.php';?>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">

  <title>NETGEAR Router <?= getModelNameStr()?></title>

  <link rel="stylesheet" type="text/css" href="css/table_noh.css">
  <link rel="stylesheet" type="text/css" href="css/scrollbar.css">
  <link rel="stylesheet" type="text/css" href="css/button.css">
  <link rel="stylesheet" type="text/css" href="css/form.css">
  <link rel="stylesheet" type="text/css" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" type="text/css" href="css/custom.css" >

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  
  <script language="javascript" type="text/javascript">
  CSRF_TOKEN = <?= genCsrfTokenFilePhp('tokenNumber')?>;

  var refreshTimer = null;
  var pgbarTimer = null;
  var pchar = "|"; // progress char
  var maxchars = 60;
  var delay_time = 2500;
  var charcount = 0;
  function post_fillout_init()
  {
      stopAnimation();
  }
  function fresh()
  {
      window.location.href="UPG_upgrade.html";
  }
  
  function startTimer()
  {
      pgbarTimer = setTimeout("showAnimation()", 50);
      refreshTimer = setTimeout("showDashBoard()", 180000);
  }
  
  function showAnimation()
  {
      updateProgress();
  }

  function showDashBoard()
  {
       window.top.location.reload();
  }

  function stopAnimation()
  {
      if(refreshTimer != null)
          clearTimeout(refreshTimer);

      $("#animation").css("display", "none");
      
      if(pgbarTimer != null)
          clearTimeout(pgbarTimer);

      $("#pgbar").css("display", "none");
  }

  function makeStr(strSize, fillChar)
  {
      var temp = "";
      for (i=0; i < strSize ; i ++)
      	  temp = temp + fillChar;
      return temp;
}

  function updateProgress()
  {
      if ( charcount == 1 )
      {
            $(".uploadGroup").hide();
            $("#pgbar").css("display", "block");
            $("#animation").css("display", "block");
      }

      if (charcount < maxchars)
      {
          charcount ++;
          $("input[name='progress']").val(makeStr(charcount,pchar));
          pgbarTimer = setTimeout("updateProgress()",delay_time);
      }
  }

  function validation()
  {
      //var up_msg = "Continue?\nAll existing Internet connections will be terminated.\n";
      var up_msg = window.top.mlang["MRU070"] + "\n";
      var a;
      var t_str; 
      var uploadFile;
      var uploadFileById,file;
      
      file = $("#router_upload").prop("files")[0];
      t_str=$("#router_upload").val();       

      a = t_str.split(".");
      if(t_str.length == 0)
      {
          //alert("The file name is null. Locate and select the upgrade file from your hard disk, please.\n");
          alert(window.top.mlang["MRUE01"]);
          return false;
      }
     
      if((a.length<2)||(a[0]=="")||(a[a.length-1].toLowerCase()!="img"))
      {
          //alert("Please assign the correct file. The file format is *.w\n");
          alert(window.top.mlang["MRUE19"] + "img");
          return false;
      }

      //set max. image size to 90MB
      if( file.size > 94371840)
      {
          //File size is too big.
          alert(window.top.mlang["genie_349"]);
          return false;	
      }

      if (!confirm(up_msg))
      {
          return false;
      }
      startTimer();
      return true;
  }

  function toggleButtonHelp()
  {
      $("#form_btn_div").hide();
      $(".help-section").hide();
  }

  function uploadFw() 
  {   
      $("#browse").prop("disabled", true);
      $("#Upload").prop("disabled", true);
      $("#cancel").prop("disabled", true);
      if (validation())
      {
          toggleButtonHelp();
          var formData = new FormData();
          formData.append("mtenFWUpload",$("#router_upload").prop("files")[0]);
          $.ajax({
            url : "/cgi-bin/rex_cgi?function=uploadFW",
            type : "POST",
            cache : false,
            dataType : "json",
            processData: false,
            contentType: false,
            data : formData,
            success : function(data) {
              if(data.status == "error")
              {   
                  uploadCheckResult();
              }
            },
            error : function(xhr, ajaxOptions, thrownError) {
              console.log(xhr.status);
              console.log(thrownError);
            },
            complete : function(json) {
            }
          }); //ajax()
      }
      else
      {
          $("#browse").prop("disabled", false);
          $("#Upload").prop("disabled", false);
          $("#cancel").prop("disabled", false);
      }
  }
  
  function forceUpgradeCallback()
  {
      return;
  }
  
  function forceUpgrade()
  {
      if($("input[name='check_status']").val() == "1")
      {
          stopAnimation();
          $(".uploadGroup").hide();
          $(".downGradeGroup").show();
          //JYang, Only check the NTGR FW version field.
          //We will use "V1.0.5.70" to compare the FW version not "V1.0.5.70_1"
          var curVer = $("span[name='currentVer']").text();
          var upVer = $("span[name='uploadVer']").text();
          var curVerSplit = curVer.split("_");
          var upVerSplit = upVer.split("_");
          if(curVerSplit[0] == upVerSplit[0])
          {
              $("#fwCompareResult1").show();  
          }
          else
          {
              var msgStr = window.top.mlang["MRU042"] +
                upVerSplit[0].substring(1,upVerSplit[0].length) +
                window.top.mlang["MRU043"] +
                curVerSplit[0].substring(1,curVerSplit[0].length) +
                window.top.mlang["MRU044"];

              if(confirm(msgStr))
                $("#fwCompareResult2").hide();
              else
                window.location.reload();
                
          }
          $("button[name='no']").on("click", function(){
               $("input[name='isForce']").prop("disabled",false);
               $("input[name='isForce']").val("false");
               $.postForm('forceFWUpdate', $('#target'), 'cgi-bin/rex_cgi', 'location.reload');
          });

          $("button[name='yes']").on("click", function(){
               $("input[name='isForce']").prop("disabled",false);
               //$(".downGradeGroup").hide();
               $("#pgbar").css("display", "block");
               $("#animation").css("display", "block");
               startTimer();
               $.postForm('forceFWUpdate', $('#target'), 'cgi-bin/rex_cgi', 'forceUpgradeCallback');
          });
      }
      else
      {
          console.log("Upload failed!");
          window.top.backUrl = "UPG_upgrade.html";
          window.top.errorStr = "MRUE20";
          location.href ="ErrorMessage.html";
      }
  }
  
  function uploadCheckResult()
  {
      fetchData('target', 'fwUploadResult', '', 'forceUpgrade');  
  }
  
  function formSubmit(btn)
  {
      $.postForm('fwUpdate', $('#target'), 'cgi-bin/rex_cgi');
  }
  </script>

</head>
<? bodyBegin('upgrade', 'UPG_upgrade', 'D-genie_311', 'Router Update', '', 'post_fillout_init') ?>
  <div id="main" class="form-group">

    <div class="uploadGroup">
    <div class="form-row">
      <a href="javascript:loadhelp('UPG_upgrade','check')" tabindex="-1"><b mlang="MRU027">Check for new version from the Internet.</b></a>
    </div>
    <div class="form-row">
      <button type="button" name="Check" id="check" value="Check" class="button-sty1" onClick="window.location.href='FW_check.html'" mlang="MRU006">Check</button>
    </div>
  
    <div class="form-row">
      <a href="javascript:loadhelp('UPG_upgrade','locate')" tabindex="-1"><b mlang="MRU028">Locate and select the upgrade file on your hard disk.</b></a>
    </div>
    <div class="form-row">
      <input class="input1" type="file" name="mtenFWUpload" id="router_upload" size="23" maxlength="1024" style="position:relative;opacity:0;filter:alpha(opacity=0);font-size:15px;width:310px;padding-top:4px" onchange="this.form.upfile.value=this.value.substr(this.value.lastIndexOf('\\')+1);" contentEditable=false onkeydown="return false;" onbeforeeditfocus="return false;" onpaste="return false;">
      <div style="margin-top: -56px">
        <input class="input1" type="text" name="upfile" size="20" class="custom_file_input" maxlength="1024" readonly>
        <button type="button" value="browse" id="browse" class="button-sty1" onclick="this.form.router_upload.click();" onmouseover="this.style.cursor='default';" mlang="UAS017">Browse</button>
      </div>
    </div>
    <div class="form-row">
      <button type="reset" name="Cancel" id="cancel" value="Cancel" class="button-sty1" onClick="stopAnimation();" mlang="UAS021">Cancel</button> 
      <button type="button" name="Upgrade" id="Upload" value="Upload" class="button-sty1" onClick="uploadFw();" mlang="MRU032">Upload</button>
    </div>
    </div>

    <div class="downGradeGroup" style="display: none;">
      <div class="form-row" id="fwCompareResult1" style="display: none;">
        <b mlang="MRU068">Warning! The firmware you are trying to upload is the same as the one you had.</b>
      </div>
      <div class="form-row" id="fwCompareResult2" style="display: none;">
        <b mlang="MRU069">Warning! The firmware version you are trying to upload is older than the one you had.</b>
      </div>
      <div class="form-row" style="display: none;">
        <b mlang="genie_648">Do you want to continue?</b>
      </div>
      <div class="form-row pb-10">
        <span mlang="MRU007">Current Firmware Version</span><span>:</span>
      </div>
      <div class="form-row pb-10">
        <span name="currentVer" id="cur_firm"></span>
      </div>
      <div class="form-row pb-10">
        <span mlang="MRU034">Uploaded Version</span><span>:</span>
      </div>
      <div class="form-row pb-10">
        <span name="uploadVer" id="new_firm"></span>
      </div>
      <div class="space-divider">&nbsp;</div>
      <div class="form-row">
      </div>
      <div class="form-row">
        <button type="button" value="No" name="no" id="no" class="button-cancel cancel_bt" mlang="SWP009">No</button>
        <button type="button" value="Yes" name="yes" id="yes" class="button-apply apply_bt" mlang="SWP003">yes</button>
      </div>
      <input type="hidden" value="" name="check_status" disabled>
      <input type="hidden" value="true" name="isForce" disabled>
    </div>

    <div align="left" id="pgbar" style="display:none;position:relative;top:0;left:0;">
    <div class="form-row" >
      <BIG mlang="genie_950">Note: The update process takes about two minutes. Do not turn off the power or press the Reset button during the update.</BIG>
    </div>
  
    <div class="form-row" >
        <input type="text" name="progress" id="pls_wait_div" class="prgbar" value="" style="color: black" size="60"
      contentEditable=false onkeydown="return false;" onbeforeeditfocus="return false;" onpaste="return false;"/>
    </div>
  
    <div class="form-row" align="center" id="animation" style="display:none;position:relative;top:0;left:0">
      <img src="images/upload_new.gif" width="290" height="82" alt="" border="0">
    </div>
    </div><!--div pgbar-->

    <div class="uploadGroup">
    <div class="form-row">
      <b mlang="Analytics_008">Router Auto Firmware Update</b>
    </div>
    <div class="form-row pb-10">
      <span mlang="Analytics_002">Enable router to automatically update to future firmware. This keeps your router up to date with the latest features and security fixes.</span>
    </div>
    <div class="form-row pb-10">
      <b style="font-size:16px;"mlang="Analytics_011">Select one of the following options:</b>
    </div>
    <div class="form-row">
      <label class="checkbox-container">
        <input type="radio" name="autoUpdate" id="auto_agree" value="true" onclick="" ><font color="gray" mlang="SBS026">Enable</font>
        <span class="radio-checkmark"></span>
      </label>
    </div>
    <div class="form-row">
      <label class="checkbox-container">
        <input type="radio" name="autoUpdate" id="auto_disagree" value="false"  onclick="" ><font color="gray" mlang="UAS010">Disable</font>
        <span class="radio-checkmark"></span>
      </label>
    </div>
  </div>
    
  </div>
  <? bodyEnd(0, 'UPG_upgrade.html') ?>    
</html>
