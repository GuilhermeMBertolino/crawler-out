<!DOCTYPE HTML>
<? include 'php/commonCfg.php';?>
<html>
<head>
  <META charset="UTF-8">
  <META http-equiv="Pragma" content="no-cache">
  <META HTTP-equiv="Cache-Control" content="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="Mon, 06 Jan 1990 00:00:01 GMT">
  
  <title>NETGEAR Router <?= getModelNameStr()?></title>

  <link rel="stylesheet" href="css/scrollbar.css">
  <link rel="stylesheet" href="css/button.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="css/settings.css<? getVer(); ?>">
  <link rel="stylesheet" href="css/custom.css"  type="text/css">

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.jscrollpane.min.js"></script>
  <script src="js/jquery.mousewheel.js"></script>
  <script src="js/utils.js<? getVer(); ?>"></script>
  <script language="javascript" type="text/javascript">
  CSRF_TOKEN = <?= genCsrfTokenFilePhp('tokenNumber')?>;
  var pchar = "|"; // progress char
  var maxchars = 61; 
  var delay_time = 200; // msecs
  var charcount = 0;
  var t;
  var wps_time_count = 2;

  function check_pin()
  {
      var lpin = $("input[name='clientPin']").val();
      var accum = 0;
      var tmplpin;

      if (lpin.length == 9)
      {
          if (lpin.charAt(4) == '-')
          {
              //WPS v2.0 Format: (nnnn-nnnn)
              tmplpin = lpin.split('-');
              lpin = tmplpin[0] + tmplpin[1];
              $("input[name='clientPin']").val(lpin);
          }
          else if (lpin.charAt(4) == ' ')
          {
              //WPS v2.0 Format: (nnnn nnnn)
              tmplpin = lpin.split(' ');
              lpin = tmplpin[0] + tmplpin[1];
              $("input[name='clientPin']").val(lpin);
          }
          else
          {
              alert(window.top.mlang["AWCE01"]);
              return false;
          }
      }
      else if (lpin.length != 4 && lpin.length != 8)
      {
          alert(window.top.mlang["AWCE01"]);
          return false;
      }

      if (parseInt(lpin, 10) != lpin) {
          alert(window.top.mlang["AWCE01"]);
          return false;
      }

      if (lpin.length == 8) {
          lpin = parseFloat($("input[name='clientPin']").val());
          accum += 3 * (parseInt(lpin / 10000000) % 10);
          accum += 1 * (parseInt(lpin / 1000000) % 10);
          accum += 3 * (parseInt(lpin / 100000) % 10);
          accum += 1 * (parseInt(lpin / 10000) % 10);
          accum += 3 * (parseInt(lpin / 1000) % 10);
          accum += 1 * (parseInt(lpin / 100) % 10);
          accum += 3 * (parseInt(lpin / 10) % 10);
          accum += 1 * (parseInt(lpin / 1) % 10);

          if (0 != (accum % 10)) {
              alert(window.top.mlang["AWCE02"]);
              return false;
          }
      }
      return true;
  }

  $(document).ready(function() {
      $("[name='next']").on("click", function(e){
          fetchData('target', 'wps', '', 'detectIsInProcess');
      });

      updateWpsMethod();
      $('[name=method]').on('change', function() {
          updateWpsMethod();
      });

      $("#wps_button").on("click", function(e){
          togglePage("wpsSelect-page", "wpsInProcess-page");
          startWPS();
      });

      $("#wps_next").on("click", function(e){
          if(check_pin())
          {
             togglePage("wpsSelect-page", "wpsInProcess-page");
             startWPS();
          }
      });

      $("#cancel").on("click", function(e){
          wpsCancel();
          togglePage("wpsInProcess-page", "wpsFail-page");
      });
      
      $("[name='OK']").on("click", function(e){
          wpsCancel();
          window.location.href = "Add_WPS_Client.html";
      });
  });

  function updateWpsMethod()
  {
      var method = $('[name=method]:checked').val();
      if (method == "PBC")
      {
        wps_time_count = 2; // 2 minutes
        $('.wps_pbc_section').css("display", "");
        $('.wps_pin_section').css("display", "none");
      }
      else
      {
        wps_time_count = 4; // 4 minutes
        $('.wps_pin_section').css("display", "");
        $('.wps_pbc_section').css("display", "none");
      }
  }
  function detectIsInProcess()
  {
      if($("input[name='wpsStatus']").val() == "1")
      {
          togglePage("first-page", "wpsInProcess-page");
          updateProgress();
      }
      else
          togglePage("first-page", "wpsSelect-page");  
  }

  function makeStr(strsize, fillchar)
  {
    var temp = "";
    for (i=0; i < strsize ; i ++)
    temp = temp + fillchar;
    return temp;
  }

  function updateProgress()
  {
      charcount ++;
      $("[name=progress]").val(makeStr(charcount/(5*wps_time_count),pchar));
      
      $("[name='wps_icon']").attr("src",(charcount % 2 == 0) ? "images/wps_icon_on.bmp" : "images/wps_icon_off.bmp");
      
      t = setTimeout("updateProgress()",delay_time);
      
      if (charcount % 10 == 0)
      {
        updateWpsStatus();
      }
  }

  function updateWpsStatus()
  {
      fetchData('target', 'wps', '', 'checkWpsStatus');
  }

  function success_cb()
  {
  }

  function checkWpsStatus()
  {
      var state = $("input[name='wpsStatus']").val();
      //console.log("WPS state:"+state);
      if(state == "1")
      {
          return;
      }
      
      clearTimeout(t);
      if(state == "2")
      {
          $("input[name='action']").val("cancel");
          $.postForm('wpsClient', $('#target'), 'cgi-bin/rex_cgi', 'success_cb');
          togglePage("wpsInProcess-page", "wpsSuccess-page");
      }
      else if(state == "4")
      {
          togglePage("wpsInProcess-page", "wpsFail-page");
          $("#timeoutDiv").show();
      }
      else if(state == "8")
      {
          togglePage("wpsInProcess-page", "wpsFail-page");
          $("#overlayDiv").show();
      }
      else
      {
          togglePage("wpsInProcess-page", "wpsFail-page");
          $("#errorDiv").show();
      }
      
  }

  function togglePage(cur, nex)
  {
      $("#"+cur).hide();
      $("#"+nex).show();
  }
  

  function startWPS()
  {
      $("input[name='action']").val("start");
      $.postForm('wpsClient', $('#target'), 'cgi-bin/rex_cgi', 'updateProgress');
  }

  function wpsCancel()
  {
      $("input[name='action']").val("cancel");
      clearTimeout(t);
      $("#cancelDiv").show();
      $.postForm('wpsClient', $('#target'), 'cgi-bin/rex_cgi');
  }
  </script>
</head>

<body onload="window.top.change_size($(this));loadhelp('WPS','');window.top.mlangInit($('#target'));" class="page-body" onResize="window.top.change_size($(this));">
  <form id="target" name="formname" method="POST" >
    <div class="page-group" id="first-page">
      <div class="page-header" style="position: relative;" mlang="LUP006">Add WPS Client</div>
      <div class="form-group" style="overflow:auto;scrolling:auto">
        <div class="form-row" style="font-size: 16px;">
          <b mlang="AWC001">New and easy way to connect to the wireless router using Wi-Fi Protected Setup (WPS)</b>
        </div>
        <div class="form-row" style="padding: 0px;">
          <p mlang="AWC002">A wireless client has to support the WPS function if you want to use this wizard to add the client to your WPS-enabled wireless router.</p>
        </div>
        <div class="form-row" style="padding: 0px;">
          <p mlang="AWC003">Please check the user manual and gift box of your wireless client to see whether it supports the WPS function.</p>
        </div>
        <div class="form-row" style="padding: 0px;">
          <p mlang="AWC004">If your wireless client does not support the WPS function, you have to configure your wireless client manually so that it has the same SSID and wireless security settings as this router.</p>
        </div>
        <div class="divider">&nbsp;</div>
  
        <div class="form-row " id="form_btn_div">
          <button type="Button" value="Next" name="next" id="next" class="button-apply apply_bt mt-20" mlang="OTH011">Next</button>
        </div>
      </div><!--form-group-->
    </div><!--page-group first-page-->

    <div class="page-group" id="wpsSelect-page" style="display: none;">
      <div class="page-header" style="position: relative;" mlang="LUP006">Add WPS Client</div>
      <div class="form-group" style="overflow:auto;scrolling:auto">
        <div class="form-row">
          <b mlang="AWC020">Select a setup method</b><b>:</b>
        </div>
        <div class="form-row">
          <label class="checkbox-container">
            <input type="radio" name="method" id="wps_type" value="PBC" checked>
            <span mlang="AWC025">Push Button (recommended)</span>
            <span class="radio-checkmark"></span>
          </label>
        </div>
        <div class="wps_pbc_section">
            <div class="form-row">
              <b mlang="AWC026">You can either press the physical push button on the router or click the button (soft push button) in this screen.</b>
            </div>
            <div class="form-row" style="padding-top: 15px;">
              <input type="button" name="wps_button" id="wps_button" style="background-image:url(images/wps_icon_on.bmp);width:28px; height:28px">
            </div>
        </div>
        <div class="form-row">
          <label class="checkbox-container">
            <input type="radio" name="method" id="pin_num" value="PIN">
            <span mlang="AWC023">PIN Number</span>
            <span class="radio-checkmark"></span>
          </label>
        </div>
        <div class="wps_pin_section">
            <div class="form-row">
              <b mlang="AWC024">This is the security PIN of the WPS client. While connecting, WPS-enabled adapters provide a randomly-generated security PIN.</b>
            </div>
            <div class="form-row">
              <b mlang="AWC018">Enter Client's PIN:</b></td>
            </div>
            <input class="input1" type="TEXT" name="clientPin" id="wps_pin" size="8" maxlength="9" value="" align="left">
            <div class="form-row " id="form_btn_div">
              <button type="Button" value="wps_next" name="wps_next" id="wps_next" class="button-apply apply_bt mt-20" mlang="OTH011">Next</button>
            </div>
        </div>
        <div class="divider">&nbsp;</div>
      </div><!--form-group-->
    </div><!--page-group wpsSelect-page-->
    
    <div class="page-group" id="wpsInProcess-page" style="display: none;">
      <div class="page-header" style="position: relative;" mlang="AWC017">Connecting to New Wireless Client</div>
      <div class="form-group" style="overflow:auto;scrolling:auto">
        <div class="form-row" align="center" style="padding-top: 15px;">
          <button type="button" value="Cancel" name="Cancel" id="cancel" class="button-cancel cancel_bt" mlang="UAS021">Cancel</button>
        </div>
        <div class="divider">&nbsp;</div>
        <div class="form-row">
          <b mlang="AWC028">Please click the software or hardware button on the client to start the WPS process...</b>
        </div>
        <div class="form-row" style="padding-top: 15px; display: flex; margin: auto; width:50%;">
          <img name="wps_icon" src="images/wps_icon_on.bmp" />&nbsp;&nbsp;&nbsp;
          <input type="text" name="progress" id="pls_wait_div" class="prgbar" value="" style="color: blue;pointer-events: none;" size="60">
        </div>
      </div><!--form-group-->
    </div><!--page-group wpsInProcess-page-->
    
    <div class="page-group" id="wpsFail-page" style="display: none;">
      <div class="page-header" style="position: relative;" mlang="AWC005">Failure</div>
      <div class="form-group" style="overflow:auto;scrolling:auto">
        <div id="timeoutDiv" style="display:none;">
          <div class="form-row" >
            <b mlang="AWC009">WPS procedure has timed out.</b>
          </div>
          <div class="form-row">
             <b mlang="AWC010">Failed to add a wireless client to the network in </b><b>2</b><b mlang="AWC006"> minutes.</b> 
          </div>
        </div>
        <div id="errorDiv" style="display:none;">
          <div class="form-row" >
            <b mlang="AWC009">WPS procedure has timed out.</b>
          </div>
          <div class="form-row">
             <b mlang="AWC019">Failed to add a wireless client to the network.</b>
          </div>
        </div>
        <div id="cancelDiv" style="display:none;">
          <div class="form-row" >
            <b mlang="AWC011">WPS procedure has been canceled by user.</b>
          </div>
          <div class="form-row">
            <b mlang="AWC019">Failed to add a wireless client to the network.</b>
          </div>
        </div>
        <div id="overlayDiv" style="display:none;">
          <div class="form-row" >
            <b mlang="AWC027">Security Risk: detecting more than one client with push button pressed.</b>
          </div>
          <div class="form-row">
            <b mlang="AWC019">Failed to add a wireless client to the network.</b>
          </div>
        </div>
        <div class="divider">&nbsp;</div>
        <div class="form-row">
          <b mlang="AWC008">Click <b>OK</b> to go back to the Wi-Fi Protected Setup screen.</b><b>... </b>
        </div>
        <div class="form-row" align="center" style="padding-top: 15px;">
          <button TYPE="BUTTON" value="OK" name="OK" id="ok" class="button-sty1"  mlang="UAS020">OK</button>
        </div>
      </div><!--form-group-->
    </div><!--page-group wpsFail-page-->
    
    <div class="page-group" id="wpsSuccess-page" style="display: none;">
      <div class="page-header" style="position: relative;" mlang="AWC007">Success</div>
      <div class="form-group" style="overflow:auto;scrolling:auto">
        <div class="form-row" align="center">
          <b mlang="AWC013">The wireless client</b><b> </b><b mlang="AWC015">has been added to the network successfully.</b>
        </div>
        <div class="divider">&nbsp;</div>
        <div class="form-row" align="center">
          <b mlang="AWC008">Click <b>OK</b> to go back to the Wi-Fi Protected Setup screen.</b><b>... </b>
        </div>
        <div class="form-row" align="center" style="padding-top: 15px;">
          <button TYPE="BUTTON" value="OK" name="OK" id="ok2" class="button-sty1"  mlang="UAS020">OK</button>
        </div>
      </div><!--form-group-->
    </div><!--page-group wpsSuccess-page-->
  <input type="hidden" name="action" value=""/>
  <input type="hidden" name="wpsStatus" value="" disabled/>
</form>
<? genHelpSection() ?>
</html>
