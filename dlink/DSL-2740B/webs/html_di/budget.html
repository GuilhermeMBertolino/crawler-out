<!--
Copyright (C) 2010, Ayecom Wuhan Corporation
All Rights Reserved.

THIS SOFTWARE IS OFFERED "AS IS", AND BROADCOM GRANTS NO WARRANTIES OF ANY
KIND, EXPRESS OR IMPLIED, BY STATUTE, COMMUNICATION OR OTHERWISE. BROADCOM
SPECIFICALLY DISCLAIMS ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A SPECIFIC PURPOSE OR NONINFRINGEMENT CONCERNING THIS SOFTWARE.

$Id: budget.html, v 1.0 2010/08/20 10:35:30 Exp, by Linus Shi $
-->

<HTML><HEAD><TITLE>D-Link ADSL Router</TITLE>
<META http-equiv=Content-Type content="text/html; charset=utf-8">
<META http-equiv=Pragma content=no-cache><LINK href="stylemain.css" 
type=text/css rel=stylesheet>
<SCRIPT language=javascript src="util.js"></SCRIPT>
<SCRIPT language=JavaScript src="menu.js"></SCRIPT>
<SCRIPT language=javascript>
<!-- hide

var tclist = '<%ejGet(tcCfgView)%>';
var entry = tclist.split(':');
var rule = new tccfg(entry[0], entry[1], entry[2], entry[3], entry[4], entry[5], entry[6], entry[7], entry[8]);

var time_out = '<%ejGet(timeout)%>';
if (time_out != '0') 
{
    setTimeout('parent.location.href="/login.html";', time_out * 60000);
}

var ntp_enabled = '<%ejGet(ntp_enabled)%>';

var response_info;
var budget_info = new Array();
var request = false;
try {
    request = new XMLHttpRequest();
} 
catch (trymicrosoft) 
{
    try {
        request = new ActiveXObject("Msxml2.XMLHTTP");
  } catch (othermicrosoft) {
    try {
        request = new ActiveXObject("Microsoft.XMLHTTP");
    } catch (failed) {
        request = false;
    }  
  }
}

if (!request)
{
    alert("Error initializing XMLHttpRequest!");
}

function getTrafficInfo() 
{
    var url = "gettrafficinfo.cgi?";
    request.open("GET", url, true);
    request.onreadystatechange = updatePage;
    request.send(null);
}

function updatePage() 
{
    if (request.readyState == 4) {
        if (request.status == 200) {
            response_info = request.responseText;
            budget_info = response_info.split(':');
            var detial = new tccfg(budget_info[0], budget_info[1], budget_info[2], budget_info[3], budget_info[4], budget_info[5], budget_info[6], budget_info[7], budget_info[8]);
            if ((detial.dlenbl == 1) && (detial.recvcount > ((detial.downlmt)*1024)))
            {
                alert('Traffic exceeded the download quota! Please push the Reset button to reset the settings.');
            }
            if ((detial.ulenbl == 1) && (detial.transcount > ((detial.uplmt)*1024)))
            {
                alert('Traffic exceeded the upload quota! Please push the Reset button to reset the settings.');
            }
        }
    }
}


function tccfg(intf, enbl, tmlmt, dlenbl, ulenbl, downlmt, uplmt, recvcount, transcount)
{
	this.intf = intf;
	this.enbl = enbl;
	this.tmlmt = tmlmt;
	this.dlenbl = dlenbl;
	this.ulenbl = ulenbl;
	this.downlmt = downlmt;
	this.uplmt = uplmt;
	this.recvcount = recvcount;
	this.transcount = transcount;
}

var sintf = rule.intf;
var srecvcount = rule.recvcount;
var stranscount = rule.transcount;

function enbllqClick()
{
    with ( document.forms[0] ) 
    {
        if(enbllq.checked != true)
        {
            interface.disabled = true;
            lmttime.disabled = true;
			enbldq.disabled = true;
			enbluq.disabled = true;
			downlimit.disabled = true;
			uplimit.disabled = true;			

            enbllq.value = 0;
        }
		else
	    {
            interface.disabled = false;
            lmttime.disabled = false;
			enbldq.disabled = false;
			enbluq.disabled = false;
			downlimit.disabled = false;
			uplimit.disabled = false;
			
            enbllq.value = 1;
		}

		enbldqClick();
		enbluqClick();
    }
}

function intfChange()
{
    /* None */
}

function enbldqClick()
{
    with ( document.forms[0] ) 
    {
        if(enbldq.checked != true)
        {
			downlimit.disabled = true;
            enbldq.value = 0;
        }
		else
	    {
	        downlimit.disabled = false;
            enbldq.value = 1;
		}
    }
}

function enbluqClick()
{
    with ( document.forms[0] ) 
    {
        if(enbluq.checked != true)
        {
			uplimit.disabled = true;
            enbluq.value = 0;
        }
		else
	    {
	        uplimit.disabled = false;
            enbluq.value = 1;
		}
    }
}

/*function showTiClick()
{
    with ( document.forms[0] ) 
    {
        document.getElementById("tcInfoDisplay").style.display = 'block';
        showTcInfo.disabled = 1;
        applyTc.disabled = 1;
		resetTc.disabled = 1;
	}
}*/

function refreshInfo()
{
    with ( document.forms[0] ) 
    {
        location.href = "budget.html";
    }
}

function cancelInfo()
{
    with ( document.forms[0] ) 
    {
        document.getElementById("tcInfoDisplay").style.display = 'none';
        /*showTcInfo.disabled = 0;
        applyTc.disabled = 0;
		resetTc.disabled = 0;*/
    }
}

function quotaCheck()
{
    with ( document.forms[0] ) 
    {
        if (rule.enbl != 1)
        {
            alert('Limitation Quota is disabled, or the settings were reset due to timeout.');
		}
		else
		{
            if ((rule.dlenbl == 1) && (rule.recvcount > ((rule.downlmt)*1024)))
            {
                alert('Traffic exceeded the download quota! Please push the Reset button to reset the settings.');
			}

            if ((rule.ulenbl == 1) && (rule.transcount > ((rule.uplmt)*1024)))
            {
                alert('Traffic exceeded the upload quota! Please push the Reset button to reset the settings.');
			}
		}
	}
}

function frmLoad()
{	
    with ( document.forms[0] )
    {	
        enbllq.value = rule.enbl;
        enbldq.value = rule.dlenbl;
        enbluq.value = rule.ulenbl;

        if (enbllq.value == 1)
        {
            enbllq.checked = true;
            interface.value = rule.intf;
            lmttime.value = rule.tmlmt;
        }
        else
        {
            enbllq.checked = false;
            interface.value = '';
            lmttime.value = '';
        }

        if (enbldq.value == 1)
        {
            enbldq.checked = true;
            downlimit.value = rule.downlmt;
        }
        else
        {
            enbldq.checked = false;
            downlimit.value = '';
        }

        if (enbluq.value == 1)
        {
            enbluq.checked = true;
            uplimit.value = rule.uplmt;
        }
        else
        {
            enbluq.checked = false;
            uplimit.value = '';
        }        		

        enbllqClick();
        quotaCheck();
        if(rule.enbl == 1)
        {
            setInterval("getTrafficInfo()", 40000);
        }
    }
}

function btnreset()
{
    var loc = 'budget.cmd?action=reset';

    var code = 'location="' + loc + '"';
    eval(code);
}

function btnApply()
{
    var loc = 'budget.cmd?action=savapply';

    with ( document.forms[0] )
    {
        if (enbllq.checked && isnum(lmttime.value) == false)
        {
            alert('Limit time is invalid and should be a number!');
            return;
        }

        if (enbllq.checked && (lmttime.value < 1 || lmttime.value > 366))
        {
            alert('Limit time should be in the region: [1, 366].');
            return;
        }

        if (enbldq.checked && isnum(downlimit.value) == false)
        {
            alert('Download quota is invalid and should be a number!');
            return;
        }

        if (enbldq.checked && (downlimit.value < 1 || downlimit.value > 2096128))
        {
            alert('Download quota should be in the region: [1, 2096128].');
            return;
        }		

        if (enbluq.checked && isnum(uplimit.value) == false)
        {
            alert('Upload quota is invalid and should be a number!');
			return;
        }

        if (enbluq.checked && (uplimit.value < 1 || uplimit.value > 2096128))
        {
            alert('Upload quota should be in the region: [1, 2096128].');
            return;
        }
		
        if (enbllq.checked)
        {	
            loc += '&enbllq=1';
            loc += '&interface=' + interface.value;
            loc += '&lmttime=' + lmttime.value;

            if (enbldq.checked)
            {	
                enbldq.value = 1;
                loc += '&downlimit=' + downlimit.value;
            }
            else
	        {
                enbldq.value = 0;
                loc += '&downlimit=0';
            }
            loc += '&enbldq=' + enbldq.value;

            if (enbluq.checked)
            {	
                enbluq.value = 1;
                loc += '&uplimit=' + uplimit.value;
            }
            else
            {
                enbluq.value = 0;
                loc += '&uplimit=0';
            }
            loc += '&enbluq=' + enbluq.value;			
        }
        else
	    {
            loc += '&enbllq=0';
        }
    }
	
    var code = 'location="' + loc + '"';
    eval(code);

}


// done hiding -->
</SCRIPT>

</HEAD>
<BODY onLoad='frmLoad()'>
<BLOCKQUOTE>
  <SCRIPT language=JavaScript>
TabHeader="Advanced";
SideItem="Budget Quota";
HelpItem="budget";
</SCRIPT>

  <SCRIPT type=text/javascript>
	mainTableStart();	
	logo();
	TopNav();
	ThirdRowStart();
	Write_Item_Images();
	mainBodyStart();
</SCRIPT>

  <FORM>
  <TABLE id=box_header cellSpacing=0 width=690 border=0>
    <TBODY>
    <TR>
      <TD class=topheader>Budget Quota </TD></TR>
    <TR>
      <TD class=content>
        <P>Budget Quota can be used to implement the limitation quota and other functions. </P></TD></TR></TBODY></TABLE>
  <TABLE id=body_header cellSpacing=0 width=690 border=0>
    <TBODY>
    <TR>
      <TD class=topheader>Limitation Quota Settings </TD></TR>
    <TR>
      <TD class=content>
        <TABLE class=formarea align=center>
          <TBODY>
          <TR>
            <TD align=center><b>Enable limitation quota &nbsp;:</TD>
            <TD><INPUT type=checkbox id=enbllq onClick=enbllqClick()> </TD>
            </TR> 
          <TR>
          <TD align=center><b>Select interface &nbsp;:</TD>
			<TD><select name='interface' size="1" onchange="intfChange()" class="changefont">
		  	<!--option value="br0">br0</option-->
		  	<option value="eth0">Lan1</option>
		  	<option value="eth1">Lan2</option>
		  	<option value="eth2">Lan3</option>
		  	<option value="eth3">Lan4</option>
  	        <script language="javascript">
            <!-- hide
            {
                var i = 0;
                var interfaceInfo = '<%ejGetOther(wanInterfaceInfo, route)%>';
                var interfaces = interfaceInfo.split('|');

                if(interfaceInfo != '')
                {
                    for ( i = 0; i < interfaces.length; i++ )
                    {
    					var names = interfaces[i].split('/');

                        if((names[1].indexOf("atm") != -1) || (names[1].indexOf("ppp") != -1) )
                        {
                            document.write("  <option value='" + names[1] + "'>");
                            document.writeln(names[1]);
                        }
                    }
                }
            }
            // done hiding 
            -->
            
            </script>
		  	</select>
		    </TD>
		    </TR>
          <TR>
            <TD align=center><b>Limit time(days) &nbsp;:</TD>
            <TD><INPUT type=text size=5 id=lmttime> </TD>
            </TR>
          <TR>
            <TD align=center><b>Start router time &nbsp;:</TD>
            <TD><SCRIPT language=javascript>
                        var bgntime = '<%ejGetOther(sysInfo, beginTime)%>';
			            if(ntp_enabled == '0')
			            {
                            document.write("<FONT color=red>NTP time server is disabled!</FONT>");
						}
						else
					    {
                            document.write(bgntime);
						}
                        </SCRIPT></TD>
            </TR> 
          <TR>
            <TD align=center><b>Enable download quota &nbsp;:</TD>
            <TD><INPUT type=checkbox id=enbldq onClick=enbldqClick()> </TD>
            </TR> 
          <TR>
            <TD align=center><b>Download quota(Max, MB) &nbsp;:</TD>
            <TD><INPUT type=text size=5 id=downlimit> </TD>
            </TR>
          <TR>
            <TD align=center><b>Enable upload quota &nbsp;:</TD>
            <TD><INPUT type=checkbox id=enbluq onClick=enbluqClick()> </TD>
            </TR> 
          <TR>
            <TD align=center><b>Upload quota(Max, MB) &nbsp;:</TD>
            <TD><INPUT type=text size=5 id=uplimit> </TD>
            </TR>			
            </TBODY></TABLE>            
            </TD></TR></TBODY></TABLE>
            
           <P align=center>
            <!--INPUT type=button id='showTcInfo' onClick='showTiClick()' value='Traffic Info' -->
            <INPUT type=button id='applyTc' onclick='btnApply()'  value="Save/Apply">
            <INPUT type=button id='resetTc' onclick='btnreset()'  value="Reset">
           </P>
           <SCRIPT language=javascript>
               if (rule.enbl == '1')
               {
                   document.write("<div id=tcInfoDisplay style='display:block;'>");
               }
			   else
               {
                   document.write("<div id=tcInfoDisplay style='display:none;'>");
               }			   
           </SCRIPT>
              <table id=body_header border="0" cellpadding="0" cellspacing="0">
		      <tr>
			    <td class=topheader>
				   Traffic Information
			    </td>										
		      </tr>               
		     <tr>
			  <td class=content>
              <table border="0" cellpadding="0" cellspacing="0">
               <tr>
                 <td><b>This information reflects the current traffic status of your specific interface&nbsp;:&nbsp;</b></td>              
                  <td>
                     <b><SCRIPT language=javascript>
                        document.write(sintf);
                        </SCRIPT></b>
                  </td>
               </tr>
              </table>   
              </br>
              <table class=formarea border="0" cellpadding="0" cellspacing="0">
                <tr>
                  <td class=form_label colspan=2>Received Traffic&nbsp;:</td>
                  <td>                     
                    <b><SCRIPT language=javascript>
						if(sintf.indexOf("eth") == -1)
					    {
                            document.write(srecvcount);
					    }
						else
						{
                            document.write(stranscount);
						}
                        document.write("  KBytes have been counted.");
                       </SCRIPT></b>
				  </td>
                </tr>
                <tr>
                  <td class=form_label colspan=2>Transmitted Traffic&nbsp;:</td>
                  <td>                     
                    <b><SCRIPT language=javascript>
						if(sintf.indexOf("eth") == -1)
					    {
                            document.write(stranscount);
					    }
						else
						{
                            document.write(srecvcount);
						}
                        document.write("  KBytes have been counted.");
                        </SCRIPT></b>
                  </td>
               </tr>
              </table>
              <P align=center>
               <INPUT onclick=refreshInfo() type=button value="Refresh">
               <INPUT onclick=cancelInfo() type=button value="Cancel">
              </P>
              <P><FONT color=red>Please take notice that you can click the "Refresh" button  
                  to refresh the Budget Quota page and display the new traffic information per 30 seconds.</FONT></P>
             </table>
            </div> 

  </FORM>        
  <SCRIPT type=text/javascript>
	mainBodyEnd();
	ThirdRowEnd();
	Footer()
	mainTableEnd()
</SCRIPT>
</BLOCKQUOTE></BODY></HTML>
