<html>
  <head>
    <meta HTTP-EQUIV='Pragma' CONTENT='no-cache'>
    <link rel="stylesheet" href='stylemain.css' type='text/css'>
            <script language="javascript" src="util.js"></script>
            <script language="javascript">
<!-- hide

var lanState = '<%ejGet(lanRefresh)%>';

if ( lanState == '1' ) {
   var code = 'location="lancfg2.cgi?lanRefresh=0"';
   eval(code);
}

var ethIp = '<%ejGet(ethIpAddress)%>';
var ethSubMask = '<%ejGet(ethSubnetMask)%>';
var dhcpStart = '<%ejGet(dhcpEthStart)%>';
var dhcpEnd = '<%ejGet(dhcpEthEnd)%>';
var dhcpLease = '<%ejGet(dhcpLeasedTime)%>';
var dhcpRelayServer = '<%ejGet(dhcpRelayServer)%>';
//var proto = 'PPPoE';
var ipExt = '0';
var dhcpEnbl = '<%ejGet(enblDhcpSrv)%>';
var macUsed = '<%ejGetOther(memInfo, pcMacAddr)%>';
var natEnbl = '1';
var dhcpres_edit = 0;
var dhcpres_edit_oldname = '';
var dhcpres_edit_oldmac = '';

var dhcpResMac = new Array();
var dhcpResIp = new Array();

var tmpethIpAddr;
var tmpethSubMask; 

var dchpBroadcast;
var dhcpUsablIp;
var clientList = '<%ejGetOther(staticiplease)%>';
//clientList = 'ERIC,192.168.10.103,00:E0:4C:7D:8F:CF|MARTIN,192.168.10.102,00:C0:4C:7D:8F:CF|';
var clientEntrys = new Array();
clientEntrys = clientList.split('|');
var dhcpLeasesNum = '<%ejGetOther(dhcpLeasesNum)%>';
var entryNum = clientEntrys.length-1;
var rule = new Array(entryNum);
for (i = 0; i < entryNum; i++){
	rule[i] = new rVe('', '', '','0');
}

for (i = 0; i < entryNum; i++){
	entry = clientEntrys[i].split(',');
	rule[i] = new rVe(entry[0], entry[1], entry[2]);
}

var savedClientList = '<%ejGetOther(staticiplease)%>';
//savedClientList =  'ERIC,192.168.10.103,00:E0:4C:7D:8F:CF,0|MARTIN,192.168.10.102,00:C0:4C:7D:8F:CF,1|';

var savedclientEntrys = new Array();
savedclientEntrys = savedClientList.split('|');
var savedentryNum = savedclientEntrys.length-1;
var rule1 = new Array(savedentryNum);
for (i = 0; i < savedentryNum; i++){
	rule1[i] = new rVe1('', '', '','0');
}

for (i = 0; i < savedentryNum; i++){
	savedentry = savedclientEntrys[i].split(',');
	rule1[i] = new rVe1(savedentry[0], savedentry[1], savedentry[2],savedentry[3]);
}

function rVe(name, ip, mac)
{
	this.name = name;
	this.ip = ip;
	this.mac = mac;
}

function rVe1(name, ip, mac, enable)
{
	this.name = name;
	this.ip = ip;
	this.mac = mac;
	this.enable = enable;
}


function enableDhcpSrv(formLoad) 
{
    with ( document.forms[0] ) 
    {
        dhcpEthStart.disabled = 0;
        dhcpEthEnd.disabled = 0;
        if (formLoad == 0)
        {
            setDhcpAddresses(ethIpAddress.value);
        }
		else 
	    {
            dhcpEthStart.value = dhcpStart;
            dhcpEthEnd.value = dhcpEnd;
        }
        dhcpLeasedTime.value = dhcpLease;
        dhcpLeasedTime.disabled = 0;
        dhcpReserveInfo.dsiabled = 0;
        //enableDhcpClient();
        disableDhcpSrvRelay();
    }
}

function disableDhcpSrv() {
   with ( document.forms[0] ) {
      dhcpEthStart.disabled = 1;
      dhcpEthEnd.disabled = 1;
      dhcpLeasedTime.value = '';
      dhcpLeasedTime.disabled = 1;
	  
      dhcpReserveInfo.dsiabled = 1;
      //btnCancel();
      //disableDhcpClient();	
   }
}

function dhcpRelay(cb)
{
    with ( document.forms[0] )
    {
        if(cb.checked == true)
        {
            enableDhcpSrvRelay();	
        }
        else
        {
            disableDhcpSrvRelay();
        }
    }
}

function disableDhcpSrvRelay() 
{
    with ( document.forms[0] ) 
    {
        DHCPR.checked = false;
        dhcpSrvAddr.value = "";
        dhcpSrvAddr.disabled = true;
    }
}

function enableDhcpSrvRelay() 
{
    with ( document.forms[0] ) 
    {
        DHCPR.checked = true;
        disableDhcpSrv();
        dhcpSrvType.checked = false;
        dhcpSrvAddr.disabled = false;
        dhcpSrvAddr.value = dhcpRelayServer;      
    }
}

function typeClick() {
   with ( document.forms[0] ) {
        if ( dhcpSrvType.checked == false )
            disableDhcpSrv();
         else
            enableDhcpSrv(0);

   }
}

function enableDhcpClient() {
   with ( document.forms[0] ) {
		removeDHCPRes.disabled = 0;
		addDHCPRes.disabled = 0;
		editDHCPRes.disabled = 0;
   }
}

function disableDhcpClient() {
   with ( document.forms[0] ) {
		removeDHCPRes.disabled = 1;
		addDHCPRes.disabled = 1;
		editDHCPRes.disabled = 1;
   }
}

function frmLoad(){
	with (document.forms[0]) {
		ethIpAddress.value= '<%ejGet(ethIpAddress)%>';
		ethSubnetMask.value= '<%ejGet(ethSubnetMask)%>';
		deviceName.value= '<%ejGet(deviceName)%>';
		if (dhcpEnbl == '1')
		{
			enableDhcpSrv(1);
			enableDhcpClient();
			dhcpSrvType.checked = true;
		} 
		else if (dhcpEnbl == '2')
		{
			disableDhcpSrv();
			dhcpSrvType.checked = false;
			enableDhcpSrvRelay();
		}
		else
		{
			disableDhcpSrv();
			disableDhcpClient();
			dhcpSrvType.checked = false;
			disableDhcpSrvRelay();
		}

         lan2IpAddress.value = '<%ejGet(lan2IpAddress)%>';
         lan2SubnetMask.value = '<%ejGet(lan2SubnetMask)%>';
         if ('<%ejGet(enblLan2)%>' == '1') {
            enblLan2.checked = true;
            hideLan2Info(0);
			document.getElementById('lan2IpAddress').disabled = 0;
			document.getElementById('lan2SubnetMask').disabled = 0;
         } else {
            enblLan2.checked = false;
            hideLan2Info(1);
			document.getElementById('lan2IpAddress').disabled = 1;
			document.getElementById('lan2SubnetMask').disabled = 1;
         }

		setClear();
	}
}

function hideLan2Info(hide) {
   var status = false;

   if ( hide == 1 )
      status = true;
   if (document.getElementById)  // DOM3 = IE5, NS6
      document.getElementById('lan2Info').disabled = status;
   else {
      if (document.layers == false) // IE4
         document.all.lan2Info.disabled = status;
   }
}

function lan2CbClick(cb) {
   if ( cb.checked == true ){
      hideLan2Info(0);
			document.getElementById('lan2IpAddress').disabled = 0;
			document.getElementById('lan2SubnetMask').disabled = 0;
   } else {
			document.getElementById('lan2IpAddress').disabled = 1;
			document.getElementById('lan2SubnetMask').disabled = 1;
      hideLan2Info(1);			
	 }
}

function setMac(){
	with (document.forms[0]) {
		if(dhcpres_edit!=1)
		macaddr.value = macUsed;
	}
}

function setClear(){
	with (document.forms[0]) {
		resv_enable.checked = true;
		CName.value = '';
		macaddr.disabled = 0;
		dipaddr.value = '0.0.0.0';
		macaddr.value = '00:00:00:00:00:00';
	}
}

//Caculating the number of hosts under specific Mask
function hostsOfMask(mask)
{
if(mask==0)
  {return 255;}
if(mask==128)
  {return 127;}
if(mask==192)
  {return 63;}
if(mask==224)
  {return 31;}
if(mask==240)
  {return 15;}
if(mask==248)
  {return 7;}
if(mask==252)
  {return 3;}
if(mask==254)
  {return 1;}
else
  {return 0;}
}

function isEndGTEStart(EndIp, StartIp)
{
   addrEnd = EndIp.split('.');
   addrStart = StartIp.split('.');
   E = parseInt(addrEnd[3]) + 1;
   S = parseInt(addrStart[3]) + 1;
   if (E < S) 
      return false;
   return true;
}

function setDhcpAddresses(lanIp) {
var broadIP;
var braodSplit;
var routermask;
var maskParts;
   with ( document.forms[0] ) {
      if ( isValidIpAddress(lanIp,"Address") == false ) return;

      if ( isValidSubnetMask(ethSubnetMask.value,"Address") == false ) return;
//-------for bug#11530------------------------------------------------
	  routermask=reencodeIP(ethSubnetMask.value);
	  maskParts=routermask.split('.');
	  if ( maskParts.length != 4 )
         return false;
          mask0=parseInt(maskParts[0]);
          mask1=parseInt(maskParts[1]);
	  mask2=parseInt(maskParts[2]);
	  mask3=parseInt(maskParts[3]);	  
//-------for bug#11530------------------------------------------------
	//Frederick,060726	Reencode ip to match lan ip
	lanIp = reencodeIP(lanIp);

      addrParts = lanIp.split('.');
      if ( addrParts.length != 4 )
         return false;
      t1 = parseInt(addrParts[3]) + 1;	  
      if (dhcpEthStart.value != '' && t1 > 255) {
         alert("Last portion of IP Address has to be less than 254 for Enabled DHCP Server");
         return false;
      }
      broadIP = getBroadcastIP(lanIp, ethSubnetMask.value);
      braodSplit = broadIP.split(".");
      dhcpEthStart.value = dhcpEthEnd.value = "";
	  
     /*
	bug#11586, 
	1)The Subnet Mask is 255.255.255.0
		DHCP rule: value=1~253 range=(value+1)~254, value=254 range=(1~value-1)

			ex: IP = 192.168.100.253, and mask is 255.255.255.0
			range=192.168.100.254~192.168.100.254

			ex: IP = 192.168.100.254, and mask is 255.255.255.0
			range=192.168.100.1~192.168.100.253

	2)The Subnet Mask is 255.255.0.0
		DHCP rule: value=1~255 range=(value)~255, value>255  range=error
		DHCP rule: value=1~253 range=(value+1)~254, value>254  range=error

		ex: IP = 192.168.100.253, and mask is 255.255.0.0
		range=192.168.100.254~192.168.255.254
	
		ex: IP = 192.168.100.254, and mask is 255.255.0.0
		range=error because if the range is 192.168.1.254~192.168.255.253 the router ip will include to dhcp range, 
		so when the subnet mask is 255.255.0.0 can not setting 192.168.x.254
	*/   
	  var check0 = parseInt(addrParts[0]);
	  var check1 = parseInt(addrParts[1]);
	  var check2 = parseInt(addrParts[2]);
	  var check3 = parseInt(addrParts[3]);
	  
if(mask3==0 && mask2==0 && mask1==0 && (mask0 <= 255 && mask0 >=0)){
//mask = x.0.0.0
       if(check3==1)
         {dhcpEthStart.value = (check0 & mask0)  + ".0.0.2";}
       else
         {dhcpEthStart.value = (check0 & mask0)  + ".0.0.1";}
         dhcpEthEnd.value =   ((check0 & mask0)+parseInt(hostsOfMask(mask0)) -1)  + ".255.255.254";
}

if(mask3==0 && mask2==0 && (mask1<=255 && mask1 >=0) && mask0==255){// mask = 255.x.0.0
       if(check3==1)
         {dhcpEthStart.value = addrParts[0] + "." + (check1 & mask1)  + ".0.2";}
       else
         {dhcpEthStart.value = addrParts[0] + "." +(check1 & mask1)  + ".0.1";}
         dhcpEthEnd.value =  addrParts[0] + "." +((check1 & mask1)+parseInt(hostsOfMask(mask1)))  + ".255.254";
}
if(mask3==0 && (mask2<=255 && mask2 >=0) && mask1==255 && mask0==255){// mask = 255.255.x.0
       if(check3==1)
         {dhcpEthStart.value = addrParts[0] + "." + addrParts[1]+ "." + (check2 & mask2)  + ".2";}
       else
         {dhcpEthStart.value = addrParts[0] + "." + addrParts[1] + "."+(check2 & mask2)  + ".1";}
         dhcpEthEnd.value =  addrParts[0] + "." + addrParts[1]+ "."+ ((check2 & mask2)+parseInt(hostsOfMask(mask2)))  + ".254";
}
if((mask3<=255 && mask3>=0) && mask2==255 && mask1==255 && mask0==255){// mask = 255.255.255.x
dhcpEthStart.value ='';
dhcpEthEnd.value = '';
      for (i = 0; i < 3; i++) {
         dhcpEthStart.value = dhcpEthStart.value + addrParts[i] + ".";
         dhcpEthEnd.value = dhcpEthEnd.value + braodSplit[i] + ".";
      }
//ex. 192.168.0.1 or 192.168.0.129 mask:255.255.255.128
       if(((check3 & mask3)+1)==check3)
         {dhcpEthStart.value = dhcpEthStart.value + (check3+1);}
       else
         {dhcpEthStart.value = dhcpEthStart.value + ((check3 & mask3)+1);}
         dhcpEthEnd.value =  dhcpEthEnd.value + ((check3 & mask3) + parseInt(hostsOfMask(mask3)) -1);
}



//	if(mask2!=0&&mask3==0){//check the submask=255.255.255.0
//
//      for (i = 0; i < 3; i++) {
//         dhcpEthStart.value = dhcpEthStart.value + addrParts[i] + ".";
//         dhcpEthEnd.value = dhcpEthEnd.value + braodSplit[i] + ".";
//      }
//	  if ( check3 >= 1&& check3 <= 253){
//		dhcpEthStart.value = dhcpEthStart.value + t1;
//        dhcpEthEnd.value = dhcpEthEnd.value + 254;
//	 }else if(check3 == 254){
//	  	dhcpEthStart.value = dhcpEthStart.value + 1;
//        dhcpEthEnd.value = dhcpEthEnd.value + (parseInt(addrParts[3]) - 1);
//	  }
//	  
//	}else{//check the submask=255.255.0.0
//	
//	  for (i = 0; i < 2; i++) {
//       	dhcpEthStart.value = dhcpEthStart.value + addrParts[i] + ".";
//       	dhcpEthEnd.value = dhcpEthEnd.value + braodSplit[i] + ".";
//      }		
//
////	  if ( check2 >= 0&& check2 <= 255){
//          if ( mask2 <= 255&& mask3 == 0){
//		dhcpEthStart.value = dhcpEthStart.value + parseInt(addrParts[2])+ ".";
//dhcpEthEnd.value = dhcpEthEnd.value + (check2 & mask2) + ".";
//        //dhcpEthEnd.value = dhcpEthEnd.value + 255+ ".";
//	}else if(check2 > 255){
//	 	alert("Last portion of IP Address has to be less than 255 for Enabled DHCP Server");
//    return false;
//	 	//dhcpEthStart.value = dhcpEthStart.value + 1+ ".";
//      //dhcpEthEnd.value = dhcpEthEnd.value + parseInt(addrParts[2])+ ".";
//
//	  }
//	  
//	  if ( check3 >= 1&& check3 <= 253){
//		dhcpEthStart.value = dhcpEthStart.value +(parseInt(addrParts[3])+1);
//	  }
//else if(check3 >= 254){
//	  	alert("Last portion of IP Address has to be less than 254 for Enabled DHCP Server");
//      return false;
//	  	//dhcpEthStart.value = dhcpEthStart.value + 1;
//        //dhcpEthEnd.value = dhcpEthEnd.value + (parseInt(addrParts[3]) - 1);
//	  }

//	}//else, check the submask=255.255.0.0
	/*bug#11586, DHCP rule: value=1~253 range=(value+1)~254, value=254 range=(1~value-1)-------end*/     

        //20110426,Bug#11530:some issues occurs after change LAN IP subnet mask.
        //20091116, Roger Yu fix dhcp IP range      
        //var s1 = getDhcpStart(lanIp, ethSubnetMask.value);
        //var s2 = s1 + 1;
        //var e2 = braodSplit[3] - 1;
        //var r1 = parseInt(addrParts[3]);

        //if (e2 <= r1)
        //{
            //dhcpEthStart.value = dhcpEthStart.value + s2;
        //}
        //else
        //{
           // dhcpEthStart.value = dhcpEthStart.value + t1;
        //}

        //if (parseInt(addrParts[3]) == 1)
        //    dhcpEthStart.value = dhcpEthStart.value + 2;
        //else if (s1 == 0)
        //    dhcpEthStart.value = dhcpEthStart.value + 1;
        //if ((s1 != 0) && (s1 < (t1 - 1)))
        //    dhcpEthStart.value = dhcpEthStart.value + s2;
        //else
        //    dhcpEthStart.value = dhcpEthStart.value + t1;

        //if (parseInt(addrParts[3]) == (braodSplit[3] -1))
        //{
            //dhcpEthEnd.value = dhcpEthEnd.value + (braodSplit[3] - 2);
        //}
        //else 
        //{
           // dhcpEthEnd.value = dhcpEthEnd.value + (braodSplit[3] - 1);
        //}
        //20091116, fix end

    }
}

function btnSave(reboot) {
   var loc = 'lancfg2.cgi?';

	var response = confirm('These settings will only take effect after rebooting the router.\nPress "OK" to reboot now or "Cancel" to reboot later');

   if (response)
//   if (reboot)
      loc = 'lancfg2Reset.cgi?';
//   	loc = 'rebootinfo.cgi';

   with ( document.forms[0] ) {
	  	if (!isValidIpAddress(ethIpAddress.value,"Address")) return;
	  	if (!isValidSubnetMask(ethSubnetMask.value,"Subnet Mask")) return;

	 //Frederick,060809 Add extra check if IP subnet qualifies with mask specified
	  	var reIP, reSubnetMask;
	  	reIP = reencodeIP(ethIpAddress.value);
	  	reSubnetMask = reencodeIP(ethSubnetMask.value);
	  	if (!DoValidateIpRange(reIP,reSubnetMask)) return;
  		
		if (DoValidateNetworkIP(reIP, reSubnetMask)==false)
		{
			return;
		}

      	loc += 'ethIpAddress=' + reIP
      	loc += '&ethSubnetMask=' + reSubnetMask;


// 		if (isOverlapModemIp(dhcpEnd, dhcpStart, ethIpAddress.value) == true){
//			alert("The Modem's IP cannot be within the DHCP address pool");
//			return;
//		}
		
      	if (enblLan2.checked == true) {
        	if ( isValidIpAddress(lan2IpAddress.value,"Address") == false ) return;
         	if ( isValidSubnetMask(lan2SubnetMask.value,"Subnet mask") == false ) return;

         	if (ethIpAddress.value == lan2IpAddress.value) {
            	alert('The IP address "' + ethIpAddress.value + '" for both LAN interfaces should not be the same.');
            	return;
         	}

         	if (isSameSubNet(ethIpAddress.value, ethSubnetMask.value, lan2IpAddress.value, lan2SubnetMask.value)) {
            	alert('The Subnet can not be the same for both LAN interfaces.');
            	return;
         	}
         
		loc += '&enblLan2=1';
         	loc += '&lan2IpAddress=' + reencodeIP(lan2IpAddress.value);
         	loc += '&lan2SubnetMask=' + reencodeIP(lan2SubnetMask.value);
      	}
      	else
         	loc += '&enblLan2=0';

   	}
   var code = 'location="' + loc + '"';
   eval(code);
}


function btnSave1(reboot) {
   var loc = 'lancfg2.cgi?';
   //var ethIP = '<%ejGet(ethIpAddress)%>';
   //var ethMask = '<%ejGet(ethSubnetMask)%>';

//	var response = confirm('These settings will only take effect after rebooting the router.\nPress "OK" to reboot now or "Cancel" to reboot later');

//   if (response)
   if (reboot)
      loc = 'lancfg2Reset.cgi?';
//	loc = 'rebootinfo.cgi';
   with ( document.forms[0] ) {
	if (!isValidIpAddress(ethIpAddress.value,"Address")) return;
	if (!isValidSubnetMask(ethSubnetMask.value,"Subnet Mask")) return;
	if (!isValidName(deviceName.value, "Device Name", BLANK_INVALID, SPACE_INVALID)) return;

	 //Frederick,060809 Add extra check if IP subnet qualifies with mask specified
	  	var reIP, reSubnetMask;
	  	reIP = reencodeIP(ethIpAddress.value);
	  	reSubnetMask = reencodeIP(ethSubnetMask.value);
	if (!DoValidateIpRange(reIP,reSubnetMask)) return;
  		
	if (DoValidateNetworkIP(reIP, reSubnetMask)==false)
		{
			return;
		}

      		loc += 'ethIpAddress=' + reIP;
      		loc += '&ethSubnetMask=' + reSubnetMask;
		loc += '&defaultGateway=' + reIP;//add by Van 0911161604
		loc += '&deviceName=' + deviceName.value;
		

		tmpethIpAddr = reIP;
		tmpethSubMask = reSubnetMask;	

// 		if (isOverlapModemIp(dhcpEnd, dhcpStart, ethIpAddress.value) == true){
//			alert("The Modem's IP cannot be within the DHCP address pool");
//			return;
//		}
		
      	if (enblLan2.checked == true) {
        	if ( isValidIpAddress(lan2IpAddress.value,"Address") == false ) return;
         	if ( isValidSubnetMask(lan2SubnetMask.value,"Subnet mask") == false ) return;

         	if (ethIpAddress.value == lan2IpAddress.value) {
            	alert('The IP address "' + ethIpAddress.value + '" for both LAN interfaces should not be the same.');
            	return;
         	}

         	if (isSameSubNet(ethIpAddress.value, ethSubnetMask.value, lan2IpAddress.value, lan2SubnetMask.value)) {
            	alert('The Subnet can not be the same for both LAN interfaces.');
            	return;
         	}
         
		loc += '&enblLan2=1';
         	loc += '&lan2IpAddress=' + reencodeIP(lan2IpAddress.value);
         	loc += '&lan2SubnetMask=' + reencodeIP(lan2SubnetMask.value);
      	}
      	else
         	loc += '&enblLan2=0';

		var ethIP = ethIpAddress.value;
		var ethMask = ethSubnetMask.value;
   
      if ( dhcpSrvType.checked == true ) {
         	if (isValidIpAddress(dhcpEthStart.value) == false || 
				!(isSameSubNet(ethIP, ethMask, dhcpEthStart.value, ethMask))) {
            	alert('Start IP address "' + dhcpEthStart.value + '" is invalid IP address.');
            	return;
         	}
         	if ( isValidIpAddress(dhcpEthEnd.value) == false ||
               !(isSameSubNet(ethIP, ethMask, dhcpEthEnd.value, ethMask))) {
            	alert('End IP address "' + dhcpEthEnd.value + '" is invalid IP address.');
            	return;
         	}   
         	if (!(isEndGTEStart(dhcpEthEnd.value, dhcpEthStart.value))) {
            	alert("End IP has to be equal or greater than Start IP address.");
            	return;
         	}

//            if (isOverlapModemIp(dhcpEthEnd.value, dhcpEthStart.value, ethIP) == true){
//                alert("The Modem's IP cannot be within the DHCP address pool");
//                return;
//            }
		
	  		var reIP, reSubnetMask, reDhcpStart, reDhcpEnd;
	  		reIP = reencodeIP(dhcpEthStart.value);
	  		reSubnetMask = reencodeIP(ethMask);
	  		if (!DoValidateIpRange(reIP,reSubnetMask)) return;
  			if (DoValidateNetworkIP(reIP, reSubnetMask)==false)
			{
				return;
			}
	  		reIP = reencodeIP(dhcpEthEnd.value);
	  		if (!DoValidateIpRange(reIP,reSubnetMask)) return;
  			if (DoValidateNetworkIP(reIP, reSubnetMask)==false)
			{
				return;
			}
			if (isInValidRange(dhcpLeasedTime.value,1,65535,"Leased time") == false) return;

         	loc += '&dhcpEthStart=' + reencodeIP(dhcpEthStart.value);
         	loc += '&dhcpEthEnd=' + reencodeIP(dhcpEthEnd.value);
         	loc += '&dhcpLeasedTime=' + dhcpLeasedTime.value;
         	loc += '&dhcpSubnetMask=' + reSubnetMask;
         	loc += '&enblDhcpSrv=1';

		var i;
		for(i = 0; i < savedentryNum; i++){
			//alert(rule1[i].ip);
			if (!isSameNet(ethIpAddress.value, rule1[i].ip)) {
            			alert('DHCP Reserved IP Address '+ rule1[i].ip +' is in a different Lan subnet with Router IP. Please delete or reset it');
            			return;
         		}
			if (isOverlapModemIp(dhcpEthEnd.value, dhcpEthStart.value, rule1[i].ip) == false){
       		var msg ='DHCP Reserved IP Address '+ rule1[i].ip +' is not within new DHCP address pool. Please delete or reset it.';
       		alert(msg);
       		return;
    			}

            // 20091117, Roger Yu add it
            if (rule1[i].ip == ethIpAddress.value)
            {
                var msg ='DHCP Reserved IP Address'+ rule1[i].ip +' is same with Router address.';
                alert(msg);
                return;
            }
            // end add            
		}	
      } 
      else if (DHCPR.checked == true)
      {
          if(isValidIpAddress(dhcpSrvAddr.value) == false)
      	  {
              alert('DHCP Server IP"' + dhcpSrvAddr.value + '"is invalid IP address.');
              return;
          }
      	  loc += '&enblDhcpSrv=2';
      	  loc += '&dhcpRelayServer=' + dhcpSrvAddr.value;
   	  } 
	  else 
	  {
          loc += '&enblDhcpSrv=0';         
      }      

   }
   var code = 'location="' + loc + '"';
   eval(code);

   if(tmpethIpAddr != ethIp || tmpethSubMask != ethSubMask) 	
	setTimeout("redirect()", 5000);
}

function redirect(){
        var loc = '';
        	//alert('redirect to the IP Address');
	 loc = 'http://' + tmpethIpAddr + '/login.html';
	 window.location.href = loc;
	//var code = 'location="' + loc + '"';
	//eval(code);	
}

function btnEdit(rml){
  var i;
  var checkedCount = 0 ;
  var hasChecked = false;

  var dhcpRes;

	with ( document.forms[0] ) {
		if(!rml) return;

  		if (rml){
			if (rml.length > 0){
				for (i = 0; i < rml.length; i++){
      				if(rml[i].checked == true){
						hasChecked = true;
        				checkedCount++;
        				dhcpRes = rml[i].value.split('|');
      				}
				}
			} else if (rml.checked == true){
				hasChecked = true;
   				checkedCount++;
				dhcpRes = rml.value.split('|');
			}

    		if (checkedCount > 1){
      			alert ("Please select only 1 item to edit!");
	      		hasChecked = false;
    	  		dhcpres_edit =0;
      			return;
    		}
  	
		}

		if (!hasChecked) {
			alert ("Please select an item to edit!");
			return;
		}

		editDhcpres(dhcpRes[0], dhcpRes[1], dhcpRes[2], dhcpRes[3]);

		dhcpReserveInfo.style.display = 'block';
		removeDHCPRes.disabled = 1;
		addDHCPRes.disabled = 1;
		editDHCPRes.disabled = 1;
	}

}


function addClick(){
    with ( document.forms[0] ) {
		dhcpReserveInfo.style.display = 'block';
		removeDHCPRes.disabled = 1;
		addDHCPRes.disabled = 1;
		editDHCPRes.disabled = 1;
		dhcpres_edit = 0;
		setClear();

	}
}

function removeClick(rml) {
   	var lst = '';
	var list = new Array();
   	if(!rml) return;

	var has_selected_items = false;
	
   if (rml.length > 0){
      for (i = 0; i < rml.length; i++) {
         if ( rml[i].checked == true ){
			has_selected_items=true;
			list = rml[i].value.split('|');
            lst += list[1] + ',';
		 }
      }
   } else if ( rml.checked == true ){
		has_selected_items=true;
		list = rml.value.split('|');
		lst = list[1];
   }
     
	if (has_selected_items){
   		var loc = 'dhcpdstaticlease.cmd?action=remove&rmLst=' + lst;

   		var code = 'location="' + loc + '"';
	//	alert(code);
   		eval(code);
	} else
		alert("There are no items to remove");
}

function editDhcpres(ebl,mac,ip,hname){
     dhcpres_edit=1;
     dhcpres_edit_oldname = hname;
     dhcpres_edit_oldmac = mac;	 
	with (document.forms[0]) {
    if(ebl == 1)
    {
		  resv_enable.checked = true;
	  }
	  else
	  {
		  resv_enable.checked = false;
		}
		CName.value = hname;
		dipaddr.value = ip;
		macaddr.value = mac;
		macaddr.disabled = 1;
	}
}

function saveClient() {
	var hwaddr = '';
	var i = 0;

   if(dhcpres_edit ==1)
   {
      var loc = 'dhcpdstaticlease.cmd?action=edit';
  //    loc += '&oldItem=' + dhcpres_edit_oldmac;
   }
   else{
	
	var loc = 'dhcpdstaticlease.cmd?action=add';
   	}
   
	with (document.forms[0]) {
	if (isValidIpAddress(dipaddr.value) && isValidMacAddress(macaddr.value)){
		
    		for (i = 0; i < savedentryNum ; i++){
       	  if(rule1[i].mac == macaddr.value)
       	 {
          		var msg;
          		if(dhcpres_edit==1)
          		{
             		if(rule1[i].mac == dhcpres_edit_oldmac)
               		continue;
          		}
          		msg ='Mac Address '+ macaddr.value +' already assign to other DHCP Reservation Entry';
          		alert(msg);
          		return;
       	}
    		}
		//var mac = (macaddr.value).split(':');
		//	hwaddr =mac[0] + mac[1] + mac[2] + mac[3] + mac[4] + mac[5];
		loc += '&mac=' + macaddr.value;
		
    		if ((isSameSubNet(dhcpEnd, ethSubMask, dipaddr.value, ethSubMask)== false)||(isOverlapModemIp(dhcpEnd, dhcpStart, dipaddr.value) == false)){
       		msg ='IP Address'+ dipaddr.value +' is not within DHCP address pool';
       		alert(msg);
       		return;
    		}

            // 20091117, Roger Yu add it
            if (dipaddr.value == ethIpAddress.value)
            {
                msg ='IP Address'+ dipaddr.value +' is same with Router address.';
                alert(msg);
                return;
            }
            // end add
            
		for (i = 0; i < savedentryNum ; i++){
  			if(rule1[i].ip == dipaddr.value){
          		var msg;
          		if(dhcpres_edit==1)
          		{
              //check if it is our old value, if yes skip it
              		if(rule1[i].mac == dhcpres_edit_oldmac)
                		continue;
          		}
          		msg ='IP Address '+ dipaddr.value +' already assign to other DHCP Reservation Entry';
          		alert(msg);
          		return;
       		}
    		}	
		loc += '&static_ip=' + dipaddr.value;
		
		if ( isValidName(CName.value,"Computer Name") == false ) return;
		
		loc += '&name=' + CName.value;
		if (resv_enable.checked == true)
			loc += '&enable=1';
		else
			loc += '&enable=0';
	}
	else{
			alert('Invalid Ip addr or MAC addr!!');
			return;
		}
	}
	var code = 'location="' + loc + '"';
	eval(code);

}

function btnCancel(){
    with ( document.forms[0] ) {
		dhcpReserveInfo.style.display = 'none';
		removeDHCPRes.disabled = 0;
		addDHCPRes.disabled = 0;
		editDHCPRes.disabled = 0;
		dhcpres_edit = 0;
	}
}

function isSameNet(lan1Ip, lan2Ip) {

   var count = 0;
   
   lan1a = lan1Ip.split('.');
   lan2a = lan2Ip.split('.');

   for (i = 0; i < 3; i++) {
      l1a_n = parseInt(lan1a[i], 10);
      l2a_n = parseInt(lan2a[i], 10);
      if (l1a_n == l2a_n)
         count++;
   }
   if (count == 3)
      return true;
   else
      return false;
}



// done hiding -->
    </script>
<script language="JavaScript" src="menu.js"></script>
   </head>
<body onLoad='frmLoad()'>
<blockquote>
<script language="JavaScript">
TabHeader="Setup";
SideItem="Local Network";
HelpItem="lancfg2";
</script> 
<script type='text/javascript'>
	mainTableStart();	
	logo();
	TopNav();
	ThirdRowStart();
	Write_Item_Images();
	mainBodyStart();
</script>
<form>
	<table id=box_header border=0 cellSpacing=0>
		<tr>
			<td class=topheader>
				LAN Setup
			</td>										
		</tr>
		<tr>
			<td class=content>
				<p>
				This section allows you to configure the local network settings of your router.  
				Please note that this section is optional and you should not need to change any of the settings here to get your network up and running.</p>
			</td>
		</tr>
	</table>
	<table id=body_header border=0 cellSpacing=0>
		<tr>
			<td class=topheader>
				Router Settings
			</td>										
		</tr>
		<tr>
			<td class=content>
	        <P class=box_msg></P>
            <P>Use this section to configure the local network settings of 
            your router. The IP Address that is configured here is the IP 
            Address that you use to access the Web-based management interface. 
            If you change the IP Address here, you may need to adjust your PC's 
            network settings to access the network again.</P>
            <TABLE class=formarea cellSpacing=0 cellPadding=0 summary="" border=0 width="100%">
              <TBODY>
              <TR>
                <TD class=form_label><LABEL for=ethIpAddress>Router IP Address&nbsp;:</LABEL></TD>
                <TD><INPUT id=ethIpAddress maxLength=15 onChange='setDhcpAddresses(this.value)'> </TD></TR>

              <TR>
                <TD class=form_label><LABEL for=ethSubnetMask>Subnet 
                Mask&nbsp;:</LABEL></TD>
                <TD><INPUT id=ethSubnetMask maxLength=15 onChange='setDhcpAddresses(ethIpAddress.value)'> 
                </TD>
	      </TR>

              <TR>
                <TD class=form_label><LABEL for=deviceName>Device Name&nbsp;:</LABEL></TD>
                <TD><INPUT id=deviceName maxLength=32> 
                </TD>
	      </TR>

	      </TBODY>
	     </TABLE>
               <table border="0" cellpadding="0" cellspacing="0" class=formarea >
                  <tr>
                     <td colspan="2">&nbsp</td>
                  </tr>
						<tr>
							<td  class=form_label><input type='checkbox' name='enblLan2' onClick='lan2CbClick(this)'></td>
							<td class=form_label_left>Configure the second IP Address and Subnet Mask for LAN interface</td>
						</tr>
                  <!-- tr>
                     <td colspan="2"><input type='checkbox' name='enblLan2' onClick='lan2CbClick(this)'>Configure the second IP Address and Subnet Mask for LAN interface
                  </tr -->
               </table>
               <div id='lan2Info'>
                  <table border="0" cellpadding="0" cellspacing="0" class=formarea >
                     <tr>
                        <td class=form_label>IP Address:</td>
                        <td><input type='text' name='lan2IpAddress' id='lan2IpAddress' size='15' maxlength='15'></td>
                     </tr>
                     <tr>
                        <td class=form_label>Subnet Mask:</td>
                        <td><input type='text' name='lan2SubnetMask' id='lan2SubnetMask' size='15' maxlength='15'></td>
                     </tr>
                  </table>
               </div>
      		</td>
		</tr>
	</table>
<!-- delete by roger @20070413	
<p align=center><input type='button' value="Save Settings" onClick='btnSave(0)'></p>
//end -->
	<table id=body_header border=0 cellSpacing=0>
		<tr>
			<td class=topheader>
				DHCP Server Settings (Optional)
			</td>										
		</tr>
		<tr>
			<td class=content>
            <P>Use this section to configure the built-in DHCP Server to assign 
            IP addresses to the computers on your network. 
            <b>Note that NAT should be disabled before using the DHCP relay function.</b> </P>

            <TABLE class=formarea cellSpacing=0 cellPadding=0 summary="" border=0 width="100%">
              <TBODY>
              <TR>
                <TD class=form_label><LABEL for=EDSv>Enable DHCP 
                  Server&nbsp;:</LABEL></TD>
                <TD><INPUT id=dhcpSrvType type=checkbox onclick="typeClick()"> 
                </TD></TR>
              <TR >
                <TD class=form_label><LABEL for=DIPAR>DHCP IP Address 
                  Range&nbsp;:</LABEL></TD>

                <TD><INPUT id=dhcpEthStart maxLength=15 size=15 
                  _VALUE="data.lan_dhcp_range_ip_start" 
                  _DISABLED="data.lan_use_dhcp == 0"> <LABEL 
                  for=toDIPAR>to</LABEL> <INPUT id=dhcpEthEnd maxLength=15 size=15 
                  _VALUE="data.lan_dhcp_range_ip_end" 
                  _DISABLED="data.lan_use_dhcp == 0"> </TD></TR><!--@OPTIONAL:the_lpj_output.APP_TYPE_ACCESS_POINT@--><!--@ENDOPTIONAL@-->
              <TR _DISPLAYED="!hide_disabled || data.lan_use_dhcp">
                <TD class=form_label><LABEL for=DLT>DHCP Lease 
                  Time&nbsp;:</LABEL></TD>
                <TD><INPUT id=dhcpLeasedTime maxLength=5 size=10 
                  _VALUE="data.lan_dhcp_timeout" 
                  _DISABLED="data.lan_use_dhcp == 0"> (hours) </TD></TR>

             <div id = 'dhcp_Relay2'>
		      <TR id = 'r1'>
              <TD class=form_label>DHCP Relay&nbsp;:</TD>
              <TD align=left><INPUT id=DHCPR type=checkbox onClick = 'dhcpRelay(this)'></TD></TR>
              
              <TR id  = 'r2'><TD  class=form_label>DHCP Server IP Address&nbsp;:</TD><TD align=left><INPUT id=dhcpSrvAddr maxLength=15 size=20 
               _DISABLED= disabled> 
              </TD></TR>
             </div>  
			</TBODY></TABLE>
</td>
		</tr>
	</table>
<p align=center><input type='button' value="Save Settings" onClick='btnSave1(0)'></p>

<TABLE id=body_header cellSpacing=0 width=690 border=0>
		<tr>
			<td class=topheader>
				DHCP Reservations List
			</td>										
		</tr>
		<tr>
			<td class=content>
            <div class=overflow>
            <TABLE class=formlisting id=basic_dhcp_staticclientlist cellSpacing=1 cellPadding=0 summary="" border=0>
              <TBODY>
              <TR class=form_label_row>
                <Td class=form_label_col></Td>
                <Td class=form_label_col>Enable</Td>
                <Td class=form_label_col>Computer Name</Td>
                <Td class=form_label_col>MAC Address</Td>

                <Td class=form_label_col>IP Address</Td>
			  </TR>
  <SCRIPT type=text/javascript>
  	if (dhcpEnbl == '1')
  		for (i = 0; i < savedentryNum; i++)
  		{
           	document.writeln('<TR class=form_label_row>');
		document.writeln('<TD align=\'center\'><input type=\'checkbox\' name=\'rml\' value=' + rule1[i].enable + '|'  +  rule1[i].mac + '|' + rule1[i].ip + '|' +  rule1[i].name + '></TD>');	
		if (rule1[i].enable != '0')
             	document.write('<TD class=formlist_col>Enable</TD>');
		else
			document.write('<TD class=formlist_col>Disable</TD>');
             document.write('<TD class=formlist_col>' + rule1[i].name +'</TD>');
             document.write('<TD class=formlist_col>' + rule1[i].mac + '</TD>');
             document.write('<TD class=formlist_col>'+ rule1[i].ip + '</TD>');
		document.write('</TR>');
  		}
</SCRIPT>                           
              </TBODY></TABLE>
              </div>
      		</td>
		</tr>
	</TABLE>
<p align=center><INPUT id=addDHCPRes onclick="addClick()" type=button value=Add><INPUT id=editDHCPRes onclick="btnEdit(this.form.rml)" type=button value=Edit ><INPUT id=removeDHCPRes onclick="removeClick(this.form.rml)" type=button value=Delete></p>

<div id=dhcpReserveInfo style="display:none">
	<TABLE id=body_header cellSpacing=0 width=690 border=0 align=center>
		<tr>
			<td class=topheader>
				<label id=dhcpheader>Add/Edit</label>&nbsp;DHCP Reservation (Optional)
			</td>										
		</tr>
		<tr>
			<td class=content>
            <TABLE class=formarea id=basic_dhcp_staticclient cellSpacing=0 
            cellPadding=0 summary="" border=0 width="100%">
              <TR>
                <TD class=form_label><LABEL for=enable id=enableRsvlbl>Enable&nbsp;:</LABEL></TD>
                <TD><INPUT id=resv_enable type=checkbox > </TD></TR>

              <TR>
                <TD class=form_label><LABEL for=CName>Computer Name&nbsp;:</LABEL></TD>
                <TD><INPUT id=CName maxLength=31>
				</TD></TR>
              <TR>
                <TD class=form_label><LABEL for=dipaddr>IP 
                  Address&nbsp;:</LABEL></TD>
                <TD><INPUT id=dipaddr maxLength=15 
                  _VALUE="ae.thearray[-1].mac_ip"> </TD></TR>
              <TR>
                <TD class=form_label><LABEL for=macaddr>MAC 
                  Address&nbsp;:</LABEL></TD>
                <TD><INPUT id=macaddr maxLength=17 
                  _VALUE="ae.thearray[-1].mac_addr"> </TD></TR>
              <TR>
                <TD class=form_label></TD>
                <TD><INPUT id=cpyMacAddr onclick=setMac(); type=button value="Copy Your PC's MAC Address"> 
                </TD></TR>
			</TBODY></TABLE>
      		</td>
		</tr>
	</table>
<p align=center><INPUT id=btnDhcpRes onclick="saveClient();" type=button value=Apply><INPUT onclick="btnCancel()" type=button value=Cancel ></p>
</div>
		
<table id=body_header width="690" border=0 cellSpacing=0>
	<TBODY>
		<TR>
			<SCRIPT type=text/javascript>
				if(dhcpEnbl == '0')	dhcpLeasesNum = '0';
				document.write('<TD class=topheader>Number of Dynamic DHCP Clients&nbsp;:&nbsp;' + dhcpLeasesNum + ' </TD>');
			</SCRIPT>
		</TR>
		<TR>
			<TD  class=content>
			<div class=overflow>
					<table class=formlisting>
				<TR class=form_label_row>
					<td class="form_label_col">Computer Name</td>
					<td class="form_label_col">MAC Address</td>
					<td class="form_label_col">IP Address</td>
					<td class="form_label_col">Expire Time</td>
				</TR>
					<%ejGet(dhcpLeases)%>
				</table>
				</div>
			</TD>
		</TR>
	</TBODY>
</table>
	
</form>
<script type='text/javascript'>
	mainBodyEnd();
	ThirdRowEnd();
	Footer()
	mainTableEnd()
</script>
</blockquote>
  </body>
</html>
