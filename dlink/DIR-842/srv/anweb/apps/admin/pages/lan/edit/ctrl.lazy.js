"use strict";function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){var i,arr2;for((null==len||len>arr.length)&&(len=arr.length),i=0,arr2=new Array(len);len>i;i++)arr2[i]=arr[i];return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i["return"]||_i["return"]()}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){return Array.isArray(arr)?arr:void 0}angular.module("app").controllerProvider.register("LanEditCtrl",["oneWayRequest","$q","$rootScope","$scope","$state","lanPage","LanPageCommon","funcs","dhcpOptions","ngDialog","pageDetails","translate","devinfo","systemActionService","navShared",function(oneWayRequest,$q,$rs,$scope,$state,lanPage,LanPageCommon,funcs,dhcpOptions,ngDialog,pageDetails,translate,devinfo,systemActionService,navShared){function findInReservation(addr){return $scope.lan.DHCPServer.DHCPv4.__ReservationArray.find(function(e){return e.IP==addr})}function onLoad(data){var lan=$scope.lan=data.View.LAN.List[thisInstInx];if($scope.needShowDropMultiCastWarn=funcs.newConfig.some(data.Device.WiFi.Radio,function(r){return r.Advanced.DropMulticast}),clientInfo.sitsOnEditable=doesClientSitOnEditable(lan),lanPageCommon.prepareIPv4ModelForForm(lan),initAddressingType=lan.IPv4.AddressingType,initDNSAuto=lan.IPv4.DHCP.__DNSAuto,"DHCP"==lan.IPv4.AddressingType){updating=!0;var pathsToUpdate=["IPv4.Address.","IPv4.Gateway","IPv4.DNS."].map(function(e){return thisInstPath+e});lanPage.subscribe($scope,onUpdate,pathsToUpdate)}}function onUpdate(){var lan=$scope.lan;if("DHCP"==lan.IPv4.AddressingType){var first=lanPageCommon.getFirstInstance(lan.IPv4.Address),_lanPageCommon$ipPref3=lanPageCommon.ipPrefixToAddrAndMask(first.IPAddress),_lanPageCommon$ipPref4=_slicedToArray(_lanPageCommon$ipPref3,2);lan.IPv4.__Address0=_lanPageCommon$ipPref4[0],lan.IPv4.__Mask0=_lanPageCommon$ipPref4[1],lan.IPv4.__Gateway=lan.IPv4.Gateway,initDNSAuto&&lan.IPv4.DHCP.__DNSAuto&&(lan.IPv4.__DNSArray=lanPageCommon.getDNSAddressArray(lan.IPv4.DNS))}}function belongsLanIPv4Subnet(ip,lanIP,lanMask){var subnet=funcs.ipv4.subnet;return subnet.belongNetwork(subnet.getNetworkAddress(lanIP,lanMask),ip,lanMask)}function openStaticIPDialog(data){return ngDialog.open({template:"dialogs/dhcp_static_address/dialog.tpl.html",controller:"DHCPStaticAddressDialogCtrl",scope:$scope,data:data})}function openDNSHostsDialog(data){return ngDialog.open({template:"dialogs/dns_hosts/dialog.tpl.html",controller:"DnsHostsDialogCtrl",resolve:funcs.getLazyResolve("dialogs/dns_hosts/ctrl.lazy.js","DnsHostsDialogCtrl"),data:data,scope:$scope})}function goAwayOnSuccess(newHost){Object.keys(allLANData.View.LAN.List).length>1?pageDetails.lanList[0].go(newHost):pageDetails.lanEdit[0].go(newHost,{data:null,inx:thisInstInx},{reload:!0})}function getClientNewIPv4Host(warn){var newHostInfo=null,lan=$scope.lan,addr0=$scope.getLocalIP();return warn||(warn=translate("lan_warn_redirect_ip",{ip:"IPv4",abr:"ip"})),"DHCP"!=lan.IPv4.AddressingType&&addr0&&(newHostInfo={warn:warn,value:addr0}),newHostInfo}function getClientNewIPv6Host(warn){var newHostInfo=null,lan=$scope.lan;if(warn||(warn=translate("lan_warn_redirect_ip",{ip:"IPv6",abr:"ip"})),"Staticv6"==lan.IPv6.AddressingType&&lan.IPv6.Static.IPAddress)newHostInfo={warn:warn,value:lanPageCommon.splitIPPrefix(lan.IPv6.Static.IPAddress)[0]};else if("Unknown"==lan.IPv6.AddressingType){var address=lan.IPv6.Address,arr=Object.keys(address).map(function(k){return address[k].IPAddress}).filter(function(e){return e});arr.length&&(newHostInfo={warn:warn,value:lanPageCommon.splitIPPrefix(arr[0])[0]})}return newHostInfo}function getClientNewDomainNameHost(warn){var newHostInfo=null,lan=$scope.lan;return lan.DomainName&&(newHostInfo={warn:warn||"lan_warn_redirect_domain_name",value:lan.DomainName}),newHostInfo}function getClientNewHost(){var lan=$scope.lan,addr0=$scope.getLocalIP();if(!clientInfo.sitsOnEditable)return null;if(funcs.is.ipv6(webHost)||webHost==lan.DomainName||funcs.is.ipv4(webHost)&&("DHCP"==lan.IPv4.AddressingType&&"DHCP"==initAddressingType||"DHCP"!=lan.IPv4.AddressingType&&addr0==webHost))return null;var newHostInfo={warn:"lan_warn_redirect_no_ip"};return funcs.is.hostname(webHost)?newHostInfo=getClientNewDomainNameHost("lan_warn_redirect_new_domain_name")||getClientNewIPv4Host()||getClientNewIPv6Host()||{warn:"lan_warn_redirect_no_ip"}:funcs.is.ipv4(webHost)&&(newHostInfo=getClientNewIPv4Host(translate("lan_warn_redirect_new_ip",{ip:"IPv4",abr:"ip"}))||getClientNewDomainNameHost()||getClientNewIPv6Host()||{warn:"lan_warn_redirect_no_ip"}),newHostInfo}function doesClientSitOnEditable(lan){var address=lan.IPv4.Address;return webHost==lan.DomainName||address&&Object.keys(address).map(function(k){return lanPageCommon.splitIPPrefix(address[k].IPAddress)[0]}).find(function(e){return e==webHost})?!0:!1}function prepareModelForSubmit(){var wdk=lanPage.getWorkDataKeeper(),basePath="View.LAN.List.".concat(thisInstInx);lanPageCommon.prepareIPv4ModelForSubmit(wdk,basePath+".")}var lanPageCommon=LanPageCommon(),allLANData=$state.params.data,thisInstInx=$state.params.inx,thisInstPath="List."+thisInstInx+".",initAddressingType=null,initDNSAuto=!1,clientInfo={},webHost=document.location.hostname,updating=!1;$scope.hostsMin=2,$scope.hostsMax=16777214,$scope.dhcpOptions=dhcpOptions,$scope.isFirewallMode=navShared.isFirewallMode,$scope.isApMode=navShared.isApMode,$scope.isApMode||($scope.hostsMax=254),devinfo.once("client").then(function(res){return res.client&&"WLAN"==res.client.name&&(clientInfo.directWiFiConnection=!0),allLANData?lanPage.setData(allLANData):lanPage.pull(thisInstPath)}).then(function(data){allLANData=data,onLoad(data),$scope.$emit("pageload")})["catch"](function(error){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"})}),$scope.goToIPv6=function(){var data=lanPage.getWorkDataKeeper().initialTree;$state.go(pageDetails.lanEditIPv6[0].state,{inx:thisInstInx,data:data})},$scope.addDHCPOption=function(){var dhcp=$scope.lan.DHCPServer.DHCPv4;lanPageCommon.openDHCPOptionsDialog({usedOptions:dhcp.__OptionsArray},$scope).closePromise.then(function(data){if(data.value&&"$escape"!=data.value){var value=data.value;dhcp.__OptionsArray.push({Option:value.Option,Value:value.Value,Force:value.Force,Type:value.Type})}})},$scope.editDHCPOption=function(option,inx){var used=$scope.lan.DHCPServer.DHCPv4.__OptionsArray.filter(function(e,i){return i!=inx});lanPageCommon.openDHCPOptionsDialog({usedOptions:used,option:option},$scope).closePromise.then(function(data){if(data.value&&"$escape"!=data.value){var value=data.value;option.Option=value.Option,option.Value=value.Value,option.Force=value.Force,option.Type=value.Type}})},$scope.deleteDHCPOption=function(items,keys){lanPageCommon.deleteItems($scope.lan.DHCPServer.DHCPv4,"__OptionsArray",keys)},$scope.addStaticIP=function(){var reservArr=$scope.lan.DHCPServer.DHCPv4.__ReservationArray;openStaticIPDialog({used:reservArr,ipVersion:"ipv4",gw:$scope.lan.IPv4.Gateway,ip0:$scope.getLocalIP(),mask0:$scope.getLocalMask()}).closePromise.then(function(data){if(data.value&&"$escape"!=data.value){var value=data.value;reservArr.push({IPAddress:value.ip,MACAddress:value.mac,Hostname:value.hostname,Lease:value.lease})}})},$scope.editStaticIP=function(item,inx){var used=$scope.lan.DHCPServer.DHCPv4.__ReservationArray.filter(function(e,i){return i!=inx});openStaticIPDialog({used:used,ipVersion:"ipv4",gw:$scope.lan.IPv4.Gateway,ip0:$scope.getLocalIP(),mask0:$scope.getLocalMask(),ip:item.IPAddress,mac:item.MACAddress,hostname:item.Hostname,lease:item.Lease}).closePromise.then(function(data){data.value&&"$escape"!=data.value&&(item.IPAddress=data.value.ip,item.MACAddress=data.value.mac,item.Hostname=data.value.hostname,item.Lease=data.value.lease)})},$scope.deleteStaticIP=function(items,keys){lanPageCommon.deleteItems($scope.lan.DHCPServer.DHCPv4,"__ReservationArray",keys)},$scope.addDNSHost=function(){var hostsArr=$scope.lan.DHCPServer.DHCPv4.__HostsArray;openDNSHostsDialog({ipVersion:"ipv4",hostsArr:hostsArr}).closePromise.then(function(data){if(data.value&&"$escape"!=data.value){var host=data.value.host;hostsArr.push(host)}})},$scope.editDNSHost=function(item,inx){var hostsArr=$scope.lan.DHCPServer.DHCPv4.__HostsArray;openDNSHostsDialog({ipVersion:"ipv4",hostsArr:hostsArr,inx:inx}).closePromise.then(function(data){if(data.value&&"$escape"!=data.value){var host=data.value.host;item.Hostname=host.Hostname,item.__AddressArray=host.__AddressArray}})},$scope.deleteDNSHosts=function(items,keys){lanPageCommon.deleteItems($scope.lan.DHCPServer.DHCPv4,"__HostsArray",keys)},$scope.submit=function(form){if(form.$valid){var confirmed,newHostInfo=getClientNewHost();if(confirmed=confirm(newHostInfo?translate(newHostInfo.warn):translate("msg_warn_submit")),!confirmed)return void(form.$canceled=!0);prepareModelForSubmit();var overlay=$scope.overlay.circular,overlayId=overlay.start(),newHost=newHostInfo?newHostInfo.value:null;oneWayRequest({req:lanPage.push(),minTime:3e3,maxTime:12e4,newHost:newHostInfo?newHostInfo.value:null}).then(function(res){if(overlay.stop(overlayId),res.data&&res.data.needReboot&&confirm(translate("notice_save_and_reboot_desc")))return systemActionService.reboot({newHost:newHost});var d=$q.defer();return d.resolve(),d.promise}).then(function(){!$rs.dlinkMobileApp.isUserInMobileApp()&&clientInfo.directWiFiConnection&&alert(translate("lan_warn_check_wifi")),goAwayOnSuccess(newHost)})["catch"](function(error){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})})["finally"](function(){overlay.stop(overlayId)})}},$scope.showDNSServer=function(){return lanPageCommon.showDNSServer($scope.lan)},$scope.getInstanceNumber=function(multiObject){var count=0;return multiObject&&(count=Object.keys(multiObject).length),count},$scope.getDHCPOptionCaption=dhcpOptions.getCaption,$scope.changed=function(){return $scope.lan?(prepareModelForSubmit(),lanPage.changed()):void 0},$scope.openDHCPServerAddressPoolDialog=function(){var data={ipVersion:4,ip:$scope.getLocalIP(),mask:$scope.getLocalMask(),gateway:$scope.lan.IPv4.Gateway};ngDialog.open({template:"dialogs/dhcp_server_address_pool/dialog.tpl.html",controller:"DHCPServerAddressPoolDialogCtrl",data:data,scope:$scope}).closePromise.then(function(data){data.value&&"$escape"!=data.value&&($scope.lan.DHCPServer.DHCPv4.StartIP=data.value.start,$scope.lan.DHCPServer.DHCPv4.EndIP=data.value.end)})},$scope.removeDHCPRelayAddress=function(inx){$scope.lan.DHCPServer.DHCPv4.__RelayArray.splice(inx,1)},$scope.addDHCPRelayAddress=function(){$scope.lan.DHCPServer.DHCPv4.__RelayArray.push({IPAddress:""})},$scope.allowDeleteRelayIP=function(){return $scope.lan.DHCPServer.DHCPv4.__RelayArray.length>1},$scope.suggestRangeDisable=function(){var addr=$scope.getLocalIP(),mask=$scope.getLocalMask(),gateway=$scope.lan.IPv4.Gateway;return!addr||!funcs.is.ipv4(addr)||!mask||!funcs.is.mask(mask)||gateway&&!funcs.is.ipv4(gateway)},$scope.onAddressingTypeChange=function(){var ipv4=$scope.lan.IPv4,addrType=ipv4.AddressingType;if("Static"==addrType){var st=ipv4.Static;if((!ipv4.__Address0||!ipv4.__Mask0)&&ipv4.Static.IPAddress){var _lanPageCommon$ipPref=lanPageCommon.ipPrefixToAddrAndMask(st.IPAddress),_lanPageCommon$ipPref2=_slicedToArray(_lanPageCommon$ipPref,2);ipv4.__Address0=_lanPageCommon$ipPref2[0],ipv4.__Mask0=_lanPageCommon$ipPref2[1]}!ipv4.__Gateway&&st.Gateway&&(ipv4.__Gateway=st.Gateway)}},$scope.removeDNSAddress=function(inx){$scope.lan.IPv4.__DNSArray.splice(inx,1)},$scope.addDNSAddress=function(){$scope.lan.IPv4.__DNSArray.push({IPAddress:""})},$scope.allowDeleteDNSAddress=function(){return lanPageCommon.allowDeleteDNSAddress($scope.lan.IPv4)},$scope.onDNSAutoChange=function(){updating&&onUpdate()},$scope.haveAPFeatures=function(){return lanPage.haveAPFeatures($scope.lan.IPv4)},$scope.dnsHostAddressArrayToString=lanPageCommon.dnsHostAddressArrayToString,$scope.getLeaseColumn=lanPageCommon.getLeaseColumn,$scope.getReservationItemSecondaryLine=lanPageCommon.getReservationItemSecondaryLine,$scope.validateStartIP=function(value){var lan=$scope.lan,startIP=value,endIP=lan.DHCPServer.DHCPv4.EndIP,addr0=$scope.getLocalIP(),mask0=$scope.getLocalMask();if(!funcs.is.ipv4(startIP))return"msg_invalid_ipv4";if(!belongsLanIPv4Subnet(startIP,addr0,mask0))return"lan_error_ip_address_and_lan_ip_are_in_different_subnets";if(funcs.is.ipv4(endIP)){var res=funcs.ipv4.address.compare(startIP,endIP);if(res>0)return"msg_error_start_ip_more_end_ip"}return funcs.ipv4.subnet.belongNetworkRange({start:startIP,end:endIP},addr0)?"lan_error_lan_ip_address_is_in_dhcp_range":null},$scope.validateEndIP=function(value){var lan=$scope.lan,startIP=lan.DHCPServer.DHCPv4.StartIP,endIP=value,addr0=$scope.getLocalIP(),mask0=$scope.getLocalMask();if(!funcs.is.ipv4(endIP))return"msg_invalid_ipv4";if(!belongsLanIPv4Subnet(endIP,addr0,mask0))return"lan_error_ip_address_and_lan_ip_are_in_different_subnets";if(funcs.is.ipv4(startIP)){var res=funcs.ipv4.address.compare(endIP,startIP);if(0>res)return"msg_error_end_ip_less_start_ip"}return funcs.ipv4.subnet.belongNetworkRange({start:startIP,end:endIP},addr0)?"lan_error_lan_ip_address_is_in_dhcp_range":null},$scope.validateRelayIP=function(value,required){$scope.getLocalMask();if(value){if(!funcs.is.ipv4(value))return"msg_invalid_ipv4"}else{var relayArr=$scope.lan.DHCPServer.DHCPv4.__RelayArray;if($scope.form.relay_ip.$dirty&&required&&!relayArr.find(function(e){return e.IPAddress}))return"msg_need_addr"}return null},$scope.validateDNSAddress=function(value,inx){return lanPageCommon.validateDNSAddress(value,inx,$scope.lan.IPv4.__DNSArray,"ipv4")},$scope.validateIP=function(value){{var dhcp=$scope.lan.DHCPServer.DHCPv4;$scope.getLocalMask()}if(!value)return"msg_input_is_empty";if(!funcs.is.ipv4(value))return"msg_invalid_ipv4";if("DHCP"==dhcp.__Mode){var obj=findInReservation(value);if(obj)return translate("lan_error_ip_is_used_as_static_ip",{mac:obj.MAC})}return null},$scope.validateGateway=function(value){var addr0=$scope.getLocalIP(),mask0=$scope.getLocalMask();if(!value)return null;var dhcp=$scope.lan.DHCPServer.DHCPv4;if(!funcs.is.ipv4(value))return"msg_invalid_ipv4";if(value==addr0)return"lan_error_gw_ip_address_is_used_as_lan_ip";if(!funcs.ipv4.subnet.belongNetwork(funcs.ipv4.subnet.getNetwork(addr0,mask0).net,value,mask0))return"lan_error_gateway_not_belong_subnets";if("DHCP"==dhcp.__Mode){if(funcs.ipv4.subnet.belongNetworkRange({start:dhcp.StartIP,end:dhcp.EndIP},value))return"lan_error_ip_address_is_in_dhcp_range";var obj=findInReservation(value);if(obj)return translate("lan_error_ip_is_used_as_static_ip",{mac:obj.MAC})}return null},$scope.validateMask=function(value){if(!funcs.is.mask(value))return"msg_invalid_mask";var hosts=funcs.ipv4.mask.hosts(value);return hosts<$scope.hostsMin?"lan_error_subnet_hosts_less_min":hosts>$scope.hostsMax?"lan_error_subnet_hosts_more_max":null},$scope.getLocalIP=function(){var ipv4=$scope.lan.IPv4;return ipv4.__Address0},$scope.getLocalMask=function(){var ipv4=$scope.lan.IPv4;return ipv4.__Mask0}}]);