"use strict";function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){var i,arr2;for((null==len||len>arr.length)&&(len=arr.length),i=0,arr2=new Array(len);len>i;i++)arr2[i]=arr[i];return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i["return"]||_i["return"]()}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){return Array.isArray(arr)?arr:void 0}angular.module("app").factory("LanPageCommon",["funcs","InstNumGen","$rootScope","translate","$q","ngDialog","lanPage",function(funcs,InstNumGen,$rs,translate,$q,ngDialog,lanPage){return function(){function getUnmanagedAddressArray(arr){return arr.filter(function(e){return!e.AddressOrigin})}function secToMin(time){return(time/60).toFixed()}function minToSec(time){return 60*time}function showDNSServer(model){return"DHCP"==model.DHCPServer.DHCPv4.__Mode&&"DHCP"!=model.IPv4.AddressingType}function showDNSv6Server(model){return"Stateful"==model.DHCPServer.DHCPv6.__Mode&&"DHCPv6"!=model.IPv6.AddressingType}function getAddressingTypesSupportedArray(data){var langs={Static:"lan_addressing_mode_static",Staticv6:"lan_addressing_mode_static",DHCP:"lan_addressing_mode_dynamic",DHCPv6:"lan_addressing_mode_dynamic",PD:"lan_ipv6_addressing_mode_pd"};return data.AddressingTypesSupported.split(",").filter(function(e){return Object.keys(langs).includes(e)}).map(function(e){return{value:e,name:langs[e]}})}function multiObjectToArray(multiObj){return Object.keys(multiObj||{}).map(function(key){return multiObj[key].__key=key,multiObj[key]})}function arrayToMultiObject(arr){var obj,multiObj={};for(var i in arr||[])obj=arr[i],obj.__key?multiObj[obj.__key]=obj:multiObj[instNumGen.get()]=obj;return multiObj}function prepareDHCPServerModelForSubmit(wdk,path){var dhcpServer=funcs.findBranch(wdk.workTree,path),dhcp=dhcpServer.DHCPv4;"DHCP"==dhcp.__Mode?(wdk.ignorePaths=wdk.ignorePaths.concat(["Relay","RelayAgent"].map(function(e){return path+"DHCPv4."+e})),dhcpServer.Enable=!0,dhcp.Mode="DHCP",dhcp.Lease=minToSec(dhcp.__LeaseInMinutes),dhcp.Reservation=arrayToMultiObject(dhcp.__ReservationArray),dhcp.Options=arrayToMultiObject(dhcp.__OptionsArray)):"Relay"==dhcp.__Mode?(wdk.ignorePaths=wdk.ignorePaths.concat(["StartIP","EndIP","Lease","Reservation","Options","DNSRelay"].map(function(e){return path+"DHCPv4."+e})),dhcpServer.Enable=!0,dhcp.Mode="Relay",dhcp.Relay=arrayToMultiObject(dhcp.__RelayArray.filter(function(e){return e.IPAddress}))):"Disable"==dhcp.__Mode&&(wdk.ignorePaths=wdk.ignorePaths.concat(["StartIP","EndIP","Lease","Reservation","Options","Relay","RelayAgent","DNSRelay"].map(function(e){return path+"DHCPv4."+e})),wdk.resetPath(path+"Enable"),dhcpServer.Enable?dhcp.Mode="None":wdk.resetPath(path+"DHCPv4.Mode"))}function prepareDHCPv6ServerModelForSubmit(wdk,path){var dhcpServer=funcs.findBranch(wdk.workTree,path),dhcp=dhcpServer.DHCPv6;"Stateful"==dhcp.__Mode?(wdk.ignorePaths.push(path+"DHCPv6.Relay"),dhcpServer.Enable=!0,dhcp.Mode="DHCP",dhcp.Lease=minToSec(dhcp.__LeaseInMinutes),dhcp.Reservation=arrayToMultiObject(dhcp.__ReservationArray)):"Stateless"==dhcp.__Mode?(wdk.ignorePaths=wdk.ignorePaths.concat(["StartIP","EndIP","Reservation","Relay"].map(function(e){return path+"DHCPv6."+e})),dhcpServer.Enable=!0,dhcp.Mode="Autoconf",dhcp.Lease=minToSec(dhcp.__LeaseInMinutes)):"Relay"==dhcp.__Mode?(wdk.ignorePaths=wdk.ignorePaths.concat(["StartIP","EndIP","Lease","Reservation","DNSRelay"].map(function(e){return path+"DHCPv6."+e})),dhcpServer.Enable=!0,dhcp.Mode="Relay",dhcp.Relay=arrayToMultiObject(dhcp.__RelayArray.filter(function(e){return e.IPAddress}))):"Disable"==dhcp.__Mode&&(wdk.ignorePaths=wdk.ignorePaths.concat(["StartIP","EndIP","Lease","Reservation","Options","Relay","DNSRelay"].map(function(e){return path+"DHCPv6."+e})),wdk.resetPath(path+"Enable"),dhcpServer.Enable&&(dhcp.Mode="None"))}function prepareDNSHostsModelForForm(dhcp){var host;dhcp.__HostsArray=multiObjectToArray(dhcp.Hosts);for(var i in dhcp.__HostsArray)host=dhcp.__HostsArray[i],host.__AddressArray=multiObjectToArray(host.Address)}function prepareDNSHostsModelForSubmit(dhcp){var host;for(var i in dhcp.__HostsArray)host=dhcp.__HostsArray[i],host.Address=arrayToMultiObject(host.__AddressArray);dhcp.Hosts=arrayToMultiObject(dhcp.__HostsArray)}function getFirstInstance(multiObj){var firstInstNum=Math.min.apply(null,Object.keys(multiObj).map(function(k){return parseInt(k)}).filter(function(i){return"NaN"!=i.toString()}));return multiObj[firstInstNum]}function ipPrefixToAddrAndMask(ipPrefix){var arr=splitIPPrefix(ipPrefix),addr=arr[0],mask=funcs.ipv4.mask["long"](arr[1]);return[addr,mask]}function splitIPPrefix(ipPrefix){return ipPrefix.split("/")}function addrAndMaskToIPPrefix(addr,mask){var prefix=funcs.ipv4.mask["short"](mask);return addr+"/"+prefix}function getDHCPServerMode(dhcpServer){var mode=dhcpServer.DHCPv4.Mode;return dhcpServer.Enable&&"None"!=mode?mode:"Disable"}function getDHCPv6ServerMode(dhcpServer){var mode="Disable";return dhcpServer.Enable&&("DHCP"==dhcpServer.DHCPv6.Mode?mode="Stateful":"Autoconf"==dhcpServer.DHCPv6.Mode?mode="Stateless":"Relay"==dhcpServer.DHCPv6.Mode&&(mode="Relay")),mode}function getIPv6AddressArray(addressObj){var addressArray=multiObjectToArray(addressObj);return indexIPv6AddressArray(addressArray),addressArray}function indexIPv6AddressArray(addressArray){for(var i in addressArray)addressArray[i].__inx=i}function getIPv6AddressMultiObject(addressArr){var arr=getUnmanagedAddressArray(addressArr).filter(function(e){return e.IPAddress}),multiObj=arrayToMultiObject(arr);return addressArr.forEach(function(obj){obj.AddressOrigin&&obj.__key&&(multiObj[obj.__key]=obj)}),multiObj}function getRelayAddressArray(relayObj){var relayArray=multiObjectToArray(relayObj);return relayArray.length||relayArray.push({IPAddress:""}),relayArray}function getDNSAddressArray(dnsObj){var dnsArray=multiObjectToArray(dnsObj);return dnsArray.length||dnsArray.push({IPAddress:""}),dnsArray}function getIntegerKeys(obj){return Object.keys(obj).filter(function(e){return e.match(/^\d+$/)}).sort(function(a,b){return a-b})}function rewriteDNSKeys(ipvx){var addrType=ipvx.AddressingType,sectName="Static"==addrType||"Staticv6"==addrType?"Static":"DHCP",dns=ipvx[sectName].DNS||{},keys=getIntegerKeys(dns);ipvx.__DNSArray.forEach(function(e,i){var k=keys[i];i<keys.length?e.__key=k:delete e.__key})}function prepareDNSAddressesForSubmit(wdk,path){var ipvx=funcs.findBranch(wdk.workTree,path),st=ipvx.Static,dhcp=ipvx.DHCP,addrType=ipvx.AddressingType;ipvx.__DNSArray.forEach(function(e){return delete e.Origin}),rewriteDNSKeys(ipvx),"Static"==addrType||"Staticv6"==addrType?(st.DNS=arrayToMultiObject(ipvx.__DNSArray.filter(function(e){return e.IPAddress})),wdk.ignorePaths.push(path+"DHCP.DNS")):("DHCP"==addrType||"DHCPv6"==addrType)&&(dhcp.DNS=dhcp.__DNSAuto?{}:arrayToMultiObject(ipvx.__DNSArray.filter(function(e){return e.IPAddress})),wdk.ignorePaths.push(path+"Static.DNS"))}function prepareDNSAddressesForForm(ipvx){ipvx.DHCP||(ipvx.DHCP={}),ipvx.DHCP.DNS||(ipvx.DHCP.DNS={}),ipvx.DHCP.__DNSAuto=!Object.keys(ipvx.DHCP.DNS).length,"Static"==ipvx.AddressingType||"Staticv6"==ipvx.AddressingType?ipvx.__DNSArray=getDNSAddressArray(ipvx.Static.DNS):("DHCP"==ipvx.AddressingType||"DHCPv6"==ipvx.AddressingType)&&(ipvx.__DNSArray=getDNSAddressArray(ipvx.DHCP.DNS))}var instNumGen;return{getDNSAddressArray:getDNSAddressArray,getIPv6AddressArray:getIPv6AddressArray,getDHCPServerMode:getDHCPServerMode,getDHCPv6ServerMode:getDHCPv6ServerMode,ipPrefixToAddrAndMask:ipPrefixToAddrAndMask,getFirstInstance:getFirstInstance,getManagedAddressArray:function(arr){return arr.filter(function(e){return e.AddressOrigin})},getUnmanagedAddressArray:getUnmanagedAddressArray,prepareIPv4ModelForForm:function(model){var _ipPrefixToAddrAndMas,_ipPrefixToAddrAndMas2,_ipPrefixToAddrAndMas3,_ipPrefixToAddrAndMas4,ipv4=model.IPv4,st=ipv4.Static,dhcpServer=model.DHCPServer,dhcpv4=dhcpServer.DHCPv4,addrType=ipv4.AddressingType;"DHCP"==addrType||"Unknown"==addrType?(_ipPrefixToAddrAndMas=ipPrefixToAddrAndMask(getFirstInstance(ipv4.Address).IPAddress),_ipPrefixToAddrAndMas2=_slicedToArray(_ipPrefixToAddrAndMas,2),ipv4.__Address0=_ipPrefixToAddrAndMas2[0],ipv4.__Mask0=_ipPrefixToAddrAndMas2[1],"DHCP"==addrType&&(ipv4.__Gateway=ipv4.Gateway)):"Static"==addrType&&(_ipPrefixToAddrAndMas3=ipPrefixToAddrAndMask(st.IPAddress),_ipPrefixToAddrAndMas4=_slicedToArray(_ipPrefixToAddrAndMas3,2),ipv4.__Address0=_ipPrefixToAddrAndMas4[0],ipv4.__Mask0=_ipPrefixToAddrAndMas4[1],ipv4.__Gateway=ipv4.Static.Gateway),prepareDNSAddressesForForm(ipv4),ipv4.__AddressingTypesSupportedArray=getAddressingTypesSupportedArray(ipv4),dhcpv4.__Mode=getDHCPServerMode(dhcpServer),dhcpv4.__ReservationArray=multiObjectToArray(dhcpv4.Reservation),dhcpv4.__OptionsArray=multiObjectToArray(dhcpv4.Options),dhcpv4.__LeaseInMinutes=secToMin(dhcpv4.Lease),prepareDNSHostsModelForForm(dhcpv4),dhcpv4.__RelayArray=getRelayAddressArray(dhcpv4.Relay)},prepareIPv4ModelForSubmit:function(wdk,basePath){instNumGen=new InstNumGen;var first,model=funcs.findBranch(wdk.workTree,basePath),ipv4=model.IPv4,st=ipv4.Static,dhcpServer=model.DHCPServer,dhcpv4=dhcpServer.DHCPv4,addrType=ipv4.AddressingType;wdk.ignorePaths=[],"Static"==addrType?st.IPAddress=addrAndMaskToIPPrefix(ipv4.__Address0,ipv4.__Mask0):"Unknown"==addrType&&(first=getFirstInstance(ipv4.Address),first.IPAddress=addrAndMaskToIPPrefix(ipv4.__Address0,ipv4.__Mask0)),"Static"==addrType?st.Gateway=ipv4.__Gateway:"DHCP"==addrType&&wdk.ignorePaths.push(basePath+"IPv4.Static.Gateway"),lanPage.haveAPFeatures(ipv4)&&prepareDNSAddressesForSubmit(wdk,basePath+"IPv4."),"Static"==ipv4.AddressingType||"Unknown"==ipv4.AddressingType?prepareDHCPServerModelForSubmit(wdk,basePath+"DHCPServer."):wdk.ignorePaths.push(basePath+"DHCPServer"),showDNSServer(model)?prepareDNSHostsModelForSubmit(dhcpv4):wdk.ignorePaths.push(basePath+"DHCPServer.DHCPv4.Hosts")},prepareIPv6ModelForForm:function(model){var ipv6=model.IPv6,dhcpServer=model.DHCPServer,dhcpv6=dhcpServer.DHCPv6,addrType=ipv6.AddressingType;ipv6.__AddressingTypesSupportedArray=getAddressingTypesSupportedArray(ipv6),"Staticv6"==addrType?ipv6.__Gateway=ipv6.Static.Gateway:"DHCPv6"==addrType&&(ipv6.__Gateway=ipv6.Gateway),prepareDNSAddressesForForm(ipv6),ipv6.__AddressArray=getIPv6AddressArray(ipv6.Address),dhcpv6.__Mode=getDHCPv6ServerMode(dhcpServer),dhcpv6.__ReservationArray=multiObjectToArray(dhcpv6.Reservation),dhcpv6.__OptionsArray=multiObjectToArray(dhcpv6.Options),dhcpv6.__LeaseInMinutes=secToMin(dhcpv6.Lease),prepareDNSHostsModelForForm(dhcpv6),dhcpv6.__RelayArray=getRelayAddressArray(dhcpv6.Relay)},prepareIPv6ModelForSubmit:function(wdk,basePath){instNumGen=new InstNumGen;var model=funcs.findBranch(wdk.workTree,basePath),ipv6=model.IPv6,st=ipv6.Static,dhcpServer=model.DHCPServer,dhcpv6=dhcpServer.DHCPv6,addrType=ipv6.AddressingType;wdk.ignorePaths=[],"Staticv6"!=ipv6.AddressingType&&(ipv6.Address=getIPv6AddressMultiObject(ipv6.__AddressArray)),"Staticv6"==addrType?st.Gateway=ipv6.__Gateway:"DHCPv6"==addrType&&wdk.ignorePaths.push(basePath+"IPv6.Static.Gateway"),lanPage.haveAPFeatures(ipv6)&&prepareDNSAddressesForSubmit(wdk,basePath+"IPv6."),"DHCPv6"!=ipv6.AddressingType?prepareDHCPv6ServerModelForSubmit(wdk,basePath+"DHCPServer."):wdk.ignorePaths.push(basePath+"DHCPServer"),showDNSv6Server(model)?prepareDNSHostsModelForSubmit(dhcpv6):wdk.ignorePaths.push(basePath+"DHCPServer.DHCPv6.Hosts")},deleteItems:function(parent,name,inxs){parent[name]=parent[name].filter(function(_,i){return!inxs.includes(i)})},showDNSServer:showDNSServer,showDNSv6Server:showDNSv6Server,splitIPPrefix:splitIPPrefix,dnsHostAddressArrayToString:function(host){return host.__AddressArray.map(function(e){return e.IPAddress}).join(", ")},indexIPv6AddressArray:indexIPv6AddressArray,secToMin:secToMin,minToSec:minToSec,getReservationItemSecondaryLine:function(item){var arr=[];return arr.push(item.MACAddress?item.MACAddress:item.Hostname),item.Lease&&arr.push(secToMin(item.Lease)+" "+translate("units_minute")),arr.join(" | ")},getLeaseColumn:function(lease){return lease?secToMin(lease):""},openDHCPOptionsDialog:function(data,$scope){return ngDialog.open({template:"dialogs/dhcp_options/dialog.tpl.html",controller:"DHCPOptionsDialogCtrl",scope:$scope,data:data})},removeDNSAddress:function(ipvx,inx){ipvx.__DNSArray.splice(inx,1)},addDNSAddress:function(ipvx){ipvx.__DNSArray.push({IPAddress:""})},allowDeleteDNSAddress:function(ipvx){return ipvx.__DNSArray.length>1&&("DHCP"!=ipvx.AddressingType&&"DHCPv6"!=ipvx.AddressingType||!ipvx.DHCP.__DNSAuto)},validateDNSAddress:function(value,inx,dnsArray,ipVersion){if(value){if(!funcs.is[ipVersion](value))return"msg_invalid_"+ipVersion;if(dnsArray.filter(function(e,i){return i!=inx&&e.IPAddress&&funcs.is[ipVersion](e.IPAddress)&&0==funcs[ipVersion].address.compare(e.IPAddress,value)}).length)return"msg_error_value_is_not_uniq"}return null}}}}]);