"use strict";!function(){angular.module("app").service("macFilterUtil",["cpe","devinfo","device","funcs",function(cpe,devinfo,device,funcs){function getConfig(){return nativeConfig}function getAttrs(){return nativeAttrs}var nativeConfig=null,dsysinitConfig=null,nativeAttrs=null,dsysinitAttrs=null,__initNativeConfig=null,firewallPath="Device.Firewall.",Helper=device.macfilter.Helper,converter=device.macfilter.converter;return{getConfig:getConfig,getAttrs:getAttrs,pull:function(){function success(response){dsysinitConfig=funcs.buildTree(response[0].result.ParameterList),dsysinitAttrs=funcs.buildTreeAttributes(response[1].result.ParameterList);var client=response[2]?response[2].client:null;return nativeConfig=converter.dsysinitToNative.config({config:dsysinitConfig,client:client}),nativeAttrs=converter.dsysinitToNative.attrs({attrs:dsysinitAttrs}),__initNativeConfig=funcs.deepClone(nativeConfig),Promise.resolve()}return Promise.all([cpe.GetParameterValues([firewallPath]),cpe.GetParameterAttributes([firewallPath]),devinfo.once("client")]).then(success)},getClient:function(){return devinfo.once("client").then(function(response){return response&&response.client?converter.dsysinitToNative.config({client:response.client}):Promise.resolve()})},applyConfig:function(changed){function prepareConfig(init){return init.BaseRule.__ruleIdv4||delete init.BaseRule,init.Rules=prepareRules(init.Rules),converter.nativeToDsysinit.config(init)}function prepareRules(rules){var result=[];return _.each(rules,function(rule){var key=result.length;if(rule.__ruleId){var ids=funcs.deepClone(rule.__ruleId);rule.DestZone="fw",rule.__ruleId=ids[0],rule.Type="v4",result.push(rule);var tempRulev6=funcs.deepClone(rule);tempRulev6.Type="v6",tempRulev6.__ruleId=ids[1],result.push(tempRulev6)}else{rule.__ruleId="new_inst_"+key,rule.DestZone="fw",rule.Type="v4",result.push(rule);var tempRulev6=funcs.deepClone(rule);tempRulev6.Type="v6",result.push(tempRulev6)}}),result}changed.Rules=prepareRules(changed.Rules);var config=converter.nativeToDsysinit.config(changed),init=prepareConfig(__initNativeConfig),diff=funcs.newConfig.makeDiff(init,config,dsysinitAttrs);return cpe.ApplyDifference(diff)},makeHelper:function(){return new Helper}}}])}();