"use strict";!function(){angular.module("app").controllerProvider.register("SysNtpCtrl",["$scope","$state","systemNtpUtil","funcs","snackbars","SysNtpConstants","translate",function($scope,$state,util,funcs,snackbars,constants,translate){function init(){function success(){helper=util.makeHelper(),systemTime.data=helper.getData(),resident?(splitDSTData(systemTime.data.ntp.DSTStart,"Start"),splitDSTData(systemTime.data.ntp.DSTEnd,"End")):dsysinit&&(splitDSTData(systemTime.data.time.TimeZoneOverride.DaylightTime.StartDate,"Start"),splitDSTData(systemTime.data.time.TimeZoneOverride.DaylightTime.EndDate,"End"),systemTime.data.manualOffsetUTC="UTC"==systemTime.data.time.LocalTimeZone?!0:!1,systemTime.messages={manualOffsetMessage:convertOffsetToUTC(systemTime.data.time.TimeZoneOverride.Offset),manualOffsetMessageDST:convertOffsetToUTC(systemTime.data.time.TimeZoneOverride.DaylightTime.Offset)},formAllowedZonesIndex()),systemTime.data.ntp.DSTTimeZoneOffset=autoconf.BR2_PACKAGE_ANWEB_DSYSINIT?void 0:systemTime.data.ntp.DSTTimeZoneOffset,systemTime.data.TimeZoneIndex=-1,systemTime.data.DSTTimeZoneIndex=(autoconf.BR2_PACKAGE_ANWEB_DSYSINIT,-1),systemTime.timeStamp=helper.getTimeStamp(systemTime.data.time);var lastServer=_.last(systemTime.data.ntp.Servers);systemTime.id=lastServer&&lastServer.__id||0,systemTime.options={years:_.range(1970,2038),months:_.range(1,13),weeks:_.range(1,6),weekDays:constants.weekDays,days:_.range(1,32),hours:_.range(24),dstHours:getDstHours(),mins:_.range(60),timezones:resident?getTimeZones():null,DstTimezones:resident?getDSTTimeZones():void 0,pollInterval:autoconf.BR2_PACKAGE_ANWEB_DSYSINIT?helper.getPoolIntervalEnum():void 0,retryInterval:helper.getRetryIntervalEnum()},__backup=funcs.deepClone(systemTime.data),$scope.$watch("systemTime.time.Year",changeDaysRange),$scope.$watch("systemTime.time.Month",changeDaysRange),util.subscribeTime(function(time){systemTime.timeStamp=helper.getTimeStamp(time)},$scope)}function error(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"})}util.pull().then(success)["catch"](error)["finally"]($scope.$emit.bind($scope,"pageload"))}function unionDSTData(){if(_.has(systemTime.data,"DST")&&resident){var dst=systemTime.data.DST;systemTime.data.ntp.DSTStart="M"+dst.StartMonth+"."+dst.StartWeek+"."+dst.StartWeekDays.value+"/"+dst.StartHour,systemTime.data.ntp.DSTEnd="M"+dst.EndMonth+"."+dst.EndWeek+"."+dst.EndWeekDays.value+"/"+dst.EndHour}if(_.has(systemTime.data,"time")&&"UTC"==systemTime.data.time.LocalTimeZone&&dsysinit&&systemTime.data.time.TimeZoneOverride.DaylightTime.Enable){var dst=systemTime.data.DST;systemTime.data.time.TimeZoneOverride.DaylightTime.StartDate="M"+dst.StartMonth+"."+dst.StartWeek+"."+dst.StartWeekDays.value+"/"+dst.StartHour,systemTime.data.time.TimeZoneOverride.DaylightTime.EndDate="M"+dst.EndMonth+"."+dst.EndWeek+"."+dst.EndWeekDays.value+"/"+dst.EndHour}}function splitDSTData(data,point){function getWeekDay(day){return _.findWhere(constants.weekDays,{value:day})}if(data){var arr=data.split("/"),arr2=arr[0].split(".");systemTime.data.DST=systemTime.data.DST||{},systemTime.data.DST[point+"Hour"]=arr[1],systemTime.data.DST[point+"Month"]=Number(arr2[0].split("M")[1]),systemTime.data.DST[point+"Week"]=Number(arr2[1]),systemTime.data.DST[point+"WeekDays"]=getWeekDay(arr2[2])}}function deteremineTimezone(){if(resident){var offset=(100*-((new Date).getTimezoneOffset()/60)/100).toFixed(2),arrOffset=offset.split(".");systemTime.data.ntp.TimeZoneOffset=helper.unionOffset(arrOffset[0],arrOffset[1])}else dsysinit&&(systemTime.data.time.LocalTimeZone=Intl.DateTimeFormat().resolvedOptions().timeZone)}function changeDaysRange(optionYear,optionMonth){function getMonthDays(year,month){return new Date(year,month,0).getDate()}function getLastDay(){return systemTime.options.days.slice(-1)[0]}var time=systemTime.data.time,year=optionYear?optionYear:time.Year,month=optionMonth?optionMonth:time.Month;systemTime.options.days=_.range(1,getMonthDays(year,month)+1);var lastDay=getLastDay();time.Day>lastDay&&(time.Day=lastDay)}function getTimeZones(){function getSign(zone){return"-"==zone.offset[0]?"-":"+"}return[{name:translate("ntp_change_main"),index:-1}].concat(_.map(constants.zones,function(zone,index){return{index:index,sign:getSign(zone),name:zone.name,offset:zone.offset}}))}function getDSTTimeZones(){function getSign(zone){return"-"==zone.offset[0]?"-":"+"}return[{name:translate("ntp_change_summer"),index:-1}].concat(_.map(constants.zones,function(zone,index){return{index:index,sign:getSign(zone),name:zone.name,offset:zone.offset}}))}function getDstHours(){for(var hours=[],i=0;24>=i;i++)hours.push(10>i?"0"+i+":00":i+":00");return hours}function delTimezonesFromDroplist(list,delList){return list.filter(function(e){var isEqualToCurrentElem=function(d){return d==e.value};return delList.some(isEqualToCurrentElem)?void 0:e})}function formAllowedZonesIndex(){return util.getTimezonesList().map(function(obj){timezonesIndex[obj.name]=!0})}function convertOffsetToUTC(min){if(!_.isFinite(min))return translate("ntp_dsysinit_offset_calc")+":";if(!min)return translate("ntp_dsysinit_offset_calc")+": UTC Â±0:00";var sign=min>0?"+":"-",h=Math.abs(Math.floor(Math.abs(min)/60)),m=Math.abs(min)-60*Math.abs(h);return Math.abs(m)<10?m="0"+m:m,translate("ntp_dsysinit_offset_calc")+": UTC "+sign+h+":"+m}$scope.systemTime={data:null,id:0,timeStamp:null,options:null,apply:function(){function success(){snackbars.add("msg_apply_success"),init(),lastTimezone=void 0}function error(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})}if(!$scope.ntpSettings.$invalid){if(dsysinit&&!timezonesIndex[systemTime.data.time.LocalTimeZone])return void alert(translate("ntp_dsysinit_invalid_timezone"));systemTime.data.ntp.Enable?unionDSTData():null;var config=helper.formConfig(systemTime.data);if(config.Device.Services.NTP.Enable&&_.isEmpty(config.Device.Services.NTP.Servers)&&!config.Device.Services.NTP.DHCPServers)return void alert(translate("ntp_empty_ntp_server"));var overlay=$scope.overlay.circular,overlayId=overlay.start();util.apply(config).then(success)["catch"](error)["finally"](overlay.stop.bind(overlay,overlayId))}},addServer:function(){$scope.systemTime.focus=!0,systemTime.data.ntp.Servers.push({address:"",__id:++systemTime.id})},removeServer:function(inx){systemTime.data.ntp.Servers.splice(inx,1)},deteremineTimezone:deteremineTimezone,setLocalTime:function(){var local=new Date,time=systemTime.data.time;time.Year=local.getFullYear(),time.Month=local.getMonth()+1,time.Day=local.getDate(),time.Hour=local.getHours(),time.Minute=local.getMinutes()},isShowServerList:function(){return systemTime.data&&systemTime.data.ntp.Enable&&!systemTime.data.ntp.DHCPServers},isSupportedNtp:function(param){return systemTime.data&&_.has(systemTime.data.ntp,param)},wasModified:function(){return __backup&&!funcs.deepEqual(__backup,systemTime.data)},formatGMT:function(offset){return offset?"00:00"==offset?"GMT":"GMT".concat(offset):""},noteGMT:function(offset){return _.filter(constants.zones,function(zone){return offset==zone.offset})},validation:function(address,id){var check=_.some(systemTime.data.ntp.Servers,function(elem){return address&&address==elem.address&&id!=+elem.__id&&!elem.isDynamic?!0:null});return check?"msg_error_value_is_not_uniq":null},changeRetryType:function(){systemTime.data.ntp.RetryInterval=0==systemTime.data.ntp.RetryType?0:""},isDynamicCheck:function(){return systemTime.data.ntp.Servers.some(function(o){return o.isDynamic})},getTimezonesList:function(){var fullList=util.proceedListForSelect(util.getTimezonesList()),retList=delTimezonesFromDroplist(fullList,timezonesToExclude);return retList},delTimezonesFromDroplist:delTimezonesFromDroplist,convertOffsetToUTC:convertOffsetToUTC,formAllowedZonesIndex:formAllowedZonesIndex};var helper,lastTimezone,systemTime=$scope.systemTime,__backup=null,resident=autoconf.BR2_PACKAGE_ANWEB_RESIDENT,dsysinit=autoconf.BR2_PACKAGE_ANWEB_DSYSINIT,timezonesToExclude=["UTC","Etc/UTC"],timezonesIndex={};init(),resident?($scope.$watch("systemTime.data.TimeZoneIndex",function(value){value>=0&&(systemTime.data.ntp.TimeZoneOffset=systemTime.options.timezones[value+1].offset,systemTime.data.TimeZoneIndex=-1)}),$scope.$watch("systemTime.data.DSTTimeZoneIndex",function(value){value>=0&&(systemTime.data.ntp.DSTTimeZoneOffset=systemTime.options.timezones[value+1].offset,systemTime.data.DSTTimeZoneIndex=-1)})):dsysinit&&($scope.$watch("systemTime.data.time.LocalTimeZone",function(value){!_.isNull(systemTime.data)&&value&&"UTC"!==value&&(systemTime.data.time.TimeZoneOverride.DaylightTime.Enable=!1,systemTime.data.manualOffsetUTC=!1)}),$scope.$watch("systemTime.data.manualOffsetUTC",function(value,oldval){value!==oldval&&void 0!==oldval&&(value?(lastTimezone=systemTime.data.time.LocalTimeZone,systemTime.data.time.LocalTimeZone="UTC"):value||void 0===lastTimezone||(systemTime.data.time.LocalTimeZone=lastTimezone,systemTime.data.time.TimeZoneOverride.DaylightTime.Enable=!1),value||deteremineTimezone())}),$scope.$watch("systemTime.data.time.TimeZoneOverride.Offset",function(value){systemTime.data&&(systemTime.messages.manualOffsetMessage=convertOffsetToUTC(value))}),$scope.$watch("systemTime.data.time.TimeZoneOverride.DaylightTime.Offset",function(value){systemTime.data&&(systemTime.messages.manualOffsetMessageDST=convertOffsetToUTC(value))})),$scope.$watch("systemTime.data.time.Month",function(value){value&&changeDaysRange(null,value)}),$scope.$watch("systemTime.data.time.Year",function(value){value&&changeDaysRange(value,null)}),$scope.checkFirefoxVersion=function(){return/Firefox\/5./.test(navigator.userAgent)?"padding-top-dateTimeBlock":void 0},$scope.getIfaceName=function(name){return"wan_auto"==name?translate(name):name}}])}();