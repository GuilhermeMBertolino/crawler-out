"use strict";function _createForOfIteratorHelper(o,allowArrayLike){var i,F,it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length)return it&&(o=it),i=0,F=function(){},{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it["return"]||it["return"]()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){var i,arr2;for((null==len||len>arr.length)&&(len=arr.length),i=0,arr2=new Array(len);len>i;i++)arr2[i]=arr[i];return arr2}!function(){function ContentToggle(){}function ClientsTable(){this.clean()}function initNavigation($scope){$scope.ipv4ipv6Toggle=(new ContentToggle).initializeState("ipv4").select(["selected"]).unselect(["unselected"]).addHandler("selectIpv4Table","ipv4").addHandler("selectIpv6Table","ipv6"),$scope.infoToggle=(new ContentToggle).initializeState("internetInfo").select(["icon-selected"]).unselect(["icon"]).addHandler("showInternetInfo","internetInfo").addHandler("showRouterInfo","routerInfo").addHandler("showClientsInfo","clientsInfo"),$scope.info={},$scope.info.sigLevelFlag=!0,$scope.isInternetConnected=function(){return $scope.info.wan?"connected"===$scope.info.wan.ipv4.networkStatus||"connected"===$scope.info.wan.ipv6.networkStatus:!1}}angular.module("app").controllerProvider.register("HomeCtrl",["$scope","$rootScope","$injector","ngDialog","translate","snackbars","HQHomeUtil",function($scope,$rs,$injector,ngDialog,translate,snackbars,HQHomeUtil){function updateWithMessage(cb){var overlayId=$rs.overlay.circular.start();push(function(err){return err?($rs.overlay.circular.stop(overlayId),void snackbars.add("msg_rpc_write_error")):(snackbars.add("msg_rpc_write_success"),pull(cb),void $rs.overlay.circular.stop(overlayId))})}function getOnNetworks(list){return _.chain(list).mapObject(function(band){return _.extend({},band,{List:_.pick(band.List,function(item){return item.Enable})})}).pick(function(band){return _.size(band.List)}).value()}function pull(cb){return Promise.all([function(){return new Promise(function(cb){wifiMacFilter.pull(function(){var data=wifiMacFilter.data();$scope.networksFullList=data.Networks,$scope.networks=getOnNetworks(data.Networks),$scope.rules=data.Rules,$scope.maxRulesCount=data.MaxRulesCount,cb()})})}(),function(){return Promise.resolve()}()]).then(function(){cb&&cb(),$scope.isReady=!0,$scope.$emit("pageload")})}function push(cb){wifiMacFilter.push(cb)}function getFilterPrototype(mac,ipv4,ipv6,hostname,ssid,band,network){var Band,dataNetworks,dataNetvorks,Network,deny,isOff=!1;return band||network||!ssid?(Band=band,Network=network,band&&network?(deny="deny"==wifiMacFilter.data().Networks[band].List[network].AccessPolicy,isOff="off"==wifiMacFilter.data().Networks[band].List[network].AccessPolicy):(dataNetvorks=getOnNetworks(wifiMacFilter.data().Networks),Band=_.keys(dataNetvorks)[0]||"1",Network=dataNetvorks[Band]&&_.keys(dataNetvorks[Band].List)[0]||"1")):(dataNetworks=wifiMacFilter.data().Networks,_.each(dataNetworks,function(networks,bandId){var listNetwork=networks.List;_.each(listNetwork,function(wifi,inx){wifi.SSID==ssid&&(deny="deny"==wifi.AccessPolicy?!0:!1,"off"==wifi.AccessPolicy&&(isOff=!0),Band=bandId,Network=inx)})})),{Enable:!0,MAC:mac||"",Hostname:hostname||"",ssid:ssid||"",Band:Band,Network:Network,deny:deny,off:isOff,IPv4:ipv4||"",IPv6:ipv6||""}}function openDialogWireless(item,inx,isNew){return ngDialog.open({template:"dialogs/wifi_mac_edit_simple/dialog.tpl.html",className:"wifi_mac_edit_dialog",controller:WifiMacEditSimpleDialogCtrl,data:{rule:item,inx:inx,isNew:isNew},scope:$scope})}function readClientsTable(connectedWifiCleints,wifiRules,lanClients){var clientsTable=new ClientsTable;return $scope.info.connectedClients=0,_.isEmpty(wifiRules)||_.isEmpty(lanClients)||clientsTable.extend(readClientsByRules(wifiRules)),connectedWifiCleints&&connectedWifiCleints.forEach(function(client){var selectedClient,addClient=getFilterPrototype(client.MAC,client.IPv4,client.IPv6,client.Hostname,client.SSID),existingClient=$scope.getRuleIndexByMacBandNetwork(wifiRules,addClient.MAC,addClient.Band,addClient.Network);existingClient?(selectedClient=clientsTable.find(addClient.MAC,addClient.Band,addClient.Network),null!=selectedClient?selectedClient.online=!0:clientsTable.add(addClient)):(addClient.online=!0,addClient.enable=!1,$scope.info.connectedClients+=1,clientsTable.add(addClient))}),clientsTable.add({isClientAddTag:!0}),clientsTable.filter($scope.networks),clientsTable.items=_.flatten(clientsTable.rows),clientsTable.items.sort(function(a,b){return b.online}),clientsTable}function readClientsByRules(rules){var clients=[];return _.each(rules,function(rule){var newClient={};newClient.MAC=rule.MAC,newClient.Hostname=rule.Hostname,newClient.enable=rule.Enable,newClient.Band=rule.Band,newClient.Network=rule.Network,newClient.deny="deny"==wifiMacFilter.data().Networks[rule.Band].List[rule.Network].AccessPolicy,clients.push(newClient)}),clients}initNavigation($scope);var wifiMacFilter=$scope.device.wifiMacFilter;$scope.update=updateWithMessage,pull(),HQHomeUtil.init({sigLevelFlag:$scope.info.sigLevelFlag,handler:function(data){_.extend($scope.info,data),$scope.info.clientsTable=readClientsTable($scope.info.wifiClients,$scope.rules,$scope.info.lanClients),$scope.isActivated||($scope.isActivated=!0,$scope.overlay.preloader.stop(),$scope.info.isAPMode&&$scope.infoToggle.showRouterInfo())}}),$scope.isMoreThanOneBand=function(){return $scope.info.wifi&&$scope.info.wifi.f5.exists},$scope.isEmptyNetwork=function(){return!$scope.networks||0===_.size($scope.networks)},$scope.getRuleByMac=function(mac){return _.find($scope.rules,function(rule){return rule.MAC.toUpperCase()===mac.toUpperCase()})},$scope.getRuleIndexByMacAndSsid=function(mac,ssid){return _.findKey($scope.rules,function(rule){return rule.MAC.toUpperCase()===mac.toUpperCase()&&void 0!=rule.ssid&&rule.ssid==ssid})},$scope.getRuleIndexByMac=function(mac){return _.findKey($scope.rules,function(rule){return rule.MAC.toUpperCase()===mac.toUpperCase()})},$scope.getRuleIndexByMacBandNetwork=function(rules,mac,band,network){return _.findKey(rules,function(rule){return rule.MAC.toUpperCase()===mac.toUpperCase()&&rule.Band==band&&rule.Network==network})},$scope.addClient=function(){var msgMaxRules;!$scope.maxRulesCount||_.size($scope.rules)<$scope.maxRulesCount?openDialogWireless(getFilterPrototype(),-1,!0):(msgMaxRules=translate("wifi_mac_max_rules_message").replace(/<MAX_RULES>/,$scope.maxRulesCount),alert(msgMaxRules))},$scope["delete"]=function(client){var indexOfExistedRule=$scope.getRuleIndexByMac(client.MAC);indexOfExistedRule&&(wifiMacFilter.cut(indexOfExistedRule),updateWithMessage())},$scope.edit=function(client){var indexOfExistedRule;if(client.Band&&client.Network)indexOfExistedRule=$scope.getRuleIndexByMacBandNetwork($scope.rules,client.MAC,client.Band,client.Network);else var indexOfExistedRule=$scope.getRuleIndexByMacAndSsid(client.MAC,client.ssid);indexOfExistedRule?openDialogWireless(getFilterPrototype(client.MAC,client.Hostname,client.ssid,client.Band,client.Network),indexOfExistedRule,!1):openDialogWireless(getFilterPrototype(client.MAC,client.Hostname,client.ssid,client.Band,client.Network),-1,!0)},$scope.getIpv6=function(){return $scope.info.wan.ipv6.ip||translate("unknown")},$scope.isMobileConn=function(){return"lte"==$scope.info.wan.ipv4.connectionType||"mobileinet"==$scope.info.wan.ipv4.connectionType},$scope.trimLetters=function(value,start,end){if(!_.isString(value))return value;var output=value;if(start){var r=new RegExp("^".concat(start,"+"),"g");output=output.replace(r,"")}if(end){var _r=new RegExp("".concat(end,"+$"),"g");output=output.replace(_r,"")}return output}}]),ContentToggle.prototype.initializeState=function(state){return this.state=state,this},ContentToggle.prototype.addHandler=function(name,state){return this[name]=function(){this.state=state},this},ContentToggle.prototype.select=function(classes){return this.selected=classes,this},ContentToggle.prototype.unselect=function(classes){return this.unselected=classes,this},ClientsTable.prototype.clean=function(){this.length=0,this.rows=[[]]},ClientsTable.prototype.add=function(client){0!==this.length&&this.length%3===0&&this.rows.push([]),this.rows[this.rows.length-1].push(client),this.length++},ClientsTable.prototype.extend=function(clients){var i,len;for(i=0,len=clients.length;len>i;i++)this.add(clients[i])},ClientsTable.prototype.find=function(mac,band,network){var finded=null;return _.each(this.rows,function(row){_.each(row,function(client){mac.toUpperCase()===client.MAC.toUpperCase()&&(band?band==client.Band&&(network?network==client.Network&&(finded=client):finded=client):finded=client)})}),finded},ClientsTable.prototype.filter=function(networkList){var networkList=_.pick(networkList,function(network){return _.some(network.List,function(item){return item.Enable})}),listClient=_.flatten(this.rows,!0);this.clean(),_.each(listClient,function(client){this.add(client)},this)}}();