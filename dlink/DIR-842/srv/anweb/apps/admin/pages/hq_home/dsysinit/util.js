"use strict";!function(){angular.module("app").service("HQHomeUtil",["devinfo","device","funcs","macFilterUtil","cookie",function(devinfo,device,funcs,macFilterUtil,cookie){function readWifiInfo(wifi_general){if(wifi_general){var wifi={};return _.each(["f24","f5"],function(frequency){wifi[frequency]={exists:wifi_general[frequency].exists,status:wifi_general[frequency].radio,ssid:wifi_general[frequency].ssid,password:wifi_general[frequency].WPAPSK,authMode:wifi_general[frequency].authMode}}),wifi}}function getWifiClients(response){var converter=device.wifiClientMgm.converter,wifiClientsMgm24=funcs.splitTree(response[constants.wifiClientsMgm24]),wifiInfo=funcs.splitTree(response[constants.wifiInfo]),servers=funcs.splitTree(funcs.fetchBranch(response[constants.network],constants.servers),constants.servers),wifiClientsMgm5=funcs.splitTree(response[constants.wifiClientsMgm5]),hostnames=funcs.splitTree(response[constants.hostnames]),easyMesh=funcs.splitTree(response[constants.easyMesh]),emTopology=funcs.splitTree(response[constants.emTopology]),ipAddress=funcs.splitTree(response[constants.dhcpStats]),input=funcs.buildTree(wifiClientsMgm24.concat(wifiClientsMgm5,wifiInfo,servers,hostnames,easyMesh,emTopology,ipAddress)),data=converter.dsysinitToNative(input);return formClients(data)}function formClients(data){var emClientsList;return data.EasyMesh&&data.EasyMesh.Enable&&data.EmTopology&&(emClientsList=[],_.each(data.EmTopology,function(elem){var stationInfo=funcs.newConfig.normalize(elem.StationInfo);_.each(stationInfo,function(client){emClientsList.push(client.MACAddress.toUpperCase())})}),data.Clients=_.filter(data.Clients,function(client){return _.find(emClientsList,function(elem){return elem==client.MAC})})),data.Clients}function readWanInfo(response){var dns,connLink,conn,duration_s,routes,route,dnsCur,dnsArr,subconnLink,ipv4gw=response.ipv4gw||{},ipv6gw=response.ipv6gw||{},apClient=response.apClient||{},network=response[constants.network],routing=response[constants.routing],uptime=response.uptime,wan={ipv4:{},ipv6:{},dns:{},sigLevelFlag:!1};if(network&&routing)if(dns=funcs.fetchBranch(network,constants.dns),ipv4gw?(connLink=ipv4gw.__connection_link,conn=funcs.fetchBranch(network,connLink),duration_s=!_.isUndefined(conn.ConnectTimeStamp)&&uptime?uptime-conn.ConnectTimeStamp:void 0,"Connected"!=ipv4gw.status&&(ipv4gw.gateway=null,ipv4gw.ip=null,ipv4gw.mask=null,ipv4gw.dns_primary=null,ipv4gw.dns_secondary=null,duration_s=null),wan.ipv4.connectionType=ipv4gw.contype,wan.ipv4.networkStatus=getWanStatus(ipv4gw.status),wan.ipv4.connectionUptime=duration_s?getUptimePrepared(duration_s):getUptimePrepared(),wan.ipv4.mac=ipv4gw.mac,wan.ipv4.ip=ipv4gw.ip,wan.ipv4.mask=ipv4gw.mask,ipv4gw.gateway?wan.ipv4.gateway=ipv4gw.gateway:(routes=funcs.fetchBranch(routing,constants.routing+"IPv4.Routes."),route=_.findWhere(routes,{Interface:conn.Interface,Destination:"0.0.0.0/0"}),wan.ipv4.gateway=route&&route.GatewayIPAddress),dnsCur=_.findWhere(dns,{Origin:connLink}),dnsCur?(dnsArr=_.values(funcs.newConfig.normalize(dnsCur.Address)),wan.ipv4.primaryDnsServer=dnsArr[0]&&dnsArr[0].IPAddress,wan.ipv4.secondaryDnsServer=dnsArr[1]&&dnsArr[1].IPAddress):(wan.ipv4.primaryDnsServer=ipv4gw.dns_primary,wan.ipv4.secondaryDnsServer=ipv4gw.dns_secondary)):(wan.ipv4.connectionUptime=getUptimePrepared(),wan.ipv4.networkStatus="apps_hq_admin_conn_not_created"),ipv6gw){var connLink=ipv6gw.__connection_link;subconnLink=ipv6gw.__sub_connection_link;var conn=funcs.fetchBranch(network,connLink),duration_s=!_.isUndefined(conn.ConnectTimeStamp)&&uptime?uptime-conn.ConnectTimeStamp:void 0;if("Connected"!=ipv6gw.status&&(ipv6gw.gatewayv6=null,ipv6gw.ipv6=null,ipv6gw.dns_primaryv6=null,ipv6gw.dns_secondaryv6=null,duration_s=null),wan.ipv6.connectionType=ipv6gw.contype,wan.ipv6.networkStatus=getWanStatus(ipv6gw.status),wan.ipv6.connectionUptime=duration_s?getUptimePrepared(duration_s):getUptimePrepared(),"Connecting"==ipv6gw.status&&"wifi"==ipv6gw.ifacetype&&(wan.ipv6.networkStatus=getWanStatus(apClient.ApCliConnect?"DHCPIPNotReceived":"WiFiDisconnected")),wan.ipv6.ip=ipv6gw.ipv6,ipv6gw.gatewayv6)wan.ipv6.gateway=ipv6gw.gatewayv6;else{var routes=funcs.fetchBranch(routing,constants.routing+"IPv6.Routes."),route=_.findWhere(routes,{Interface:conn.Interface,Destination:"::/0"});wan.ipv6.gateway=route&&route.GatewayIPAddress}var dnsCur=_.find(dns,function(elem){return subconnLink?elem.Origin==subconnLink:elem.Origin==connLink});if(dnsCur){var dnsArr=_.values(funcs.newConfig.normalize(dnsCur.Address));wan.ipv6.primaryDnsServer=dnsArr[0]&&dnsArr[0].IPAddress,wan.ipv6.secondaryDnsServer=dnsArr[1]&&dnsArr[1].IPAddress}else wan.ipv6.primaryDnsServer=ipv6gw.dns_primaryv6,wan.ipv6.secondaryDnsServer=ipv6gw.dns_secondaryv6}else wan.ipv6.connectionUptime=getUptimePrepared(),wan.ipv6.networkStatus="apps_hq_admin_conn_not_created";else wan.ipv4.connectionUptime=getUptimePrepared(),wan.ipv6.connectionUptime=getUptimePrepared();return wan}function readLanInfo(response){var ipv6,ip,ipv6Info,lanInfo=response.lan&&response.lan[0],network=response[constants.network],lan={ipv4:{},ipv6:{}};return lanInfo&&(lan.ipv4.mac=lanInfo.mac,lan.ipv4.ip=lanInfo.ip,lan.ipv4.mask=lanInfo.mask,lanInfo.ipv6&&(ipv6=lanInfo.ipv6.split("/"),lan.ipv6.ip=ipv6[0],lan.ipv6.assignedPrefix=ipv6[1])),network&&(ip=funcs.fetchBranch(network,lanInfo.ipLink),ipv6Info=_.find(funcs.newConfig.normalize(ip.IPv6Address),function(elem){return elem.IPAddress==lanInfo.ipv6}),lan.ipv6.addressingMode=ipv6Info&&ipv6Info.AddressingType),lan}function getWanStatus(status){var key=null;switch(status){case"Disabled":key="st_disabled";break;case"Connected":key="connected";break;case"kabinet_not_started":case"Disconnected":key="disconnected";break;default:status&&(status=status.replace(/PPP|WiFi|USB|DHCP|IP|SIM/g,function(i){return i[0]+i.slice(1).toLowerCase()}),key="wan_status_"+status.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase())}return key}function getUptimePrepared(s){var result={};return result.d=s/86400|0,result.h=formatTimeElement(s%86400/3600|0),result.m=formatTimeElement(s%3600/60|0),result.s=formatTimeElement(s%60|0),result}function formatTimeElement(n){return n>9?n:"0"+n}var devMode=cookie.get("device_mode"),constants={wifiInfo:"Device.WiFi.",network:"Device.Network.",routing:"Device.Routing.",usb:"Device.USB.Connection.",hostnames:"Device.Hostnames.",servers:"Device.Network.Server.",dns:"Device.Network.DNS.Current.",wifiClientsMgm24:"Device.Statistics.WiFi.Radio.1.AccessPoint.",wifiClientsMgm5:"Device.Statistics.WiFi.Radio.2.AccessPoint.",neighbours:"Device.Statistics.Neighbours.",easyMesh:"Device.Services.EasyMesh.",emTopology:"Device.Statistics.EasyMesh.Topology.",dhcpStats:"Device.Statistics.DHCPServer.1.Client."},configPaths=[constants.wifiInfo,constants.wifiClientsMgm24,constants.hostnames,constants.network,constants.routing,constants.dhcpStats];configPaths.push(constants.wifiClientsMgm5),"ap"!=devMode&&(configPaths.push(constants.easyMesh),configPaths.push(constants.emTopology));var areas=["wifi_general","net","version","notice"],data={};return{init:function(params){var handler=params.handler;data.sigLevelFlag=params.sigLevelFlag,devinfo.init({min_interval:4,timeout:1e4});var areasAndRpc=_.union(areas,configPaths).join("|");devinfo.onceAndSubscribe(areasAndRpc,function(response){!response||Object.keys(response).length<=1||(data.modelName=response.modelName,data.supportMail=response.supportMail,data.supportTel=response.supportTel,data.wifi=readWifiInfo(response.wifi_general),data.isAPMode="ap"==response.deviceMode,data.wifiClients=getWifiClients(response),data.wan=readWanInfo(response,data.sigLevelFlag),data.lan=readLanInfo(response),data.sigLevelFlag=data.wan.sigLevelFlag,handler(data))})}}}])}();