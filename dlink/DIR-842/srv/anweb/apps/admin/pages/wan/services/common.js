"use strict";angular.module("app").factory("wanPageCommon",["translate","pageDetails","$state","navigationFilter","funcs","navShared",function(translate,pageDetails,$state,navigationFilter,funcs,navShared){function getOriginText(conn){return translate({AutoConfigured:"wan_ipv6_auto_configured",AutoConfiguredByDHCPv6:"wan_ipv6_auto_configured_by_dhcp_v6",AutoConfiguredBySlaac:"wan_ipv6_auto_configured_by_slaac",Auto:"wan_ipv6_auto_configured"}[conn.Origin])}function getIPAddress(conn){return conn.StaticIPAddress0?conn.StaticIPAddress0:conn.IPAddress?conn.IPAddress:""}function getIPv6Address(conn){return conn.StaticIPv6Address0?conn.StaticIPv6Address0:conn.IPv6Address?conn.IPv6Address:""}function conflictsByMedia(conn1,conn2){return conn1.MediaPath!=conn2.MediaPath?!1:-1!=conn1.__Type.indexOf("PPP")||-1!=conn2.__Type.indexOf("PPP")?!1:"IPv6oE"==conn1.__Type&&"IPv4oE"==conn2.__Type||"IPv4oE"==conn1.__Type&&"IPv6oE"==conn2.__Type?!1:"DSL.ATM"==conn1.MediaType?!0:"Bridge"==conn1.__Type&&"IPv4oE"==conn2.__Type?!1:"IPv4oE"==conn1.__Type&&"IPv4oE"==conn2.__Type||"IPv6oE"==conn1.__Type&&"IPv6oE"==conn2.__Type?!0:function(conn1,conn2){function hasTag(conn){return!!(conn.VLAN&&conn.VLAN.Enable&&conn.VLAN.ID)}var isTaggedConn1=hasTag(conn1),isTaggedConn2=hasTag(conn2);return isTaggedConn1||isTaggedConn2?isTaggedConn1&&isTaggedConn2&&conn1.VLAN.ID==conn2.VLAN.ID?!0:!1:!0}(conn1,conn2)}function fillGeneralTemplPart(conn,contype,data){conn.Name=funcs.generateName(contype),conn.Enable=!0,conn.__Type=getInternalType(contype),conn.Flags={RIP:!1,IGMP:getFlagIGMP(contype,data.__flatConnList),NAT:!["dynipv6","statipv6","pppoev6","bridge","ipipv6","6in4","6to4","6rd"].includes(contype),NATv6:["dynipv6","statipv6","pppoev6","pppoedual"].includes(contype)&&!!autoconf.BR2_PACKAGE_ANWEB_CUSTOM_WW_39630,NATv6Hide:!["dynipv6","statipv6","pppoev6","pppoedual","l2tpdual"].includes(contype),Firewall:"bridge"!=contype,Ping:autoconf.BR2_PACKAGE_ANWEB_CUSTOM_CONVEX_44043||autoconf.BR2_PACKAGE_ANWEB_WAN_ENABLE_PING_DEFAULT?!0:!1,RTSP:!1,AltRoutingTable:!1,MLD:!1,ProxyARP:autoconf.BR2_PACKAGE_ANWEB_SUPPORT_ARP_PROXY?!1:void 0}}function getFlagIGMP(contype,listConns,conflicts){return"dynip"!=contype&&"statip"!=contype&&"ipoa"!=contype?!1:function(list,conflicts){return!!list.find(function(conn){return conn.Flags&&conn.Flags.IGMP?conflicts&&-1!=conflicts.indexOf(conn.__Path)?!1:!0:!1})}(listConns,conflicts)?!1:!0}function fillIpv4TemplPart(conn,contype){var vendorID=autoconf.BR2_PACKAGE_ANWEB_WAN_DYNIP_DEFAULT_VENDER_ID||"dslforum.org";["dynip","lte","mobileinet"].indexOf(contype)>=0?(conn.DNSAutomatical=!0,conn.AddressingType="DHCP",conn.VendorID=vendorID,conn.WithoutAuth=!0):("statip"==contype||"ipoa"==contype)&&(conn.AddressingType="Static",conn.VendorID=vendorID)}function fillIpv6TemplPart(conn,contype){["dynipv6","pppoev6","pppoedual","l2tpdual"].indexOf(contype)>=0?(conn.Origin="AutoConfigured",conn.GatewayIPAddressBySlaac=!0,conn.DNSIPv6Automatical=!0,conn.RequestPrefixes="Auto"):"statipv6"==contype?conn.Origin="Static":"mobileinet"==contype&&(conn.DNSIPv6Automatical=!0)}function fillPppTemplPart(conn,contype){isPpp(contype)&&(["pppoe","pppoev6","pppoedual","pppoa"].indexOf(contype)>=0?conn.MaxMRUSize=1492:"pptp"==contype||"l2tp"==contype||"l2tpdual"==contype||"l2tpoveripsec"==contype?(conn.MaxMRUSize=1456,conn.ActualType=contype.toUpperCase(),"pptp"==contype&&(conn.PPPMPPC=!0)):("3g"==contype||"mobileinet"==contype)&&(conn.MaxMRUSize=1370),conn.AuthenticationProtocol="AUTO",conn.EncryptionProtocol="None",conn.KeepAlive=!0,conn.LCPEcho=30,conn.LCPEchoRetry=3,conn.IPExtension=!1,conn.PPPDebug=!1,conn.WithoutAuth=!1,conn.ConnectionTrigger="AlwaysOn",conn.DNSAutomatical=!0,conn.IdleDisconnectTime=30)}function fillIPsecTemplPart(conn,contype){"l2tpoveripsec"==contype&&(conn.IPsec={Key:"",PFS:!0,PortEnabled:!1,Port:"1701",Type:"transport",DPD:"restart",DPDDelay:30,DPDTimeOut:120})}function addCreatedIfacesToMedia(){}function fillMediaTemplPart(conn,contype,data){function getMediaPath(availableIfaces){var firstIface=availableIfaces[0];return firstIface.path}conn.__AvailableIfaces=getAvailableIfaces(data,contype),conn.__AvailableIfaces.length&&(conn.MediaPath=getMediaPath(conn.__AvailableIfaces),conn.MediaType=getMediaType(conn.MediaPath),conn.Media={DSL:{ATM:{},PTM:{}},Ethernet:{},Bridging:{},WiFi:{},Dongle:{},FullIfaceList:{}})}function fillUsbModemTemplPart(conn,contype){"mobileinet"==contype&&(conn.Mode="auto",conn.WithoutAuth=!0,conn.AuthenticationProtocol="auto",conn.Version="IPv4"),"lte"==contype&&(conn.AuthenticationProtocol="pap",conn.WithoutAuth=!0)}function fillIpIp6TemplPart(conn){conn.Mode=autoconf.BR2_PACKAGE_ANWEB_WAN_IP_IPV6_TUNNEL_DSLITE_MODE?"dslite":"ipip6",conn.PeerIPv6="",conn.PeerIPv6Type="ipv6",conn.MRUAuto=!0}function fillSITTemplPart(conn,contype){conn.MRUAuto=!0,"6rd"==contype&&(conn.Mode="6rd",conn.PeerIP="",conn.IPv6rdPrefix="",conn.IPv6rdPrefixLen=32,conn.IPv6rdOption=!0,conn.IPv6rdHubAndSpoke=!1,conn.IPv6rdIPv4MaskLen=0),"6to4"==contype&&(conn.PeerIP="192.88.99.1",conn.Mode="6to4"),"6in4"==contype&&(conn.PeerIP="",conn.Mode="6in4",conn.VPNIPv6="",conn.PeerVPNIPv6="",conn.RoutedPrefix="")}function getInternalType(contype){switch(contype){case"pppoe":return"PPPoE";case"pppoev6":return"PPPoEv6";case"pppoedual":return"PPPoEDual";case"pppoa":return"PPPoA";case"pptp":return"PPTP";case"l2tp":return"PPTP";case"l2tpdual":return"PPTP";case"l2tpoveripsec":return"PPTP";case"3g":return"3G";case"dynip":return"IPv4oE";case"statip":return"IPv4oE";case"lte":return"LTE";case"ipoa":return"IPoA";case"dynipv6":return"IPv6oE";case"statipv6":return"IPv6oE";case"bridge":return"Bridge";case"mobileinet":return"USB";case"ipipv6":return"IPIP6";case"6in4":return"SIT";case"6to4":return"SIT";case"6rd":return"SIT"}}function getAvailableIfaces(data,contype,connIfaceLink,connLink){var ins,ret=null,media=data.Media,ifaces=[];if("dynip"==contype||"statip"==contype||"dynipv6"==contype||"statipv6"==contype||"ipoedual"==contype||"pppoe"==contype||"pppoedual"==contype||"pppoev6"==contype||"bridge"==contype){for(var i in media.Ethernet.Interface)ins=media.Ethernet.Interface[i],ifaces.push({name:getIfaceName(ins,"Ethernet"),path:"Ethernet.Interface.".concat(i,"."),groupName:"wan_iface_group_eth"});if("bridge"!=contype)for(var i in media.WiFi.Network){var ins=media.WiFi.Network[i];ifaces.push({name:getIfaceName(ins,"WiFi"),path:"WiFi.Network.".concat(i,"."),groupName:"wan_iface_group_wifi",__Link:ins.__Link})}for(var i in media.Bridging.Bridge){var ins=media.Bridging.Bridge[i];ifaces.push({name:getIfaceName(ins,"Bridging"),path:"Bridging.Bridge.".concat(i,"."),groupName:"wan_iface_group_eth",__Link:ins.__Link})}}var i,ins,i,ins,i,ins;return ret=ifaces.map(function(e){return e.path="Device.WAN.Media."+e.path,e})}function getMediaType(mediaPath){var mediaType,arr=mediaPath.split(".");return mediaType="DSL"==arr[3]?arr[3]+"."+arr[4]:arr[3]}function getIfaceName(mediaData,mediaType){return"DSL.ATM"==mediaType?mediaData.__New?translate("wan_add_new_pvc"):"ATM "+mediaData.DestinationAddress:"DSL.PTM"==mediaType&&mediaData.__New?translate("wan_add_new_ptm"):mediaData.Name}function isPpp(contype){return["3g","mobileinet"].indexOf(contype)>=0?void 0:["pppoe","pppoa","pppoedual","pppoev6","pptp","l2tp","l2tpdual","l2tpoveripsec"].indexOf(contype)>=0}function flattenConnections(data,dontAddServiceProps,types){types||(types=["PPPoE","PPPoEv6","PPPoEDual","PPPoA","PPTP","3G","IPv4oE","LTE","IPoA","IPv6oE","Bridge","USB","IPIP6","SIT"]);var t,obj,conns,c,arr=[];for(var i in types)if(t=types[i],obj=data[t]){conns=obj.Connection;for(var j in conns)c=conns[j],dontAddServiceProps||(c.__Type=t,c.__Path=t+".Connection."+j+"."),arr.push(c)}return arr}function getTypeLangKey(conn,internalType){switch(internalType){case"PPPoE":return"pppoe";case"PPPoEv6":return"pppoev6";case"PPPoEDual":return"pppoedual";case"PPPoA":return"pppoa";case"PPTP":return conn.IPsec?"l2tpoveripsec":conn.ActualType.toLowerCase();case"3G":return"3g";case"IPv4oE":return"DHCP"==conn.AddressingType?"dynip":"statip";case"LTE":return"lte";case"IPoA":return"ipv4oa";case"IPv6oE":return"Static"==conn.Origin?"statipv6":"dynipv6";case"Bridge":return"bridge";case"USB":return"mobileinet";case"IPIP6":return"ipipv6";case"SIT":return conn.Mode}}function getIfaceText(conn,all){function getNullIfaceMsg(){return navShared.isFirewallMode?"-":translate("unknown")}function getlowerConnName(){if(conn.__LinkInterface&&conn.__LinkInterface.includes("Device.Network.Group.")){var _char=conn.__LinkInterface.split("."),_name=conn.Media.FullIfaceList.Name;return"[Group_".concat(_char.at(-2),"] ").concat(_name)}return conn.BaseConnection?all.find(function(e){return e.__Path==conn.BaseConnection.replace("Device.WAN.","")}).Name:conn.__BaseConnName?conn.__BaseConnName:getNullIfaceMsg()}var media;if(["SIT","IPIP6","PPTP"].includes(conn.__Type))return"PPTP"==conn.__Type&&conn.AutomaticalConnection&&!navShared.isFirewallMode?translate("wan_auto_selected"):getlowerConnName();if(media=conn.Media,!media)return getNullIfaceMsg();if(media.Ethernet)return media.Ethernet.Name;if(media.WiFi)return media.WiFi.Name;if(media.DSL){if(media.DSL.ATM)return media.DSL.ATM.DestinationAddress;if(media.DSL.PTM)return media.DSL.PTM.Name}return media.Bridging?media.Bridging.Name:media.Dongle?media.Dongle.Name:getNullIfaceMsg()}function getStrStatusText(status){var all={Disabled:"st_disabled",Connected:"connected",Disconnected:"disconnected",Connecting:"wan_status_connecting",CableDisconnected:"wan_status_cable_disconnected",USBDisconnected:"wan_status_usb_disconnected",WiFiDisconnect:"wan_status_wifi_disconnect",SIMDisconnected:"wan_status_sim_disconnected",WiFiDisconnected:"wan_status_wifi_disconnected",DHCPIPNotReceived:"wan_status_dhcp_ip_not_received",USBNotActive:"wan_status_usb_not_active",PPPServerNotAvailable:"wan_status_ppp_server_not_available",PPPPeerNegotiationFailed:"wan_status_ppp_peer_negotiation_failed",PPPPeerNotResponding:"wan_status_ppp_peer_not_responding",PPPAuthFailed:"wan_status_ppp_auth_failed",PPPNotResponse:"wan_status_ppp_not_response",PPPWiFiClientCouldNotConnect:"wan_status_ppp_wifi_client_could_not_connect",kabinet_not_started:"disconnected",PPPOnDemand:"wan_on_demand",PPPNoNANoPD:"wan_status_ppp_no_nano_pd",PPPNoNA:"wan_status_ppp_no_na",PPPNoPD:"wan_status_ppp_no_pd",PPPResolveFailed:"wan_status_ppp_resolve_failed",PPPNoDR:"wan_status_ppp_no_dr",Unknown:"wan_status_unknown"},str=all[status]||all.Unknown;return str||(str=all.Unknown),translate(str)}function getStatus(stConn){switch(stConn){case"Connected":case"PPPOnDemand":return"on";case"Connecting":return"pending";case"CableDisconnected":case"USBDisconnected":case"WiFiDisconnect":case"SIMDisconnected":case"WiFiDisconnected":return"disconnected"}return"off"}var customRules=navigationFilter.rules();return{flattenConnections:flattenConnections,flattenIfaces:function(data){function addIfaces(arr,media,type){var iface;for(var i in media)iface=media[i],iface.__Type=type,arr.push(media[i])}function prefix(type){switch(type){case"Ethernet":case"Dongle":case"Bridging":return"Bridge";case"ATM":case"PTM":return"Link";case"WiFi":return"Network"}}var media,arr=[];for(var type in data.Media)if("DSL"==type)for(var typeDsl in data.Media[type])media=data.Media[type][typeDsl][prefix(typeDsl)],addIfaces(arr,media,typeDsl);else{var media=data.Media[type][prefix(type)];addIfaces(arr,media,type)}return arr},getTypeLangKey:getTypeLangKey,getContype:function(conn,internalType){return"IPoA"==internalType?"ipoa":getTypeLangKey(conn,internalType)},getInternalType:getInternalType,getAvailableTypes:function(){function add(value,name){name||(name=value),types.push({name:name,value:value})}var types=[];return add("dynip"),add("statip"),add("dynipv6"),add("statipv6"),add("pppoe"),add("pppoev6"),add("pppoedual"),add("pptp"),add("l2tp"),add("l2tpoveripsec"),customRules.AllowedWANTypes?types.filter(function(o){return customRules.AllowedWANTypes.includes(o.value)}):types},getAvailableIfaces:getAvailableIfaces,isIpv6ByInternalType:function(internalType){return"PPPoEv6"==internalType||"PPPoEDual"==internalType||"IPv6oE"==internalType},isIpv4ByInternalType:function(internalType){return"PPPoEv6"!=internalType&&"IPv6oE"!=internalType&&"Bridge"!=internalType},isXxtpByContype:function(contype){return"pptp"==contype||"l2tp"==contype||"l2tpdual"==contype||"l2tpoveripsec"==contype},isIpv4ByContype:function(contype){return["dynip","statip","pppoedual","pppoe","pppoa","ipoa","ipipv6"].indexOf(contype)>=0},isIpv6ByContype:function(contype){return["dynipv6","statipv6","pppoedual","pppoev6","6in4","6to4","6rd"].indexOf(contype)>=0},isPppByContype:isPpp,isBaseByConnType:function(connType){var ret=["dynip","dynipv6","statip","statipv6","pppoe","pppoev6","pppoedual","bridge"].includes(connType);return ret},getIfaceText:getIfaceText,getStatus:getStatus,getStrStatusText:getStrStatusText,getSiblingStateFullName:function(currentStateFullName,siblingStateName){var arr=currentStateFullName.split(".");return arr[arr.length-1]=siblingStateName,arr.join(".")},getByPath:function(path,obj){var key,arr=path instanceof Array?path:path.split("."),prop=obj;for(var i in arr){if(key=arr[i],!prop||!key)break;prop=prop[key]}return prop},getOrCreateByPath:function(path,obj,value){var key,parent,arr=path instanceof Array?path:path.split("."),prop=obj;for(var i in arr){if(!arr[i])break;key=arr[i],parent=prop,parent[key]||(parent[key]={}),prop=parent[key]}return void 0!=value&&(parent[key]=value,prop=parent[key]),prop},delWanBasePath:function(path){return path.split(".").slice(2).join(".")},getNewConnTempl:function(data,contype){var conn={__New:!0};addCreatedIfacesToMedia(data,contype),fillMediaTemplPart(conn,contype,data),fillGeneralTemplPart(conn,contype,data),fillIpv4TemplPart(conn,contype,data),fillIpv6TemplPart(conn,contype,data),fillPppTemplPart(conn,contype,data),fillUsbModemTemplPart(conn,contype,data),"ipipv6"==contype&&fillIpIp6TemplPart(conn,contype),("6in4"==contype||"6to4"==contype||"6rd"==contype)&&fillSITTemplPart(conn,contype),fillIPsecTemplPart(conn,contype,data);var internalType=getInternalType(contype),baseObject=data[internalType].Connection,instNums=Object.keys(baseObject),newInstNum=instNums.length?Math.max.apply(null,instNums)+1:1;return conn.__Path="".concat(internalType,".Connection.").concat(newInstNum,"."),conn},getIfaceName:getIfaceName,getExistingAtmLink:function(vpi,vci,links){var link=links.keys().find(function(e){return e.DestinationAddress==vpi+"/"+vci});return link},validateDnsServers:function(dnsPrim,dnsSec){return dnsSec&&dnsPrim==dnsSec?"msg_error_dns_servers_is_equal":null},checksum:funcs.checksum,getMediaType:getMediaType,getConflictingConnections:function(conn,all){var flattenAll=flattenConnections(all),arr=[];if(conn.MediaPath&&(arr=arr.concat(flattenAll.filter(function(c){return conflictsByMedia(c,conn)}))),"PPTP"==conn.__Type&&conn.AutomaticalConnection){if(flattenAll.filter(function(c){return c.__LowerLayer!=conn.__LowerLayer}))return arr;arr=arr.concat(flattenAll.filter(function(c){return"PPTP"==c.__Type}))}return"IPIP6"==conn.__Type&&(arr=arr.concat(flattenAll.filter(function(c){return"IPIP6"==c.__Type&&c.BaseConnection==conn.BaseConnection}))),"SIT"==conn.__Type&&(arr=arr.concat(flattenAll.filter(function(c){return"SIT"==c.__Type&&c.BaseConnection==conn.BaseConnection}))),arr},goToWanMainState:function(){var wanInfoState=pageDetails.wanInfo[0].state;return $state.go(wanInfoState)},extendConn:function(conn,all,stConn){var typeText=translate(getTypeLangKey(conn,conn.__Type)),ifaceText=getIfaceText(conn,all),statusText=getStrStatusText(stConn),status=getStatus(stConn);return conn.__TypeText=typeText,conn.__IfaceText=ifaceText,conn.__Status=status,conn.__StatusText=statusText,conn.__OriginText=getOriginText(conn),conn.__IPAddress=getIPAddress(conn),"IPv6oE"==conn.__Type&&(conn.__IPv6Address=getIPAddress(conn),conn.__GatewayIPv6Address=conn.GatewayIPv6Address),"PPPoEv6"==conn.__Type&&(conn.__IPv6Address=getIPv6Address(conn),conn.__GatewayIPv6Address=conn.GatewayIPv6Address),("IPv4oE"==conn.__Type||"PPPoE"==conn.__Type||"PPTP"==conn.__Type||"USB"==conn.__Type&&"IPv4"==conn.Version)&&(conn.__GatewayIPAddress=conn.GatewayIPAddress),("PPPoEDual"==conn.__Type||"L2TPDUAL"==conn.ActualType||"USB"==conn.__Type&&("IPv6"==conn.Version||"Dual"==conn.Version))&&(conn.__IPv6Address=getIPv6Address(conn),conn.__GatewayIPAddress=conn.GatewayIPAddress,conn.__GatewayIPv6Address=conn.GatewayIPv6Address),conn},getFlagIGMP:getFlagIGMP,supportDualLAN:!!autoconf.BR2_PACKAGE_ANWEB_CUSTOM_TIMDS_34475||!!autoconf.BR2_PACKAGE_ANWEB_CUSTOM_MTS_29548}}]);