"use strict";angular.module("app").controller("WanConnCtrl",["$scope","$state","wanPage","wanPageCommon","translate","navShared",function($scope,$state,wanPage,wanPageCommon,translate,navShared){function updateMedia(mediaData,mediaType){var conn=$scope.conn;"Ethernet"==mediaType?conn.Media.Ethernet=mediaData:"Bridging"==mediaType?conn.Media.Bridging=mediaData:"WiFi"==mediaType&&(conn.Media.WiFi=mediaData)}function onIfaceChange(pathNewMedia,pathOldMedia){var connByNewIface,conn=$scope.conn,mediaType=wanPageCommon.getMediaType(pathNewMedia);conn.MediaType=mediaType;var mediaData=wanPageCommon.getByPath(pathNewMedia.replace("Device.WAN.",""),$state.params.data);mediaData&&(updateMedia(mediaData,mediaType),"IPv4oE"==conn.__Type&&(connByNewIface=getExistingConn(pathNewMedia),haveChangesIPv4(connByNewIface,pathOldMedia)||fillIpv4FromExistingConn(connByNewIface)),"IPoA"==conn.__Type&&(mediaData.LinkType="IPoA"),"PPPoA"==conn.__Type&&(mediaData.LinkType="PPPoA"),$scope.vlan&&("DSL.ATM"==mediaType||"DSL.PTM"==mediaType?conn.__UseMultiPVC=mediaData.UseMultiPVC:delete conn.__UseMultiPVC),("DSL.ATM"==mediaType||"DSL.PTM"==mediaType)&&(conn.__newMedia=!!mediaData.__New),wanPage.updateVlan(conn.VLAN,mediaData))}function getExistingConn(ifacePath){return Object.keys(data.IPv4oE.Connection).map(function(key){return data.IPv4oE.Connection[key]}).find(function(e){return e.MediaPath==ifacePath})}function fillIpv4FromExistingConn(existingConn){var conn=$scope.conn;conn.DNSServer1=existingConn?existingConn.DNSServer1:"",conn.DNSServer2=existingConn?existingConn.DNSServer2:"","statip"==$scope.contype&&(conn.StaticIPAddress0=existingConn?existingConn.StaticIPAddress0:"",conn.StaticIPSubnetMask0=existingConn?existingConn.StaticIPSubnetMask0:"",conn.GatewayIPAddress=existingConn?existingConn.GatewayIPAddress:"")}function haveChangesIPv4(newConn,pathOldMedia){function isChanged(existConn){var field,curValue;for(var j in fields)if(field=fields[j],curValue=$scope.conn[field],existConn&&curValue&&curValue!=existConn[field])return!0;return!1}var fields=["DNSServer1","DNSServer2","StaticIPAddress0","StaticIPSubnetMask0","GatewayIPAddress"],oldConn=getExistingConn(pathOldMedia);return!oldConn&&isChanged(newConn)||oldConn&&isChanged(oldConn)}function getFirewallAutoConfigDialog(){var type=translate("shorewall_autoconfig_wan_connection",{trustAsHtml:!0});return wanPage.getFirewallAutoConfigNote(type,$scope)}var defTmpl,mediaData,data=$state.params.data,conn=$scope.conn=$state.params.conn,contype=$scope.contype=$state.params._contype,isFirewallMode=navShared.isFirewallMode;$scope.availableTypes=$state.params.availableTypes||wanPageCommon.getAvailableTypes(),$scope.idleDisconnTimeMinVal=30,$scope.idleDisconnTimeMaxVal=4294967296,$scope.common={role:$state.params.role,contype:contype,isNoWanPorts:data.NoWanPorts,isXxtp:wanPageCommon.isXxtpByContype(contype),isIpv4:wanPageCommon.isIpv4ByContype(contype),isIpv6:wanPageCommon.isIpv6ByContype(contype),isPpp:wanPageCommon.isPppByContype(contype),isBase:wanPageCommon.isBaseByConnType(contype),existsConns:data.__flatConnList,existsIfaces:data.__flatIfaceList,getFirewallAutoConfigDialog:getFirewallAutoConfigDialog},["pppoe","pppoa","pptp","l2tp","l2tpoveripsec","3g","mobileinet"].indexOf(contype)>=0&&!conn.__New&&("AlwaysOn"==conn.ConnectionTrigger&&conn.IdleDisconnectTime<$scope.idleDisconnTimeMinVal||conn.IdleDisconnectTime>$scope.idleDisconnTimeMaxVal)&&(defTmpl=wanPageCommon.getNewConnTempl(data,contype),defTmpl.IdleDisconnectTime&&(conn.IdleDisconnectTime=defTmpl.IdleDisconnectTime)),conn.MediaPath&&onIfaceChange(conn.MediaPath),conn.__New||!conn.MediaPath||isFirewallMode||(mediaData=wanPageCommon.getByPath(conn.MediaType,conn.Media),conn.__AvailableIfaces=[{name:wanPageCommon.getIfaceName(mediaData,conn.MediaType),path:conn.MediaPath}]),$scope.common.checksum=wanPageCommon.checksum(JSON.stringify(conn)),wanPageCommon.supportDualLAN&&($scope.common.duallan=data.DualLAN),$scope.submit=function(form){var iface;if(form.$valid){if(($scope.common.isNoWanPorts||conn.__AvailableIfaces&&!conn.__AvailableIfaces.length)&&"mobileinet"!=$scope.common.contype&&("ipipv6"!=$scope.common.contype&&"PPTP"!=$scope.conn.__Type&&"SIT"!=$scope.conn.__Type||isFirewallMode))return void alert(translate(isFirewallMode?"wan_no_interfaces_available_firewall":"wan_no_interfaces_available"));if("DSL.PTM"==$scope.conn.MediaType&&"Bridge"!=$scope.conn.__Type&&(iface=wanPage.getIfacePtmByVlan(data,conn)))return void alert("".concat(translate("msg_is_media_type_busy")," (").concat(iface,")"));if(conn.Flags&&conn.Flags.NATv6&&"None"!=conn.RequestPrefixes&&"mobileinet"!=$scope.common.contype&&"statipv6"!=$scope.common.contype)return void alert(translate("wan_natv6_pd_warning"));if("mobileinet"==$scope.common.contype&&("IPv4"==conn.Version&&(conn.DNSIPv6Automatical=!0),"IPv6"==conn.Version&&(conn.DNSAutomatical=!0)),conn.BandsPreference){var isNotAuto=!conn.BandsPreferenceAuto,isNoSelected=!conn.BandsPreference.find(function(b){return b.Value&&("auto"==conn.Mode||conn.Mode.includes("4G")&&/^LTE\d+/.test(b.Key)||conn.Mode.includes("3G")&&/^UMTS\d+/.test(b.Key)||conn.Mode.includes("2G")&&/^GSM\d+/.test(b.Key))});if(isNotAuto&&isNoSelected)return void alert(translate("wan_no_select_band"))}isFirewallMode&&conn.__New?getFirewallAutoConfigDialog().then(function(res){return conn.firewallAutoConfig=res.value}).then(function(){return $scope.$emit("pagesubmit",conn,$state.params.simple)}):$scope.$emit("pagesubmit",conn,$state.params.simple)}},$scope.haveChanges=function(form){if(form.$invalid||$scope.conn.__New)return!0;var checksum=wanPageCommon.checksum(JSON.stringify(conn));return checksum!=$scope.common.checksum},$scope.$on("generalIfaceChange",function($event,newMedia,oldMedia){onIfaceChange(newMedia,oldMedia)}),$scope.$on("generalContypeChange",function($event,contype,role){$scope.$emit("contypeChange",contype,role)})}]);