"use strict";!function(){angular.module("app").controllerProvider.register("IPsecInfoCtrl",["$scope","$state","translate","IPsecUtil","navigationFilter",function($scope,$state,translate,util,navigationFilter){function activate(overlayId){function success(){helper=util.makeHelper();var commonSettings=helper.getSettings();ipsec.enabled=commonSettings.enabled,ipsec.logLevel=commonSettings.logLevel,ipsec.tunnels=helper.getTunnels(),ipsec.status=helper.getTunnelsStatus(),ipsec.debug=commonSettings.debug,fwRules=util.getFwRules(),ipsec.enabled?(util.subscribeInfo(updateStatus,$scope),util.subscribeIface(updateIface,$scope)):util.unsubscribe()}function finallyCb(){overlayId&&overlay.stop(overlayId),ipsec.isActivate||($scope.$emit("pageload"),ipsec.isActivate=!0)}util.pull().then(success)["catch"](errorPull)["finally"](finallyCb)}function updateStatus(data){ipsec.status=data,$scope.$emit("pageload")}function updateIface(data){ipsec.tunnels=data}function add(){$state.go(currentState+".add")}function edit(item){$state.go(currentState+".edit",{inx:item.__index})}function getTunnelsStatusIP(item){var ipLeft,ipRight;return item.ip?(ipLeft=item.ip.left&&_.contains(item.ip.left," ")?item.ip.left.replace(" "," "):item.ip.left,ipRight=item.ip.right&&_.contains(item.ip.right," ")?item.ip.right.replace(" "," "):item.ip.right,(ipLeft?ipLeft:"-")+" / "+(ipRight?ipRight:"-")):void 0}function getTunnelsStatusPackets(item){return item.packet?item.packet["in"]+" / "+item.packet.out:void 0}function getTunnelsStatusRxTx(item){if(item.rate)var rx=item.rate.rx.value+" "+item.rate.rx.metric;var tx=item.rate.tx.value+" "+item.rate.tx.metric;return rx+" / "+tx}function getList(param){return helper.getList(param)}function errorPull(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"})}function errorPush(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})}function errorRemove(){$state.go("error",{code:"msg_remove_error",message:"msg_rpc_remove_error"})}function getExistFwRulesData(arr,namesArr){var result=[];return _.each(arr,function(item){var rules=item.isIPv6?fwRules.v6.rules:fwRules.v4.rules,zoneId=item.isIPv6?fwRules.v6.zoneId:fwRules.v4.zoneId,iface="Device.Network.Connection.IPsec."+item.__id+".";_.each(rules,function(rule,k){if(rule.Dest&&rule.Dest.Iface==iface||rule.Source&&rule.Source.Iface==iface)rule.Name&&!_.findWhere(result,{inx:k})&&(namesArr&&namesArr.push(rule.Name),result.push({inx:k,type:item.isIPv6?"IPv6":"IPv4"}));else if(arr.length==ipsec.tunnels.length&&(rule.Dest&&!rule.Dest.Iface||rule.Source&&!rule.Source.Iface)){var sourceZoneId=rule.Source.Zone.split(".").splice(-2)[0],destZoneId=rule.Dest.Zone.split(".").splice(-2)[0];(sourceZoneId==zoneId||destZoneId==zoneId)&&rule.Name&&!_.findWhere(result,{inx:k})&&(namesArr&&namesArr.push(rule.Name),result.push({inx:k,type:item.isIPv6?"IPv6":"IPv4"}))}})}),result}$scope.$emit("pageload");var helper,ipsec=$scope.ipsec={isActivate:!1,enabled:null,tunnels:null,status:null,debug:null,changeDebug:function(){function success(){activate(overlayId)}function error(){overlay.stop(overlayId),errorPush()}var overlayId=overlay.start(),setEn=helper.setDebug(ipsec.debug);util.apply(setEn).then(success)["catch"](error)},changeEnabled:function(){function success(){activate(overlayId)}function error(){overlay.stop(overlayId),errorPush()}var overlayId=overlay.start(),setEn=helper.setEnabled(ipsec.enabled),existFwRuleInx=[];ipsec.enabled||_.isEmpty(fwRules)||(existFwRuleInx=getExistFwRulesData(ipsec.tunnels)),util.apply(setEn,existFwRuleInx).then(success)["catch"](error)},changeLogLevel:function(){function success(){activate(overlayId)}function error(){overlay.stop(overlayId),errorPush()}var overlayId=overlay.start(),applyObj=helper.setLogLevel(ipsec.logLevel);util.apply(applyObj).then(success)["catch"](error)},add:add,edit:edit,remove:function(items){function getConfirmMessage(){var confirmMessage="";if(existFwRuleInx.length&&"router"==util.deviceMode){var warnKey=1==existFwRuleNames.length?"ipflt_rule_remove_warning":"ipflt_rules_remove_warning";confirmMessage+=translate(translate(warnKey,{list:': "'.concat(existFwRuleNames.join('", "'),'"')}))}else confirmMessage+=translate("ipsec_remove_rules_warning");return confirmMessage}function depsCheckSuccess(deps){var depsDataFromPage={depLinks:deps,callbackDelFn:del};return util.depsChecker.openDialogIfDepsExists(depsDataFromPage)}var existFwRuleInx=[],existFwRuleNames=[];if(_.isEmpty(fwRules)||(existFwRuleInx=getExistFwRulesData(items,existFwRuleNames)),confirm(getConfirmMessage())){var indexes=_.pluck(items,"__index"),removeConnections=helper.removeRules(indexes),del=ipsec.removeTunnels=function(depsToDel){var overlayId=overlay.start();util.apply(removeConnections,existFwRuleInx,depsToDel).then(function(){activate(overlayId)},function(){overlay.stop(overlay,overlayId),errorRemove()})};if(util.isFirewallMode){var overlayId=overlay.start();util.checkLinksDeps(removeConnections,existFwRuleInx).then(depsCheckSuccess,errorRemove)["finally"](overlay.stop.bind(overlay,overlayId))}else del()}},getMiniTunnelsShort:function(item){var result=[];return item.alg&&item.alg_ph2&&result.push(translate("ipsec_alg")+": "+item.alg+"/"+item.alg_ph2+";"),item.hash&&item.auth_alg&&result.push(translate("ipsec_hash")+": "+item.hash+"/"+item.auth_alg+";"),item.iface&&result.push(translate("iface")+": "+item.iface+";"),result},getTunnelsStatusIP:getTunnelsStatusIP,getTunnelsStatusPackets:getTunnelsStatusPackets,getTunnelsStatusRxTx:getTunnelsStatusRxTx,getMiniTunnelsStatusShort:function(item){var result=[];return item.ip&&result.push(translate("source")+" / "+translate("dest")+": "+getTunnelsStatusIP(item)+";"),item.CHILD&&result.push("CHILD: "+translate(item.CHILD)+";"),item.IKE&&result.push("IKE: "+translate(item.IKE)+";"),item.packet&&result.push(translate("ipsec_packets")+": "+getTunnelsStatusPackets(item)+";"),item.rate&&result.push(translate("ipsec_rx_tx")+": "+getTunnelsStatusRxTx(item)+";"),item.time&&result.push(translate("ipsec_time")+": "+item.time+";"),result},getList:getList,getStateText:function(item){return translate(item.stateText)},reconnect:function(items){var overlayId=overlay.start();util.reconnect(items)["finally"](overlay.stop.bind(overlay,overlayId))},getPhaseLabel:function(type){return customRules&&customRules.RenameIPsecInfo?translate("ipsec_ike_phase",{number:"phase1"==type?"1":"2"}):"phase1"==type?"IKE":"CHILD"}},currentState=$state.current.name.split(".");currentState.pop(),currentState=currentState.join(".");var fwRules,overlay=$scope.overlay.circular,customRules=navigationFilter.rules()||{};activate()}])}();