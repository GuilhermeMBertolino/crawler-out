"use strict";!function(){angular.module("app").service("vserversUtil",["cpe","devinfo","device","funcs",function(cpe,devinfo,device,funcs){function getConfig(){return angular.copy(nativeConfig)}var nativeConfig=null,dsysinitConfig=null,__initNativeConfig=null,__initDsysinitConfig=null,dsysinitAttrs=null,firewallPath="Device.Firewall.",Helper=device.vservers.Helper,converter=device.vservers.converter,snatFlag=autoconf.BR2_PACKAGE_ANWEB_NAT_LOOPBACK;return{getConfig:getConfig,pull:function(){function success(response){return dsysinitConfig=funcs.buildTree(response[0].result.ParameterList),dsysinitAttrs=funcs.buildTreeAttributes(response[1].result.ParameterList),nativeConfig=converter.dsysinitToNative({config:dsysinitConfig,snatFlag:snatFlag}),__initDsysinitConfig=funcs.deepClone(dsysinitConfig),__initNativeConfig=funcs.deepClone(nativeConfig),Promise.resolve()}var paths=["Device.Network.",firewallPath,"Device.Services.","Device.Switch."];return Promise.all([cpe.GetParameterValues(paths),cpe.GetParameterAttributes([firewallPath])]).then(success)},removeRules:function(items){var newConfig=funcs.deepClone(__initDsysinitConfig);_.each(items,function(item){_.each(item.ids,function(id){funcs.cutBranch(newConfig,firewallPath+"IPv4.Rules."+id.__id),_.isUndefined(id.__idLoopDNAT)||funcs.cutBranch(newConfig,firewallPath+"IPv4.Rules."+id.__idLoopDNAT),_.isUndefined(id.__idLoopSNAT)||funcs.cutBranch(newConfig,firewallPath+"IPv4.Rules."+id.__idLoopSNAT)})});var diff=funcs.newConfig.makeDiff(__initDsysinitConfig,newConfig,dsysinitAttrs);return cpe.ApplyDifference(diff)},applyRule:function(rule,id){function addRule(rules,rule){var ruleArr=prepareRule(rule);_.each(ruleArr,function(elem){rules.push(elem)})}function setRule(rules,rule,id){var index=_.findIndex(rules,function(e){return e.__id==id}),ruleArr=prepareRule(rule);_.each(ruleArr,function(elem,key){0==key?rules[index]=elem:rules.push(elem)})}function prepareRule(rule){var destPortStart=rule.Dest.Ports[1].Start;destPortStart=destPortStart.replace(/\s+/g,""),destPortStart=destPortStart.split(",");var sourcePortStart=rule.Source.Ports[1].Start;if(sourcePortStart=sourcePortStart.replace(/\s+/g,""),sourcePortStart=sourcePortStart.split(","),1==sourcePortStart.length){var ports=destPortStart[0].split(":"),sports=sourcePortStart[0].split(":");return rule.Dest.Ports[1].Start=ports[0],rule.Dest.Ports[1].End=ports[1]?ports[1]:rule.Dest.Ports[1].End,rule.Source.Ports[1].Start=sports[0],rule.Source.Ports[1].End=sports[1]?sports[1]:rule.Source.Ports[1].End,delete rule.ids,[rule]}return _.map(sourcePortStart,function(elem,key){var currentRule=funcs.deepClone(rule),dports=destPortStart.length>1?destPortStart[key].split(":"):destPortStart[0].split(":"),sports=elem.split(":");if(currentRule.Dest.Ports[1].Start=dports[0],currentRule.Dest.Ports[1].End=dports[1]?dports[1]:"",currentRule.Source.Ports[1].Start=sports[0],currentRule.Source.Ports[1].End=sports[1]?sports[1]:"",currentRule.Name+="_"+sourcePortStart[key],_.has(currentRule,"ids")){var id=currentRule.ids[key];id?(currentRule.__id=id.__id,currentRule.__idLoopDNAT=id.__idLoopDNAT,currentRule.__idLoopSNAT=id.__idLoopSNAT,currentRule.__obj&&currentRule.__obj[currentRule.__id]&&(currentRule.__protoObj=currentRule.__obj[currentRule.__id].__protoObj,currentRule.__addrObj=currentRule.__obj[currentRule.__id].__addrObj)):0!=key&&_.has(currentRule,"__id")&&delete currentRule.__id,delete currentRule.ids}return currentRule})}_.each(__initNativeConfig.Rules,function(rule,key){setRule(__initNativeConfig.Rules,rule,rule.__id)});var newNativeConfig=funcs.deepClone(__initNativeConfig);_.isUndefined(id)?addRule(newNativeConfig.Rules,rule):setRule(newNativeConfig.Rules,rule,id);var convertRules=converter.nativeToDsysinit({Rules:newNativeConfig.Rules}),convertInitRules=converter.nativeToDsysinit({Rules:__initNativeConfig.Rules}),diff=funcs.newConfig.makeDiff(convertInitRules,convertRules,dsysinitAttrs);return cpe.ApplyDifference(diff)},makeHelper:function(){return new Helper},getDefaultRule:function(){var defRule={Enable:!0,Proto:"TCP",Type:"custom",Name:"",Source:{Iface:"all",IP:[""],Ports:{1:{Start:"",End:""}}},Dest:{IP:[""],Ports:{1:{Start:"",End:""}}}};return defRule.SNAT=!0,defRule}}}])}();