"use strict";!function(){angular.module("app").service("miscUtil",["$injector","cpe","device","funcs","navShared",function($injector,cpe,device,funcs,navShared){function prepareNativeConfig(nativeConfig){Object.keys(nativeConfig.passThrough).length||(nativeConfig.passThrough=getDefaultPassthrough());return nativeConfig}function getDefaultPassthrough(){var defaultInst={Enable:!0,ExternalInterface:"",InternalInterface:"",Settings:{pppoe:!1,ipsec:!0,l2tp:!0,pptp:!0},WANGroup:"Device.Network.Group.1.",__id:"new_passthrough_0"};return defaultInst}function getConfig(){return nativeConfig?nativeConfig:""}function getIfacesForSelect(){return ifaceHelper.getIfacesForSelect()}function fixEmptyRules(config){for(var paths=["Device.Firewall.IPv4.Rules.","Device.Firewall.IPv6.Rules."],_loop=function(){var path=_paths[_i],obj=funcs.fetchBranch(config,path);funcs.newConfig.each(obj,function(value,key){Object.keys(value).length||delete obj[key]})},_i=0,_paths=paths;_i<_paths.length;_i++)_loop();return config}var nativeConfig=null,attrs=null,nativeConfigBackup=null,converter=device.misc.converter,ifaceHelper=null,isFirewallMode=navShared.isFirewallMode,constants={rules:"Device.Firewall.IPv4.Rules.",settings:"Device.Network.Settings.",groups:"Device.Network.Group.",twinIP:"Device.Services.TwinIP.",passthrough:"Device.Services.Passthrough.",deviceMode:"Device.DeviceInfo.DeviceMode."},pullPaths=[constants.rules,constants.settings,constants.deviceMode,constants.passthrough],pullAttrs=[constants.rules,constants.settings,constants.passthrough];return{pull:function(){function success(response){var cpeConfig=fixEmptyRules(response[0].result.Config);return attrs=response[1].result.Datamodel,isFirewallMode&&(ifaceHelper=new device["interface"](cpeConfig)),nativeConfigBackup=converter.dsysinitToNative(cpeConfig),nativeConfig=prepareNativeConfig(funcs.deepClone(nativeConfigBackup)),Promise.resolve()}function error(){return Promise.reject()}return Promise.all([cpe.GetConfig(pullPaths),cpe.GetDatamodel(pullAttrs)]).then(success,error)},apply:function(newNativeConfig){function prepareNewNativeConfig(newNativeConfig){return funcs.deepEqual(newNativeConfig.passThrough,getDefaultPassthrough())&&delete newNativeConfig.passThrough,newNativeConfig}function prepareNewCpeConfig(newCpeConfig){return newCpeConfig}newNativeConfig=prepareNewNativeConfig(newNativeConfig);var nativeConfigBackupCopy=funcs.deepClone(nativeConfigBackup),initCpeConfig=converter.nativeToDsysinit(nativeConfigBackupCopy),newCpeConfig=prepareNewCpeConfig(converter.nativeToDsysinit(newNativeConfig)),diff=funcs.newConfig.makeDiff(initCpeConfig,newCpeConfig,attrs);return Object.keys(diff).length?cpe.ApplyDifference(diff):Promise.resolve()},getConfig:getConfig,getIfacesForSelect:getIfacesForSelect}}])}();