"use strict";function ScheduleFormDialogCtrl($scope,$rootScope,translate,scheduler,snackbars,$state,device,funcs,cpe){function init(){function getTemplateList(){return[{value:"* * * * *",cronWithDuration:"* * * * *",text:"sched_every_minute",templateEditOptions:!0},{value:"0 * * * *",cronWithDuration:"0 * * * *",text:"sched_every_hour",templateEditOptions:!0},{value:"0 0 * * *",cronWithDuration:"0 0 * * *",text:"sched_every_day",templateEditOptions:!0},{value:"0 0 * * 1",cronWithDuration:"0 0 * * 1",text:"sched_every_week",templateEditOptions:!0},{value:"0 0 1 * *",cronWithDuration:"0 0 1 * *",text:"sched_every_month",templateEditOptions:!0}]}function getSystemTime(){return cpe.GetParameterValues(["Device.System.Time"])}function setModeName(){if("CalendarTable"==rule.genInfo.type)$scope.dialog.mode.name="calendar",$scope.dialog.templates.current=rule.genInfo.calendarTable;else if(branches){var find=_.find($scope.dialog.templates.list,function(item){return item.value==rule.genInfo.cron});find?($scope.dialog.mode.name="simple",$scope.dialog.templates.current=find.value):$scope.dialog.mode.name="advanced"}else $scope.dialog.mode.name="simple",$scope.dialog.templates.current=rule.cronWithDuration,$scope.dialog.templates.currentDuration=rule.genInfo.duration}function getAddingSchedules(config){var result=[],elems=funcs.fetchBranch(config,"Device.System.Scheduler.Config.");return _.each(elems,function(item,i){item.Cron&&item.Type&&"Cron"==item.Type&&result.push({Cron:item.Cron,Duration:item.Duration,Type:item.Type,Name:item.Name}),item.Type&&"CalendarTable"==item.Type&&result.push({CalendarTable:item.CalendarTable,Duration:item.Duration,Type:item.Type,Name:item.Name,Id:i})}),result}function pull(){return Promise.all([cpe.GetParameterValues(["Device.System.Scheduler.Config"]),cpe.GetParameterAttributes(["Device.System.Scheduler.Config"])])}if(dg.templates.list=getTemplateList(),getSystemTime().then(function(data){var config=funcs.buildTree(data.result.ParameterList),systemTime=config.Device.System.Time;dg.currentTimeDate={month:"sched_st_"+helper.date.getNameMonth(systemTime.Month),day:systemTime.Day,hour:helper.date.doubleFormat(""+systemTime.Hour),minute:helper.date.doubleFormat(""+systemTime.Minute),year:systemTime.Year}}),branches){var _success=function(response){config=funcs.buildTree(response[0].result.ParameterList),attrs=funcs.buildTreeAttributes(response[1].result.ParameterList);var initRulesConfig=config.Device.System.Scheduler.Config;helper=device.schedule.helper(initRulesConfig);var rulesConfig=helper.convertRules();if(_.keys(rulesConfig).length){addingSchedules=getAddingSchedules(config),usedBranchSchedules=helper.getUsedBranchSchedules(config,branches);var inxsSchedules=_.keys(usedBranchSchedules);if(dg.branches.usingInSchedules=!!inxsSchedules.length,1===inxsSchedules.length){var inxSchedule=inxsSchedules[0],rule=rulesConfig[inxSchedule],schedule=usedBranchSchedules[inxSchedule],interval=rule.interval;dg.rule=rule,dg.branches.nowSchedule.push(scheduler.translateSchedule(interval)),dg.templates.current=rule.cronWithDuration,dg.templates.currentDuration=rule.genInfo.duration,dg.templates.name=rule.name,_.isObject(rule.cronWithDuration)&&(dg.mode.name="calendar");var branchInx=_.findKey(schedule.Branches,function(branch){return-1!==branches.indexOf(branch.Link)});dg.branches.enableAtStart=rule.genInfo.tasks[branchInx].EnableAtStart}_.each(rulesConfig,function(item){if(item){var ind=dg.scheduleRules.length;dg.scheduleRules[ind]=item,dg.scheduleRules[ind].interval=scheduler.translateSchedule(item.interval),dg.scheduleRules[ind].duration=scheduler.translateSchedule(item.duration.toString()),null===dg.branches.scheduleId&&(dg.branches.scheduleId=item.id),addExistSchedToTmplList(item)}}),__backupList=angular.copy(dg.templates.list),setTimeDate(dg.templates.current),convertToDurationUser()}else dg.branches.addSchedule=!0,dg.scheduleRules=0,dg.ruleState.list=[{label:translate("sched_create_rule"),value:"new"}];dg.rule?(dg.ruleState.state="exist",dg.templates.current=dg.rule.cronWithDuration,dg.manual.enable="on"===dg.rule.state):dg.manual.enable=!0,dg.ruleState.update(),dg.branches.isLoaded=!0};dg.branches.addBranche=!0,pull().then(_success).then(changeStringSchedule)}if(commandName){if(dg.commands.selected=!0,dg.header="sched_selection",dg.manual.enable=!0,dg.mode.list.splice(-1,1),("reboot"==commandName||"upload_config"==commandName)&&dg.templates.list.splice(0,2),"exec"!=commandName||_.isEmpty(modem)||dg.templates.list.splice(0,1),command.length){command.cronWithDuration=command[0].Cron,dg.commands.rule=command;var templates=dg.templates,findTemplate=_.find(templates.list,function(temp){return temp.value===command[0].Cron});findTemplate||templates.list.push({value:command[0].Cron,cronWithDuration:command[0].Cron,text:scheduler.translateSchedule(helper.convertCronToUserString(command[0].Cron))}),templates.current=command[0].Cron,dg.manual.name=command[0].Name}else{var templates=dg.templates;templates.current=templates.list[0].value}}else rule&&rule.genInfo?(dg.rule=rule,dg.manual.duration=rule.genInfo.duration,dg.manual.name=rule.name,convertToDurationUser(),dg.manual.enable="on"===rule.state,setModeName(),_.keys(rule.genInfo.tasks).length>1&&(dg.tasks.noEmpty=!0,_.each(rule.genInfo.tasks,function(item){if(item.Link){var task=scheduler.getTask(item.Link,item.rule),exist=!1;_.each(dg.tasks.list,function(item){item.Name===task.Name&&(item.count++,exist=!0)}),exist||(task.count=1,dg.tasks.list.push(task))}})),addExistSchedToTmplList(rule),setTimeDate("CalendarTable"!=rule.genInfo.type?rule.genInfo.cron:rule.genInfo.calendarTable),config&&(addingSchedules=getAddingSchedules(config)),"on"===rule.status&&(dg.manual.enable=!0),isEdit=!0):(dg.mode.name="simple",dg.templates.current=dg.templates.list[2].value,dg.manual.duration="30",config&&(addingSchedules=getAddingSchedules(config)))}function addExistSchedToTmplList(sched){var addToTemplate=!0,isExist=!1,arrExistingSchedules=[];if(_.each(dg.templates.list,function(listItem){"CalendarTable"==sched.type?_.isEqual(sched.cronWithDuration,listItem.cronWithDuration)&&(isExist=!0):listItem.value===sched.genInfo.cron&&listItem.duration&&listItem.duration==sched.genInfo.duration&&(isExist=!0),isExist&&(listItem.duration=sched.genInfo.duration,listItem.idSchedule=sched.id,listItem.cronWithDuration=sched.cronWithDuration,listItem.name=sched.name,listItem.enable="on"===listItem.state,addToTemplate=!1)}),addToTemplate){var existingSchedule={value:sched.genInfo.cron,text:scheduler.translateSchedule(helper.convertCronToUserString(sched.cronWithDuration,addingSchedules)),duration:sched.genInfo.duration,cronWithDuration:sched.cronWithDuration,name:sched.name,idSchedule:sched.id,enable:"on"===sched.state};arrExistingSchedules.push(existingSchedule)}_.each(arrExistingSchedules,function(arrElem){dg.templates.list.push(arrElem)})}function setTimeDate(cron){if(cron){if(dg.manual.type="calendar"==dg.mode.name?"CalendarTable":"Cron",_.isObject(cron))return setCalendarTable(cron),void($scope.dialog.branches.addBranche&&$scope.setAlreadyExistingSchedule(cron,dg.templates.currentDuration));cron=cron.split(" ");var man=$scope.dialog.manual;if(man.min=cron[0],man.hour=cron[1],man.day=cron[2],man.month=cron[3],man.weekDay=cron[4],"simple"==$scope.dialog.mode.name){var templateOptions=$scope.dialog.templates.options={},allowEdit=_.find($scope.dialog.templates.list,function(item){return item.value==cron.length>5?cron.slice(0,-1).join(" "):cron.join(" ")});allowEdit&&("*"!=man.min&&(templateOptions.setMin=!0),"*"!=man.hour&&(templateOptions.setHour=!0),"*"!=man.day&&(templateOptions.setDay=!0),"*"!=man.weekDay&&(templateOptions.setWeekDay=!0,convertCronToWeekDays()))}checkFormDurationSettErrors(),checkDurationCorrect(),$scope.dialog.branches.addBranche&&$scope.setAlreadyExistingSchedule(cron.join(" "),dg.templates.currentDuration),__backupBranchData=angular.copy(getCurrentBranchData())}}function checkFormDurationSettErrors(){var days=$scope.dialog.durationSett.days,hours=$scope.dialog.durationSett.hours,min=$scope.dialog.durationSett.min;days||($scope.dialog.durationSett.days=0),hours||($scope.dialog.durationSett.hours=0),min||($scope.dialog.durationSett.min=0)}function convertToDurationCron(){var days=$scope.dialog.durationSett.days,hours=$scope.dialog.durationSett.hours,min=$scope.dialog.durationSett.min,sec=$scope.dialog.durationSett.sec;$scope.dialog.manual.duration=86400*days+3600*hours+60*min+sec,$scope.dialog.durationSett.notSetDurationErr=$scope.dialog.manual.duration<=0?!0:!1}function convertToDurationUser(){var duration=$scope.dialog.manual.duration;if(duration){var days=0,hours=0,sec=0,min=0;$scope.dialog.durationSett.enable=0==duration?!1:!0,duration>=86400&&(days=parseInt(duration/86400),duration%=86400),duration>=3600&&(hours=parseInt(duration/3600),duration%=3600),duration>=60&&(min=parseInt(duration/60),duration%=60),duration>0&&(sec=duration),$scope.dialog.durationSett.days=days,$scope.dialog.durationSett.hours=hours,$scope.dialog.durationSett.min=min,$scope.dialog.durationSett.sec=sec}}function checkDurationCorrect(){var durationSett=$scope.dialog.durationSett,constraints=durationSett.constraints,cMin=$scope.dialog.manual.min,cHour=$scope.dialog.manual.hour,cDay=$scope.dialog.manual.day,cMonth=$scope.dialog.manual.month,cWeek=$scope.dialog.manual.weekDay,man=$scope.dialog.manual;if(_.each(constraints,function(item){item.status=!0,item.nwMax=null}),constraints.showDay.nwMax=364,"*"!=cWeek&&null!==cWeek){constraints.showDay.nwMax=7;var weekDaysArr=cWeek.split(",");if(weekDaysArr.length>1){var nwMax=7;_.each(weekDaysArr,function(numWeek,i,arr){if(0!=i){var newNwMax=arr[i]-arr[i-1];nwMax=nwMax>newNwMax?newNwMax:nwMax}}),nwMax-1==0?(constraints.showDay.status=!1,man.duration=man.duration>86399?30:man.duration):constraints.showDay.nwMax=nwMax-1}}"*"==cMin&&"*"==cHour?(constraints.showDay.status=!1,constraints.showHour.status=!1,constraints.showMin.status=!1,man.duration=man.duration>59?30:man.duration):"*"!=cMin&&"*"==cHour&&"*"==cDay&&"*"==cMonth&&"*"==cWeek?(constraints.showDay.status=!1,constraints.showHour.status=!1,man.duration=man.duration>3599?30:man.duration):"*"!=cMin&&"*"!=cHour&&"*"==cDay&&"*"==cMonth&&"*"==cWeek?constraints.showDay.status=!1:"*"!=cMin&&"*"!=cHour&&"*"!=cDay&&"*"==cMonth&&"*"==cWeek&&(constraints.showDay.nwMax=30);var cronStr=helper.valid.sort(cMin)+" "+helper.valid.sort(cHour)+" "+helper.valid.sort(cDay)+" "+helper.valid.sort(cMonth,"month")+" "+helper.valid.sort(cWeek,"weekDay");isEdit&&cronStr==rule.genInfo.cron&&(man.duration=rule.genInfo.duration)}function applyDiff(diff){return cpe.ApplyDifference(diff)}function success(){snackbars.add("msg_rpc_write_success")}function error(){snackbars.add("msg_rpc_write_error")}function changeStringSchedule(){function isValidAllParam(){return null===dg.valid.rangeNumbers(man.min,0,59)&&null===dg.valid.rangeNumbers(man.hour,0,23)&&null===dg.valid.rangeNumbers(man.day,1,31)&&null===dg.valid.rangeNumbers(man.month,1,12,"m")&&null===dg.valid.rangeNumbers(man.weekDay,0,6,"w")}if("calendar"==dg.mode.name)return void(dg.branches.addBranche&&($scope.checkAlreadyAdding(),dg.branches.isEditable=isEditableSchedule()));var man=dg.manual;if(isValidAllParam()){var cronStr=helper.valid.sort(man.min)+" "+helper.valid.sort(man.hour)+" "+helper.valid.sort(man.day)+" "+helper.valid.sort(man.month,"month")+" "+helper.valid.sort(man.weekDay,"weekDay"),stringInterval=helper.convertCronToUserString(cronStr);dg.branches.addBranche&&($scope.checkAlreadyAdding(),dg.branches.isEditable=isEditableSchedule()),dg.stringInterval=scheduler.translateSchedule(stringInterval),checkDurationCorrect()}else dg.stringInterval=""}function convertCronToWeekDays(){var regExpRange=/^(\d{1,2})\s*-\s*(\d{1,2})$/;if(!_.isNull($scope.dialog.manual.weekDay)&&"*"!=$scope.dialog.manual.weekDay){var selectedCron=$scope.dialog.manual.weekDay.split(","),templates=$scope.dialog.templates;templates.selectedWeekDays=[],_.each(selectedCron,function(day){var range=regExpRange.exec(day);if(range)for(var _loop=function(index){item=_.find($scope.dialog.templates.weekdays,function(elem){return elem.value==index}),templates.selectedWeekDays.push({item:item,key:day-1})},index=range[1];index<=range[2];index++){var item;_loop(index)}else{var item=_.find($scope.dialog.templates.weekdays,function(elem){return elem.value==day||elem.day==day});templates.selectedWeekDays.push({item:item})}})}}function selectSchedule(id){id&&(__backupRule=angular.copy(dg.manual),_.each($scope.dialog.scheduleRules,function(item){item.id==id&&($scope.dialog.branches.scheduleInfo.enable=item.state,$scope.dialog.branches.scheduleInfo.duration=item.duration)}),$scope.dialog.branches.scheduleId=id)}function isEditableSchedule(){var result=!0,idSchedule=dg.branches.selectExistingSchedule,schedule=_.findWhere(dg.scheduleRules,{id:idSchedule});if(schedule&&schedule.tasks>0){var links=_.chain(schedule.genInfo.tasks).mapObject(function(task){return task.Link}).values().without(void 0,"").value();result=!_.difference(links,branches).length}return result}function setCalendarTable(calendar){dg.templates.simpleModeCalendar=helper.setCalendarTable(calendar),dg.manual.calendarTable=dg.templates.simpleModeCalendar}function checkUniqRuleName(name){if(!addingSchedules.length)return null;if(dg.rule&&name&&name==dg.rule.name)return null;if("exist"==dg.ruleState.state){var currenRule=_.findWhere(dg.templates.list,{cronWithDuration:dg.templates.current});if(currenRule&&name&&name==currenRule.name)return null}return name&&_.findWhere(addingSchedules,{Name:name})?"msg_error_value_is_not_uniq":null}function getCurrentBranchData(){var obj={state:dg.ruleState.state,mode:dg.mode.name,rule:dg.templates.current,action:dg.branches.enableAtStart,enable:dg.manual.enable};return"calendar"!=dg.mode.name?obj.manual=dg.manual:obj.calendar=dg.manual.calendarTable,obj}var data=$scope.ngDialogData,rule=data.rule,attrs=data.attrs,config=data.config,branches=data.branches,command=data.command,commandName=data.nameCmd,ruleName=data.name,isNeedReload=data.isNeedReload,modem=data.modem,uploadArgs=data.args,helper=device.schedule.helper(),__backupRule=null,__backupList=null,__backupBranchData=null,overlay=$rootScope.overlay.circular,isEdit=!1,needDisabledSave=!1,addingSchedules={},usedBranchSchedules={};_.isUndefined(isNeedReload)&&(isNeedReload=!0),$scope.dialog={manual:{min:null,hour:null,day:null,month:null,weekDay:null,duration:null,name:"",enable:!1,args:{},calendarTable:{}},durationSett:{sec:30,min:0,hours:0,days:0,enable:!0,notSetDurationErr:!1,constraints:{showDay:{status:!0,nwMax:null},showHour:{status:!0,nwMax:null},showMin:{status:!0,nwMax:null}}},currentTimeDate:{month:null,day:null,hour:null,minute:null,year:null},templates:{current:"",currentDuration:"",list:null,options:{},weekdays:[{label:"ntp_short_mon",day:"mon",value:"1"},{label:"ntp_short_tue",day:"tue",value:"2"},{label:"ntp_short_wed",day:"wed",value:"3"},{label:"ntp_short_thu",day:"thu",value:"4"},{label:"ntp_short_fri",day:"fri",value:"5"},{label:"ntp_short_sat",day:"sat",value:"6"},{label:"ntp_short_sun",day:"sun",value:"0"}],selectedWeekDays:[],simpleModeCalendar:helper.getSimpleModeCalendar(),simpleModeInterval:function(){for(var intervals=[],i=0;24>=i;i++)intervals.push((10>i?"0"+i:i)+":00");return intervals}(),weekDays:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]},tasks:{noEmpty:!1,list:[]},mode:{name:"simple",list:[{label:translate("wan_simple_mode"),value:"simple"},{label:translate("wan_advanced_mode"),value:"advanced"},{label:translate("sched_calendar_mode"),value:"calendar"}],update:function(){var temp=$scope.dialog.templates;"calendar"!=$scope.dialog.mode.name&&(needDisabledSave=!1,(!temp.current||_.isObject(temp.current))&&(temp.current=temp.list[0].value)),"simple"==$scope.dialog.mode.name&&convertCronToWeekDays(),dg.manual.type="calendar"==dg.mode.name?"CalendarTable":"Cron"}},ruleState:{state:"new",list:[{label:translate("sched_create_rule"),value:"new"},{label:translate("sched_use_exist"),value:"exist"}],update:function(){if($scope.dialog.scheduleRules||(dg.ruleState.list=[{label:translate("sched_create_rule"),value:"new"}]),"new"==dg.ruleState.state&&__backupList&&(dg.templates.list=_.filter(__backupList,function(elem){return!elem.name}),dg.manual.name="",dg.rule&&(dg.rule.name=""),"calendar"==dg.mode.name?dg.templates.current={}:(dg.templates.current=dg.templates.list[2].cronWithDuration,needDisabledSave=!1,dg.manual.duration=30)),"exist"==dg.ruleState.state){if(dg.templates.list=_.filter(__backupList,function(elem){return elem.name}),dg.templates.list.length&&dg.rule){var existRule=_.findWhere(dg.templates.list,{idSchedule:dg.rule.id});dg.templates.current=existRule?existRule.cronWithDuration:dg.templates.list[0].cronWithDuration}else dg.templates.list.length&&(dg.templates.current=dg.templates.list[0].cronWithDuration,dg.templates.list[0].duration&&(dg.manual.duration=dg.templates.list[0].duration));convertToDurationUser()}}},valid:{rangeNumbers:helper.valid.checkRange,checkDate:helper.valid.checkCorrectDate,checkUniqRuleName:checkUniqRuleName},close:function(){$scope.closeThisDialog(null)},stringInterval:"",isDisabledSave:function(){return!$scope.form.$valid||needDisabledSave||$scope.checkAlreadyAdding()?!0:_.isEqual(__backupBranchData,getCurrentBranchData())&&_.isEqual(__backupRule,dg.manual)},save:function(){function finish(){$scope.closeThisDialog($scope.dialog),overlay.stop(overlayId),isNeedReload&&$state.reload()}if(!$scope.form.$invalid){var overlayId=overlay.start(),id=rule?rule.id:dg.branches.selectExistingSchedule?dg.branches.selectExistingSchedule:null;if(commandName)var cmdHelper=helper.commands(),newConfigCommands=cmdHelper.getConfigCmd($scope.dialog.manual,config,$scope.dialog.commands.rule,commandName,uploadArgs),diff=helper.getDiffRule(config,newConfigCommands,attrs);else{"CalendarTable"!=dg.manual.type&&setCalendarTable();var newRule;if(dg.branches.addBranche){if(branches.length){var enableAtStart=dg.branches.enableAtStart,branchesLink=_.map(branches,function(link){return{Link:link,EnableAtStart:enableAtStart}}),initRule=dg.branches.isEditable?dg.manual:null,schedule=usedBranchSchedules&&dg.branches.selectExistingSchedule?usedBranchSchedules[id]:null;newRule=helper.getRule(initRule,branchesLink,schedule)}}else newRule=helper.getRule(dg.manual);var newConfig=helper.getRemoveBranchConfig(config,usedBranchSchedules,branches);newConfig=helper.getConfig(newRule,newConfig,id),diff=helper.getDiffRule(config,newConfig,attrs)}return _.keys(diff).length?void applyDiff(diff).then(success,error).then(finish):(success(),void finish())}},resetCalendar:function(){_.each($scope.dialog.templates.simpleModeCalendar,function(calendar){_.each($scope.dialog.templates.weekDays,function(day){calendar[day]=!1})})},isDisabledResetCalendar:function(){return dg.branches.isEditable?_.every($scope.dialog.templates.simpleModeCalendar,function(calendar){return!(calendar.Mon||calendar.Tue||calendar.Wed||calendar.Thu||calendar.Fri||calendar.Sat||calendar.Sun)}):!0},cnahgeCalendarState:function(time,day){dg.branches.isEditable&&(time[day]=!time[day],dg.manual.calendarTable=dg.templates.simpleModeCalendar)},branches:{addBranche:!1,isLoaded:!1,selectSchedule:selectSchedule,scheduleId:null,scheduleInfo:{enable:!1,duration:null},selectExistingSchedule:null,isEditable:!0,warning:{elems:[]},enableAtStart:!0,enableAtStartModes:function(){switch(ruleName){case"radioEnable":return[{name:"sched_act_radio_enable",value:!0},{name:"sched_act_radio_disable",value:!1}];case"ssidEnable":return[{name:"sched_act_broadcast_enable",value:!0},{name:"sched_act_broadcast_disable",value:!1}];default:return[{name:"sched_act_rule_enable",value:!0},{name:"sched_act_rule_disable",value:!1}]}}(),addSchedule:!1,usingInSchedules:null,nowSchedule:[],changeMode:function(){var branches=$scope.dialog.branches;branches.addSchedule=!branches.addSchedule},deleteBranches:function(){function finish(){$scope.closeThisDialog("del"),overlay.stop(overlayId),isNeedReload&&$state.reload()}var overlayId=$rootScope.overlay.circular.start(),newConfig=helper.getRemoveBranchConfig(config,usedBranchSchedules,branches),diff=helper.getDiffRule(config,newConfig,attrs);applyDiff(diff).then(success)["catch"](error)["finally"](finish)}},scheduleRules:[],header:"sched_nav",isOnlyBranch:!1,commands:{selected:!1,rule:[],deleteCmd:function(){function finish(){$scope.closeThisDialog(null),overlay.stop(overlayId),isNeedReload&&$state.reload()}var overlayId=$rootScope.overlay.circular.start(),cmdHelper=helper.commands(),deleteCmdConfig=cmdHelper.getDeleteCmdConfig(config,command),diff=helper.getDiffRule(config,deleteCmdConfig,attrs);applyDiff(diff).then(success)["catch"](error)["finally"](finish)}},rule:null};var dg=$scope.dialog;$scope.$watch("dialog.manual.min",changeStringSchedule),$scope.$watch("dialog.manual.hour",changeStringSchedule),$scope.$watch("dialog.manual.day",changeStringSchedule),$scope.$watch("dialog.manual.month",changeStringSchedule),$scope.$watch("dialog.manual.weekDay",changeStringSchedule),$scope.$watch("dialog.branches.scheduleId",selectSchedule),$scope.$watch("dialog.templates.selectedWeekDays",function(newValue){newValue.length&&($scope.dialog.manual.weekDay="",_.each(newValue,function(item){$scope.dialog.manual.weekDay.length&&($scope.dialog.manual.weekDay+=","),$scope.dialog.manual.weekDay+=item.item.value}),$scope.dialog.manual.weekDay=$scope.dialog.manual.weekDay.split(",").sort().join(","),checkDurationCorrect())},!0),$scope.$watch("dialog.durationSett.sec",convertToDurationCron),$scope.$watch("dialog.durationSett.min",convertToDurationCron),$scope.$watch("dialog.durationSett.hours",convertToDurationCron),$scope.$watch("dialog.durationSett.days",convertToDurationCron),$scope.$watch("dialog.templates.current",function(newValue){newValue&&(_.isObject(newValue)?($scope.dialog.mode.name="calendar",setTimeDate(newValue),changeStringSchedule()):(dg.branches.addBranche&&($scope.dialog.mode.name="simple"),setTimeDate(newValue),convertToDurationUser()))}),init(),$scope.setAlreadyExistingSchedule=function(cronStr,duration){var isCalendar=_.isObject(cronStr)?!0:!1,man=$scope.dialog.manual,tempList=$scope.dialog.templates.list,rule=null,currenTemp=$scope.currenTemplate=_.find(tempList,function(item){return isCalendar?_.isEqual(item.cronWithDuration,cronStr):item.cronWithDuration==cronStr});$scope.dialog.scheduleRules&&(rule=$scope.dialog.scheduleRules.filter(function(item){return isCalendar?_.isEqual(item.genInfo.calendarTable,cronStr):item.genInfo.cronWithDuration==cronStr})[0]),rule&&($scope.dialog.isOnlyBranch=rule.tasks?!1:!0),currenTemp&&"undefined"!=typeof currenTemp.duration?(man.duration=currenTemp.duration,man.name=currenTemp.name,$scope.dialog.branches.selectExistingSchedule=currenTemp.idSchedule,man.enable=currenTemp.enable):(man.duration=isCalendar?3600:man.duration?man.duration:30,$scope.dialog.branches.selectExistingSchedule=null)},$scope.checkAlreadyAdding=function(){if(addingSchedules.length<1&&"calendar"!=$scope.dialog.mode.name)return!1;var t=$scope.dialog.manual,nowCron={cron:t.min+" "+t.hour+" "+t.day+" "+t.month+" "+t.weekDay,duration:t.duration},nowCalendarTable=t.calendarTable,result=!1;if("calendar"!=$scope.dialog.mode.name)needDisabledSave=!1,_.each(addingSchedules,function(item){item.Cron==nowCron.cron&&(result=rule&&rule.genInfo.cron==nowCron.cron&&rule.genInfo.duration==nowCron.duration?!1:item.Duration!=nowCron.duration||$scope.currenTemplate&&$scope.currenTemplate.value==item.Cron&&$scope.currenTemplate.duration==item.Duration?!1:!0)});else{if(_.isEmpty(nowCalendarTable)||_.isEqual(nowCalendarTable,helper.getSimpleModeCalendar()))return needDisabledSave=!0,!1;needDisabledSave=!1;for(var i=0;i<addingSchedules.length;i++){var item=addingSchedules[i],itemCalendar=helper.getSimpleModeCalendar(),itemCalendarTable=item.CalendarTable;_.each(item.CalendarTable,function(num,inx){if(num){var numToBit=(num>>>0).toString(2);numToBit=numToBit.split("").reverse().join(""),_.each(numToBit,function(bit,i){"1"==bit&&(itemCalendar[i][inx]=!0)})}});var equal=_.isEqual(nowCalendarTable,itemCalendar);if("exist"==dg.ruleState.state&&equal)return _.isEqual(dg.templates.current,itemCalendarTable)?!1:!0;if(dg.rule&&dg.rule.id&&dg.rule.id!=item.Id&&equal)return!0;if(!dg.rule&&equal)return!0;if(dg.branches.addBranche&&"exist"!=dg.ruleState.state&&equal)return!0}}return result},$scope.getText=function(template){return _.has(template,"name")&&""!==template.name?template.name:_.has(template,"name")&&""===template.name||!_.has(template,"name")?template.text:void 0},$scope.goToTaskPage=function(item){if(item.href){var params={};item.freq&&(params.freq=item.freq),$scope.closeThisDialog(null),$state.go(item.href,params)}}}ScheduleFormDialogCtrl.$inject=["$scope","$rootScope","translate","scheduler","snackbars","$state","device","funcs","cpe"];