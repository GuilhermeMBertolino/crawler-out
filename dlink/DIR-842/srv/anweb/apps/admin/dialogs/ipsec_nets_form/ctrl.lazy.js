"use strict";function IPsecNetsFormDialogCtrl($scope,translate,device){function isNotUniqRule(){return list&&list.length?_.some(list,function(elem){return _.isEqual(elem,$scope.dialog.rule)}):!1}function wasModified(){return __backupRule&&!_.isEqual(__backupRule,$scope.dialog.rule)}function validateNets(elem){function isInvalidIP(addr){return addr&&!funcs_is.ipv4(addr)}function isInvalidMask(msk){return msk&&!funcs_is.mask(msk)}function isInvalidIPv6(addr){return addr&&!funcs_is.ipv6(addr)}function isInvalidPrefixIPv6(msk){return msk&&!funcs_is.ipv6Prefix(msk)}function isSubnetIp(addr,msk){return addr&&msk&&funcs_ipv4.subnet.getNetworkAddress(addr,msk)}function isSubnetIPv6(addr,msk){return addr&&msk&&funcs_ipv6.subnet.getNetworkAddress(addr,msk)}function isContainsNetwork(network1,network2){return funcs_ipv4.subnet.containsNetwork(network1,network2)}function isContainsNetworkIPv6(network1,network2){return funcs_ipv6.subnet.containsNetwork(network1,network2)}function isReservedIPv6(addr,msk){return funcs_ipv6.subnet.checkReserved(addr,msk)}function isReserved(network){switch(network){case"0.0.0.0":return"defroute";case"127.0.0.0":return"loopback";case"169.254.0.0":return"linklocal";case"240.0.0.0":return"future";case"192.88.99.0":return"anycast";case"224.0.0.0":return"multicast"}return"network"}var errors={SourceAddress:[],DestAddress:[]},addr1=_.isUndefined(elem.source.split("/")[0])?elem.source:elem.source.split("/")[0],msk1=_.isUndefined(elem.source.split("/")[1])?"":elem.source.split("/")[1],addr2=_.isUndefined(elem.dest.split("/")[0])?elem.dest:elem.dest.split("/")[0],msk2=_.isUndefined(elem.dest.split("/")[1])?"":elem.dest.split("/")[1],network1={},network2={};"ipv4"==$scope.ipVersion?(isInvalidIP(addr1)&&errors.SourceAddress.push("msg_invalid_ipv4"),isInvalidIP(addr2)&&errors.DestAddress.push("msg_invalid_ipv4"),msk1&&!funcs_is.number(msk1)&&errors.SourceAddress.push("msg_invalid_mask"),msk2&&!funcs_is.number(msk2)&&errors.DestAddress.push("msg_invalid_mask"),_.isUndefined(elem.source.split("/")[2])||errors.SourceAddress.push("msg_invalid_mask"),_.isUndefined(elem.dest.split("/")[2])||errors.DestAddress.push("msg_invalid_mask"),""!=addr1&&""==msk1&&errors.SourceAddress.push("ipsec_error_mask_is_null"),""!=addr2&&""==msk2&&errors.DestAddress.push("ipsec_error_mask_is_null"),(msk1>32||isInvalidMask(funcs_ipv4.mask["long"](msk1)))&&errors.SourceAddress.push("msg_invalid_mask"),(msk2>32||isInvalidMask(funcs_ipv4.mask["long"](msk2)))&&errors.DestAddress.push("msg_invalid_mask"),(!isInvalidIP(addr1)&&!isInvalidMask(funcs_ipv4.mask["long"](msk1))||!isInvalidIP(addr2)&&!isInvalidMask(funcs_ipv4.mask["long"](msk2)))&&(isSubnetIp(addr1,funcs_ipv4.mask["long"](msk1))!=addr1&&errors.SourceAddress.push("msg_invalid_ipv4_subnet"),isSubnetIp(addr2,funcs_ipv4.mask["long"](msk2))!=addr2&&errors.DestAddress.push("msg_invalid_ipv4_subnet"),"network"!=isReserved(isSubnetIp(addr1,funcs_ipv4.mask["long"](msk1)))&&errors.SourceAddress.push("lan_error_ip_is_reserved"),elem.dest&&"0.0.0.0/1"!=elem.dest&&"network"!=isReserved(isSubnetIp(addr2,funcs_ipv4.mask["long"](msk2)))&&errors.DestAddress.push("lan_error_ip_is_reserved"),0==errors.SourceAddress.length&&0==errors.DestAddress.length&&(""!=addr1&&(network1={ip:addr1,mask:funcs_ipv4.mask["long"](msk1)}),""!=addr2&&(network2={ip:addr2,mask:funcs_ipv4.mask["long"](msk2)})),_.isEmpty(network1)||_.isEmpty(network2)||!isContainsNetwork(network1,network2)||(errors.SourceAddress.push("ipsec_local_remote_intersect_msg"),errors.DestAddress.push("ipsec_local_remote_intersect_msg")),_.isEmpty(network1)||_.isEmpty(network2)||!isContainsNetwork(network2,network1)||(errors.SourceAddress.push("ipsec_local_remote_intersect_msg"),errors.DestAddress.push("ipsec_local_remote_intersect_msg")))):"ipv6"==$scope.ipVersion&&(isInvalidIPv6(addr1)&&errors.SourceAddress.push("msg_invalid_ipv6"),isInvalidIPv6(addr2)&&errors.DestAddress.push("msg_invalid_ipv6"),msk1&&!funcs_is.number(msk1)&&errors.SourceAddress.push("msg_invalid_ipv6_prefix"),msk2&&!funcs_is.number(msk2)&&errors.DestAddress.push("msg_invalid_ipv6_prefix"),_.isUndefined(elem.source.split("/")[2])||errors.SourceAddress.push("msg_invalid_ipv6_prefix"),_.isUndefined(elem.dest.split("/")[2])||errors.DestAddress.push("msg_invalid_ipv6_prefix"),""!=addr1&&""==msk1&&errors.SourceAddress.push("ipsec_error_mask_is_null"),""!=addr2&&""==msk2&&errors.DestAddress.push("ipsec_error_mask_is_null"),(msk1>128||isInvalidPrefixIPv6(msk1))&&errors.SourceAddress.push("msg_invalid_ipv6_prefix"),(msk2>128||isInvalidPrefixIPv6(msk2))&&errors.DestAddress.push("msg_invalid_ipv6_prefix"),(!isInvalidIPv6(addr1)&&!isInvalidPrefixIPv6(msk1)||!isInvalidIPv6(addr2)&&!isInvalidPrefixIPv6(msk2))&&(isSubnetIPv6(addr1,msk1)!=addr1.toLowerCase()&&errors.SourceAddress.push("msg_invalid_ipv6_subnet"),isSubnetIPv6(addr2,msk2)!=addr2.toLowerCase()&&errors.DestAddress.push("msg_invalid_ipv6_subnet"),_.isNull(isReservedIPv6(addr1,msk1))||"network"==isReservedIPv6(addr1,msk1)||errors.SourceAddress.push("lan_error_ip_is_reserved"),_.isNull(isReservedIPv6(addr2,msk2))||"network"==isReservedIPv6(addr2,msk2)||errors.DestAddress.push("lan_error_ip_is_reserved"),0==errors.SourceAddress.length&&0==errors.DestAddress.length&&(""!=addr1&&(network1={ip:addr1,prefix:msk1}),""!=addr2&&(network2={ip:addr2,prefix:msk2})),_.isEmpty(network1)||_.isEmpty(network2)||!isContainsNetworkIPv6(network1,network2)||(errors.SourceAddress.push("ipsec_local_remote_intersect_msg"),errors.DestAddress.push("ipsec_local_remote_intersect_msg")),_.isEmpty(network1)||_.isEmpty(network2)||!isContainsNetworkIPv6(network2,network1)||(errors.SourceAddress.push("ipsec_local_remote_intersect_msg"),errors.DestAddress.push("ipsec_local_remote_intersect_msg"))));for(var i in list)list[i].source==elem.source&&errors.SourceAddress.push("msg_ip_address_is_used"),list[i].dest==elem.dest&&errors.DestAddress.push("msg_ip_address_is_used");return errors}var index=$scope.ngDialogData.inx,data=$scope.ngDialogData.data,list=$scope.ngDialogData.list,funcs_ipv4=device.funcs.ipv4,funcs_ipv6=device.funcs.ipv6,funcs_is=device.funcs.is;$scope.ipVersion=$scope.ngDialogData.data.ipVersion,$scope.ikeVersion=$scope.ngDialogData.data.ikeVersion,$scope.dialog={header:"",action:null,rule:null,id:0,save:function(){$scope.form.$valid&&$scope.closeThisDialog({write:$scope.dialog.rule})},remove:function(){$scope.closeThisDialog({remove:{items:[$scope.dialog.rule],index:[index]}})},close:function(){$scope.closeThisDialog(null)},isDisabledSave:function(){return isNotUniqRule()||"edit"==$scope.dialog.action&&!wasModified()},isNotUniqRule:isNotUniqRule,validation:function(elem,param){var errors={SourceAddress:[],DestAddress:[]};if((_.isObject(elem)||_.isObject(elem))&&(errors=validateNets(elem)),!_.isObject(elem)||!_.isObject(elem))if("SourceAddress"==param){var isUniqSource=_.filter($scope.dialog.rule.source,function(f){return f.source==elem});if(isUniqSource.length>1)return errors.SourceAddress.push("msg_error_value_is_not_uniq"),errors[param][0];_.each($scope.dialog.rule.dest,function(item){errors=validateNets({source:elem,dest:item.dest})})}else{var isUniqDest=_.filter($scope.dialog.rule.dest,function(f){return f.dest==elem});if(isUniqDest.length>1)return errors.DestAddress.push("msg_error_value_is_not_uniq"),errors[param][0];_.each($scope.dialog.rule.source,function(item){errors=validateNets({source:item.source,dest:elem})})}return errors[param].length?errors[param][0]:null},needMTU:function(){return _.has($scope.dialog.rule,"mtu")},addSourceSubnet:function(){$scope.dialog.focus=!0,$scope.dialog.rule.source.push({source:"",__id:++$scope.dialog.id})},addDestSubnet:function(){$scope.dialog.focus=!0,$scope.dialog.rule.dest.push({dest:"",__id:++$scope.dialog.id})},removeSourceSubnet:function(inx){$scope.dialog.rule.source.splice(inx,1)},removeDestSubnet:function(inx){$scope.dialog.rule.dest.splice(inx,1)}};var __backupRule=null;!function(){_.isUndefined(index)?($scope.dialog.action="add",$scope.dialog.header=translate("act_add_rule")):($scope.dialog.action="edit",$scope.dialog.header=translate("act_edit_rule")),$scope.dialog.rule=data,2!=$scope.ikeVersion||_.isArray($scope.dialog.rule.source)&&_.isArray($scope.dialog.rule.dest)||($scope.dialog.rule.source=[{source:"",__id:++$scope.dialog.id}],$scope.dialog.rule.dest=[{dest:"",__id:++$scope.dialog.id}]),__backupRule=angular.copy($scope.dialog.rule)}()}angular.module("app").controllerProvider.register("IPsecNetsFormDialogCtrl",IPsecNetsFormDialogCtrl);