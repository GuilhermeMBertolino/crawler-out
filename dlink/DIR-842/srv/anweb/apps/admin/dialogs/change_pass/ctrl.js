"use strict";function ChangePassDialogCtrl($scope,changePassword,translate,device,devinfo,$q,navigationFilter,cookie,snackbars,$injector){function activate(){function SsidConfig(band){function getBase(){var ap=device.wifi.getBand(0,"".concat(band,"GHz")).ap;return ap.getBase()}var postfix,config={},base=getBase(),postfix="-"+($scope.deviceMac?$scope.deviceMac.replace(/:/g,"").slice(-4):device.funcs.randomString(4));return config.band=band,config.value=base.SSID+postfix,config.defaultSSID=angular.copy(base.SSID),$scope.needChangePSK&&(config.PSK=base.Security.PreSharedKey),config.apply=function(){base=getBase(),base.SSID=config.value,$scope.needChangePSK&&(base.Security.PreSharedKey=config.PSK)},config}$scope.needChangeSSID24&&($scope.ssids[2.4]=new SsidConfig("2.4")),$scope.needChangeSSID5&&SUPPORT_WIFI_5GHZ&&($scope.ssids[5]=new SsidConfig("5"))}function pull(){function pullWifi(){var deferred=$q.defer();return device.wifi.pullCommon(function(error){error?deferred.reject():deferred.resolve()}),deferred.promise}function pullDevinfo(){return devinfo.once("version").then(function(result){$scope.deviceMac=result.deviceMac.toUpperCase()})}return device.wifi.pullCommon?pullWifi().then(pullDevinfo):pullDevinfo()}function changePass(){function success(){deferred.resolve()}function error(msg){$scope.passwd.errorMessage=translate(msg),deferred.reject($scope.passwd.errorMessage)}var deferred=$q.defer();if($scope.needChangePass){var login=null,password=$scope.passwd.value;changePassword(login,password).then(success,error)}else success();return deferred.promise}function changeLang(){var lang=_.findKey(translate.langNames,function(value){return value===$scope.lang.value}),overlayId=overlay.start();device.system.changeLang(lang).then(translate.changeLanguage(lang))["catch"](snackbars.add.bind(snackbars,translate("sysconfig_change_lang_error")))["finally"](overlay.stop.bind(overlay,overlayId))}function setUSBAutoConnDefGW(){return"ap"==deviceMode,Promise.resolve()}function saveSsid(){var deferred=$q.defer();return _.keys($scope.ssids).length?(_.each(_.values($scope.ssids),function(ssidConfig){ssidConfig.apply()}),device.wifi.push(function(){deferred.resolve()},!0)):deferred.resolve(),deferred.promise}function formValid(){return $scope.form_change_password.$valid&&(!$scope.needChangePass||$scope.passwd.value.length&&$scope.passwd.confirmValue.length)}var SUPPORT_WIFI_5GHZ=autoconf.BR2_PACKAGE_ANWEB_WIFI_5GHZ,overlay=$scope.overlay.circular,login=cookie.get("user_login"),deviceMode=cookie.get("device_mode");$injector.get("cpe"),$scope.customRules=navigationFilter.rules()||{},$scope.needChangePSK=autoconf.BR2_PACKAGE_ANWEB_CUSTOM_DME_39231||autoconf.BR2_PACKAGE_ANWEB_CUSTOM_FIRSTMEDIA_44663||autoconf.BR2_PACKAGE_ANWEB_CUSTOM_PLANETA_45478,_.extend($scope,{applying:!1,ssids:{},passwd:{value:$scope.customRules.DialogChangePasswordValue||"",change:function(){$scope.passwd.errorMessage=null},confirmValue:$scope.customRules.DialogChangePasswordValue||""},lang:{value:null,list:null,change:changeLang},ssid:{},needChangeSSID24:$scope.ngDialogData.needChangeSSID24,needChangeSSID5:$scope.ngDialogData.needChangeSSID5,needChangePass:$scope.ngDialogData.needChangePass,deviceMac:null,save:function(){if(formValid()){var overlayId=overlay.start();$scope.applying=!0,changePass().then(saveSsid).then(changeLang).then(setUSBAutoConnDefGW).then(function(){$scope.closeThisDialog()})["finally"](function(){$scope.applying=!1,overlay.stop(overlayId)})}},saveEnabled:function(){return $scope.ngDialogData.needChangePass&&$scope.customRules.DialogChangePasswordValue?formValid():formValid()&&!$scope.applying}}),function(){function getLangBrowser(langList){return _.find(Object.keys(langList),function(e){return e.slice(0,2)==window.navigator.language.slice(0,2)})||"eng"}Promise.all([pull(),translate.getLangNames()]).then(function(res){var langNames=res[1].data,langDesc=getLangBrowser(langNames);$scope.lang.value=langNames[langDesc],$scope.lang.list=_.values(langNames),translate.changeLanguage(langDesc),activate()})}(),$scope.getSSIDName=function(obj){if(obj&&obj.band){var name=translate("wifi_network_name"),ssid24name=SUPPORT_WIFI_5GHZ?name+" 2.4 "+translate("units_GHz")+" (SSID)":name+" (SSID)",ssid5name=name+" 5 "+translate("units_GHz")+" (SSID)";return"5"==obj.band?ssid5name:ssid24name}},$scope.validateSSID=function(origin,value){return value==origin?"msg_change_pass_ssid_def_error":null},$scope.confirmPasswordValidate=function(value){return value&&value!=$scope.passwd.value?"msg_passwords_not_equal":null},$scope.getPSKName=function(band){var key=translate("password");return"2.4"==band?key+String(SUPPORT_WIFI_5GHZ?" 2.4 "+translate("units_GHz")+" (PSK)":" (PSK)"):key+" 5 "+translate("units_GHz")+" (PSK)"},$scope.validatePSK=function(value){if(value){if(!(value.length>=8&&value.length<=63))return"msg_invalid_password_length";if(/[а-яА-Я]+/.test(value))return"dcc_wifi_cyrillic";if(!/^[\x20-\x7E]+$/g.test(value))return"msg_password_contains_illegal"}return null},$scope.getPassDesc=function(){return"SuperAdmin"==login?"password_description_ttk_superadmin":"password_description_ttk"}}