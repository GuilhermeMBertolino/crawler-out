"use strict";!function(){appDeps=appDeps.concat(["nw","app.config","ui.router","app-module-funcs","device","dcc.device","ngDialog","dlink-mobile-app"]);var app=angular.module("trouble",appDeps),TROUBLE_DEFAULT_AWAY_URL=autoconf.BR2_PACKAGE_ANWEB_CUSTOM_MTS_18276?"/admin/index.html":autoconf.BR2_PACKAGE_ANWEB_PROVIDER_URL;app.constant("fieldConfig",{style:"material"}),app.config(["$stateProvider","$injector","pageList","$urlRouterProvider","navigation","ngDialogProvider",function($stateProvider,$injector,pageList,$urlRouterProvider,navigation,ngDialogProvider){_.each(navigation,function(elem,inx){var views,page,state=null;elem.page?_.isObject(elem.page)?(views={},_.each(elem.page,function(_elem,_inx){var view,_page=pageList[_elem];_page&&(view={templateUrl:_.isArray(_page.html)?_.first(_page.html):_page.html,controller:_page.ctrl,controllerAs:_page.ctrlAlias},views[_inx]=view)}),state={views:views,url:elem.url,params:elem.url?void 0:elem.params}):(page=pageList[elem.page],state=page?{templateUrl:_.isArray(page.html)?_.first(page.html):page.html,controller:page.ctrl,controllerAs:page.ctrlAlias,url:elem.url,params:elem.params}:{template:'<div class="content_padding"><h3>Page not found</h3></div>',url:elem.url,params:elem.url?void 0:elem.params}):state={"abstract":!0,url:elem.url,template:"<ui-view/>"},state&&$stateProvider.state(inx,state)}),ngDialogProvider.setDefaults({closeByDocument:!1,showClose:!1})}]),app.controller("TroubleCtrl",["$scope","$q","$rootScope","$window","devinfo","$state","navigation","troubleCheck","$timeout","translate","overlay-core","queryString","$location",function($scope,$q,$rootScope,$window,devinfo,$state,navigation,troubleCheck,$timeout,translate,overlay,queryString){function changeURL(url){beforeExit().then(function(){location.href=isRedirectID(url)?document.location.protocol+"//"+document.location.host+"/redirect_to?redirect_id="+url:isPath(url)?url:"http://"+url}),overlay.simple.start({action:"wait.redirect"})}function isURL(str){if(!str)return!1;var url=new RegExp("^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i");return str.length<2083&&url.test(str)}function isPath(str){return str&&"/"==str[0]}function isRedirectID(str){return str&&"/"!=str[0]&&32==str.length&&/[0-9a-z]+$/.test(str)}function beforeExit(){return Promise.resolve()}$rootScope.autoconf=autoconf;var checkCount=0,checkCountMax=autoconf.BR2_PACKAGE_ANWEB_CUSTOM_POLAND_43525?0:2,finishURL=function(){return queryString.finishURL?queryString.finishURL:queryString.redirect_id?queryString.redirect_id:"connected"}();devinfo.init({need_auth:!1}),devinfo.subscribe("ports",function(data){data&&($rootScope.rootAvailPorts=data.availPorts)}),devinfo.once("version").then(function(data){var startPage;if(data){if($scope.devInfo=data,$scope.devInfo.fw_version=data.version,$scope.devInfo.fw_name=data.modelName,$scope.title=data.modelName,translate.changeLanguage(data.lang),devinfo.init({need_auth:!0}),queryString.finishURL)return void $scope.onStartBtnClick();startPage="start",$state.go(startPage).then(function(){overlay.simple.stop({action:"loading"}),$scope.isLoaded=!0})}}),$scope.isButton=function(btn){var name=$state.$current.name,nav=navigation[name];return nav&&nav.buttons.indexOf(btn)>=0},$scope.isWizard=function(){return"connected"==queryString.finishURL},$scope.onStartBtnClick=function(){overlay.simple.start({action:"loading"}),devinfo.once("version|ports|box|net").then(function(data){var ifacetype,gw;data&&(ifacetype=null,gw=null,$scope.devInfo=data,$scope.devInfo.fw_version=data.version,$scope.devInfo.fw_name=data.modelName,data.ipv4gw?gw=data.ipv4gw:data.ipv6gw&&(gw=data.ipv6gw),gw&&(ifacetype=gw.ifacetype),$scope.DSLMode="DSL"==data.deviceClass&&_.contains(["dsl","atm","ptm"],ifacetype),$scope.connType=gw?gw.contype:null,$rootScope.rootAvailPorts=data.availPorts,$rootScope.rootGWIface=ifacetype,$scope.EtherwanMode=_.some(data.availPorts,function(o){return o.isEtherwan}),$rootScope.rootWANPort=_.find(data.availPorts,function(port){return/^(internet|port5|dsl)$/.test(port.name)&&port.isWan||port.isWan&&port.alias.startsWith("WAN")||port.isEtherwan}),$rootScope.rootBoxInfo={ports:_.map(_.sortBy(data.availPorts,"position"),function(o){return o.name})},$state.go("wait").then(function(){overlay.simple.stop({action:"loading"}),$scope.isLoaded=!0}),console.log("rootAvailPorts",$rootScope.rootAvailPorts),console.log("rootWANPort",$rootScope.rootWANPort))})},$scope.onExitBtnClick=function(){beforeExit().then(function(){return $window.location.href="/"})},$scope.onCheckBtnClick=function(){$state.go("wait")},$scope.onApplyBtnClick=function(){$timeout(function(){$scope.$broadcast("goToErrorForm",!0),$scope.$broadcast("apply")})},$scope.onAwayBtnClick=function(){var url=queryString.redirect_id?queryString.redirect_id:TROUBLE_DEFAULT_AWAY_URL;changeURL(isPath(url)?url:url)},$scope.checkSiteURL=function(){return!0},$scope.forceConnectedState=function(){return isRedirectID(finishURL)||isURL(finishURL)||isPath(finishURL)?(changeURL(finishURL),$q.reject()):$state.go("connected")},$scope.isPPPoE=function(){return $scope.connType&&$scope.connType.includes("pppoe")},$scope.isDHCP=function(){return $scope.connType&&$scope.connType.includes("dynip")},$scope.isShowServiceInfo=function(){var name=$state.$current.name,nav=navigation[name];return nav&&!["wait","connected","errorPPPAuth"].includes(nav.page)},$scope.showNextError=function(){checkCount++,troubleCheck.getNextStatus(function(status){var promise;checkCountMax>=checkCount||"connected"==status?"connected"==status&&(isRedirectID(finishURL)||isURL(finishURL)||isPath(finishURL))?(console.log("finishURL",finishURL),changeURL(finishURL)):promise=$state.go(status):(promise=$state.go("failed"),checkCount=0),promise&&promise.then(function(){overlay.simple.stop({action:"loading"}),$scope.isLoaded=!0})},$scope)}}])}();