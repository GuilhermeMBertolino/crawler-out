"use strict";!function(){var nw=angular.module(regdep("nw-client-list"));nw.service("nwClientListUtil",["$q","funcs","devinfo","cookie","device",function($q,funcs,devinfo,cookie,device){var promise,is=funcs.is,statsConverter=device.statsDHCP.converter,clientsPath="Device.Statistics.Neighbours.",ifacePath="Device.Network.Interface.",wifiStatsPath1="Device.Statistics.WiFi.Radio.1.AccessPoint.",wifiStatsPath2="Device.Statistics.WiFi.Radio.2.AccessPoint.",hostnamePath="Device.Hostnames.",serversPath="Device.Network.Server.",ipv4Path="Device.Routing.IPv4.Routes.",ipv6Path="Device.Routing.IPv6.Routes.",isLoading=!1;return{pull:function(source){function success(data){isLoading=!1;var iface=null,clients=[],wifiAPData=[],ipv4Route=[],ipv6Route=[];if(data&&data[clientsPath]&&(clients=funcs.fetchBranch(data[clientsPath],clientsPath),clients=funcs.newConfig.instanceObjectToArray(clients),data[ifacePath]&&(iface=funcs.fetchBranch(data[ifacePath],ifacePath))),data&&data[ipv4Path]&&data[ipv6Path]){ipv4Route=funcs.fetchBranch(data[ipv4Path],ipv4Path),ipv4Route=funcs.newConfig.instanceObjectToArray(ipv4Route),ipv6Route=funcs.fetchBranch(data[ipv6Path],ipv6Path),ipv6Route=funcs.newConfig.instanceObjectToArray(ipv6Route);var gateway=_.chain(_.union(ipv4Route,ipv6Route)).map(function(elem){return elem.GatewayIPAddress}).uniq().compact().value();_.isEmpty(gateway)||_.each(gateway,function(elem){clients=_.filter(clients,function(item){return item.IPAddress!=elem})})}if(data&&data[serversPath]&&data[hostnamePath]){var servers=funcs.splitTree(data[serversPath]),hostnames=funcs.splitTree(data[hostnamePath]),input=servers.concat(hostnames),serversClients=statsConverter.dsysinitToNative(funcs.buildTree(input));_.each(serversClients,function(cl){var temp={MACAddress:cl.MACAddress,Hostname:cl.hostname,IPAddress:cl.ip},repeaterClient=_.findWhere(clients,{IPAddress:temp.IPAddress});repeaterClient&&(clients=_.without(clients,repeaterClient)),_.findWhere(clients,{MACAddress:temp.MACAddress,IPAddress:temp.IPAddress})||clients.push(temp)})}if(data&&(data[wifiStatsPath1]||data[wifiStatsPath2])){var radio1=funcs.splitTree(data[wifiStatsPath1]),radio2=funcs.splitTree(data[wifiStatsPath2]),radio=funcs.buildTree(radio1.concat(radio2));radio=funcs.fetchBranch(radio,"Device.Statistics.WiFi.Radio."),_.each(radio,function(elem){_.each(elem.AccessPoint,function(ap){wifiAPData=wifiAPData.concat(_.map(funcs.newConfig.normalize(ap.AssociatedDevice),function(obj){var clientObj={MACAddress:obj.MACAddress,Port:ap.CrossLink};return clients.push(clientObj),obj}))})})}deferred.resolve(iface?{clients:clients,iface:iface,wifiAPData:wifiAPData}:{clients:clients,wifiAPData:wifiAPData})}function error(){isLoading=!1,deferred.reject()}function getAreas(source){var areaList={all:clientsPath+"|"+ifacePath+"|"+hostnamePath,wifi:wifiStatsPath1+"|"+wifiStatsPath2+"|"+hostnamePath,leasesv4:serversPath,route:ipv4Path+"|"+ipv6Path},source=source&&source.split(" ");return _.chain(source).map(function(el){return areaList[el]}).compact().value().join("|")||areaList.all}var area=getAreas(source);if(isLoading)return promise;var deferred=$q.defer();return isLoading=!0,promise=deferred.promise,devinfo.once(area).then(success,error),deferred.promise},filterClientsInfo:function(clients,format,iface,band,wifiAPData){function checkClientsPorts(elem,iface){if(!iface||_.isUndefined(elem.port)||_.isUndefined(elem.iface))return!0;if(""==elem.iface)return!1;if(-1!=elem.iface.indexOf("Bridge"))return!0;var iface=funcs.fetchBranch(iface,elem.iface);return iface?iface.Bridged:!1}function checkLinkLocal(ip,mac){if(is.ipv4(ip)||!ip)return!0;var addr=funcs.ipv6.address.full(ip),splitAddr=addr.split(":");return"ap"==cookie.get("device_mode")&&checkIfClientsConnected(mac)?!0:"fe80"!=splitAddr[0].toLowerCase()}function checkIfClientsConnected(mac){return!wifiAPData||_.isEmpty(wifiAPData)?!1:_.find(wifiAPData,function(client){return client.MACAddress.toUpperCase()==mac.toUpperCase()})}return clients.filter(function(client){return"ip"!=format.value||checkClientsPorts(client.raw,iface)&&checkLinkLocal(client.raw.ip,client.raw.mac)?band&&-1==client.raw.port.indexOf("Device.WiFi.Radio."+band)?!1:!0:!1})},prepareClientsList:function(clients,version,direction,exclude,filterFn){function excludeRule(rule){function compare(rule,compareRule){return _.every(rule,function(value,name){return compareRule[name]==value})}return _.some(exclude,function(elem){return compare(elem,rule)})}return _.chain(clients).filter(function(elem){return excludeRule(elem)?!1:"wifi"!=direction?("ipv4"!=version||is.ipv4(elem.IPAddress))&&("ipv6"!=version||is.ipv6(elem.IPAddress))?elem.Flags&&"reachable"!=elem.Flags&&"stale"!=elem.Flags&&"delay"!=elem.Flags?!1:!0:!1:!0}).map(function(elem){return{ip:elem.IPAddress,mac:elem.MACAddress?elem.MACAddress.toUpperCase():"",host:elem.Hostname,port:elem.Port,iface:elem.Interface}}).filter(function(elem){return filterFn&&!filterFn(elem)?!1:!0}).value()},findClient:function(knownClients,addr,type){return"ip"==type?_.findWhere(knownClients,{IPAddress:addr}):_.findWhere(knownClients,{MACAddress:addr})},getHostname:function(client){return client.Hostname}}}])}();