<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html" />
    <% getIndex("no-cache"); %>
    <title>Online Update</title>
    <% getInfo("include_css"); %>
    <script type="text/javascript" src="request.js"></script>
    <script language="Javascript" src='<% getInfo("lang");%>'></script>
    <script type="text/javascript" src="util_gw.js"></script>
  </head>
  <body>
    <style>
      .err-class {
        color: red;
      }
      p {
        text-align: center;
      }
      .on {
        display: on;
      }
      .off {
        display: none;
      }
      dialog{
        width: 300px;
        min-height: 130px;
        border: 1px solid #eee;
        top: -140px;
      }
      .favDialogDiv{
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 130px;
      }
    </style>
    <blockquote>
      <h2><script>dw(online_upgrade_menu)</script></h2>
      <script>dw(online_upgrade_des)</script>
      <hr size="1" noshade align="top" />
      <div id="checkDivId">
        <p>
          <input type="button" id="checkBtn" onclick="checkVersion()" value="检查版本" />
          <script>document.getElementById("checkBtn").value = check_version</script>
        </p>
        <p id="errMsgId" class="err-class"></p>
      </div>
      <dialog id="favDialog">
        <div class="favDialogDiv">
            <p><span id="checkMsg"></span></p>
            <p>
              <script type="text/javascript" language="javascript1.2">
                var MWJ_progBar = 0;
                var myProgBar = new progressBar(1, "#000000", "#ffffff", "#043db2", 300, 15, 1);
              </script>
            </p>
            <p id="footer-btn">
                <input type="button" id="closeBtn" onclick="hideDialog()" value="关闭" />
                <input
                type="button"
                id="upgradeBtn"
                onclick="triggerFwDownload()"
                value="升级"
                />
                <script>
                  document.getElementById("closeBtn").value = install_close;
                  document.getElementById("upgradeBtn").value = menu_updateFm
                </script>
            </p>
        </div>
      </dialog>
    </blockquote>
    <script>
      parent.hideWaitDiv();
      var contexturl = "api/v0/aupg";
      var jsonrpc = "2.0";
      var timer = null;
      var Progress = 0;
      var favDialog = document.getElementById("favDialog");

      var CheckResultState = {
        Default: 0,
        Checking: 1,
        CheckExist: 2,
        CheckNotExist: 3,
        TimeOut: 4,
        Error: 5,
      };

      var FwDownloadState = {
        Normal: 0,
        OK: 1,
        DownLoading: 2,
        TimeOut: 3,
        Error: 4,
      };

      // 展示错误信息
      function showError(text) {
        document.getElementById("errMsgId").innerText = text;
      }

      function showDialog() {
        if (typeof favDialog.showModal == "function") {
          favDialog.showModal();
        } else {
          favDialog.hidden = false;
        }
      }

      function hideDialog() {
        show_div(false, "progress_div");
        progress(0);
        if (typeof favDialog.close == "function") {
          favDialog.close("CANCELLED");
        } else {
          favDialog.hidden = true;
        }
      }

      // 进度条
      function progress(percentage) {
        myProgBar.setBar(percentage / 100);
      }
     // 升级倒计时
      function upgradeCountdown(time) {
        var countdownTimer = setInterval(function () {
            var loading = time - 1
            time = loading
            document.getElementById("checkMsg").innerText = online_upgrade_msg1 + loading + "S";
            if (loading <= 0) {
                time = null
                clearInterval(countdownTimer)
                parent.location.reload()
            }
        }, 1000)
      }

      // 开始升级
      function upgrade() {
        ajax({
          type: "post",
          url: contexturl,
          data: {
            id: new Date().getTime(),
            jsonrpc,
            method: "start",
            params: {},
          },
          success: function (res) {
            var resultJson = res.result;
            if (resultJson.code != 0) {
              document.getElementById("checkMsg").innerText = online_upgrade_err1
              return;
            }
            var loading = resultJson.loading || 60;
            show_div(false, "progress_div");
            show_div(false, "footer-btn");
            upgradeCountdown(loading)
          },
          faild: function (error) {
            document.getElementById("checkMsg").innerText = online_upgrade_err1;
          },
          timeOut: 30000,
        });
      }

      // 获取下载进度
      function getFwDownloadResult() {
        ajax({
          type: "post",
          url: contexturl,
          data: {
            id: new Date().getTime(),
            jsonrpc,
            method: "fwDownloadResult",
            params: {},
          },
          success: function (res) {
            var resultJson = res.result;
            // 下载错误
            if (resultJson.code != 0) {
              document.getElementById("checkMsg").innerText = online_upgrade_err2;
              return;
            }
            // 下载中
            if (
              resultJson.state == FwDownloadState.DownLoading ||
              resultJson.state == FwDownloadState.Normal
            ) {
              progress(resultJson.percentage);
              var timer = setTimeout(function () {
                clearTimeout(timer);
                getFwDownloadResult();
              }, 1000);
              return;
            }
            // 下载成功
            if (resultJson.state == FwDownloadState.OK) {
              progress(100);
              upgrade();
              return;
            }
            document.getElementById("checkMsg").innerText = online_upgrade_err2;
          },
          faild: function (error) {
            document.getElementById("checkMsg").innerText = online_upgrade_err2;
          },
          timeOut: 30000,
        });
      }

      // 触发下载
      function triggerFwDownload() {
        Progress = 0;
        ajax({
          type: "post",
          url: contexturl,
          data: {
            id: new Date().getTime(),
            jsonrpc,
            method: "triggerFwDownload",
            params: {},
          },
          success: function (res) {
            var resultJson = res.result;
            if (resultJson.code == 0) {
              show_div(true, "progress_div");
              progress(0);
              getFwDownloadResult();
            } else {
              document.getElementById("checkMsg").innerText = online_upgrade_err2;
            }
          },
          faild: function (error) {
            document.getElementById("checkMsg").innerText = online_upgrade_err2;
          },
          timeOut: 30000,
        });
      }

      // 获取检测结果
      function getCheckResult() {
        ajax({
          type: "post",
          url: contexturl,
          data: {
            id: new Date().getTime(),
            jsonrpc,
            method: "versionCheckResult",
            params: {},
          },
          success: function (res) {
            var resultJson = res.result;
            var checkmsg = "";
            if (resultJson.code != 0) {
              document.getElementById("checkMsg").innerText = online_upgrade_err3;
              showDialog();
              parent.hideWaitDiv();
              return;
            }
            if (
              resultJson.state == CheckResultState.Checking ||
              resultJson.state == CheckResultState.Default
            ) {
              // 检测中
              var timer = setTimeout(function () {
                clearTimeout(timer);
                getCheckResult();
              }, 3000);
              return;
            }
            // 获取结果成功，显示对应信息
            if (resultJson.state == CheckResultState.CheckExist) {
              checkmsg = online_upgrade_msg2 + resultJson?.softwareVersion;
              document.getElementById("upgradeBtn").style.display =
                "inline-block";
            }
            if (resultJson.state == CheckResultState.CheckNotExist) {
              checkmsg = online_upgrade_err4;
            }
            if (resultJson.state == CheckResultState.TimeOut) {
              checkmsg = online_upgrade_err5;
            }
            document.getElementById("checkMsg").innerText = checkmsg;
            parent.hideWaitDiv();
            showDialog();
          },
          faild: function (error) {
            document.getElementById("checkMsg").innerText = online_upgrade_err3;
            showDialog();
            parent.hideWaitDiv();
          },
          timeOut: 30000,
        });
      }

      // 检查版本
      function checkVersion() {
        parent.showWaitDiv();
        document.getElementById("checkMsg").innerText = "";
        document.getElementById("upgradeBtn").style.display = "none";
        ajax({
          type: "post",
          url: contexturl,
          data: {
            id: new Date().getTime(),
            jsonrpc,
            method: "triggerVersionCheck",
            params: {},
          },
          success: function (res) {
            var resultJson = res.result;
            if (resultJson.code == 0) {
              getCheckResult();
            }
          },
          faild: function (error) {
            document.getElementById("checkMsg").innerText = online_upgrade_err3;
            showDialog();
            parent.hideWaitDiv();
          },
          timeOut: 30000,
        });
      }
    </script>
  </body>
</html>
