<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="proma" content="no-cache"><meta http-equiv="cache-control" content="no cache"><meta http-equiv="expires" content="0"><title></title><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><link rel="stylesheet" href="/static/css/main.css"><link rel="stylesheet" href="/static/css/common.css"><link rel="stylesheet" href="/static/css/advance_menu.css"></head><body><div id="app"></div><script type="text/x-template" id="main"><div>
  <!--子菜单-->
  <adv-child-menu childType="tools"></adv-child-menu>  
  <div class="advance-box">
	  <br>
    <br>
	  <div class="fun-box">
      <table class="table">  
        <tbody>
        <tr>
          <td conspan="2">
            <span class="basic-title">{{ lang_t('firmware.msg9') }}</span>
          </td>
        </tr>
    	  <tr>
    		  <td class="fun-left2">{{ lang_t('firmware.firmware_ver') }}</td>
    		  <td>{{ version }}</td>
    		</tr>
    		<tr>
    		  <td class="fun-left2">{{ lang_t('firmware.build_time') }}</td>
    		  <td>{{ buildTime }}</td>
    		</tr>
  	  	</tbody>
	    </table>
      <br>
      <table class="table">  
        <tbody>
        <tr><td><b>{{ lang_t('firmware.local_upgrade') }}</b></td></tr>  
        <tr><td>{{ lang_t('firmware.local_upgrade_msg') }}</td></tr>        
		<tr>
          <td>
            <x-checkbox v-model="loaddef" v-show="!showMesh">{{ lang_t('firmware.upgrade_with_reset') }}</x-checkbox>
            <span v-show="!showMesh"><br><br></span>
            <input type="file" id="f_upload" @change="filechange">
          </td>
        </tr>
        <tr>
          <td v-show="showUpdateBtn && !showMesh">
            <button type="button" class="btn" @click="submit_upgrade">{{ lang_t('firmware.upgrade') }}</button>
          </td>
        </tr>
        </tbody> 
      </table>
	  <br>
      <div v-if="showMesh">
        <table class="table">
          <tbody>
          <tr>
            <td colspan="12" style="padding-bottom: 0;">
                <table class="t_table3 table-bordered table-striped">
                  <thead>
                    <th>{{ lang_t('rule.device_name') }}</th>
                    <th>IP</th>
                    <th>MAC</th>
                    <th>{{ lang_t('firmware.firmware_ver') }}</th>
                    <th>{{ lang_t('common.select') }}<x-checkbox v-model="selectAll" @change="selectFun" :disabled="disSelect"></x-checkbox></th>
                  </thead>
                  <tbody>
                    <tr v-for="(d,i) in meshGroup" :key="d.idx">
                      <td>{{ d.device_name }}</td>
                      <td>{{ d.ip }}</td>
                      <td>{{ d.mac }}</td>
                      <td>{{ d.version }}</td>
                      <td><x-checkbox v-model="selectIdx[i]" :disabled="disSelect||salvUpDis[i]"></x-checkbox></td>
                    </tr>
                  </tbody>
                </table>
            </td>
          </tr>
          <tr>
            <td style="padding-top: 0;">
              <x-checkbox v-model="slav_loaddef">{{ lang_t('firmware.upgrade_with_reset') }}</x-checkbox>
            </td>
          </tr>
          <tr>
            <td style="padding-top: 0;">
              <x-checkbox v-model="mainUpgrade" @change="mainUpgradeClick" :disabled="mainUpDis">{{ lang_t('firmware.main_upgrade') }}</x-checkbox>
            </td>
          </tr>
          <tr>
            <td>
              <button type="button" class="btn btn-primary all-but" @click="salv_Upgrade" :disabled="salvBtn">{{ salvUpgrade ? lang_t("common.upgrading") : lang_t("firmware.upgrade") }}</button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
      <br>
	  <table class="table">  
        <tbody>
        <tr><td><b>{{ lang_t('firmware.cloud_upgrade') }}</b></td></tr>
        <tr><td>{{ lang_t('firmware.cloud_upgrade_msg') }}</td></tr>
        <tr>
          <td>
			<button type="button" class="btn" @click="newCloudCheck('0')" :disabled="cloudCheck_en">{{ lang_t('firmware.check') }}</button>
          </td>
        </tr>
        <tr v-if="result != 0">
          <td v-if="result == 4 && cloudStatus != 1">{{ lang_t('firmware.found_newfw')}}:&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#EA7105;">{{newVersion}}</span> {{lang_t('firmware.manual_upgrade') }} 
            &nbsp;&nbsp;
			<button type="button" class="btn btn-primary all-but" id="cloud_upload" @click.prevent="cloudUpgrade" >{{ lang_t('firmware.upgrade') }}</button>
          </td>
          <td v-else-if="result == 1">{{ lang_t('firmware.check_internet_result') }}</td>
          <td v-else-if="result == 3">{{ lang_t('firmware.newcloudUpdateing') }}</td>
		  <td v-else-if="result == 5">{{ lang_t('firmware.cloudUpdateing') }}</td>
          <td v-else-if="result == 2">{{ lang_t('firmware.check_if_newver') }}</td>
          <td v-else-if="cloudStatus == 1" style="color:blue"><b>{{ lang_t('firmware.upload') }}</b></td>
        </tr>
        </tbody> 
      </table>
    </div>
  </div>
</div></script><script src="/plugin/vue.js"></script><script src="/plugin/jquery-3.2.1.min.js"></script><script src="/static/js/config.js"></script><script src="/static/js/layout.js"></script><script src="/static/js/common.js"></script><script src="/static/js/topicurl.js"></script><script>var cs_main={template:"#main",data:function(){return{globalConfig:globalConfig,lang:$.lang,lang_t:lang_t,result:"",buildTime:"",newVersion:"",loaddef:!1,slav_loaddef:!1,version:"",upgradeAction:"/cgi-bin/cstecgi.cgi?action=upload",setUpgradeFW:"0",maxSize:0,disSelect:!1,selectbox:!1,showUpdateBtn:!1,cloudCheck_en:!1,cloudStatus:"",meshGroup:[],selectIdx:[],selectAll:!1,loaddef_salv:!1,showMesh:!1,salvBtn:!0,salvResult:[],salvVersion:[],salvDis:[],salvUpdateIdx:null,selectDis:!1,salvUpgrade:!1,mainUpgrade:!1,mainUpDis:!1,salvUpDis:[]}},watch:{selectIdx2:function(t){t.length==this.meshGroup.length&&t.indexOf(!1)<0?this.selectAll=!0:this.selectAll=!1}},created:function(){var e=this;uiPost.FirmwareUpgrade(function(t){e.hardModel=t.hardModel,e.flashSize=t.flashSize,e.version=t.fmVersion,e.buildTime=t.buildTime,e.cloudFw=t.cloudFw,e.maxSize=parseInt(t.maxSize),e.lanip=t.lanIp,""!=t.upgradeAction&&(e.upgradeAction=t.upgradeAction),""!=t.setUpgradeFW&&(e.setUpgradeFW=t.setUpgradeFW)}),uiPost.getWiFiMeshConfig(function(t){e.meshGroup=t.meshInfo,"0"!=t.wifiOff&&"0"!=t.wifiOff5g||"1"==t.meshEnabled&&"1"==globalConfig.masterMode&&(e.showMesh=!0)})},methods:{selectFun:function(t){var e=this.selectIdx;for(var s in this.selectIdx=[],this.meshGroup)this.selectIdx[s]=this.salvUpDis[s]?e[s]:t},filechange:function(){var t=document.getElementById("f_upload"),e=t.files[0].name,s=t.files[0];if(e.indexOf(".web")<0&&e.indexOf(".bin")<0)return Cstool.Msg({content:this.lang_t("firmware.msg2")}),t.value="",!1;this.upload(s,"")},salv_Upgrade:function(){var t={},e=[];for(var s in this.meshGroup)!0===this.selectIdx[s]&&e.push(this.meshGroup[s].ip);if(0==e.length&&!this.mainUpgrade)return Cstool.Msg({content:this.lang_t("firmware.msg7")}),!1;var i=document.getElementById("f_upload").files[0],n=e.join(";");"1"==(this.mainUpgrade?"1":"0")?this.submit_upgrade():(t.ip=n,t.resetFlags=this.slav_loaddef?"1":"0",t.FileName=i.name,t.ContentLength=i.size,this.salvUpgrade=!0,uiPost.informSlaveUpdate(t,function(t){var e=240;t.wtime&&(e=t.wtime),Cstool.Count(e,"up",function(){location.href="/login.html?timestamp="+(new Date).getTime()})}))},cloudUpgrade:function(){var s=this,t={},i=120;s.cloudCheck_en=!0,t.resetFlags=s.loaddef?"1":"0","1"==s.setUpgradeFW?uiPost.setUpgradeFW(t,function(t){null!=t.wtime&&""!=t.wtime&&0!=t.wtime&&(i=Number(t.wtime));var e=setInterval(function(){uiPost.getCloudDownloadStatus(function(t){s.cloudStatus=t.cloudupg_download,"2"==t.cloudupg_download?(clearInterval(e),Cstool.Count(i,"up",function(){location.href="/login.html"})):"3"==t.cloudupg_download&&(s.cloudCheck_en=!1)})},1e3)}):uiPost.CloudACMunualUpdate(t,function(t){i=null!=t.wtime&&""!=t.wtime&&0!=t.wtime?Number(t.wtime):240,Cstool.Count(i,"up",function(){location.href="/login.html"})})},mainUpgradeClick:function(){this.mainUpgrade},newCloudCheck:function(s,t){var i=this,n=0,a={type:s,uiNotLoadAlert:1};"1"==s&&(a.ip=t),i.btnDis(s,!0),uiPost.CloudSrvVersionCheck(a,function(){var e=setInterval(function(){if(30<=n)return i.statusCheck(s,e,"2"),!1;uiPost.getCloudSrvCheckStatus(a,function(t){i.statusCheck(s,e,t.cloudFwStatus,t)}),n++},1e3)})},btnDis:function(t,e){"0"!=t&&(this.cloudCheck_en=e);for(var s=0;s<this.meshGroup.length;s++)s==this.salvUpdateIdx&&"1"==t||"88"==this.salvResult[s]||(this.salvDis[s]=e)},statusCheck:function(t,e,s,i){null!=s&&"3"!=s&&"0"!=s?("0"==t?("4"==s&&(this.newVersion=i.newVersion),this.result=s):("4"==s&&(this.salvVersion[this.salvUpdateIdx]=i.newVersion),this.salvResult.splice(this.salvUpdateIdx,1,s)),this.btnDis(99,!1),clearInterval(e)):"0"==t?this.result="3":this.salvResult.splice(this.salvUpdateIdx,1,"3")},submit_upgrade:function(){var t=this,e={};if(this.showMesh){var s=[];for(var i in this.meshGroup)!0===this.selectIdx[i]&&s.push(this.meshGroup[i].ip);if(0==s.length&&!this.mainUpgrade)return Cstool.Msg({content:this.lang_t("firmware.msg7")}),!1;e.slaveIpList=s.join(";")}if(""==$("#f_upload").val())return Cstool.Msg({content:t.lang_t("firmware.msg1")}),!1;var n=document.getElementById("f_upload").files[0],a=n.size;if(1<=a/(1024*t.flashSize*1024))return Cstool.Msg({content:t.lang_t("firmware.msg3")}),!1;var l=this.mainUpgrade?"1":"0";e.resetFlags="1"==l?t.slav_loaddef?"1":"0":t.loaddef?"1":"0",e.FileName=n.name,e.ContentLength=a,uiPost.setUpgradeFW(e,function(t){var e=240;null!=t.wtime&&""!=t.wtime&&(e=t.wtime),Cstool.Count(e,"up",function(){location.href="/login.html"})})},checkUploadStatus:function(){var e=this,s=0;Cstool.Msg({content:this.lang_t("firmware.msg12"),type:"no"});var i=setInterval(function(){s++,uiPost.getSlaveUpdate(function(t){(7<=s||"1"==t.slaveUpgStatus)&&(e.slaveIp=t.slaveIp,Cstool.Msg({content:"1"==t.slaveUpgStatus?e.lang_t("firmware.msg13",[e.lang_t("common.done")]):e.lang_t("firmware.msg13",[e.lang_t("common.fail")])}),e.showUpdateBtn=!0,clearInterval(i))})},1e3)},upload:function(t,e){var n=this;Cstool.Msg({type:"no",content:n.lang_t("firmware.uploading")}),uiPost.killProcess(function(){upload.fileUpload({data:t,url:n.upgradeAction+"&"+globalConfig.token,success:function(t){if("1"==t.upgradeStatus){if(t.availableDevic){var e=t.availableDevic.split(";");n.mainUpDis="PASS"!=e[0],n.mainUpDis&&(n.mainUpgrade=!1);for(var s=[],i=0;i<n.meshGroup.length;i++)s[i]=!~e.indexOf(n.meshGroup[i].mac);n.disSelect=!~s.indexOf(!1),n.salvUpDis=s}"1"==t.slaveIpList?n.checkUploadStatus():(Cstool.Msg({content:n.lang_t("firmware.upload_success"),type:"no",time:2}),n.showUpdateBtn=!0),n.salvBtn=!1}else n.salvBtn=!0,n.showUpdateBtn=!1,Cstool.Msg({content:n.lang_t('firmware["'+t.upgradeERR+'"]')})},error:function(t){n.salvBtn=!0,n.showUpdateBtn=!1,Cstool.Msg({content:n.lang_t("firmware.MM_fwupload_error")})}})})}}}</script><script src="/static/js/main.js"></script></body></html>